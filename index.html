<!DOCTYPE html>
<!--
    Open Porte v5.19 - üö™ PORTONCINI + LINK CATALOGO CORRETTO ‚úÖ
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    üîß v5.17 (28 NOV 2025) - PORTONCINI FINSTRAL FIN-DOOR
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - üö™ DATABASE FIN-DOOR: Telai L/Z/T, Tipi anta, Modelli
    - üìã TELAI: 961, 962, 963, 705, 706, 711, 718, 720, Z62, 967, etc.
    - üé® TIPI ANTA: Frame-Frame, Planar-Planar, misti
    - üìê MODELLI: 01, 02, 04-07, 20-24, 41, 43 con prezzi
    - üîß MATERIALI: PVC, Alluminio, Legno, Vetro, Ceramica, Metallo
    - ‚úÇÔ∏è TAGLI: Codici specifici per ogni telaio
    - üîê MANIGLIE: 16 set + 10 maniglioni con prezzi
    - üé® COLORI: Gruppi Alu 1/1H/2/3, PVC A/B
    - üí∞ CALCOLO: Prezzo base + supplementi automatici
    
    üîß v5.16 (28 NOV 2025) - MANIGLIE E CILINDRO EVOLUTI
    
    üìã CHANGELOG v5.15:
    - üîê AGGIUNTO: Modello "Non di serie" in Linea Piano
    - ‚úÖ ESSENZE: Rovere, Tanganica, Castagno, Douglas, Pino, Noce Canaletto, Teak, Laccato RAL, Altre Essenze
    - ‚úÖ PREZZI: Differenziati per essenza (Noce Canaletto +‚Ç¨53, Teak +‚Ç¨115, Altre +‚Ç¨81)
    - ‚úÖ CALCOLO: calcolaPrezzoRivestimento() ora accetta parametro essenza
    - ‚úÖ LISTINO: Prezzi da pag. 99 EVO 2025
    
    üìã CHANGELOG v5.14:
    
    üîß AGGIORNAMENTI v5.14 (28 NOV 2025):
    - üóëÔ∏è RIMOSSO renderStep8ConfigBlindate() - config globale non pi√π usata
    - üóëÔ∏è RIMOSSO renderBlindateTab() - tab dedicato non pi√π usato
    - üóëÔ∏è RIMOSSO addBlindata(), updateBlindata(), updateBlindataOpt()
    - ‚úÖ MANTENUTO calcolaLuceOikos() - usata in Ingresso
    - ‚úÖ MANTENUTO calcolaPrezzoBlindataStimato() - per calcolo prezzi
    - üìâ RIDOTTE ~920 righe di codice non utilizzato
    
    üîß AGGIORNAMENTI v5.13 (28 NOV 2025):
    - ‚úÖ DATABASE OIKOS_PANNELLI_PIANO: Essenze e prezzi per luce/tipo anta
    - ‚úÖ DATABASE OIKOS_CORNICI_IMBOTTI: Cornici aste, Kit alluminio, Imbotti
    - ‚úÖ UI CORNICI ESTERNE: Imbotte con cornici / Solo cornici
    - ‚úÖ UI CORNICI INTERNE: Cornici ferma pannello interno
    - ‚úÖ PREZZI: Cornici lineari (CF1-CF2-CT1-CC2-CC3), Kit Alluminio
    - ‚úÖ IMBOTTI: Altezza H1/H2, Larghezza 20/30cm, Essenze complete
    
    üîß AGGIORNAMENTI v5.12 (28 NOV 2025):
    - ‚úÖ renderBlindataConfig(): UI completa con tutti i campi
    - ‚úÖ PRESTAZIONI: Cilindro, Colore Telaio, Acustica, Termica, Kit AAV
    - ‚úÖ OPTIONAL: Vetro (tipo/finitura/termico), Sopraluce, Fiancoluce
    - ‚úÖ RIVESTIMENTI: Interno + Esterno (linea/modello/essenza/tinta)
    - ‚úÖ VERNICIATURA ESTERNI: Checkbox per maggiorazione +‚Ç¨150
    - ‚úÖ updateIngressoBlindataOpt(): Gestione optional in ingresso
    - ‚úÖ updateIngressoBlindataRiv(): Gestione rivestimenti in ingresso
    - ‚úÖ INIZIALIZZAZIONE: Struttura completa con vetro/sopraluce/fiancoluce/rivestimenti
    - ‚úÖ EXPORT JSON: Ingresso completo con tutti i campi blindata
    - ‚úÖ TOTALI: Aggiunto n_ingressi, n_blindate, n_portoncini
    - ‚úÖ FIX CAMBIO TIPO: Quando cambi portoncino‚Üîblindata, pulisce config precedente
    
    üîß AGGIORNAMENTI v5.08 (28 NOV 2025):
    - ‚úÖ RIMOSSI checkbox Blindate/Portoncini da Step 2
    - ‚úÖ INFO: Portoncini e Blindate si configurano nella posizione
    - ‚è≥ STEP 2: Rimuovere Step config globale
    - ‚è≥ STEP 3: Aggiungere tipoposizione nella UI posizione
    - ‚è≥ STEP 4: Aggiornare export JSON
    
    üîß AGGIORNAMENTI v5.07 (28 NOV 2025):
    - ‚úÖ EXPORT configBlindate: Tutti i campi config globale blindate
    - ‚úÖ EXPORT blindata posizione: Aggiunto pos.blindata in positions[]
    - ‚úÖ OPTIONAL EXPORT: vetro, sopraluce, fiancoluce inclusi
    - ‚úÖ RIVESTIMENTI EXPORT: rivestimentoInt/Est inclusi
    
    üîß AGGIORNAMENTI v5.05 (28 NOV 2025):
    - ‚úÖ SEZIONE OPTIONAL: Vetro/Sopraluce/Fiancoluce nel tab posizione Blindate
    - ‚úÖ FUNZIONE updateBlindataOpt(): Update campi optional per posizione
    - ‚úÖ EREDITARIET√Ä: Optional ereditati da config globale in addBlindata()
    - ‚úÖ UI COMPATTA: Checkbox e dropdown per ogni optional
    
    üîß AGGIORNAMENTI v5.04 (28 NOV 2025):
    - ‚úÖ FIX EXPORT: colorePersiana ora esportato correttamente in JSON
    - ‚úÖ CAMPI AGGIUNTI: coloreTelaio, battuta, tipo, apertura in configPersiane
    - ‚úÖ NOMI CHIARI: Tutti i campi persiane hanno nomi consistenti
    
    üîß AGGIORNAMENTI v5.03 (28 NOV 2025):
    - ‚úÖ DATABASE OIKOS_OPTIONAL: Prezzi vetro blindato/termico, sopraluce, fiancoluce
    - ‚úÖ SEZIONE OPTIONAL: UI in Step 8 Config Blindate
    - ‚úÖ VETRO: V1-V5, trasparente/sabbiato, blindato/termico
    - ‚úÖ SOPRALUCE: H500/H800, sabbiato, controtelaio auto
    - ‚úÖ FIANCOLUCE: Con/senza vetro, sabbiato, colori
    - ‚úÖ CALCOLO: Tutti optional integrati in calcolaPrezzoBlindataStimato()
    
    üîß AGGIORNAMENTI v5.02 (28 NOV 2025):
    - ‚úÖ FUNZIONE calcolaPrezzoRivestimento(): Cerca prezzo per linea/modello/luce
    - ‚úÖ RIVESTIMENTO INT: Aggiunto al calcolo totale blindata
    - ‚úÖ RIVESTIMENTO EST: Aggiunto al calcolo totale blindata
    - ‚úÖ VERNICIATURA: +‚Ç¨150 se verniciatura esterni attiva
    
    üîß AGGIORNAMENTI v5.01 (28 NOV 2025):
    - ‚úÖ KIT AAV: Sezione Kit Aria-Acqua-Vento in Step 8
    - ‚úÖ KIT MOSE 4/5A/C5: Prezzi per Luce 0/1/2 (‚Ç¨405/‚Ç¨464/‚Ç¨499)
    - ‚úÖ KIT DAM 4/5A/C5: Prezzi per Luce 0/1/2 (‚Ç¨459/‚Ç¨489/‚Ç¨514)
    - ‚úÖ SELEZIONE: Dropdown con Nessuno/MOSE/DAM
    - ‚úÖ RIEPILOGO: Mostra Kit AAV nella sintesi configurazione
    
    üîß AGGIORNAMENTI v5.00 (28 NOV 2025):
    - ‚úÖ DATABASE RIVESTIMENTI: OIKOS_RIVESTIMENTI con 7 linee complete
    - ‚úÖ DROPDOWN DINAMICI: Modello/Essenza cambiano in base a Linea selezionata
    - ‚úÖ HELPER FUNCTIONS: getModelliRivestimento(), getEssenzeRivestimento(), getTinteRivestimento()
    - ‚úÖ UI MIGLIORATA: Sezioni separate per Riv. Interno e Riv. Esterno
    - ‚úÖ PULIZIA AUTOMATICA: Cambiando Linea si puliscono Modello/Essenza/Tinta
    - ‚úÖ PREZZI BASE: Inclusi per ogni linea/modello/luce
    
    üîß AGGIORNAMENTI v4.99 (28 NOV 2025):
    - ‚úÖ STEP 8: Config Globale Porte Blindate
    - ‚úÖ Configurazione Base: Versione, Tipo Anta, Verso, Controtelaio, Cilindro
    - ‚úÖ Colori e Finiture: Telaio, Rivestimento Int/Est, Verniciatura
    - ‚úÖ Prestazioni: Acustica, Termica
    - ‚úÖ Riepilogo configurazione in tempo reale
    - ‚úÖ Navigazione Step 8 nel menu laterale
    
    üîß AGGIORNAMENTI v4.98 (28 NOV 2025):
    - ‚úÖ NUOVO PRODOTTO: Porte Blindate con listino Oikos 2025
    - ‚úÖ CHECKBOX: Attivabile in Step 2 Selezione Prodotti
    - ‚úÖ TAB DEDICATO: Sezione Blindate in ogni posizione
    - ‚úÖ CALCOLO LUCE: Automatico da dimensioni (Luce 0-6)
    - ‚úÖ CONFIGURAZIONE: Versione, Anta, Apertura, Controtelaio
    - ‚úÖ PRESTAZIONI: Cilindro, Colore Telaio, Acustica, Termica
    - ‚úÖ PREZZO STIMATO: Calcolo automatico base + optional
    
    üîß AGGIORNAMENTI v4.97 (28 NOV 2025):
    - ‚úÖ ZSX/ZDX VALIDAZIONE: Controllo ZSX ‚â§ SRSX e ZDX ‚â§ SRDX
    - ‚úÖ Label aggiornate: "A muro (=SRSX)" e "A muro (=SRDX)" per chiarezza
    - ‚úÖ Input Limitato OBBLIGATORIO: Evidenziato rosso se vuoto
    - ‚úÖ Errore visivo se ZSX > SRSX o ZDX > SRDX
    
    üîß AGGIORNAMENTI v4.96 (27 NOV 2025):
    - FIX BUG CRITICO: project.posizioni ‚Üí project.positions in 4 funzioni
    - updateTipoPersiana, updateAccessorio, updateAccessoriPersiana, migrazione tapparelle
    - Tipo Persiana ORA resta selezionato dopo selezione
    
    üîß AGGIORNAMENTI v4.95 (27 NOV 2025):
       - üîß FIX: Cardini da listino Punto Persiane
       - F1:2, F2:4, F3:5, F4:6 | PF1:3, PF2:6, PF3:7, PF4:8
       - üÜï AUTO-INIT: accessoriPersiana salvato automaticamente al primo render
       - üÜï RICALCOLO: Cambiando tipo (F1‚ÜíF2) ricalcola cardini/fermapersiane

    üîß AGGIORNAMENTI v4.94 (27 NOV 2025):
       - ‚úÖ ACCESSORI PERSIANE: Nuova sezione Cardini + Fermapersiane
       - ‚úÖ CARDINI: Calcolo automatico da tipologia (F1‚Üí2, F2‚Üí3, PF1‚Üí3, PF2‚Üí6, ecc.)
       - ‚úÖ FERMAPERSIANE: 1 per anta automatico
       - ‚úÖ MODELLI: 7 cardini + 6 fermapersiane da listino Punto Persiane
       - ‚úÖ APERTURA LIBRO: +1 cardine se apertura /A o LIB

    üîß AGGIORNAMENTI v4.93 (27 NOV 2025):
       - ‚úÖ NUOVA OPZIONE: "üîß Solo Accessori" (no telo, solo componenti)
       - ‚úÖ AGGIUNTO: Motore nella lista accessori selezionabili
       - ‚úÖ LOGICA: tap.qta = 0 quando "Solo Accessori", = 1 altrimenti
       - ‚úÖ 4 opzioni sostituzione: Tutto | Solo Telo | Selettiva | Solo Accessori

    üîß AGGIORNAMENTI v4.92 (26 NOV 2025):
       - FIX: Rimosso vecchio campo "sostEsistente" che creava conflitto
       - Ora export JSON usa SOLO: sostTipo + accessoriDaSostituire
       - Rimossa select "Sost. Esistente" dalla Config Globale (sostituita da sezione checkbox)
    
    üîß AGGIORNAMENTI v4.91 (26 NOV 2025):
       - NUOVA SEZIONE: Sostituzione Componenti Tapparella
       - 3 modalit√†: Sost. TUTTO / Solo Telo / Selettiva
       - 9 accessori selezionabili: Rullo, Supporti, Calotta, Puleggia, 
         Avvolgitore, Cintino, Passacinghia, Ganci, Guide
       - Guide + Colore Guida appaiono SOLO se checkbox Guide selezionato
       - UI con checkbox colorati e feedback visivo immediato
    
    üîß AGGIORNAMENTI v4.90 (26 NOV 2025):
       - GUIDE PLASTICINO: 12 modelli (TG15/TG10/TG30, TG25/TG20/TG35, RIB, PF ferro)
       - COLORI GUIDE: Anodizzati (Argento, Bronzo, Elox, Bianco) + 
         Verniciati RAL (1013, 6005, 8014, 8017, 8019) + RAL a richiesta
       - Dropdown dinamici in Config Globale E nelle Posizioni
       - Ordine campi: Modello ‚Üí Colore Telo ‚Üí Guida ‚Üí Colore Guida ‚Üí Tipo
    
    üîß AGGIORNAMENTI v4.89 (26 NOV 2025):
       - Colori Tapparelle: Aggiunta mappa colori Plasticino per modello
       - ALLUMINIO COIBENTATO: Tinta Unita (21 colori) + Legno (6) + Raffaello (4)
       - PVC: 16 colori specifici inclusi con clausole garanzia (*)
       - Dropdown colore si aggiorna automaticamente quando cambi modello
       - Modelli supportati: ALUPROFIL MD/AD, STEELPROFIL, ANTIGRANDINE, PESANTE, 
         MINI 8/10, ALUBLIND, COMBI, ORIENTA, ESTELLA CLASSIC
    
    üîß AGGIORNAMENTI v4.88 (26 NOV 2025):
       - CONTROLLO 1 (PF): HSoffitto > HMT + HCASS
       - CONTROLLO 2 (F): HParapettoSoffitto > HMT + HCASS (FIX: era HPavimentoParapetto)
       - CONTROLLO 4 (NUOVO): BRM_H Infisso + BRM_H Cassonetto <= Spazio disponibile
         ‚Ä¢ PF: confronta con HSoffitto
         ‚Ä¢ F: confronta con HParapettoSoffitto
       - Messaggi di errore pi√π chiari e specifici
    
    üîß AGGIORNAMENTI v4.87 (26 NOV 2025):
       - ZSX/ZDX Cassonetti: Sostituiti campi numerici con radio button
       - Opzioni: üß± Muro (attaccato) | ‚úÖ Libero (>50mm) | ‚ö†Ô∏è Limitato (inserisci mm)
       - Campo numerico visibile SOLO se "Limitato" selezionato
       - BRM Larghezza DINAMICO: allargamento calcolato automaticamente
         ‚Ä¢ Allargamento per lato = valoreL / 2 (es: valoreL=30 ‚Üí 15mm per lato)
         ‚Ä¢ ZSX/ZDX = Muro ‚Üí +0mm (non pu√≤ allargarsi)
         ‚Ä¢ ZSX/ZDX = Libero/Limitato ‚Üí +(valoreL/2)mm
         ‚Ä¢ Es con valoreL=30: Muro+Muro=+0 | Muro+Libero=+15 | Libero+Libero=+30
       - Ricalcolo BRM automatico quando cambia ZSX_tipo o ZDX_tipo
       - UX migliorata: meno scrittura manuale per casi comuni
    
    üîß AGGIORNAMENTI v4.86 (26 NOV 2025):
       - FIX BRM Cassonetti Larghezza: Formula "(LS+SRSX+SRDX)" ora calcolata correttamente
       - Bug: Le parentesi nella formula impedivano il parsing (split '+' creava valori errati)
       - Soluzione: Rimossi caratteri () dalla formula prima dell'elaborazione
       - Calcolo corretto: LS=1550 + SRSX=110 + SRDX=130 + 30 = 1820mm (non pi√π 140!)
       - FIX Controllo B-C Real-time: Ora si aggiorna automaticamente quando cambi B o C
       - Implementata funzione validateCassonettoBC() che era vuota
       - Aggiunto ID al div del controllo per aggiornamento DOM diretto
    
    üîß AGGIORNAMENTI v4.85 (26 NOV 2025):
    - üêõ FIX CRITICO: Errore "codTagli undefined" che bloccava addInfisso
    - ‚úÖ Aggiungere infisso ora funziona senza dover uscire/rientrare
    - ‚úÖ Corretti tutti i riferimenti a codTagli (rimosso in v4.81)
    - ‚úÖ Usato tagliTelaio per i check invece di codTagli
    
    üîß AGGIORNAMENTI v4.84 (26 NOV 2025):
    - üîÑ FIX: Sync GitHub ora include campi mancanti in configInfissi
    - ‚úÖ Aggiunti: allarme, cerniere, maniglia, coloreManiglia
    - ‚úÖ iPad e PC ora sincronizzano tutti i campi correttamente
    
    üîß AGGIORNAMENTI v4.83 (26 NOV 2025):
    - üé® FIX: Colori PVC/PVC si aggiornano subito senza cambiare schermata
    - ‚úÖ Aggiunto render() immediato dopo sync coloreInt/coloreEst
    - ‚úÖ Funziona sia in Config Globale che nelle Posizioni
    
    üîß AGGIORNAMENTI v4.82 (25 NOV 2025):
    - ‚å®Ô∏è FIX navigazione TAB in Misure Principali (LVT‚ÜíHVT‚ÜíLF‚ÜíHF‚ÜíTMV‚ÜíHMT‚ÜíL4‚ÜíH4)
    - ‚úÖ Rimosso handler che bloccava TAB nativo
    - ‚úÖ Aggiunto tabindex 100-107 per sequenza corretta
    - ‚úÖ Altezze gi√† funzionanti (tabindex 108-110)
    
    üîß AGGIORNAMENTI v4.81 (25 NOV 2025):
    - üóëÔ∏è Rimosso codTagli ridondante dal JSON (es. "SOTTO")
    - ‚úÖ tagliTelaio indica la posizione ‚Üí codTagli generato al volo
    - ‚úÖ Solo codTagliValues salvato (contiene i codici es. "128")
    - ‚úÖ Retrocompatibile con progetti esistenti
    
    üîß AGGIORNAMENTI v4.80 (25 NOV 2025):
    - üî© Nuovo campo "Cerniere" (a-vista / a-scomparsa)
    - ‚úÖ Posizionato tra Vetro e Maniglia
    - ‚úÖ Funziona in Config Globale e Posizioni
    - ‚úÖ Sincronizzazione automatica
    - üìã Numerazione aggiornata: Cerniere=10, Maniglia=11, etc.
    
    üîß AGGIORNAMENTI v4.79 (25 NOV 2025):
    - üè∑Ô∏è COD.TAGLI ora mostra dropdown con codici filtrati per telaio selezionato
    - ‚úÖ Mappa completa codici da catalogo Finstral EUR 2025/3
    - ‚úÖ Telai L: 961, 962, 963, 924, 991, 951
    - ‚úÖ Telai Z: 964, 965, 966, 967, Z62, Z91
    - ‚úÖ Funziona in Config Globale e Posizioni
    
    üîß AGGIORNAMENTI v4.78 (25 NOV 2025):
    - üé® Se PVC/PVC: coloreInt e coloreEst sempre sincronizzati
    - ‚úÖ Cambi coloreInt ‚Üí coloreEst si aggiorna automaticamente
    - ‚úÖ Funziona sia in Config Globale che nelle singole Posizioni
    
    üîß AGGIORNAMENTI v4.77 (25 NOV 2025):
    - üîß FIX COD.TAGLI in posizione: ora mostra valore (es. "128") invece del nome ("SOTTO")
    - ‚úÖ Aggiunta etichetta sopra il campo (es. "SOTTO") 
    - ‚úÖ Campo input mostra il codice corretto
    
    üîß AGGIORNAMENTI v4.76 (25 NOV 2025):
    - üíæ Auto-save dati cantiere mentre digiti (debounce 500ms)
    - ‚úÖ Non perdi pi√π dati se chiudi browser mentre scrivi
    - ‚úÖ Nessun disturbo UI (solo localStorage, no render)
    
    üîß AGGIORNAMENTI v4.75 (25 NOV 2025):
    - üßπ Quando disattivi un prodotto, pulisce automaticamente tutti i dati correlati
    - ‚úÖ Pulisce config globale, BRM, rilievo preesistente
    - ‚úÖ Pulisce tutte le posizioni (imposta a null)
    - ‚úÖ Dashboard non mostra pi√π prodotti fantasma
    - üîß FIX: Rimosso motoreAzienda/motoreModello da infissi (erano solo per tapparelle)
    - üîß FIX: finituraInt e finituraEst ora salvati correttamente nel JSON
    - ‚úÖ Rimosso vecchio campo finIntEst, sostituito con campi separati
    
    üîß AGGIORNAMENTI v4.74 (21 NOV 2025):
    - üÜï SYNC PERIODICO: Controlla aggiornamenti GitHub ogni 2 minuti automaticamente!
    - ‚úÖ Anche con tab gi√† aperto: Non serve pi√π F5 per aggiornare
    - ‚úÖ Background silenzioso: Non disturba lavoro utente
    - ‚úÖ Smart: Solo se token configurato
    - üí° RISOLVE: "Tab aperto da ore, dati vecchi" ‚Üí Ora auto-aggiorna ogni 2 min!
    
    üîß AGGIORNAMENTI v4.73 (21 NOV 2025):
    - üÜï AUTO-DOWNLOAD: Scarica automaticamente da GitHub quando apri l'app!
    - ‚úÖ Background sync: Non blocca caricamento UI (500ms delay)
    - ‚úÖ Una volta per sessione: Flag per evitare sync multipli
    - ‚úÖ Silent fail: Se errore, non disturba utente (log in console)
    - üí° RISOLVE: "Devo premere scarica ogni volta" ‚Üí Ora automatico!
    
    üîß AGGIORNAMENTI v4.72 (21 NOV 2025):
    - üö® FIX CRITICO UPLOAD: Forza saveState() PRIMA di preparare dati!
    - ‚úÖ Rilegge progetto dopo updateProjectTimestamp per versione corretta
    - ‚úÖ Usa updatedProject invece di project per dati freschi garantiti
    - üí° RISOLVE: "iPad v21 senza modifiche" - ora upload include tutte le modifiche
    - üîÑ Combo fix: Download intelligente + Upload dati freschi
    
    üîß AGGIORNAMENTI v4.71 (21 NOV 2025):
    - üö® FIX CRITICO: Sincronizzazione GitHub ora AGGIORNA progetti esistenti!
    - ‚úÖ Confronto versioni: GitHub > Locale ‚Üí SOVRASCRIVI automaticamente
    - ‚úÖ Confronto timestamp: Stessa versione ma pi√π recente ‚Üí AGGIORNA
    - ‚úÖ Messaggio dettagliato: "X nuovi, Y aggiornati"
    - ‚ö†Ô∏è Gestione conflitti: Se locale > GitHub ‚Üí Mantiene locale e avvisa
    - üí° RISOLVE: "Modifiche da PC non visibili su iPad anche dopo download"
    
    üîß AGGIORNAMENTI v4.70 (21 NOV 2025):
    - ‚úÖ IMPLEMENTATA logica condizionale cassonetti basata su azienda
    - üè¢ FINSTRAL:
      ‚Ä¢ Campo 2: Cassonetto (‚òë checkbox + text, default "Cassonetto")
      ‚Ä¢ Campo 3: Posa (‚òë checkbox + text, default "Frontale")
      ‚Ä¢ Campo 4: Colore (‚ö° AUTO da infisso.coloreEsterno + modificabile "Finiture PVC")
      ‚Ä¢ Campo 5: Isolamento Posaclima (‚òë checkbox)
      ‚Ä¢ Campo 6: A Soffitto (‚òë checkbox)
    - üè¢ MAG√í e ALPAC:
      ‚Ä¢ Campo 2: Tipo (‚ñº select: Cassonetto | Monoblocco)
      ‚Ä¢ Campo 3: Posa (‚ñº select: Frontale | Rasomuro | Esterna dal sotto | Interna dal sotto)
      ‚Ä¢ Campo 4: Finitura (‚ñº select: Grezzo da rasare | Mano di fondo)
      ‚Ä¢ Campi 5 e 6: üö´ NASCOSTI
    - ‚úÖ Logica implementata in Config Globale (Step 3) e Tab Posizioni
    - ‚úÖ Cambio azienda ‚Üí render automatico nuovi campi
    
    üíæ STRUTTURA DATI:
    - FINSTRAL: cassonettoCheck, cassonettoText, posaCheck, posaText, colore, isolamentoPosaclima, aSoffitto
    - MAG√í/ALPAC: tipo, posa, finitura
    
    ---
    
    üîß AGGIORNAMENTI v4.69 (21 NOV 2025):
    - üóëÔ∏è ELIMINATO campo "tipo" (Manuale/Motorizzata) dal rilievo preesistente tapparelle
    - ‚úÖ MANTENUTO rilievo preesistente (Materiale, Togliere, Smaltire, Note)
    - ‚úÖ 3 OPZIONI SEMPRE VISIBILI in Config Globale (punto 4):
      1. üñêÔ∏è Manuale
      2. ‚ôªÔ∏è Motore esistente (riutilizzo)
      3. ‚ö° Motorizzata (+ checkbox Forniamo motore + select Modello)
    - ‚úÖ 3 OPZIONI SEMPRE VISIBILI in Tab Posizioni (stesse opzioni)
    - ‚úÖ Nessuna logica condizionale basata su tipo esistente
    
    üìã NUOVA LOGICA SEMPLIFICATA:
    - NON serve pi√π compilare campo "tipo" nel rilievo
    - Rilievo preesistente ancora presente per altri campi (Materiale, Togliere, Smaltire, Note)
    - 3 opzioni disponibili da subito come punto 4
    - Scelta diretta del tipo tapparella
    - Checkbox "Forniamo motore" visibile solo se Motorizzata
    - Select modello motore visibile solo se checkbox attiva
    
    üíæ STRUTTURA DATI:
    - project.configTapparelle.nuovaAutomazione: "Manuale" | "Motore esistente" | "Motorizzata"
    - project.configTapparelle.forniMotore: true | false (solo se Motorizzata)
    - project.configTapparelle.modelloMotore: stringa modello (se fornitura)
    - pos.tapparella.nuovaAutomazione: (stesso schema)
    
    ---
    
    üîß AGGIORNAMENTI v4.68 (21 NOV 2025):
    - üóëÔ∏è RIMOSSA sezione "üîÑ Cosa si sostituisce?" (Entrambi/Solo Motore/Solo Tapparella)
    - ‚úÖ Semplificazione interfaccia: campi Guida e Colore Guida sempre visibili
    - ‚úÖ Condizione motori aggiornata: non dipende pi√π da tipoSostituzione
    - ‚úÖ Interfaccia pi√π pulita e lineare
    
    ---
    
    ‚ö° LOGICA CONDIZIONALE (v4.63-67): Configurazione Tapparelle Intelligente
       - Campo "4. Nuova automazione" ora CONDIZIONALE basato su tipo esistente
       - Rilievo Globale con campo "üîç Tapparella esistente" (Manuale/Motorizzata)
       - Auto-copia da rilievo globale a pos.rilievoTapparella.tipo
       
    üìã CASO A - Esistente MANUALE:
       - Opzione 1: üñêÔ∏è Rimane Manuale
       - Opzione 2: ‚ö° Motorizzata
         ‚îî‚îÄ Checkbox: üîå Forniamo motore
            ‚îî‚îÄ Select: [OXIMO IO / RS100 io Hybrid / LT HELIOS / RS100 SOLAR io]
    
    üìã CASO B - Esistente MOTORIZZATA:
       - Opzione 1: ‚ôªÔ∏è Motore esistente (riutilizzo)
       - Opzione 2: üîÑ Sostituzione motore
         ‚îî‚îÄ Select: [OXIMO IO / RS100 io Hybrid / LT HELIOS / RS100 SOLAR io]
    
    üíæ STRUTTURA DATI:
       - project.rilievoTapparelle.tipo: "Manuale" | "Motorizzata"
       - project.configTapparelle.nuovaAutomazione: "Rimane Manuale" | "Motorizzata" | "Motore esistente" | "Sostituzione motore"
       - project.configTapparelle.forniMotore: true | false (solo se Manuale‚ÜíMotorizzata)
       - project.configTapparelle.modelloMotore: stringa modello (se fornitura/sostituzione)
    
    üîÑ AUTO-SYNC:
       - Rilievo globale ‚Üí pos.rilievoTapparella.tipo
       - Config globale ‚Üí pos.tapparella.* (tutti i campi)
       - Sistema override funzionante come altri prodotti
    
    Implementazione:
    - calculateRilievoGlobaleCompleteness: total=4 per tapparelle (riga 8750)
    - renderRilievoGlobale: Campo tipo con bottoni toggle (riga 11735)
    - renderStep5ConfigTapparelle: Logica condizionale completa (riga 12495)
    - updateRilievoGlobale: Inizializzazione e copia campo tipo (riga 8417, 8459)
    - updateConfigTapparelle: Sync automatico a posizioni (esistente)
    
    ---
    
    üîß AGGIORNAMENTI v4.62 (20 NOV 2025):
    
    ‚ö° NUOVO CAMPO: Tipo Automazione Tapparelle
       - Aggiunto campo "Tipo Automazione" nel rilievo preesistente tapparelle
       - Opzioni: üñêÔ∏è Manuale | ‚ö° Motorizzata
       - Campo obbligatorio per completezza rilievo (4/4 campi)
       - Salvato in pos.rilievoTapparella.tipo
       - Visibile in dashboard per preventivi e analisi
       - Bottoni stile toggle con evidenziazione selezione
    
    Implementazione:
    - Calcolo completezza aggiornato: total = 4 per tapparelle (riga 13476)
    - Template HTML con bottoni selezione (riga 13594-13613)
    - Campo salvato via updateRilievoProdotto()
    - Integrato con sistema esistente rilievo preesistente
    
    ---
    
    üîß AGGIORNAMENTI v4.61 (20 NOV 2025):
    
    ‚ö° FIX CRITICO: Upload GitHub da iPad ora funziona
       - Problema: Safari iOS falliva codifica base64 con caratteri speciali
       - Causa: btoa(unescape(encodeURIComponent())) non compatibile iOS
       - Soluzione: Usa TextEncoder per codifica sicura + fallback
       - Upload da iPad ora funziona correttamente
    
    ‚ö° FIX: Notifiche errore upload visibili
       - Problema: Upload falliva silenziosamente (solo console.log)
       - Utente vedeva "‚úÖ Salvato" anche quando falliva
       - Soluzione: Mostra "‚ùå Impossibile salvare" se upload fallisce
       - Mostra "‚ö†Ô∏è Parziale" se alcuni progetti falliscono
       - Log dettagliati errori HTTP per debugging
    
    Implementazione:
    - TextEncoder per base64 (riga ~5919-5930)
    - Tracking progetti falliti (riga ~5297-5330)
    - Notifiche errore specifiche
    - Status sync corretto (synced/error)
    - Compatibile iOS Safari
    
    ---
    
    üîß AGGIORNAMENTI v4.52 (19 NOV 2025):
    
    ‚ö° FIX CRITICO: Tapparelle - Campi modello, tipologia e guida ora salvati nel JSON
       - Problema: Dashboard non riusciva a calcolare prezzi tapparelle
       - Causa: Normalizzazione GitHub NON salvava modello, tipologia, guida
       - Soluzione: Aggiunti 3 campi alla normalizzazione (riga 5561-5563)
       - Dashboard ora riceve dati completi per calcolo prezzi
       - Progetti vecchi: Fallback a stringa vuota ''
    
    Implementazione:
    - normalized.tapparella ora include:
      ‚Ä¢ modello: pos.tapparella.modello || ''
      ‚Ä¢ tipologia: pos.tapparella.tipologia || ''
      ‚Ä¢ guida: pos.tapparella.guida || ''
    - Retrocompatibile con progetti esistenti
    - Fix richiesto da analisi JSON completa
    
    ---
    
    üîß AGGIORNAMENTI v4.50 (19 NOV 2025):
    
    ‚ö° FIX CRITICO: Menu hamburger ora funziona!
       - Problema: Carattere `});\\n` letterale invece di newline reale
       - Causa: "Uncaught SyntaxError: Invalid or unexpected token"
       - Riga 19262: Rimosso `\\n` problematico
       - Menu hamburger ‚ò∞ ora funziona correttamente
       - 2 errori JavaScript risolti
    
    Implementazione:
    - Sostituito `});\\n` con `});` normale
    - Verificati altri backslash-n (tutti corretti dentro stringhe)
    - Test locale superato
    
    ---
    
    üîß AGGIORNAMENTI v4.47 (19 NOV 2025):
    
    ‚ö° FIX CRITICO: Errore sintassi JavaScript risolto
       - Problema: Liste colori inline (38 elementi) causavano "Invalid or unexpected token"
       - Soluzione: Creata costante const COLORI_PERSIANE con array
       - Rimossi caratteri "?" problematici ‚Üí sostituiti con "50"
       - Menu hamburger ora funziona correttamente
       - Migliorata leggibilit√† del codice
    
    Implementazione:
    - const COLORI_PERSIANE = [38 colori] dichiarata dopo lo state
    - renderSelectWithCustom usa COLORI_PERSIANE invece di array inline
    - Funziona in Config Globale E Posizioni
    
    ---
    
    üîß AGGIORNAMENTI v4.46 (19 NOV 2025):
    
    ‚ö° PERSIANE: Select colori con 38 opzioni
       - Colore Persiana: 38 colori CPF con descrizioni complete
       - Colore Telaio: Stessa lista di 38 colori CPF
       - Opzioni: CPF910L, CPF113L, CPF701L, CPF716L, CPF605L, CPF609T, etc.
       - Ogni colore include: Codice + Descrizione + Tipo RAL + Finitura (opaco/ruvido/textured)
       - Custom input: Possibilit√† di scrivere colori personalizzati
       - Funziona in Config Globale E Posizioni
    
    Implementazione:
    - renderSelectWithCustom per Colore Persiana e Colore Telaio
    - Lista completa 38 colori disponibili
    - Compatibile con auto-sync config ‚Üí posizioni
    
    ---
    
    üîß AGGIORNAMENTI v4.40 (18 NOV 2025):
    
    ‚ö° FIX CRITICO: Colori PVC/Alluminio cambiano IMMEDIATAMENTE
       - Prima: Bisognava uscire e rientrare dal progetto
       - Ora: Cambio finitura ‚Üí Colori si aggiornano ISTANTANEAMENTE
       - Trigger diretto in handleSelectCustomChange
       - Funziona sia per Config Globale che Posizioni
       - Funziona anche con input custom
    
    Implementazione:
    - handleSelectCustomChange chiama aggiornaColoriPerFinitura dopo 150ms
    - Input custom finitura chiama aggiornaColoriPerFinitura direttamente
    - Log console mostra "TRIGGER DIRETTO" per debug
    
    
    ---
    
    üîß AGGIORNAMENTI v4.39 (18 NOV 2025):
    
    1. COLORI PVC/ALLUMINIO - Uniformata logica:
       - aggiornaColoriPerFinitura() ora usa stessa logica di renderSelectColoreStandard()
       - Priorit√†: Se contiene "alluminio" ‚Üí colori alluminio, ALTRIMENTI ‚Üí colori PVC
       - Fix incoerenza tra le due funzioni
    
    2. MANIGLIE SEMPLIFICATE (4 opzioni):
       - STANDARD ‚Üí 601
       - A PRESSIONE ‚Üí 712
       - DOPPIA ANTA/RIBALTA ‚Üí 773
       - DOPPIA ANTA ‚Üí 772
       (Sempre possibile scrivere manualmente altri codici)
    
    3. COLORI MANIGLIA (9 opzioni complete):
       - 01 - BIANCO
       - 07 - PERLA
       - 56 - NEUTRO ANODIZZATO
       - 74 - BRONZO
       - 40 - OTTONE LUCIDO
       - 79 - TITANIO
       - M01 - BIANCO
       - M03 - NERO
       - M07 - BIANCO CREMA
       (Sempre possibile scrivere manualmente altri colori)
    
    4. VERSIONE aggiornata ovunque:
       - Tag <title>: Open Porte v4.62
       - Titolo interfaccia
       - Tutti i riferimenti
    
    
    ---
    
    üêõ FIX v4.38 (18 NOV 2025):
    
    PROBLEMA CRITICO:
    - Layout completamente rotto su TUTTI i dispositivi
    - Nessuno stile, solo testo grezzo
    - Anche versioni vecchie che funzionavano non rendono pi√π
    
    CAUSA IDENTIFICATA:
    - Google Fonts bloccato/lento ‚Üí blocca rendering
    - Font Inter da fonts.googleapis.com non carica
    - Browser aspetta timeout ‚Üí pagina rimane senza CSS
    
    SOLUZIONE v4.38:
    - RIMOSSO Google Fonts
    - Uso font di sistema (veloce, sempre disponibile)
    - Tailwind CDN rimane (necessario)
    - Font: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Arial
    
    MODIFICHE TECNICHE:
    - Riga 1269: RIMOSSA chiamata a fonts.googleapis.com
    - Riga 1273: font-family con stack di font di sistema
    - Zero dipendenze esterne critiche oltre Tailwind
    
    COMPORTAMENTO:
    ‚úÖ Caricamento istantaneo (no attesa Google Fonts)
    ‚úÖ Layout corretto su tutti i dispositivi
    ‚úÖ Funziona anche offline (dopo primo caricamento Tailwind)
    ‚úÖ Font sistema = veloce e sempre disponibile
    
    TEST:
    - Apri Console (F12)
    - Cerca errori di rete
    - Verifica che Tailwind si carichi
    
    
    ---
    
    üêõ FIX v4.37 (18 NOV 2025):
    
    PROBLEMA PERSISTENTE:
    - Finitura Esterna: "pvc"
    - Colore Esterno dropdown: mostra colori ALLUMINIO ‚ùå
    
    CAUSA IDENTIFICATA:
    - Logica if/else troppo rigida (riga 3596-3605 v4.33)
    - Non gestiva spazi extra o case sensitivity
    - If (pvc) else if (alluminio) else (pvc) ‚Üí ma se finitura=undefined cadeva su default
    
    SOLUZIONE v4.37:
    - Normalizzazione valore: trim() + toLowerCase()
    - Logica invertita: Se contiene "alluminio" ‚Üí alluminio, ALTRIMENTI ‚Üí PVC
    - PVC come default SEMPRE (pi√π sicuro)
    - Console.log per debug: mostra quale logica si attiva
    
    MODIFICHE TECNICHE:
    - Riga 3596-3610: Logica completamente riscritta
    - const finituraNormalized = (finituraValue || '').toString().trim().toLowerCase()
    - if (includes 'alluminio') ‚Üí alluminio, else ‚Üí PVC
    - console.log per ogni scelta
    
    COMPORTAMENTO:
    ‚úÖ Finitura="pvc" ‚Üí Colori PVC
    ‚úÖ Finitura="PVC" ‚Üí Colori PVC
    ‚úÖ Finitura=" pvc " ‚Üí Colori PVC (trim)
    ‚úÖ Finitura="alluminio" ‚Üí Colori Alluminio
    ‚úÖ Finitura="pvc/alluminio" ‚Üí Colori Alluminio (contiene alluminio)
    ‚úÖ Finitura=undefined ‚Üí Colori PVC (default)
    ‚úÖ Finitura="" ‚Üí Colori PVC (default)
    
    DEBUG:
    Apri Console (F12) e vedrai:
    "üé® DEBUG renderSelectColoreStandard: fieldName=coloreEst, finitura="pvc" ‚Üí normalized="pvc""
    "   ‚úÖ Finitura PVC o vuota ‚Üí 10 colori PVC"
    
    
    ---
    
    üêõ FIX v4.33 (18 NOV 2025):
    
    ‚úÖ COLORI SI AGGIORNANO IN TEMPO REALE quando cambi Finitura!
    
    PROBLEMA (screenshot utente):
    - Finitura Esterna: "alluminio" ‚úÖ
    - Colore Esterno dropdown: mostrava colori PVC ‚ùå (dovevano essere colori alluminio!)
    - Causa: renderSelectColoreStandard() generava HTML STATICO al caricamento
    - Quando utente cambiava finitura da PVC ‚Üí Alluminio, dropdown NON si aggiornava
    
    SOLUZIONE:
    - Funzione aggiornaColoriPerFinitura() (riga ~3670): Rigenera dropdown colori dinamicamente
    - Event listener globale (riga ~3730): Intercetta cambiamenti campi finitura
    - ID univoci select colori: Per identificare quale dropdown aggiornare
    - Logica automatica: Cambi finitura ‚Üí Colori si aggiornano dopo 100ms
    
    FUNZIONALIT√Ä:
    - Cambio "Finitura Interna" da PVC ‚Üí Alluminio ‚Üí "Colore Interno" si aggiorna automaticamente
    - Cambio "Finitura Esterna" da Alluminio ‚Üí PVC ‚Üí "Colore Esterno" si aggiorna automaticamente
    - Funziona in Config Globale E nelle Posizioni
    - Se colore selezionato non valido per nuova finitura ‚Üí viene resettato
    - Esempio: Finitura=PVC, Colore="L19 - Rovere verniciato" ‚Üí cambio a Alluminio ‚Üí L19 mantenuto ‚úÖ
    - Esempio: Finitura=PVC, Colore="42 - Bianco" ‚Üí cambio a Alluminio ‚Üí resettat ‚Üí "‚ñº Seleziona..." ‚ö†Ô∏è
    
    MODIFICHE TECNICHE:
    - Riga 3527-3620: renderSelectColoreStandard() con ID univoco select
    - Riga 3622-3710: Funzione aggiornaColoriPerFinitura()
    - Riga 3712-3760: Event listener globale document.addEventListener('change')
    - Console log: "üé® Aggiorno colori per finitura" quando rileva cambio
    
    RISULTATO:
    ‚úÖ Finitura PVC ‚Üí mostra colori PVC in tempo reale
    ‚úÖ Finitura Alluminio ‚Üí mostra colori alluminio in tempo reale
    ‚úÖ Cambio finitura ‚Üí dropdown aggiornato immediatamente
    ‚úÖ Colore incompatibile ‚Üí resettato automaticamente
    ‚úÖ Funziona senza reload pagina
    
    
    ---
    
    üêõ FIX v4.32 (18 NOV 2025):
    
    ‚úÖ CORRETTI COLORI DINAMICI PVC vs ALLUMINIO + Aggiunto Input Custom
    
    PROBLEMA (rilevato da screenshot utente):
    - Finitura Interna: "alluminio" ‚Üí Colore Interno mostrava: "55 - Noce chiaro decoro legno" (colore PVC!) ‚ùå
    - Finitura Esterna: "pvc" ‚Üí Colore Esterno dropdown mostrava correttamente colori alluminio ‚úÖ
    - Array colori PVC errati nel codice:
      ‚Ä¢ '42 - Bianco perla' ‚Üí doveva essere '42 - Bianco'
      ‚Ä¢ '07 - Nero' ‚Üí doveva essere '07 - Bianco perla'
    - Mancava opzione "Scrivi manualmente" per colori non standard
    
    SOLUZIONE:
    - Funzione renderSelectColoreStandard() (riga ~3484): COMPLETAMENTE RISCRITTA
    - Array PVC corretti da PDF Finstral pagina 1 (10 colori totali)
    - Array Alluminio decoro legno da PDF pagina 2 gruppo 1H (10 colori)
    - Aggiunta opzione "üñäÔ∏è Scrivi manualmente" con input custom
    - Logica identica a renderSelectWithCustom() per consistency
    
    COLORI PVC CORRETTI (dal PDF):
    01-Bianco, 45-Bianco, 27-Bianco perla, 42-Bianco, 07-Bianco perla,
    46-Grigio seta, 06-Grigio, 13-Castagno legno, 19-Rovere legno, 55-Noce chiaro legno
    
    COLORI ALLUMINIO DECORO LEGNO (dal PDF):
    L13-Castagno, L14-Mogano, L16-Douglas, L18-Noce, L19-Rovere,
    L55-Noce chiaro, LX01-Rovere naturale, LX02-Ciliegio, LX03-Pino, LX04-Rovere venato
    
    MODIFICHE TECNICHE:
    - Riga 3484-3564: renderSelectColoreStandard() con custom input
    - Array PVC: 42="Bianco" (FIX), 07="Bianco perla" (FIX)
    - Aggiunti: custom input + gestione __custom__ value
    - NO modifiche Config/Posizioni: usano gi√† renderSelectColoreStandard() ‚úÖ
    
    RISULTATO:
    ‚úÖ Finitura PVC ‚Üí mostra SOLO colori PVC
    ‚úÖ Finitura Alluminio ‚Üí mostra SOLO colori alluminio decoro legno
    ‚úÖ Opzione "Scrivi manualmente" ‚Üí utente pu√≤ inserire colori custom (es: RAL speciali)
    ‚úÖ Dashboard: riconoscer√† colori standard E custom
    ‚úÖ 4 campi aggiornati: Config Int/Est + Posizione Int/Est
    
    
    ---
    
    üêõ FIX v4.31 (18 NOV 2025):
    
    ‚úÖ IMPLEMENTATE 67 MANIGLIE FINSTRAL complete (Serie 1-4, 11-16)
    
    PROBLEMA:
    - Campi Maniglia usavano opzioni generiche: ['standard', 'satinato', 'inox', 'design', 'con-chiave']
    - Colore Maniglia usava: ['bianco', 'bronzo', 'oro', 'nero', 'inox', 'satinato']
    - Mancava integrazione con catalogo Finstral ufficiale
    - Dashboard non poteva calcolare supplementi corretti
    
    SOLUZIONE:
    - Estratte 67 maniglie complete da catalogo PDF Finstral (MANIGLIE-FINSTRAL-DB.js)
    - Config Globale (riga ~11241): Array 67 maniglie con codice+descrizione
    - Config Globale (riga ~11252): Array 13 colori con codice+descrizione
    - Posizione (riga ~13582): Stesso array 67 maniglie (eredita da Config)
    - Posizione (riga ~13593): Stesso array 13 colori (eredita da Config)
    
    FORMATO SALVATAGGIO:
    - Maniglia: "6010 - Finestra alluminio" (codice + descrizione completa)
    - Colore: "01 - Bianco", "07 - Bianco perla", "56 - Neutro anodizzato"
    - Dashboard v7.26: far√† parsing per estrarre codice e calcolare supplementi
    
    ELENCO MANIGLIE (67 totali):
    Serie 1: 6010-6031, 6470-6471, 6710-6750
    Serie 2: 7040-7071, 7720-7740, 7500-7530
    Serie 3: 8010-8011, 8020
    Serie 4: 1040-1041
    Serie 11-16: 1901-1906, 19110-19162, 49110-49162, 29110-29160
    
    COLORI (13 totali):
    01-Bianco, 07-Bianco perla, 56-Neutro anod., 79-Titanio, 74-Bronzo,
    40-Ottone, 0156-Bianco/Neutro, 0174-Bianco/Bronzo, M01-Bianco opaco,
    M03-Nero opaco, M07-Bianco crema, 43-Acciaio inox, E03-Nero anod.
    
    RISULTATO:
    ‚úÖ App: 67 maniglie Finstral selezionabili
    ‚úÖ App: 13 colori ufficiali selezionabili
    ‚úÖ Salvataggio: codice + descrizione in JSON
    ‚úÖ Compatibilit√†: Valori vecchi ("standard", "bianco") ancora funzionanti
    ‚è≥ Prossimo: Dashboard v7.26 con calcolo supplementi automatico
    
    
    ---
    
    üêõ FIX v4.30 (18 NOV 2025):
    
    ‚úÖ RISOLTO: Campi Maniglia e Colore Maniglia non venivano copiati da Config Globale a Posizione
    
    PROBLEMA 1 - COPIA DA CONFIG:
    - Config Globale: Maniglia = "inox", Colore Maniglia = "bronzo"
    - Creata nuova posizione + Aggiungi Infisso
    - Risultato: Maniglia e Colore Maniglia VUOTI (non copiati) ‚ùå
    
    PROBLEMA 2 - OPZIONI SELECT SBAGLIATE:
    - Opzioni attuali: ['standard', 'con-chiave', 'alzante-scorrevole', 'cremonese']
    - Opzioni corrette: ['standard', 'satinato', 'inox', 'design', 'con-chiave']
    - Le vecchie opzioni non corrispondevano a SPECIFICA-MANIGLIE-SOLO.md
    
    SOLUZIONE:
    - Funzione addInfisso() (riga ~8149): Aggiunto codTagliValues, maniglia, coloreManiglia
    - Ora copia TUTTI i campi da config globale quando si crea infisso
    - Aggiornate opzioni Maniglia in Config Globale (riga ~11204)
    - Aggiornate opzioni Maniglia in Posizione (riga ~13545)
    
    MODIFICHE:
    - Riga 8183-8191: addInfisso() ora copia maniglia e coloreManiglia
    - Riga 11204: Config Globale usa opzioni corrette
    - Riga 13545: Posizione usa opzioni corrette
    - Riga 357: Documentazione interna aggiornata
    
    RISULTATO:
    ‚úÖ Config Globale ‚Üí Posizione: maniglia e coloreManiglia copiati
    ‚úÖ Opzioni select conformi a specifica dashboard
    ‚úÖ Supplementi maniglie calcolati correttamente (+‚Ç¨20 inox, +‚Ç¨40 design, +‚Ç¨50 con-chiave)
    
    
    ---
    
    üêõ FIX v4.29 (18 NOV 2025):
    
    ‚úÖ RISOLTO: Colori Interno/Esterno non devono avere opzione "Scrivi manualmente"
    
    PROBLEMA:
    - Colore Esterno mostrava "üñäÔ∏è Scrivi manualmente" + input custom
    - Se config globale: Finitura=PVC, Colore="19 - Rovere"
    - Ma posizione aveva: Finitura=alluminio
    - Sistema vedeva "19 - Rovere" non in lista alluminio ‚Üí trattava come custom
    - Risultato: dropdown "Scrivi manualmente" invece di select normale
    
    SOLUZIONE:
    - Creata funzione renderSelectColoreStandard() (riga ~3405)
    - Select SOLO con colori validi per materiale corrente (PVC o Alluminio)
    - NO opzione "Scrivi manualmente"
    - NO input custom
    - Se valore non valido per materiale ‚Üí campo vuoto (selezionabile)
    
    MODIFICHE:
    - Riga 3405: Nuova funzione renderSelectColoreStandard()
    - Riga 11145: Config globale Colore Interno usa renderSelectColoreStandard
    - Riga 11156: Config globale Colore Esterno usa renderSelectColoreStandard
    - Riga 13486: Posizione Colore Interno usa renderSelectColoreStandard
    - Riga 13497: Posizione Colore Esterno usa renderSelectColoreStandard
    
    RISULTATO:
    ‚úÖ Campi colore mostrano SOLO dropdown standard
    ‚úÖ Opzioni dinamiche basate su Finitura (PVC/Alluminio)
    ‚úÖ Completamente modificabili tramite select
    ‚úÖ NO pi√π input custom per colori
    
    
    ---
    
    Open Porte v4.27 - FIX TAB FUNZIONANTE DEFINITIVO ‚úÖ
    
    üéØ FIX v4.27 (17 NOV 2025):
    
    ‚úÖ TAB FINALMENTE FUNZIONANTE:
    
    PROBLEMA v4.25/v4.26:
    - Codice inline aveva errore di sintassi JavaScript
    - Template literal interpolava male gli indici
    - event.shiftKey non valutabile in template literal
    - Risultato: TAB non funzionava durante digitazione
    
    SOLUZIONE v4.27:
    - La funzione handleMisureTabNavigation ESISTEVA GI√Ä ed era perfetta!
    - Errore: non veniva chiamata correttamente nei campi
    - FIX: Sostituito codice inline con chiamata corretta:
      onkeydown="handleMisureTabNavigation(event, '${pos.id}', ${index}, 8)"
    
    FUNZIONE (gi√† presente e funzionante):
    ```javascript
    window.handleMisureTabNavigation = (event, posId, currentIndex, totalFields) => {
        if (event.key === 'Tab') {
            event.preventDefault();
            const grid = document.getElementById(`misure-grid-${posId}`);
            const inputs = grid.querySelectorAll('input[type="number"]');
            
            if (event.shiftKey) {
                // SHIFT+TAB indietro
                inputs[currentIndex - 1]?.focus();
            } else {
                // TAB avanti
                inputs[currentIndex + 1]?.focus();
            }
        }
    };
    ```
    
    RISULTATO:
    ‚úÖ TAB funziona SEMPRE (anche durante digitazione)
    ‚úÖ SHIFT+TAB funziona per tornare indietro
    ‚úÖ Focus automatico sul campo successivo
    ‚úÖ Campo viene selezionato automaticamente
    ‚úÖ Navigazione fluida LVT‚ÜíHVT‚ÜíLF‚ÜíHF‚ÜíTMV‚ÜíHMT‚ÜíL4‚ÜíH4
    
    ---
    
    Open Porte v4.26 - FIX AZIENDA PERSIANE ‚úÖ
    
    üêõ FIX v4.26 (17 NOV 2025):
    
    ‚úÖ RISOLTO: Campo Azienda persiane mostrava input custom
    
    PROBLEMA:
    - Config globale usava: "p-persiane" (minuscolo, trattino)
    - Posizione cercava: "P. Persiane" (maiuscolo, punto, spazio)
    - Mismatch ‚Üí sistema trattava come valore custom
    - Dropdown mostrava "‚úèÔ∏è Scrivi manualmente" invece del valore
    
    SOLUZIONE:
    - Sostituito "p-persiane" con "P. Persiane" in config globale
    - Ora config globale e posizione usano STESSO formato
    - Dropdown mostra correttamente "P. Persiane"
    - Input custom resta nascosto (come altri campi)
    
    MODIFICHE:
    - Riga 11123: ['p-persiane'] ‚Üí ['P. Persiane']
    
    RISULTATO:
    ‚úÖ Campo Azienda persiane funziona come gli altri
    ‚úÖ Dropdown mostra valore corretto
    ‚úÖ Nessun input custom visibile se non necessario
    ‚úÖ Coerenza tra config globale e posizioni
    
    ---
    
    Open Porte v4.25 - FIX TAB DEFINITIVO ‚úÖ
    
    üéØ NUOVO v4.25 (17 NOV 2025):
    
    ‚úÖ FIX TAB MISURE - SOLUZIONE DEFINITIVA:
    
    PROBLEMA:
    - TAB non funzionava quando digitavi in un campo e premevi TAB
    - Input type="number" ha comportamento speciale con TAB
    - tabindex da soli non bastano durante la digitazione
    
    SOLUZIONE APPLICATA:
    - Aggiunto onkeydown inline compatto su ogni campo
    - Intercetta TAB, fa preventDefault
    - Trova campo successivo con querySelectorAll
    - Fa focus() e select() sul campo successivo
    - Supporta SHIFT+TAB per andare indietro
    
    CODICE:
    ```javascript
    onkeydown="if(event.key==='Tab'){
        event.preventDefault();
        const inputs=document.querySelectorAll('#misure-grid-ID input');
        const next=inputs[INDEX ¬± 1];
        if(next){next.focus();next.select();}
    }"
    ```
    
    RISULTATO:
    ‚úÖ TAB funziona SEMPRE, anche mentre digiti
    ‚úÖ SHIFT+TAB funziona per tornare indietro
    ‚úÖ Campo successivo viene automaticamente selezionato
    ‚úÖ Navigazione fluida e naturale
    
    ---
    
    Open Porte v4.24 - TIPO OBBLIGATORIO INFISSI/PERSIANE ‚úÖ
    
    üéØ NUOVO v4.24 (17 NOV 2025):
    
    ‚úÖ CAMPO TIPO OBBLIGATORIO:
    
    RICHIESTA UTENTE:
    - Campo "Tipo" (F1/F2/PF1/PF2/etc.) deve essere obbligatorio
    - Per INFISSI: F1, PF1, F2, PF2, F3, PF3, HST, FISSO
    - Per PERSIANE: F1, PF1, F2, PF2, F3, PF3, SCORREVOLE
    
    IMPLEMENTAZIONE:
    
    1Ô∏è‚É£ FEEDBACK VISIVO:
       - Campo VUOTO: Bordo arancione spesso + sfondo crema
       - Campo COMPILATO: Bordo grigio normale + sfondo bianco
       - Asterisco rosso (*) su label per indicare obbligatoriet√†
    
    2Ô∏è‚É£ CAMBIO DINAMICO:
       - onChange ‚Üí cambio colore istantaneo
       - Select vuoto ‚Üí border-2 border-orange-400 bg-orange-50
       - Select compilato ‚Üí border bg-white
    
    3Ô∏è‚É£ DOVE APPLICATO:
       - Infissi in posizione: Campo "Tipo"
       - Persiane in posizione: Campo "Tipo"
       - Funzione handleProductSelectWithCustom aggiornata
    
    MODIFICHE TECNICHE:
    - Riga ~13053: Infisso tipo + feedback visivo
    - Riga ~13580: Persiana tipo + feedback visivo
    - Riga 6537: handleProductSelectWithCustom con cambio colore
    
    RISULTATO:
    ‚úÖ Utente vede immediatamente se tipo manca (arancione)
    ‚úÖ Label con asterisco rosso (*) indica obbligatoriet√†
    ‚úÖ Compilazione pi√π guidata e intuitiva
    ‚úÖ Coerente con sistema feedback visivo v4.22
    
    ---
    
    Open Porte v4.23 - FIX NAVIGAZIONE TAB MISURE ‚úÖ
    
    üéØ NUOVO v4.23 (17 NOV 2025):
    
    ‚úÖ FIX NAVIGAZIONE TAB IN MISURE:
    
    PROBLEMA: 
    - Tasto TAB non funzionava tra campi LVT, HVT, LF, HF, etc.
    - Funzione custom handleMisureTabNavigation usava preventDefault
    - Bloccava navigazione naturale del browser
    
    SOLUZIONE:
    - RIMOSSA funzione custom onkeydown
    - AGGIUNTI attributi tabindex nativi (100-110)
    - Sequenza: LVT(100) ‚Üí HVT(101) ‚Üí LF(102) ‚Üí HF(103) ‚Üí 
      TMV(104) ‚Üí HMT(105) ‚Üí L4(106) ‚Üí H4(107) ‚Üí
      H Soffitto(108) ‚Üí H Parapetto(109) ‚Üí H Pavimento(110)
    
    MODIFICHE:
    1. Rimosso: onkeydown="handleMisureTabNavigation(...)"
    2. Aggiunto: tabindex="100-110" su tutti i campi misure
    3. Browser gestisce TAB nativamente
    
    RISULTATO:
    ‚úÖ TAB funziona perfettamente tra tutti i campi
    ‚úÖ SHIFT+TAB torna indietro
    ‚úÖ Navigazione fluida e naturale
    ‚úÖ Funziona anche su mobile con tastiera esterna
    
    ---
    
    Open Porte v4.22 - FEEDBACK VISIVO + FIX APERTURA ‚úÖ
    
    üö® FIX CRITICI v4.20 (17 NOV 2025):
    
    ‚ùå‚Üí‚úÖ OVERLAY MENU BLOCCATO:
       - PROBLEMA: Overlay menu rimaneva attivo e bloccava interfaccia
       - SOLUZIONE: Aggiunta chiusura menu in tutte funzioni navigazione:
         ‚Ä¢ openProject(), openPosition(), goBack(), showProjectsList()
         ‚Ä¢ createProject callback
       - RISULTATO: Overlay si chiude automaticamente, app utilizzabile
    
    ‚ùå‚Üí‚úÖ ID ANNOP001 NON FUNZIONAVA:
       - PROBLEMA: createProject() usava vecchia funzione generateProjectId()
       - VECCHIO: 2025_11_0001 (anno_mese_numero)
       - NUOVO: 2025P001 (ANNOP001)
       - SOLUZIONE: Sostituito generateProjectId() con generateId()
       - RISULTATO: ID sequenziale corretto #2025P001, #2025P002, etc.
    
    ---
    
    ‚ú® MODIFICHE v4.20 (17 NOV 2025):
    
    üéØ ID SEQUENZIALE ANNOP001:
       - Formato: ANNOP001 (esempio: 2025P001)
       - Anno (4 cifre) + P + Numero sequenziale (3 cifre)
       - Supporta fino a 999 progetti per anno
       - Visualizzazione: #2025P001, #2025P002, etc.
    
    üß≠ NAVIGAZIONE POSIZIONI MIGLIORATA:
       - Header a 2 righe: Navigazione principale + Comandi posizione
       - Pulsante "üîß Setup" per tornare a configurazioni globali
       - Dropdown posizioni avanzato con:
         ‚Ä¢ Icone stato: ‚úÖ completo, ‚ö†Ô∏è parziale, ‚ùå incompleto
         ‚Ä¢ Percentuale completamento per ogni posizione
         ‚Ä¢ Indicatore ‚ñ∂Ô∏è per posizione corrente
         ‚Ä¢ Mostra nome + ambiente
       - Layout responsive mobile/tablet/desktop
    
    üéØ LISTA PROGETTI CON ID:
       - ID visibile in card: #2025P001
       - Layout: ID ‚Üí Nome ‚Üí Cliente ‚Üí Info
       - Icone: üë§ Cliente, üìã Posizioni, üóÇÔ∏è Progetto
    
    ---
    
    Open Porte v4.19 - LISTA PROGETTI ALL'AVVIO + FIX ADDPOSITION ‚úÖ
    
    ‚ú® MODIFICHE v4.19 (17 NOV 2025):
    
    üéØ APERTURA APP ‚Üí LISTA PROGETTI:
       - All'avvio dell'app, se non c'√® currentProject ‚Üí mostra lista progetti
       - Logica aggiunta in loadState() dopo caricamento dati
       - Migliore UX: utente vede subito i suoi progetti
    
    üîß FIX AGGIUNTA POSIZIONE:
       - PROBLEMA: saveState() chiamato PRIMA di impostare state.currentPosition/screen
       - SOLUZIONE: Riordinato operazioni in addPosition():
         1. updateProjectTimestamp()
         2. state.currentPosition = pos.id
         3. state.screen = 'position'
         4. saveState() ‚Üê Ora salva stato completo
         5. render()
       - Ora la posizione si apre correttamente dopo la creazione
    
    ---
    
    Open Porte v4.17 - SCELTA PRODOTTI: Pagina Iniziale con Pulsante o Checkbox ‚úÖ
    
    ‚ú® MODIFICHE v4.17 SCELTA PRODOTTI (18 NOV 2025):
    
    üéØ PAGINA INIZIALE PRODOTTO:
       - Nuova posizione ‚Üí prodotti NON inizializzati (undefined)
       - Utente DEVE fare scelta esplicita per ogni prodotto abilitato
       - Due opzioni visibili: "+ Aggiungi [Prodotto]" O "‚ö†Ô∏è Non presente"
    
    üìã COMPORTAMENTO UTENTE:
       SCELTA A: Click "+ Aggiungi Infisso"
       - Chiama addInfisso() esistente
       - Prodotto creato PRECOMPILATO con Config Globale
       - Campi gi√† popolati (azienda, telaio, colori, ecc.)
       
       SCELTA B: Check "‚ö†Ô∏è Non presente"
       - Prodotto aggiunto a pos.prodottiAssenti
       - Pulsante "Aggiungi" nascosto
       - Posizione marcata senza quel prodotto
    
    üîÑ CAMBIO IDEA:
       - Se check ‚Üí uncheck: rimuove da prodottiAssenti, mostra pulsante
       - Se uncheck ‚Üí check: aggiunge a prodottiAssenti, nasconde pulsante
       - Checkbox sempre cliccabile per cambiare stato
    
    ‚úÖ VANTAGGI:
       - Zero prodotti dimenticati (utente deve decidere)
       - Configurazione veloce (campi precompilati)
       - Flessibilit√† (pu√≤ sempre cambiare idea)
       - Chiarezza visiva (stato sempre visibile)
    
    üóëÔ∏è RIMOSSO:
       - Auto-inizializzazione prodotti in addPosition()
       - Flag notPresent (usa pos.prodottiAssenti esistente)
       - Funzioni helper toggleProductPresence/enableProduct
    
    ‚úÖ MANTENUTO:
       - Funzione toggleProdottoAssente() esistente
       - Funzioni add[Prodotto]() esistenti (gi√† copiano config)
       - Logica rendering migliorata per UX
    
    ---
    
    Open Porte v4.10 - MENU UNIFICATO: Config Globale = Config Posizioni ‚úÖ
    
    ‚ú® MODIFICHE v4.10 MENU UNIFICATO (14 NOV 2025):
    
    üéØ UNIFICAZIONE MENU CONFIGURAZIONE:
       - Menu Step 3 (Config Globale) ora identico al menu nelle Posizioni
       - Tutti gli 11 campi Finstral disponibili sia in globale che in ogni posizione
       - Ereditariet√† automatica: posizioni partono da config globale
       - Override locale: modifiche posizione protette da auto-sync
    
    üé® COLORI SEMPLIFICATI E DINAMICI:
       - PVC: 15 colori completi (Bianco, Beige, Verde, Blu, Grigio, Marrone)
       - Alluminio: 14 effetti legno esclusivi (Winchester, Noce, Douglas, Larice, ecc.)
       - Dropdown colori si aggiorna automaticamente in base a finitura selezionata
       - Se PVC ‚Üí mostra colori PVC | Se Alluminio ‚Üí mostra solo legni
    
    üìã CAMPI MENU COMPLETO:
       1. Azienda (finstral, essepi, schuco, + custom)
       2. Tipo Anta (step/nova/slim/classic-line, + custom)
       3. Finitura Interna (pvc, legno, alluminio, ceramica)
       4. Finitura Esterna (pvc, alluminio, ceramica)
       5. Colore Interno (dinamico: 15 PVC o 14 Alluminio)
       6. Colore Esterno (dinamico: 15 PVC o 14 Alluminio)
       7. Telaio (961, 965, 967, Z62, Z91, + custom)
       8. Allarme (si/no)
       9. Vetro (doppio, doppio-sat, triplo, triplo-sat)
       10. Maniglia (67 codici Finstral: 6010-Finestra alluminio, 7040-Finestra S2, 8010-Acciaio inox, 1901-S11, ecc.)
       11. Colore Maniglia (13 colori: 01-Bianco, 07-Bianco perla, 56-Neutro anod., 79-Titanio, M01-Bianco opaco, ecc.)
    
    üîß FUNZIONI NUOVE:
       - renderSelectColore(): Gestisce dropdown colori dinamici
       - Aggiornamento automatico colori al cambio finitura
       - Validazione opzioni in base a materiale selezionato
    
    ---
    
    Open Porte v4.5 - AUTO-SYNC FIX: Sincronizzazione Automatica e Fix Campo Rilievo ‚úÖ
    
    ‚ú® MODIFICHE AUTO-SYNC + FIX (12 NOV 2025):
    
    ‚úÖ FIX MAPPING CAMPI RILIEVO:
       - PROBLEMA: Il sistema cercava pos.rilievoInfissi ma il campo √® pos.rilievo
       - CAUSA: Inconsistenza nei nomi dei campi tra globale e posizione
         ‚Ä¢ Globale: project.rilievoInfissi, project.rilievoPersiane, ecc.
         ‚Ä¢ Posizione: pos.rilievo (infissi), pos.rilievoPersiane, ecc.
       - SOLUZIONE: Aggiunto mapping corretto in tutte le funzioni:
         ‚Ä¢ renderRilievoPerProdotto: productType === 'infissi' ? 'rilievo' : 'rilievo[Prodotto]'
         ‚Ä¢ isRilievoPersonalizzato: stesso fix
         ‚Ä¢ updateRilievoProdotto: stesso fix  
         ‚Ä¢ copiaRilievoDaGlobaleProdotto: stesso fix
       - RISULTATO: I dati del rilievo infissi ora vengono visualizzati correttamente!
    
    ‚úÖ SINCRONIZZAZIONE AUTOMATICA RILIEVI:
       - PROBLEMA: Solo rilievo infissi veniva copiato nelle nuove posizioni
       - SOLUZIONE: La funzione addPosition ora copia TUTTI i rilievi globali:
         ‚Ä¢ rilievo (infissi) - FIXATO mapping
         ‚Ä¢ rilievoPersiane - NUOVO auto-sync
         ‚Ä¢ rilievoTapparelle - NUOVO auto-sync  
         ‚Ä¢ rilievoZanzariere - NUOVO auto-sync
         ‚Ä¢ rilievoCassonetti - NUOVO auto-sync
       - RISULTATO: Creando una nuova posizione, tutti i dati vengono copiati automaticamente
    
    üéØ PROBLEMI RISOLTI:
       1. Rilievo infissi che non veniva visualizzato (campo sbagliato)
       2. Altri prodotti senza sincronizzazione automatica
       3. Necessit√† di premere "Copia Rilievo" manualmente
       4. Inconsistenza dati tra progetto iniziale e posizioni
    
    Open Porte v3.5 - FASE 021f: FIX COMPLETAMENTO >100% ‚úÖ
    
    ‚ú® MODIFICHE FASE 021f (03 NOV 2025 - CHAT 021 FIX PERCENTUALE):
    ‚úÖ FIX COMPLETAMENTO SUPERIORE AL 100%:
       - PROBLEMA: Completamento posizione mostrava 130% invece di max 100%
       - UTENTE: "COME FA AD ESSERE SUPERIORE DEL 100% INCOMPLETO"
       - CAUSA: Punti doppi assegnati per prodotti assenti
       - BUG: Riga 3181 dava 30 punti per prodotti assenti
              Riga 3215 aggiungeva ALTRI 30 punti se tutti assenti
              Totale: 20 + 20 + 30 + 30 = 100... ma 30 contati 2 volte = 130%!
       - SOLUZIONE: Rimossa riga 3214-3216 (aggiunta doppia punti misure)
       - RISULTATO: Completamento MAX 100% sempre! ‚úÖ
    
    üéØ LOGICA CORRETTA PUNTEGGIO:
       ```
       1. Nome posizione:  20 punti max
       2. Ambiente:        20 punti max
       3. Prodotti OK:     30 punti max (presenti + dichiarati assenti)
       4. Misure complete: 30 punti max (solo per prodotti PRESENTI)
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       TOTALE MAX:        100 punti (100%)
       ```
    
    ‚ú® MODIFICHE FASE 021e (03 NOV 2025 - CHAT 021 FIX DROPDOWN):
    ‚úÖ FIX HEADER CHE COPRE DROPDOWN:
       - PROBLEMA: Header fisso con z-index alto copriva dropdown select
       - UTENTE: "Non riesco a selezionare la parte alta" 
       - SOLUZIONE 1: position fixed ‚Üí sticky (scorre con pagina)
       - SOLUZIONE 2: z-index 1000 ‚Üí 40 (meno invasivo)
       - SOLUZIONE 3: height 60px ‚Üí 50px (header pi√π compatto)
       - SOLUZIONE 4: select:focus z-index: 50 (dropdown sopra header)
       - RISULTATO: Dropdown selezionabili in tutta la pagina! ‚ú®
    
    üéØ MODIFICHE CSS:
       ```css
       .app-header {
           position: sticky;    /* era: fixed */
           height: 50px;        /* era: 60px */
           z-index: 40;         /* era: 1000 */
       }
       
       select:focus {
           position: relative;
           z-index: 50;         /* sopra header */
       }
       ```
    
    ‚ú® MODIFICHE FASE 021d (03 NOV 2025 - CHAT 021 FIX HEADER):
    ‚úÖ FIX CRITICO HEADER POSIZIONI:
       - PROBLEMA: Header hamburger NON appariva in pagina posizioni
       - CAUSA: renderProjectMenu() usava state.projects[currentProject] (accesso array per indice)
       - CORRETTO: state.projects.find(p => p.id === currentProject) (ricerca per ID)
       - RISULTATO: Header con menu hamburger ora visibile in tutte le pagine progetto
       - Menu "‚Üê Lista Progetti" funziona in ogni sezione
    
    üêõ BUG SPECIFICO:
       ```javascript
       // PRIMA (SBAGLIATO) - riga 2064
       const project = state.projects[state.currentProject]; // currentProject √® ID, non indice!
       
       // DOPO (CORRETTO)
       const project = state.projects.find(p => p.id === state.currentProject);
       ```
    
    ‚ú® MODIFICHE FASE 021c (03 NOV 2025 - CHAT 021 FIX FINALE):
    ‚úÖ FIX MENU SISTEMA COMPLETO:
       - Rimosso COMPLETAMENTE vecchio header e menu statico dal body
       - Header ora renderizzato dinamicamente per ogni sezione
       - Lista progetti: Header() con pulsanti Import/Export/Nuovo
       - Progetto: renderTopNavbar() con hamburger + menu laterale
       - PositionDetail: renderTopNavbar() con menu laterale (come progetto)
       - Pulsante "‚Üê Lista Progetti" nel menu laterale ora funziona
       - Navigazione pulita senza duplicazioni header
       - Un solo sistema di menu, zero conflitti
    
    üîß PROBLEMI RISOLTI:
       - Due header sovrapposti (vecchio statico + nuovo dinamico)
       - Pulsanti che chiamavano funzioni inesistenti (toggleMenu, navigateTo)
       - Menu "Config Globali" che non faceva nulla
       - Impossibilit√† tornare a lista progetti
       - Overlay conflittuali
    
    üéØ STRUTTURA FINALE:
       - body: Solo <div id="app"></div>
       - render(): Chiama ProjectsList/ProjectSetup/PositionDetail
       - ProjectsList(): Include Header() con azioni lista
       - ProjectSetup(): Include renderTopNavbar() con menu laterale
       - PositionDetail(): Include renderTopNavbar() con menu laterale
    
    ‚ú® MODIFICHE FASE 021b (31 OTT 2025 - CHAT 021 CONTINUAZIONE):
    ‚úÖ FIX CRITICO VALIDAZIONE:
       - TMV >= LF: Telaio Montante Verticale deve CONTENERE Luce Foro
       - HMT >= HF: Altezza Montante Telaio deve CONTENERE Altezza Foro
       - PRIMA (SBAGLIATO): Controllava TMV < LF, HMT < HF (invertito!)
       - DOPO (CORRETTO): Controlla TMV >= LF, HMT >= HF (logica corretta)
       - Messaggio errore aggiornato con logica corretta
    
    üéØ LOGICA CORRETTA:
       Il telaio/muro (TMV, HMT) deve essere PI√ô GRANDE del foro (LF, HF)
       perch√© il foro sta DENTRO il telaio/muro, non viceversa!
    
    ‚ú® MODIFICHE FASE 021 (31 OTT 2025 - CHAT 021):
    ‚úÖ MENU LATERALE HAMBURGER:
       - Header compatto fisso con pulsante hamburger ‚ò∞
       - Menu laterale scorrevole (slide-in da sinistra)
       - Overlay scuro semi-trasparente per chiusura
       - Animazioni smooth (300ms cubic-bezier)
       - Responsive: mobile 85%, tablet 280px, desktop 320px
    
    ‚úÖ STRUTTURA MENU:
       - Info progetto (Nome + Ambiente)
       - Navigazione principale con indicatori completamento
       - Submenu Config espandibile con percentuali prodotti
       - Azioni rapide (Export JSON/PDF, Import, Lista progetti)
       - Badge completamento colorati (verde/giallo/rosso)
    
    ‚úÖ FUNZIONALIT√Ä:
       - toggleProjectMenu(): apre/chiude menu laterale
       - closeProjectMenu(): chiude menu (anche con click overlay)
       - toggleConfigMenu(): espande/collassa submenu Config
       - Navigazione chiude menu automaticamente
       - Preservate tutte funzioni calcolo completamento
       - Disabilita Posizioni se Setup incompleto
    
    ‚úÖ UX MIGLIORATA:
       - Pi√π spazio per contenuto principale
       - Mobile-friendly (standard UX mobile)
       - Azioni export/import sempre accessibili
       - Header pulito e minimale
       - Focus massimo sul contenuto
    
    ‚ú® MODIFICHE FASE 017 (29 OTT 2025 - CHAT 017):
    ‚úÖ FIX RICARICA IMMEDIATA QUANTIT√Ä:
       - Cambio quantit√† ora ricarica la pagina IMMEDIATAMENTE
       - Visualizzazione minimale/completa si aggiorna in tempo reale
       - UX migliorata: feedback istantaneo all'utente
       - Implementazione: render() chiamato automaticamente quando field='qta'
       - Fix applicato in updateProduct() dopo saveState()
    
    ‚ú® MODIFICHE FASE 016 (29 OTT 2025 - CHAT 016):
    ‚úÖ QTA=0 MANTIENE PRODOTTO VISIBILE:
       - Impostare quantit√†=0 NON elimina pi√π il prodotto dalla posizione
       - Prodotto rimane configurato e visibile
       - Utente pu√≤ aumentare quantit√† in qualsiasi momento (0‚Üí1‚Üí2‚Üí3...)
       - Logica: qta=0 = "prodotto configurato ma non presente in questa posizione"
       - Ideale per: prodotto opzionale, da decidere dopo, in attesa ordine
       - Vantaggi: Zero click inutili, massima flessibilit√†
    ‚úÖ VISUALIZZAZIONE MINIMALE PER QTA=0:
       - qta=0: Mostra SOLO il dropdown quantit√† (pagina pulita)
       - qta‚â•1: Mostra TUTTI i campi del prodotto (pagina completa)
       - Transizione automatica: cambio qta 0‚Üî1 aggiorna visualizzazione (FASE 017: fix immediato)
       - Dati sempre preservati: anche con qta=0 tutti i dati rimangono salvati
       - Applicato a: Infissi, Persiane, Tapparelle, Zanzariere, Cassonetti
       - UX migliorata: meno confusione visiva quando prodotto assente
    
    ‚ú® MODIFICHE FASE 015 (29 OTT 2025 - CHAT 015):
    ‚úÖ GESTIONE ESPLICITA DEGLI 0:
       - FIX CRITICO: cleanNegativeValues() ora preserva '0' espliciti (non li sovrascrive)
       - FIX CRITICO: addCassonetto() non sovrascrive pi√π BSuperiore='0' dell'utente
       - FIX: Visualizzazione BRM mostra "0" invece di "-" quando il valore √® zero
       - Placeholder informativi: "Inserisci misura (anche 0 se assente)"
       - Completamento: prodotto con BRM=0 √® considerato "compilato" (gi√† funzionante)
       - Export JSON: valori 0 vengono inclusi correttamente (gi√† funzionante)
       - Validazione: accetta 0 come valore valido (gi√† funzionante)
       - ‚úÖ QUANTIT√Ä PRODOTTI: Dropdown quantit√† ora parte da 0 a 10 (prima 1-10)
         * Applicato a: Infissi, Persiane, Tapparelle, Zanzariere, Cassonetti
         * Permette di indicare "quantit√† 0" per prodotti assenti in posizione
       
    üéØ PRINCIPIO FONDAMENTALE:
       - "0" nelle MISURE = VALORE ESPLICITO (l'utente ha inserito zero)
       - "" (vuoto) nelle MISURE = CAMPO MANCANTE (non ancora compilato)
       - "0" nella QUANTIT√Ä = PRODOTTO CONFIGURATO MA ASSENTE (rimane visibile e modificabile)
       - Distinzione preservata in tutto il codice!
    
    ‚ú® MODIFICHE FASE 012 (28 OTT 2025 - CHAT 012):
    
    ‚ú® MODIFICHE FASE 012 (28 OTT 2025 - CHAT 012):
    ‚úÖ MENU PRINCIPALE MIGLIORATO:
       - LAYOUT A DUE RIGHE: Nome progetto e utility in alto, navigazione in basso
       - PULSANTE "‚Üê Lista" per tornare rapidamente alla lista progetti
       - NOME PROGETTO E AMBIENTE visibili sempre nel menu
       - INDICATORI DI COMPLETAMENTO su ogni sezione (pallino colorato)
       - PERCENTUALI DI COMPLETAMENTO nel dropdown Config
       - PULSANTE "üìã Riepilogo" per visualizzare riepilogo rilievi
       - DROPDOWN CONFIG MIGLIORATO con percentuali per ogni prodotto
       
    ‚úÖ FUNZIONI DI CALCOLO COMPLETAMENTO:
       - calcolaCompletamentoCliente() - verifica campi cliente compilati
       - calcolaCompletamentoSetup() - verifica prodotti selezionati
       - calcolaCompletamentoConfig() - media completamento configurazioni
       - calcolaCompletamentoPosizioni() - posizioni con misure
       - Funzioni specifiche per ogni prodotto (Infissi, Persiane, etc.)
       
    ‚úÖ INDICATORI VISIVI:
       - Pallino VERDE = 100% completo
       - Pallino GIALLO = 50-99% completo  
       - Pallino ROSSO = 1-49% completo
       - Nessun pallino = 0% (non iniziato)
       
    ‚úÖ MIGLIORAMENTI USABILIT√Ä:
       - Click fuori dal dropdown lo chiude automaticamente
       - Tooltip con percentuale esatta al passaggio del mouse
       - Menu pi√π compatto e organizzato
       - Navigazione pi√π intuitiva con feedback visivo
    
    ‚ú® MODIFICHE FASE 03 (25 OTT 2025 - PRECEDENTE):
    ‚úÖ EXPORT JSON COMPLETO CON DATI MURO:
       - Aggiunto campo "nome_ricerca" per ricerca facile (cliente + progetto)
       - Aggiunto "caratteristiche_muro_globali" con tutti i dati globali del progetto
       - Aggiunto "caratteristiche_muro_override" per ogni posizione (se presente)
       - Aggiunto "rilievo_preesistente" per ogni posizione (se presente)
       - Include: telaio, falso, guida, coprifilo, profondit√† muro, battuta superiore tapparella
       - Versione JSON aggiornata a "1.0-FASE007"
       
    üîç RICERCA NEL JSON:
       Cerca il campo "nome_ricerca" per trovare rapidamente il progetto
       Esempio: "nome_ricerca": "Mario Rossi Appartamento Centro"
    
    ‚ú® MODIFICHE FASE 02 (25 OTT 2025 - PRECEDENTE):
    ‚úÖ BSup PRE-COMPILATO CON BATTUTA SUPERIORE TAPPARELLA:
       - Quando aggiungi un cassonetto, BSuperiore viene automaticamente pre-compilato
       - Il valore iniziale √® "Battuta Superiore con Tapparella" dalle caratteristiche muro
       - Usa le caratteristiche muro override se presenti, altrimenti quelle globali
       - Il campo rimane MODIFICABILE dall'utente
       - Migrazione automatica: cassonetti esistenti vengono inizializzati all'avvio
       - Funzioni modificate: addCassonetto(), ricalcolaBRMCassonetto(), cleanNegativeValues()
    
    ‚ú® MODIFICHE FASE 01 (25 OTT 2025 - PRECEDENTE):
    ‚úÖ OVERRIDE MANUALE VALIDAZIONE MISURE:
       - Nuovo sistema per confermare manualmente misure con errore di validazione
       - Pulsante "‚úì Conferma OK" appare accanto ai campi con errore (bordo rosso)
       - Dopo conferma: campo diventa VERDE con badge "‚úÖ CONFERMATO (manuale)"
       - L'override ignora solo l'errore specifico di quel campo
       - Pulsante "‚úï Annulla conferma" per rimuovere l'override se necessario
       - Gli override vengono salvati nel state (pos.validationOverrides)
       - Utile per casi particolari sul campo dove la misura √® corretta ma la validazione automatica √® troppo restrittiva
    
    ‚ú® MODIFICHE FASE 28 (22 OTT 2025 - PRECEDENTE):
    ‚úÖ STEP DINAMICI IN BASE AI PRODOTTI SELEZIONATI:
       - La barra degli step mostra SOLO i prodotti selezionati
       - MURO INTEGRATO NELLO STEP "PRODOTTI": Step 2 contiene sia selezione prodotti che config muro
       - Ordine: Cliente ‚Üí Prodotti+Muro ‚Üí Config Prodotti selezionati ‚Üí Posizioni
       - I numeri degli step si adattano automaticamente (es: 1,2,3,4 invece di 1,2,3,4,5,6,7,8,9)
       - Navigazione intelligente: i pulsanti Avanti/Indietro saltano solo agli step validi
       - Se deseleziono un prodotto mentre sono sul suo step ‚Üí salto automaticamente allo step successivo
    
    ‚úÖ CARATTERISTICHE MURO PERSONALIZZATE PER POSIZIONE - RISOLTO:
       - Quando clicchi "Personalizza caratteristiche muro" ora APPARE l'intera sezione modificabile
       - Aggiunta funzione updateCaratteristicheMuroOverride() per gestire le modifiche delle posizioni
       - Aggiunta funzione renderCaratteristicheMuroOverride() per mostrare tutti i campi
       - I campi vengono mostrati in un box viola/giallo per distinguerli dal globale
       - Funziona esattamente come la config globale ma modifica pos.caratteristicheMuroOverride
       - Pulsante "Ripristina globali" sempre visibile per tornare ai valori globali
    
    ‚ú® MODIFICHE FASE 27 (22 OTT 2025 - PRECEDENTE):
    ‚úÖ MODAL "NUOVO PROGETTO" OTTIMIZZATO:
       - Campo "Cliente" SEMPRE OBBLIGATORIO (identifica il progetto)
       - Campo "Nome progetto" OPZIONALE
       - Ordine invertito: Cliente ‚Üí Nome progetto
       - Se Nome progetto vuoto ‚Üí usa nome Cliente come identificativo
       - Validazione migliorata con alert se Cliente mancante
       - UI migliorata: bordo viola per campo obbligatorio, testo esplicativo
    
    ‚ú® NUOVE FUNZIONALIT√Ä PER ODOO (22 OTT 2025):
    ‚úÖ PULSANTE "STAMPA PDF":
       - Genera un PDF professionale del rilievo completo
       - Include tutti i dati: cliente, posizioni, prodotti, misure BRM
       - Pronto per essere caricato su Odoo come allegato
       - Layout ottimizzato per stampa con intestazione aziendale
    
    ‚úÖ PULSANTE "EXPORT JSON PER ODOO":
       - Esporta il singolo progetto in formato JSON
       - Struttura ottimizzata per integrazione con Odoo
       - Include: cliente, posizioni, prodotti, misure, BRM, totali
       - Nome file: RILIEVO-[Cliente]-[Progetto]-[Data].json
       - Pronto per essere caricato su Odoo e letto dal sistema
    
    ‚úÖ WORKFLOW INTEGRATO:
       1. Fai rilievo con app ‚Üí Compila tutti i dati
       2. Clicca "Stampa PDF" ‚Üí Salva PDF per archivio/stampa
       3. Clicca "Export JSON" ‚Üí Scarica file JSON
       4. Apri Odoo ‚Üí Progetto S00XXX ‚Üí Allega entrambi i file
       5. La ragazza legge il PDF per fare preventivo
       6. Il JSON √® pronto per future automazioni
    
    üéØ VANTAGGI:
       - Zero costi di sviluppo
       - Immediate integration con Odoo
       - Dati sempre aggiornati e tracciati
       - Squadra posa pu√≤ scaricare PDF da Odoo su smartphone
    
    ‚ú® MODIFICHE FASE 027 (11 NOV 2025):
    ‚úÖ AUTO-SELEZIONE TIPO INFISSO ASSOCIATO:
       - Quando selezioni tipo (F1, PF1, F2, PF2, etc) ‚Üí auto-check radio F/PF
       - Vale per INFISSI: F1,F2,F3,FISSO,HST ‚Üí auto F | PF1,PF2,PF3 ‚Üí auto PF
       - Vale per PERSIANE: F1,F2,F3 ‚Üí auto F | PF1,PF2,PF3 ‚Üí auto PF
       - Opzioni persiane allineate: F1,PF1 (prima erano FA,PFA)
       - Console log conferma selezione automatica
    
    ‚ú® MODIFICHE FASE 26 (22 OTT 2025 - PRECEDENTE):
    ‚úÖ CAMPO "TIPO TAGLI" ELIMINATO:
       - Rimosso completamente il campo "Tipo Tagli" dalla posizione infissi
       - Il campo era ridondante con la selezione "Tagli Telaio"
       - Rimangono attivi: Tagli Telaio (dropdown) e COD.TAGLI (campi multipli editabili)
    
    ‚ú® MODIFICHE FASE 25 (21 OTT 2025):
    ‚úÖ BRM FINESTRA/PORTAFINESTRA - INFISSI:
       - Config Globale (STEP 3): Aggiunta sezione "BRM FINESTRA" e "BRM PORTAFINESTRA"
       - BRM Finestra usa HF per altezza
       - BRM Portafinestra usa HPF per altezza
       - Nelle posizioni: Se tipo √® F1/F2/F3/FISSO ‚Üí usa BRM Finestra
       - Nelle posizioni: Se tipo √® PF1/PF2/PF3 ‚Üí usa BRM Portafinestra
       - Ricalcolo automatico quando cambia il tipo di infisso
       
    ‚úÖ BRM FINESTRA/PORTAFINESTRA - ZANZARIERE:
       - Config Globale (STEP 6): Aggiunta sezione "BRM FINESTRA" e "BRM PORTAFINESTRA"
       - BRM Finestra usa LF/HF
       - BRM Portafinestra usa LPF/HPF
       - Nelle posizioni: Legge il tipo dell'INFISSO nella stessa posizione
       - Se infisso √® F1/F2/F3/FISSO ‚Üí usa BRM Finestra
       - Se infisso √® PF1/PF2/PF3 ‚Üí usa BRM Portafinestra
       - Ricalcolo automatico quando cambia il tipo di infisso
       
    ‚úÖ COD.TAGLI FIX:
       - RISOLTO: Campo codTagli ora viene copiato dalla config globale in addInfisso
       - Quando selezioni "4 Lati", vedrai correttamente: SOPRA, SOTTO, SX, DX
       - Tutti i tag sono modificabili singolarmente
       
    ‚úÖ MODIFICHE TECNICHE:
       - calculateBRM() ora accetta parametro 'tipo' (es: "F1", "PF2")
       - Se tipo contiene "PF" usa configurazioni _PF (misuraBaseH_PF, etc)
       - Tutte le funzioni di ricalcolo BRM passano il tipo corretto
       - updateProduct() ricalcola BRM quando cambia tipo infisso
    
    ‚ú® MODIFICHE FASE 24 (21 OTT 2025 - PRECEDENTE):
    ‚úÖ INFISSI - HPF AGGIUNTO:
       - Aggiunto HPF (Altezza Portafinestra) nei dropdown BRM personalizzati
       - Ora disponibili: HF (finestra) e HPF (portafinestra) per altezza
       
    ‚úÖ ZANZARIERE - LPF E HPF AGGIUNTI:
       - Aggiunto LPF (Larghezza Portafinestra) nei dropdown BRM personalizzati per larghezza
       - Aggiunto HPF (Altezza Portafinestra) nei dropdown BRM personalizzati per altezza
       - Distinzione completa tra Finestra (LF/HF) e Portafinestra (LPF/HPF)
       
    ‚úÖ CASSONETTI - BRM_C E BRM_B IMPLEMENTATI:
       - Aggiunto BRM_C e BRM_B nella configurazione globale (brmConfigCassonetti)
       - Aggiunto calcolo BRM_C e BRM_B nella funzione calculateBRM()
       - Aggiunto inizializzazione BRM_C e BRM_B in addCassonetto()
       - Aggiunto ricalcolo BRM_C e BRM_B in ricalcolaBRMCassonetto()
       - Aggiunto gestione BRM_C e BRM_B in applicaBRMPersonalizzato()
       - Aggiunto gestione BRM_C e BRM_B in ripristinaGlobale()
       - Aggiunto gestione BRM_C e BRM_B in personalizzaBRM()
       - Visualizzazione formula globale e personalizzata per C e B
       - Dropdown per selezionare misure base (C, B, HCASS, BSuperiore)
       - Campi risultato per BRM_C e BRM_B
    
    ‚ú® MODIFICHE FASE 20A (20 OTT 2025 - PRECEDENTE):
    ‚úÖ NUOVO SISTEMA BRM PERSONALIZZATO - COMPLETAMENTE RIDISEGNATO:
    ‚úÖ NUOVO SISTEMA BRM PERSONALIZZATO - COMPLETAMENTE RIDISEGNATO:
       - RIMOSSO: Propriet√† usaGlobale (confusa e causava errori)
       - RIMOSSO: Funzione toggleUsaGlobale()
       - AGGIUNTO: personalizzaBRM() - Crea formula personalizzata per posizione
       - AGGIUNTO: ripristinaGlobale() - Elimina personalizzazione, torna a globale
       
    üéØ NUOVO FUNZIONAMENTO PI√ô CHIARO:
       - Di default ‚Üí Ogni posizione usa la formula GLOBALE (dalle impostazioni progetto)
       - Per personalizzare ‚Üí Bottone "üé® Personalizza BRM" (viola)
       - Personalizzato ‚Üí Mostra form con dropdown per modificare formula
       - Ripristina ‚Üí Bottone "‚Ü©Ô∏è Usa Globale" (verde) per tornare a formula standard
       
    ‚úÖ LOGICA SEMPLIFICATA:
       - Se esiste product.brmPersonalizzato ‚Üí Usa formula personalizzata
       - Se NON esiste ‚Üí Usa formula globale (project.brmConfigXXX)
       - Nessun toggle, nessuna ambiguit√†!
       
    ‚úÖ APPLICATO A TUTTI I PRODOTTI:
       - Infissi, Persiane, Tapparelle, Zanzariere, Cassonetti
       - Per cassonetti: bottone "Ricalcola BRM" visibile SOLO con formula globale
       
    ‚úÖ VANTAGGI:
       - Pi√π chiaro: o usi globale, o usi personalizzato (no toggle confuso)
       - Visivamente distinto: bottoni colorati diversamente
       - Pi√π facile da debuggare: logica lineare senza flag booleani
       - Pi√π stabile: nessun conflitto tra usaGlobale e brmPersonalizzato
    
    ‚ú® MODIFICHE FASE 15_FIX3 (20 OTT 2025 - PRECEDENTE):
    ‚úÖ CONFIG GLOBALE INFISSI (STEP 3) - ULTRA SEMPLIFICATA:
       - RIMOSSO: Misure Principali (LVT, HVT, LF, HF, TMV, HMT, LVAR, HVAR)
       - RIMOSSO: Delta (Delta INT, Delta EST)
       - RIMOSSO: Altezze (H Soffitto, H Parapetto/Soffitto, H Pavimento/Parapetto)
       - Nella config globale STEP 3 rimangono SOLO:
         * üîß Materiale (con toggle SELECT/INPUT)
         * üìù Note
         * üî® Da togliere? (checkbox)
         * üóëÔ∏è Da smaltire? (checkbox)
         * üìè Coprifili INT? (checkbox)
         * üìê Coprifili EST? (checkbox)
       - TUTTE le misure (Principali, Delta, Altezze) sono ora SOLO nelle posizioni
       - Config globale focalizzata su informazioni comuni e scelte operative
    
    ‚ú® MODIFICHE FASE 15_FIX2 (20 OTT 2025 - PRECEDENTE):
    ‚úÖ MISURE PRINCIPALI INFISSI - SOLO NELLE POSIZIONI:
       - RIMOSSO: Misure Principali (LVT, HVT, LF, HF, TMV, HMT, LVAR, HVAR) dalla config globale STEP 3
       - Le Misure Principali ora sono disponibili SOLO dentro ogni singola posizione
       - Nella config globale (STEP 3) rimangono solo:
         * Delta (Delta INT, Delta EST)
         * Altezze (H Soffitto, H Parapetto/Soffitto, H Pavimento/Parapetto)
         * Materiale
         * Note
         * Checkbox (Da togliere, Da smaltire, Coprifili INT, Coprifili EST)
    
    ‚ú® MODIFICHE FASE 15_FIX (20 OTT 2025 - PRECEDENTE):
    ‚úÖ BRM PERSONALIZZATO SEMPLIFICATO:
       - updateBRMPersonalizzato() ora fa semplicemente render() completo
       - RIMOSSO: Codice complesso con querySelector che cercava manualmente gli elementi
       - RISULTATO: Nessun errore di inserimento nella posizione!
       - Pi√π stabile, pi√π affidabile, pi√π semplice da manutenere
       - Il BRM si aggiorna correttamente in tempo reale
    
    ‚ú® MODIFICHE FASE 15 (PRECEDENTE):
    ‚úÖ RILIEVO PREESISTENTE INFISSI - MISURE VISIBILI SUBITO:
    ‚úÖ RILIEVO PREESISTENTE INFISSI - MISURE VISIBILI SUBITO:
       - Misure Principali (LVT, HVT, LF, HF, TMV, HMT, LVAR, HVAR) in griglia 4 colonne
       - Delta (Delta INT, Delta EST) in griglia compatta
       - Altezze (H Soffitto, H Parapetto/Soffitto, H Pavimento/Parapetto)
       - Posizionate PRIMA di Materiale e Note
       - Visibili SOLO per Infissi
       - Funzione updateMisureGlobaliInfissi(projectId, field, value)
       - Salvataggio in project.misureGlobaliInfissi
    
    ‚ú® MODIFICHE FASE 13a (PRECEDENTI):
    ‚úÖ CAMPO "COSA C'√à" - ELIMINATO:
       - Rimosso completamente il campo "üè† Cosa c'√®?" dal rilievo preesistente
       - Layout adattato da 3 a 2 colonne (Materiale + Note)
    
    ‚úÖ CAMPO "MATERIALE" - SELECT/INPUT INTERCAMBIABILE:
       - Aggiunto bottone toggle "‚úèÔ∏è Scrivi" / "üìã Tendina"
       - Modalit√† SELECT (default): Dropdown con opzioni predefinite (Legno, PVC, Alluminio, Ferro)
       - Modalit√† INPUT: Campo testo libero per materiali personalizzati
       - Sincronizzazione automatica del valore tra le due modalit√†
       - Funzione toggleMaterialeMode(productType, projectId) per gestire il cambio modalit√†
    
    ‚ú® MODIFICHE FASE 13 (PRECEDENTI):
    ‚úÖ RILIEVO PREESISTENTE GLOBALE:
       - Aggiunta sezione "RILIEVO PREESISTENTE" negli STEP di configurazione (3,4,5,7)
       - Ogni prodotto (Infissi, Persiane, Tapparelle, Cassonetti) ha il suo rilievo globale
       - Campi globali per ogni prodotto:
         * üîß Materiale (SELECT/INPUT intercambiabile)
         * üìù Note
         * üî® Da togliere? (checkbox)
         * üóëÔ∏è Da smaltire? (checkbox)
       - SOLO per INFISSI anche:
         * üìè Coprifili INT? (checkbox)
         * üìê Coprifili EST? (checkbox)
       
    ‚úÖ SALVATAGGIO DATI:
       - I dati globali vengono salvati in: project.rilievoInfissi, project.rilievoPersiane, etc.
       - Ogni posizione pu√≤ modificare localmente questi dati (pos.rilievo)
       - Indicatore progresso: 0-100% completezza campi
       - Validazione visiva con colori (rosso = incompleto, verde = completo)
    
    ‚úÖ FUNZIONI NUOVE:
       - updateRilievoGlobale(projectId, productType, field, value)
       - getRilievoGlobale(project, productType)
       - calculateRilievoGlobaleCompleteness(project, productType)
       - renderRilievoGlobale(project, productType, productLabel, icon)
       - toggleMaterialeMode(productType, projectId) - FASE 13a
    
    ‚ú® MODIFICHE FASE 11_1A (PRECEDENTE):
    ‚úÖ BRM CASSONETTI - Nuove Misure Larghezza:
       - Opzioni specifiche per cassonetti: LARGH_CASS, LS, LVT, TMV, LF, MIS_FIN_INF_L, LS+SRDX+SRSX
       - Le altre tipologie di prodotto mantengono le misure standard
       - FORMULE COMPOSITE: Supporto per formule tipo "LS+SRDX+SRSX" (somma automatica di pi√π misure)
       - Le misure del cassonetto sono salvate nel cassonetto stesso (non in pos.misure)
       - Ricalcolo automatico BRM quando cambiano le misure (LS, SRSX, SRDX, etc.)
       - Bottone "Ricalcola BRM" visibile SOLO con "Usa Globale" attivo
       - Con formula personalizzata, il BRM si aggiorna automaticamente modificando i dropdown
    
    ‚úÖ TAGLI INFISSO - COD.TAGLI Automatico:
       - ELIMINATO campo "Tipo Tagli" (campo testo libero)
       - AGGIUNTO campo "COD.TAGLI" (sola lettura, automatico)
       - Codice generato automaticamente in base alla selezione di "Tagli Telaio":
         * Sopra ‚Üí SOPRA
         * Sotto ‚Üí SOTTO
         * Sopra/Sotto ‚Üí SOPRA SOTTO
         * DX ‚Üí DX
         * SX ‚Üí SX
         * DX/SX ‚Üí DX SX
         * 4 Lati ‚Üí SOPRA SOTTO SX DX
         * Sopra/Laterali ‚Üí SOPRA SX DX
         * Sotto/Laterali ‚Üí SOTTO SX DX
    
    üîß FIX TECNICI:
       - calculateBRM() ora gestisce formule composite con "+" e rimuove spazi
       - addCassonetto() inizializza tutte le misure a 0
       - updateProduct() ricalcola BRM per tutte le misure del cassonetto
       - toggleUsaGlobale() copia correttamente l'operazione dalla config globale
       - updateBRMPersonalizzato() usa le misure corrette per cassonetti
       - Bottone "Ricalcola BRM" nascosto quando si usa formula personalizzata (non serve)
    
    ‚ú® MODIFICHE FASE 11a (PRECEDENTE):
    ‚úÖ CASSONETTI - Nuovo Campo "Tipo Cassonetto":
       - Datalist selezionabile: LARGH_CASS, LS, LVT, TMV, LP, MIS_FIN_INF_L, LS+SRDX+SRSX
       - Permette sia selezione da dropdown che scrittura libera
    
    ‚úÖ MOTORI TAPPARELLE - Sistema Completo:
       - üè≠ MARCA: Somfy, Nice, Cherubini (datalist)
       - üì° MODELLO/Trasmettitore: Dinamico basato su marca
       - ‚ö° ALIMENTAZIONE: Radio Filare/Telecomando
       - üìª TRASMETTITORE: Solo se Telecomando
    
    ‚úÖ SOSTITUZIONE TAPPARELLE:
       - Radio: Solo Motore/Solo Tapparella/Entrambi
       - Campi intelligenti in base alla selezione
    
    ‚úÖ BREADCRUMB NAVIGATION:
       - Sostituita freccia con breadcrumb
       - Mostra: Progetti ‚Ä∫ Progetto ‚Ä∫ Posizione
    
    ‚ú® MODIFICHE FASE 10a (PRECEDENTE):
    ‚úÖ TUTTI I PRODOTTI - Campi Configurazione con Datalist:
       - INPUT + DATALIST: Permette sia selezione da dropdown che scrittura libera
       - INFISSO: Finitura Int/Est, Colore Int/Est, Tipo Anta, Telaio, Allarme, Vetro, Tagli Telaio
       - PERSIANA: Modello, Fissaggio, Tipo Telaio, Colore Persiana, Colore Telaio, Battuta
       - TAPPARELLA: Azienda, Modello, Colore, Manuale/Motorizzato, Sost. Esistente, Guida, Colore Guida
       - ZANZARIERA: Colore Telaio, Tipo Rete, Colore Rete
       - CASSONETTO: Tipo, Azienda, Colore, Sovrappi/Sostit, A Soffitto
    
    üí° FUNZIONAMENTO DATALIST:
    - Click sulla freccia dropdown ‚Üí Mostra opzioni predefinite dalla tabella globale
    - Scrittura diretta ‚Üí Accetta qualsiasi valore personalizzato
    - Suggerimenti mentre si digita ‚Üí Filtra le opzioni disponibili
    
    ‚ú® MODIFICHE FASE 9a-UPDATE (PRECEDENTE):
    ‚úÖ INFISSO - Tipo e Apertura aggiornati:
       - TIPO: F1, PF1, F2, PF2, F3, PF3, HST, FISSO + ‚úèÔ∏è ALTRO - SCRIVO
       - APERTURA: SX, DX, Fisso, Ribalta, Sp. SX, Sp. DX, SCORR.PARALL + ‚úèÔ∏è ALTRO - SCRIVO
       - Possibilit√† di scrivere custom e tornare a selezionare dal dropdown
    
    ‚úÖ PERSIANA - Tipo e Apertura aggiornati:
       - TIPO: F1, PF1, F2, PF2, F3, PF3, SCORREVOLE + ‚úèÔ∏è ALTRO - SCRIVO
       - APERTURA: SP SX, SP DX, LIB SX, LIB DX, SCORR SX, SCORR DX + ‚úèÔ∏è Altro SCRIVO
       - Campo input che appare quando si seleziona ALTRO - SCRIVO
       - Possibilit√† di tornare a selezionare dal dropdown
    
    ‚ú® MODIFICHE FASE 9a (RIORGANIZZAZIONE COMPLETA):
    ‚úÖ INFISSO: Riorganizzato con sezioni separate
       - üìã Dati Specifici: Quantit√†, Tipo, Apertura
       - ‚öôÔ∏è Configurazione: Finitura Int/Est, Colore Int/Est, Tipo Anta, Telaio, Allarme, Vetro, Tagli Telaio, Tipo Tagli
    
    ‚úÖ PERSIANA: Riorganizzata con sezioni separate + foto
       - üìã Dati Specifici: Quantit√†, Tipo, Apertura
       - ‚öôÔ∏è Configurazione: Modello, Fissaggio, Tipo Telaio, Colore Persiana, Colore Telaio, Battuta
       - üì∑ Foto Persiana: Upload e gestione foto
       - RISOLTO: Rimossa doppia selezione QT√Ä
    
    ‚úÖ TAPPARELLA: Riorganizzata con sezioni separate + motori dinamici
       - üìã Dati Specifici: Quantit√†
       - ‚öôÔ∏è Configurazione: Azienda, Modello, Colore, Manuale/Motorizzato, Sost. Esistente, Guida, Colore Guida
       - üîå Motori: Sezione dinamica con "+ Aggiungi Motore"
    
    ‚úÖ ZANZARIERA: Riorganizzata con tipo infisso associato
       - üîß Tipo Infisso Associato: Radio button F (Finestra) / PF (Porta Finestra)
       - ‚ö†Ô∏è Avviso: "Seleziona prima se F o PF"
       - üìã Dati Specifici: Quantit√†, Tipo, Apertura
       - ‚öôÔ∏è Configurazione: Colore Telaio, Tipo Rete, Colore Rete
    
    ‚úÖ CASSONETTO: Riorganizzato con misure dettagliate
       - üìã Dati Generali: Quantit√†, Tipo, Azienda, Colore, Sovrappi/Sostit, A Soffitto
       - üìè Misure Cassonetto (mm): LS, SRSX, ZSX, SRDX, ZDX, HCASS, B, C, BSuperiore
       - üìù Nota: "Se SRSX = ZSX ‚Üí Muro a SX | Se SRDX = ZDX ‚Üí Muro a DX"
    
    ‚ú® MODIFICHE FASE 31 (INTEGRAZIONE):
    ‚úÖ FOTO PERSIANE: Aggiunte funzioni per gestire foto specifiche delle persiane
       - addFotoPersiana: Aggiunge foto a una persiana specifica
       - removeFotoPersiana: Rimuove foto da una persiana specifica
    
    ‚úÖ MOTORI TAPPARELLE: Aggiunte funzioni per gestire motori delle tapparelle
       - addMotoreTapparella: Aggiunge un motore a una tapparella
       - updateMotoreTapparella: Aggiorna il modello di un motore
       - removeMotoreTapparella: Rimuove un motore da una tapparella
    
    ‚ú® MODIFICHE FASE 28:
    ‚úÖ INFISSI: Aggiunto campo QT√Ä selezionabile (1-10) come per le Persiane
       - Select dropdown per selezionare quantit√†
       - Default: 1
       - Visibile nella griglia dettagli infisso
    
    ‚úÖ PERSIANE TIPO: Opzioni allineate con infissi
       - Lista completa: F1, PF1, F2, PF2, F3, PF3, SCORREVOLE
       - Opzione "‚úèÔ∏è ALTRO - SCRIVO" per tipi personalizzati
    
    ‚úÖ LAYOUT OTTIMIZZATO:
       - Grid infissi: 4 colonne (QT√Ä + 6 campi)
       - Prima riga: QT√Ä, Azienda, Finitura Int, Finitura Est
       - Seconda riga: Colore Int, Colore Est, Tipo Anta
    
    MODIFICHE FASE 21 (PRECEDENTE):
    ‚úÖ CAMPO PIANO: Dropdown selezionabile con opzioni predefinite
       - Piano Seminterrato, Piano Terra, Piano Rialzato
       - Primo-Quinto Piano, Attico, Mansarda
    
    ‚úÖ CONFIG INFISSI: Rimossa sezione Motori (i motori vanno su tapparelle)
       - Mantiene tutti gli altri 10 campi
       - Formula BRM personalizzabile
    
    ‚úÖ CONFIG PERSIANE: Campi completi con dropdown
       - Tipo (Battente, Scorrevole, A libro, Orientabile)
       - Materiale (Alluminio, Legno, PVC, Alluminio-Legno)
       - Colore/Finitura (input libero)
       - Apertura (Interna, Esterna)
       - Formula BRM personalizzabile
    
    ‚úÖ CONFIG TAPPARELLE: Campi completi con MOTORI
       - Tipo (Standard, Blindata, Coibentata, Orientabile)
       - Materiale (PVC, Alluminio, Alluminio Coibentato, Acciaio)
       - Colore (input libero)
       - Comando (Manuale, Motorizzata)
       - Motori: Azienda (Somfy, Nice, Cherubini, Faac) + Modello
       - Formula BRM personalizzabile
    
    ‚úÖ CONFIG ZANZARIERE: Campi completi
       - Tipo (Avvolgibile, Pliss√©, Battente, Scorrevole, Fissa)
       - Colore Telaio (input libero)
       - Tipo Rete (Standard, Anti-polline, Pet-resistant, Micro-forata)
       - Colore Rete (Nero, Grigio, Bianco)
       - Formula BRM personalizzabile
    
    ‚úÖ CONFIG CASSONETTI: Campi completi
       - Tipo (Esterno, Incasso, Sopra-finestra, Semi-incasso)
       - Materiale (PVC, Alluminio, Alluminio Coibentato, Legno)
       - Finitura/Colore (input libero)
       - Coibentazione (Standard, Rinforzata, Acustica)
       - Formula BRM personalizzabile
    
    ‚úÖ QUANTIT√Ä NELLE POSIZIONI: Campo numerico
       - Default: 1
       - Modificabile per ogni posizione
       - Visibile nella griglia dettagli posizione
    
    ‚úÖ INIZIALIZZAZIONE AUTOMATICA: I prodotti ereditano i valori dalle config default
       - Quando aggiungi un prodotto, i campi sono pre-compilati
       - Puoi personalizzare ogni singolo prodotto
    
    ‚úÖ FUNZIONI UPDATE: Aggiunte per tutti i config
       - updateConfigPersiane
       - updateConfigTapparelle
       - updateConfigZanzariere
       - updateConfigCassonetti
    
    MODIFICHE FASE 20:
    ‚úÖ DROPDOWN PER FORMULA PERSONALIZZATA quando usaGlobale √® false
    ‚úÖ CALCOLO AUTOMATICO BRM con formula personalizzata
    ‚úÖ FIX ERRORI VARIABILI nei render delle tab prodotti
    
    MODIFICHE FASE 18B:
    ‚úÖ UN SOLO prodotto per tipo per posizione (no pi√π array)
    ‚úÖ Pulsante "Usa Globale" per BRM
    ‚úÖ Migrazione automatica dati
    ‚úÖ UI migliorata
-->
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon inline per evitare errore 404 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü™ü</text></svg>">
    <title>Open Porte v5.16 - Maniglie Blindate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- RIMOSSO: Google Fonts per velocit√† -->
    <style>
        * { 
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body { 
            overscroll-behavior-y: contain;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        input, select, textarea { 
            font-size: 16px !important;
        }
        .compact-input {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        .section-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: all 0.3s;
        }
        .section-card:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .product-pill {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 2px solid;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .product-pill.selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .brm-calculator {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .brm-result {
            background: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
            font-size: 0.875rem;
            color: #f59e0b;
            text-align: center;
            margin-top: 0.5rem;
        }
        
        /* üéØ FASE 18A - STILI VALIDAZIONE */
        .input-valid {
            border: 2px solid #10b981 !important;
            background: #f0fdf4 !important;
        }
        .input-warning {
            border: 2px solid #f59e0b !important;
            background: #fffbeb !important;
        }
        .input-error {
            border: 2px solid #ef4444 !important;
            background: #fef2f2 !important;
        }
        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .validation-message.error {
            color: #ef4444;
        }
        .validation-message.warning {
            color: #f59e0b;
        }
        .validation-message.success {
            color: #10b981;
        }
        /* üõ°Ô∏è OVERRIDE VALIDAZIONE MANUALE */
        .input-overridden {
            border: 2px solid #10b981 !important;
            background: #f0fdf4 !important;
        }
        .validation-override-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #10b981;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }
        .btn-override-confirm {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #10b981;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            margin-left: 0.5rem;
            border: none;
            transition: all 0.2s;
        }
        .btn-override-confirm:hover {
            background: #059669;
            transform: scale(1.05);
        }
        .btn-override-cancel {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #6b7280;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            margin-left: 0.5rem;
            border: none;
            transition: all 0.2s;
        }
        .btn-override-cancel:hover {
            background: #4b5563;
            transform: scale(1.05);
        }
        .validation-summary {
            position: sticky;
            top: 0;
            z-index: 10;
            margin-bottom: 1rem;
        }
        .pulse-error {
            animation: pulseRed 2s infinite;
        }
        @keyframes pulseRed {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        .product-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s;
        }
        .product-card:hover {
            border-color: #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* ============================================
           üçî MENU SISTEMA - FASE 021: MENU LATERALE
           ============================================ */

        :root {
            --menu-primary: #2563eb;
            --menu-header-bg: #1e40af;
            --menu-bg: #f8fafc;
            --menu-hover: #e2e8f0;
            --menu-text: #1e293b;
            --menu-text-sec: #64748b;
            --menu-border: #cbd5e1;
            --menu-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Header fisso compatto */
        .app-header {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: var(--menu-header-bg);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 40;
            box-shadow: var(--menu-shadow);
        }

        /* Assicura che select/dropdown nativi siano sopra header */
        select:focus {
            position: relative;
            z-index: 50;
        }

        /* Container principale con padding per non andare sotto header */
        body {
            padding-top: 0;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
            margin-right: 16px;
            transition: transform 0.2s;
        }

        .menu-toggle:hover {
            transform: scale(1.1);
        }

        .app-title {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 18px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Menu laterale progetto */
        .side-menu-project {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: var(--menu-bg);
            box-shadow: var(--menu-shadow);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1100;
            overflow-y: auto;
        }

        .side-menu-project.open {
            left: 0;
        }

        .project-menu-header {
            min-height: 50px;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--menu-header-bg);
            color: white;
            font-weight: bold;
        }

        .project-menu-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
            transition: transform 0.2s;
        }

        .project-menu-close:hover {
            transform: scale(1.1);
        }

        /* Info progetto */
        .project-info-box {
            padding: 16px;
            background: white;
            border-bottom: 2px solid var(--menu-border);
        }

        .project-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--menu-text);
            margin-bottom: 4px;
        }

        .project-ambiente {
            font-size: 14px;
            color: var(--menu-text-sec);
        }

        /* Navigazione menu */
        .nav-section {
            padding: 8px 0;
        }

        .nav-title {
            padding: 12px 16px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--menu-text-sec);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            color: var(--menu-text);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--menu-hover);
            border-left-color: var(--menu-primary);
        }

        .nav-item.active {
            background: rgba(37, 99, 235, 0.1);
            border-left-color: var(--menu-primary);
            color: var(--menu-primary);
            font-weight: 600;
        }

        .nav-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .nav-item.disabled:hover {
            background: transparent;
            border-left-color: transparent;
        }

        .nav-label {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Submenu Config */
        .nav-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.02);
        }

        .nav-submenu.open {
            max-height: 500px;
        }

        .nav-submenu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px 12px 52px;
            color: var(--menu-text);
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-submenu-item:hover {
            background: var(--menu-hover);
        }

        .nav-submenu-item.active {
            background: rgba(37, 99, 235, 0.1);
            color: var(--menu-primary);
            font-weight: 600;
        }

        /* Indicatori completamento */
        .completion-badge {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .completion-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .completion-dot.green { background: #22c55e; }
        .completion-dot.yellow { background: #eab308; }
        .completion-dot.red { background: #ef4444; }

        .completion-percent {
            font-size: 11px;
            font-weight: 600;
            color: var(--menu-text-sec);
        }

        /* Azioni menu */
        .menu-actions {
            padding: 16px;
            border-top: 2px solid var(--menu-border);
            background: white;
        }

        .menu-action-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--menu-border);
            background: white;
            color: var(--menu-text);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-action-btn:hover {
            background: var(--menu-hover);
            border-color: var(--menu-primary);
        }

        .menu-action-btn.primary {
            background: var(--menu-primary);
            color: white;
            border-color: var(--menu-primary);
        }

        .menu-action-btn.primary:hover {
            background: #1d4ed8;
        }

        /* Overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1050;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .menu-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        /* ===== MENU PRINCIPALE APPLICAZIONE ===== */
        .main-menu {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: var(--menu-bg, #ffffff);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.15);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1100;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .main-menu.open {
            left: 0;
        }
        
        .main-menu-header {
            min-height: 56px;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }
        
        .main-menu-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
            transition: transform 0.2s;
        }
        
        .main-menu-close:hover {
            transform: scale(1.1);
        }
        
        .main-menu-title {
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        /* Search Bar */
        .main-menu-search {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Main Navigation Section */
        .main-nav-section {
            flex: 1;
            padding: 8px 0;
        }
        
        .main-nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .main-nav-item:hover {
            background: #f5f5f5;
            transform: translateX(5px);
        }
        
        .main-nav-item.expandable .main-nav-arrow {
            transition: transform 0.3s;
        }
        
        .main-nav-item.expanded .main-nav-arrow {
            transform: rotate(90deg);
        }
        
        .main-nav-label {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .main-nav-icon {
            font-size: 20px;
        }
        
        .main-nav-arrow {
            margin-left: auto;
            color: #999;
            font-size: 12px;
        }
        
        /* Submenu */
        .main-submenu {
            max-height: 0;
            overflow: hidden;
            background: #f8f8f8;
            transition: max-height 0.3s ease-out;
        }
        
        .main-submenu.open {
            max-height: 300px;
        }
        
        .main-submenu-item {
            padding: 12px 20px 12px 52px;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .main-submenu-item:hover {
            background: #e8e8e8;
            border-left-color: #667eea;
            color: #333;
        }
        
        /* Main Menu Overlay */
        .main-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1050;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .main-menu-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Quick Actions Bottom */
        .main-menu-bottom {
            padding: 16px;
            border-top: 2px solid #e5e5e5;
            background: white;
        }
        
        .quick-actions-title {
            font-size: 11px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .quick-actions-grid {
            display: flex;
            gap: 8px;
            justify-content: space-around;
        }
        
        .quick-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: 2px solid #e5e5e5;
            background: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Main content */
        .main-content {
            margin-top: 60px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 767px) {
            .side-menu-project {
                width: 85%;
                max-width: 320px;
            }
        }

        @media (min-width: 1024px) {
            .header-actions {
                gap: 12px;
            }
            
            .btn-icon {
                padding: 10px 16px;
            }
        }

        /* ‚òÅÔ∏è FASE 022a: OneDrive Sync UI */
        .sync-badge {
            display: inline-block;
            margin-left: auto;
        }
        
        /* üé® FASE DISEGNI: Badge conteggio */
        .count-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        .sync-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .sync-settings-dialog {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .sync-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .sync-settings-header h3 {
            margin: 0;
            font-size: 20px;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .sync-account {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            margin: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }

        .sync-options {
            padding: 0 20px;
            margin: 20px 0;
        }

        .sync-options label {
            display: flex;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            color: #1e293b;
            transition: color 0.2s;
        }

        .sync-options label:hover {
            color: #2563eb;
        }

        .sync-options input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .sync-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 0 20px;
            margin: 20px 0;
        }

        .btn-sync {
            padding: 10px 16px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-sync:hover {
            background: #f8fafc;
            border-color: #2563eb;
            color: #2563eb;
        }

        .btn-sync:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #1e40af;
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border: 1px solid #cbd5e1;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .sync-info {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            font-size: 14px;
            color: #64748b;
        }

        .sync-info p {
            margin: 0 0 8px 0;
        }

        .sync-info strong {
            color: #1e293b;
        }

        .sync-info ul {
            margin: 8px 0;
        }

        .sync-info li {
            margin: 6px 0;
        }
        
        /* üÜï Select con larghezza fissa uniforme */
        select {
            min-width: 200px;
            width: 100%;
        }
    </style>
    
    <!-- Menu Sistema Module INTEGRATO -->
    <style>
        /* Aggiustamenti per compatibilit√† con menu sistema */
        body {
            padding-top: 0;
        }
        
        #app {
            transition: margin-left 0.3s ease;
        }
        
        /* Nascondi vecchi menu se presenti */
        .old-navigation,
        .main-menu {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .menu-sistema.active ~ #app {
                margin-left: 0;
            }
        }
        
        /* Menu Container */
        .menu-sistema {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            transition: left 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        
        .menu-sistema.active {
            left: 0;
        }
        
        /* Header */
        .menu-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-title {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        
        .menu-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            margin-top: 5px;
        }
        
        /* Menu Items */
        .menu-items {
            padding: 10px 0;
        }
        
        .menu-item {
            position: relative;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 30px;
        }
        
        .menu-item.active {
            background: rgba(52, 152, 219, 0.3);
            border-left: 4px solid #3498db;
        }
        
        .menu-icon {
            font-size: 20px;
            min-width: 30px;
            text-align: center;
        }
        
        .menu-label {
            flex: 1;
            font-size: 16px;
        }
        
        .menu-arrow {
            color: rgba(255,255,255,0.5);
            transition: transform 0.3s;
        }
        
        .menu-item.expanded .menu-arrow {
            transform: rotate(90deg);
        }
        
        /* Submenu */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.2);
        }
        
        .submenu.active {
            max-height: 500px;
        }
        
        .submenu-item {
            color: rgba(255,255,255,0.9);
            padding: 12px 20px 12px 60px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .submenu-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 70px;
        }
        
        /* Toggle Button */
        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        .menu-toggle.active {
            left: 260px;
        }
        
        .menu-toggle-icon {
            color: white;
            font-size: 24px;
        }
        
        /* Overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 9998;
        }
        
        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Footer */
        .menu-footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .sync-status {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .sync-status.connected {
            color: #2ecc71;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- üéØ FASE 021b: App container - tutto renderizzato dinamicamente -->
    <div id="app"></div>
    
    <!-- üìä SheetJS per export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // State Management
        let state = {
            screen: 'list',
            projects: [],
            currentProject: null,
            currentPosition: null,
            setupStep: 1,
            showRiepilogoRilievi: false,  // Per mostrare il riepilogo rilievi
            sincronizzazioneVerificata: false,  // Flag per verifica sincronizzazione (1 volta per sessione)
            projectMenuOpen: false,  // ‚úÖ FASE 021: Menu laterale aperto/chiuso
            configMenuExpanded: false,  // ‚úÖ FASE 021: Submenu Config espanso/collassato
            mainMenuOpen: false,  // ‚úÖ FASE 023: Menu principale applicazione
            // üì¶ FASE 027K: GitHub Sync
            github: {
                connected: false,
                token: null,
                lastSyncTime: null,
                syncStatus: 'disconnected', // disconnected|synced|syncing|error
                autoSyncEnabled: true,
                autoBackupEnabled: true,
                syncNotifications: true
            }
        };

        // ‚öôÔ∏è VERSIONE APP - UNICO PUNTO DA MODIFICARE
        const APP_VERSION = '5.19-test';
        const APP_VERSION_NOTE = 'üß™ TEST CATALOGO INTERATTIVO';
        
        // üÜï v4.79: Mappa codici taglio disponibili per tipo telaio (da catalogo Finstral EUR 2025/3)
        const CODICI_TAGLIO_PER_TELAIO = {
            // Telai forma L
            '961': ['127', '107', '163', '162', '164', '165', '5N', '179N'],
            '962': ['127', '107', '161', '118', '163', '164', '165', '116', '167', '129', '132', '153', '5N', '179N', '172', '162', '166', '169'],
            '963': ['127', '107', '161', '162', '163', '164', '165', '105', '166', '170', '118', '134', '149', '172', '116', '129', '132', '167', '147', '148', '5N', '179N'],
            '924': ['127', '107', '163', '162', '164', '165', '5N', '179N'],
            '991': ['127', '107', '161', '118', '163', '164', '165', '116', '167', '129', '132', '5N', '179N', '172', '162', '166', '153', '133', '176'],
            '951': ['151', '156', '157', '119', '124', '152', '127', '121', '179N', '191', '192', '153'],
            // Telai forma Z
            '964': ['128', '110', '136', '179N', '5N'],
            '965': ['128', '110', '115', '100', '120', '125', '130', '140', '178', '179N', '5N'],
            '966': ['128', '110', '115', '100', '120', '125', '130', '135', '140', '145', '150', '160', '178', '179N', '5N'],
            '967': ['128', '131', '110', '179N', '5N'],
            // Telai Z62/Z91
            'Z62': ['128', '110', '179N', '5N'],
            'Z91': ['128', '110', '179N', '5N']
        };
        
        // Funzione helper per ottenere codici disponibili
        function getCodiciTaglioPerTelaio(telaio) {
            return CODICI_TAGLIO_PER_TELAIO[telaio] || [];
        }
        
        // üÜï v4.81: Genera array posizioni tagli da tagliTelaio (non serve pi√π salvare codTagli)
        function getPosizioniTagli(tagliTelaio) {
            const tagliMap = {
                'nessuno': [],
                'sopra': ['SOPRA'],
                'sotto': ['SOTTO'],
                'dx': ['DX'],
                'sx': ['SX'],
                'sopra-sotto': ['SOPRA', 'SOTTO'],
                'dx-sx': ['SX', 'DX'],
                '4-lati': ['SOPRA', 'SOTTO', 'SX', 'DX'],
                'sopra-laterali': ['SOPRA', 'SX', 'DX'],
                'sotto-laterali': ['SOTTO', 'SX', 'DX']
            };
            return tagliMap[tagliTelaio] || [];
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üö™ DATABASE PORTONCINI FINSTRAL FIN-DOOR - Listino EUR 2025/3 Marzo 2025
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // TELAI FIN-DOOR (supplementi ‚Ç¨/ml)
        const FINDOOR_TELAI = {
            'L-INT': {
                '961': { desc: 'PVC-PVC 77mm', spessore: 77, supplPvc: 0, supplAlu: 5.20 },
                '962': { desc: 'PVC-PVC 90mm', spessore: 90, supplPvc: 0, supplAlu: 5.61 },
                '963': { desc: 'PVC-PVC 124mm', spessore: 124, supplPvc: 2.89, supplAlu: 9.31 },
                '924': { desc: 'PVC-PVC 90mm', spessore: 90, supplPvc: 8.83, supplAlu: 14.30 },
                '991': { desc: 'PVC-PVC 90mm Z', spessore: 90, supplPvc: 10.90, supplAlu: 16.50 },
                '951': { desc: 'PVC-PVC 124mm', spessore: 124, supplPvc: 13.00, supplAlu: 20.10 },
                '705': { desc: 'ALU-ALU 78mm', spessore: 78, supplAlu: 24.20, note: 'Cerniere a scomparsa' },
                '706': { desc: 'ALU-ALU 84mm', spessore: 84, supplAlu: 32.40 },
                '711': { desc: 'ALU-ALU 102mm', spessore: 102, supplAlu: 35.00 },
                '718': { desc: 'ALU-ALU 87mm T', spessore: 87, supplAlu: 32.40 },
                '720': { desc: 'ALU-ALU 90mm', spessore: 90, supplAlu: 24.20, note: 'Solo cerniere cod.220' }
            },
            'L-EST': {
                'A961': { desc: 'PVC-PVC 77mm', spessore: 77, supplPvc: 0, supplAlu: 5.20 },
                'A962': { desc: 'PVC-PVC 90mm', spessore: 90, supplPvc: 0, supplAlu: 5.61 },
                'A705': { desc: 'ALU-ALU 78mm', spessore: 78, supplAlu: 24.20 },
                'A706': { desc: 'ALU-ALU 84mm', spessore: 84, supplAlu: 32.40 }
            },
            'Z': {
                'Z62': { desc: 'PVC-PVC 67mm', spessore: 67, supplPvc: 5.21, supplAlu: 10.40 },
                '967': { desc: 'PVC-PVC 77mm', spessore: 77, supplPvc: 10.90, supplAlu: 15.30 },
                'Z91': { desc: 'PVC-PVC 90mm', spessore: 90, supplPvc: 16.10, supplAlu: 21.70 },
                '707': { desc: 'ALU-ALU 75mm', spessore: 75, supplAlu: 36.40 }
            },
            'T': {
                '718T': { desc: 'ALU-ALU 87mm', spessore: 87, supplAlu: 32.40 },
                'AZ63': { desc: 'PVC-PVC 77mm', spessore: 77, supplPvc: 5.07, supplAlu: 11.50 }
            }
        };
        
        // TIPI ANTA (Interno - Esterno)
        const FINDOOR_TIPI_ANTA = [
            { cod: 'STEP_FRAME-STEP_FRAME', desc: 'Step Frame - Step Frame', mat: 'PVC-PVC', tab: 'PVC' },
            { cod: 'FLAT_FRAME-FLAT_FRAME', desc: 'Flat Frame - Flat Frame', mat: 'PVC-PVC', tab: 'PVC' },
            { cod: 'FLAT_FRAME-STEP_FRAME', desc: 'Flat Frame - Step Frame', mat: 'PVC-PVC', tab: 'PVC' },
            { cod: 'FLAT_PLANAR-FLAT_PLANAR', desc: 'Flat Planar - Flat Planar', mat: 'ALU-ALU', tab: 'ALU' },
            { cod: 'STEP_PLANAR-STEP_PLANAR', desc: 'Step Planar - Step Planar', mat: 'ALU-ALU', tab: 'ALU' },
            { cod: 'FLAT_PLANAR-STEP_PLANAR', desc: 'Flat Planar - Step Planar', mat: 'ALU-ALU', tab: 'ALU' },
            { cod: 'STEP_PLANAR-FLAT_FRAME', desc: 'Step Planar - Flat Frame', mat: 'ALU-PVC', tab: 'ALU' },
            { cod: 'STEP_PLANAR-STEP_FRAME', desc: 'Step Planar - Step Frame', mat: 'ALU-PVC', tab: 'ALU' }
        ];
        
        // PREZZI BASE TIPO 720 (griglia L√óH)
        const FINDOOR_PREZZI_BASE = {
            'PVC': {
                larghezze: [990, 1115, 1240, 1365],
                prezzi: {
                    2040: [1240, 1297, 1351, 1408],
                    2165: [1272, 1329, 1388, 1444],
                    2290: [1303, 1362, 1422, 1482],
                    2415: [1412, 1474, 1535, 1597],
                    2540: [1443, 1507, 1570, 1633],
                    2665: [1475, 1540, 1606, 1670],
                    2790: [1506, 1573, 1640, 1708],
                    2915: [1537, 1607, 1675, 1744]
                }
            },
            'ALU': {
                larghezze: [990, 1115, 1240, 1365, 1490],
                prezzi: {
                    2040: [1871, 1944, 2018, 2093, 2165],
                    2165: [1922, 1998, 2074, 2149, 2225],
                    2290: [1973, 2051, 2129, 2207, 2284],
                    2415: [2036, 2117, 2197, 2276, 2355],
                    2540: [2087, 2169, 2251, 2333, 2416],
                    2665: [2139, 2223, 2307, 2391, 2475],
                    2790: [2190, 2276, 2361, 2448, 2534],
                    2915: [2241, 2329, 2418, 2506, 2594]
                }
            }
        };
        
        // MODELLI ANTA con prezzi supplemento
        const FINDOOR_MODELLI_ANTA = {
            '01': { desc: 'Liscio', minL: 460, minH: 1770,
                prezzi: { 'FLAT_PLANAR': [2511, 2651], 'STEP_PLANAR': [2417, 2551], 'STEP_FRAME': [1860, 1860] }
            },
            '02': { desc: 'Fresatura 1mm', minL: 750, minH: 1770,
                prezzi: { 'FLAT_PLANAR': [2529, 2669], 'STEP_PLANAR': [2436, 2569], 'STEP_FRAME': [1878, 1878] }
            },
            '04': { desc: 'Fresatura laterale', minL: 600, minH: 1770, stessoPrezzoDi: '02' },
            '05': { desc: 'Fresatura verticale', minL: 600, minH: 1770, stessoPrezzoDi: '02' },
            '06': { desc: 'Fresatura orizzontale', minL: 600, minH: 1770, stessoPrezzoDi: '02' },
            '07': { desc: 'Fresatura linee', minL: 460, minH: 1770, stessoPrezzoDi: '02' },
            '20': { desc: 'Inserto inox', minL: 460, minH: 1770,
                prezzi: { 'FLAT_PLANAR': [2610, 2750], 'STEP_PLANAR': [2516, 2650], 'STEP_FRAME': [1946, 1946] }
            },
            '21': { desc: 'Inserto inox 2', minL: 460, minH: 1770, stessoPrezzoDi: '20' },
            '23': { desc: 'Inserto inox + fresatura', minL: 600, minH: 1770,
                prezzi: { 'FLAT_PLANAR': [2877, 3017], 'STEP_PLANAR': [2783, 2917], 'STEP_FRAME': [2192, 2192] }
            },
            '24': { desc: 'Inserto inox variante', minL: 460, minH: 1770,
                prezzi: { 'FLAT_PLANAR': [2610, 2750], 'STEP_PLANAR': [2307, 2413], 'STEP_FRAME': [1946, 1946] }
            },
            '41': { desc: 'Inserto vetro', minL: 800, minH: 1770,
                prezzi: { 'FLAT_PLANAR': [3498, 3637], 'STEP_PLANAR': [3403, 3538], 'STEP_FRAME': [2704, 2704] }
            },
            '43': { desc: 'Inserto vetro grande', minL: 880, minH: 1900,
                prezzi: { 'FLAT_PLANAR': [3796, 3936], 'STEP_PLANAR': [3702, 3836], 'STEP_FRAME': [3003, 3003] }
            }
        };
        
        // TAGLI TELAIO FIN-DOOR (‚Ç¨/ml)
        const FINDOOR_TAGLI_PREZZI = {
            '127': 2.19, '107': 2.19, '163': 2.19, '162': 2.19, '161': 2.19,
            '164': 2.75, '165': 2.75, '166': 2.19, '167': 2.75, '118': 5.22,
            '116': 2.75, '129': 2.75, '132': 2.75, '153': 2.75, '172': 5.22,
            '151': 2.19, '156': 2.19, '157': 2.19, '119': 2.19, '124': 2.19,
            '128': 2.19, '110': 2.19, '318': 5.36, '319': 5.36,
            '179N': 2.19, '179X': 2.19, '5N': 2.19
        };
        
        // TAGLI per telaio FIN-DOOR
        const FINDOOR_TAGLI_PER_TELAIO = {
            '961': ['127', '107', '163', '162', '164', '165', '179N'],
            '962': ['127', '107', '161', '118', '163', '164', '165', '116', '167', '129', '132', '153', '179N', '172', '162', '166'],
            '963': ['127', '107', '161', '162', '163', '164', '165', '105', '166', '170', '118', '134', '149', '172', '116', '129', '132', '167', '147', '148', '179N'],
            '705': ['318'], '706': ['318'], '711': ['318'], '718': ['318'], '720': ['318'],
            '707': ['318'], '967': ['128', '110', '115', '100', '120', '125', '130', '140', '179X', '179N'],
            'Z62': ['128', '110', '179N'], 'Z91': ['128', '110', '179N']
        };
        
        // MANIGLIE FIN-DOOR
        const FINDOOR_MANIGLIE = {
            'set': {
                '450': { desc: 'Alluminio standard', colori: ['56', '44', '01', '02'], prezzo: 102 },
                '452': { desc: 'Alluminio placca', colori: ['56', '44', '01', '02'], prezzo: 102 },
                '401': { desc: 'Alluminio comfort', colori: ['56', '01', '02'], prezzo: 102 },
                '404': { desc: 'Alluminio premium', colori: ['56', '01', '02'], prezzo: 138 },
                '405': { desc: 'Alluminio economica', colori: ['56'], prezzo: 75.6 },
                '501-56': { desc: 'Design moderna alu', colori: ['56'], prezzo: 138 },
                '501-43': { desc: 'Design moderna inox', colori: ['43'], prezzo: 182 },
                '507': { desc: 'Acciaio inox protezione', colori: ['43'], prezzo: 298 },
                '420': { desc: 'Acciaio inox', colori: ['43'], prezzo: 281 },
                '581': { desc: 'Serie 11', colori: ['56', 'E03'], prezzo: 151 },
                '582': { desc: 'Serie 12', colori: ['56', 'E03', '43'], prezzo: 161 },
                '583': { desc: 'Serie 13', colori: ['56', 'E03', '43'], prezzo: 210 }
            },
            'maniglioni': {
                '506': { desc: 'Pomello fisso inox', prezzo: 219 },
                '487': { desc: 'Barra 90mm', prezzo: 284 },
                '488': { desc: 'Barra 98mm L485', prezzo: 509 },
                '485': { desc: 'Barra 90mm L450', prezzo: 196 },
                '468-56': { desc: 'Design 450mm alu', prezzo: 405 },
                '468-E03': { desc: 'Design 450mm nero', prezzo: 513 },
                '391': { desc: 'Compatto L300', prezzo: 130 },
                '390': { desc: 'Quadrato inox', prezzo: 255 },
                '341': { desc: 'Quadrato design', prezzo: 287 }
            },
            'colori': {
                '01': 'Bianco', '02': 'Marrone', '43': 'Acciaio inox',
                '44': 'Alu colore inox', '56': 'Alu neutro anod.', 'E03': 'Alu nero anod.'
            }
        };
        
        // COLORI ALLUMINIO FIN-DOOR
        const FINDOOR_COLORI_ALU = {
            'gruppo1': {
                desc: 'Gruppo 1 (standard)',
                suppl: 0,
                colori: ['F716-Antracite', 'F905-Nero', 'F113-Bianco perla', 'M716-Antracite op.', 'M905-Nero op.', 'DB703-Antracite met.']
            },
            'gruppo1H': {
                desc: 'Gruppo 1H (decoro legno)',
                suppl: 0,
                colori: ['L13-Castagno', 'L14-Mogano', 'L16-Douglas', 'L18-Noce', 'L19-Rovere', 'L55-Noce chiaro']
            },
            'gruppo2': {
                desc: 'Gruppo 2 (+284‚Ç¨/ordine)',
                suppl: 284,
                colori: ['RAL a richiesta', 'F09-Bianco ghiaccio', 'F92-Grigio platino', 'LC31-Champagne', 'LC32-Dorato']
            },
            'gruppo3': {
                desc: 'Gruppo 3 (+1410‚Ç¨/ordine)',
                suppl: 1410,
                colori: ['NCS a richiesta', 'DB speciali']
            }
        };
        
        // Funzione calcolo prezzo base portoncino
        function calcolaPrezzoBasePortoncino(larghezza, altezza, tipoTabella) {
            const tab = FINDOOR_PREZZI_BASE[tipoTabella];
            if (!tab) return 0;
            
            // Trova indice colonna (larghezza >= valore)
            let idxL = 0;
            for (let i = 0; i < tab.larghezze.length; i++) {
                if (larghezza <= tab.larghezze[i]) { idxL = i; break; }
                idxL = i;
            }
            
            // Trova riga altezza
            const altezze = Object.keys(tab.prezzi).map(Number).sort((a,b) => a-b);
            let rigaH = altezze[0];
            for (const h of altezze) {
                if (altezza <= h) { rigaH = h; break; }
                rigaH = h;
            }
            
            return tab.prezzi[rigaH]?.[idxL] || 0;
        }
        
        // Funzione calcolo supplemento modello anta
        function calcolaSupplModelloAnta(modello, tipoAnta, isGrande) {
            let mod = FINDOOR_MODELLI_ANTA[modello];
            if (!mod) return 0;
            if (mod.stessoPrezzoDi) mod = FINDOOR_MODELLI_ANTA[mod.stessoPrezzoDi];
            if (!mod?.prezzi) return 0;
            
            // Determina categoria: FLAT_PLANAR, STEP_PLANAR, STEP_FRAME
            let cat = 'STEP_PLANAR';
            if (tipoAnta.includes('FLAT_PLANAR')) cat = 'FLAT_PLANAR';
            else if (tipoAnta.includes('STEP_FRAME') || tipoAnta.includes('FLAT_FRAME')) cat = 'STEP_FRAME';
            
            const prezzi = mod.prezzi[cat];
            if (!prezzi) return 0;
            return isGrande ? prezzi[1] : prezzi[0];
        }

        // üìÑ Aggiorna title dinamicamente
        document.title = `Open Porte v${APP_VERSION} - ${APP_VERSION_NOTE}`;

        // üîó LISTENER CATALOGO INTERATTIVO
        // Riceve messaggi dal catalogo esterno per selezionare modello anta
        let catalogoTargetPosition = null; // Memorizza project/pos corrente
        
        window.addEventListener('message', function(event) {
            // Verifica origine (accetta stesso dominio o github pages)
            const allowedOrigins = [
                window.location.origin,
                'https://openporte2025.github.io',
                'null' // per file:// locale
            ];
            
            if (!allowedOrigins.includes(event.origin) && event.origin !== 'null') {
                console.log('Origine non autorizzata:', event.origin);
                return;
            }
            
            const data = event.data;
            if (data && data.type === 'CATALOGO_SELECT_MODELLO') {
                console.log('üìñ Ricevuto da catalogo:', data);
                
                // Trova posizione target
                if (catalogoTargetPosition) {
                    const { projectId, posId } = catalogoTargetPosition;
                    updateIngressoData(projectId, posId, 'portoncino', 'modelloAnta', data.modello);
                    
                    // Notifica utente
                    alert(`‚úÖ Modello ${data.modello} - ${data.descrizione} selezionato!`);
                }
            }
        });
        
        // Funzione per aprire catalogo e memorizzare target
        function apriCatalogoModelli(projectId, posId) {
            catalogoTargetPosition = { projectId, posId };
            window.open('https://openporte2025.github.io/test-catalogo/catalogo-findoor-completo.html', 'catalogo_findoor');
            console.log('üìñ Catalogo aperto per posizione:', posId);
        }

        // üö® LOG VERSIONE - AUTOMATICO
        console.log('%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó', 'color: #16a34a; font-weight: bold; font-size: 14px;');
        console.log(`%c‚ïë   üö™ OPEN PORTE v${APP_VERSION} CARICATO! ‚úÖ           ‚ïë`, 'color: #16a34a; font-weight: bold; font-size: 14px;');
        console.log(`%c‚ïë   ${APP_VERSION_NOTE}!           ‚ïë`, 'color: #16a34a; font-weight: bold; font-size: 14px;');
        console.log('%c‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù', 'color: #16a34a; font-weight: bold; font-size: 14px;');
        console.log(`%cüîß v${APP_VERSION}:`, 'color: #dc2626; font-weight: bold; font-size: 13px;');
        console.log('  üì¶ CASSONETTI CONDIZIONALI: Finstral vs Mag√≤/Alpac');
        console.log('  üè¢ Finstral: checkbox+text (Cassonetto, Posa, Colore AUTO, Isolamento, Soffitto)');
        console.log('  üè¢ Mag√≤/Alpac: select (Tipo, Posa, Finitura) - campi 5-6 nascosti');
        console.log('  ‚úÖ Config Globale + Tab Posizioni implementate');
        console.log('%cüîß v4.69:', 'color: #2563eb; font-weight: bold; font-size: 13px;');
        console.log('  ‚úÖ 3 OPZIONI TAPPARELLE SEMPRE VISIBILI: Manuale | Motore esistente | Motorizzata');
        console.log(' ');

        // üé® COSTANTE COLORI PERSIANE
        const COLORI_PERSIANE = [
            'CPF910L - Bianco puro tipo Ral 9010 opaco',
            'CPF113L - Bianco perla tipo Ral1013 opaco',
            'CPF701L - Grigio argento tipo Ral 7001 opaco',
            'CPF716L - Antracite tipo Ral 7016 opaco',
            'CPF605L - Verde muschio tipo Ral 6005 opaco',
            'CPF609T - Verde abete textured tipo Ral 6009 ruvido',
            'CPF817L - Marrone cioccolato tipo Ral 8017 opaco',
            'CPF735L - Grigio luce tipo Ral 7035 opaco',
            'CPF609L - Verde abete tipo Ral6009 semiopaco',
            'CPF621L - Verde pallido tipo Ral 6021 opaco',
            'CPF119L - Beige tipo Ral 1019 opaco Grigio',
            'CPF524L - Azzurro pastello tipo Ral 5024 opaco',
            'CPF811L - Marrone Nuss tipo Ral 8011 opaco',
            'CPF910T - Bianco puro textured tipo Ral 9010 ruvido',
            'CPF113T - Bianco perla textured tipo Ral 1013 ruvido',
            'CPF701T - Grigio argento textured tipo Ral 7001 ruvido',
            'CPF305T - Rosso vino textured tipo Ral 3005 ruvido',
            'CPF605T - Verde foglia textured tipo Ral 6005 ruvido',
            'CPF817T - Marrone cioccolato textured tipo Ral 8017 ruvido',
            'CPF820H - Grey Oak',
            'CPF818H - Renolit Vulcano',
            'CPF813H - Renolit Gold',
            'CPFR811 - Marrone Renolit scuro',
            'CPF812H - Marrone Renolit dorato',
            'CPFN630 - Acacia - effetto rigato',
            'CPFN632 - Noce Reale - effetto rigato',
            'CPF90RC - Marrone RENOLIT CHIARO ruvido',
            'CPF91RS - Marrone RENOLIT SCURO ruvido',
            'CPF51CR - Marrone ciliegio Renoir ruvido',
            'CPF358R - Douglas tipo 335-S0R',
            'CPF127R - Noce scuro ruvido tipo 102-50R',
            'CPF375R - Castagno chiaro ruvido tipo 375-S0R',
            'CPF378R - Castagno scuro ruvido tipo 378-50R',
            'CPF317R - Ciliegio chiaro ruvido tipo 317-50R',
            'CPF70KA - Winchester',
            'CPFSLV7 - Verde Salvia',
            'CPFRGG4 - Ruggine EVO',
            'CPF744L - Grigio seta tipo RAL 7044 opaco'
        ];

        // üî© COSTANTE CARDINI PUNTO PERSIANE (pag. 190)
        const CARDINI_PUNTO_PERSIANE = [
            { codice: 'C.SAF90', nome: 'Cardine SAF 90mm (facciata)', prezzo: 0 },
            { codice: 'C.SAF150', nome: 'Cardine SAF 150mm (cappotto)', prezzo: 0 },
            { codice: 'C.SAF240', nome: 'Cardine SAF 240mm (cappotto spesso)', prezzo: 0 },
            { codice: 'C.SAF320', nome: 'Cardine SAF 320mm (cappotto XL)', prezzo: 0 },
            { codice: 'C.REG.SAF90', nome: 'Cardine Regolabile 90mm', prezzo: 0 },
            { codice: 'C.REG.SAF150', nome: 'Cardine Regolabile 150mm', prezzo: 0 },
            { codice: 'CHA.1', nome: 'Cardine mensola lama stretta', prezzo: 18.00 }
        ];

        // üîí COSTANTE FERMAPERSIANE PUNTO PERSIANE (pag. 182)
        const FERMAPERSIANE_PUNTO_PERSIANE = [
            { codice: 'K.EASY', nome: 'Ferma KOMFORT a scomparsa', prezzo: 56.00 },
            { codice: 'F.INC', nome: 'Fermo Piemontese incassato', prezzo: 45.00 },
            { codice: 'GRILLO', nome: 'Ferma tipo Grillo', prezzo: 0 },
            { codice: 'SALTARELLO', nome: 'Ferma tipo Saltarello', prezzo: 0 },
            { codice: 'PIEMONTESE', nome: 'Ferma tipo Piemontese', prezzo: 0 },
            { codice: 'OMETTO', nome: 'Ferma tipo Ometto (pavimento)', prezzo: 0 }
        ];

        // üßÆ CALCOLO AUTOMATICO CARDINI PER TIPOLOGIA
        // Valori da listino Punto Persiane
        function calcolaCardiniPersiana(tipologia, aperturaLibro = false) {
            const cardiniBase = {
                'F1': 2, 'F2': 4, 'F3': 5, 'F4': 6,
                'PF1': 3, 'PF2': 6, 'PF3': 7, 'PF4': 8
            };
            let qta = cardiniBase[tipologia] || 2;
            if (aperturaLibro) qta += 1; // +1 se apertura a libro
            return qta;
        }

        // üßÆ CALCOLO AUTOMATICO FERMAPERSIANE (1 per anta)
        function calcolaFermapersiane(tipologia) {
            const antePerTipo = {
                'F1': 1, 'F2': 2, 'F3': 3, 'F4': 4,
                'PF1': 1, 'PF2': 2, 'PF3': 3, 'PF4': 4
            };
            return antePerTipo[tipologia] || 1;
        }

        // üì¶ FASE 027K: Configurazione GitHub Sync
        const GITHUB_CONFIG = {
            enabled: true,
            owner: 'Openporte2025',
            repo: 'dati-cantieri',
            projectsPath: 'progetti',  // ‚ö° FIX: Path cartella progetti
            branch: 'main',
            token: '', // Caricato da localStorage
            lastSync: null,
            autoSyncInterval: 5 * 60 * 1000  // 5 minuti
        };

        let syncInterval = null;  // Timer per sync automatica
        
        // ============================================================================
        // SISTEMA INDICATORI COMPLETAMENTO
        // ============================================================================
        const CompletionSystem = {
            checkProjectData(project) {
                return !!(project.name && project.client);
            },
            checkClientData(project) {
                const c = project.clientData || {};
                return !!(c.nome || c.cognome || c.telefono);
            },
            checkProducts(project) {
                const p = project.prodotti || {};
                return Object.values(p).some(v => v === true);
            },
            checkCaratteristicheMuro(project) {
                const m = project.caratteristicheMuro || {};
                return Object.values(m).some(v => v && v !== '');
            },
            checkConfigInfissi(project) {
                if (!project.prodotti?.infissi) return null;
                const c = project.configInfissi || {};
                return !!(c.azienda || c.telaio);
            },
            checkConfigPersiane(project) {
                if (!project.prodotti?.persiane) return null;
                const c = project.configPersiane || {};
                return !!(c.azienda || c.modello);
            },
            checkConfigTapparelle(project) {
                if (!project.prodotti?.tapparelle) return null;
                const c = project.configTapparelle || {};
                return !!(c.azienda || c.tipo);
            },
            checkConfigZanzariere(project) {
                if (!project.prodotti?.zanzariere) return null;
                const c = project.configZanzariere || {};
                return !!(c.azienda || c.modelloF);
            },
            checkConfigCassonetti(project) {
                if (!project.prodotti?.cassonetti) return null;
                const c = project.configCassonetti || {};
                return !!(c.tipo || c.azienda);
            },
            checkRilieviGlobali(project) {
                const rilievi = [
                    project.rilievoInfissi,
                    project.rilievoPersiane,
                    project.rilievoTapparelle,
                    project.rilievoZanzariere,
                    project.rilievoCassonetti
                ].filter(r => r && (r.materiale || r.togliere || r.smaltimento));
                return rilievi.length > 0;
            },
            checkBRMGlobali(project) {
                const brm = [
                    project.brmConfigInfissi,
                    project.brmConfigPersiane,
                    project.brmConfigTapparelle,
                    project.brmConfigZanzariere,
                    project.brmConfigCassonetti
                ].filter(b => b && (b.misuraBaseL || b.misuraBaseH));
                return brm.length > 0;
            },
            getOverallCompletion(project) {
                if (!project) return 0;
                const checks = [
                    this.checkProjectData(project),
                    this.checkClientData(project),
                    this.checkProducts(project),
                    this.checkCaratteristicheMuro(project),
                    this.checkConfigInfissi(project),
                    this.checkConfigPersiane(project),
                    this.checkConfigTapparelle(project),
                    this.checkConfigZanzariere(project),
                    this.checkConfigCassonetti(project),
                    this.checkRilieviGlobali(project),
                    this.checkBRMGlobali(project)
                ].filter(v => v !== null);
                const completed = checks.filter(v => v === true).length;
                return checks.length > 0 ? Math.round((completed / checks.length) * 100) : 0;
            },
            getIcon(isComplete) {
                if (isComplete === null) return '';
                return isComplete ? '‚úÖ' : '‚≠ï';
            },
            getBadgeHTML(isComplete) {
                if (isComplete === null) return '';
                const icon = this.getIcon(isComplete);
                const className = isComplete ? 'complete' : 'incomplete';
                return `<span class="completion-badge ${className}">${icon}</span>`;
            },
            getProgressBar(percentage) {
                const color = percentage === 100 ? '#10b981' : 
                             percentage >= 75 ? '#3b82f6' :
                             percentage >= 50 ? '#f59e0b' : '#ef4444';
                return `
                    <div class="progress-bar" style="background: #e5e7eb; border-radius: 10px; height: 6px; overflow: hidden; margin: 5px 0;">
                        <div style="width: ${percentage}%; height: 100%; background: ${color}; transition: width 0.3s;"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280; text-align: right;">${percentage}%</div>
                `;
            }
        };
        
        // ‚ö° FASE 024B: Sistema aggiornamenti parziali DOM (approccio cloud)
        // Invece di render() completo, aggiorniamo solo gli elementi necessari
        
        /**
         * ‚ö° FASE 024B: Tracking digitazione utente (per sync silenzioso)
         */
        let lastTypingTime = 0;
        const TYPING_TIMEOUT = 3000; // 3 secondi dopo ultima digitazione
        
        function markUserTyping() {
            lastTypingTime = Date.now();
        }
        
        function isUserTyping() {
            return (Date.now() - lastTypingTime) < TYPING_TIMEOUT;
        }
        
        /**
         * Aggiorna status sync visualizzato senza render completo
         */
        function updateSyncStatusDisplay(status) {
            // Aggiorna badge sync nel menu principale
            const syncBadges = document.querySelectorAll('[data-sync-status]');
            syncBadges.forEach(badge => {
                const statusMap = {
                    'syncing': { text: '‚Üª', class: 'text-blue-500 animate-spin' },
                    'synced': { text: '‚òÅ', class: 'text-green-500' },
                    'error': { text: '‚ö†', class: 'text-red-500' },
                    'disconnected': { text: '‚óã', class: 'text-gray-400' }
                };
                const config = statusMap[status] || statusMap['disconnected'];
                badge.textContent = config.text;
                badge.className = config.class;
            });
        }
        
        /**
         * Aggiorna un singolo campo DOM senza render completo
         */
        function updateDOMField(elementId, value) {
            const el = document.getElementById(elementId);
            if (el) {
                if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
                    el.value = value;
                } else {
                    el.textContent = value;
                }
            }
        }
        
        /**
         * Aggiorna i BRM visualizzati per un prodotto specifico
         */
        function updateBRMDisplay(projectId, posId, productType) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project || !project.positions) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos) return;
            
            const product = pos[productType];
            if (!product) return;
            
            // Aggiorna i campi BRM visualizzati
            updateDOMField(`brm-l-${posId}-${productType}`, product.BRM_L || '');
            updateDOMField(`brm-h-${posId}-${productType}`, product.BRM_H || '');
        }
        
        /**
         * Aggiorna indicatori completamento senza render
         */
        function updateCompletenessIndicators(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project || !project.positions) return;
            
            project.positions.forEach(pos => {
                const comp = calculatePositionCompleteness(pos);
                const indicator = document.getElementById(`completeness-${pos.id}`);
                if (indicator) {
                    indicator.textContent = `${comp.percentage}%`;
                    indicator.className = comp.percentage === 100 
                        ? 'text-green-600 font-bold' 
                        : 'text-orange-600 font-bold';
                }
            });
        }

        // Load/Save Functions
        function loadState() {
            const saved = localStorage.getItem('openPorteData');
            if (saved) {
                try {
                    state = JSON.parse(saved);
                    console.log('üìÇ CARICATO DA LOCALSTORAGE');
                    console.log(`   Progetti trovati: ${state.projects ? state.projects.length : 0}`);
                    
                    if (state.currentProject) {
                        const project = state.projects.find(p => p.id === state.currentProject);
                        if (project) {
                            console.log('   Progetto corrente:', project.name);
                            console.log('   rilievoInfissi:', project.rilievoInfissi);
                            console.log('   rilievoPersiane:', project.rilievoPersiane);
                            console.log('   rilievoTapparelle:', project.rilievoTapparelle);
                        }
                    }
                    
                    console.log('üîÑ ESEGUENDO migrateOldData...');
                    migrateOldData(); // Migra dati vecchi formato array -> singolo oggetto
                    
                    console.log('üîÑ ESEGUENDO migrateProjectRilievi per tutti i progetti...');
                    if (state.projects && Array.isArray(state.projects)) {
                        state.projects.forEach(project => {
                            migrateProjectRilievi(project);
                        });
                    }
                    
                    console.log('üîÑ ESEGUENDO cleanNegativeValues...');
                    cleanNegativeValues(); // ‚úÖ NUOVO: Pulisce valori negativi nei BRM
                    
                    console.log('üîÑ ESEGUENDO migrateOldProjectsMetadata...');
                    migrateOldProjectsMetadata(); // ‚úÖ SOLUZIONE C: Migra progetti senza metadata
                    
                    console.log('üîÑ ESEGUENDO migrateGitHubStructure...');
                    migrateGitHubStructure(); // üì¶ FASE 027K: Migra struttura GitHub se mancante
                    
                    console.log('üîÑ ESEGUENDO migrateProjectDrawings per tutti i progetti...');
                    // üé® FASE DISEGNI: Migra struttura drawings
                    if (state.projects && Array.isArray(state.projects)) {
                        state.projects.forEach(project => {
                            migrateProjectDrawings(project);
                        });
                        console.log('‚úÖ Struttura drawings migrata per tutti i progetti');
                    }
                    
                    console.log('üßπ ESEGUENDO cleanCorruptedProjects...');
                    cleanCorruptedProjects(); // üîß v4.57: Rimuove progetti corrotti (ID mancante/undefined)
                    
                    console.log('üîÑ ESEGUENDO migrateSostituzioneComponenti...');
                    migrateSostituzioneComponenti(); // üîß v4.92: Migra sostEsistente ‚Üí sostTipo
                    
                } catch (e) {
                    console.error('‚ùå Errore caricando stato da localStorage:', e);
                    console.log('üîÑ Resetto allo stato iniziale...');
                    // Reset to initial state if localStorage is corrupted
                    state = {
                        screen: 'list',
                        projects: [],
                        currentProject: null,
                        currentPosition: null,
                        setupStep: 1,
                        projectMenuOpen: false,
                        mainMenuOpen: false,
                        github: {
                            connected: false,
                            token: null,
                            lastSyncTime: null,
                            syncStatus: 'disconnected',
                            autoSyncEnabled: true,
                            autoBackupEnabled: true,
                            syncNotifications: true
                        }
                    };
                }
            } else {
                console.log('üì≠ localStorage vuoto - Prima apertura app');
                console.log('üí° Usa il menu per creare un nuovo progetto o scarica da GitHub');
            }
            
            // üÜï v4.22: FORZA SEMPRE apertura lista progetti all'avvio
            // Ignora screen salvato in localStorage
            state.screen = 'list';
            console.log('üìã Apertura app ‚Üí Lista progetti (forzato)');
            
            // üîß FIX CRITICO: Assicura che state.github esista SEMPRE
            if (!state.github) {
                console.warn('‚ö†Ô∏è state.github non esisteva, lo creo ora');
                state.github = {
                    connected: false,
                    token: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
            }
            
            // üîß FIX CRITICO: Assicura che state.projects sia sempre un array
            if (!state.projects || !Array.isArray(state.projects)) {
                console.warn('‚ö†Ô∏è state.projects non era un array, lo reimposto');
                state.projects = [];
            }
            
            // ‚ùå DISABILITATO: Non creare progetto demo automaticamente
            // Se non ci sono progetti, mostra schermata vuota con istruzioni
            if (state.projects.length === 0) {
                console.log('üì≠ Nessun progetto presente');
                console.log('üí° Usa il pulsante "+ Nuovo Progetto" per iniziare');
            }
            /* PROGETTO DEMO DISABILITATO
            if (state.projects.length === 0 && window.location.hostname === 'localhost') {
                console.log('üéØ Creazione progetto di esempio per test locale...');
                const demoProject = createProject('demo_' + Date.now(), 'Progetto Demo');
                demoProject.client = 'Cliente Esempio';
                demoProject.clientData = {
                    nome: 'Mario Rossi',
                    indirizzo: 'Via Roma 1',
                    telefono: '333 1234567',
                    email: 'mario.rossi@example.com'
                };
                state.projects.push(demoProject);
                console.log('‚úÖ Progetto demo creato:', demoProject.name);
                saveState();
            }
            */
        }

        // üì¶ FASE 027K: Migrazione struttura GitHub per backward compatibility
        function migrateGitHubStructure() {
            // Se state.github non esiste, crealo con valori default
            if (!state.github) {
                console.log('üîÑ Migrazione: Aggiunta struttura GitHub');
                state.github = {
                    connected: false,
                    token: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
                
                // Carica token se presente in localStorage
                const savedToken = localStorage.getItem('github_token');
                if (savedToken) {
                    state.github.token = savedToken;
                    state.github.connected = true;
                    GITHUB_CONFIG.token = savedToken;
                    console.log('‚úÖ Token GitHub caricato');
                }
                
                // Salva lo state migrato
                saveState();
            } else {
                // üì¶ FASE 027K FIX: Sincronizza token tra state e GITHUB_CONFIG
                if (state.github.token) {
                    GITHUB_CONFIG.token = state.github.token;
                    console.log('‚úÖ Token GitHub sincronizzato');
                } else {
                    // Prova a caricare da localStorage se manca in state
                    const savedToken = localStorage.getItem('github_token');
                    if (savedToken) {
                        state.github.token = savedToken;
                        state.github.connected = true;
                        GITHUB_CONFIG.token = savedToken;
                        console.log('‚úÖ Token GitHub recuperato da localStorage');
                    }
                }
            }
        }

        // ‚úÖ NUOVO: Funzione per pulire valori negativi nei BRM
        function cleanNegativeValues() {
            if (!state.projects) return;
            
            state.projects.forEach(project => {
                // Pulisci config globali
                const configs = ['brmConfigInfissi', 'brmConfigPersiane', 'brmConfigTapparelle', 
                                 'brmConfigZanzariere', 'brmConfigCassonetti'];
                
                configs.forEach(configKey => {
                    if (project[configKey]) {
                        ['valoreL', 'valoreH', 'valoreC', 'valoreB', 
                         'valoreL_PF', 'valoreH_PF'].forEach(field => {
                            if (project[configKey][field]) {
                                const val = parseFloat(project[configKey][field]);
                                if (!isNaN(val) && val < 0) {
                                    project[configKey][field] = Math.abs(val).toString();
                                }
                            }
                        });
                    }
                });
                
                // Pulisci BRM personalizzati nelle posizioni
                if (project.positions) {
                    project.positions.forEach(pos => {
                        ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'].forEach(productType => {
                            const product = pos[productType];
                            if (product && product.brmPersonalizzato) {
                                ['valoreL', 'valoreH', 'valoreC', 'valoreB'].forEach(field => {
                                    if (product.brmPersonalizzato[field]) {
                                        const val = parseFloat(product.brmPersonalizzato[field]);
                                        if (!isNaN(val) && val < 0) {
                                            product.brmPersonalizzato[field] = Math.abs(val).toString();
                                        }
                                    }
                                });
                            }
                        });
                        
                        // üîß Inizializza BSuperiore nei cassonetti esistenti
                        if (pos.cassonetto) {
                            const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                                ? pos.caratteristicheMuroOverride 
                                : project.caratteristicheMuro || {};
                            
                            const bSuperioreDefault = cm.battutaSuperioreTapparella || '0';
                            
                            // ‚úÖ FASE 015: Se BSuperiore non esiste (undefined/null/''), inizializzalo
                            // NON sovrascrivere '0' esplicito dell'utente!
                            if (pos.cassonetto.BSuperiore === undefined || 
                                pos.cassonetto.BSuperiore === null || 
                                pos.cassonetto.BSuperiore === '') {
                                pos.cassonetto.BSuperiore = bSuperioreDefault;
                            }
                        }
                    });
                }
            });
        }

        // üîß v4.92: Migrazione sostEsistente ‚Üí sostTipo + accessoriDaSostituire
        function migrateSostituzioneComponenti() {
            if (!state.projects || !Array.isArray(state.projects)) return;
            
            let migratedCount = 0;
            
            state.projects.forEach(project => {
                migratedCount += migrateSingleProjectSostituzione(project);
            });
            
            if (migratedCount > 0) {
                console.log(`‚úÖ Migrazione sostEsistente ‚Üí sostTipo: ${migratedCount} elementi aggiornati`);
                saveState();
            }
        }
        
        // Helper per migrare singolo progetto
        function migrateSingleProjectSostituzione(project) {
            let count = 0;
            
            // Migra configTapparelle
            if (project.configTapparelle) {
                if (project.configTapparelle.sostEsistente && !project.configTapparelle.sostTipo) {
                    // Converti vecchio valore in nuovo formato
                    const oldValue = project.configTapparelle.sostEsistente;
                    if (oldValue === 'Sost. tutto' || oldValue === 'Sost. Rullo S√¨') {
                        project.configTapparelle.sostTipo = 'tutto';
                    } else if (oldValue === 'Non Sost. Niente' || oldValue === 'Sost. Rullo No') {
                        project.configTapparelle.sostTipo = 'niente';
                    } else {
                        project.configTapparelle.sostTipo = 'tutto'; // default
                    }
                    count++;
                }
                // Rimuovi vecchio campo
                delete project.configTapparelle.sostEsistente;
            }
            
            // Migra posizioni con tapparella
            if (project.positions && Array.isArray(project.positions)) {
                project.positions.forEach(pos => {
                    if (pos.tapparella) {
                        if (pos.tapparella.sostEsistente && !pos.tapparella.sostTipo) {
                            // Converti vecchio valore in nuovo formato
                            const oldValue = pos.tapparella.sostEsistente;
                            if (oldValue === 'Sost. tutto' || oldValue === 'Sost. Rullo S√¨') {
                                pos.tapparella.sostTipo = 'tutto';
                                // Imposta tutti gli accessori a true
                                pos.tapparella.accessoriDaSostituire = {
                                    rullo: true, supporti: true, calotta: true,
                                    puleggia: true, avvolgitore: true, cintino: true,
                                    passacinghia: true, ganci: true, guide: true
                                };
                            } else if (oldValue === 'Non Sost. Niente' || oldValue === 'Sost. Rullo No') {
                                pos.tapparella.sostTipo = 'niente';
                                pos.tapparella.accessoriDaSostituire = {
                                    rullo: false, supporti: false, calotta: false,
                                    puleggia: false, avvolgitore: false, cintino: false,
                                    passacinghia: false, ganci: false, guide: false
                                };
                            } else {
                                pos.tapparella.sostTipo = 'tutto';
                                pos.tapparella.accessoriDaSostituire = {
                                    rullo: true, supporti: true, calotta: true,
                                    puleggia: true, avvolgitore: true, cintino: true,
                                    passacinghia: true, ganci: true, guide: true
                                };
                            }
                            count++;
                        }
                        // Rimuovi vecchio campo
                        delete pos.tapparella.sostEsistente;
                    }
                });
            }
            
            return count;
        }

        // üîß v4.57: Pulizia progetti corrotti (ID mancante o undefined)
        function cleanCorruptedProjects() {
            if (!state.projects || !Array.isArray(state.projects)) return;
            
            const originalLength = state.projects.length;
            
            // Rimuovi progetti con ID corrotto
            state.projects = state.projects.filter(project => {
                // Controlla ID valido
                const hasValidId = project.id && 
                                  project.id !== '#UNKNOWN' && 
                                  project.id !== 'undefined' && 
                                  typeof project.id === 'string' &&
                                  project.id.trim() !== '';
                
                // Controlla nome valido (almeno uno dei tre)
                const hasValidName = (project.name && project.name !== 'undefined' && project.name.trim()) ||
                                    (project.client && project.client !== 'undefined' && project.client.trim()) ||
                                    (project.clientData?.nome && project.clientData.nome !== 'undefined' && project.clientData.nome.trim());
                
                // Se progetto corrotto, logga e rimuovi
                if (!hasValidId || !hasValidName) {
                    console.warn('üóëÔ∏è PROGETTO CORROTTO RIMOSSO:', {
                        id: project.id,
                        name: project.name,
                        client: project.client,
                        hasValidId: hasValidId,
                        hasValidName: hasValidName
                    });
                    return false; // Rimuovi
                }
                
                return true; // Mantieni
            });
            
            const removedCount = originalLength - state.projects.length;
            
            if (removedCount > 0) {
                console.log(`‚úÖ Rimossi ${removedCount} progetti corrotti`);
                saveState(); // Salva stato pulito
                showNotification(`üßπ Rimossi ${removedCount} progetti corrotti dal database`, 'success', 4000);
            } else {
                console.log('‚úÖ Nessun progetto corrotto trovato');
            }
        }

        // Migrazione dati da vecchio formato (array) a nuovo formato (oggetto singolo)
        // ============================================================================
        // MIGRAZIONE RILIEVI: Aggiunge rilievi mancanti alle posizioni
        // ============================================================================
        function migrateProjectRilievi(project) {
            if (!project || !project.positions) return project;
            
            console.log(`üîÑ Migrazione rilievi per progetto: ${project.name || project.id}`);
            
            let migratedCount = 0;
            
            project.positions.forEach((pos, index) => {
                let positionMigrated = false;
                
                // PERSIANE
                if (!pos.rilievoPersiane && project.rilievoPersiane) {
                    pos.rilievoPersiane = {
                        togliere: project.rilievoPersiane.togliere || false,
                        smaltimento: project.rilievoPersiane.smaltimento || false,
                        materiale: project.rilievoPersiane.materiale || '',
                        note: project.rilievoPersiane.note || ''
                    };
                    positionMigrated = true;
                }
                
                // TAPPARELLE
                if (!pos.rilievoTapparelle && project.rilievoTapparelle) {
                    pos.rilievoTapparelle = {
                        togliere: project.rilievoTapparelle.togliere || false,
                        smaltimento: project.rilievoTapparelle.smaltimento || false,
                        materiale: project.rilievoTapparelle.materiale || '',
                        note: project.rilievoTapparelle.note || ''
                    };
                    positionMigrated = true;
                }
                
                // ZANZARIERE
                if (!pos.rilievoZanzariere && project.rilievoZanzariere) {
                    pos.rilievoZanzariere = {
                        togliere: project.rilievoZanzariere.togliere || false,
                        smaltimento: project.rilievoZanzariere.smaltimento || false,
                        materiale: project.rilievoZanzariere.materiale || '',
                        note: project.rilievoZanzariere.note || ''
                    };
                    positionMigrated = true;
                }
                
                // CASSONETTI
                if (!pos.rilievoCassonetti && project.rilievoCassonetti) {
                    pos.rilievoCassonetti = {
                        togliere: project.rilievoCassonetti.togliere || false,
                        smaltimento: project.rilievoCassonetti.smaltimento || false,
                        materiale: project.rilievoCassonetti.materiale || '',
                        note: project.rilievoCassonetti.note || ''
                    };
                    positionMigrated = true;
                }
                
                if (positionMigrated) {
                    migratedCount++;
                    console.log(`  ‚úÖ Posizione ${index + 1} (${pos.name}): rilievi aggiunti`);
                }
            });
            
            if (migratedCount > 0) {
                console.log(`‚úÖ Migrazione completata: ${migratedCount} posizioni aggiornate`);
                // Aggiorna metadata versione
                if (!project.metadata) project.metadata = {};
                project.metadata.migratedToV45 = true;
                project.metadata.migrationDate = new Date().toISOString();
            } else {
                console.log(`‚úì Nessuna migrazione necessaria`);
            }
            
            return project;
        }

        // ============================================================================
        // MIGRAZIONE RILIEVI: Aggiunge rilievi mancanti alle posizioni
        // ============================================================================
        function migrateProjectRilievi(project) {
            if (!project || !project.positions) return project;
            
            console.log(`üîÑ Migrazione rilievi per progetto: ${project.name || project.id}`);
            
            let migratedCount = 0;
            
            project.positions.forEach((pos, index) => {
                let positionMigrated = false;
                
                // PERSIANE
                if (!pos.rilievoPersiane && project.rilievoPersiane) {
                    pos.rilievoPersiane = {
                        togliere: project.rilievoPersiane.togliere || false,
                        smaltimento: project.rilievoPersiane.smaltimento || false,
                        materiale: project.rilievoPersiane.materiale || '',
                        note: project.rilievoPersiane.note || ''
                    };
                    positionMigrated = true;
                }
                
                // TAPPARELLE
                if (!pos.rilievoTapparelle && project.rilievoTapparelle) {
                    pos.rilievoTapparelle = {
                        togliere: project.rilievoTapparelle.togliere || false,
                        smaltimento: project.rilievoTapparelle.smaltimento || false,
                        materiale: project.rilievoTapparelle.materiale || '',
                        note: project.rilievoTapparelle.note || ''
                    };
                    positionMigrated = true;
                }
                
                // ZANZARIERE
                if (!pos.rilievoZanzariere && project.rilievoZanzariere) {
                    pos.rilievoZanzariere = {
                        togliere: project.rilievoZanzariere.togliere || false,
                        smaltimento: project.rilievoZanzariere.smaltimento || false,
                        materiale: project.rilievoZanzariere.materiale || '',
                        note: project.rilievoZanzariere.note || ''
                    };
                    positionMigrated = true;
                }
                
                // CASSONETTI
                if (!pos.rilievoCassonetti && project.rilievoCassonetti) {
                    pos.rilievoCassonetti = {
                        togliere: project.rilievoCassonetti.togliere || false,
                        smaltimento: project.rilievoCassonetti.smaltimento || false,
                        materiale: project.rilievoCassonetti.materiale || '',
                        note: project.rilievoCassonetti.note || ''
                    };
                    positionMigrated = true;
                }
                
                if (positionMigrated) {
                    migratedCount++;
                    console.log(`  ‚úÖ Posizione ${index + 1} (${pos.name}): rilievi aggiunti`);
                }
            });
            
            if (migratedCount > 0) {
                console.log(`‚úÖ Migrazione completata: ${migratedCount} posizioni aggiornate`);
                if (!project.metadata) project.metadata = {};
                project.metadata.migratedToV45 = true;
                project.metadata.migrationDate = new Date().toISOString();
            } else {
                console.log(`‚úì Nessuna migrazione necessaria`);
            }
            
            return project;
        }

        function migrateOldData() {
            if (!state.projects) return;
            
            state.projects.forEach(project => {
                // üîß FIX CRITICO: Migra rilievi globali da ARRAY a OGGETTO se necessario
                ['rilievoInfissi', 'rilievoPersiane', 'rilievoTapparelle', 'rilievoZanzariere', 'rilievoCassonetti'].forEach(rilievoKey => {
                    if (Array.isArray(project[rilievoKey])) {
                        console.warn(`‚ö†Ô∏è MIGRAZIONE: ${rilievoKey} era ARRAY, convertito in OGGETTO`);
                        // Se √® un array vuoto o con elementi, convertilo in oggetto vuoto
                        project[rilievoKey] = {
                            materiale: '',
                            note: '',
                            togliere: false,
                            smaltimento: false
                        };
                        
                        // Aggiungi coprifili solo per infissi
                        if (rilievoKey === 'rilievoInfissi') {
                            project[rilievoKey].coprifiliInt = false;
                            project[rilievoKey].coprifiliEst = false;
                        }
                    }
                });
                
                if (!project.positions) return;
                
                project.positions.forEach(pos => {
                    // Migra infissi
                    if (pos.infissi && Array.isArray(pos.infissi) && pos.infissi.length > 0) {
                        pos.infisso = pos.infissi[0]; // Prendi il primo
                        delete pos.infissi;
                    }
                    
                    // Migra persiane
                    if (pos.persiane && Array.isArray(pos.persiane) && pos.persiane.length > 0) {
                        pos.persiana = pos.persiane[0];
                        delete pos.persiane;
                    }
                    
                    // Migra tapparelle
                    if (pos.tapparelle && Array.isArray(pos.tapparelle) && pos.tapparelle.length > 0) {
                        pos.tapparella = pos.tapparelle[0];
                        delete pos.tapparelle;
                    }
                    
                    // Migra zanzariere
                    if (pos.zanzariere && Array.isArray(pos.zanzariere) && pos.zanzariere.length > 0) {
                        pos.zanzariera = pos.zanzariere[0];
                        delete pos.zanzariere;
                    }
                    
                    // Migra cassonetti
                    if (pos.cassonetti && Array.isArray(pos.cassonetti) && pos.cassonetti.length > 0) {
                        pos.cassonetto = pos.cassonetti[0];
                        delete pos.cassonetti;
                    }
                });
            });
            
            // üîç DEBUG: Verifica stato prima di salvare
            if (state.currentProject) {
                const project = state.projects.find(p => p.id === state.currentProject);
                if (project) {
                    console.log('üîç DENTRO migrateOldData PRIMA di saveState:');
                    console.log('   rilievoPersiane:', project.rilievoPersiane);
                    console.log('   Tipo:', Array.isArray(project.rilievoPersiane) ? 'ARRAY' : 'OGGETTO');
                }
            }
            
            saveState(); // Salva i dati migrati
        }

        function saveState() {
            // üì¶ FASE 027K: Aggiorna metadata modifiche
            if (!state.metadata) {
                state.metadata = {};
            }
            state.metadata.lastModified = Date.now();
            state.metadata.appVersion = '4.20';
            
            // üì¶ FASE 027K: Assicurati che github structure esista
            if (!state.github) {
                state.github = {
                    connected: false,
                    token: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
            }
            
            // üîç DEBUG: Log rilievo globale prima di salvare
            if (state.currentProject) {
                const project = state.projects.find(p => p.id === state.currentProject);
                if (project) {
                    console.log('üíæ SALVANDO IN LOCALSTORAGE:');
                    console.log('   rilievoInfissi:', project.rilievoInfissi);
                    console.log('   rilievoPersiane:', project.rilievoPersiane);
                    console.log('   rilievoTapparelle:', project.rilievoTapparelle);
                }
            }
            
            try {
                localStorage.setItem('openPorteData', JSON.stringify(state));
                console.log('‚úÖ localStorage AGGIORNATO');
            } catch (error) {
                console.error('‚ùå Errore salvataggio localStorage:', error);
                showNotification('‚ö†Ô∏è Errore salvataggio locale: ' + error.message, 'error', 5000);
                return; // Esci se non riesce a salvare localmente
            }
            
            // üì¶ FASE 027K: Auto-backup su GitHub (debounced)
            // Solo se connesso, auto-backup abilitato e non gi√† in sync
            if (state.github && state.github.connected && 
                state.github.autoBackupEnabled && 
                state.github.syncStatus !== 'syncing') {
                
                try {
                    // Debounce: aspetta 2 secondi di inattivit√† prima di sync
                    clearTimeout(window.githubSyncDebounce);
                    window.githubSyncDebounce = setTimeout(() => {
                        uploadToGitHub().catch(err => {
                            console.error('‚ùå Errore auto-sync GitHub:', err);
                        });
                    }, 2000);
                } catch (error) {
                    console.error('‚ùå Errore setup auto-sync:', error);
                }
            }
        }

        // ============================================================================
        // üÜï GENERA ID PROGETTO - Formato: ANNO_MESE_XXXX (es: 2025_11_0001)
        // ============================================================================
        
        /**
         * Valida Step 1 - Nome Cliente obbligatorio
         */
        function validateStep1(project) {
            if (!project.client || project.client.trim() === '') {
                alert('‚ö†Ô∏è ATTENZIONE\n\nIl campo "Cliente" √® obbligatorio.\n\nCompila il nome del cliente prima di procedere.');
                return false;
            }
            return true;
        }
        
        /**
         * Cambia step con validazione
         */
        function changeSetupStep(newStep) {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return;
            
            // Se sto passando da Step 1 a qualsiasi altro step, valida
            if (state.setupStep === 1 && newStep > 1) {
                if (!validateStep1(project)) {
                    return; // Blocca cambio step
                }
            }
            
            // Cambio step OK
            state.setupStep = newStep;
            render();
        }
        
        function generateProjectId() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // 01-12
            
            // Chiave localStorage per contatore mensile
            const counterKey = `project_counter_${year}_${month}`;
            
            // Leggi contatore attuale (default 0)
            let counter = parseInt(localStorage.getItem(counterKey) || '0');
            
            // Incrementa contatore
            counter++;
            
            // Salva nuovo contatore
            localStorage.setItem(counterKey, counter.toString());
            
            // Genera ID: 2025_11_0001
            const projectId = `${year}_${month}_${String(counter).padStart(4, '0')}`;
            
            console.log(`‚úÖ Generated Project ID: ${projectId}`);
            return projectId;
        }
        
        // ============================================================================
        // GENERA ID GENERICO (per elementi interni come prodotti)
        // ============================================================================
        // üÜï v4.20: Genera ID progetto sequenziale formato ANNOP001
        // Esempi: 2025P001, 2025P002, 2025P003, ..., 2025P999
        function generateId() {
            const currentYear = new Date().getFullYear();
            
            // Trova tutti i progetti dell'anno corrente
            const existingIds = (state.projects || [])
                .map(p => p.id)
                .filter(id => id && id.startsWith(currentYear + 'P'));
            
            // Estrai i numeri esistenti
            const existingNumbers = existingIds
                .map(id => {
                    const match = id.match(/^(\d{4})P(\d{3})$/);
                    return match ? parseInt(match[2]) : 0;
                })
                .filter(n => n > 0);
            
            // Trova il prossimo numero disponibile
            const nextNumber = existingNumbers.length > 0 
                ? Math.max(...existingNumbers) + 1 
                : 1;
            
            // Formatta con padding (001, 002, 003, etc.)
            const paddedNumber = String(nextNumber).padStart(3, '0');
            
            // Ritorna formato: 2025P001
            return `${currentYear}P${paddedNumber}`;
        }
        
        // üÜï v4.20: Formatta ID progetto per visualizzazione
        // Il formato ANNOP001 si mostra direttamente con il prefisso #
        // Esempio: "2025P001" ‚Üí "#2025P001"
        function formatProjectId(id) {
            if (!id) return '#UNKNOWN';
            // Se gi√† in formato ANNOP001, mostra direttamente
            if (/^\d{4}P\d{3}$/.test(id)) {
                return '#' + id;
            }
            // Fallback per vecchi ID casuali (primi 6 caratteri)
            return '#' + id.substring(0, 6).toUpperCase();
        }
        
        // üÜï Genera ID sequenziale per posizione: 2025_11_0001_01, 2025_11_0001_02, ecc
        function generateSequentialPositionId(projectId, positions) {
            const existingNumbers = positions
                .map(p => {
                    // Match formato: 2025_11_0001_01, 2025_11_0001_02, ecc.
                    const match = p.id.match(new RegExp(`^${projectId.replace(/_/g, '\\_')}_(\\d+)$`));
                    return match ? parseInt(match[1]) : 0;
                })
                .filter(n => n > 0);
            
            const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
            return `${projectId}_${String(nextNumber).padStart(2, '0')}`;
        }
        
        /**
         * Genera un ID leggibile per una posizione basato su ambiente
         * Es: "cucina-1", "soggiorno-2", ecc.
         */
        function generatePositionId(ambiente, projectPositions) {
            // Normalizza ambiente per usarlo come ID
            let baseId = (ambiente || 'posizione')
                .toLowerCase()
                .replace(/[^a-z0-9]/g, '-')  // Sostituisci caratteri speciali con -
                .replace(/-+/g, '-')         // Rimuovi - multipli
                .replace(/^-|-$/g, '');      // Rimuovi - iniziali/finali
            
            // Se vuoto, usa "posizione"
            if (!baseId) baseId = 'posizione';
            
            // Conta quante posizioni con questo base ID esistono gi√†
            const existingWithSameBase = projectPositions.filter(p => 
                p.id.startsWith(baseId + '-') || p.id === baseId
            ).length;
            
            // Aggiungi numero progressivo
            const counter = existingWithSameBase + 1;
            
            return `${baseId}-${counter}`;
        }

        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚ö° FASE 024C: SISTEMA UNIVERSALE TOGGLE SELECT/INPUT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        /**
         * Toggle universale tra select e input per qualsiasi campo
         * @param {string} fieldId - ID base del campo (es. 'azienda', 'coloreInt')
         * @param {string} context - Contesto univoco (es. 'infisso-proj123', 'pos456')
         */
        window.toggleFieldMode = (fieldId, context) => {
            const selectEl = document.getElementById(`${fieldId}-select-${context}`);
            const inputEl = document.getElementById(`${fieldId}-input-${context}`);
            const btnEl = document.getElementById(`${fieldId}-toggle-${context}`);
            
            if (!selectEl || !inputEl) return;
            
            if (selectEl.style.display === 'none') {
                // Torna a SELECT
                selectEl.style.display = 'block';
                inputEl.style.display = 'none';
                if (btnEl) btnEl.innerHTML = '‚úèÔ∏è Scrivi manualmente';
                
                // Trasferisci valore da input a select se presente
                if (inputEl.value && inputEl.value.trim() !== '') {
                    // Se il valore non √® nelle opzioni, aggiungilo temporaneamente
                    const existingOption = Array.from(selectEl.options).find(opt => opt.value === inputEl.value);
                    if (!existingOption) {
                        const newOption = document.createElement('option');
                        newOption.value = inputEl.value;
                        newOption.text = inputEl.value;
                        newOption.selected = true;
                        selectEl.appendChild(newOption);
                    } else {
                        selectEl.value = inputEl.value;
                    }
                }
            } else {
                // Passa a INPUT
                selectEl.style.display = 'none';
                inputEl.style.display = 'block';
                if (btnEl) btnEl.innerHTML = 'üìã Torna a selezione';
                
                // Trasferisci valore da select a input
                if (selectEl.value && selectEl.value !== '') {
                    inputEl.value = selectEl.value;
                }
                inputEl.focus();
            }
        };
        
        /**
         * Genera HTML per campo con toggle select/input
         * @param {Object} config - Configurazione campo
         * @returns {string} HTML completo del campo
         */
        function renderFieldWithToggle(config) {
            const {
                fieldId,           // 'azienda', 'coloreInt', ecc.
                context,           // 'infisso-proj123' o 'pos456'
                label,             // 'Azienda'
                currentValue,      // Valore corrente
                options,           // Array opzioni ['Oknoplast', 'Finstral', ...]
                updateFunction,    // Nome funzione da chiamare (es. 'updateConfigInfissi')
                updateParams,      // Parametri per la funzione update
                required = false   // Se il campo √® obbligatorio
            } = config;
            
            // üÜï v4.22: Feedback visivo - arancione se vuoto, bianco se compilato
            const isEmpty = !currentValue || currentValue === '';
            const borderClass = isEmpty ? 'border-orange-400 bg-orange-50' : 'border-gray-300 bg-white';
            const statusIcon = required ? (isEmpty ? '<span class="text-orange-600">‚óè</span>' : '<span class="text-green-600">‚úì</span>') : '';
            
            // Costruisci parametri per update function
            const updateCall = `${updateFunction}(${updateParams.map(p => `'${p}'`).join(', ')}, this.value)`;
            
            return `
                <div class="mb-3">
                    <div class="flex items-center justify-between mb-1">
                        <label class="text-sm font-semibold flex items-center gap-2">
                            ${label}
                            ${statusIcon}
                        </label>
                        <button onclick="toggleFieldMode('${fieldId}', '${context}')" 
                                id="${fieldId}-toggle-${context}"
                                class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full font-medium transition">
                            ‚úèÔ∏è Scrivi manualmente
                        </button>
                    </div>
                    
                    <!-- SELECT MODE (default) -->
                    <select id="${fieldId}-select-${context}"
                            onchange="${updateCall}"
                            class="w-full px-3 py-2 border-2 ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            style="display: block;">
                        <option value="">Seleziona...</option>
                        ${options.map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                    
                    <!-- INPUT MODE (hidden) -->
                    <input type="text" 
                           id="${fieldId}-input-${context}"
                           value="${currentValue || ''}"
                           oninput="${updateCall}"
                           placeholder="Scrivi ${label.toLowerCase()}..."
                           class="w-full px-3 py-2 border-2 ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           style="display: none;">
                </div>
            `;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üéØ SELECT CON CUSTOM INPUT - FASE 020
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Handler globale per gestire il cambio tra select e custom input
        window.handleSelectCustomChange = (fieldName, selectElement, projectId, posId, productType) => {
            const value = selectElement.value;
            console.log('üü† handleSelectCustomChange CHIAMATA:', {fieldName, value, projectId, posId, productType});
            const customInputId = `${fieldName}_custom_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
            const customInput = document.getElementById(customInputId);
            
            // üÜï v4.22: Feedback visivo immediato - cambia colore bordo
            if (value === '' || value === '__custom__') {
                // Vuoto o custom ‚Üí arancione
                selectElement.classList.remove('border-gray-300', 'bg-white');
                selectElement.classList.add('border-orange-400', 'bg-orange-50');
            } else {
                // Compilato ‚Üí bianco
                selectElement.classList.remove('border-orange-400', 'bg-orange-50');
                selectElement.classList.add('border-gray-300', 'bg-white');
            }
            
            if (value === '__custom__') {
                // Mostra input custom
                if (customInput) {
                    customInput.style.display = 'block';
                    customInput.focus();
                }
            } else if (value !== '') {
                // Nascondi input custom
                if (customInput) {
                    customInput.style.display = 'none';
                    customInput.value = '';
                }
                
                // Determina se √® rilievo globale (productType plurale)
                const isRilievoGlobale = (productType === 'infissi' || productType === 'persiane' || 
                                         productType === 'tapparelle' || productType === 'zanzariere' || 
                                         productType === 'cassonetti');
                
                // ‚ö° Per rilievo globale SALVA IMMEDIATAMENTE senza delay
                if (isRilievoGlobale) {
                    console.log('üü¢ Chiamando updateRilievoGlobale IMMEDIATAMENTE');
                    updateRilievoGlobale(projectId, productType, fieldName, value);
                } else {
                    // ‚ö° RITARDA il render per permettere al select di chiudersi naturalmente (solo per config/prodotti)
                    setTimeout(() => {
                        // Chiama il callback appropriato in base al contesto
                        if (posId && productType) {
                            // √à una posizione
                            updateProduct(projectId, posId, productType, fieldName, value);
                        } else {
                            // √à config globale
                            if (productType === 'infisso') {
                                updateConfigInfissi(projectId, fieldName, value);
                            } else if (productType === 'persiana') {
                                updateConfigPersiane(projectId, fieldName, value);
                            } else if (productType === 'tapparella') {
                                updateConfigTapparelle(projectId, fieldName, value);
                            } else if (productType === 'zanzariera') {
                                updateConfigZanzariere(projectId, fieldName, value);
                            } else if (productType === 'cassonetto') {
                                updateConfigCassonetti(projectId, fieldName, value);
                            }
                        }
                    }, 50); // 50ms di delay
                    
                    // üé® v4.40: Se campo finitura, aggiorna colori IMMEDIATAMENTE
                    if (fieldName === 'finituraInt' || fieldName === 'finituraEst') {
                        setTimeout(() => {
                            console.log(`üé® TRIGGER DIRETTO: Aggiorno colori per ${fieldName}`);
                            aggiornaColoriPerFinitura(fieldName, projectId, posId, productType);
                        }, 150); // 150ms per dare tempo al salvataggio
                    }
                }
            }
        };
        
        // Funzione per renderizzare select con opzione custom
        function renderSelectWithCustom(fieldName, currentValue, options, projectId, posId, productType, label) {
            // Determina se il valore corrente √® custom (non nella lista)
            const isCustom = currentValue && currentValue !== '' && !options.includes(currentValue);
            const selectedValue = isCustom ? '__custom__' : (currentValue || '');
            const isEmpty = !currentValue || currentValue === '';
            
            // ID univoco per l'input custom
            const customInputId = `${fieldName}_custom_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
            
            return `
                <div class="mb-2">
                    ${label ? `<label class="block text-base font-bold mb-1 text-gray-800">${label}</label>` : ''}
                    
                    <!-- Select principale -->
                    <select 
                        class="w-full px-3 py-2.5 border-2 rounded-lg text-base font-medium ${isEmpty ? 'border-orange-400 bg-orange-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                        onchange="handleSelectCustomChange('${fieldName}', this, '${projectId}', '${posId || ''}', '${productType}')"
                    >
                        <option value="" class="text-gray-400">‚ñº Seleziona...</option>
                        ${options.map(opt => `
                            <option value="${opt}" ${selectedValue === opt ? 'selected' : ''} class="text-gray-900 font-medium">
                                ${opt}
                            </option>
                        `).join('')}
                        <option value="__custom__" ${isCustom ? 'selected' : ''} class="text-blue-600 font-semibold">
                            üñäÔ∏è Scrivi manualmente
                        </option>
                    </select>
                    
                    <!-- Input custom (nascosto se non serve) -->
                    <input 
                        type="text" 
                        class="w-full px-3 py-2.5 border-2 border-blue-400 rounded-lg mt-2 text-base font-medium bg-blue-50 focus:ring-2 focus:ring-blue-500" 
                        id="${customInputId}"
                        placeholder="‚úèÔ∏è Scrivi valore personalizzato..."
                        value="${isCustom ? currentValue : ''}"
                        style="display: ${isCustom ? 'block' : 'none'};"
                        onchange="${posId ? `updateProduct('${projectId}', '${posId}', '${productType}', '${fieldName}', this.value)` : 
                                  productType === 'infisso' ? `updateConfigInfissi('${projectId}', '${fieldName}', this.value)` :
                                  productType === 'persiana' ? `updateConfigPersiane('${projectId}', '${fieldName}', this.value)` :
                                  productType === 'tapparella' ? `updateConfigTapparelle('${projectId}', '${fieldName}', this.value)` :
                                  productType === 'zanzariera' ? `updateConfigZanzariere('${projectId}', '${fieldName}', this.value)` :
                                  `updateConfigCassonetti('${projectId}', '${fieldName}', this.value)`}"
                    />
                </div>
            `;
        }

        // üé® FASE 30024: Funzione per select colori dinamici (PVC vs Alluminio)
        function renderSelectColore(fieldName, currentValue, finituraValue, projectId, posId, productType, label) {
            // Colori PVC (tutti)
            const coloriPVC = [
                '01 - Bianco',
                '42 - Bianco perla',
                '45 - Grigio seta',
                '06 - Grigio',
                '07 - Nero',
                '13 - Castagno decoro legno',
                '19 - Rovere decoro legno',
                '46 - Marrone chiaro',
                '55 - Noce chiaro decoro legno'
            ];
            
            // Colori Alluminio (SOLO effetti legno)
            const coloriAlluminioLegno = [
                'L13 - Castagno verniciato',
                'L14 - Mogano verniciato',
                'L16 - Douglas verniciato',
                'L18 - Noce verniciato',
                'L19 - Rovere verniciato',
                'L55 - Noce chiaro verniciato',
                'LX01 - Rovere naturale',
                'LX02 - Ciliegio scuro',
                'LX03 - Pino verniciato',
                'LX04 - Rovere venato'
            ];
            
            // Scelta opzioni in base a finitura
            let opzioni = [];
            if (finituraValue && finituraValue.toLowerCase().includes('pvc')) {
                opzioni = coloriPVC;
            } else if (finituraValue && finituraValue.toLowerCase().includes('alluminio')) {
                opzioni = coloriAlluminioLegno;
            } else {
                // Se finitura non impostata o altro materiale, usa PVC come default
                opzioni = coloriPVC;
            }
            
            // Usa renderSelectWithCustom con opzioni dinamiche
            return renderSelectWithCustom(fieldName, currentValue, opzioni, projectId, posId, productType, label);
        }

        // üé® FASE 30024b: Select COLORI STANDARD (NO custom input) - v4.29
        function renderSelectColoreStandard(fieldName, currentValue, finituraValue, projectId, posId, productType, label) {
            // ‚úÖ COLORI PVC CORRETTI (dal PDF Finstral pagina 1)
            const coloriPVC = [
                '01 - Bianco',              // extraliscio
                '45 - Bianco',              // satinata
                '27 - Bianco perla',        // satinata
                '42 - Bianco',              // goffrata (FIX: era "Bianco perla")
                '07 - Bianco perla',        // goffrata (FIX: era "Nero")
                '46 - Grigio seta',         // satinata
                '06 - Grigio',              // satinata
                '13 - Castagno decoro legno',   // goffrata
                '19 - Rovere decoro legno',     // goffrata
                '55 - Noce chiaro decoro legno' // goffrata
            ];
            
            // ‚úÖ COLORI ALLUMINIO - Solo decoro legno (dal PDF pagina 2, gruppo 1H)
            const coloriAlluminioLegno = [
                'L13 - Castagno verniciato',
                'L14 - Mogano verniciato',
                'L16 - Douglas verniciato',
                'L18 - Noce verniciato',
                'L19 - Rovere verniciato',
                'L55 - Noce chiaro verniciato',
                'LX01 - Rovere naturale',
                'LX02 - Ciliegio scuro',
                'LX03 - Pino verniciato',
                'LX04 - Rovere venato'
            ];
            
            // Scelta opzioni in base a finitura - FIX v4.37: Logica pi√π robusta
            let opzioni = [];
            
            // Normalizza il valore di finitura (trim + lowercase)
            const finituraNormalized = (finituraValue || '').toString().trim().toLowerCase();
            
            console.log(`üé® DEBUG renderSelectColoreStandard: fieldName=${fieldName}, finitura="${finituraValue}" ‚Üí normalized="${finituraNormalized}"`);
            
            // Priorit√†: Se contiene "alluminio" ‚Üí usa colori alluminio
            if (finituraNormalized.includes('alluminio') || finituraNormalized.includes('aluminio')) {
                opzioni = coloriAlluminioLegno;
                console.log(`   ‚úÖ Finitura contiene "alluminio" ‚Üí ${coloriAlluminioLegno.length} colori alluminio`);
            } 
            // Altrimenti: usa colori PVC (default sicuro)
            else {
                opzioni = coloriPVC;
                console.log(`   ‚úÖ Finitura PVC o vuota ‚Üí ${coloriPVC.length} colori PVC`);
            }
            
            // Determina se il valore corrente √® custom (non nella lista)
            const isCustom = currentValue && currentValue !== '' && !opzioni.includes(currentValue);
            const selectedValue = isCustom ? '__custom__' : (currentValue || '');
            const isEmpty = !currentValue || currentValue === '';
            
            // ID univoco per l'input custom
            const customInputId = `${fieldName}_custom_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
            
            // ID univoco per il select (per update dinamico)
            const selectId = `${fieldName}_select_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
            
            return `
                <div class="mb-2">
                    ${label ? `<label class="block text-base font-bold mb-1 text-gray-800">${label}</label>` : ''}
                    
                    <!-- Select con colori validi + opzione custom -->
                    <select 
                        id="${selectId}"
                        class="w-full px-3 py-2.5 border-2 rounded-lg text-base font-medium ${isEmpty ? 'border-orange-400 bg-orange-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                        onchange="handleSelectCustomChange('${fieldName}', this, '${projectId}', '${posId || ''}', '${productType}')"
                    >
                        <option value="" class="text-gray-400">‚ñº Seleziona...</option>
                        ${opzioni.map(opt => `
                            <option value="${opt}" ${selectedValue === opt ? 'selected' : ''} class="text-gray-900 font-medium">
                                ${opt}
                            </option>
                        `).join('')}
                        <option value="__custom__" ${isCustom ? 'selected' : ''} class="text-blue-600 font-semibold">
                            üñäÔ∏è Scrivi manualmente
                        </option>
                    </select>
                    
                    <!-- Input custom (nascosto se non serve) -->
                    <input 
                        type="text" 
                        class="w-full px-3 py-2.5 border-2 border-blue-400 rounded-lg mt-2 text-base font-medium bg-blue-50 focus:ring-2 focus:ring-blue-500" 
                        id="${customInputId}"
                        placeholder="‚úèÔ∏è Scrivi colore personalizzato..."
                        value="${isCustom ? currentValue : ''}"
                        style="display: ${isCustom ? 'block' : 'none'};"
                        onchange="${posId ? `updateProduct('${projectId}', '${posId}', '${productType}', '${fieldName}', this.value)` : 
                                  productType === 'infisso' ? `updateConfigInfissi('${projectId}', '${fieldName}', this.value)` :
                                  productType === 'persiana' ? `updateConfigPersiane('${projectId}', '${fieldName}', this.value)` :
                                  productType === 'tapparella' ? `updateConfigTapparelle('${projectId}', '${fieldName}', this.value)` :
                                  productType === 'zanzariera' ? `updateConfigZanzariere('${projectId}', '${fieldName}', this.value)` :
                                  `updateConfigCassonetti('${projectId}', '${fieldName}', this.value)`}"
                    />
                </div>
            `;
        }
        
        // üîÑ FUNZIONE DINAMICA: Aggiorna dropdown colori quando cambia finitura - v4.39 (base v4.33)
        window.aggiornaColoriPerFinitura = (finituraField, projectId, posId, productType) => {
            console.log(`üé® Aggiorno colori per finitura: ${finituraField}`);
            
            // Trova valore finitura attuale
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            let finituraValue = '';
            let coloreField = '';
            
            // Determina quale finitura √® cambiata e quale colore aggiornare
            if (finituraField === 'finituraInt') {
                finituraValue = posId ? 
                    project.positions.find(p => p.id === posId)?.infisso?.finituraInt :
                    project.configInfissi?.finituraInt || 'pvc';
                coloreField = 'coloreInt';
            } else if (finituraField === 'finituraEst') {
                finituraValue = posId ? 
                    project.positions.find(p => p.id === posId)?.infisso?.finituraEst :
                    project.configInfissi?.finituraEst || 'pvc';
                coloreField = 'coloreEst';
            }
            
            console.log(`   Finitura: ${finituraValue}, Campo colore: ${coloreField}`);
            
            // Array colori
            const coloriPVC = [
                '01 - Bianco', '45 - Bianco', '27 - Bianco perla', '42 - Bianco', 
                '07 - Bianco perla', '46 - Grigio seta', '06 - Grigio',
                '13 - Castagno decoro legno', '19 - Rovere decoro legno', '55 - Noce chiaro decoro legno'
            ];
            
            const coloriAlluminio = [
                'L13 - Castagno verniciato', 'L14 - Mogano verniciato', 'L16 - Douglas verniciato',
                'L18 - Noce verniciato', 'L19 - Rovere verniciato', 'L55 - Noce chiaro verniciato',
                'LX01 - Rovere naturale', 'LX02 - Ciliegio scuro', 'LX03 - Pino verniciato', 'LX04 - Rovere venato'
            ];
            
            // Scelta opzioni - FIX v4.39: Logica uniformata a renderSelectColoreStandard
            // Normalizza valore finitura
            const finituraNormalized = (finituraValue || '').toString().trim().toLowerCase();
            
            let opzioni = [];
            // Priorit√†: Se contiene "alluminio" ‚Üí usa colori alluminio
            if (finituraNormalized.includes('alluminio') || finituraNormalized.includes('aluminio')) {
                opzioni = coloriAlluminio;
                console.log(`   ‚úÖ Finitura contiene "alluminio" ‚Üí ${coloriAlluminio.length} colori alluminio`);
            } 
            // Altrimenti: usa colori PVC (default sicuro)
            else {
                opzioni = coloriPVC;
                console.log(`   ‚úÖ Finitura PVC o vuota ‚Üí ${coloriPVC.length} colori PVC`);
            }
            
            // Trova select colore da aggiornare
            const selectId = `${coloreField}_select_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
            const selectElement = document.getElementById(selectId);
            
            if (!selectElement) {
                console.warn(`‚ö†Ô∏è Select non trovato: ${selectId}`);
                return;
            }
            
            // Salva valore corrente (se compatibile con nuove opzioni)
            const currentValue = selectElement.value;
            const keepValue = opzioni.includes(currentValue);
            
            // Rigenera opzioni
            selectElement.innerHTML = `
                <option value="" class="text-gray-400">‚ñº Seleziona...</option>
                ${opzioni.map(opt => `
                    <option value="${opt}" ${keepValue && currentValue === opt ? 'selected' : ''} class="text-gray-900 font-medium">
                        ${opt}
                    </option>
                `).join('')}
                <option value="__custom__" class="text-blue-600 font-semibold">üñäÔ∏è Scrivi manualmente</option>
            `;
            
            // Se valore non compatibile, resetta
            if (!keepValue && currentValue) {
                console.log(`   ‚ö†Ô∏è Colore "${currentValue}" non valido per ${finituraValue}, resettato`);
                selectElement.value = '';
                // Salva anche il reset
                if (posId) {
                    updateProduct(projectId, posId, productType, coloreField, '');
                } else {
                    if (productType === 'infisso') updateConfigInfissi(projectId, coloreField, '');
                }
            }
            
            console.log(`   ‚úÖ Colori aggiornati: ${opzioni.length} opzioni (${finituraValue})`);
        };
        
        // üîÑ EVENT LISTENER GLOBALE: Intercetta cambiamenti finitura e aggiorna colori - v4.39 (base v4.33)
        document.addEventListener('change', (event) => {
            const target = event.target;
            
            // Intercetta SOLO select (non input custom)
            if (target.tagName !== 'SELECT') return;
            
            // Ottieni onChange value per identificare campo
            const onchangeAttr = target.getAttribute('onchange');
            if (!onchangeAttr) return;
            
            // Verifica se √® un campo finitura (finituraInt o finituraEst)
            if (!onchangeAttr.includes('finituraInt') && !onchangeAttr.includes('finituraEst')) return;
            
            console.log('üîÑ Rilevato cambio finitura, aggiorno colori...');
            
            // Estrai parametri dall'attributo onchange
            // Formato: updateConfigInfissi('proj-xxx', 'finituraInt', this.value) o updateProduct(...)
            const isConfig = onchangeAttr.includes('updateConfigInfissi');
            const isPosition = onchangeAttr.includes('updateProduct');
            
            // Estrai projectId
            const projectIdMatch = onchangeAttr.match(/'([^']+)'/);
            const projectId = projectIdMatch ? projectIdMatch[1] : null;
            
            // Estrai field name
            const fieldMatch = isConfig ? 
                onchangeAttr.match(/updateConfigInfissi\('[^']*',\s*'([^']*)'/) :
                onchangeAttr.match(/updateProduct\('[^']*',\s*'[^']*',\s*'[^']*',\s*'([^']*)'/);
            const fieldName = fieldMatch ? fieldMatch[1] : null;
            
            // Estrai posId (solo per posizioni)
            const posIdMatch = isPosition ? onchangeAttr.match(/updateProduct\('[^']*',\s*'([^']*)'/): null;
            const posId = posIdMatch ? posIdMatch[1] : null;
            
            // Estrai productType
            const productTypeMatch = onchangeAttr.match(/'(infisso|persiana|tapparella|zanzariera|cassonetto)'/);
            const productType = productTypeMatch ? productTypeMatch[1] : 'infisso';
            
            if (projectId && fieldName) {
                // Attendi 100ms per permettere al valore di aggiornarsi
                setTimeout(() => {
                    aggiornaColoriPerFinitura(fieldName, projectId, posId, productType);
                }, 100);
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üéØ SOLUZIONE C: SISTEMA ANTI-DUPLICATI ENTERPRISE (Chat 010)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 1: DEVICE IDENTIFICATION
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        function getDeviceId() {
            // Ottiene o crea ID univoco dispositivo
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + generateId();
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        function getDeviceName() {
            // Ottiene o rileva nome dispositivo
            let deviceName = localStorage.getItem('deviceName');
            if (!deviceName) {
                deviceName = detectDeviceName();
                // Permetti modifica nome
                const customName = localStorage.getItem('customDeviceName');
                if (customName) deviceName = customName;
                localStorage.setItem('deviceName', deviceName);
            }
            return deviceName;
        }

        function detectDeviceName() {
            // Rileva tipo dispositivo automaticamente
            const ua = navigator.userAgent;
            
            if (/iPad/i.test(ua)) return 'Tablet iPad';
            if (/iPhone/i.test(ua)) return 'Smartphone iPhone';
            if (/Android/i.test(ua)) {
                if (/Mobile/i.test(ua)) return 'Smartphone Android';
                return 'Tablet Android';
            }
            if (/Windows/i.test(ua)) return 'PC Windows';
            if (/Mac/i.test(ua)) return 'PC Mac';
            if (/Linux/i.test(ua)) return 'PC Linux';
            
            return 'Dispositivo Sconosciuto';
        }

        function setCustomDeviceName(name) {
            // Permette utente di personalizzare nome dispositivo
            localStorage.setItem('customDeviceName', name);
            localStorage.setItem('deviceName', name);
            showNotification(`‚úÖ Nome dispositivo impostato: ${name}`, 'success');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üé® COLORI TAPPARELLE PLASTICINO - v4.89
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const COLORI_TAPPARELLE_PLASTICINO = {
            // ALLUMINIO COIBENTATO - Tinta Unita
            'ALLUMINIO_UNITA': [
                'Bianco 01', 'Bianco 9010', 'Avorio 34', 'Crema 39', 
                'Grigio 07', 'Argento 05', 'Grigio 10', 'Grigio 23',
                'Salmone 06', 'Ocra 03', 'Marrone 08', 'Marrone 04', 
                'Marrone 48', 'Marrone 79', 'Verde 43', 'Verde 09',
                'Verde 83', 'Verde 29', 'Rosso 02', 'Blu 35', 'Noce 61'
            ],
            // ALLUMINIO COIBENTATO - Tinta Legno
            'ALLUMINIO_LEGNO': [
                'Pino 52', 'Rovere 56', 'Teak 44', 'Ciliegio 33', 
                'Ciliegio 60', 'Noce 47'
            ],
            // ALLUMINIO COIBENTATO - Tinta Raffaello
            'ALLUMINIO_RAFFAELLO': [
                'Grigio Raffaello R94', 'Verde Raffaello R99', 
                'Marrone Raffaello R91', 'Rosso Raffaello R66'
            ],
            // PVC
            'PVC': [
                'Bianco 01', 'Avorio 34', 'Beige 17', 'Beige 502',
                'Grigio 07', 'Grigio 10', 'Marrone 81*', 'Marrone 0197*',
                'Verde 06', 'Noce 37*', 'Nero 88*', 'Blu 15*', 'Blu 95*',
                'Bruno 68', 'Bronzo', 'Ocra 84'
            ]
        };
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üõ§Ô∏è GUIDE PLASTICINO - v4.89
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const GUIDE_PLASTICINO = [
            // Alluminio Estruso 30x25x30
            'TG15 - Guide 30x25x30 Finestra',
            'TG10 - Guide 30x25x30 Portafinestra',
            'TG30 - Guide 30x25x30 Barra 6800mm',
            // Alluminio Estruso 28x17x28 Ribassato
            'TG25RIB - Guide 28x17x28 Ribassato Finestra',
            'TG20RIB - Guide 28x17x28 Ribassato Portafinestra',
            'TG35RIB - Guide 28x17x28 Ribassato Barra',
            // Alluminio Estruso 28x17x28 Standard
            'TG25 - Guide 28x17x28 Finestra',
            'TG20 - Guide 28x17x28 Portafinestra',
            'TG35 - Guide 28x17x28 Barra',
            // Ferro Zincato 21x20x21
            'PF2 - Guide 21x20x21 Ferro Zn Finestra',
            'PF4 - Guide 21x20x21 Ferro Zn Portafinestra',
            'PF1 - Guide 21x20x21 Ferro Zn Barra'
        ];
        
        const COLORI_GUIDE_PLASTICINO = {
            // Anodizzati standard
            'ANODIZZATO': [
                'Argento', 'Bronzo', 'Elox', 'Bianco'
            ],
            // Verniciati RAL
            'VERNICIATO': [
                'Avorio RAL 1013', 'Verde RAL 6005', 
                'Marrone RAL 8014', 'Marrone RAL 8017', 'Marrone RAL 8019'
            ]
        };
        
        // Funzione per ottenere colori guide
        function getColoriGuide() {
            return [
                ...COLORI_GUIDE_PLASTICINO['ANODIZZATO'],
                ...COLORI_GUIDE_PLASTICINO['VERNICIATO'],
                'RAL a richiesta'
            ];
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üîß ACCESSORI TAPPARELLA MANUALE - v4.91
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        const ACCESSORI_TAPPARELLA = [
            { id: 'rullo', label: 'Rullo ottagonale', icon: 'üîÑ' },
            { id: 'supporti', label: 'Supporti + Cuscinetti', icon: 'üî©' },
            { id: 'calotta', label: 'Calotta regolabile', icon: 'üé©' },
            { id: 'puleggia', label: 'Puleggia', icon: '‚öôÔ∏è' },
            { id: 'avvolgitore', label: 'Avvolgitore + Cassetta', icon: 'üì¶' },
            { id: 'cintino', label: 'Cintino', icon: 'üéóÔ∏è' },
            { id: 'passacinghia', label: 'Passacinghia', icon: 'üîó' },
            { id: 'ganci', label: 'Ganci a molla', icon: 'ü™ù' },
            { id: 'guide', label: 'Guide', icon: 'üõ§Ô∏è' },
            { id: 'motore', label: 'Motore', icon: '‚ö°' }
        ];
        
        // Funzione per renderizzare sezione sostituzione componenti
        function renderSostituzioneComponenti(projectId, posId, tap) {
            const sostTipo = tap.sostTipo || 'tutto';
            const accessori = tap.accessoriDaSostituire || {};
            
            // Se "tutto", tutti selezionati. Se "niente", tutti deselezionati.
            const isDisabled = sostTipo !== 'selettiva';
            const allChecked = sostTipo === 'tutto';
            const noneChecked = sostTipo === 'niente';
            
            return `
                <div class="mt-4 p-3 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-bold mb-3">üîß Sostituzione Componenti</label>
                    
                    <!-- Radio buttons -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        <label class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${sostTipo === 'tutto' ? 'bg-blue-100 border-2 border-blue-500' : 'bg-white border'}">
                            <input type="radio" name="sostTipo-${posId}" value="tutto"
                                   ${sostTipo === 'tutto' ? 'checked' : ''}
                                   onchange="updateSostTipo('${projectId}', '${posId}', 'tutto')"
                                   class="w-4 h-4">
                            <span class="text-sm font-medium">üîÑ Sost. TUTTO</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${sostTipo === 'niente' ? 'bg-gray-200 border-2 border-gray-500' : 'bg-white border'}">
                            <input type="radio" name="sostTipo-${posId}" value="niente"
                                   ${sostTipo === 'niente' ? 'checked' : ''}
                                   onchange="updateSostTipo('${projectId}', '${posId}', 'niente')"
                                   class="w-4 h-4">
                            <span class="text-sm font-medium">üìÑ Solo Telo</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${sostTipo === 'selettiva' ? 'bg-amber-100 border-2 border-amber-500' : 'bg-white border'}">
                            <input type="radio" name="sostTipo-${posId}" value="selettiva"
                                   ${sostTipo === 'selettiva' ? 'checked' : ''}
                                   onchange="updateSostTipo('${projectId}', '${posId}', 'selettiva')"
                                   class="w-4 h-4">
                            <span class="text-sm font-medium">‚úèÔ∏è Selettiva</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${sostTipo === 'soloAccessori' ? 'bg-purple-100 border-2 border-purple-500' : 'bg-white border'}">
                            <input type="radio" name="sostTipo-${posId}" value="soloAccessori"
                                   ${sostTipo === 'soloAccessori' ? 'checked' : ''}
                                   onchange="updateSostTipo('${projectId}', '${posId}', 'soloAccessori')"
                                   class="w-4 h-4">
                            <span class="text-sm font-medium">üîß Solo Accessori</span>
                        </label>
                    </div>
                    
                    <!-- Checkbox accessori (visibili solo se non "niente") -->
                    ${sostTipo !== 'niente' ? `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                            ${ACCESSORI_TAPPARELLA.map(acc => {
                                const isChecked = allChecked || accessori[acc.id];
                                const isGuide = acc.id === 'guide';
                                return `
                                    <label class="flex items-center gap-2 px-2 py-1.5 rounded ${isChecked ? 'bg-green-100' : 'bg-white'} border cursor-pointer ${isDisabled ? 'opacity-60' : ''}">
                                        <input type="checkbox" 
                                               ${isChecked ? 'checked' : ''} 
                                               ${isDisabled ? 'disabled' : ''}
                                               onchange="updateAccessorio('${projectId}', '${posId}', '${acc.id}', this.checked)"
                                               class="w-4 h-4">
                                        <span class="text-xs">${acc.icon} ${acc.label}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Campi Guide (visibili solo se guide selezionate) -->
                        ${(allChecked || accessori.guide) ? `
                            <div class="grid grid-cols-2 gap-2 p-2 bg-blue-50 rounded border border-blue-200">
                                <div>
                                    <label class="text-xs font-medium text-blue-700">üõ§Ô∏è Modello Guida</label>
                                    <input type="text" value="${tap.guida || ''}"
                                           placeholder="Seleziona guida"
                                           list="guida-tap-list-${posId}"
                                           onchange="updateProduct('${projectId}', '${posId}', 'tapparella', 'guida', this.value)"
                                           class="w-full compact-input border rounded mt-1">
                                    <datalist id="guida-tap-list-${posId}">
                                        ${GUIDE_PLASTICINO.map(g => `<option value="${g}">`).join('\\n')}
                                    </datalist>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-blue-700">üé® Colore Guida</label>
                                    <input type="text" value="${tap.coloreGuida || ''}"
                                           placeholder="Seleziona colore"
                                           list="colore-guida-list-${posId}"
                                           onchange="updateProduct('${projectId}', '${posId}', 'tapparella', 'coloreGuida', this.value)"
                                           class="w-full compact-input border rounded mt-1">
                                    <datalist id="colore-guida-list-${posId}">
                                        ${getColoriGuide().map(c => `<option value="${c}">`).join('\\n')}
                                    </datalist>
                                </div>
                            </div>
                        ` : ''}
                    ` : `
                        <p class="text-xs text-gray-500 italic">Solo il telo verr√† sostituito, nessun accessorio.</p>
                    `}
                </div>
            `;
        }
        
        // Funzioni di aggiornamento
        function updateSostTipo(projectId, posId, tipo) {
            updateProduct(projectId, posId, 'tapparella', 'sostTipo', tipo);
            
            // Gestione qta telo
            if (tipo === 'soloAccessori') {
                updateProduct(projectId, posId, 'tapparella', 'qta', 0); // No telo
            } else {
                updateProduct(projectId, posId, 'tapparella', 'qta', 1); // Con telo
            }
            
            // Se "tutto", imposta tutti gli accessori a true
            if (tipo === 'tutto') {
                const allAccessori = {};
                ACCESSORI_TAPPARELLA.forEach(a => allAccessori[a.id] = true);
                updateProduct(projectId, posId, 'tapparella', 'accessoriDaSostituire', allAccessori);
            }
            // Se "niente", imposta tutti a false
            else if (tipo === 'niente') {
                const noAccessori = {};
                ACCESSORI_TAPPARELLA.forEach(a => noAccessori[a.id] = false);
                updateProduct(projectId, posId, 'tapparella', 'accessoriDaSostituire', noAccessori);
            }
            // Se "soloAccessori", accessori selezionabili ma niente telo
            // (non resettiamo gli accessori, l'utente li sceglie)
            
            render();
        }
        
        function updateAccessorio(projectId, posId, accessorioId, checked) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            const pos = project.positions.find(p => p.id === posId);
            if (!pos || !pos.tapparella) return;
            
            const accessori = pos.tapparella.accessoriDaSostituire || {};
            accessori[accessorioId] = checked;
            updateProduct(projectId, posId, 'tapparella', 'accessoriDaSostituire', accessori);
            render();
        }
        
        // üî© Funzione per Accessori Persiana (Cardini + Fermapersiane)
        function renderAccessoriPersiana(projectId, posId, per) {
            const tipologia = per.tipo || 'F2';
            const aperturaLibro = (per.apertura || '').includes('LIB') || (per.apertura || '').includes('/A');
            
            // Calcola quantit√† suggerite
            const cardiniSuggeriti = calcolaCardiniPersiana(tipologia, aperturaLibro);
            const fermaperSuggeriti = calcolaFermapersiane(tipologia);
            
            // üÜï AUTO-INIZIALIZZA se non esiste
            if (!per.accessoriPersiana) {
                per.accessoriPersiana = {
                    cardini: { qta: cardiniSuggeriti, modello: 'C.SAF90' },
                    fermapersiane: { qta: fermaperSuggeriti, modello: 'K.EASY' }
                };
                // Salva subito nel JSON
                saveState();
                console.log(`üî© Auto-init accessoriPersiana per ${tipologia}: cardini=${cardiniSuggeriti}, ferma=${fermaperSuggeriti}`);
            }
            
            // Valori attuali
            const accessori = per.accessoriPersiana;
            const cardini = accessori.cardini || { qta: cardiniSuggeriti, modello: 'C.SAF90' };
            const ferma = accessori.fermapersiane || { qta: fermaperSuggeriti, modello: 'K.EASY' };
            
            return `
                <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4 mb-3">
                    <h5 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        üî© Accessori Persiana
                        <span class="text-xs font-normal text-gray-500">(ESCLUSI dal prezzo base)</span>
                    </h5>
                    
                    <!-- CARDINI -->
                    <div class="bg-white p-3 rounded-lg border mb-3">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-sm font-bold text-gray-700">üìç Cardini</span>
                            <span class="text-xs text-blue-600 bg-blue-100 px-2 py-0.5 rounded">
                                ${tipologia} ${aperturaLibro ? '(Libro)' : ''} ‚Üí suggeriti: ${cardiniSuggeriti}
                            </span>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="text-xs text-gray-600">Quantit√†</label>
                                <input type="number" min="0" max="20" value="${cardini.qta}"
                                       onchange="updateAccessoriPersiana('${projectId}', '${posId}', 'cardini', 'qta', parseInt(this.value))"
                                       class="w-full compact-input border rounded text-center">
                            </div>
                            <div class="col-span-2">
                                <label class="text-xs text-gray-600">Modello</label>
                                <select onchange="updateAccessoriPersiana('${projectId}', '${posId}', 'cardini', 'modello', this.value)"
                                        class="w-full compact-input border rounded">
                                    ${CARDINI_PUNTO_PERSIANE.map(c => 
                                        `<option value="${c.codice}" ${cardini.modello === c.codice ? 'selected' : ''}>
                                            ${c.codice} - ${c.nome} ${c.prezzo > 0 ? '‚Ç¨' + c.prezzo : ''}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- FERMAPERSIANE -->
                    <div class="bg-white p-3 rounded-lg border">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-sm font-bold text-gray-700">üîí Fermapersiane</span>
                            <span class="text-xs text-green-600 bg-green-100 px-2 py-0.5 rounded">
                                ${tipologia.replace('PF','').replace('F','')} ante ‚Üí suggeriti: ${fermaperSuggeriti}
                            </span>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="text-xs text-gray-600">Quantit√†</label>
                                <input type="number" min="0" max="10" value="${ferma.qta}"
                                       onchange="updateAccessoriPersiana('${projectId}', '${posId}', 'fermapersiane', 'qta', parseInt(this.value))"
                                       class="w-full compact-input border rounded text-center">
                            </div>
                            <div class="col-span-2">
                                <label class="text-xs text-gray-600">Modello</label>
                                <select onchange="updateAccessoriPersiana('${projectId}', '${posId}', 'fermapersiane', 'modello', this.value)"
                                        class="w-full compact-input border rounded">
                                    ${FERMAPERSIANE_PUNTO_PERSIANE.map(f => 
                                        `<option value="${f.codice}" ${ferma.modello === f.codice ? 'selected' : ''}>
                                            ${f.codice} - ${f.nome} ${f.prezzo > 0 ? '‚Ç¨' + f.prezzo : ''}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Funzione aggiornamento accessori persiana
        function updateAccessoriPersiana(projectId, posId, tipo, campo, valore) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            const pos = project.positions.find(p => p.id === posId);
            if (!pos || !pos.persiana) return;
            
            // Inizializza se non esiste
            if (!pos.persiana.accessoriPersiana) {
                pos.persiana.accessoriPersiana = {
                    cardini: { qta: 0, modello: 'C.SAF90' },
                    fermapersiane: { qta: 0, modello: 'K.EASY' }
                };
            }
            
            // Aggiorna il campo specifico
            if (!pos.persiana.accessoriPersiana[tipo]) {
                pos.persiana.accessoriPersiana[tipo] = {};
            }
            pos.persiana.accessoriPersiana[tipo][campo] = valore;
            
            saveState();
            render();
        }
        
        // üÜï Funzione per aggiornare tipo persiana e ricalcolare accessori
        function updateTipoPersiana(projectId, posId, nuovoTipo) {
            console.log(`üîß updateTipoPersiana CHIAMATA: projectId=${projectId}, posId=${posId}, nuovoTipo=${nuovoTipo}`);
            
            const project = state.projects.find(p => p.id === projectId);
            if (!project) {
                console.error('‚ùå Progetto non trovato:', projectId);
                return;
            }
            const pos = project.positions.find(p => p.id === posId);
            if (!pos) {
                console.error('‚ùå Posizione non trovata:', posId);
                return;
            }
            
            // üÜï v4.95 FIX: Inizializza persiana se non esiste
            if (!pos.persiana) {
                console.log('üÜï Inizializzo pos.persiana');
                pos.persiana = { qta: 1 };
            }
            
            // Aggiorna tipo
            pos.persiana.tipo = nuovoTipo;
            console.log(`‚úÖ pos.persiana.tipo SALVATO: ${pos.persiana.tipo}`);
            
            // Ricalcola accessori suggeriti
            const aperturaLibro = (pos.persiana.apertura || '').includes('LIB') || (pos.persiana.apertura || '').includes('/A');
            const cardiniSuggeriti = calcolaCardiniPersiana(nuovoTipo, aperturaLibro);
            const fermaperSuggeriti = calcolaFermapersiane(nuovoTipo);
            
            // Aggiorna quantit√† (mantiene modello)
            if (!pos.persiana.accessoriPersiana) {
                pos.persiana.accessoriPersiana = {
                    cardini: { qta: cardiniSuggeriti, modello: 'C.SAF90' },
                    fermapersiane: { qta: fermaperSuggeriti, modello: 'K.EASY' }
                };
            } else {
                pos.persiana.accessoriPersiana.cardini.qta = cardiniSuggeriti;
                pos.persiana.accessoriPersiana.fermapersiane.qta = fermaperSuggeriti;
            }
            
            console.log(`üîÑ Tipo ${nuovoTipo}: cardini=${cardiniSuggeriti}, ferma=${fermaperSuggeriti}`);
            saveState();
            
            // Verifica dopo saveState
            const verifica = state.projects.find(p => p.id === projectId)?.posizioni.find(p => p.id === posId);
            console.log(`üîç VERIFICA dopo save: pos.persiana.tipo = ${verifica?.persiana?.tipo}`);
            
            render();
        }
        
        // Funzione per Config Globale Sostituzione Componenti
        function renderSostituzioneComponentiConfig(projectId, configTapparelle) {
            const sostTipo = configTapparelle?.sostTipo || 'tutto';
            const accessori = configTapparelle?.accessoriDaSostituire || {};
            
            const isDisabled = sostTipo !== 'selettiva';
            const allChecked = sostTipo === 'tutto';
            
            return `
                <div class="col-span-2 mt-2 p-3 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-bold mb-3">üîß 4. Sostituzione Componenti Default</label>
                    
                    <!-- Radio buttons -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        <label class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${sostTipo === 'tutto' ? 'bg-blue-100 border-2 border-blue-500' : 'bg-white border'}">
                            <input type="radio" name="sostTipoConfig-${projectId}" value="tutto"
                                   ${sostTipo === 'tutto' ? 'checked' : ''}
                                   onchange="updateSostTipoConfig('${projectId}', 'tutto')"
                                   class="w-4 h-4">
                            <span class="text-sm font-medium">üîÑ Sost. TUTTO</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${sostTipo === 'niente' ? 'bg-gray-200 border-2 border-gray-500' : 'bg-white border'}">
                            <input type="radio" name="sostTipoConfig-${projectId}" value="niente"
                                   ${sostTipo === 'niente' ? 'checked' : ''}
                                   onchange="updateSostTipoConfig('${projectId}', 'niente')"
                                   class="w-4 h-4">
                            <span class="text-sm font-medium">üìÑ Solo Telo</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${sostTipo === 'selettiva' ? 'bg-amber-100 border-2 border-amber-500' : 'bg-white border'}">
                            <input type="radio" name="sostTipoConfig-${projectId}" value="selettiva"
                                   ${sostTipo === 'selettiva' ? 'checked' : ''}
                                   onchange="updateSostTipoConfig('${projectId}', 'selettiva')"
                                   class="w-4 h-4">
                            <span class="text-sm font-medium">‚úèÔ∏è Selettiva</span>
                        </label>
                        <label class="flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer ${sostTipo === 'soloAccessori' ? 'bg-purple-100 border-2 border-purple-500' : 'bg-white border'}">
                            <input type="radio" name="sostTipoConfig-${projectId}" value="soloAccessori"
                                   ${sostTipo === 'soloAccessori' ? 'checked' : ''}
                                   onchange="updateSostTipoConfig('${projectId}', 'soloAccessori')"
                                   class="w-4 h-4">
                            <span class="text-sm font-medium">üîß Solo Accessori</span>
                        </label>
                    </div>
                    
                    <!-- Checkbox accessori -->
                    ${sostTipo !== 'niente' ? `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                            ${ACCESSORI_TAPPARELLA.map(acc => {
                                const isChecked = allChecked || accessori[acc.id];
                                return `
                                    <label class="flex items-center gap-2 px-2 py-1.5 rounded ${isChecked ? 'bg-green-100' : 'bg-white'} border cursor-pointer ${isDisabled ? 'opacity-60' : ''}">
                                        <input type="checkbox" 
                                               ${isChecked ? 'checked' : ''} 
                                               ${isDisabled ? 'disabled' : ''}
                                               onchange="updateAccessorioConfig('${projectId}', '${acc.id}', this.checked)"
                                               class="w-4 h-4">
                                        <span class="text-xs">${acc.icon} ${acc.label}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Campi Guide -->
                        ${(allChecked || accessori.guide) ? `
                            <div class="grid grid-cols-2 gap-2 p-2 bg-blue-50 rounded border border-blue-200">
                                <div>
                                    <label class="text-xs font-medium text-blue-700">üõ§Ô∏è Modello Guida</label>
                                    <input type="text" 
                                           value="${configTapparelle?.guida || ''}"
                                           placeholder="Seleziona guida"
                                           list="config-guida-tap-list-${projectId}"
                                           onchange="updateConfigTapparelle('${projectId}', 'guida', this.value)"
                                           class="w-full px-2 py-1 border rounded mt-1 text-sm">
                                    <datalist id="config-guida-tap-list-${projectId}">
                                        ${GUIDE_PLASTICINO.map(g => `<option value="${g}">`).join('\\n')}
                                    </datalist>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-blue-700">üé® Colore Guida</label>
                                    <input type="text" 
                                           value="${configTapparelle?.coloreGuida || ''}"
                                           placeholder="Seleziona colore"
                                           list="config-colore-guida-list-${projectId}"
                                           onchange="updateConfigTapparelle('${projectId}', 'coloreGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded mt-1 text-sm">
                                    <datalist id="config-colore-guida-list-${projectId}">
                                        ${getColoriGuide().map(c => `<option value="${c}">`).join('\\n')}
                                    </datalist>
                                </div>
                            </div>
                        ` : ''}
                    ` : `
                        <p class="text-xs text-gray-500 italic">Default: Solo il telo verr√† sostituito.</p>
                    `}
                </div>
            `;
        }
        
        // Funzioni di aggiornamento Config
        function updateSostTipoConfig(projectId, tipo) {
            updateConfigTapparelle(projectId, 'sostTipo', tipo);
            
            // Gestione qta telo default
            if (tipo === 'soloAccessori') {
                updateConfigTapparelle(projectId, 'qta', 0); // No telo
            } else {
                updateConfigTapparelle(projectId, 'qta', 1); // Con telo
            }
            
            if (tipo === 'tutto') {
                const allAccessori = {};
                ACCESSORI_TAPPARELLA.forEach(a => allAccessori[a.id] = true);
                updateConfigTapparelle(projectId, 'accessoriDaSostituire', allAccessori);
            } else if (tipo === 'niente') {
                const noAccessori = {};
                ACCESSORI_TAPPARELLA.forEach(a => noAccessori[a.id] = false);
                updateConfigTapparelle(projectId, 'accessoriDaSostituire', noAccessori);
            }
            // soloAccessori: accessori selezionabili manualmente
            
            render();
        }
        
        function updateAccessorioConfig(projectId, accessorioId, checked) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const accessori = project.configTapparelle?.accessoriDaSostituire || {};
            accessori[accessorioId] = checked;
            updateConfigTapparelle(projectId, 'accessoriDaSostituire', accessori);
            render();
        }
        
        // Mappa modello ‚Üí categoria colori
        const MODELLO_TO_COLORI_MAP = {
            // Alluminio Coibentato Media Densit√†
            'TA01': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
            'TA05': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
            'TA42': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
            'TA07': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
            // Alluminio Coibentato Alta Densit√†
            'TA25': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
            'TA30': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
            // Acciaio Coibentato
            'TA15': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
            'TA20': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
            // PVC
            'A01': ['PVC'],
            'A10': ['PVC'],
            'A16': ['PVC'],
            'A15': ['PVC'],
            // Alluminio Estruso
            'TA10': ['ALLUMINIO_UNITA'],
            'TA13': ['ALLUMINIO_UNITA'],
            // Combi (Alluminio/PVC)
            'A18': ['ALLUMINIO_UNITA', 'PVC'],
            'A20': ['ALLUMINIO_UNITA', 'PVC'],
            // Orientabili / Estella
            'A40': ['ALLUMINIO_UNITA'],
            'A50': ['ALLUMINIO_UNITA']
        };
        
        // Funzione per ottenere colori disponibili per un modello
        function getColoriTapparella(modello) {
            if (!modello) return COLORI_TAPPARELLE_PLASTICINO['PVC']; // Default PVC
            
            // Estrai codice modello (es. "TA01" da "TA01 - Tipo ALUPROFIL MD 13x55")
            const codiceMatch = modello.match(/^([A-Z0-9]+)/);
            const codice = codiceMatch ? codiceMatch[1] : '';
            
            // Trova categorie per questo modello
            const categorie = MODELLO_TO_COLORI_MAP[codice] || ['PVC'];
            
            // Unisci tutti i colori delle categorie
            let colori = [];
            categorie.forEach(cat => {
                if (COLORI_TAPPARELLE_PLASTICINO[cat]) {
                    colori = colori.concat(COLORI_TAPPARELLE_PLASTICINO[cat]);
                }
            });
            
            // Rimuovi duplicati
            return [...new Set(colori)];
        }
        
        // Funzione per aggiornare datalist colori tapparella (POSIZIONI)
        function updateColoriTapparellaDatalist(posId, modello) {
            const datalistId = `colore-tap-list-${posId}`;
            const datalist = document.getElementById(datalistId);
            
            if (!datalist) {
                console.warn(`‚ö†Ô∏è Datalist non trovato: ${datalistId}`);
                return;
            }
            
            const colori = getColoriTapparella(modello);
            
            // Aggiorna opzioni
            datalist.innerHTML = colori.map(c => `<option value="${c}">`).join('\n');
            console.log(`üé® Colori tapparella aggiornati per ${modello}: ${colori.length} opzioni`);
        }
        
        // Funzione per aggiornare datalist colori tapparella (CONFIG GLOBALE)
        function updateColoriTapparellaDatalistConfig(projectId, modello) {
            const datalistId = `config-colore-tap-list-${projectId}`;
            const datalist = document.getElementById(datalistId);
            
            if (!datalist) {
                console.warn(`‚ö†Ô∏è Datalist config non trovato: ${datalistId}`);
                return;
            }
            
            const colori = getColoriTapparella(modello);
            
            // Aggiorna opzioni
            datalist.innerHTML = colori.map(c => `<option value="${c}">`).join('\n');
            console.log(`üé® Colori tapparella CONFIG aggiornati per ${modello}: ${colori.length} opzioni`);
        }
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 2: METADATA & VERSIONING
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function initMetadata() {
            // üÜï v4.61: Metadata versioning COMPLETO con log dettagliato
            const now = new Date().toISOString();
            return {
                version: 1,  // üî¢ Numero versione incrementale (1, 2, 3, 4...)
                created: now,
                updated: now,
                device: {
                    id: getDeviceId(),
                    name: getDeviceName()
                },
                syncStatus: "local",  // local | synced | conflict
                changes: [{
                    version: 1,
                    timestamp: now,
                    action: "created",
                    details: "Progetto creato",
                    device: {
                        id: getDeviceId(),
                        name: getDeviceName()
                    }
                }]
            };
        }

        function updateProjectTimestamp(projectId, action, details, changedFields = {}) {
            // üÜï v4.61: Auto-aggiorna versione e logga modifiche DETTAGLIATE
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Inizializza metadata se non esiste (backward compatibility)
            if (!project.metadata) {
                project.metadata = initMetadata();
                project.metadata.created = project.createdDate || project.created || new Date().toISOString();
            }
            
            // üîß Migra da formato vecchio a nuovo se necessario
            if (typeof project.metadata.version === 'string') {
                // Converti "1.0" ‚Üí 1, "2.5" ‚Üí 3, etc
                project.metadata.version = parseInt(project.metadata.version.split('.')[0]) || 1;
            }
            if (project.metadata.history && !project.metadata.changes) {
                // Migra history ‚Üí changes
                project.metadata.changes = project.metadata.history || [];
                delete project.metadata.history;
            }
            if (project.metadata.createdAt && !project.metadata.created) {
                project.metadata.created = project.metadata.createdAt;
                delete project.metadata.createdAt;
            }
            if (project.metadata.lastModified && !project.metadata.updated) {
                project.metadata.updated = project.metadata.lastModified;
                delete project.metadata.lastModified;
            }
            
            // Incrementa versione
            project.metadata.version = (project.metadata.version || 0) + 1;
            
            // Aggiorna timestamp
            const now = new Date().toISOString();
            project.metadata.updated = now;
            
            // Aggiorna status
            project.metadata.syncStatus = "local";
            
            // Aggiorna device info
            project.metadata.device = {
                id: getDeviceId(),
                name: getDeviceName()
            };
            
            // Prepara entry log modifiche
            const changeEntry = {
                version: project.metadata.version,
                timestamp: now,
                action: action,
                details: details,
                device: {
                    id: getDeviceId(),
                    name: getDeviceName()
                }
            };
            
            // Aggiungi campi modificati se forniti
            if (Object.keys(changedFields).length > 0) {
                changeEntry.fields = changedFields;
            }
            
            // Aggiungi a changes array
            if (!project.metadata.changes) {
                project.metadata.changes = [];
            }
            project.metadata.changes.push(changeEntry);
            
            // Limita changes a ultimi 100 entries
            if (project.metadata.changes.length > 100) {
                project.metadata.changes = project.metadata.changes.slice(-100);
            }
            
            console.log(`üìù Progetto ${projectId} aggiornato: v${project.metadata.version} - ${action}`);
            
            saveState();
        }

        function migrateOldProjectsMetadata() {
            // Migra progetti vecchi senza metadata
            let migrated = 0;
            
            state.projects.forEach(project => {
                if (!project.metadata) {
                    project.metadata = initMetadata();
                    // Usa date esistenti se disponibili
                    if (project.createdDate) {
                        project.metadata.createdAt = project.createdDate;
                    }
                    migrated++;
                }
            });
            
            if (migrated > 0) {
                saveState();
                console.log(`‚úÖ Migrati ${migrated} progetti con metadata`);
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 3: IMPORT JSON
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function importProjectsJSON() {
            // Crea input file nascosto
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                showNotification('üì• Lettura file in corso...', 'info');
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Valida struttura
                    if (!validateImportJSON(data)) {
                        showNotification('‚ùå File JSON non valido', 'error');
                        return;
                    }
                    
                    // Processa import
                    await processImport(data);
                    
                } catch (error) {
                    console.error('Errore import:', error);
                    showNotification('‚ùå Errore durante import: ' + error.message, 'error');
                }
            };
            
            input.click();
        }

        function validateImportJSON(data) {
            // Valida struttura JSON importato
            if (!data || typeof data !== 'object') return false;
            
            // Accetta sia formato singolo progetto che array progetti
            if (Array.isArray(data.projects)) {
                // Formato export multiplo
                return data.projects.every(p => p.id && p.name);
            } else if (data.id && data.name) {
                // Formato singolo progetto
                return true;
            }
            
            return false;
        }

        async function processImport(data) {
            // Processa l'import con gestione duplicati
            
            // Converti in array se singolo progetto
            let importedProjects = Array.isArray(data.projects) ? data.projects : [data];
            
            showNotification(`üìä Analisi ${importedProjects.length} progetti...`, 'info');
            
            // Rileva duplicati
            const analysis = detectDuplicates(importedProjects);
            
            // Mostra preview
            const proceed = await showImportPreview(analysis);
            if (!proceed) return;
            
            // Crea backup pre-import
            createBackup(`Pre-import: ${importedProjects.length} progetti`);
            
            // Processa progetti nuovi (facile)
            analysis.newProjects.forEach(project => {
                // ‚úÖ NORMALIZZA positions
                if (!project.positions || !Array.isArray(project.positions)) {
                    project.positions = [];
                }
                state.projects.push(project);
            });
            
            // Processa conflitti (complesso)
            for (const conflict of analysis.conflicts) {
                const resolution = await resolveConflict(conflict);
                applyConflictResolution(conflict, resolution);
            }
            
            // Salva e aggiorna
            saveState();
            render();
            
            // Notifica risultato
            const replacedCount = analysis.conflicts.filter(c => c.resolution === 'replace').length;
            const keptCount = analysis.conflicts.filter(c => c.resolution === 'keep').length;
            
            showNotification(
                `‚úÖ Import completato!\nNuovi: ${analysis.newProjects.length} | Aggiornati: ${replacedCount} | Mantenuti: ${keptCount}`,
                'success'
            );
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 4: RILEVAMENTO DUPLICATI
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function detectDuplicates(importedProjects) {
            // Analizza e classifica progetti importati
            const results = {
                newProjects: [],      // Mai visti prima
                existingProjects: [], // Identici, nessun conflitto
                conflicts: []         // Stessi ma diversi
            };
            
            importedProjects.forEach(imported => {
                const existing = state.projects.find(p => p.id === imported.id);
                
                if (!existing) {
                    // Progetto nuovo
                    results.newProjects.push(imported);
                } else {
                    // Progetto esistente - confronta versioni
                    const comparison = compareProjects(existing, imported);
                    
                    if (comparison.identical) {
                        // Identici, nessun conflitto
                        results.existingProjects.push({
                            imported: imported,
                            existing: existing
                        });
                    } else {
                        // Diversi, conflitto!
                        results.conflicts.push({
                            imported: imported,
                            existing: existing,
                            comparison: comparison
                        });
                    }
                }
            });
            
            return results;
        }

        function compareProjects(project1, project2) {
            // Confronta due progetti in dettaglio
            const result = {
                identical: false,
                newerProject: null,  // 'project1' | 'project2' | null
                differences: {
                    positions: false,
                    products: false,
                    caratteristiche: false,
                    clientData: false
                },
                timestamps: {
                    project1: project1.metadata?.lastModified || null,
                    project2: project2.metadata?.lastModified || null
                }
            };
            
            // Confronta timestamp
            const ts1 = new Date(project1.metadata?.lastModified || 0);
            const ts2 = new Date(project2.metadata?.lastModified || 0);
            
            if (ts1 > ts2) {
                result.newerProject = 'project1';
            } else if (ts2 > ts1) {
                result.newerProject = 'project2';
            }
            
            // Confronta contenuti
            if (project1.positions?.length !== project2.positions?.length) {
                result.differences.positions = true;
            }
            
            if (JSON.stringify(project1.prodotti) !== JSON.stringify(project2.prodotti)) {
                result.differences.products = true;
            }
            
            if (JSON.stringify(project1.caratteristicheMuro) !== JSON.stringify(project2.caratteristicheMuro)) {
                result.differences.caratteristiche = true;
            }
            
            if (project1.name !== project2.name || project1.client !== project2.client) {
                result.differences.clientData = true;
            }
            
            // Determina se identici
            result.identical = !Object.values(result.differences).some(d => d);
            
            return result;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 
        // üìã SEZIONE 5: GESTIONE CONFLITTI
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function resolveConflict(conflict) {
            // Mostra dialog e ottiene scelta utente
            return new Promise((resolve) => {
                showConflictDialog(conflict, resolve);
            });
        }

        function showConflictDialog(conflict, callback) {
            // Crea e mostra dialog modale conflitto
            const { imported, existing, comparison } = conflict;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                    <div class="p-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-600">
                            ‚ö†Ô∏è Conflitto Rilevato
                        </h2>
                        
                        <div class="mb-4">
                            <p class="font-semibold text-lg">${existing.name}</p>
                            <p class="text-gray-600">${existing.client || 'Nessun cliente'}</p>
                            <p class="text-sm text-gray-500">ID: ${existing.id}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6 border rounded-lg p-4">
                            <div class="border-r pr-4">
                                <h3 class="font-bold mb-2 text-blue-600">üì± LOCALE</h3>
                                <p class="text-sm"><strong>Data:</strong> ${formatDate(comparison.timestamps.project1)}</p>
                                <p class="text-sm"><strong>Dispositivo:</strong> ${existing.metadata?.deviceName || 'Sconosciuto'}</p>
                                <p class="text-sm"><strong>Posizioni:</strong> ${existing.positions?.length || 0}</p>
                                <p class="text-sm"><strong>Versione:</strong> ${existing.metadata?.version || '1.0'}</p>
                                ${comparison.newerProject === 'project1' ? '<p class="text-green-600 font-bold mt-2">‚≠ê Pi√π recente</p>' : ''}
                            </div>
                            
                            <div class="pl-4">
                                <h3 class="font-bold mb-2 text-purple-600">üì• IMPORTATO</h3>
                                <p class="text-sm"><strong>Data:</strong> ${formatDate(comparison.timestamps.project2)}</p>
                                <p class="text-sm"><strong>Dispositivo:</strong> ${imported.metadata?.deviceName || 'Sconosciuto'}</p>
                                <p class="text-sm"><strong>Posizioni:</strong> ${imported.positions?.length || 0}</p>
                                <p class="text-sm"><strong>Versione:</strong> ${imported.metadata?.version || '1.0'}</p>
                                ${comparison.newerProject === 'project2' ? '<p class="text-green-600 font-bold mt-2">‚≠ê Pi√π recente</p>' : ''}
                            </div>
                        </div>
                        
                        ${renderDifferences(comparison.differences)}
                        
                        <div class="space-y-3 mb-6">
                            <p class="font-semibold">Cosa vuoi fare?</p>
                            
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50">
                                <input type="radio" name="resolution" value="replace" class="mr-3" ${comparison.newerProject === 'project2' ? 'checked' : ''}>
                                <div>
                                    <p class="font-semibold">Sostituisci con versione importata</p>
                                    <p class="text-sm text-gray-600">La versione locale sar√† sovrascritta</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-green-50">
                                <input type="radio" name="resolution" value="keep" class="mr-3" ${comparison.newerProject === 'project1' ? 'checked' : ''}>
                                <div>
                                    <p class="font-semibold">Mantieni versione locale</p>
                                    <p class="text-sm text-gray-600">La versione importata sar√† ignorata</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-purple-50">
                                <input type="radio" name="resolution" value="duplicate" class="mr-3">
                                <div>
                                    <p class="font-semibold">Crea nuovo progetto (duplica)</p>
                                    <p class="text-sm text-gray-600">Mantieni entrambe le versioni come progetti separati</p>
                                </div>
                            </label>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="window.closeConflictDialog('cancel')" 
                                    class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button onclick="window.closeConflictDialog('apply')" 
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Applica
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Funzione per chiudere dialog
            window.closeConflictDialog = (action) => {
                if (action === 'apply') {
                    const selected = document.querySelector('input[name="resolution"]:checked');
                    const resolution = selected ? selected.value : 'keep';
                    conflict.resolution = resolution; // Salva per stats
                    callback(resolution);
                } else {
                    callback('cancel');
                }
                document.body.removeChild(modal);
                delete window.closeConflictDialog;
            };
        }

        function renderDifferences(differences) {
            // Renderizza elenco differenze trovate
            const diffs = [];
            if (differences.positions) diffs.push('Numero posizioni diverso');
            if (differences.products) diffs.push('Prodotti selezionati diversi');
            if (differences.caratteristiche) diffs.push('Caratteristiche muro diverse');
            if (differences.clientData) diffs.push('Dati cliente diversi');
            
            if (diffs.length === 0) {
                return '<p class="text-sm text-gray-600 mb-4">‚ö†Ô∏è Stesso ID ma versioni diverse</p>';
            }
            
            return `
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="font-semibold text-sm mb-2">Differenze rilevate:</p>
                    <ul class="text-sm space-y-1">
                        ${diffs.map(d => `<li>‚Ä¢ ${d}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function applyConflictResolution(conflict, resolution) {
            // Applica la risoluzione scelta dall'utente
            const { imported, existing } = conflict;
            const existingIndex = state.projects.findIndex(p => p.id === existing.id);
            
            switch (resolution) {
                case 'replace':
                    // Sostituisci locale con importato
                    if (imported.metadata) {
                        imported.metadata.syncStatus = 'synced';
                    }
                    // ‚úÖ NORMALIZZA positions
                    if (!imported.positions || !Array.isArray(imported.positions)) {
                        imported.positions = [];
                    }
                    state.projects[existingIndex] = imported;
                    break;
                    
                case 'keep':
                    // Mantieni locale, ignora importato
                    if (existing.metadata) {
                        existing.metadata.syncStatus = 'synced';
                    }
                    // Non fare nulla
                    break;
                    
                case 'duplicate':
                    // Crea nuovo ID per importato e aggiungi
                    imported.id = generateId();
                    imported.name = imported.name + ' (importato)';
                    if (imported.metadata) {
                        imported.metadata.syncStatus = 'local';
                    }
                    // ‚úÖ NORMALIZZA positions
                    if (!imported.positions || !Array.isArray(imported.positions)) {
                        imported.positions = [];
                    }
                    state.projects.push(imported);
                    break;
                    
                case 'cancel':
                    // Non fare nulla
                    break;
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 6: BACKUP SYSTEM
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function createBackup(reason) {
            // Crea backup completo stato corrente
            const backup = {
                id: `backup_${Date.now()}`,
                timestamp: new Date().toISOString(),
                reason: reason || 'Backup manuale',
                projects: JSON.parse(JSON.stringify(state.projects)),
                count: state.projects.length,
                deviceName: getDeviceName()
            };
            
            const backups = getBackups();
            backups.push(backup);
            
            // Mantieni solo ultimi 10 backup
            if (backups.length > 10) {
                backups.shift();
            }
            
            localStorage.setItem('openPorteBackups', JSON.stringify(backups));
            
            console.log(`üíæ Backup creato: ${backup.id}`);
            return backup.id;
        }

        function getBackups() {
            // Ottiene lista backup
            const stored = localStorage.getItem('openPorteBackups');
            return stored ? JSON.parse(stored) : [];
        }

        function restoreBackup(backupId) {
            // Ripristina backup specifico
            const backups = getBackups();
            const backup = backups.find(b => b.id === backupId);
            
            if (!backup) {
                showNotification('‚ùå Backup non trovato', 'error');
                return false;
            }
            
            if (!confirm(`Ripristinare backup del ${formatDate(backup.timestamp)}?\nQuesta azione sovrascriver√† i dati correnti.`)) {
                return false;
            }
            
            // Crea backup corrente prima di restore (safety)
            createBackup('Pre-restore safety backup');
            
            // Restore
            state.projects = JSON.parse(JSON.stringify(backup.projects));
            saveState();
            render();
            
            showNotification(`‚úÖ Backup ripristinato: ${backup.reason}`, 'success');
            return true;
        }

        function deleteBackup(backupId) {
            // Elimina backup specifico
            let backups = getBackups();
            backups = backups.filter(b => b.id !== backupId);
            localStorage.setItem('openPorteBackups', JSON.stringify(backups));
            
            showNotification('üóëÔ∏è Backup eliminato', 'info');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 7: UI HELPER FUNCTIONS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function showImportPreview(analysis) {
            // Mostra preview progetti da importare
            return new Promise((resolve) => {
                const { newProjects, existingProjects, conflicts } = analysis;
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.right = '0';
                modal.style.bottom = '0';
                
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-xl w-full">
                        <div class="p-6">
                            <h2 class="text-2xl font-bold mb-4 text-blue-600">
                                üì• Anteprima Import
                            </h2>
                            
                            <div class="space-y-4 mb-6">
                                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <p class="font-bold text-green-700">‚úÖ Nuovi Progetti: ${newProjects.length}</p>
                                    <p class="text-sm text-gray-600">Saranno aggiunti senza conflitti</p>
                                </div>
                                
                                ${conflicts.length > 0 ? `
                                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <p class="font-bold text-yellow-700">‚ö†Ô∏è Conflitti Rilevati: ${conflicts.length}</p>
                                    <p class="text-sm text-gray-600">Ti verr√† chiesto come gestirli</p>
                                </div>
                                ` : ''}
                                
                                ${existingProjects.length > 0 ? `
                                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p class="font-bold text-blue-700">üìã Progetti Identici: ${existingProjects.length}</p>
                                    <p class="text-sm text-gray-600">Saranno ignorati (gi√† presenti)</p>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="window.closeImportPreview(false)" 
                                        class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                    Annulla
                                </button>
                                <button onclick="window.closeImportPreview(true)" 
                                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Continua Import
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                window.closeImportPreview = (proceed) => {
                    document.body.removeChild(modal);
                    delete window.closeImportPreview;
                    resolve(proceed);
                };
            });
        }

        function formatDate(isoString) {
            // Formatta data ISO in formato leggibile
            if (!isoString) return 'Mai';
            const date = new Date(isoString);
            return date.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚òÅÔ∏è FASE 022a: ONEDRIVE SYNC MODULE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // ‚îÄ‚îÄ‚îÄ UTILITY FUNCTIONS ‚îÄ‚îÄ‚îÄ
        
        function renderGitHubBadge() {
            // üì¶ Controllo sicurezza: se github non esiste, ritorna disconnesso
            if (!state.github || !state.github.connected) {
                return '<span style="font-size: 14px; color: #94a3b8;">‚ö™</span>'; // Disconnesso
            }
            
            switch(state.github.syncStatus) {
                case 'synced':
                    return '<span style="font-size: 14px; color: #22c55e;">üü¢</span>'; // Verde
                case 'syncing':
                    return '<span style="font-size: 14px; color: #eab308;">üü°</span>'; // Giallo
                case 'error':
                    return '<span style="font-size: 14px; color: #ef4444;">üî¥</span>'; // Rosso
                default:
                    return '<span style="font-size: 14px; color: #3b82f6;">üîµ</span>'; // Blu
            }
        }
        
        function getTimeSince(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Ora';
            if (minutes < 60) return `${minutes} min fa`;
            if (hours < 24) return `${hours} ore fa`;
            return `${days} giorni fa`;
        }
        
        // ‚îÄ‚îÄ‚îÄ AUTHENTICATION ‚îÄ‚îÄ‚îÄ
        
        async function connectOneDrive() {
            try {
                // Verifica configurazione CLIENT_ID
                if (ONEDRIVE_CONFIG.clientId === 'YOUR_CLIENT_ID_HERE') {
                    showNotification('‚ö†Ô∏è Configurare CLIENT_ID in Azure Portal prima!', 'error', 8000);
                    showOneDriveSetupInstructions();
                    return;
                }
                
                showNotification('üîó Connessione a OneDrive...', 'info');
                
                // Genera PKCE challenge
                const codeVerifier = generateRandomString(128);
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Salva verifier per dopo
                sessionStorage.setItem('onedrive_code_verifier', codeVerifier);
                
                // Costruisci URL autorizzazione
                const authUrl = `${ONEDRIVE_CONFIG.authority}/authorize?` +
                    `client_id=${ONEDRIVE_CONFIG.clientId}` +
                    `&response_type=code` +
                    `&redirect_uri=${encodeURIComponent(ONEDRIVE_CONFIG.redirectUri)}` +
                    `&scope=${encodeURIComponent(ONEDRIVE_CONFIG.scopes.join(' '))}` +
                    `&code_challenge=${codeChallenge}` +
                    `&code_challenge_method=S256` +
                    `&prompt=select_account`;
                
                // Reindirizza a pagina auth Microsoft
                window.location.href = authUrl;
                
            } catch (error) {
                console.error('Error connecting to OneDrive:', error);
                showNotification('‚ùå Errore connessione OneDrive', 'error');
            }
        }
        
        async function handleAuthCallback() {
            // üîß FIX: OneDrive rimosso, ignora callback
            if (!state.onedrive) {
                return;
            }
            
            // Gestisce il callback dopo l'autenticazione
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                showNotification('‚ùå Autenticazione annullata', 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            if (code) {
                try {
                    showNotification('üîê Ottenimento token...', 'info');
                    
                    const codeVerifier = sessionStorage.getItem('onedrive_code_verifier');
                    sessionStorage.removeItem('onedrive_code_verifier');
                    
                    // Scambia code con access token
                    const tokenResponse = await fetch(`${ONEDRIVE_CONFIG.authority}/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            client_id: ONEDRIVE_CONFIG.clientId,
                            scope: ONEDRIVE_CONFIG.scopes.join(' '),
                            code: code,
                            redirect_uri: ONEDRIVE_CONFIG.redirectUri,
                            grant_type: 'authorization_code',
                            code_verifier: codeVerifier
                        })
                    });
                    
                    if (!tokenResponse.ok) {
                        throw new Error('Token exchange failed');
                    }
                    
                    const tokens = await tokenResponse.json();
                    
                    // Salva token
                    state.onedrive.connected = true;
                    state.onedrive.accessToken = tokens.access_token;
                    state.onedrive.refreshToken = tokens.refresh_token;
                    state.onedrive.tokenExpiry = Date.now() + (tokens.expires_in * 1000);
                    
                    // Ottieni info utente
                    const userInfo = await fetch(`${ONEDRIVE_CONFIG.apiEndpoint}/me`, {
                        headers: { 'Authorization': `Bearer ${tokens.access_token}` }
                    });
                    
                    if (userInfo.ok) {
                        const user = await userInfo.json();
                        state.onedrive.userEmail = user.userPrincipalName || user.mail;
                    }
                    
                    state.onedrive.syncStatus = 'synced';
                    saveState();
                    
                    // Pulisci URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    showNotification('‚úÖ Connesso a OneDrive!', 'success');
                    
                    // Avvia sync automatica
                    if (state.onedrive.autoSyncEnabled) {
                        startAutoSync();
                    }
                    
                    // üÜï SCARICA AUTOMATICAMENTE I DATI DAL CLOUD
                    // Se l'utente connette OneDrive su nuovo dispositivo, scarica i progetti esistenti
                    setTimeout(async () => {
                        if (state.projects.length === 0) {
                            // Prova a scaricare dati dal cloud
                            showNotification('üì• Controllo dati su OneDrive...', 'info');
                            const downloaded = await downloadFromOneDrive();
                            if (downloaded) {
                                showNotification('‚úÖ Progetti sincronizzati da OneDrive!', 'success', 3000);
                            }
                        }
                    }, 1500);
                    
                    render();
                    
                } catch (error) {
                    console.error('Token exchange error:', error);
                    showNotification('‚ùå Errore ottenimento token', 'error');
                    state.onedrive.connected = false;
                    saveState();
                }
            }
        }
        
        async function disconnectOneDrive() {
            if (confirm('Disconnettere OneDrive? I dati locali NON verranno eliminati.')) {
                stopAutoSync();
                
                state.onedrive = {
                    connected: false,
                    userEmail: null,
                    accessToken: null,
                    refreshToken: null,
                    tokenExpiry: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
                
                saveState();
                render();
                showNotification('üëã OneDrive disconnesso', 'info');
            }
        }
        
        // üì¶ FASE 027K: Funzioni Helper GitHub
        function showGitHubTokenInput() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); display: flex;
                align-items: center; justify-content: center; z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h2 style="margin: 0 0 1rem 0; color: #2d3748;">üîë Token GitHub</h2>
                    <p style="color: #718096; margin-bottom: 1.5rem; font-size: 0.95rem;">
                        Inserisci il token GitHub per sincronizzare progetti.
                    </p>
                    <input type="password" id="github-token-input" 
                           placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" 
                                style="padding: 0.75rem 1.5rem; border: 2px solid #e2e8f0; background: white; color: #4a5568; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Annulla
                        </button>
                        <button onclick="saveGitHubTokenFromInput()" 
                                style="padding: 0.75rem 1.5rem; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            üíæ Salva
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('github-token-input').focus();
        }
        
        function saveGitHubTokenFromInput() {
            const token = document.getElementById('github-token-input')?.value.trim();
            
            if (!token) {
                alert('‚ùå Inserisci un token valido');
                return;
            }
            
            // üîß FIX: Assicura che state.github esista
            if (!state.github) {
                state.github = {
                    connected: false,
                    token: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
            }
            
            // Salva token
            GITHUB_CONFIG.token = token;
            state.github.token = token;
            state.github.connected = true;
            localStorage.setItem('github_token', token);
            
            saveState();
            render();
            
            // Chiudi modale
            document.querySelector('div[style*="position: fixed"]')?.remove();
            
            showNotification('‚úÖ GitHub configurato!', 'success');
        }
        
        function disconnectGitHub() {
            if (confirm('Disconnettere GitHub? I dati locali NON verranno eliminati.')) {
                state.github = {
                    connected: false,
                    token: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
                
                GITHUB_CONFIG.token = '';
                localStorage.removeItem('github_token');
                
                saveState();
                render();
                showNotification('üëã GitHub disconnesso', 'info');
            }
        }
        
        async function refreshAccessToken() {
            try {
                if (!state.onedrive.refreshToken) {
                    throw new Error('No refresh token');
                }
                
                const response = await fetch(`${ONEDRIVE_CONFIG.authority}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        client_id: ONEDRIVE_CONFIG.clientId,
                        scope: ONEDRIVE_CONFIG.scopes.join(' '),
                        refresh_token: state.onedrive.refreshToken,
                        grant_type: 'refresh_token'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Token refresh failed');
                }
                
                const tokens = await response.json();
                
                state.onedrive.accessToken = tokens.access_token;
                if (tokens.refresh_token) {
                    state.onedrive.refreshToken = tokens.refresh_token;
                }
                state.onedrive.tokenExpiry = Date.now() + (tokens.expires_in * 1000);
                
                saveState();
                return true;
                
            } catch (error) {
                console.error('Token refresh error:', error);
                showNotification('‚ö†Ô∏è Riconnetti OneDrive', 'error');
                state.onedrive.connected = false;
                stopAutoSync();
                saveState();
                return false;
            }
        }
        
        async function ensureValidToken() {
            // Verifica e rinnova token se necessario
            if (!state.onedrive.connected) {
                return false;
            }
            
            // Se token scade tra meno di 5 minuti, rinnova
            if (state.onedrive.tokenExpiry && (Date.now() + 300000) >= state.onedrive.tokenExpiry) {
                return await refreshAccessToken();
            }
            
            return true;
        }
        
        // ‚îÄ‚îÄ‚îÄ PKCE HELPERS ‚îÄ‚îÄ‚îÄ
        
        function generateRandomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            const values = crypto.getRandomValues(new Uint8Array(length));
            for (let i = 0; i < length; i++) {
                result += charset[values[i] % charset.length];
            }
            return result;
        }
        
        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            const base64 = btoa(String.fromCharCode(...new Uint8Array(hash)));
            return base64.replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
        }
        
        // ‚îÄ‚îÄ‚îÄ SYNC OPERATIONS ‚îÄ‚îÄ‚îÄ
        
        // üì¶ FASE 027K: Upload progetti su GitHub
        // üì• Download Manuale da GitHub
        async function manualDownloadFromGitHub() {
            if (!GITHUB_CONFIG.token && (!state.github || !state.github.token)) {
                showNotification('‚ö†Ô∏è Configura prima il token GitHub', 'error');
                return false;
            }
            
            const token = GITHUB_CONFIG.token || state.github.token;
            
            try {
                showNotification('‚¨áÔ∏è Download da GitHub in corso...', 'info', 3000);
                
                // Lista tutti i file nel repository
                const listUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents?ref=${GITHUB_CONFIG.branch}`;
                
                console.log('üìÇ Listing files from:', listUrl);
                
                const listResponse = await fetch(listUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!listResponse.ok) {
                    throw new Error(`GitHub API error: ${listResponse.status}`);
                }
                
                const files = await listResponse.json();
                console.log('üìÑ Files found:', files.length);
                
                // Filtra solo file JSON dei progetti
                const projectFiles = files.filter(f => f.name.endsWith('.json') && f.type === 'file');
                
                if (projectFiles.length === 0) {
                    showNotification('‚ÑπÔ∏è Nessun progetto trovato su GitHub', 'info');
                    return false;
                }
                
                console.log('üì¶ Project files:', projectFiles.map(f => f.name));
                
                // Calcola statistiche
                let newCount = 0;
                let updatedCount = 0;
                const messages = [];
                
                for (const file of projectFiles) {
                    try {
                        console.log('‚¨áÔ∏è Downloading:', file.name);
                        
                        // Usa l'API GitHub per ottenere il contenuto
                        const contentResponse = await fetch(file.url, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (!contentResponse.ok) continue;
                        
                        const contentData = await contentResponse.json();
                        
                        // Decodifica da base64
                        const content = atob(contentData.content.replace(/\s/g, ''));
                        const projectData = JSON.parse(content);
                        
                        console.log('‚úÖ Downloaded project:', projectData.name || projectData.id || 'unnamed');
                        console.log('üì¶ Project structure:', Object.keys(projectData));
                        
                        // Gestisci diverse strutture possibili
                        let projectsToImport = [];
                        
                        if (Array.isArray(projectData)) {
                            // Array di progetti
                            projectsToImport = projectData;
                        } else if (projectData.projects && Array.isArray(projectData.projects)) {
                            // Oggetto con array projects
                            projectsToImport = projectData.projects;
                        } else if (projectData.id && projectData.name) {
                            // Singolo progetto
                            projectsToImport = [projectData];
                        } else {
                            console.warn('‚ö†Ô∏è Unknown structure:', projectData);
                            continue;
                        }
                        
                        // Importa progetti
                        for (const proj of projectsToImport) {
                            if (!proj.id || !proj.name) {
                                console.warn('‚ö†Ô∏è Invalid project (missing id or name):', proj);
                                continue;
                            }
                            
                            // ‚úÖ NORMALIZZA positions
                            if (!proj.positions || !Array.isArray(proj.positions)) {
                                proj.positions = [];
                            }
                            
                            if (!existingIds.has(proj.id)) {
                                // NUOVO PROGETTO: Importa
                                state.projects.push(proj);
                                existingIds.add(proj.id);
                                newCount++;
                                console.log('‚úÖ Imported NEW:', proj.name);
                            } else {
                                // PROGETTO ESISTENTE: Confronta versioni
                                const existingIndex = state.projects.findIndex(p => p.id === proj.id);
                                const existing = state.projects[existingIndex];
                                
                                const localVersion = existing.metadata?.version || 0;
                                const githubVersion = proj.metadata?.version || 0;
                                
                                console.log(`üîÑ Project "${proj.name}": Local v${localVersion} vs GitHub v${githubVersion}`);
                                
                                if (githubVersion > localVersion) {
                                    // GitHub pi√π recente ‚Üí SOVRASCRIVI
                                    state.projects[existingIndex] = proj;
                                    updatedCount++;
                                    console.log(`‚úÖ UPDATED (GitHub v${githubVersion} > Local v${localVersion}):`, proj.name);
                                } else if (githubVersion === localVersion) {
                                    // Stesso numero versione ‚Üí Confronta timestamp
                                    const localTime = new Date(existing.metadata?.updated || 0).getTime();
                                    const githubTime = new Date(proj.metadata?.updated || 0).getTime();
                                    
                                    if (githubTime > localTime) {
                                        state.projects[existingIndex] = proj;
                                        updatedCount++;
                                        console.log(`‚úÖ UPDATED (same version but newer timestamp):`, proj.name);
                                    } else {
                                        console.log('‚è≠Ô∏è Skipped (local is same or newer):', proj.name);
                                    }
                                } else {
                                    // Locale pi√π recente ‚Üí CONFLITTO
                                    console.warn(`‚ö†Ô∏è CONFLICT: Local v${localVersion} > GitHub v${githubVersion} for "${proj.name}"`);
                                    console.warn('   ‚Üí Keeping local version. Upload to sync.');
                                }
                            }
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error downloading', file.name, error);
                    }
                }
                
                // Messaggi finali
                if (newCount > 0) messages.push(`${newCount} nuovi`);
                if (updatedCount > 0) messages.push(`${updatedCount} aggiornati`);
                
                if (newCount > 0 || updatedCount > 0) {
                    saveState();
                    render();
                    showNotification(`‚úÖ Download completato: ${messages.join(', ')}!`, 'success');
                } else {
                    showNotification('‚ÑπÔ∏è Tutti i progetti sono gi√† aggiornati', 'info');
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error in manualDownloadFromGitHub:', error);
                showNotification('‚ùå Errore download: ' + error.message, 'error');
                return false;
            }
        }
        
        // üì¶ FASE 027K: Upload progetti su GitHub
        async function uploadToGitHub(projectId = null) {
            // üîß Controllo token PRIMA di tutto
            if (!GITHUB_CONFIG.token || GITHUB_CONFIG.token.trim() === '') {
                console.error('‚ùå GITHUB_CONFIG.token non configurato:', {
                    hasToken: !!GITHUB_CONFIG.token,
                    tokenLength: GITHUB_CONFIG.token ? GITHUB_CONFIG.token.length : 0,
                    stateGithub: state.github
                });
                showNotification('‚ö†Ô∏è Token GitHub mancante - Configura in Impostazioni ‚Üí GitHub', 'error', 5000);
                return false;
            }
            
            console.log('‚úÖ Token GitHub presente:', {
                tokenLength: GITHUB_CONFIG.token.length,
                owner: GITHUB_CONFIG.owner,
                repo: GITHUB_CONFIG.repo
            });
            
            // üîß FIX: Assicura che state.github esista
            if (!state.github) {
                state.github = {
                    connected: false,
                    token: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
            }
            
            try {
                state.github.syncStatus = 'syncing';
                updateSyncStatusDisplay('syncing');
                
                // Determina quali progetti caricare
                let projectsToUpload = [];
                
                if (projectId) {
                    // Upload singolo progetto
                    const project = state.projects.find(p => p.id === projectId);
                    if (!project) {
                        throw new Error('Progetto non trovato');
                    }
                    projectsToUpload = [project];
                } else if (state.currentProject) {
                    // Upload progetto corrente
                    const project = state.projects.find(p => p.id === state.currentProject);
                    if (!project) {
                        throw new Error('Progetto corrente non trovato');
                    }
                    projectsToUpload = [project];
                } else {
                    // Upload TUTTI i progetti (se chiamato da lista)
                    projectsToUpload = state.projects;
                }
                
                if (projectsToUpload.length === 0) {
                    showNotification('‚ÑπÔ∏è Nessun progetto da sincronizzare', 'info');
                    return false;
                }
                
                // Upload progetti
                let successCount = 0;
                let failedProjects = [];
                for (const project of projectsToUpload) {
                    const uploaded = await uploadSingleProjectToGitHub(project);
                    if (uploaded) {
                        successCount++;
                    } else {
                        failedProjects.push(project.name || project.id);
                    }
                }
                
                state.github.lastSyncTime = Date.now();
                state.github.syncStatus = successCount > 0 ? 'synced' : 'error';
                updateSyncStatusDisplay(successCount > 0 ? 'synced' : 'error');
                
                // Notifica successo o errore
                if (state.github.syncNotifications && !isUserTyping()) {
                    if (!window.lastSyncNotification || (Date.now() - window.lastSyncNotification) > 5000) {
                        window.lastSyncNotification = Date.now();
                        
                        if (successCount === 0) {
                            // ‚úÖ NESSUN progetto salvato - ERRORE
                            const msg = projectsToUpload.length === 1
                                ? '‚ùå Impossibile salvare progetto su GitHub'
                                : `‚ùå Impossibile salvare ${projectsToUpload.length} progetti su GitHub`;
                            showNotification(msg, 'error', 4000);
                        } else if (successCount === projectsToUpload.length) {
                            // ‚úÖ TUTTI i progetti salvati - SUCCESSO
                            const msg = projectsToUpload.length === 1 
                                ? '‚úÖ Progetto salvato su GitHub'
                                : `‚úÖ ${successCount} progetti salvati su GitHub`;
                            showNotification(msg, 'success', 2000);
                        } else {
                            // ‚ö†Ô∏è ALCUNI progetti salvati - PARZIALE
                            const msg = `‚ö†Ô∏è ${successCount}/${projectsToUpload.length} progetti salvati su GitHub`;
                            showNotification(msg, 'warning', 3000);
                        }
                    }
                }
                
                GITHUB_CONFIG.lastSync = new Date().toISOString();
                console.log(`‚úÖ Upload completato: ${successCount}/${projectsToUpload.length} progetti`);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Errore upload GitHub:', error);
                state.github.syncStatus = 'error';
                updateSyncStatusDisplay('error');
                showNotification('‚ùå Errore GitHub: ' + error.message, 'error');
                return false;
            }
        }
        
        // üì¶ FASE NUOVA: Download progetti da GitHub
        async function downloadFromGitHub() {
            if (!GITHUB_CONFIG.token) {
                showNotification('‚ö†Ô∏è Configura GitHub prima', 'error');
                return false;
            }
            
            try {
                showNotification('üì• Sincronizzazione con GitHub...', 'info');
                
                // üÜï v4.61: SYNC BIDIREZIONALE - Lista tutti i file nella cartella progetti
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.projectsPath}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showNotification('üìÅ Cartella progetti non trovata su GitHub', 'warning');
                        return false;
                    }
                    throw new Error(`Errore GitHub: ${response.status}`);
                }
                
                const files = await response.json();
                
                // Filtra solo file JSON
                const projectFiles = files.filter(f => f.name.endsWith('.json'));
                
                if (projectFiles.length === 0) {
                    showNotification('üì≠ Nessun progetto trovato su GitHub', 'info');
                    
                    // üÜï v4.61: Se GitHub vuoto ma ci sono progetti locali, chiedi cosa fare
                    if (state.projects.length > 0) {
                        const localProjects = state.projects.length;
                        const shouldUpload = confirm(
                            `‚ö†Ô∏è ATTENZIONE:\n\n` +
                            `GitHub: 0 progetti\n` +
                            `Locale: ${localProjects} progetti\n\n` +
                            `Vuoi caricare i tuoi progetti locali su GitHub?\n\n` +
                            `OK = Carica su GitHub\n` +
                            `Annulla = Mantieni solo locali`
                        );
                        
                        if (shouldUpload) {
                            console.log('üì§ Caricamento progetti locali su GitHub...');
                            await syncToGitHub();
                        }
                    }
                    
                    return false;
                }
                
                console.log(`üì• Trovati ${projectFiles.length} progetti su GitHub`);
                
                // üÜï v4.61: Estrai ID progetti da GitHub
                const githubProjectIds = new Set(
                    projectFiles
                        .map(f => f.name.match(/progetto-(.+)\.json/))
                        .filter(m => m)
                        .map(m => m[1])
                );
                
                console.log('üìã Progetti su GitHub:', Array.from(githubProjectIds));
                
                // üÜï v4.61: Identifica progetti SOLO locali (cancellati da GitHub)
                const localOnlyProjects = state.projects.filter(p => !githubProjectIds.has(p.id));
                
                if (localOnlyProjects.length > 0) {
                    console.warn(`‚ö†Ô∏è Trovati ${localOnlyProjects.length} progetti solo locali (cancellati da GitHub):`);
                    localOnlyProjects.forEach(p => {
                        console.warn(`   - ${p.id}: ${p.name || p.client}`);
                    });
                    
                    // Chiedi all'utente cosa fare
                    const message = 
                        `‚ö†Ô∏è PROGETTI CANCELLATI DA GITHUB:\n\n` +
                        `Trovati ${localOnlyProjects.length} progetti sul tuo dispositivo\n` +
                        `che sono stati cancellati da GitHub:\n\n` +
                        localOnlyProjects.map(p => `‚Ä¢ ${p.name || p.client} (${p.id})`).join('\n') +
                        `\n\nCosa vuoi fare?\n\n` +
                        `OK = Ricaricare su GitHub\n` +
                        `Annulla = Eliminare localmente`;
                    
                    const shouldReUpload = confirm(message);
                    
                    if (shouldReUpload) {
                        // Ricarica progetti locali su GitHub
                        console.log('üì§ Ricaricamento progetti locali su GitHub...');
                        for (const project of localOnlyProjects) {
                            await uploadSingleProjectToGitHub(project);
                        }
                        showNotification(`‚úÖ ${localOnlyProjects.length} progetti ricaricati su GitHub`, 'success', 3000);
                    } else {
                        // Elimina progetti locali
                        console.log('üóëÔ∏è Eliminazione progetti locali...');
                        state.projects = state.projects.filter(p => githubProjectIds.has(p.id));
                        saveState();
                        showNotification(`üóëÔ∏è ${localOnlyProjects.length} progetti rimossi localmente`, 'info', 3000);
                    }
                }
                
                // Scarica ogni progetto da GitHub
                let downloadedCount = 0;
                let updatedCount = 0;
                let newCount = 0;
                let skippedCount = 0;
                
                for (const file of projectFiles) {
                    try {
                        // Scarica contenuto del file
                        const contentResponse = await fetch(file.url, {
                            headers: {
                                'Authorization': `token ${GITHUB_CONFIG.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (!contentResponse.ok) continue;
                        
                        const contentData = await contentResponse.json();
                        const content = atob(contentData.content.replace(/\n/g, ''));
                        const projectData = JSON.parse(content);
                        
                        // Gestisci diversi formati di file
                        let project = null;
                        
                        if (projectData.id) {
                            // Formato singolo progetto
                            project = projectData;
                        } else if (projectData.projects && Array.isArray(projectData.projects)) {
                            // Formato con array di progetti
                            project = projectData.projects[0];
                        } else if (Array.isArray(projectData)) {
                            // Formato array diretto
                            project = projectData[0];
                        }
                        
                        if (project && project.id) {
                            // ‚úÖ NORMALIZZA: Garantisci che positions sia sempre un array
                            if (!project.positions || !Array.isArray(project.positions)) {
                                project.positions = [];
                            }
                            
                            // Migra dati se necessario
                            project = migrateProjectRilievi(project);
                            
                            // üîß v4.92: Migra sostEsistente ‚Üí sostTipo
                            migrateSingleProjectSostituzione(project);
                            
                            if (typeof migrateOldData === 'function') {
                                migrateOldData();
                            }
                            
                            // Verifica se il progetto esiste gi√†
                            const existingIndex = state.projects.findIndex(p => p.id === project.id);
                            
                            if (existingIndex >= 0) {
                                // üÜï v4.61: Confronto INTELLIGENTE basato su metadata.version
                                const existing = state.projects[existingIndex];
                                
                                const remoteVersion = project.metadata?.version || 1;
                                const localVersion = existing.metadata?.version || 1;
                                
                                console.log(`üîç Confronto ${project.id}:`, {
                                    remote: remoteVersion,
                                    local: localVersion,
                                    remoteName: project.name,
                                    localName: existing.name
                                });
                                
                                if (remoteVersion > localVersion) {
                                    // GitHub pi√π recente ‚Üí Usa GitHub
                                    console.log(`üì• GitHub pi√π recente (v${remoteVersion} > v${localVersion})`);
                                    state.projects[existingIndex] = project;
                                    updatedCount++;
                                } else if (localVersion > remoteVersion) {
                                    // Locale pi√π recente ‚Üí Ignora GitHub, carica locale su GitHub dopo
                                    console.log(`üì§ Locale pi√π recente (v${localVersion} > v${remoteVersion}) - da ricaricare`);
                                    skippedCount++;
                                    // Verr√† ricaricato da auto-sync
                                } else {
                                    // Stessa versione ‚Üí Controlla timestamp come fallback
                                    const remoteDate = new Date(project.metadata?.updated || project.updated || 0);
                                    const localDate = new Date(existing.metadata?.updated || existing.updated || 0);
                                    
                                    if (remoteDate > localDate) {
                                        console.log(`üì• Stesso version ma GitHub pi√π recente (timestamp)`);
                                        state.projects[existingIndex] = project;
                                        updatedCount++;
                                    } else {
                                        console.log(`‚úÖ Progetti identici (v${localVersion})`);
                                        skippedCount++;
                                    }
                                }
                            } else {
                                // Aggiungi nuovo progetto da GitHub
                                state.projects.push(project);
                                newCount++;
                                console.log(`‚ûï Nuovo da GitHub: ${project.name} (v${project.metadata?.version || 1})`);
                            }
                            
                            downloadedCount++;
                        }
                        
                    } catch (err) {
                        console.error(`Errore scaricando ${file.name}:`, err);
                    }
                }
                
                // ‚ö° DEBUG: Verifica stato progetti dopo download
                console.log('üìä DEBUG sync bidirezionale:');
                console.log(`   - Progetti finali in state: ${state.projects.length}`);
                console.log(`   - Progetti scaricati: ${downloadedCount}/${projectFiles.length}`);
                console.log(`   - Nuovi: ${newCount}`);
                console.log(`   - Aggiornati: ${updatedCount}`);
                console.log(`   - Skipped (locale pi√π recente): ${skippedCount}`);
                state.projects.forEach((p, i) => {
                    console.log(`   ${i+1}. ${p.name || p.client || 'NO NAME'} [ID: ${p.id}] v${p.metadata?.version || '?'}`);
                });
                
                // Salva stato aggiornato
                saveState();
                
                // üîß v4.92: Migra sostEsistente ‚Üí sostTipo per dati da GitHub
                migrateSostituzioneComponenti();
                
                // Aggiorna timestamp sync
                if (state.github) {
                    state.github.lastSyncTime = Date.now();
                    state.github.syncStatus = 'synced';
                }
                
                // üÜï v4.61: Se ci sono progetti locali pi√π recenti, caricali su GitHub
                if (skippedCount > 0) {
                    console.log(`üì§ Caricamento ${skippedCount} progetti locali pi√π recenti su GitHub...`);
                    const localNewerProjects = state.projects.filter(local => {
                        const githubVersion = projectFiles
                            .find(f => f.name === `progetto-${local.id}.json`)
                            ?.metadata?.version || 0;
                        return (local.metadata?.version || 1) > githubVersion;
                    });
                    
                    for (const project of localNewerProjects) {
                        await uploadSingleProjectToGitHub(project);
                    }
                }
                
                // Mostra risultato completo
                const parts = [];
                if (newCount > 0) parts.push(`‚ûï ${newCount} nuovi`);
                if (updatedCount > 0) parts.push(`üîÑ ${updatedCount} aggiornati`);
                if (skippedCount > 0) parts.push(`üì§ ${skippedCount} ricaricati`);
                
                const message = parts.length > 0
                    ? `‚úÖ Sincronizzazione completata!\n${parts.join(' ‚Ä¢ ')}`
                    : `‚úÖ Tutti i progetti sono gi√† sincronizzati`;
                
                showNotification(message, 'success', 5000);
                
                // Re-render SEMPRE dopo download
                render();
                console.log('üîÑ Render forzato dopo sync bidirezionale');
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Errore download GitHub:', error);
                showNotification('‚ùå Errore download: ' + error.message, 'error');
                return false;
            }
        }
        
        // üì¶ FASE 027M: Normalizza positions ‚Üí formato nuovo misure
        function normalizePositionsToMisure(positions) {
            return positions.map(pos => {
                const normalized = {
                    id: pos.id,
                    name: pos.name,
                    piano: pos.piano,
                    ambiente: pos.ambiente,
                    quantita: parseInt(pos.quantita) || 1,
                    misure: pos.misure || {},
                    rilievo: pos.rilievo || {},
                    note: pos.note || '',
                    foto: pos.foto || []
                };
                
                // Normalizza infisso
                if (pos.infisso && parseInt(pos.infisso.qta) > 0) {
                    normalized.infisso = {
                        id: pos.infisso.id,
                        quantita: parseInt(pos.infisso.qta) || 0,
                        azienda: pos.infisso.azienda || 'Non specificata',
                        brm: {
                            L: pos.infisso.BRM_L || 0,
                            H: pos.infisso.BRM_H || 0
                        },
                        finitura_int: pos.infisso.finituraInt,
                        finitura_est: pos.infisso.finituraEst,
                        colore_int: pos.infisso.coloreInt,
                        colore_est: pos.infisso.coloreEst,
                        tipo_anta: pos.infisso.tipoAnta,
                        telaio: pos.infisso.telaio,
                        allarme: pos.infisso.allarme,
                        vetro: pos.infisso.vetro,
                        tipo: pos.infisso.tipo,
                        apertura: pos.infisso.apertura,
                        note: pos.infisso.note || '',
                        foto: pos.infisso.foto || []
                    };
                }
                
                // Normalizza persiana
                if (pos.persiana && parseInt(pos.persiana.qta) > 0) {
                    normalized.persiana = {
                        id: pos.persiana.id,
                        quantita: parseInt(pos.persiana.qta) || 0,
                        azienda: pos.persiana.azienda || 'Non specificata',
                        brm: {
                            L: pos.persiana.BRM_L || 0,
                            H: pos.persiana.BRM_H || 0
                        },
                        modello: pos.persiana.modello,
                        fissaggio: pos.persiana.fissaggio,
                        battuta: pos.persiana.battuta,
                        colore: pos.persiana.colorePersiana || pos.persiana.colore,
                        materiale: pos.persiana.materiale,
                        tipo: pos.persiana.tipo,
                        apertura: pos.persiana.apertura,
                        note: pos.persiana.note || '',
                        foto: pos.persiana.foto || []
                    };
                }
                
                // Normalizza zanzariera
                if (pos.zanzariera && parseInt(pos.zanzariera.qta) > 0) {
                    normalized.zanzariera = {
                        id: pos.zanzariera.id,
                        quantita: parseInt(pos.zanzariera.qta) || 0,
                        azienda: pos.zanzariera.azienda || 'Non specificata',
                        brm: {
                            L: pos.zanzariera.BRM_L || 0,
                            H: pos.zanzariera.BRM_H || 0
                        },
                        azienda: pos.zanzariera.azienda,
                        tipo: pos.zanzariera.tipo,
                        colore: pos.zanzariera.coloreTelaio,
                        tipo_rete: pos.zanzariera.tipoRete,
                        note: pos.zanzariera.note || '',
                        foto: pos.zanzariera.foto || []
                    };
                }
                
                // Normalizza tapparella
                if (pos.tapparella && parseInt(pos.tapparella.qta) > 0) {
                    normalized.tapparella = {
                        id: pos.tapparella.id,
                        quantita: parseInt(pos.tapparella.qta) || 0,
                        azienda: pos.tapparella.azienda || 'Non specificata',
                        brm: {
                            L: pos.tapparella.BRM_L || 0,
                            H: pos.tapparella.BRM_H || 0
                        },
                        modello: pos.tapparella.modello || '',
                        tipologia: pos.tapparella.tipologia || '',
                        guida: pos.tapparella.guida || '',
                        tipo: pos.tapparella.tipo,
                        materiale: pos.tapparella.materiale,
                        colore: pos.tapparella.colore,
                        motorizzazione: pos.tapparella.motorizzazione,
                        note: pos.tapparella.note || '',
                        foto: pos.tapparella.foto || []
                    };
                }
                
                // Normalizza cassonetto
                if (pos.cassonetto && parseInt(pos.cassonetto.qta) > 0) {
                    normalized.cassonetto = {
                        id: pos.cassonetto.id,
                        quantita: parseInt(pos.cassonetto.qta) || 0,
                        azienda: pos.cassonetto.azienda || 'Non specificata',
                        brm: {
                            L: pos.cassonetto.BRM_L || 0,
                            H: pos.cassonetto.BRM_H || 0
                        },
                        tipo: pos.cassonetto.tipo,
                        materiale: pos.cassonetto.materiale,
                        isolamento: pos.cassonetto.isolamento,
                        note: pos.cassonetto.note || '',
                        foto: pos.cassonetto.foto || []
                    };
                }
                
                return normalized;
            });
        }
        
        // üì¶ FASE 027K: Upload singolo progetto (helper function)
        async function uploadSingleProjectToGitHub(project) {
            try {
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üöÄ INIZIO UPLOAD PROGETTO:', project.id);
                console.log('üìã Nome:', project.name);
                console.log('üë§ Cliente:', project.client);
                console.log('üè¢ ClienteData:', project.clientData);
                console.log('üìç Posizioni:', project.positions?.length || 0);
                console.log('üîë Token presente:', !!GITHUB_CONFIG.token);
                console.log('üîë Token lunghezza:', GITHUB_CONFIG.token ? GITHUB_CONFIG.token.length : 0);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                // ‚ö†Ô∏è CONTROLLO TOKEN
                if (!GITHUB_CONFIG.token || GITHUB_CONFIG.token.trim() === '') {
                    const errorMsg = '‚ùå Token GitHub mancante';
                    console.error(errorMsg);
                    showNotification('‚ö†Ô∏è Connetti GitHub prima di salvare - Vai in "Connetti GitHub"', 'error', 5000);
                    return false;
                }
                
                // ‚úÖ VALIDAZIONE MINIMA: Richiede solo nome/cliente (progetti vuoti OK per schede pre-cantiere)
                const hasValidName = (project.name && project.name.trim()) || 
                                     (project.client && project.client.trim()) || 
                                     (project.clientData?.nome && project.clientData.nome.trim());

                if (!hasValidName) {
                    const errorMsg = `‚ö†Ô∏è Progetto ${project.id}: Nome mancante`;
                    console.log(errorMsg, {
                        id: project.id,
                        name: project.name,
                        client: project.client,
                        clientNome: project.clientData?.nome
                    });
                    showNotification(errorMsg + ' - Compila nome progetto o cliente', 'warning', 4000);
                    return false;
                }

                const numPositions = (project.positions && project.positions.length) || 0;
                console.log(`‚úÖ Upload valido: ${project.name || project.id} (${numPositions} posizioni)`);
                
                // üö® FIX v4.71: SALVA STATO PRIMA DI UPLOAD per assicurare dati freschi
                console.log('üíæ Salvataggio stato prima upload...');
                saveState();
                console.log('‚úÖ Stato salvato, procedo con upload');
                
                // üÜï v4.61: Tracking modifiche prima dell'upload
                updateProjectTimestamp(
                    project.id, 
                    'uploaded_to_github', 
                    `Progetto caricato su GitHub (${numPositions} posizioni)`,
                    { positions: numPositions }
                );
                
                // üö® RILEGGI progetto dopo updateProjectTimestamp per avere versione aggiornata
                const updatedProject = state.projects.find(p => p.id === project.id);
                if (!updatedProject) {
                    throw new Error('Progetto non trovato dopo update timestamp');
                }
                
                // Prepara dati progetto COMPLETI
                const projectData = {
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // DATI PROGETTO COMPLETI (v4.0)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    id: updatedProject.id,
                    name: updatedProject.name || '',
                    client: updatedProject.client || '',
                    
                    // DATI CLIENTE COMPLETI
                    clientData: {
                        nome: updatedProject.clientData?.nome || '',
                        cognome: updatedProject.clientData?.cognome || '',
                        telefono: updatedProject.clientData?.telefono || '',
                        email: updatedProject.clientData?.email || '',
                        indirizzo: updatedProject.clientData?.indirizzo || '',
                        citta: updatedProject.clientData?.citta || '',
                        cap: updatedProject.clientData?.cap || '',
                        piano: updatedProject.clientData?.piano || '',
                        note: updatedProject.clientData?.note || ''
                    },
                    
                    // PRODOTTI ABILITATI
                    prodotti: {
                        infissi: updatedProject.prodotti?.infissi || false,
                        persiane: updatedProject.prodotti?.persiane || false,
                        tapparelle: updatedProject.prodotti?.tapparelle || false,
                        zanzariere: updatedProject.prodotti?.zanzariere || false,
                        cassonetti: updatedProject.prodotti?.cassonetti || false,
                        blindate: updatedProject.prodotti?.blindate || false,
                        portoncini: updatedProject.prodotti?.portoncini || false
                    },
                    
                    // CARATTERISTICHE MURO
                    caratteristicheMuro: {
                        profMuroInt: updatedProject.caratteristicheMuro?.profMuroInt || '',
                        profPianaSopra: updatedProject.caratteristicheMuro?.profPianaSopra || '',
                        profPianaSotto: updatedProject.caratteristicheMuro?.profPianaSotto || '',
                        telaioProfondita: updatedProject.caratteristicheMuro?.telaioProfondita || '',
                        telaioLarghezza: updatedProject.caratteristicheMuro?.telaioLarghezza || '',
                        guidaEsistente: updatedProject.caratteristicheMuro?.guidaEsistente || '',
                        profGuida: updatedProject.caratteristicheMuro?.profGuida || '',
                        larghezzaGuida: updatedProject.caratteristicheMuro?.larghezzaGuida || '',
                        profMuroEst: updatedProject.caratteristicheMuro?.profMuroEst || '',
                        battutaSuperioreTapparella: updatedProject.caratteristicheMuro?.battutaSuperioreTapparella || '',
                        falsoEsistente: updatedProject.caratteristicheMuro?.falsoEsistente || '',
                        spessoreFalso: updatedProject.caratteristicheMuro?.spessoreFalso || '',
                        distanzaFalsoInfisso: updatedProject.caratteristicheMuro?.distanzaFalsoInfisso || ''
                    },
                    
                    // CONFIG INFISSI
                    configInfissi: {
                        azienda: updatedProject.configInfissi?.azienda || '',
                        telaio: updatedProject.configInfissi?.telaio || '',
                        finituraInt: updatedProject.configInfissi?.finituraInt || '',
                        finituraEst: updatedProject.configInfissi?.finituraEst || '',
                        coloreInt: updatedProject.configInfissi?.coloreInt || '',
                        coloreEst: updatedProject.configInfissi?.coloreEst || '',
                        tipoAnta: updatedProject.configInfissi?.tipoAnta || '',
                        vetro: updatedProject.configInfissi?.vetro || '',
                        // üÜï v4.84: Campi mancanti aggiunti
                        allarme: updatedProject.configInfissi?.allarme || '',
                        cerniere: updatedProject.configInfissi?.cerniere || '',
                        maniglia: updatedProject.configInfissi?.maniglia || '',
                        coloreManiglia: updatedProject.configInfissi?.coloreManiglia || '',
                        tagliTelaio: updatedProject.configInfissi?.tagliTelaio || '',
                        // üÜï v4.81: codTagli rimosso, generato da tagliTelaio
                        codTagliValues: updatedProject.configInfissi?.codTagliValues || []
                    },
                    
                    // BRM INFISSI
                    brmConfigInfissi: {
                        misuraBaseL: updatedProject.brmConfigInfissi?.misuraBaseL || '',
                        operazioneL: updatedProject.brmConfigInfissi?.operazioneL || '',
                        valoreL: updatedProject.brmConfigInfissi?.valoreL || '',
                        misuraBaseH: updatedProject.brmConfigInfissi?.misuraBaseH || '',
                        operazioneH: updatedProject.brmConfigInfissi?.operazioneH || '',
                        valoreH: updatedProject.brmConfigInfissi?.valoreH || '',
                        note: updatedProject.brmConfigInfissi?.note || ''
                    },
                    
                    // RILIEVO INFISSI
                    rilievoInfissi: {
                        materiale: updatedProject.rilievoInfissi?.materiale || '',
                        togliere: updatedProject.rilievoInfissi?.togliere || false,
                        smaltimento: updatedProject.rilievoInfissi?.smaltimento || false,
                        coprifiliInt: updatedProject.rilievoInfissi?.coprifiliInt || false,
                        coprifiliEst: updatedProject.rilievoInfissi?.coprifiliEst || false,
                        note: updatedProject.rilievoInfissi?.note || ''
                    },
                    
                    // CONFIG PERSIANE - üîß v5.04: Nomi campi corretti
                    configPersiane: {
                        azienda: updatedProject.configPersiane?.azienda || '',
                        modello: updatedProject.configPersiane?.modello || '',
                        fissaggio: updatedProject.configPersiane?.fissaggio || '',
                        colorePersiana: updatedProject.configPersiane?.colorePersiana || '',
                        // üîß v5.04: coloreTelaio SOLO se fissaggio = telaio
                        coloreTelaio: (updatedProject.configPersiane?.fissaggio === 'telaio') 
                                      ? (updatedProject.configPersiane?.coloreTelaio || '') 
                                      : '',
                        battuta: updatedProject.configPersiane?.battuta || '',
                        tipoStecca: updatedProject.configPersiane?.tipoStecca || '',
                        asolato: updatedProject.configPersiane?.asolato || '',
                        tipo: updatedProject.configPersiane?.tipo || '',
                        apertura: updatedProject.configPersiane?.apertura || ''
                    },
                    
                    // BRM PERSIANE
                    brmConfigPersiane: {
                        misuraBaseL: updatedProject.brmConfigPersiane?.misuraBaseL || '',
                        operazioneL: updatedProject.brmConfigPersiane?.operazioneL || '',
                        valoreL: updatedProject.brmConfigPersiane?.valoreL || '',
                        misuraBaseH: updatedProject.brmConfigPersiane?.misuraBaseH || '',
                        operazioneH: updatedProject.brmConfigPersiane?.operazioneH || '',
                        valoreH: updatedProject.brmConfigPersiane?.valoreH || '',
                        note: updatedProject.brmConfigPersiane?.note || ''
                    },
                    
                    // RILIEVO PERSIANE
                    rilievoPersiane: {
                        materiale: updatedProject.rilievoPersiane?.materiale || '',
                        togliere: updatedProject.rilievoPersiane?.togliere || false,
                        smaltimento: updatedProject.rilievoPersiane?.smaltimento || false,
                        note: updatedProject.rilievoPersiane?.note || ''
                    },
                    
                    // CONFIG TAPPARELLE
                    configTapparelle: {
                        azienda: updatedProject.configTapparelle?.azienda || '',
                        tipo: updatedProject.configTapparelle?.tipo || '',
                        colore: updatedProject.configTapparelle?.colore || '',
                        motorizzazione: updatedProject.configTapparelle?.motorizzazione || '',
                        comando: updatedProject.configTapparelle?.comando || ''
                    },
                    
                    // BRM TAPPARELLE
                    brmConfigTapparelle: {
                        misuraBaseL: updatedProject.brmConfigTapparelle?.misuraBaseL || '',
                        operazioneL: updatedProject.brmConfigTapparelle?.operazioneL || '',
                        valoreL: updatedProject.brmConfigTapparelle?.valoreL || '',
                        misuraBaseH: updatedProject.brmConfigTapparelle?.misuraBaseH || '',
                        operazioneH: updatedProject.brmConfigTapparelle?.operazioneH || '',
                        valoreH: updatedProject.brmConfigTapparelle?.valoreH || '',
                        note: updatedProject.brmConfigTapparelle?.note || ''
                    },
                    
                    // RILIEVO TAPPARELLE
                    rilievoTapparelle: {
                        materiale: updatedProject.rilievoTapparelle?.materiale || '',
                        togliere: updatedProject.rilievoTapparelle?.togliere || false,
                        smaltimento: updatedProject.rilievoTapparelle?.smaltimento || false,
                        note: updatedProject.rilievoTapparelle?.note || ''
                    },
                    
                    // CONFIG ZANZARIERE
                    configZanzariere: {
                        azienda: updatedProject.configZanzariere?.azienda || '',
                        modelloF: updatedProject.configZanzariere?.modelloF || '',
                        modelloPF: updatedProject.configZanzariere?.modelloPF || '',
                        colore: updatedProject.configZanzariere?.colore || ''
                    },
                    
                    // BRM ZANZARIERE
                    brmConfigZanzariere: {
                        misuraBaseL: updatedProject.brmConfigZanzariere?.misuraBaseL || '',
                        operazioneL: updatedProject.brmConfigZanzariere?.operazioneL || '',
                        valoreL: updatedProject.brmConfigZanzariere?.valoreL || '',
                        misuraBaseH: updatedProject.brmConfigZanzariere?.misuraBaseH || '',
                        operazioneH: updatedProject.brmConfigZanzariere?.operazioneH || '',
                        valoreH: updatedProject.brmConfigZanzariere?.valoreH || '',
                        note: updatedProject.brmConfigZanzariere?.note || ''
                    },
                    
                    // RILIEVO ZANZARIERE
                    rilievoZanzariere: {
                        materiale: updatedProject.rilievoZanzariere?.materiale || '',
                        togliere: updatedProject.rilievoZanzariere?.togliere || false,
                        smaltimento: updatedProject.rilievoZanzariere?.smaltimento || false,
                        note: updatedProject.rilievoZanzariere?.note || ''
                    },
                    
                    // CONFIG CASSONETTI
                    configCassonetti: {
                        tipo: updatedProject.configCassonetti?.tipo || '',
                        azienda: updatedProject.configCassonetti?.azienda || '',
                        materiale: updatedProject.configCassonetti?.materiale || '',
                        finitura: updatedProject.configCassonetti?.finitura || '',
                        coibentazione: updatedProject.configCassonetti?.coibentazione || '',
                        aSoffitto: updatedProject.configCassonetti?.aSoffitto || ''
                    },
                    
                    // BRM CASSONETTI
                    brmConfigCassonetti: {
                        misuraBaseL: updatedProject.brmConfigCassonetti?.misuraBaseL || '',
                        operazioneL: updatedProject.brmConfigCassonetti?.operazioneL || '',
                        valoreL: updatedProject.brmConfigCassonetti?.valoreL || '',
                        misuraBaseH: updatedProject.brmConfigCassonetti?.misuraBaseH || '',
                        operazioneH: updatedProject.brmConfigCassonetti?.operazioneH || '',
                        valoreH: updatedProject.brmConfigCassonetti?.valoreH || '',
                        misuraBaseC: updatedProject.brmConfigCassonetti?.misuraBaseC || '',
                        operazioneC: updatedProject.brmConfigCassonetti?.operazioneC || '',
                        valoreC: updatedProject.brmConfigCassonetti?.valoreC || '',
                        misuraBaseB: updatedProject.brmConfigCassonetti?.misuraBaseB || '',
                        operazioneB: updatedProject.brmConfigCassonetti?.operazioneB || '',
                        valoreB: updatedProject.brmConfigCassonetti?.valoreB || '',
                        SRSX: updatedProject.brmConfigCassonetti?.SRSX || '',
                        SRDX: updatedProject.brmConfigCassonetti?.SRDX || '',
                        ZSX: updatedProject.brmConfigCassonetti?.ZSX || '',
                        ZDX: updatedProject.brmConfigCassonetti?.ZDX || '',
                        note: updatedProject.brmConfigCassonetti?.note || ''
                    },
                    
                    // RILIEVO CASSONETTI
                    rilievoCassonetti: {
                        materiale: updatedProject.rilievoCassonetti?.materiale || '',
                        togliere: updatedProject.rilievoCassonetti?.togliere || false,
                        smaltimento: updatedProject.rilievoCassonetti?.smaltimento || false,
                        note: updatedProject.rilievoCassonetti?.note || ''
                    },
                    
                    // üö™ v5.10: configBlindate e configPortoncini RIMOSSI
                    // Ora si configurano direttamente nella posizione (pos.ingresso)
                    
                    // POSIZIONI (con caratteristiche muro per posizione)
                    positions: (updatedProject.positions || []).map(pos => ({
                        id: pos.id,
                        name: pos.name || '',
                        ambiente: pos.ambiente || '',
                        piano: pos.piano || '',
                        quantita: pos.quantita || '',
                        
                        // Caratteristiche muro posizione
                        caratteristicheMuroOverride: pos.caratteristicheMuroOverride || null,
                        
                        // Misure
                        misure: pos.misure || {},
                        
                        // Rilievo
                        rilievo: pos.rilievo || {},
                        
                        // üö™ v5.10: Tipo Posizione (finestra o ingresso)
                        tipoposizione: pos.tipoposizione || 'finestra',
                        
                        // Prodotti (solo per tipo 'finestra')
                        infisso: pos.infisso || null,
                        persiana: pos.persiana || null,
                        tapparella: pos.tapparella || null,
                        zanzariera: pos.zanzariera || null,
                        cassonetto: pos.cassonetto || null,
                        
                        // üö™ v5.10: Ingresso (solo per tipo 'ingresso')
                        ingresso: pos.ingresso ? {
                            tipo: pos.ingresso.tipo || null,  // 'portoncino' | 'blindata'
                            portoncino: pos.ingresso.portoncino || null,
                            blindata: pos.ingresso.blindata || null
                        } : null,
                        
                        // Prodotti assenti
                        prodottiAssenti: pos.prodottiAssenti || [],
                        
                        // üé® FASE DISEGNI: Disegni posizione
                        drawings: pos.drawings || [],
                        
                        // Note e foto
                        note: pos.note || '',
                        noteVisibilita: pos.noteVisibilita || [],
                        foto: pos.foto || []
                    })),
                    
                    // üé® FASE DISEGNI: Disegni progetto
                    drawings: updatedProject.drawings || {
                        general: [],
                        stats: {
                            total: 0,
                            totalSize: 0,
                            lastUpdate: new Date().toISOString()
                        }
                    },
                    
                    // DATE
                    created: updatedProject.created || new Date().toISOString(),
                    updated: new Date().toISOString(),
                    
                    // üÜï v4.61: METADATA COMPLETO con versioning e history
                    metadata: updatedProject.metadata || {
                        version: 1,
                        created: updatedProject.created || new Date().toISOString(),
                        updated: new Date().toISOString(),
                        device: {
                            id: localStorage.getItem('deviceId'),
                            name: localStorage.getItem('deviceName')
                        },
                        syncStatus: 'synced',
                        changes: []
                    }
                };
                
                // Genera nome file
                const fileName = `progetto-${updatedProject.id}.json`;
                const filePath = `progetti/${fileName}`;
                
                // Converti in JSON + Base64 (compatibile Safari iOS)
                const content = JSON.stringify(projectData, null, 2);
                
                // ‚úÖ FIX iOS: Usa TextEncoder invece di btoa+unescape (pi√π sicuro)
                let base64Content;
                try {
                    // Metodo moderno (preferito)
                    const encoder = new TextEncoder();
                    const uint8Array = encoder.encode(content);
                    base64Content = btoa(String.fromCharCode.apply(null, uint8Array));
                } catch (e) {
                    // Fallback per browser vecchi
                    base64Content = btoa(unescape(encodeURIComponent(content)));
                }
                
                // Verifica se file esiste gi√† (per ottenere SHA)
                const checkUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                
                console.log('üîç Controllo esistenza file su GitHub...');
                console.log('üìç URL:', checkUrl);
                console.log('üîë Token (primi 10 char):', GITHUB_CONFIG.token.substring(0, 10) + '...');
                
                const checkResponse = await fetch(checkUrl, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                if (checkResponse.ok) {
                    const existing = await checkResponse.json();
                    sha = existing.sha;
                    console.log('üìù File esiste gi√† - Aggiornamento (SHA:', sha.substring(0, 10) + '...)');
                } else {
                    console.log('üìÑ File non esiste - Creazione nuovo (Status:', checkResponse.status, ')');
                    if (checkResponse.status !== 404) {
                        console.warn('‚ö†Ô∏è Status inaspettato:', checkResponse.status, checkResponse.statusText);
                    }
                }
                
                // Upload file su GitHub
                const uploadUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                
                console.log('üì§ Inizio upload su GitHub...');
                console.log('üìç URL:', uploadUrl);
                console.log('üì¶ Dimensione contenuto:', content.length, 'caratteri');
                console.log('üì¶ Dimensione base64:', base64Content.length, 'caratteri');
                console.log('üîÑ Tipo operazione:', sha ? 'UPDATE (con SHA)' : 'CREATE');
                
                const uploadResponse = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `${sha ? 'Update' : 'Create'} ${fileName}`,
                        content: base64Content,
                        branch: GITHUB_CONFIG.branch,
                        ...(sha && { sha })
                    })
                });
                
                console.log('üì• Risposta GitHub:', {
                    ok: uploadResponse.ok,
                    status: uploadResponse.status,
                    statusText: uploadResponse.statusText
                });
                
                if (!uploadResponse.ok) {
                    let errorMsg = 'Upload fallito';
                    let errorDetails = null;
                    try {
                        const error = await uploadResponse.json();
                        errorMsg = error.message || errorMsg;
                        errorDetails = error;
                        console.error('‚ùå Dettagli errore GitHub:', error);
                    } catch (e) {
                        errorMsg = `HTTP ${uploadResponse.status}: ${uploadResponse.statusText}`;
                        console.error('‚ùå Impossibile parsare risposta errore');
                    }
                    console.error(`‚ùå Upload fallito per ${project.id}:`, {
                        status: uploadResponse.status,
                        statusText: uploadResponse.statusText,
                        error: errorMsg,
                        errorDetails: errorDetails
                    });
                    throw new Error(errorMsg);
                }
                
                console.log(`‚úÖ Progetto salvato con successo: ${fileName}`);
                return true;
                
            } catch (error) {
                const projectName = project.name || project.client || project.id;
                console.error(`‚ùå ERRORE upload progetto ${projectName}:`, {
                    error: error.message,
                    stack: error.stack,
                    projectId: project.id,
                    hasToken: !!GITHUB_CONFIG.token,
                    tokenLength: GITHUB_CONFIG.token ? GITHUB_CONFIG.token.length : 0
                });
                
                // Notifica specifica all'utente
                let userMsg = `‚ùå Upload fallito: ${projectName}`;
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    userMsg = '‚ö†Ô∏è Token GitHub non valido - Riconnetti';
                } else if (error.message.includes('404')) {
                    userMsg = '‚ö†Ô∏è Repository GitHub non trovato - Verifica configurazione';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    userMsg = '‚ö†Ô∏è Errore connessione - Controlla rete';
                } else {
                    userMsg = `‚ùå ${error.message}`;
                }
                showNotification(userMsg, 'error', 5000);
                
                return false;
            }
        }
        
        async function downloadFromOneDrive() {
            console.log('üîΩ downloadFromOneDrive: INIZIO');
            
            // Check 1: Token valido?
            console.log('üîΩ Check token...');
            if (!await ensureValidToken()) {
                console.error('üîΩ ERRORE: Token non valido');
                showNotification('‚ö†Ô∏è Riconnetti OneDrive', 'error');
                return false;
            }
            console.log('üîΩ Token OK');
            
            try {
                state.onedrive.syncStatus = 'syncing';
                render();
                
                // Check 2: Percorso file
                const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
                const url = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}:/content`;
                console.log('üîΩ Percorso file:', filePath);
                console.log('üîΩ URL completo:', url);
                
                // Check 3: Notifica utente
                showNotification('üì• Download da OneDrive in corso...', 'info', 3000);
                
                // Check 4: Fetch
                console.log('üîΩ Avvio fetch...');
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                console.log('üîΩ Fetch completato. Status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('üîΩ File non trovato (404). Primo upload?');
                        showNotification('üì§ File non trovato su OneDrive. Primo upload...', 'info');
                        return await uploadToOneDrive();
                    }
                    console.error('üîΩ ERRORE HTTP:', response.status, response.statusText);
                    throw new Error(`Download failed: ${response.status} ${response.statusText}`);
                }
                
                // Check 5: Parse JSON
                console.log('üîΩ Download OK. Parsing JSON...');
                const cloudData = await response.json();
                console.log('üîΩ JSON parsed. Progetti trovati:', cloudData.projects?.length || 0);
                
                // Check 6: Validazione dati
                if (!cloudData.projects || !Array.isArray(cloudData.projects)) {
                    console.error('üîΩ ERRORE: Dati non validi. projects non √® array');
                    throw new Error('Dati OneDrive non validi');
                }
                
                // Check 7: Backup locale
                console.log('üîΩ Creazione backup locale...');
                if (state.onedrive.autoBackupEnabled) {
                    createBackup('Pre-sync OneDrive');
                }
                
                // Check 8: Merge dati
                console.log('üîΩ Merge dati preservando token...');
                const currentTokens = {
                    accessToken: state.onedrive.accessToken,
                    refreshToken: state.onedrive.refreshToken,
                    tokenExpiry: state.onedrive.tokenExpiry
                };
                
                state = {
                    ...cloudData,
                    onedrive: {
                        ...cloudData.onedrive,
                        ...currentTokens,
                        connected: true
                    }
                };
                
                state.onedrive.lastSyncTime = Date.now();
                state.onedrive.syncStatus = 'synced';
                
                // Check 9: Salvataggio
                console.log('üîΩ Salvataggio state...');
                saveState();
                
                // Check 10: Render
                console.log('üîΩ Render UI...');
                render();
                
                // Check 11: Notifica successo
                console.log('üîΩ DOWNLOAD COMPLETATO! Progetti:', state.projects.length);
                showNotification(`‚úÖ ${state.projects.length} progetti scaricati da OneDrive!`, 'success', 3000);
                
                return true;
                
            } catch (error) {
                console.error('üîΩ ERRORE DOWNLOAD:', error);
                console.error('üîΩ Error message:', error.message);
                console.error('üîΩ Error stack:', error.stack);
                
                state.onedrive.syncStatus = 'error';
                render();
                
                // Notifica con dettaglio errore
                showNotification(`‚ùå Errore download: ${error.message}`, 'error', 5000);
                return false;
            }
        }
        
        // Variabile globale per tracciare l'ultimo sync
        let lastSyncAttempt = 0;
        const MIN_SYNC_INTERVAL = 10000; // Minimo 10 secondi tra sync
        
        async function performSync() {
            // Previeni sync troppo frequenti
            const now = Date.now();
            if (now - lastSyncAttempt < MIN_SYNC_INTERVAL) {
                console.log('Sync skipped - troppo frequente');
                return false;
            }
            lastSyncAttempt = now;
            
            if (!state.onedrive.connected) {
                showNotification('‚ö†Ô∏è Configura GitHub prima', 'info');
                // openSyncSettings(); // FASE 027K: Funzione OneDrive deprecata
                return;
            }
            
            try {
                // Controlla quale versione √® pi√π recente
                const cloudMeta = await getCloudFileMetadata();
                
                if (!cloudMeta) {
                    // File non esiste, upload
                    return await uploadToOneDrive();
                }
                
                const localModified = state.metadata?.lastModified || 0;
                const cloudModified = new Date(cloudMeta.lastModifiedDateTime).getTime();
                
                if (cloudModified > localModified + 60000) { // Cloud pi√π recente di 1 minuto
                    // Scarica da cloud
                    return await downloadFromOneDrive();
                } else if (localModified > cloudModified) {
                    // Carica su cloud
                    return await uploadToOneDrive();
                } else {
                    // Sincronizzati
                    state.onedrive.syncStatus = 'synced';
                    state.onedrive.lastSyncTime = Date.now();
                    // saveState(); // RIMOSSO - non necessario qui
                    // Non mostrare notifica se gi√† sincronizzato
                    return true;
                }
                
            } catch (error) {
                console.error('Sync error:', error);
                state.onedrive.syncStatus = 'error';
                showNotification('‚ùå Errore sincronizzazione', 'error');
                return false;
            }
        }
        
        async function getCloudFileMetadata() {
            try {
                if (!await ensureValidToken()) {
                    return null;
                }
                
                const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
                const url = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        return null; // File non esiste
                    }
                    throw new Error(`Metadata fetch failed: ${response.status}`);
                }
                
                return await response.json();
                
            } catch (error) {
                console.error('Metadata fetch error:', error);
                return null;
            }
        }
        
        // ‚îÄ‚îÄ‚îÄ AUTO SYNC ‚îÄ‚îÄ‚îÄ
        
        function startAutoSync() {
            if (!state.onedrive.connected || !state.onedrive.autoSyncEnabled) {
                return;
            }
            
            stopAutoSync(); // Pulisci timer esistente
            
            // USA INTERVALLO SICURO DI 5 MINUTI INVECE DI CONFIG
            const SAFE_SYNC_INTERVAL = 5 * 60 * 1000; // 5 minuti fissi
            
            syncInterval = setInterval(async () => {
                if (state.onedrive.connected && state.onedrive.autoSyncEnabled) {
                    console.log('Auto-sync triggered at', new Date().toLocaleTimeString());
                    await performSync();
                }
            }, SAFE_SYNC_INTERVAL);
            
            console.log('Auto-sync attivata (ogni 5 min effettivi)');
        }
        
        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                console.log('Auto-sync disattivata');
            }
        }
        
        // ‚îÄ‚îÄ‚îÄ UI FUNCTIONS ‚îÄ‚îÄ‚îÄ
        
        async function testOneDriveConnection() {
            console.log('üß™ TEST CONNESSIONE ONEDRIVE');
            showNotification('üß™ Test connessione in corso...', 'info');
            
            try {
                // Test 1: Token valido?
                if (!state.onedrive.connected) {
                    throw new Error('OneDrive non connesso');
                }
                
                if (!state.onedrive.accessToken) {
                    throw new Error('Access token mancante');
                }
                
                console.log('‚úÖ Token presente');
                
                // Test 2: Verifica scadenza token
                if (state.onedrive.tokenExpiry && Date.now() >= state.onedrive.tokenExpiry) {
                    console.log('‚ö†Ô∏è Token scaduto, refresh...');
                    await refreshAccessToken();
                }
                
                // Test 3: Test API Microsoft Graph
                console.log('üß™ Test API Microsoft Graph...');
                const testUrl = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive`;
                const testResponse = await fetch(testUrl, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                
                if (!testResponse.ok) {
                    throw new Error(`API test failed: ${testResponse.status}`);
                }
                
                console.log('‚úÖ API Microsoft Graph OK');
                
                // Test 4: Controlla se cartella OpenPorte esiste
                console.log('üß™ Controllo cartella OpenPorte...');
                const folderUrl = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${ONEDRIVE_CONFIG.folderPath}`;
                const folderResponse = await fetch(folderUrl, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                
                if (folderResponse.ok) {
                    console.log('‚úÖ Cartella OpenPorte trovata');
                } else if (folderResponse.status === 404) {
                    console.log('‚ö†Ô∏è Cartella OpenPorte non esiste');
                }
                
                // Test 5: Controlla se file data.json esiste
                console.log('üß™ Controllo file data.json...');
                const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
                const fileUrl = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}`;
                const fileResponse = await fetch(fileUrl, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                
                if (fileResponse.ok) {
                    const fileInfo = await fileResponse.json();
                    console.log('‚úÖ File data.json trovato');
                    console.log('üìÑ Size:', fileInfo.size, 'bytes');
                    console.log('üìÖ Modified:', fileInfo.lastModifiedDateTime);
                    showNotification(`‚úÖ Test OK! File trovato (${Math.round(fileInfo.size/1024)}KB)`, 'success', 3000);
                } else if (fileResponse.status === 404) {
                    console.log('‚ö†Ô∏è File data.json non esiste su OneDrive');
                    showNotification('‚ö†Ô∏è File non trovato su OneDrive. Carica prima dal PC!', 'error', 5000);
                } else {
                    throw new Error(`File check failed: ${fileResponse.status}`);
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå TEST FALLITO:', error);
                showNotification(`‚ùå Test fallito: ${error.message}`, 'error', 5000);
                return false;
            }
        }
        
        // üì¶ FASE 027K: Mostra impostazioni GitHub
        function openGitHubSettings() {
            // Assicura che github structure esista
            if (!state.github) {
                state.github = {
                    connected: false,
                    token: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
            }
            
            const modal = document.createElement('div');
            modal.className = 'sync-settings-modal';
            modal.innerHTML = `
                <div class="sync-settings-dialog">
                    <div class="sync-settings-header">
                        <h3>üì¶ Impostazioni GitHub</h3>
                        <button onclick="this.closest('.sync-settings-modal').remove()" class="close-btn">‚úï</button>
                    </div>
                    
                    <div class="sync-account">
                        ${state.github.connected ? `
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">
                                    üü¢ ${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}
                                </div>
                                <div style="font-size: 12px; color: #64748b;">
                                    ${state.github.lastSyncTime ? 
                                        'Ultima sync: ' + getTimeSince(state.github.lastSyncTime) : 
                                        'Mai sincronizzato'}
                                </div>
                            </div>
                            <button onclick="disconnectGitHub(); this.closest('.sync-settings-modal').remove();" class="btn-secondary">
                                Disconnetti
                            </button>
                        ` : `
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">
                                    ‚ö™ Non configurato
                                </div>
                                <div style="font-size: 12px; color: #64748b;">
                                    Inserisci token per sincronizzazione
                                </div>
                            </div>
                            <button onclick="showGitHubTokenInput(); this.closest('.sync-settings-modal').remove();" class="btn-primary">
                                üîë Configura
                            </button>
                        `}
                    </div>
                    
                    ${state.github.connected ? `
                        <div class="sync-options">
                            <label>
                                <input type="checkbox" ${state.github.autoSyncEnabled ? 'checked' : ''} 
                                       onchange="state.github.autoSyncEnabled = this.checked; saveState();">
                                <span>Sincronizzazione automatica</span>
                            </label>
                            
                            <label>
                                <input type="checkbox" ${state.github.autoBackupEnabled ? 'checked' : ''} 
                                       onchange="state.github.autoBackupEnabled = this.checked; saveState();">
                                <span>Backup automatico su modifica</span>
                            </label>
                            
                            <label>
                                <input type="checkbox" ${state.github.syncNotifications ? 'checked' : ''} 
                                       onchange="state.github.syncNotifications = this.checked; saveState();">
                                <span>Notifiche sincronizzazione</span>
                            </label>
                        </div>
                        
                        <div class="sync-actions">
                            <button onclick="manualDownloadFromGitHub(); this.closest('.sync-settings-modal').remove();" class="btn-sync" style="background: #3b82f6;">
                                ‚¨áÔ∏è Scarica da GitHub
                            </button>
                            <button onclick="uploadToGitHub(); this.closest('.sync-settings-modal').remove();" class="btn-sync">
                                ‚¨ÜÔ∏è Carica su GitHub
                            </button>
                        </div>
                    ` : ''}
                    
                    <div class="sync-info">
                        <p><strong>‚ÑπÔ∏è Come funziona:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px; color: #64748b;">
                            <li>Backup automatico su GitHub ad ogni modifica</li>
                            <li>Sincronizzazione con dashboard web</li>
                            <li>I dati locali sono sempre disponibili offline</li>
                            <li>Versioning automatico (cronologia modifiche)</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Chiudi con click fuori
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function showOneDriveSetupInstructions() {
            const modal = document.createElement('div');
            modal.className = 'sync-settings-modal';
            modal.innerHTML = `
                <div class="sync-settings-dialog" style="max-width: 600px;">
                    <div class="sync-settings-header">
                        <h3>‚öôÔ∏è Setup OneDrive</h3>
                        <button onclick="this.closest('.sync-settings-modal').remove()" class="close-btn">‚úï</button>
                    </div>
                    
                    <div style="padding: 20px; line-height: 1.6;">
                        <p><strong>Per abilitare OneDrive sync:</strong></p>
                        
                        <ol style="margin: 16px 0; padding-left: 20px;">
                            <li style="margin: 12px 0;">
                                Vai su <a href="https://portal.azure.com" target="_blank" style="color: #2563eb;">
                                    Azure Portal
                                </a>
                            </li>
                            <li style="margin: 12px 0;">
                                Vai su "App registrations" ‚Üí "New registration"
                            </li>
                            <li style="margin: 12px 0;">
                                Nome app: <strong>Open Porte</strong>
                            </li>
                            <li style="margin: 12px 0;">
                                Supported account types: <strong>Accounts in any organizational directory and personal Microsoft accounts</strong>
                            </li>
                            <li style="margin: 12px 0;">
                                Redirect URI: <strong>${window.location.origin}</strong>
                            </li>
                            <li style="margin: 12px 0;">
                                Copia il <strong>Client ID</strong> generato
                            </li>
                            <li style="margin: 12px 0;">
                                Modifica il file HTML sostituendo <code>YOUR_CLIENT_ID_HERE</code> con il tuo Client ID
                            </li>
                        </ol>
                        
                        <p style="margin-top: 20px; padding: 12px; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 13px;">
                            <strong>‚ö†Ô∏è Nota:</strong> Questo setup √® necessario solo una volta. Il Client ID pu√≤ essere condiviso tra dispositivi.
                        </p>
                    </div>
                    
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="this.closest('.sync-settings-modal').remove()" class="btn-primary">
                            Ho capito
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üé® FASE DISEGNI: GESTIONE DISEGNI NOTABILITY
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const DRAWING_LIMITS = {
            maxFileSize: 5 * 1024 * 1024,      // 5 MB
            maxProjectSize: 20 * 1024 * 1024,  // 20 MB
            maxDrawingsPerProject: 50,
            maxDrawingsPerPosition: 10,
            thumbnailSize: 200,
            thumbnailQuality: 0.7
        };

        // Genera ID univoco per disegno
        function generateDrawingId() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8);
            return `drw-${timestamp}-${random}`;
        }

        // Conta disegni totali progetto
        function getDrawingsCount(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return 0;
            
            let count = 0;
            
            // Disegni generali
            if (project.drawings?.general) {
                count += project.drawings.general.length;
            }
            
            // Disegni posizioni
            if (project.positions) {
                project.positions.forEach(pos => {
                    if (pos.drawings) {
                        count += pos.drawings.length;
                    }
                });
            }
            
            return count;
        }

        // Calcola dimensione totale disegni
        function calculateTotalDrawingsSize(project) {
            let total = 0;
            
            if (project.drawings?.general) {
                total += project.drawings.general.reduce((sum, d) => sum + (d.size || 0), 0);
            }
            
            if (project.positions) {
                project.positions.forEach(pos => {
                    if (pos.drawings) {
                        total += pos.drawings.reduce((sum, d) => sum + (d.size || 0), 0);
                    }
                });
            }
            
            return total;
        }

        // Formatta dimensione file
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        // Converti file in base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Genera thumbnail da immagine
        function generateThumbnail(file, maxSize = 200) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    resolve(null);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = Math.min(maxSize / img.width, maxSize / img.height);
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        resolve(canvas.toDataURL('image/jpeg', DRAWING_LIMITS.thumbnailQuality));
                    };
                    img.onerror = () => resolve(null);
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Valida file disegno
        function validateDrawingFile(file, project) {
            const errors = [];
            
            // Tipo file
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                errors.push('Formato non supportato. Usa PNG, JPG o PDF.');
            }
            
            // Dimensione singolo file
            if (file.size > DRAWING_LIMITS.maxFileSize) {
                errors.push(`File troppo grande. Max ${formatFileSize(DRAWING_LIMITS.maxFileSize)}`);
            }
            
            // Dimensione totale progetto
            const currentSize = calculateTotalDrawingsSize(project);
            if (currentSize + file.size > DRAWING_LIMITS.maxProjectSize) {
                const available = DRAWING_LIMITS.maxProjectSize - currentSize;
                errors.push(`Spazio insufficiente. Disponibili ${formatFileSize(available)}`);
            }
            
            // Numero disegni
            const currentCount = getDrawingsCount(project.id);
            if (currentCount >= DRAWING_LIMITS.maxDrawingsPerProject) {
                errors.push(`Limite disegni raggiunto (${DRAWING_LIMITS.maxDrawingsPerProject})`);
            }
            
            return {
                valid: errors.length === 0,
                errors
            };
        }

        // Migra progetti esistenti
        function migrateProjectDrawings(project) {
            if (!project.drawings) {
                project.drawings = {
                    general: [],
                    stats: {
                        total: 0,
                        totalSize: 0,
                        lastUpdate: new Date().toISOString()
                    }
                };
            }
            
            if (project.positions) {
                project.positions.forEach(pos => {
                    if (!pos.drawings) {
                        pos.drawings = [];
                    }
                });
            }
            
            return project;
        }

        // Aggiorna statistiche disegni
        function updateDrawingsStats(project) {
            const total = getDrawingsCount(project.id);
            const totalSize = calculateTotalDrawingsSize(project);
            
            if (!project.drawings) {
                project.drawings = { general: [] };
            }
            
            project.drawings.stats = {
                total,
                totalSize,
                lastUpdate: new Date().toISOString()
            };
        }

        // Naviga a pagina disegni
        function navigateToDrawings() {
            state.screen = 'drawings';
            render();
        }

        // Ottieni dimensioni immagine
        function getImageDimensions(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve({ width: img.width, height: img.height });
                img.onerror = () => resolve(null);
                img.src = dataUrl;
            });
        }

        // Aggiungi disegno al progetto
        async function addDrawingToProject(file, description = '', linkedPositions = []) {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) {
                showNotification('‚ùå Progetto non trovato', 'error');
                return false;
            }
            
            // Migra struttura se necessario
            migrateProjectDrawings(project);
            
            // Valida file
            const validation = validateDrawingFile(file, project);
            if (!validation.valid) {
                showNotification('‚ùå ' + validation.errors[0], 'error');
                return false;
            }
            
            try {
                showNotification('üì§ Caricamento in corso...', 'info');
                
                // Converti in base64
                const data = await fileToBase64(file);
                
                // Genera thumbnail per immagini
                const thumbnail = await generateThumbnail(file);
                
                // Crea oggetto disegno
                const drawing = {
                    id: generateDrawingId(),
                    name: file.name.replace(/\.[^/.]+$/, ''), // Rimuovi estensione
                    description,
                    type: file.type,
                    size: file.size,
                    data,
                    thumbnail,
                    uploadDate: new Date().toISOString(),
                    linkedPositions,
                    metadata: {
                        originalName: file.name,
                        source: 'Upload',
                        dimensions: file.type.startsWith('image/') ? await getImageDimensions(data) : null
                    }
                };
                
                // Aggiungi a progetto
                project.drawings.general.push(drawing);
                
                // Aggiorna statistiche
                updateDrawingsStats(project);
                
                // Salva
                saveToLocalStorage();
                
                showNotification('‚úÖ Disegno aggiunto', 'success');
                render();
                
                return true;
                
            } catch (error) {
                console.error('Errore aggiunta disegno:', error);
                showNotification('‚ùå Errore caricamento: ' + error.message, 'error');
                return false;
            }
        }

        // Elimina disegno
        function deleteDrawing(drawingId, positionId = null) {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return false;
            
            if (positionId) {
                // Disegno di posizione
                const position = project.positions?.find(p => p.id === positionId);
                if (position?.drawings) {
                    position.drawings = position.drawings.filter(d => d.id !== drawingId);
                }
            } else {
                // Disegno generale
                if (project.drawings?.general) {
                    project.drawings.general = project.drawings.general.filter(d => d.id !== drawingId);
                }
            }
            
            updateDrawingsStats(project);
            saveToLocalStorage();
            showNotification('‚úÖ Disegno eliminato', 'success');
            render();
            
            return true;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üéØ FASE 021: MENU LATERALE HAMBURGER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Genera HTML menu laterale con header compatto
        function renderProjectMenu() {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return '';
            
            // Determina quali prodotti sono selezionati
            const hasInfissi = project.prodotti?.infissi || false;
            const hasPersiane = project.prodotti?.persiane || false;
            const hasTapparelle = project.prodotti?.tapparelle || false;
            const hasZanzariere = project.prodotti?.zanzariere || false;
            const hasCassonetti = project.prodotti?.cassonetti || false;
            const hasBlindate = project.prodotti?.blindate || false;
            
            // Verifica prerequisiti per navigazione
            const canGoToPositions = hasInfissi || hasPersiane || hasTapparelle || 
                                     hasZanzariere || hasCassonetti || hasBlindate;
            
            // Determina se sezione √® attiva
            const isStep1Active = state.setupStep === 1;
            const isStep2Active = state.setupStep === 2;
            const isStep3Active = state.setupStep === 3 && hasInfissi;
            const isStep4Active = state.setupStep === 4 && hasPersiane;
            const isStep5Active = state.setupStep === 5 && hasTapparelle;
            const isStep6Active = state.setupStep === 6 && hasZanzariere;
            const isStep7Active = state.setupStep === 7 && hasCassonetti;
            const isStep8Active = state.setupStep === 8 && hasBlindate;
            const isStep9Active = state.setupStep === 9;
            
            // Calcola completamento per ogni sezione
            const completamentoCliente = calcolaCompletamentoCliente(project);
            const completamentoSetup = calcolaCompletamentoSetup(project);
            const completamentoConfig = calcolaCompletamentoConfig(project);
            const completamentoPosizioni = calcolaCompletamentoPosizioni(project);
            
            // Stato menu Config (espanso o collassato)
            const configExpanded = state.configMenuExpanded || false;
            
            return `
                <!-- Header compatto fisso -->
                <header class="app-header">
                    <button class="menu-toggle" onclick="toggleProjectMenu()">‚ò∞</button>
                    <h1 class="app-title">
                        ${project.clientName || 'Nuovo Progetto'}
                        ${project.ambiente ? ` - ${project.ambiente}` : ''}
                        <span style="margin-left: 1rem; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-size: 0.75rem; font-weight: 600; vertical-align: middle;">v${APP_VERSION}</span>
                    </h1>
                    <div class="header-actions">
                        <button class="btn-icon" onclick="exportCurrentProjectJSON()" title="Export JSON">üíæ</button>
                        <button class="btn-icon" onclick="printCurrentProjectPDF()" title="Export PDF">üñ®Ô∏è</button>
                    </div>
                </header>
                
                <!-- Menu laterale progetto -->
                <aside class="side-menu-project ${state.projectMenuOpen ? 'open' : ''}" id="projectSideMenu">
                    <!-- Header menu -->
                    <div class="project-menu-header">
                        <button class="project-menu-close" onclick="toggleProjectMenu()">‚úï</button>
                        <span>MENU PROGETTO</span>
                    </div>
                    
                    <!-- Info Progetto -->
                    <div class="project-info-box">
                        <div class="project-name">${project.clientName || 'Nuovo Progetto'}</div>
                        ${project.ambiente ? `<div class="project-ambiente">${project.ambiente}</div>` : ''}
                    </div>
                    
                    <!-- Navigazione Principale -->
                    <div class="nav-section">
                        <div class="nav-title">Navigazione</div>
                        
                        <!-- Cliente -->
                        <div class="nav-item ${isStep1Active ? 'active' : ''}" 
                             onclick="navigateToStep(1); closeProjectMenu();">
                            <div class="nav-label">
                                <span class="nav-icon">üë§</span>
                                <span>Cliente</span>
                            </div>
                            ${renderCompletionBadge(completamentoCliente)}
                        </div>
                        
                        <!-- Setup -->
                        <div class="nav-item ${isStep2Active ? 'active' : ''}" 
                             onclick="navigateToStep(2); closeProjectMenu();">
                            <div class="nav-label">
                                <span class="nav-icon">üõ†Ô∏è</span>
                                <span>Setup</span>
                            </div>
                            ${renderCompletionBadge(completamentoSetup)}
                        </div>
                        
                        <!-- Config (con submenu) -->
                        <div class="nav-item ${(isStep3Active || isStep4Active || isStep5Active || isStep6Active || isStep7Active) ? 'active' : ''}" 
                             onclick="toggleConfigMenu(event)">
                            <div class="nav-label">
                                <span class="nav-icon">‚öôÔ∏è</span>
                                <span>Config</span>
                                <span style="margin-left: auto; font-size: 12px;">${configExpanded ? '‚ñº' : '‚ñ∂'}</span>
                            </div>
                            ${renderCompletionBadge(completamentoConfig)}
                        </div>
                        
                        <!-- Submenu Config -->
                        <div class="nav-submenu ${configExpanded ? 'open' : ''}" id="configSubmenu">
                            ${hasInfissi ? `
                                <div class="nav-submenu-item ${isStep3Active ? 'active' : ''}" 
                                     onclick="navigateToStep(3); closeProjectMenu();">
                                    <span>ü™ü Infissi</span>
                                    ${renderCompletionBadge(calcolaCompletamentoInfissi(project), true)}
                                </div>
                            ` : ''}
                            
                            ${hasPersiane ? `
                                <div class="nav-submenu-item ${isStep4Active ? 'active' : ''}" 
                                     onclick="navigateToStep(4); closeProjectMenu();">
                                    <span>üö™ Persiane</span>
                                    ${renderCompletionBadge(calcolaCompletamentoPersiane(project), true)}
                                </div>
                            ` : ''}
                            
                            ${hasTapparelle ? `
                                <div class="nav-submenu-item ${isStep5Active ? 'active' : ''}" 
                                     onclick="navigateToStep(5); closeProjectMenu();">
                                    <span>üéöÔ∏è Tapparelle</span>
                                    ${renderCompletionBadge(calcolaCompletamentoTapparelle(project), true)}
                                </div>
                            ` : ''}
                            
                            ${hasZanzariere ? `
                                <div class="nav-submenu-item ${isStep6Active ? 'active' : ''}" 
                                     onclick="navigateToStep(6); closeProjectMenu();">
                                    <span>ü¶ü Zanzariere</span>
                                    ${renderCompletionBadge(calcolaCompletamentoZanzariere(project), true)}
                                </div>
                            ` : ''}
                            
                            ${hasCassonetti ? `
                                <div class="nav-submenu-item ${isStep7Active ? 'active' : ''}" 
                                     onclick="navigateToStep(7); closeProjectMenu();">
                                    <span>üì¶ Cassonetti</span>
                                    ${renderCompletionBadge(calcolaCompletamentoCassonetti(project), true)}
                                </div>
                            ` : ''}
                            
                            ${hasBlindate ? `
                                <div class="nav-submenu-item ${isStep8Active ? 'active' : ''}" 
                                     onclick="navigateToStep(8); closeProjectMenu();">
                                    <span>üîê Blindate</span>
                                </div>
                            ` : ''}
                            
                            ${!hasInfissi && !hasPersiane && !hasTapparelle && !hasZanzariere && !hasCassonetti && !hasBlindate ? `
                                <div style="padding: 12px 20px 12px 52px; color: #64748b; font-size: 14px; font-style: italic;">
                                    Nessun prodotto selezionato
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Posizioni -->
                        <div class="nav-item ${!canGoToPositions ? 'disabled' : ''} ${isStep9Active ? 'active' : ''}" 
                             onclick="${canGoToPositions ? 'navigateToPositions(); closeProjectMenu();' : ''}">
                            <div class="nav-label">
                                <span class="nav-icon">üìç</span>
                                <span>Posizioni</span>
                            </div>
                            ${canGoToPositions ? renderCompletionBadge(completamentoPosizioni) : ''}
                        </div>
                        
                        <!-- üé® FASE DISEGNI: Disegni -->
                        <div class="nav-item ${state.screen === 'drawings' ? 'active' : ''}" 
                             onclick="navigateToDrawings(); closeProjectMenu();">
                            <div class="nav-label">
                                <span class="nav-icon">üé®</span>
                                <span>Disegni</span>
                            </div>
                            ${(() => {
                                const count = getDrawingsCount(state.currentProject);
                                return count > 0 ? `<span class="count-badge">${count}</span>` : '';
                            })()}
                        </div>
                        
                        
                        <!-- üì¶ FASE 027K: GitHub Sync -->
                        <div style="border-top: 1px solid var(--menu-border); margin: 12px 0;"></div>
                        
                        <div class="nav-item" onclick="openGitHubSettings(); closeProjectMenu();">
                            <div class="nav-label">
                                <span class="nav-icon">üì¶</span>
                                <span>GitHub</span>
                            </div>
                            <span class="sync-badge" id="syncBadge">
                                ${renderGitHubBadge()}
                            </span>
                        </div>
                        
                        ${state.github.connected ? `
                            <div style="padding: 8px 20px; font-size: 12px; color: var(--menu-text-sec);">
                                <div>üü¢ ${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}</div>
                                ${state.github.lastSyncTime ? `
                                    <div style="margin-top: 4px;">
                                        üîÑ ${getTimeSince(state.github.lastSyncTime)}
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div style="padding: 8px 20px; font-size: 12px; color: #f59e0b;">
                                ‚ö†Ô∏è Non configurato
                            </div>
                        `}
                    </div>
                    
                    <!-- Azioni Rapide -->
                    <div class="menu-actions">
                        <button class="menu-action-btn" onclick="exportCurrentProjectExcel(); closeProjectMenu();">
                            üìä Excel Completo
                        </button>
                        <button class="menu-action-btn" onclick="exportCurrentProjectJSON(); closeProjectMenu();">
                            üíæ Esporta JSON
                        </button>
                        <button class="menu-action-btn" onclick="printCurrentProjectPDF(); closeProjectMenu();">
                            üñ®Ô∏è Esporta PDF
                        </button>
                        <button class="menu-action-btn" onclick="importProjectsJSON(); closeProjectMenu();">
                            üì• Importa JSON
                        </button>
                        <button class="menu-action-btn primary" onclick="tornaAllaLista();">
                            ‚Üê Lista Progetti
                        </button>
                    </div>
                </aside>
                
                <!-- Overlay -->
                <div class="menu-overlay ${state.projectMenuOpen ? 'active' : ''}" 
                     id="projectMenuOverlay" 
                     onclick="closeProjectMenu()"></div>
            `;
        }
        
        // Funzioni di gestione menu laterale
        function toggleProjectMenu() {
            state.projectMenuOpen = !state.projectMenuOpen;
            render();
        }
        
        function closeProjectMenu() {
            state.projectMenuOpen = false;
            render();
        }
        
        function toggleConfigMenu(event) {
            if (event) event.stopPropagation();
            state.configMenuExpanded = !state.configMenuExpanded;
            render();
        }
        
        // Render badge completamento
        function renderCompletionBadge(percentuale, mini = false) {
            if (percentuale === 0) return '';
            
            const dotColor = percentuale === 100 ? 'green' : 
                           percentuale >= 50 ? 'yellow' : 'red';
            
            if (mini) {
                return `<span class="completion-percent">${percentuale}%</span>`;
            }
            
            return `
                <div class="completion-badge">
                    <div class="completion-dot ${dotColor}"></div>
                    <span class="completion-percent">${percentuale}%</span>
                </div>
            `;
        }
        
        // Mantieni compatibilit√† nomi vecchi
        const renderTopNavbar = renderProjectMenu;

        // ‚úÖ FASE 012 - FUNZIONI CALCOLO COMPLETAMENTO
        
        // Calcola completamento sezione Cliente
        function calcolaCompletamentoCliente(project) {
            if (!project) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 5; // Nome, Indirizzo, Telefono, Email, Ambiente
            
            if (project.clientName) campiCompilati++;
            if (project.clientAddress) campiCompilati++;
            if (project.clientPhone) campiCompilati++;
            if (project.clientEmail) campiCompilati++;
            if (project.ambiente) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        // Calcola completamento Setup
        function calcolaCompletamentoSetup(project) {
            if (!project || !project.prodotti) return 0;
            
            // Almeno un prodotto selezionato = 100%
            const hasAnyProduct = project.prodotti.infissi || project.prodotti.persiane ||
                                 project.prodotti.tapparelle || project.prodotti.zanzariere ||
                                 project.prodotti.cassonetti;
            
            return hasAnyProduct ? 100 : 0;
        }

        // Calcola completamento Config generale
        function calcolaCompletamentoConfig(project) {
            if (!project || !project.prodotti) return 0;
            
            let totaleCompletamento = 0;
            let prodottiSelezionati = 0;
            
            if (project.prodotti.infissi) {
                totaleCompletamento += calcolaCompletamentoInfissi(project);
                prodottiSelezionati++;
            }
            if (project.prodotti.persiane) {
                totaleCompletamento += calcolaCompletamentoPersiane(project);
                prodottiSelezionati++;
            }
            if (project.prodotti.tapparelle) {
                totaleCompletamento += calcolaCompletamentoTapparelle(project);
                prodottiSelezionati++;
            }
            if (project.prodotti.zanzariere) {
                totaleCompletamento += calcolaCompletamentoZanzariere(project);
                prodottiSelezionati++;
            }
            if (project.prodotti.cassonetti) {
                totaleCompletamento += calcolaCompletamentoCassonetti(project);
                prodottiSelezionati++;
            }
            
            if (prodottiSelezionati === 0) return 0;
            
            return Math.round(totaleCompletamento / prodottiSelezionati);
        }

        // Calcola completamento Posizioni
        function calcolaCompletamentoPosizioni(project) {
            if (!project || !project.positions || project.positions.length === 0) return 0;
            
            let posizioniCompletate = 0;
            
            project.positions.forEach(pos => {
                // Una posizione √® completa se ha almeno nome e un prodotto con misure
                if (pos.name) {
                    let hasMeasures = false;
                    
                    ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'].forEach(tipo => {
                        if (pos[tipo] && (pos[tipo].larghezza || pos[tipo].altezza)) {
                            hasMeasures = true;
                        }
                    });
                    
                    if (hasMeasures) posizioniCompletate++;
                }
            });
            
            return project.positions.length > 0 ? 
                   Math.round((posizioniCompletate / project.positions.length) * 100) : 0;
        }

        // Funzioni specifiche per ogni prodotto
        function calcolaCompletamentoInfissi(project) {
            if (!project.brmConfigInfissi) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 4;
            
            if (project.brmConfigInfissi.valoreL) campiCompilati++;
            if (project.brmConfigInfissi.valoreH) campiCompilati++;
            if (project.rilievoInfissi?.materiale) campiCompilati++;
            if (project.rilievoInfissi?.note) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        function calcolaCompletamentoPersiane(project) {
            if (!project.brmConfigPersiane) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 4;
            
            if (project.brmConfigPersiane.valoreL) campiCompilati++;
            if (project.brmConfigPersiane.valoreH) campiCompilati++;
            if (project.rilievoPersiane?.materiale) campiCompilati++;
            if (project.rilievoPersiane?.note) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        function calcolaCompletamentoTapparelle(project) {
            if (!project.brmConfigTapparelle) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 4;
            
            if (project.brmConfigTapparelle.valoreL) campiCompilati++;
            if (project.brmConfigTapparelle.valoreH) campiCompilati++;
            if (project.rilievoTapparelle?.materiale) campiCompilati++;
            if (project.rilievoTapparelle?.note) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        function calcolaCompletamentoZanzariere(project) {
            if (!project.brmConfigZanzariere) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 2;
            
            if (project.brmConfigZanzariere.valoreL) campiCompilati++;
            if (project.brmConfigZanzariere.valoreH) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        function calcolaCompletamentoCassonetti(project) {
            if (!project.brmConfigCassonetti) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 4;
            
            if (project.brmConfigCassonetti.valoreL) campiCompilati++;
            if (project.brmConfigCassonetti.valoreC) campiCompilati++;
            if (project.brmConfigCassonetti.valoreB) campiCompilati++;
            if (project.rilievoCassonetti?.materiale) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        // Funzione per tornare alla lista progetti
        function tornaAllaLista() {
            if (confirm('Vuoi tornare alla lista progetti? Le modifiche sono salvate automaticamente.')) {
                state.screen = 'list';
                state.currentProject = null;
                state.setupStep = 1;
                saveState();
                render();
            }
        }

        // Toggle riepilogo rilievi

        // Naviga a step specifico con validazione prerequisiti
        function navigateToStep(stepNumber) {
            // Chiudi dropdown se aperto
            const dropdown = document.getElementById('configDropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            
            // Verifica se pu√≤ navigare
            if (!canNavigateToStep(stepNumber)) {
                showNotification('‚ö†Ô∏è Completa prima i passaggi precedenti', 'warning');
                return;
            }
            
            // Cambia step e renderizza
            state.setupStep = stepNumber;
            saveState();
            render();
        }

        // Naviga direttamente a Step 9 (Posizioni)
        function navigateToPositions() {
            // Chiudi dropdown se aperto
            const dropdown = document.getElementById('configDropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            
            const project = state.projects[state.currentProject];
            if (!project) return;
            
            // Verifica che ci sia almeno un prodotto selezionato
            const hasProducts = project.prodotti?.infissi || 
                                project.prodotti?.persiane || 
                                project.prodotti?.tapparelle || 
                                project.prodotti?.zanzariere || 
                                project.prodotti?.cassonetti;
            
            if (!hasProducts) {
                showNotification('‚ö†Ô∏è Seleziona almeno un prodotto nello Setup', 'warning');
                return;
            }
            
            // Salta direttamente a step 9
            state.setupStep = 9;
            saveState();
            render();
        }

        // Verifica se √® possibile navigare a uno step specifico
        function canNavigateToStep(stepNumber) {
            const project = state.projects[state.currentProject];
            if (!project) return false;
            
            // Step 1-2 sempre accessibili
            if (stepNumber <= 2) {
                return true;
            }
            
            // Step 3-7: Config prodotti - verificare se prodotto selezionato
            if (stepNumber === 3) {
                return project.prodotti?.infissi || false;
            }
            if (stepNumber === 4) {
                return project.prodotti?.persiane || false;
            }
            if (stepNumber === 5) {
                return project.prodotti?.tapparelle || false;
            }
            if (stepNumber === 6) {
                return project.prodotti?.zanzariere || false;
            }
            if (stepNumber === 7) {
                return project.prodotti?.cassonetti || false;
            }
            
            // Step 9: Posizioni - almeno un prodotto selezionato
            if (stepNumber === 9) {
                return project.prodotti?.infissi || 
                       project.prodotti?.persiane || 
                       project.prodotti?.tapparelle || 
                       project.prodotti?.zanzariere || 
                       project.prodotti?.cassonetti;
            }
            
            return false;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // üéØ FASE 28: Navigazione intelligente tra step dinamici
        function getValidSteps(project) {
            const steps = [1, 2]; // Sempre presenti: Dati Cliente, Prodotti (include Muro)
            
            // Aggiungi solo gli step dei prodotti selezionati
            if (project.prodotti?.infissi) steps.push(3);
            if (project.prodotti?.persiane) steps.push(4);
            if (project.prodotti?.tapparelle) steps.push(5);
            if (project.prodotti?.zanzariere) steps.push(6);
            if (project.prodotti?.cassonetti) steps.push(7);
            // üö™ v5.08: Blindate e Portoncini non hanno pi√π step globale
            
            // Step finale sempre presente
            steps.push(8);
            
            return steps;
        }

        function getNextValidStep(currentStep, project) {
            const validSteps = getValidSteps(project);
            const currentIndex = validSteps.indexOf(currentStep);
            if (currentIndex !== -1 && currentIndex < validSteps.length - 1) {
                return validSteps[currentIndex + 1];
            }
            return currentStep; // Se siamo all'ultimo step, rimani l√¨
        }

        function getPrevValidStep(currentStep, project) {
            const validSteps = getValidSteps(project);
            const currentIndex = validSteps.indexOf(currentStep);
            if (currentIndex > 0) {
                return validSteps[currentIndex - 1];
            }
            return currentStep; // Se siamo al primo step, rimani l√¨
        }

        window.goToNextStep = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                state.setupStep = getNextValidStep(state.setupStep, project);
                saveState();
                render();
            }
        };

        window.goToPrevStep = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                state.setupStep = getPrevValidStep(state.setupStep, project);
                render();
            }
        };

        // üéØ FASE 25: Gestione Select con "Altro e scrivo"
        function handleSelectWithCustom(projectId, field, selectId, inputId, value, options) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (!select || !input) return;
            
            if (value === '__ALTRO__') {
                // Mostra input personalizzato
                input.style.display = 'block';
                input.focus();
                // Non salvare ancora
            } else if (value) {
                // Opzione standard selezionata
                input.style.display = 'none';
                input.value = '';
                updateClientData(projectId, field, value);
            }
        }

        function handleConfigSelectWithCustom(projectId, configType, field, selectId, inputId, value) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (!select || !input) return;
            
            if (value === '__ALTRO__') {
                // Mostra input personalizzato
                input.style.display = 'block';
                input.focus();
            } else if (value) {
                // Opzione standard selezionata
                input.style.display = 'none';
                input.value = '';
                // Chiama la funzione di update appropriata
                const updateFnMap = {
                    'persiane': updateConfigPersiane,
                    'tapparelle': updateConfigTapparelle,
                    'zanzariere': updateConfigZanzariere,
                    'cassonetti': updateConfigCassonetti
                };
                const updateFn = updateFnMap[configType];
                if (updateFn) {
                    updateFn(projectId, field, value);
                }
            }
        }

        function handleProductSelectWithCustom(projectId, posId, productType, field, selectId, inputId, value) {
            console.log(`üéØ handleProductSelectWithCustom: productType=${productType}, field=${field}, value=${value}`);
            
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (!select || !input) {
                console.error('‚ùå Select o input non trovati:', selectId, inputId);
                return;
            }
            
            // üÜï v4.24: Feedback visivo immediato per campo tipo obbligatorio
            if (field === 'tipo' && (productType === 'infisso' || productType === 'persiana')) {
                if (value === '' || value === '__ALTRO__') {
                    // Vuoto o custom ‚Üí arancione
                    select.classList.remove('border', 'bg-white');
                    select.classList.add('border-2', 'border-orange-400', 'bg-orange-50');
                } else {
                    // Compilato ‚Üí bianco
                    select.classList.remove('border-2', 'border-orange-400', 'bg-orange-50');
                    select.classList.add('border', 'bg-white');
                }
            }
            
            if (value === '__ALTRO__') {
                // Mostra input personalizzato
                input.style.display = 'block';
                input.focus();
            } else if (value) {
                // Opzione standard selezionata
                input.style.display = 'none';
                input.value = '';
                
                // üÜï v4.95: Se cambia tipo persiana, ricalcola accessori
                if (productType === 'persiana' && field === 'tipo') {
                    console.log(`üìå Chiamo updateTipoPersiana con value=${value}`);
                    updateTipoPersiana(projectId, posId, value);
                } else {
                    updateProduct(projectId, posId, productType, field, value);
                }
            }
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-300',
                error: 'bg-red-100 text-red-800 border-red-300',
                info: 'bg-blue-100 text-blue-800 border-blue-300'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification ${colors[type]} border-2`;
            notification.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 2000);
        }

        // üéØ FASE 18A - SISTEMA VALIDAZIONE MISURE
        function validateMisure(project, pos) {
            const errors = [];
            const warnings = [];
            
            const misure = pos.misure || {};
            
            // Prendi caratteristiche muro (override o globali)
            const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                ? pos.caratteristicheMuroOverride 
                : project.caratteristicheMuro || {};
            
            const LF = parseFloat(misure.LF) || 0;
            const HF = parseFloat(misure.HF) || 0;
            const LVT = parseFloat(misure.LVT) || 0;
            const HVT = parseFloat(misure.HVT) || 0;
            const TMV = parseFloat(misure.TMV) || 0;
            const HMT = parseFloat(misure.HMT) || 0;
            
            const LT = parseFloat(cm.telaioLarghezza) || 0;
            
            // Calcola ARIA
            let ARIA = 0;
            if (cm.falsoEsistente === 'si') {
                ARIA = parseFloat(cm.distanzaFalsoInfisso) || 0;
            } else if (cm.falsoEsistente === 'no') {
                ARIA = parseFloat(cm.distanzaMuroInfisso) || 0;
            }
            
            // Calcola SPESSORE_FALSO
            const SPESSORE_FALSO = cm.falsoEsistente === 'si' ? (parseFloat(cm.spessoreFalso) || 0) : 0;
            
            // 1. LF >= LVT (Luce Foro deve essere >= Luce Vano Telaio)
            if (LF > 0 && LVT > 0) {
                if (LF < LVT) {
                    errors.push({
                        field: 'LF',
                        message: `LF (${LF}) deve essere ‚â• LVT (${LVT})`
                    });
                }
            }
            
            // 2. HF >= HVT (Altezza Foro deve essere >= Altezza Vano Telaio)
            if (HF > 0 && HVT > 0) {
                if (HF < HVT) {
                    errors.push({
                        field: 'HF',
                        message: `HF (${HF}) deve essere ‚â• HVT (${HVT})`
                    });
                }
            }
            
            // 3. HVT + LT <= HMT
            if (HVT > 0 && LT > 0 && HMT > 0) {
                if (HVT + LT > HMT) {
                    errors.push({
                        field: 'HMT',
                        message: `HMT (${HMT}) deve essere ‚â• HVT (${HVT}) + LT (${LT}) = ${HVT + LT}`
                    });
                }
            }
            
            // 4. TMV >= LF (Telaio Montante Verticale deve contenere la Luce Foro)
            if (LF > 0 && TMV > 0) {
                if (TMV < LF) {
                    errors.push({
                        field: 'TMV',
                        message: `TMV (${TMV}) deve essere ‚â• LF (${LF})`
                    });
                }
            }
            
            // 5. HMT >= HF (Altezza Montante Telaio deve contenere l'Altezza Foro)
            if (HF > 0 && HMT > 0) {
                if (HMT < HF) {
                    errors.push({
                        field: 'HMT',
                        message: `HMT (${HMT}) deve essere ‚â• HF (${HF})`
                    });
                }
            }
            
            // 6. LVT + ((LT + ARIA + SPESSORE_FALSO)*2) <= TMV
            if (LVT > 0 && LT > 0 && TMV > 0) {
                const calcolato = LVT + ((LT + ARIA + SPESSORE_FALSO) * 2);
                if (calcolato > TMV) {
                    errors.push({
                        field: 'TMV',
                        message: `TMV (${TMV}) deve essere ‚â• LVT (${LVT}) + [(LT (${LT}) + ARIA (${ARIA}) + FALSO (${SPESSORE_FALSO})) √ó 2] = ${calcolato.toFixed(1)}`
                    });
                } else if (calcolato > TMV * 0.95) {
                    warnings.push({
                        field: 'TMV',
                        message: `TMV vicino al limite: calcolato ${calcolato.toFixed(1)} / max ${TMV}`
                    });
                }
            }
            
            // Warnings per valori sospetti
            if (LF > 0 && LF < 300) {
                warnings.push({
                    field: 'LF',
                    message: 'LF molto piccolo (< 300mm)'
                });
            }
            if (LF > 3000) {
                warnings.push({
                    field: 'LF',
                    message: 'LF molto grande (> 3000mm)'
                });
            }
            if (HF > 0 && HF < 300) {
                warnings.push({
                    field: 'HF',
                    message: 'HF molto piccolo (< 300mm)'
                });
            }
            if (HF > 3000) {
                warnings.push({
                    field: 'HF',
                    message: 'HF molto grande (> 3000mm)'
                });
            }
            
            // üõ°Ô∏è Filtra gli errori che hanno un override manuale confermato
            const filteredErrors = errors.filter(error => {
                return !(pos.validationOverrides && pos.validationOverrides[error.field]);
            });
            
            return { 
                errors: filteredErrors, 
                warnings, 
                isValid: filteredErrors.length === 0 
            };
        }

        function getFieldValidationClass(project, pos, fieldName) {
            // üõ°Ô∏è Controlla se c'√® un override manuale per questo campo
            if (pos.validationOverrides && pos.validationOverrides[fieldName]) {
                return 'input-overridden'; // Verde con badge confermato
            }
            
            const validation = validateMisure(project, pos);
            
            const hasError = validation.errors.some(e => e.field === fieldName);
            const hasWarning = validation.warnings.some(w => w.field === fieldName);
            
            const misure = pos.misure || {};
            const value = parseFloat(misure[fieldName]) || 0;
            
            if (hasError) return 'input-error';
            if (hasWarning) return 'input-warning';
            if (value > 0) return 'input-valid';
            
            return '';
        }

        function getFieldValidationMessage(project, pos, fieldName) {
            // üõ°Ô∏è Se c'√® un override manuale, mostra il badge CONFERMATO
            if (pos.validationOverrides && pos.validationOverrides[fieldName]) {
                return `
                    <div class="validation-message success">
                        ‚úÖ CONFERMATO (manuale)
                        <button 
                            class="btn-override-cancel" 
                            onclick="cancelValidationOverride('${project.id}', '${pos.id}', '${fieldName}')"
                            title="Annulla conferma manuale">
                            ‚úï Annulla
                        </button>
                    </div>
                `;
            }
            
            const validation = validateMisure(project, pos);
            
            const error = validation.errors.find(e => e.field === fieldName);
            if (error) {
                return `
                    <div class="validation-message error">
                        üî¥ ${error.message}
                        <button 
                            class="btn-override-confirm" 
                            onclick="confirmValidationOverride('${project.id}', '${pos.id}', '${fieldName}')"
                            title="Ho verificato, la misura √® corretta">
                            ‚úì Conferma OK
                        </button>
                    </div>
                `;
            }
            
            const warning = validation.warnings.find(w => w.field === fieldName);
            if (warning) {
                return `<div class="validation-message warning">üü° ${warning.message}</div>`;
            }
            
            const misure = pos.misure || {};
            const value = parseFloat(misure[fieldName]) || 0;
            if (value > 0) {
                return `<div class="validation-message success">‚úÖ OK</div>`;
            }
            
            return '';
        }

        // üõ°Ô∏è OVERRIDE VALIDAZIONE MANUALE - Conferma che una misura √® corretta
        function confirmValidationOverride(projectId, posId, fieldName) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project || !project.positions) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos) return;
            
            // Inizializza l'oggetto validationOverrides se non esiste
            if (!pos.validationOverrides) {
                pos.validationOverrides = {};
            }
            
            // Salva la conferma per questo campo
            pos.validationOverrides[fieldName] = {
                confirmed: true,
                timestamp: new Date().toISOString(),
                value: pos.misure ? pos.misure[fieldName] : null
            };
            
            saveState();
            render();
        }

        // üõ°Ô∏è OVERRIDE VALIDAZIONE MANUALE - Annulla la conferma manuale
        function cancelValidationOverride(projectId, posId, fieldName) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project || !project.positions) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos) return;
            
            // Rimuovi l'override per questo campo
            if (pos.validationOverrides && pos.validationOverrides[fieldName]) {
                delete pos.validationOverrides[fieldName];
                
                // Se non ci sono pi√π override, rimuovi l'oggetto intero
                if (Object.keys(pos.validationOverrides).length === 0) {
                    delete pos.validationOverrides;
                }
            }
            
            saveState();
            render();
        }

        // üìã RILIEVO PREESISTENTE - Gestione e Validazione
        function updateRilievo(projectId, posId, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (project && project.positions) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.rilievo) {
                        pos.rilievo = {
                            togliere: false,
                            smaltimento: false,
                            materiale: '',
                            coprifiliInt: false,
                            coprifiliEst: false,
                            note: ''
                        };
                    }
                    
                    // Gestione checkbox (boolean)
                    if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                        pos.rilievo[field] = value === true || value === 'true';
                    } else {
                        pos.rilievo[field] = value;
                    }
                    
                    saveState();
                    render();
                }
            }
        }

        // üÜï CALCOLA COMPLETEZZA PER SINGOLO PRODOTTO
        function calculateRilievoCompletenessForProduct(pos, productType) {
            const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const rilievo = pos[rilievoKey];
            
            if (!rilievo) return { percentage: 0, completed: 0, total: productType === 'infissi' ? 5 : 3 };
            
            let completed = 0;
            const hasCoprifili = productType === 'infissi';
            const total = hasCoprifili ? 5 : 3; // infissi: 5 campi | altri: 3 campi
            
            // Conta i campi compilati
            if (rilievo.materiale && rilievo.materiale.trim() !== '') completed++;
            if (rilievo.togliere !== undefined && rilievo.togliere !== null) completed++;
            if (rilievo.smaltimento !== undefined && rilievo.smaltimento !== null) completed++;
            
            if (hasCoprifili) {
                if (rilievo.coprifiliInt !== undefined && rilievo.coprifiliInt !== null) completed++;
                if (rilievo.coprifiliEst !== undefined && rilievo.coprifiliEst !== null) completed++;
            }
            
            const percentage = Math.round((completed / total) * 100);
            return { percentage, completed, total };
        }

        function getRilievoStatusForProduct(pos, productType) {
            const completeness = calculateRilievoCompletenessForProduct(pos, productType);
            
            if (completeness.percentage === 0) {
                return { icon: '‚ö™', color: 'gray', text: 'NON INIZIATO', badge: 'bg-gray-500' };
            } else if (completeness.percentage < 50) {
                return { icon: 'üî¥', color: 'red', text: 'INCOMPLETO', badge: 'bg-red-500' };
            } else if (completeness.percentage < 100) {
                return { icon: 'üü°', color: 'amber', text: 'PARZIALE', badge: 'bg-amber-500' };
            } else {
                return { icon: 'üü¢', color: 'green', text: 'COMPLETO', badge: 'bg-green-500' };
            }
        }
        
        // üÜï CALCOLA COMPLETEZZA MEDIA DI UNA POSIZIONE (tutti i prodotti)
        function calculateRilievoCompleteness(pos) {
            // Questa funzione mantiene il nome originale per retrocompatibilit√†
            // Calcola la media di completezza di tutti i prodotti nella posizione
            const project = state.projects.find(p => p.positions?.some(position => position.id === pos.id));
            if (!project) return { percentage: 0, completed: 0, total: 0 };
            
            const prodotti = ['infissi', 'persiane', 'tapparelle', 'zanzariere', 'cassonetti'];
            const prodottiAttivi = prodotti.filter(p => project.prodotti?.[p]);
            
            if (prodottiAttivi.length === 0) return { percentage: 0, completed: 0, total: 0 };
            
            let totalPercentage = 0;
            let totalCompleted = 0;
            let totalFields = 0;
            
            prodottiAttivi.forEach(productType => {
                const comp = calculateRilievoCompletenessForProduct(pos, productType);
                totalPercentage += comp.percentage;
                totalCompleted += comp.completed;
                totalFields += comp.total;
            });
            
            const avgPercentage = Math.round(totalPercentage / prodottiAttivi.length);
            return { percentage: avgPercentage, completed: totalCompleted, total: totalFields };
        }

        function getRilievoStatus(pos) {
            const completeness = calculateRilievoCompleteness(pos);
            
            if (completeness.percentage === 0) {
                return { icon: '‚ö™', color: 'gray', text: 'NON INIZIATO', badge: 'bg-gray-500' };
            } else if (completeness.percentage < 50) {
                return { icon: 'üî¥', color: 'red', text: 'INCOMPLETO', badge: 'bg-red-500' };
            } else if (completeness.percentage < 100) {
                return { icon: 'üü°', color: 'amber', text: 'PARZIALE', badge: 'bg-amber-500' };
            } else {
                return { icon: 'üü¢', color: 'green', text: 'COMPLETO', badge: 'bg-green-500' };
            }
        }

        // üÜï FASE 013 (28 OTT 2025) - Calcolo completamento posizione base
        // Controlla: nome, ambiente, prodotti enabled, misure compilate
        // ‚úÖ Foto NON necessarie | ‚úÖ Prodotti OBBLIGATORI | ‚úÖ Misure anche "0" valide
        // üÜï FASE 014 - Calcolo completamento basato su TUTTI i prodotti del progetto
        function calculatePositionCompleteness(pos, project) {
            let score = 0;
            const missing = [];
            
            // ========================================
            // STEP 1: AMBIENTE (33 punti)
            // ========================================
            let step1Score = 0;
            
            // Nome posizione (16.5 punti)
            if (pos.name && pos.name.trim() !== '') {
                step1Score += 16.5;
            } else {
                missing.push('Nome posizione');
            }
            
            // Ambiente (16.5 punti)
            if (pos.ambiente && pos.ambiente.trim() !== '') {
                step1Score += 16.5;
            } else {
                missing.push('Ambiente');
            }
            
            score += Math.round(step1Score);
            
            // ========================================
            // STEP 2: PRODOTTI (33 punti)
            // ========================================
            const mapProdotti = {
                'infissi': 'infisso',
                'persiane': 'persiana', 
                'tapparelle': 'tapparella',
                'zanzariere': 'zanzariera',
                'cassonetti': 'cassonetto'
            };
            
            // Ottieni prodotti abilitati nel progetto
            const prodottiProgetto = [];
            if (project?.prodotti) {
                Object.keys(project.prodotti).forEach(tipo => {
                    if (project.prodotti[tipo] === true) {
                        prodottiProgetto.push(mapProdotti[tipo]);
                    }
                });
            }
            
            // Se non ci sono prodotti configurati nel progetto,
            // verifica se la posizione ha almeno UN prodotto presente
            if (prodottiProgetto.length === 0) {
                // Controlla se ci sono prodotti direttamente nella posizione
                const hasPosProducts = 
                    (pos.infisso && Object.keys(pos.infisso).length > 0) ||
                    (pos.persiana && Object.keys(pos.persiana).length > 0) ||
                    (pos.tapparella && Object.keys(pos.tapparella).length > 0) ||
                    (pos.zanzariera && Object.keys(pos.zanzariera).length > 0) ||
                    (pos.cassonetto && Object.keys(pos.cassonetto).length > 0);
                
                if (hasPosProducts) {
                    // Posizione ha prodotti anche senza configurazione progetto
                    // Assegna punti prodotti (33 punti)
                    score += 33;
                } else {
                    // Nessun prodotto n√© nel progetto n√© nella posizione
                    missing.push('Nessun prodotto configurato nel progetto');
                    return {
                        percentage: score,
                        isComplete: false,
                        missing: missing,
                        enabledProducts: 0
                    };
                }
            }
            
            // Verifica TUTTI i prodotti del progetto
            const prodottiPresenti = [];
            const prodottiAssenti = pos.prodottiAssenti || [];
            const prodottiMancanti = [];
            
            prodottiProgetto.forEach(tipo => {
                const hasProdotto = pos[tipo] && typeof pos[tipo] === 'object';
                const qta = hasProdotto ? (parseInt(pos[tipo].qta) || 0) : 0;
                const isDichiaratoAssente = prodottiAssenti.includes(tipo);
                
                if (hasProdotto && qta > 0) {
                    // Prodotto presente con quantit√† > 0
                    prodottiPresenti.push(tipo);
                } else if (isDichiaratoAssente || qta === 0) {
                    // OK: dichiarato come non presente in questa posizione
                } else {
                    // MANCANTE: n√© presente con qta>0 n√© dichiarato assente
                    prodottiMancanti.push(tipo);
                }
            });
            
            // Calcola punteggio prodotti
            const prodottiOk = prodottiPresenti.length + prodottiAssenti.length;
            const percentualeProdotti = prodottiProgetto.length > 0 ? (prodottiOk / prodottiProgetto.length) : 0;
            score += Math.round(33 * percentualeProdotti);
            
            if (prodottiMancanti.length > 0) {
                missing.push(`Prodotti mancanti (${prodottiOk}/${prodottiProgetto.length}): ${prodottiMancanti.join(', ')}`);
            }
            
            // ========================================
            // STEP 3: MISURE POSIZIONE (34 punti)
            // ========================================
            const misurePosizione = ['LVT', 'HVT', 'LF', 'HF', 'TMV', 'HMT', 'L4', 'H4'];
            let misureCompilate = 0;
            
            misurePosizione.forEach(field => {
                const val = pos.misure?.[field];
                // Valore valido: NON vuoto E NON zero
                if (val !== undefined && val !== null && val !== '' && parseFloat(val) !== 0) {
                    misureCompilate++;
                }
            });
            
            if (misureCompilate >= 4) {
                // 4 o pi√π misure = OK completo
                score += 34;
            } else if (misureCompilate >= 2) {
                // 2-3 misure = parziale
                score += 17;
                missing.push(`Misure posizione parziali (${misureCompilate}/8) - Inserisci almeno 4 misure per completare`);
            } else {
                // Meno di 2 misure = mancanti
                missing.push(`Misure posizione mancanti (${misureCompilate}/8 compilate, minimo 2)`);
            }
            
            return {
                percentage: Math.min(score, 100),
                isComplete: score >= 100,
                missing: missing,
                enabledProducts: prodottiProgetto.length,
                prodottiPresenti: prodottiPresenti.length,
                prodottiAssenti: prodottiAssenti.length,
                misureCompilate: misureCompilate
            };
        }

        // üÜï FASE 014 - Toggle prodotto assente/presente in posizione
        function toggleProdottoAssente(projectId, posId, productType) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (!project || !pos) return;
            
            // Inizializza array se non esiste
            if (!pos.prodottiAssenti) {
                pos.prodottiAssenti = [];
            }
            
            const mapProdotti = {
                'infissi': 'infisso',
                'persiane': 'persiana',
                'tapparelle': 'tapparella',
                'zanzariere': 'zanzariera',
                'cassonetti': 'cassonetto'
            };
            
            const prodottoSingolare = mapProdotti[productType];
            const index = pos.prodottiAssenti.indexOf(prodottoSingolare);
            
            if (index > -1) {
                // Era assente, rimuovi (ora deve essere presente)
                pos.prodottiAssenti.splice(index, 1);
            } else {
                // Era presente (o non dichiarato), marca come assente
                pos.prodottiAssenti.push(prodottoSingolare);
                
                // Se c'era il prodotto fisico, rimuovilo
                if (pos[prodottoSingolare]) {
                    delete pos[prodottoSingolare];
                }
            }
            
            saveState();
            render();
        }

        // üÜï Toggle flag misure parziali OK
        function toggleMisureParziali(projectId, posId, checked) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (!project || !pos) return;
            
            pos.misureParziali = checked;
            
            saveState();
            render();
        }

        // üÜï FASE 013 - Helper per status badge completamento posizione
        // üîß FASE 014 - Aggiunto parametro project
        function getPositionCompletenessStatus(pos, project) {
            const comp = calculatePositionCompleteness(pos, project);
            
            if (comp.percentage === 100) {
                return { 
                    icon: 'üü¢', 
                    color: 'green', 
                    text: '100% ‚úÖ', 
                    badge: 'bg-green-500',
                    comp: comp 
                };
            } else if (comp.percentage >= 70) {
                return { 
                    icon: 'üü°', 
                    color: 'amber', 
                    text: `${comp.percentage}% ‚ö†Ô∏è`, 
                    badge: 'bg-amber-500',
                    comp: comp 
                };
            } else if (comp.percentage > 0) {
                return { 
                    icon: 'üü†', 
                    color: 'orange', 
                    text: `${comp.percentage}% ‚ö†Ô∏è`, 
                    badge: 'bg-orange-500',
                    comp: comp 
                };
            } else {
                return { 
                    icon: 'üî¥', 
                    color: 'red', 
                    text: '0% ‚ùå', 
                    badge: 'bg-red-500',
                    comp: comp 
                };
            }
        }

        // üÜï FASE 13 - Gestione Rilievo Globale per Prodotti
        // üÜï FASE 014 - Sincronizzazione Intelligente Globale ‚Üí Posizioni
        function updateRilievoGlobale(projectId, productType, field, value) {
            console.log('üîµ updateRilievoGlobale CHIAMATA:', {projectId, productType, field, value});
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                console.log('üîµ rilievoKey:', rilievoKey);
                console.log('üîµ project[rilievoKey] ESISTE?:', !!project[rilievoKey], 'VALORE:', project[rilievoKey]);
                
                if (!project[rilievoKey]) {
                    project[rilievoKey] = {
                        materiale: '',
                        note: '',
                        togliere: false,
                        smaltimento: false
                    };
                    
                    // Aggiungi coprifili solo per infissi
                    if (productType === 'infissi') {
                        project[rilievoKey].coprifiliInt = false;
                        project[rilievoKey].coprifiliEst = false;
                    }
                    
                    // Aggiungi campo tipo per tapparelle
                    if (productType === 'tapparelle') {
                        project[rilievoKey].tipo = '';
                    }
                    
                    console.log('üÜï Creato nuovo rilievoKey:', project[rilievoKey]);
                }
                
                // üîç FASE 014 - Salva valore precedente per sync intelligente
                const previousValue = project[rilievoKey][field];
                
                // Gestione checkbox (boolean)
                if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                    project[rilievoKey][field] = value === true || value === 'true';
                } else {
                    project[rilievoKey][field] = value;
                }
                
                console.log(`‚úèÔ∏è APPENA ASSEGNATO ${field} = ${value}`);
                console.log(`   project[${rilievoKey}]:`, project[rilievoKey]);
                console.log(`   Tipo:`, Array.isArray(project[rilievoKey]) ? 'ARRAY ‚ùå' : 'OGGETTO ‚úÖ');
                
                // üîÑ FASE 014 - Sincronizzazione Intelligente alle posizioni
                // Aggiorna SOLO posizioni che hanno ancora il valore precedente del globale
                // (= non sono state personalizzate)
                if (project.positions && project.positions.length > 0) {
                    let syncCount = 0;
                    let createdCount = 0;
                    
                    project.positions.forEach(pos => {
                        // üÜï FIX: Se la posizione NON ha questo tipo di rilievo, CREALO con valori globali
                        if (!pos[rilievoKey]) {
                            pos[rilievoKey] = {
                                materiale: project[rilievoKey].materiale || '',
                                note: project[rilievoKey].note || '',
                                togliere: project[rilievoKey].togliere || false,
                                smaltimento: project[rilievoKey].smaltimento || false
                            };
                            
                            // Aggiungi coprifili solo per infissi
                            if (productType === 'infissi') {
                                pos[rilievoKey].coprifiliInt = project[rilievoKey].coprifiliInt || false;
                                pos[rilievoKey].coprifiliEst = project[rilievoKey].coprifiliEst || false;
                            }
                            
                            // Aggiungi campo tipo per tapparelle
                            if (productType === 'tapparelle') {
                                pos[rilievoKey].tipo = project[rilievoKey].tipo || '';
                            }
                            
                            createdCount++;
                        } else {
                            // Se il campo esiste, controlla se sincronizzare
                            const posValue = pos[rilievoKey][field];
                            
                            // Se il valore della posizione corrisponde al vecchio valore globale
                            // significa che NON √® stato personalizzato ‚Üí AGGIORNA
                            if (posValue === previousValue) {
                                pos[rilievoKey][field] = project[rilievoKey][field];
                                syncCount++;
                            }
                            // Altrimenti skip: √® una personalizzazione dell'utente
                        }
                    });
                    
                    // Log per debug (opzionale - pu√≤ essere rimosso in produzione)
                    if (createdCount > 0) {
                        console.log(`üÜï INIT: ${createdCount} posizioni inizializzate con valori globali ${productType}`);
                    }
                    if (syncCount > 0) {
                        console.log(`‚úÖ SYNC: ${syncCount} posizioni aggiornate per ${productType}.${field}`);
                    }
                }
                
                console.log('üíæ PRIMA DI SALVARE - project[rilievoKey]:', project[rilievoKey]);
                saveState();
                console.log('‚úÖ saveState() CHIAMATO per updateRilievoGlobale');
                render(); // ‚úÖ Aggiunto render() per aggiornamento immediato interfaccia
            } else {
                console.error('‚ùå PROJECT NON TROVATO in updateRilievoGlobale:', projectId);
            }
        }

        function toggleMaterialeMode(productType, projectId) {
            const selectEl = document.getElementById(`materiale-select-${productType}-${projectId}`);
            const inputEl = document.getElementById(`materiale-input-${productType}-${projectId}`);
            const toggleBtn = document.getElementById(`materiale-toggle-${productType}-${projectId}`);
            
            if (selectEl && inputEl && toggleBtn) {
                if (selectEl.style.display === 'none') {
                    // Passa a SELECT
                    selectEl.style.display = 'block';
                    inputEl.style.display = 'none';
                    toggleBtn.innerHTML = '‚úèÔ∏è Scrivi';
                    // Sincronizza valore
                    const currentValue = inputEl.value;
                    // Se il valore esiste nelle opzioni, selezionalo
                    const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
                    if (optionExists) {
                        selectEl.value = currentValue;
                    } else {
                        selectEl.value = '';
                    }
                } else {
                    // Passa a INPUT
                    selectEl.style.display = 'none';
                    inputEl.style.display = 'block';
                    toggleBtn.innerHTML = 'üìã Tendina';
                    // Sincronizza valore
                    inputEl.value = selectEl.value;
                }
            }
        }

        function toggleMaterialePosMode(posId) {
            const selectEl = document.getElementById(`materiale-pos-select-${posId}`);
            const inputEl = document.getElementById(`materiale-pos-input-${posId}`);
            const toggleBtn = document.getElementById(`materiale-pos-toggle-${posId}`);
            
            if (selectEl && inputEl && toggleBtn) {
                if (selectEl.style.display === 'none') {
                    // Passa a SELECT
                    selectEl.style.display = 'block';
                    inputEl.style.display = 'none';
                    toggleBtn.innerHTML = '‚úèÔ∏è Scrivi';
                    // Sincronizza valore
                    const currentValue = inputEl.value;
                    const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
                    if (optionExists) {
                        selectEl.value = currentValue;
                    } else {
                        selectEl.value = '';
                    }
                } else {
                    // Passa a INPUT
                    selectEl.style.display = 'none';
                    inputEl.style.display = 'block';
                    toggleBtn.innerHTML = 'üìã Tendina';
                    inputEl.value = selectEl.value;
                }
            }
        }

        // üÜï CHAT 011 - Toggle Ambiente (Dropdown ‚Üî Free Text)
        function toggleAmbienteMode(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (!pos) return;
            
            const selectEl = document.getElementById(`ambiente-select-${posId}`);
            const inputEl = document.getElementById(`ambiente-input-${posId}`);
            const toggleBtn = document.getElementById(`ambiente-toggle-${posId}`);
            
            if (selectEl && inputEl && toggleBtn) {
                if (selectEl.style.display === 'none') {
                    // Passa a DROPDOWN
                    selectEl.style.display = 'block';
                    inputEl.style.display = 'none';
                    toggleBtn.innerHTML = '‚úèÔ∏è Scrivi';
                    toggleBtn.title = 'Passa a scrittura libera';
                    // Sincronizza valore: se il valore attuale esiste nel dropdown, selezionalo
                    const currentValue = inputEl.value;
                    const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
                    if (optionExists && currentValue) {
                        selectEl.value = currentValue;
                    } else {
                        selectEl.value = currentValue || ''; // Mantieni valore anche se non in lista
                    }
                    
                    // üÜï Salva stato nella posizione
                    pos.ambienteMode = 'select';
                    saveState();
                } else {
                    // Passa a FREE TEXT
                    selectEl.style.display = 'none';
                    inputEl.style.display = 'block';
                    toggleBtn.innerHTML = 'üìã Tendina';
                    toggleBtn.title = 'Torna alla tendina';
                    // Sincronizza valore: trasferisci dal dropdown all'input
                    inputEl.value = selectEl.value;
                    
                    // üÜï Salva stato nella posizione
                    pos.ambienteMode = 'input';
                    saveState();
                }
            }
        }

        function copiaRilievoDaGlobale(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (project && pos) {
                // Copia dal rilievo globale infissi (default)
                const rilievoGlobale = getRilievoGlobale(project, 'infissi');
                
                // Inizializza pos.rilievo se non esiste
                if (!pos.rilievo) {
                    pos.rilievo = {
                        togliere: false,
                        smaltimento: false,
                        materiale: '',
                        coprifiliInt: false,
                        coprifiliEst: false,
                        note: ''
                    };
                }
                
                // Copia i valori
                pos.rilievo.materiale = rilievoGlobale.materiale || '';
                pos.rilievo.note = rilievoGlobale.note || '';
                pos.rilievo.togliere = rilievoGlobale.togliere || false;
                pos.rilievo.smaltimento = rilievoGlobale.smaltimento || false;
                pos.rilievo.coprifiliInt = rilievoGlobale.coprifiliInt || false;
                pos.rilievo.coprifiliEst = rilievoGlobale.coprifiliEst || false;
                
                saveState();
                render();
                
                alert('‚úÖ Dati copiati dal rilievo globale!');
            }
        }

        function updateRilievoProdotto(projectId, posId, productType, field, value) {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (project && pos) {
                // FIX: Per infissi il campo √® 'rilievo', per altri prodotti √® 'rilievo[Prodotto]'
                const rilievoKey = productType === 'infissi' ? 'rilievo' : `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                
                // üÜï FASE 014 - Inizializza rilievo con valori globali se non esiste
                if (!pos[rilievoKey]) {
                    const rilievoGlobale = getRilievoGlobale(project, productType);
                    
                    pos[rilievoKey] = {
                        materiale: rilievoGlobale.materiale || '',
                        note: rilievoGlobale.note || '',
                        togliere: rilievoGlobale.togliere || false,
                        smaltimento: rilievoGlobale.smaltimento || false
                    };
                    
                    // Aggiungi coprifili solo per infissi
                    if (productType === 'infissi') {
                        pos[rilievoKey].coprifiliInt = rilievoGlobale.coprifiliInt || false;
                        pos[rilievoKey].coprifiliEst = rilievoGlobale.coprifiliEst || false;
                    }
                    
                    // Aggiungi campo tipo per tapparelle
                    if (productType === 'tapparelle') {
                        pos[rilievoKey].tipo = rilievoGlobale.tipo || '';
                    }
                }
                
                // Gestione checkbox (boolean)
                if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                    pos[rilievoKey][field] = value === true || value === 'true';
                } else {
                    pos[rilievoKey][field] = value;
                }
                
                saveState();
                render();
            }
        }

        function copiaRilievoDaGlobaleProdotto(projectId, posId, productType) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (project && pos) {
                const rilievoGlobale = getRilievoGlobale(project, productType);
                // FIX: Per infissi il campo √® 'rilievo', per altri prodotti √® 'rilievo[Prodotto]'
                const rilievoKey = productType === 'infissi' ? 'rilievo' : `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                
                // Inizializza pos.rilievo se non esiste
                if (!pos[rilievoKey]) {
                    pos[rilievoKey] = {
                        materiale: '',
                        note: '',
                        togliere: false,
                        smaltimento: false
                    };
                    
                    if (productType === 'infissi') {
                        pos[rilievoKey].coprifiliInt = false;
                        pos[rilievoKey].coprifiliEst = false;
                    }
                    
                    if (productType === 'tapparelle') {
                        pos[rilievoKey].tipo = '';
                    }
                }
                
                // Copia i valori
                pos[rilievoKey].materiale = rilievoGlobale.materiale || '';
                pos[rilievoKey].note = rilievoGlobale.note || '';
                pos[rilievoKey].togliere = rilievoGlobale.togliere || false;
                pos[rilievoKey].smaltimento = rilievoGlobale.smaltimento || false;
                
                if (productType === 'infissi') {
                    pos[rilievoKey].coprifiliInt = rilievoGlobale.coprifiliInt || false;
                    pos[rilievoKey].coprifiliEst = rilievoGlobale.coprifiliEst || false;
                }
                
                if (productType === 'tapparelle') {
                    pos[rilievoKey].tipo = rilievoGlobale.tipo || '';
                }
                
                saveState();
                render();
                
                alert('‚úÖ Dati copiati dal rilievo globale!');
            }
        }

        function toggleMaterialeProdottoMode(uniqueId) {
            const selectEl = document.getElementById(`materiale-select-${uniqueId}`);
            const inputEl = document.getElementById(`materiale-input-${uniqueId}`);
            const toggleBtn = document.getElementById(`materiale-toggle-${uniqueId}`);
            
            if (selectEl && inputEl && toggleBtn) {
                if (selectEl.style.display === 'none') {
                    // Passa a SELECT
                    selectEl.style.display = 'block';
                    inputEl.style.display = 'none';
                    toggleBtn.innerHTML = '‚úèÔ∏è Scrivi';
                    const currentValue = inputEl.value;
                    const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
                    if (optionExists) {
                        selectEl.value = currentValue;
                    } else {
                        selectEl.value = '';
                    }
                } else {
                    // Passa a INPUT
                    selectEl.style.display = 'none';
                    inputEl.style.display = 'block';
                    toggleBtn.innerHTML = 'üìã Tendina';
                    inputEl.value = selectEl.value;
                }
            }
        }

        function getRilievoGlobale(project, productType) {
            const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            return project[rilievoKey] || {};
        }

        function calculateRilievoGlobaleCompleteness(project, productType) {
            const rilievo = getRilievoGlobale(project, productType);
            let completed = 0;
            let total = 3; // materiale, togliere, smaltimento (campo "preesistente" ELIMINATO in FASE 13a)
            
            // Per infissi ci sono anche i coprifili
            if (productType === 'infissi') {
                total = 5; // + coprifiliInt, coprifiliEst
            }
            
            // Conta i campi compilati (campo "preesistente" ELIMINATO in FASE 13a)
            if (rilievo.materiale && rilievo.materiale.trim() !== '') completed++;
            if (rilievo.togliere !== undefined && rilievo.togliere !== null) completed++;
            if (rilievo.smaltimento !== undefined && rilievo.smaltimento !== null) completed++;
            
            if (productType === 'infissi') {
                if (rilievo.coprifiliInt !== undefined && rilievo.coprifiliInt !== null) completed++;
                if (rilievo.coprifiliEst !== undefined && rilievo.coprifiliEst !== null) completed++;
            }
            
            const percentage = Math.round((completed / total) * 100);
            return { percentage, completed, total };
        }

        // BRM Calculator
        function calculateBRM(project, pos, misure, brmConfig, tipo = null) {
            if (!brmConfig) {
                return { L: null, H: null, C: null, B: null };
            }
            
            // Determina se √® portafinestra in base al tipo
            const isPortafinestra = tipo && (tipo.includes('PF') || tipo.toUpperCase().includes('PF'));
            
            // Funzione helper per calcolare formule composite
            const calcolaMisura = (formula, misure) => {
                if (!formula) return null;
                
                // Rimuovi tutti gli spazi dalla formula
                formula = formula.replace(/\s+/g, '');
                
                // ‚úÖ v4.86 FIX: Rimuovi parentesi dalla formula (es. "(LS+SRSX+SRDX)" ‚Üí "LS+SRSX+SRDX")
                formula = formula.replace(/[()]/g, '');
                
                // Se la formula contiene "+" significa che √® una somma di pi√π misure
                if (formula.includes('+')) {
                    const parti = formula.split('+').map(p => p.trim());
                    let totale = 0;
                    for (const parte of parti) {
                        const valore = parseFloat(misure[parte]);
                        if (!isNaN(valore)) {
                            totale += valore;
                        }
                    }
                    return totale;
                }
                // Altrimenti √® una singola misura
                const valore = parseFloat(misure[formula]);
                return isNaN(valore) ? null : valore;
            };
            
            // Calcola L separatamente - usa _PF se √® portafinestra e disponibile
            let L = null;
            const misuraBaseLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'misuraBaseL_PF' : 'misuraBaseL';
            const operazioneLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'operazioneL_PF' : 'operazioneL';
            const valoreLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'valoreL_PF' : 'valoreL';
            
            if (brmConfig[misuraBaseLKey]) {
                const baseL = calcolaMisura(brmConfig[misuraBaseLKey], misure);
                if (baseL !== null) {
                    const valoreL = parseFloat(brmConfig[valoreLKey]) || 0;
                    
                    // ‚úÖ v4.87: Allargamento DINAMICO per cassonetti
                    // Se √® un cassonetto (ha LS), calcola allargamento basato su ZSX_tipo/ZDX_tipo
                    const isCassonetto = misure.LS !== undefined;
                    
                    if (isCassonetto && brmConfig[operazioneLKey] === '+') {
                        // Allargamento per lato = valoreL / 2 (se valoreL=30 ‚Üí 15mm per lato)
                        const allargamentoPerLato = (parseFloat(brmConfig[valoreLKey]) || 0) / 2;
                        const allargamentoSX = (misure.ZSX_tipo === 'muro') ? 0 : allargamentoPerLato;
                        const allargamentoDX = (misure.ZDX_tipo === 'muro') ? 0 : allargamentoPerLato;
                        const allargamentoTotale = allargamentoSX + allargamentoDX;
                        L = baseL + allargamentoTotale;
                        console.log(`üîß BRM Cassonetto: base=${baseL}, valoreL=${brmConfig[valoreLKey]}‚Üíper lato=${allargamentoPerLato}, ZSX=${misure.ZSX_tipo}(+${allargamentoSX}), ZDX=${misure.ZDX_tipo}(+${allargamentoDX}) ‚Üí L=${L}`);
                    } else if (brmConfig[operazioneLKey] === '+') {
                        L = baseL + valoreL;
                    } else {
                        L = baseL - valoreL;
                    }
                }
            }
            
            // Calcola H separatamente - usa _PF se √® portafinestra e disponibile
            let H = null;
            const misuraBaseHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'misuraBaseH_PF' : 'misuraBaseH';
            const operazioneHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'operazioneH_PF' : 'operazioneH';
            const valoreHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'valoreH_PF' : 'valoreH';
            
            if (brmConfig[misuraBaseHKey]) {
                const baseH = calcolaMisura(brmConfig[misuraBaseHKey], misure);
                if (baseH !== null) {
                    const valoreH = parseFloat(brmConfig[valoreHKey]) || 0;
                    if (brmConfig[operazioneHKey] === '+') {
                        H = baseH + valoreH;
                    } else {
                        H = baseH - valoreH;
                    }
                }
            }
            
            // Calcola C separatamente (per cassonetti)
            let C = null;
            if (brmConfig.misuraBaseC) {
                const baseC = calcolaMisura(brmConfig.misuraBaseC, misure);
                if (baseC !== null) {
                    const valoreC = parseFloat(brmConfig.valoreC) || 0;
                    if (brmConfig.operazioneC === '+') {
                        C = baseC + valoreC;
                    } else {
                        C = baseC - valoreC;
                    }
                }
            }
            
            // Calcola B separatamente (per cassonetti)
            let B = null;
            if (brmConfig.misuraBaseB) {
                const baseB = calcolaMisura(brmConfig.misuraBaseB, misure);
                if (baseB !== null) {
                    const valoreB = parseFloat(brmConfig.valoreB) || 0;
                    if (brmConfig.operazioneB === '+') {
                        B = baseB + valoreB;
                    } else {
                        B = baseB - valoreB;
                    }
                }
            }
            
            return { L, H, C, B };
        }

        // Project Management
        function createProject(name, client) {
            // üîß v4.57: Genera ID e verifica validit√†
            let newId = generateId();
            
            // üö® VALIDAZIONE CRITICA: ID deve essere valido
            if (!newId || newId === '#UNKNOWN' || newId === 'undefined' || newId.trim() === '') {
                console.error('‚ùå ERRORE CRITICO: generateId() ha ritornato ID non valido:', newId);
                // Fallback: genera ID con timestamp
                const fallbackId = `${new Date().getFullYear()}P${Date.now().toString().slice(-3)}`;
                console.warn('‚ö†Ô∏è Uso ID fallback:', fallbackId);
                newId = fallbackId;
            }
            
            console.log('‚úÖ Nuovo progetto creato con ID:', newId);
            
            const project = {
                id: newId,  // üÜï v4.20: USA formato ANNOP001 (2025P001) + v4.57: validato
                name,
                client,
                clientData: {},
                prodotti: {},
                caratteristicheMuro: {},
                configInfissi: {},
                configPersiane: {},
                configCassonetti: {
                    tipo: '',
                    azienda: '',
                    materiale: '',
                    finitura: '',
                    coibentazione: '',
                    aSoffitto: ''
                },
                configTapparelle: {},
                configZanzariere: {
                    azienda: '',
                    modelloPF: '',
                    modelloF: '',
                    colore: ''
                },
                // üÜï FIX: Inizializza esplicitamente TUTTI i rilievi globali come OGGETTI
                rilievoInfissi: {
                    materiale: '',
                    note: '',
                    togliere: false,
                    smaltimento: false,
                    coprifiliInt: false,
                    coprifiliEst: false
                },
                rilievoPersiane: {
                    materiale: '',
                    note: '',
                    togliere: false,
                    smaltimento: false
                },
                rilievoTapparelle: {
                    materiale: '',
                    note: '',
                    togliere: false,
                    smaltimento: false
                },
                rilievoZanzariere: {
                    materiale: '',
                    note: '',
                    togliere: false,
                    smaltimento: false
                },
                rilievoCassonetti: {
                    materiale: '',
                    note: '',
                    togliere: false,
                    smaltimento: false
                },
                brmConfigInfissi: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigPersiane: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigTapparelle: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigZanzariere: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigCassonetti: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    misuraBaseC: '', operazioneC: '-', valoreC: '0',
                    misuraBaseB: '', operazioneB: '-', valoreB: '0',
                    note: '',
                    SRSX: '0',
                    SRDX: '0',
                    ZSX: '0',
                    ZDX: '0'
                },
                positions: [],
                createdAt: new Date().toISOString(),
                // ‚úÖ SOLUZIONE C: Metadata per tracking e sincronizzazione
                metadata: initMetadata()
            };
            state.projects.push(project);
            state.currentProject = project.id;
            state.setupStep = 1;
            saveState();
            return project;
        }

        async function deleteProject(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Chiedi conferma con il nome del progetto
            const confirmMessage = `Sei sicuro di voler eliminare il progetto "${project.name}" (Cliente: ${project.client})?\n\nQuesta azione √® IRREVERSIBILE e canceller√†:\n- Tutte le ${project.positions.length} posizioni\n- Tutti i dati e le configurazioni\n- Tutte le foto associate\n\n${state.github?.connected ? '‚ö†Ô∏è Il progetto verr√† eliminato anche da GitHub' : ''}`;
            
            if (!confirm(confirmMessage)) {
                return; // Annullato dall'utente
            }
            
            // üÜï v4.61: CANCELLA DA GITHUB PRIMA di eliminare locale
            let githubDeleted = false;
            if (state.github?.connected && GITHUB_CONFIG.token) {
                try {
                    console.log(`üóëÔ∏è Cancellazione progetto ${projectId} da GitHub...`);
                    
                    const fileName = `progetto-${projectId}.json`;
                    const filePath = `${GITHUB_CONFIG.projectsPath}/${fileName}`;
                    
                    // Ottieni SHA del file per cancellazione
                    const checkUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                    const checkResponse = await fetch(checkUrl, {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const fileData = await checkResponse.json();
                        const sha = fileData.sha;
                        
                        // Cancella file da GitHub
                        const deleteUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                        const deleteResponse = await fetch(deleteUrl, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `token ${GITHUB_CONFIG.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `Delete ${fileName}`,
                                sha: sha,
                                branch: GITHUB_CONFIG.branch
                            })
                        });
                        
                        if (deleteResponse.ok) {
                            console.log(`‚úÖ Progetto ${projectId} cancellato da GitHub`);
                            githubDeleted = true;
                        } else {
                            console.error(`‚ùå Errore cancellazione GitHub:`, deleteResponse.status);
                        }
                    } else if (checkResponse.status === 404) {
                        console.log(`‚ÑπÔ∏è Progetto ${projectId} non presente su GitHub`);
                        githubDeleted = true; // Non esiste, quindi OK
                    }
                } catch (error) {
                    console.error('‚ùå Errore cancellazione GitHub:', error);
                    // Continua comunque con cancellazione locale
                }
            }
            
            // Rimuovi il progetto dall'array locale
            const index = state.projects.findIndex(p => p.id === projectId);
            if (index !== -1) {
                state.projects.splice(index, 1);
                
                // Se era il progetto corrente, resetta
                if (state.currentProject === projectId) {
                    state.currentProject = null;
                    state.screen = 'list';
                }
                
                saveState();
                
                // Notifica risultato
                if (githubDeleted) {
                    showNotification('üóëÔ∏è Progetto eliminato (locale + GitHub)', 'success');
                } else if (state.github?.connected) {
                    showNotification('‚ö†Ô∏è Progetto eliminato localmente (errore GitHub)', 'warning');
                } else {
                    showNotification('üóëÔ∏è Progetto eliminato localmente', 'success');
                }
                
                render();
            }
        }

        function addPosition(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                // üÜï FASE 014 - Copia valori globali per nuova posizione
                const rilievoGlobaleInfissi = getRilievoGlobale(project, 'infissi');
                
                // üîß FIX: Trova il primo numero libero (senza buchi)
                const usedNumbers = new Set();
                project.positions.forEach(p => {
                    const match = p.name.match(/Pos\.\s*(\d+)/);
                    if (match) {
                        usedNumbers.add(parseInt(match[1]));
                    }
                });
                
                // Trova il primo numero libero partendo da 1
                let newNum = 1;
                while (usedNumbers.has(newNum)) {
                    newNum++;
                }
                
                const pos = {
                    id: generateSequentialPositionId(projectId, project.positions),
                    name: `Pos. ${newNum}`,
                    piano: project.clientData?.piano || '',
                    ambiente: '',
                    ambienteMode: 'select',  // üÜï Traccia modalit√† input: 'select' o 'input'
                    quantita: '1',
                    misure: {},
                    // üìã AUTO-SYNC: Inizializza TUTTI i rilievi con valori globali
                    rilievo: {
                        togliere: rilievoGlobaleInfissi.togliere || false,
                        smaltimento: rilievoGlobaleInfissi.smaltimento || false,
                        materiale: rilievoGlobaleInfissi.materiale || '',
                        coprifiliInt: rilievoGlobaleInfissi.coprifiliInt || false,
                        coprifiliEst: rilievoGlobaleInfissi.coprifiliEst || false,
                        note: rilievoGlobaleInfissi.note || ''
                    },
                    // üÜï AUTO-SYNC: Inizializza anche rilievi altri prodotti
                    rilievoPersiane: {
                        togliere: project.rilievoPersiane?.togliere || false,
                        smaltimento: project.rilievoPersiane?.smaltimento || false,
                        materiale: project.rilievoPersiane?.materiale || '',
                        note: project.rilievoPersiane?.note || ''
                    },
                    rilievoTapparelle: {
                        togliere: project.rilievoTapparelle?.togliere || false,
                        smaltimento: project.rilievoTapparelle?.smaltimento || false,
                        materiale: project.rilievoTapparelle?.materiale || '',
                        note: project.rilievoTapparelle?.note || ''
                    },
                    rilievoZanzariere: {
                        togliere: project.rilievoZanzariere?.togliere || false,
                        smaltimento: project.rilievoZanzariere?.smaltimento || false,
                        materiale: project.rilievoZanzariere?.materiale || '',
                        note: project.rilievoZanzariere?.note || ''
                    },
                    rilievoCassonetti: {
                        togliere: project.rilievoCassonetti?.togliere || false,
                        smaltimento: project.rilievoCassonetti?.smaltimento || false,
                        materiale: project.rilievoCassonetti?.materiale || '',
                        note: project.rilievoCassonetti?.note || ''
                    },
                    infissi: [],
                    persiane: [],
                    cassonetti: [],
                    tapparelle: [],
                    zanzariere: [],
                    foto: [],
                    note: '',
                    noteVisibilita: []
                };
                project.positions.push(pos);
                
                // ‚ùå NON CREARE PRODOTTI - L'utente deve fare scelta esplicita
                // I prodotti vengono creati solo quando l'utente:
                // 1. Click "+ Aggiungi [Prodotto]" ‚Üí chiama add[Prodotto]()
                // 2. Check "Non presente" ‚Üí aggiunto a pos.prodottiAssenti
                console.log('‚úÖ NUOVA POSIZIONE CREATA - Prodotti NON inizializzati (scelta utente)');




                
                // ‚úÖ SOLUZIONE C: Track modifica
                updateProjectTimestamp(projectId, 'addPosition', `Aggiunta posizione: ${pos.name}`);
                
                // üÜï v4.19: Imposta stato PRIMA di salvare
                state.currentPosition = pos.id;
                state.screen = 'position'; // üÜï Apri subito la posizione
                
                // Salva dopo aver impostato tutto lo stato
                saveState();
                
                showNotification('Posizione aggiunta', 'success');
                render();
            }
        }

        // Product Management Functions
        function addInfisso(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // Verifica se la config √® vuota
                    const configVuota = !project.configInfissi || Object.keys(project.configInfissi).length === 0;
                    const configHaValori = project.configInfissi && (
                        project.configInfissi.azienda ||
                        project.configInfissi.telaio ||
                        project.configInfissi.coloreInt ||
                        // üÜï v4.85: Usa tagliTelaio invece di codTagli (rimosso)
                        project.configInfissi.tagliTelaio
                    );
                    
                    if (configVuota || !configHaValori) {
                        console.warn('‚ö†Ô∏è CONFIG GLOBALE INFISSI VUOTA!');
                        console.log('üí° SUGGERIMENTO: Imposta prima la Config Globale, poi aggiungi le posizioni.');
                        console.log('   Oppure usa il pulsante SINCRONIZZA TUTTO dopo aver configurato.');
                    }
                    
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigInfissi);
                    // UN SOLO INFISSO per posizione
                    pos.infisso = {
                        id: generateId(),
                        qta: '1',
                        azienda: project.configInfissi?.azienda || '',
                        finituraInt: project.configInfissi?.finituraInt || '',
                        finituraEst: project.configInfissi?.finituraEst || '',
                        coloreInt: project.configInfissi?.coloreInt || '',
                        coloreEst: project.configInfissi?.coloreEst || '',
                        tipoAnta: project.configInfissi?.tipoAnta || '',
                        telaio: project.configInfissi?.telaio || '',
                        allarme: project.configInfissi?.allarme || '',
                        vetro: project.configInfissi?.vetro || '',
                        cerniere: project.configInfissi?.cerniere || '',  // üÜï v4.80
                        tagliTelaio: project.configInfissi?.tagliTelaio || '',
                        // üÜï v4.81: codTagli rimosso - generato al volo da tagliTelaio
                        codTagliValues: project.configInfissi?.codTagliValues ? [...project.configInfissi.codTagliValues] : [],
                        maniglia: project.configInfissi?.maniglia || '',
                        coloreManiglia: project.configInfissi?.coloreManiglia || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        note: '',
                        foto: []
                    };
                    
                    // Log per debug DETTAGLIATO
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('‚ûï INFISSO AGGIUNTO - DEBUG COMPLETO');
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('üìä Config Globale Infissi:', project.configInfissi);
                    console.log('üìç Posizione ID:', pos.id);
                    console.log('ü™ü Infisso Creato:', {
                        azienda: pos.infisso.azienda || '‚ùå VUOTO',
                        telaio: pos.infisso.telaio || '‚ùå VUOTO',
                        coloreInt: pos.infisso.coloreInt || '‚ùå VUOTO',
                        coloreEst: pos.infisso.coloreEst || '‚ùå VUOTO',
                        vetro: pos.infisso.vetro || '‚ùå VUOTO',
                        // üÜï v4.85: Corretto - usa codTagliValues invece di codTagli (rimosso in v4.81)
                        codTagliValues: pos.infisso.codTagliValues?.length > 0 ? `‚úÖ ${pos.infisso.codTagliValues.length} valore/i` : '‚ùå VUOTO'
                    });
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    
                    saveState();
                    render();
                }
            }
        }

        function addPersiana(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigPersiane);
                    
                    // UNA SOLA PERSIANA per posizione
                    pos.persiana = {
                        id: generateId(),
                        qta: '1',
                        // üîß FIX 027H: Copia TUTTI i campi da config globale
                        azienda: project.configPersiane?.azienda || '',
                        modello: project.configPersiane?.modello || '',
                        fissaggio: project.configPersiane?.fissaggio || '',
                        // tipoTelaio solo se fissaggio = TELAIO
                        tipoTelaio: (project.configPersiane?.fissaggio === 'TELAIO') 
                                    ? (project.configPersiane?.tipoTelaio || '') 
                                    : '',
                        // coloreTelaio solo se fissaggio = TELAIO
                        coloreTelaio: (project.configPersiane?.fissaggio === 'TELAIO')
                                      ? (project.configPersiane?.coloreTelaio || '')
                                      : '',
                        battuta: project.configPersiane?.battuta || '',
                        // üîß FIX: colorePersiana (sempre)
                        colorePersiana: project.configPersiane?.colorePersiana || '',
                        tipo: project.configPersiane?.tipo || '',
                        materiale: project.configPersiane?.materiale || '',
                        colore: project.configPersiane?.colore || '',
                        apertura: project.configPersiane?.apertura || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        note: '',
                        foto: []
                    };
                    
                    // Log debug DETTAGLIATO PERSIANE
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('‚ûï PERSIANA AGGIUNTA - DEBUG COMPLETO');
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('üìä Config Globale Persiane:', project.configPersiane);
                    console.log('üö™ Persiana Creata:', {
                        azienda: pos.persiana.azienda || '‚ùå VUOTO',
                        modello: pos.persiana.modello || '‚ùå VUOTO',
                        fissaggio: pos.persiana.fissaggio || '‚ùå VUOTO',
                        colorePersiana: pos.persiana.colorePersiana || '‚ùå VUOTO'
                    });
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    
                    saveState();
                    render();
                }
            }
        }

        function addTapparella(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigTapparelle);
                    // UNA SOLA TAPPARELLA per posizione
                    pos.tapparella = {
                        id: generateId(),
                        qta: '1',
                        azienda: project.configTapparelle?.azienda || '',
                        modello: project.configTapparelle?.modello || '',
                        tipo: project.configTapparelle?.tipo || '',
                        materiale: project.configTapparelle?.materiale || '',
                        colore: project.configTapparelle?.colore || '',
                        manualeMot: project.configTapparelle?.tipologia || '',
                        guida: project.configTapparelle?.guida || '',
                        coloreGuida: project.configTapparelle?.coloreGuida || '',
                        comando: project.configTapparelle?.comando || '',
                        motoreAzienda: project.configTapparelle?.motoreAzienda || '',
                        motoreModello: project.configTapparelle?.motoreModello || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        note: '',
                        foto: []
                    };
                    saveState();
                    render();
                }
            }
        }

        function addZanzariera(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // Determina il tipo in base all'infisso presente nella posizione
                    const tipoInfisso = pos.infisso?.tipo || '';
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigZanzariere, tipoInfisso);
                    // UNA SOLA ZANZARIERA per posizione
                    pos.zanzariera = {
                        id: generateId(),
                        qta: '1',
                        azienda: project.configZanzariere?.azienda || '',
                        tipo: project.configZanzariere?.tipo || '',
                        coloreTelaio: project.configZanzariere?.coloreTelaio || '',
                        tipoRete: project.configZanzariere?.tipoRete || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        note: '',
                        foto: []
                    };
                    saveState();
                    render();
                }
            }
        }

        function addCassonetto(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // Prendi caratteristiche muro (override o globali)
                    const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                        ? pos.caratteristicheMuroOverride 
                        : project.caratteristicheMuro || {};
                    
                    // üîß BSuperiore: Pre-compila con Battuta Superiore con Tapparella
                    const bSuperioreDefault = cm.battutaSuperioreTapparella || '0';
                    
                    // UN SOLO CASSONETTO per posizione
                    pos.cassonetto = {
                        id: generateId(),
                        qta: '1',
                        azienda: project.configCassonetti?.azienda || '',
                        tipo: project.configCassonetti?.tipo || '',
                        materiale: project.configCassonetti?.materiale || '',
                        finitura: project.configCassonetti?.finitura || '',
                        coibentazione: project.configCassonetti?.coibentazione || '',
                        // Inizializza le misure a 0
                        LS: '0',
                        SRSX: '0',
                        ZSX: '0',
                        SRDX: '0',
                        ZDX: '0',
                        HCASS: '0',
                        B: '0',
                        C: '0',
                        BSuperiore: bSuperioreDefault, // ‚úÖ Pre-compilato con battutaSuperioreTapparella
                        BRM_L: null,
                        BRM_H: null,
                        BRM_C: null,
                        BRM_B: null,
                        note: '',
                        foto: []
                    };
                    
                    // Calcola BRM iniziale (sar√† 0 perch√© le misure sono 0)
                    const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
                    pos.cassonetto.BRM_L = brm.L;
                    pos.cassonetto.BRM_H = brm.H;
                    pos.cassonetto.BRM_C = brm.C;
                    pos.cassonetto.BRM_B = brm.B;
                    
                    saveState();
                    render();
                }
            }
        }

        function deleteProduct(projectId, posId, productType) {
            if (confirm('Sei sicuro di voler eliminare questo elemento?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos[productType]) {
                        // Elimina il singolo prodotto
                        delete pos[productType];
                        saveState();
                        render();
                    }
                }
            }
        }

        // üîÑ NUOVA FUNZIONE: Ricarica infisso da configurazione globale
        function ricaricaInfissoDaGlobali(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos || !pos.infisso) return;
            
            // Conferma azione
            if (!confirm('Ricaricare la configurazione dalle Impostazioni Globali? I dati attuali verranno sovrascritti (tranne BRM e note).')) {
                return;
            }
            
            // Salva BRM e note (non vanno sovrascritti)
            const savedBRM_L = pos.infisso.BRM_L;
            const savedBRM_H = pos.infisso.BRM_H;
            const savedNote = pos.infisso.note || '';
            const savedFoto = pos.infisso.foto || [];
            const savedQta = pos.infisso.qta || '1';
            const savedId = pos.infisso.id;
            
            // Ricarica TUTTO da config globale
            pos.infisso = {
                id: savedId,
                qta: savedQta,
                azienda: project.configInfissi?.azienda || '',
                finituraInt: project.configInfissi?.finituraInt || '',
                finituraEst: project.configInfissi?.finituraEst || '',
                coloreInt: project.configInfissi?.coloreInt || '',
                coloreEst: project.configInfissi?.coloreEst || '',
                tipoAnta: project.configInfissi?.tipoAnta || '',
                telaio: project.configInfissi?.telaio || '',
                allarme: project.configInfissi?.allarme || '',
                vetro: project.configInfissi?.vetro || '',
                cerniere: project.configInfissi?.cerniere || '',  // üÜï v4.80
                tagliTelaio: project.configInfissi?.tagliTelaio || '',
                // üÜï v4.81: codTagli rimosso - generato al volo da tagliTelaio
                codTagliValues: project.configInfissi?.codTagliValues ? [...project.configInfissi.codTagliValues] : [],
                maniglia: project.configInfissi?.maniglia || '',
                coloreManiglia: project.configInfissi?.coloreManiglia || '',
                BRM_L: savedBRM_L, // Mantieni BRM
                BRM_H: savedBRM_H,
                note: savedNote, // Mantieni note
                foto: savedFoto  // Mantieni foto
            };
            
            console.log('üîÑ INFISSO RICARICATO DA GLOBALI:', {
                posId,
                azienda: pos.infisso.azienda,
                telaio: pos.infisso.telaio,
                coloreInt: pos.infisso.coloreInt
            });
            
            saveState();
            showNotification('‚úÖ Configurazione ricaricata da Globali', 'success');
            render();
        }

        // üîÑ NUOVA FUNZIONE: Ricarica persiana da configurazione globale
        function ricaricaPersianaDaGlobali(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos || !pos.persiana) return;
            
            // Conferma azione
            if (!confirm('Ricaricare la configurazione dalle Impostazioni Globali? I dati attuali verranno sovrascritti (tranne BRM e note).')) {
                return;
            }
            
            // Salva BRM e note
            const savedBRM_L = pos.persiana.BRM_L;
            const savedBRM_H = pos.persiana.BRM_H;
            const savedNote = pos.persiana.note || '';
            const savedFoto = pos.persiana.foto || [];
            const savedQta = pos.persiana.qta || '1';
            const savedId = pos.persiana.id;
            
            // Ricarica TUTTO da config globale
            pos.persiana = {
                id: savedId,
                qta: savedQta,
                azienda: project.configPersiane?.azienda || '',
                modello: project.configPersiane?.modello || '',
                fissaggio: project.configPersiane?.fissaggio || '',
                tipoTelaio: (project.configPersiane?.fissaggio === 'TELAIO') 
                            ? (project.configPersiane?.tipoTelaio || '') 
                            : '',
                coloreTelaio: (project.configPersiane?.fissaggio === 'TELAIO')
                              ? (project.configPersiane?.coloreTelaio || '')
                              : '',
                battuta: project.configPersiane?.battuta || '',
                colorePersiana: project.configPersiane?.colorePersiana || '',
                tipo: project.configPersiane?.tipo || '',
                materiale: project.configPersiane?.materiale || '',
                colore: project.configPersiane?.colore || '',
                apertura: project.configPersiane?.apertura || '',
                BRM_L: savedBRM_L,
                BRM_H: savedBRM_H,
                note: savedNote,
                foto: savedFoto
            };
            
            console.log('üîÑ PERSIANA RICARICATA DA GLOBALI:', {
                posId,
                azienda: pos.persiana.azienda,
                modello: pos.persiana.modello,
                fissaggio: pos.persiana.fissaggio
            });
            
            saveState();
            showNotification('‚úÖ Configurazione ricaricata da Globali', 'success');
            render();
        }

        function updateProduct(projectId, posId, productType, field, value) {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    // üÜï FASE 016: qta=0 √® VALIDO - prodotto rimane visibile e modificabile
                    pos[productType][field] = value;
                    
                    // üÜï v4.78: Se PVC/PVC, sincronizza coloreInt e coloreEst nella posizione
                    if (productType === 'infisso') {
                        const inf = pos.infisso;
                        const isPvcPvc = inf.finituraInt === 'pvc' && inf.finituraEst === 'pvc';
                        
                        if (isPvcPvc) {
                            if (field === 'coloreInt') {
                                inf.coloreEst = value;
                                console.log('üé® v4.78: PVC/PVC posizione ‚Üí coloreEst sincronizzato');
                                // üÜï v4.83: Aggiorna UI immediatamente
                                saveState();
                                render();
                                return; // Evita doppio render
                            } else if (field === 'coloreEst') {
                                inf.coloreInt = value;
                                console.log('üé® v4.78: PVC/PVC posizione ‚Üí coloreInt sincronizzato');
                                // üÜï v4.83: Aggiorna UI immediatamente
                                saveState();
                                render();
                                return; // Evita doppio render
                            }
                        }
                    }
                    
                    // INFISSI: Se cambia tagliTelaio, RESET dei codTagliValues per aggiornamento immediato
                    if (productType === 'infisso' && field === 'tagliTelaio') {
                        // üÜï v4.81: Usa getPosizioniTagli() invece di salvare codTagli
                        const posizioniTagli = getPosizioniTagli(value);
                        
                        // Sincronizza codTagliValues
                        if (project.configInfissi?.codTagliValues?.length === posizioniTagli.length) {
                            pos[productType].codTagliValues = [...project.configInfissi.codTagliValues];
                        } else {
                            pos[productType].codTagliValues = new Array(posizioniTagli.length).fill('');
                        }
                    }
                    
                    // INFISSI: Se cambia il tipo (F1->PF1 etc), ricalcola BRM di infisso E zanzariera
                    if (productType === 'infisso' && field === 'tipo') {
                        const inf = pos.infisso;
                        // Ricalcola BRM infisso
                        if (inf.brmPersonalizzato) {
                            const brm = calculateBRM(project, pos, pos.misure, inf.brmPersonalizzato, value);
                            inf.BRM_L = brm.L;
                            inf.BRM_H = brm.H;
                        } else {
                            const brm = calculateBRM(project, pos, pos.misure, project.brmConfigInfissi, value);
                            inf.BRM_L = brm.L;
                            inf.BRM_H = brm.H;
                        }
                        
                        // Ricalcola anche BRM zanzariera se presente
                        if (pos.zanzariera) {
                            const zan = pos.zanzariera;
                            if (zan.brmPersonalizzato) {
                                const brm = calculateBRM(project, pos, pos.misure, zan.brmPersonalizzato, value);
                                zan.BRM_L = brm.L;
                                zan.BRM_H = brm.H;
                            } else {
                                const brm = calculateBRM(project, pos, pos.misure, project.brmConfigZanzariere, value);
                                zan.BRM_L = brm.L;
                                zan.BRM_H = brm.H;
                            }
                        }
                        
                        // üéØ AUTO-SELEZIONE tipoInfissoAssociato per INFISSO
                        let autoTipo = null;
                        if (value && value.includes('PF')) {
                            // PF1, PF2, PF3 ‚Üí Porta Finestra
                            autoTipo = 'PF';
                        } else if (value && (value.match(/F\d/) || value === 'FISSO' || value === 'HST')) {
                            // F1, F2, F3, FISSO, HST ‚Üí Finestra
                            autoTipo = 'F';
                        }
                        if (autoTipo) {
                            inf.tipoInfissoAssociato = autoTipo;
                            console.log(`‚úÖ Auto-selezionato tipoInfissoAssociato: ${autoTipo} per infisso tipo ${value}`);
                        }
                    }
                    
                    // üéØ PERSIANE: Auto-selezione tipoInfissoAssociato  
                    if (productType === 'persiana' && field === 'tipo') {
                        const per = pos.persiana;
                        let autoTipo = null;
                        if (value && value.includes('PF')) {
                            // PF1, PF2, PF3 ‚Üí Porta Finestra
                            autoTipo = 'PF';
                        } else if (value && value.match(/F[A\d]/)) {
                            // F1, F2, F3 ‚Üí Finestra
                            autoTipo = 'F';
                        }
                        if (autoTipo) {
                            per.tipoInfissoAssociato = autoTipo;
                            console.log(`‚úÖ Auto-selezionato tipoInfissoAssociato: ${autoTipo} per persiana tipo ${value}`);
                        }
                    }
                    
                    // CASSONETTI: Se cambiano le misure, ricalcola il BRM
                    const misureCassonetto = ['LS', 'SRSX', 'ZSX', 'SRDX', 'ZDX', 'HCASS', 'B', 'C', 'BSuperiore'];
                    if (productType === 'cassonetto' && misureCassonetto.includes(field)) {
                        const cas = pos.cassonetto;
                        if (cas.brmPersonalizzato) {
                            // Usa formula personalizzata
                            const brm = calculateBRM(project, pos, cas, cas.brmPersonalizzato);
                            cas.BRM_L = brm.L;
                            cas.BRM_H = brm.H;
                        } else {
                            // Usa formula globale
                            const brm = calculateBRM(project, pos, cas, project.brmConfigCassonetti);
                            cas.BRM_L = brm.L;
                            cas.BRM_H = brm.H;
                        }
                    }
                    
                    saveState();
                    
                    // üîÑ Re-render SOLO se cambiato tipo (infisso/persiana) per aggiornare tipoInfissoAssociato radio
                    if ((productType === 'infisso' || productType === 'persiana') && field === 'tipo') {
                        render();
                    }
                    
                    // üîß v4.44: Re-render se cambiato fissaggio persiane per mostrare/nascondere telai
                    if (productType === 'persiana' && field === 'fissaggio') {
                        render();
                    }
                    
                    // RIMOSSO: render() per evitare reload pagina dopo ogni modifica
                    // I dati sono gi√† salvati, non serve ricaricare la pagina
                    // Solo in casi specifici dove cambia la struttura HTML servirebbe,
                    // ma anche l√¨ √® meglio aggiornare solo la parte necessaria
                }
            }
        }

        // Validazione B-C per cassonetti
        function validateCassonettoBC(projectId, posId) {
            // ‚úÖ v4.86: Aggiorna controllo B-C in tempo reale
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos || !pos.cassonetto) return;
            
            const cas = pos.cassonetto;
            const validationDiv = document.getElementById(`bc-validation-${posId}`);
            if (!validationDiv) return;
            
            // Leggi valori aggiornati dai campi input (non da cas che potrebbe non essere ancora aggiornato)
            const bInput = validationDiv.parentElement.querySelector('input[onchange*="\'B\'"]');
            const cInput = validationDiv.parentElement.querySelector('input[onchange*="\'C\'"]');
            
            const b = bInput ? parseFloat(bInput.value) || 0 : parseFloat(cas.B) || 0;
            const c = cInput ? parseFloat(cInput.value) || 0 : parseFloat(cas.C) || 0;
            const diff = b - c;
            
            // Prendi Prof. Muro Int (override o globale)
            const profMuroInt = pos.caratteristicheMuroOverride?.profMuroInt 
                ? parseFloat(pos.caratteristicheMuroOverride.profMuroInt) 
                : parseFloat(project.caratteristicheMuro?.profMuroInt) || 0;
            
            let html = '';
            
            if (b === 0 || c === 0 || profMuroInt === 0) {
                html = `
                    <div class="mt-3 bg-gray-100 border-l-4 border-gray-400 p-3">
                        <p class="text-sm text-gray-600">
                            ‚ÑπÔ∏è Inserisci B, C e Prof. Muro Int per attivare il controllo
                        </p>
                    </div>
                `;
            } else {
                const differenza = Math.abs(diff - profMuroInt);
                const isValid = differenza <= 10;
                
                if (isValid) {
                    html = `
                        <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-3">
                            <p class="text-sm text-green-800">
                                ‚úÖ <strong>Controllo OK:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm ‚úì
                            </p>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-3">
                            <p class="text-sm text-red-800">
                                ‚ö†Ô∏è <strong>ATTENZIONE:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm (Tolleranza ¬±10mm superata!)
                            </p>
                        </div>
                    `;
                }
            }
            
            validationDiv.innerHTML = html;
        }

        // ‚úÖ v4.87: Gestione radio button ZSX (Spazio Sinistra)
        function updateZSXTipo(projectId, posId, tipo) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos || !pos.cassonetto) return;
            
            pos.cassonetto.ZSX_tipo = tipo;
            
            // Se muro o libero, ZSX non serve (imposta a 0 o valore speciale)
            if (tipo === 'muro') {
                pos.cassonetto.ZSX = '0';
            } else if (tipo === 'libero') {
                pos.cassonetto.ZSX = '999'; // Valore che indica "spazio illimitato"
            }
            // Se limitato, mantieni il valore esistente o aspetta input
            
            // ‚úÖ v4.87: Ricalcola BRM con nuovo allargamento
            if (!pos.cassonetto.brmPersonalizzato && project.brmConfigCassonetti) {
                const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
                pos.cassonetto.BRM_L = brm.L;
                pos.cassonetto.BRM_H = brm.H;
                pos.cassonetto.BRM_C = brm.C;
                pos.cassonetto.BRM_B = brm.B;
            }
            
            saveState();
            render();
        }
        
        // ‚úÖ v4.87: Gestione radio button ZDX (Spazio Destra)
        function updateZDXTipo(projectId, posId, tipo) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos || !pos.cassonetto) return;
            
            pos.cassonetto.ZDX_tipo = tipo;
            
            // Se muro o libero, ZDX non serve (imposta a 0 o valore speciale)
            if (tipo === 'muro') {
                pos.cassonetto.ZDX = '0';
            } else if (tipo === 'libero') {
                pos.cassonetto.ZDX = '999'; // Valore che indica "spazio illimitato"
            }
            // Se limitato, mantieni il valore esistente o aspetta input
            
            // ‚úÖ v4.87: Ricalcola BRM con nuovo allargamento
            if (!pos.cassonetto.brmPersonalizzato && project.brmConfigCassonetti) {
                const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
                pos.cassonetto.BRM_L = brm.L;
                pos.cassonetto.BRM_H = brm.H;
                pos.cassonetto.BRM_C = brm.C;
                pos.cassonetto.BRM_B = brm.B;
            }
            
            saveState();
            render();
        }

        // ‚úÖ v4.97: Validazione ZSX - deve essere ‚â§ SRSX
        function validateAndUpdateZSX(projectId, posId, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos || !pos.cassonetto) return;
            
            const zsx = parseInt(value) || 0;
            const srsx = parseInt(pos.cassonetto.SRSX) || 0;
            
            // Salva sempre il valore (la validazione √® visiva)
            pos.cassonetto.ZSX = value;
            
            // Log per debug
            if (zsx > srsx && srsx > 0) {
                console.warn(`‚ö†Ô∏è ZSX (${zsx}mm) > SRSX (${srsx}mm) - Errore logico!`);
            }
            
            // Ricalcola BRM
            if (!pos.cassonetto.brmPersonalizzato && project.brmConfigCassonetti) {
                const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
                pos.cassonetto.BRM_L = brm.L;
                pos.cassonetto.BRM_H = brm.H;
                pos.cassonetto.BRM_C = brm.C;
                pos.cassonetto.BRM_B = brm.B;
            }
            
            saveState();
            render();
        }
        
        // ‚úÖ v4.97: Validazione ZDX - deve essere ‚â§ SRDX
        function validateAndUpdateZDX(projectId, posId, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos || !pos.cassonetto) return;
            
            const zdx = parseInt(value) || 0;
            const srdx = parseInt(pos.cassonetto.SRDX) || 0;
            
            // Salva sempre il valore (la validazione √® visiva)
            pos.cassonetto.ZDX = value;
            
            // Log per debug
            if (zdx > srdx && srdx > 0) {
                console.warn(`‚ö†Ô∏è ZDX (${zdx}mm) > SRDX (${srdx}mm) - Errore logico!`);
            }
            
            // Ricalcola BRM
            if (!pos.cassonetto.brmPersonalizzato && project.brmConfigCassonetti) {
                const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
                pos.cassonetto.BRM_L = brm.L;
                pos.cassonetto.BRM_H = brm.H;
                pos.cassonetto.BRM_C = brm.C;
                pos.cassonetto.BRM_B = brm.B;
            }
            
            saveState();
            render();
        }

        // Validazione in tempo reale per le altezze (mentre scrivi)
        function validateAltezzeRealTime(projectId, posId) {
            // Leggi i valori dai campi DOM
            const hsoffEl = document.getElementById(`hsoff-${posId}`);
            const hparapSoffEl = document.getElementById(`hparapsoff-${posId}`);
            const hpavParapEl = document.getElementById(`hpavparap-${posId}`);
            const validationMsgEl = document.getElementById(`validation-msg-${posId}`);
            
            if (!hsoffEl || !hparapSoffEl || !hpavParapEl || !validationMsgEl) return;
            
            const hsoff = parseFloat(hsoffEl.value) || 0;
            const hparapSoff = parseFloat(hparapSoffEl.value) || 0;
            const hpavParap = parseFloat(hpavParapEl.value) || 0;
            
            // Reset a grigio se mancano valori
            if (hsoff === 0 || hparapSoff === 0 || hpavParap === 0) {
                hsoffEl.className = 'w-full px-3 py-2 border-2 border-gray-300 rounded font-semibold';
                hparapSoffEl.className = 'w-full px-3 py-2 border-2 border-gray-300 rounded font-semibold';
                hpavParapEl.className = 'w-full px-3 py-2 border-2 border-gray-300 rounded font-semibold';
                validationMsgEl.innerHTML = '';
                return;
            }
            
            // Calcola validazione
            const somma = hpavParap + hparapSoff;
            const diff = Math.abs(somma - hsoff);
            
            if (diff <= 10) {
                // Verde - OK
                const borderClass = 'w-full px-3 py-2 border-2 border-green-500 rounded font-semibold';
                hsoffEl.className = borderClass;
                hparapSoffEl.className = borderClass;
                hpavParapEl.className = borderClass;
                validationMsgEl.innerHTML = `
                    <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-2">
                        <p class="text-xs text-green-800">
                            ‚úÖ <strong>OK:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm ‚úì
                        </p>
                    </div>
                `;
            } else {
                // Rosso - ERRORE
                const borderClass = 'w-full px-3 py-2 border-2 border-red-500 rounded font-semibold';
                hsoffEl.className = borderClass;
                hparapSoffEl.className = borderClass;
                hpavParapEl.className = borderClass;
                validationMsgEl.innerHTML = `
                    <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-2">
                        <p class="text-xs text-red-800">
                            ‚ö†Ô∏è <strong>ERRORE:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm (>10mm!)
                        </p>
                    </div>
                `;
            }
        }

        // Personalizza BRM per questa specifica posizione
        window.personalizzaBRM = (projectId, posId, productType) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    const product = pos[productType];
                    
                    const configMap = {
                        'infisso': 'brmConfigInfissi',
                        'persiana': 'brmConfigPersiane',
                        'tapparella': 'brmConfigTapparelle',
                        'zanzariera': 'brmConfigZanzariere',
                        'cassonetto': 'brmConfigCassonetti'
                    };
                    const configKey = configMap[productType];
                    
                    // Crea brmPersonalizzato copiando la config globale come base
                    if (configKey && project[configKey]) {
                        const globalConfig = project[configKey];
                        product.brmPersonalizzato = {
                            misuraBaseL: globalConfig.misuraBaseL || '',
                            operazioneL: globalConfig.operazioneL || '-',
                            valoreL: globalConfig.valoreL || '0',
                            misuraBaseH: globalConfig.misuraBaseH || '',
                            operazioneH: globalConfig.operazioneH || '-',
                            valoreH: globalConfig.valoreH || '0'
                        };
                        
                        // Se √® un cassonetto, aggiungi anche C e B
                        if (productType === 'cassonetto') {
                            product.brmPersonalizzato.misuraBaseC = globalConfig.misuraBaseC || '';
                            product.brmPersonalizzato.operazioneC = globalConfig.operazioneC || '-';
                            product.brmPersonalizzato.valoreC = globalConfig.valoreC || '0';
                            product.brmPersonalizzato.misuraBaseB = globalConfig.misuraBaseB || '';
                            product.brmPersonalizzato.operazioneB = globalConfig.operazioneB || '-';
                            product.brmPersonalizzato.valoreB = globalConfig.valoreB || '0';
                        }
                        
                        // Determina il tipo per infissi e zanzariere
                        let tipo = null;
                        if (productType === 'infisso') {
                            tipo = product.tipo;
                        } else if (productType === 'zanzariera') {
                            tipo = pos.infisso?.tipo || '';
                        }
                        
                        // Ricalcola BRM con la formula personalizzata
                        const misure = (productType === 'cassonetto') ? product : pos.misure;
                        const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato, tipo);
                        product.BRM_L = brm.L;
                        product.BRM_H = brm.H;
                        if (productType === 'cassonetto') {
                            product.BRM_C = brm.C;
                            product.BRM_B = brm.B;
                        }
                    }
                    
                    saveState();
                    render();
                }
            }
        }

        // ‚úÖ APPLICA MODIFICHE BRM - Conferma e salva le modifiche al BRM personalizzato
        window.applicaBRMPersonalizzato = (projectId, posId, productType) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType] && pos[productType].brmPersonalizzato) {
                    const product = pos[productType];
                    
                    // ‚úÖ FIX: LEGGI I VALORI CORRENTI DAL DOM prima di salvare!
                    const misuraBaseLSelect = document.querySelector(`#brm-misuraBaseL-${productType}-${posId}`);
                    const operazioneLSelect = document.querySelector(`#brm-operazioneL-${productType}-${posId}`);
                    const valoreLInput = document.querySelector(`#brm-valoreL-${productType}-${posId}`);
                    const misuraBaseHSelect = document.querySelector(`#brm-misuraBaseH-${productType}-${posId}`);
                    const operazioneHSelect = document.querySelector(`#brm-operazioneH-${productType}-${posId}`);
                    const valoreHInput = document.querySelector(`#brm-valoreH-${productType}-${posId}`);
                    
                    // Aggiorna lo state con i valori dal DOM
                    if (misuraBaseLSelect) product.brmPersonalizzato.misuraBaseL = misuraBaseLSelect.value;
                    if (operazioneLSelect) product.brmPersonalizzato.operazioneL = operazioneLSelect.value;
                    // ‚úÖ FIX: Converti il valore in positivo (valore assoluto)
                    if (valoreLInput) product.brmPersonalizzato.valoreL = Math.abs(parseFloat(valoreLInput.value) || 0).toString();
                    if (misuraBaseHSelect) product.brmPersonalizzato.misuraBaseH = misuraBaseHSelect.value;
                    if (operazioneHSelect) product.brmPersonalizzato.operazioneH = operazioneHSelect.value;
                    // ‚úÖ FIX: Converti il valore in positivo (valore assoluto)
                    if (valoreHInput) product.brmPersonalizzato.valoreH = Math.abs(parseFloat(valoreHInput.value) || 0).toString();
                    
                    // Se √® un cassonetto, gestisci anche C e B
                    if (productType === 'cassonetto') {
                        const misuraBaseCSelect = document.querySelector(`#brm-misuraBaseC-${productType}-${posId}`);
                        const operazioneCSelect = document.querySelector(`#brm-operazioneC-${productType}-${posId}`);
                        const valoreCInput = document.querySelector(`#brm-valoreC-${productType}-${posId}`);
                        const misuraBaseBSelect = document.querySelector(`#brm-misuraBaseB-${productType}-${posId}`);
                        const operazioneBSelect = document.querySelector(`#brm-operazioneB-${productType}-${posId}`);
                        const valoreBInput = document.querySelector(`#brm-valoreB-${productType}-${posId}`);
                        
                        if (misuraBaseCSelect) product.brmPersonalizzato.misuraBaseC = misuraBaseCSelect.value;
                        if (operazioneCSelect) product.brmPersonalizzato.operazioneC = operazioneCSelect.value;
                        // ‚úÖ FIX: Converti il valore in positivo (valore assoluto)
                        if (valoreCInput) product.brmPersonalizzato.valoreC = Math.abs(parseFloat(valoreCInput.value) || 0).toString();
                        if (misuraBaseBSelect) product.brmPersonalizzato.misuraBaseB = misuraBaseBSelect.value;
                        if (operazioneBSelect) product.brmPersonalizzato.operazioneB = operazioneBSelect.value;
                        // ‚úÖ FIX: Converti il valore in positivo (valore assoluto)
                        if (valoreBInput) product.brmPersonalizzato.valoreB = Math.abs(parseFloat(valoreBInput.value) || 0).toString();
                    }
                    
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Ricalcola BRM con i nuovi valori
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato, tipo);
                    product.BRM_L = brm.L;
                    product.BRM_H = brm.H;
                    if (productType === 'cassonetto') {
                        product.BRM_C = brm.C;
                        product.BRM_B = brm.B;
                    }
                    
                    // Salva lo stato
                    saveState();
                    
                    // Fai un render completo per consolidare le modifiche
                    render();
                    
                    // Mostra notifica di successo
                    if (productType === 'cassonetto') {
                        showNotification(`‚úÖ BRM salvato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm, C=${brm.C || '?'}mm, B=${brm.B || '?'}mm`, 'success');
                    } else {
                        showNotification(`‚úÖ BRM salvato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm`, 'success');
                    }
                }
            }
        }

        // Ripristina uso formula globale (elimina personalizzazione)
        window.ripristinaGlobale = (projectId, posId, productType) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    const product = pos[productType];
                    
                    // Elimina il brmPersonalizzato
                    delete product.brmPersonalizzato;
                    
                    const configMap = {
                        'infisso': 'brmConfigInfissi',
                        'persiana': 'brmConfigPersiane',
                        'tapparella': 'brmConfigTapparelle',
                        'zanzariera': 'brmConfigZanzariere',
                        'cassonetto': 'brmConfigCassonetti'
                    };
                    const configKey = configMap[productType];
                    
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Ricalcola BRM con la config globale
                    if (configKey) {
                        const misure = (productType === 'cassonetto') ? product : pos.misure;
                        const brm = calculateBRM(project, pos, misure, project[configKey], tipo);
                        product.BRM_L = brm.L;
                        product.BRM_H = brm.H;
                        if (productType === 'cassonetto') {
                            product.BRM_C = brm.C;
                            product.BRM_B = brm.B;
                        }
                    }
                    
                    saveState();
                    render();
                }
            }
        }

        // Forza ricalcolo BRM per cassonetto (solo quando Usa Globale √® attivo)
        window.ricalcolaBRMCassonetto = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.cassonetto) {
                    const cas = pos.cassonetto;
                    
                    // Prendi caratteristiche muro (override o globali)
                    const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                        ? pos.caratteristicheMuroOverride 
                        : project.caratteristicheMuro || {};
                    
                    // üîß BSuperiore: Pre-compila con Battuta Superiore con Tapparella
                    const bSuperioreDefault = cm.battutaSuperioreTapparella || '0';
                    
                    // Assicurati che tutte le misure esistano
                    if (!cas.LS) cas.LS = '0';
                    if (!cas.SRSX) cas.SRSX = '0';
                    if (!cas.ZSX) cas.ZSX = '0';
                    if (!cas.SRDX) cas.SRDX = '0';
                    if (!cas.ZDX) cas.ZDX = '0';
                    if (!cas.HCASS) cas.HCASS = '0';
                    if (!cas.B) cas.B = '0';
                    if (!cas.C) cas.C = '0';
                    // ‚úÖ FASE 015: Inizializza BSuperiore SOLO se mancante
                    // NON sovrascrivere '0' esplicito dell'utente!
                    if (cas.BSuperiore === undefined || cas.BSuperiore === null || cas.BSuperiore === '') {
                        // Pre-compila con battutaSuperioreTapparella se mancante
                        cas.BSuperiore = bSuperioreDefault;
                    }
                    
                    // Ricalcola BRM (solo con formula globale, non personalizzata)
                    if (!cas.brmPersonalizzato) {
                        const brm = calculateBRM(project, pos, cas, project.brmConfigCassonetti);
                        cas.BRM_L = brm.L;
                        cas.BRM_H = brm.H;
                        cas.BRM_C = brm.C;
                        cas.BRM_B = brm.B;
                        
                        saveState();
                        render();
                        showNotification('BRM ricalcolato! L=' + (cas.BRM_L || 'null') + 'mm, H=' + (cas.BRM_H || 'null') + 'mm, C=' + (cas.BRM_C || 'null') + 'mm, B=' + (cas.BRM_B || 'null') + 'mm', 'success');
                    } else {
                        showNotification('Non puoi ricalcolare BRM con formula personalizzata. Prima ripristina la formula globale.', 'error');
                    }
                }
            }
        };

        // Aggiorna formula BRM personalizzata per un prodotto
        function updateBRMPersonalizzato(projectId, posId, productType, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    const product = pos[productType];
                    if (!product.brmPersonalizzato) {
                        product.brmPersonalizzato = {
                            misuraBaseL: '', operazioneL: '+', valoreL: '0',
                            misuraBaseH: '', operazioneH: '+', valoreH: '0'
                        };
                    }
                    
                    // ‚úÖ FIX: Converti sempre i valori mm in positivi (valore assoluto)
                    if (field.startsWith('valore') && !isNaN(value)) {
                        value = Math.abs(parseFloat(value)).toString();
                    }
                    
                    // Salva il valore
                    product.brmPersonalizzato[field] = value;
                    
                    // Per i cassonetti, le misure sono nel cassonetto stesso
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Ricalcola BRM con la nuova formula
                    const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato, tipo);
                    product.BRM_L = brm.L;
                    product.BRM_H = brm.H;
                    
                    // Salva PRIMA di aggiornare l'interfaccia
                    saveState();
                    
                    // ‚úÖ FIX: Aggiorna SOLO i valori BRM visualizzati, NON ricreare tutto il DOM
                    updateBRMDisplay(projectId, posId, productType, product);
                    
                    // Mostra una notifica con il nuovo valore BRM
                    showNotification(`BRM aggiornato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm`, 'success');
                }
            }
        }
        
        // ‚úÖ NUOVA FUNZIONE: Aggiorna solo i valori BRM visualizzati senza ricreare i dropdown
        function updateBRMDisplay(projectId, posId, productType, product) {
            // Aggiorna la formula visualizzata
            const formulaL = document.querySelector(`#formula-brm-l-${productType}-${posId}`);
            const formulaH = document.querySelector(`#formula-brm-h-${productType}-${posId}`);
            
            if (formulaL && product.brmPersonalizzato) {
                formulaL.textContent = `= ${product.brmPersonalizzato.misuraBaseL || '?'} ${product.brmPersonalizzato.operazioneL || '+'} ${product.brmPersonalizzato.valoreL || '0'}mm`;
            }
            
            if (formulaH && product.brmPersonalizzato) {
                formulaH.textContent = `= ${product.brmPersonalizzato.misuraBaseH || '?'} ${product.brmPersonalizzato.operazioneH || '+'} ${product.brmPersonalizzato.valoreH || '0'}mm`;
            }
            
            // Aggiorna i risultati BRM
            const brmLResult = document.querySelector(`#brm-l-result-${productType}-${posId}`);
            const brmHResult = document.querySelector(`#brm-h-result-${productType}-${posId}`);
            
            if (brmLResult) {
                // ‚úÖ FASE 015: Distingui 0 (valido) da mancante
                brmLResult.textContent = (product.BRM_L !== undefined && product.BRM_L !== null && product.BRM_L !== '') 
                    ? product.BRM_L 
                    : '-';
            }
            
            if (brmHResult) {
                // ‚úÖ FASE 015: Distingui 0 (valido) da mancante
                brmHResult.textContent = (product.BRM_H !== undefined && product.BRM_H !== null && product.BRM_H !== '') 
                    ? product.BRM_H 
                    : '-';
            }
        }

        // === FASE 23A: GESTIONE COD.TAGLI ===
        
        // Funzione per aggiornare la config globale degli infissi
        window.updateConfigInfissi = (projectId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi) {
                    project.configInfissi = {};
                }
                
                // Log per debug
                console.log('üîß Config Globale aggiornata:', field, '=', value);
                
                // Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configInfissi[field];
                console.log('   oldValue:', oldValue);
                
                project.configInfissi[field] = value;
                
                // üÜï v4.78: Se PVC/PVC, sincronizza coloreInt e coloreEst
                const isPvcPvc = project.configInfissi.finituraInt === 'pvc' && 
                                 project.configInfissi.finituraEst === 'pvc';
                
                if (isPvcPvc) {
                    if (field === 'coloreInt') {
                        project.configInfissi.coloreEst = value;
                        console.log('üé® v4.78: PVC/PVC ‚Üí coloreEst sincronizzato a:', value);
                        // Sincronizza anche coloreEst alle posizioni
                        syncConfigToPositions(project, 'infisso', 'coloreEst', value, oldValue);
                        // üÜï v4.83: Aggiorna UI immediatamente
                        render();
                    } else if (field === 'coloreEst') {
                        project.configInfissi.coloreInt = value;
                        console.log('üé® v4.78: PVC/PVC ‚Üí coloreInt sincronizzato a:', value);
                        // Sincronizza anche coloreInt alle posizioni
                        syncConfigToPositions(project, 'infisso', 'coloreInt', value, oldValue);
                        // üÜï v4.83: Aggiorna UI immediatamente
                        render();
                    }
                }
                
                // Se cambia tagliTelaio, RESET immediato dei codTagli per forzare aggiornamento
                if (field === 'tagliTelaio') {
                    // üÜï v4.81: Usa getPosizioniTagli() invece di salvare codTagli
                    const posizioniTagli = getPosizioniTagli(value);
                    
                    // Inizializza codTagliValues con stringhe vuote (basato su numero posizioni)
                    project.configInfissi.codTagliValues = new Array(posizioniTagli.length).fill('');
                    
                    console.log('   posizioniTagli generate:', posizioniTagli);
                    console.log('   codTagliValues inizializzati:', project.configInfissi.codTagliValues);
                    
                    // üÜï SYNC AUTOMATICO tagliTelaio A TUTTE LE POSIZIONI
                    if (project.positions) {
                        let posizioniAggiornate = 0;
                        project.positions.forEach(pos => {
                            if (pos.infisso) {
                                // Aggiorna tagliTelaio
                                pos.infisso.tagliTelaio = value;
                                // üÜï v4.81: Non salva pi√π codTagli, lo genera al volo
                                // Reset codTagliValues se numero diverso, altrimenti mantieni
                                if (pos.infisso.codTagliValues?.length !== posizioniTagli.length) {
                                    pos.infisso.codTagliValues = new Array(posizioniTagli.length).fill('');
                                }
                                posizioniAggiornate++;
                            }
                        });
                        console.log(`‚úÖ Aggiornati tagliTelaio in ${posizioniAggiornate} posizioni`);
                    }
                    
                    // Sincronizza codTagliValues con le posizioni
                    syncConfigToPositions(project, 'infisso', 'codTagliValues', project.configInfissi.codTagliValues, null);
                    
                    // üÜï RENDER IMMEDIATO per aggiornare i campi codice
                    render();
                }
                
                // AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                console.log('   Chiamo syncConfigToPositions...');
                let posizioniAggiornate = syncConfigToPositions(project, 'infisso', field, value, oldValue);
                console.log(`   ‚úÖ ${posizioniAggiornate} posizioni sincronizzate`);
                
                saveState();
                // render(); ‚Üê RIMOSSO: Evita reload pagina, mantiene focus
            }
        };
        
        // Funzione per aggiornare i VALORI dei COD.TAGLI (non le etichette)
        window.updateCodTagliValue = (projectId, index, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi.codTagliValues) {
                    project.configInfissi.codTagliValues = [];
                }
                
                // Salva il vecchio array PRIMA di aggiornare
                const oldValue = [...(project.configInfissi.codTagliValues || [])];
                
                project.configInfissi.codTagliValues[index] = value;
                
                // AUTO-SYNC: Aggiorna automaticamente le posizioni
                syncConfigToPositions(project, 'infisso', 'codTagliValues', project.configInfissi.codTagliValues, oldValue);
                
                saveState();
            }
        };
        
        // FORZA SINCRONIZZAZIONE: Sincronizza TUTTI i campi config ‚Üí posizioni (anche array vuoti)
        window.forzaSincronizzazioneInfissi = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (!project || !project.configInfissi) {
                alert('‚ùå Nessuna configurazione infissi trovata!');
                return;
            }
            
            // Verifica se la config ha effettivamente valori
            const configHaValori = (
                project.configInfissi.azienda ||
                project.configInfissi.telaio ||
                project.configInfissi.coloreInt ||
                // üÜï v4.85: Usa tagliTelaio invece di codTagli (rimosso)
                project.configInfissi.tagliTelaio
            );
            
            if (!configHaValori) {
                alert('‚ö†Ô∏è CONFIG GLOBALE VUOTA!\n\nImposta prima i valori nella Config Globale, poi sincronizza.');
                return;
            }
            
            if (!confirm('üîÑ SINCRONIZZARE TUTTI GLI INFISSI?\n\nQuesto aggiorner√† TUTTE le posizioni con i valori della Config Globale, sovrascrivendo anche i campi vuoti.\n\nLe modifiche manuali nelle singole posizioni NON verranno sovrascritte.')) {
                return;
            }
            
            console.log('üîÑ FORZA SINCRONIZZAZIONE INFISSI');
            console.log('   Config:', project.configInfissi);
            
            let contatore = 0;
            const campiDaSincronizzare = [
                'azienda', 'tipoAnta', 'finituraInt', 'finituraEst', 
                'coloreInt', 'coloreEst', 'telaio', 'allarme', 'vetro', 'cerniere',
                'tagliTelaio', 'codTagliValues', 'maniglia', 'coloreManiglia'  // üÜï v4.81: rimosso codTagli
            ];
            
            project.positions.forEach(pos => {
                if (pos.infisso) {
                    console.log(`   Posizione ${pos.id}:`);
                    campiDaSincronizzare.forEach(field => {
                        const currentValue = pos.infisso[field];
                        const configValue = project.configInfissi[field];
                        
                        // Sincronizza se:
                        // 1. Campo vuoto/undefined/null
                        // 2. Array vuoto []
                        // 3. Stringa vuota ''
                        const isEmpty = (
                            currentValue === undefined ||
                            currentValue === null ||
                            currentValue === '' ||
                            (Array.isArray(currentValue) && currentValue.length === 0)
                        );
                        
                        // NON sincronizzare se la config ha array vuoti o valori vuoti
                        const configHasValue = configValue !== undefined && 
                                              configValue !== null && 
                                              configValue !== '' &&
                                              (!Array.isArray(configValue) || configValue.length > 0);
                        
                        console.log(`     ${field}: pos="${currentValue}" config="${configValue}" isEmpty=${isEmpty} configHasValue=${configHasValue}`);
                        
                        if (isEmpty && configHasValue) {
                            if (Array.isArray(configValue)) {
                                pos.infisso[field] = [...configValue];
                            } else {
                                pos.infisso[field] = configValue;
                            }
                            console.log(`     ‚úÖ Sincronizzato: ${field} = ${configValue}`);
                            contatore++;
                        } else if (!isEmpty) {
                            console.log(`     ‚è≠Ô∏è Skip (gi√† impostato)`);
                        } else if (!configHasValue) {
                            console.log(`     ‚è≠Ô∏è Skip (config vuota)`);
                        }
                    });
                }
            });
            
            saveState();
            render();
            
            alert(`‚úÖ SINCRONIZZAZIONE COMPLETATA!\n\nAggiornati ${contatore} campi nelle posizioni esistenti.`);
            console.log(`‚úÖ SINCRONIZZAZIONE COMPLETATA: ${contatore} campi aggiornati`);
        };
        
        // Funzione per aggiornare un singolo COD.TAGLI in una posizione
        window.updateCodTagliPosizione = (projectId, posId, index, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.infisso) {
                    // üÜï v4.81: Aggiorna codTagliValues (non pi√π codTagli)
                    if (!pos.infisso.codTagliValues) {
                        pos.infisso.codTagliValues = [];
                    }
                    pos.infisso.codTagliValues[index] = value;
                    saveState();
                    // Non fare render completo per mantenere il focus
                }
            }
        };
        // MAIN COMPONENTS
        function Header() {
            return `
                <header class="bg-white/95 backdrop-blur shadow-lg sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-4 py-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <!-- Hamburger Menu Button -->
                                <button onclick="toggleMainMenu()" class="p-2 hover:bg-gray-100 rounded-lg" title="Menu principale">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                    </svg>
                                </button>
                                
                                ${state.screen !== 'list' ? `
                                    <button onclick="goBack()" class="p-2 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                ` : ''}
                                <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                    Open Porte v${APP_VERSION}
                                </h1>
                            </div>
                            <div class="flex items-center gap-2">
                                ${state.screen === 'list' ? `
                                    <button onclick="importProjectsJSON()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                        <span>üì•</span>
                                        <span>Importa</span>
                                    </button>
                                    <button onclick="exportAllProjects()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                        <span>üíæ</span>
                                        <span>JSON</span>
                                    </button>
                                    <button onclick="exportAllProjectsExcel()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-emerald-600 to-green-700 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                        <span>üìä</span>
                                        <span>Excel</span>
                                    </button>
                                    <button onclick="showNewProjectModal()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                                        + Nuovo Progetto
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        // Main Menu laterale dell'applicazione
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üé® PAGINA DISEGNI PROGETTO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function DrawingsPage() {
            const project = state.projects.find(p => p.id === state.currentProject);
            
            if (!project) {
                return `<div style="padding: 20px; text-align: center;">
                    <p>‚ùå Progetto non trovato</p>
                </div>`;
            }
            
            // Migra se necessario
            migrateProjectDrawings(project);
            
            const drawings = project.drawings?.general || [];
            const stats = project.drawings?.stats || { total: 0, totalSize: 0 };
            const totalSize = calculateTotalDrawingsSize(project);
            const usedSpace = (totalSize / DRAWING_LIMITS.maxProjectSize * 100).toFixed(1);
            
            return `
                ${renderProjectMenu()}
                
                <div style="padding: 80px 20px 20px 20px;">
                    <!-- Header Pagina -->
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <h2 style="margin: 0; font-size: 24px; color: #2d3748;">
                                üé® Disegni Progetto
                            </h2>
                            <button onclick="showUploadDialog()" 
                                    style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">+</span>
                                Aggiungi
                            </button>
                        </div>
                        
                        <!-- Statistiche -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px; color: #718096;">
                            <div>
                                <strong>${drawings.length}</strong> disegni
                            </div>
                            <div>
                                <strong>${formatFileSize(totalSize)}</strong> occupati
                            </div>
                            <div>
                                <strong>${usedSpace}%</strong> spazio usato
                            </div>
                        </div>
                        
                        <!-- Barra progresso spazio -->
                        <div style="margin-top: 10px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${usedSpace}%; height: 100%; background: ${usedSpace > 80 ? '#f56565' : '#4CAF50'}; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <!-- Lista Disegni -->
                    ${drawings.length === 0 ? `
                        <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">üé®</div>
                            <h3 style="margin: 0 0 10px 0; color: #2d3748;">Nessun disegno</h3>
                            <p style="color: #718096; margin: 0 0 20px 0;">
                                Aggiungi disegni schematici dal rilievo per avere riferimenti visivi
                            </p>
                            <button onclick="showUploadDialog()" 
                                    style="padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                                Aggiungi primo disegno
                            </button>
                        </div>
                    ` : drawings.map(drawing => renderDrawingCard(drawing, project)).join('')}
                </div>
            `;
        }

        // Render card singolo disegno
        function renderDrawingCard(drawing, project) {
            const isImage = drawing.type.startsWith('image/');
            const isPDF = drawing.type === 'application/pdf';
            const linkedPos = drawing.linkedPositions || [];
            const posNames = linkedPos.map(id => {
                const pos = project.positions.find(p => p.id === id);
                return pos?.name || 'Sconosciuta';
            });
            
            return `
                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <!-- Thumbnail -->
                        <div style="flex-shrink: 0;">
                            ${drawing.thumbnail ? `
                                <img src="${drawing.thumbnail}" 
                                     alt="${drawing.name}"
                                     onclick="viewDrawing('${drawing.id}')"
                                     style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #e2e8f0;">
                            ` : `
                                <div onclick="viewDrawing('${drawing.id}')"
                                     style="width: 120px; height: 120px; background: #f7fafc; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #e2e8f0;">
                                    <span style="font-size: 48px;">${isPDF ? 'üìÑ' : 'üñºÔ∏è'}</span>
                                </div>
                            `}
                        </div>
                        
                        <!-- Info -->
                        <div style="flex: 1; min-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #2d3748; overflow: hidden; text-overflow: ellipsis;">
                                ${drawing.name}
                            </h3>
                            
                            ${drawing.description ? `
                                <p style="margin: 0 0 10px 0; color: #718096; font-size: 14px;">
                                    ${drawing.description}
                                </p>
                            ` : ''}
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px; color: #a0aec0; margin-bottom: 12px;">
                                <span>üìÖ ${new Date(drawing.uploadDate).toLocaleDateString('it-IT')}</span>
                                <span>üíæ ${formatFileSize(drawing.size)}</span>
                                ${isPDF && drawing.metadata?.pageCount ? `
                                    <span>üìÑ ${drawing.metadata.pageCount} pag.</span>
                                ` : ''}
                                ${drawing.metadata?.dimensions ? `
                                    <span>üìê ${drawing.metadata.dimensions.width}√ó${drawing.metadata.dimensions.height}px</span>
                                ` : ''}
                            </div>
                            
                            ${linkedPos.length > 0 ? `
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: #a0aec0; margin-bottom: 4px;">Collegato a:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${posNames.map(name => `
                                            <span style="background: #edf2f7; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #4a5568;">
                                                üìç ${name}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Azioni -->
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="viewDrawing('${drawing.id}')"
                                        style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                                    üëÅÔ∏è Visualizza
                                </button>
                                <button onclick="downloadDrawing('${drawing.id}')"
                                        style="padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                                    üíæ Scarica
                                </button>
                                <button onclick="confirmDeleteDrawing('${drawing.id}')"
                                        style="padding: 8px 16px; background: #f56565; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Dialog upload
        function showUploadDialog() {
            const project = state.projects.find(p => p.id === state.currentProject);
            const availableSpace = DRAWING_LIMITS.maxProjectSize - calculateTotalDrawingsSize(project);
            
            const dialog = document.createElement('div');
            dialog.className = 'modal-overlay';
            dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            dialog.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; font-size: 24px; color: #2d3748;">
                        üì§ Aggiungi Disegno
                    </h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">
                            File (PNG, JPG, PDF)
                        </label>
                        <input type="file" 
                               id="drawing-file-input"
                               accept="image/png,image/jpeg,image/jpg,application/pdf"
                               style="width: 100%; padding: 10px; border: 2px dashed #cbd5e0; border-radius: 8px; cursor: pointer;">
                        <div style="margin-top: 8px; font-size: 12px; color: #a0aec0;">
                            Max ${formatFileSize(DRAWING_LIMITS.maxFileSize)} per file ‚Ä¢ Disponibili ${formatFileSize(availableSpace)}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">
                            Descrizione (opzionale)
                        </label>
                        <textarea id="drawing-description"
                                  placeholder="Es: Vista generale piano terra"
                                  style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; min-height: 80px; font-family: inherit; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('.modal-overlay').remove()"
                                style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; cursor: pointer;">
                            Annulla
                        </button>
                        <button onclick="uploadDrawingFromDialog()"
                                style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Carica
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }

        // Upload da dialog
        async function uploadDrawingFromDialog() {
            const fileInput = document.getElementById('drawing-file-input');
            const descriptionInput = document.getElementById('drawing-description');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showNotification('‚ö†Ô∏è Seleziona un file', 'warning');
                return;
            }
            
            const file = fileInput.files[0];
            const description = descriptionInput.value.trim();
            
            const success = await addDrawingToProject(file, description);
            
            if (success) {
                document.querySelector('.modal-overlay').remove();
            }
        }

        // Visualizza disegno (lightbox)
        function viewDrawing(drawingId) {
            const project = state.projects.find(p => p.id === state.currentProject);
            const drawing = project?.drawings?.general?.find(d => d.id === drawingId);
            
            if (!drawing) return;
            
            const isPDF = drawing.type === 'application/pdf';
            
            const lightbox = document.createElement('div');
            lightbox.className = 'lightbox-overlay';
            lightbox.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
            lightbox.onclick = (e) => {
                if (e.target === lightbox) lightbox.remove();
            };
            
            lightbox.innerHTML = `
                <div style="position: relative; max-width: 90vw; max-height: 90vh; background: white; border-radius: 12px; overflow: hidden;">
                    <div style="padding: 15px; background: #2d3748; color: white; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px;">${drawing.name}</h3>
                        <button onclick="this.closest('.lightbox-overlay').remove()"
                                style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">
                            √ó
                        </button>
                    </div>
                    <div style="padding: 20px; max-height: calc(90vh - 100px); overflow: auto;">
                        ${isPDF ? `
                            <iframe src="${drawing.data}" 
                                    style="width: 80vw; height: 70vh; border: none; border-radius: 8px;"></iframe>
                            <div style="margin-top: 15px; text-align: center;">
                                <a href="${drawing.data}" 
                                   download="${drawing.name}.pdf"
                                   style="padding: 10px 20px; background: #4299e1; color: white; text-decoration: none; border-radius: 8px; display: inline-block;">
                                    üíæ Scarica PDF
                                </a>
                            </div>
                        ` : `
                            <img src="${drawing.data}" 
                                 alt="${drawing.name}"
                                 style="max-width: 100%; height: auto; border-radius: 8px; display: block; margin: 0 auto;">
                        `}
                    </div>
                </div>
            `;
            
            document.body.appendChild(lightbox);
        }

        // Scarica disegno
        function downloadDrawing(drawingId) {
            const project = state.projects.find(p => p.id === state.currentProject);
            const drawing = project?.drawings?.general?.find(d => d.id === drawingId);
            
            if (!drawing) return;
            
            const ext = drawing.type === 'application/pdf' ? 'pdf' : 
                        drawing.type === 'image/png' ? 'png' : 'jpg';
            
            const link = document.createElement('a');
            link.href = drawing.data;
            link.download = `${drawing.name}.${ext}`;
            link.click();
            
            showNotification('üíæ Download avviato', 'success');
        }

        // Conferma eliminazione
        function confirmDeleteDrawing(drawingId) {
            if (confirm('Eliminare questo disegno? L\'operazione non pu√≤ essere annullata.')) {
                deleteDrawing(drawingId);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üìã MAIN MENU
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function MainMenu() {
            return `
                <!-- Main Menu Laterale -->
                <aside class="main-menu ${state.mainMenuOpen ? 'open' : ''}" id="mainSideMenu">
                    <!-- Header menu -->
                    <div class="main-menu-header">
                        <button class="main-menu-close" onclick="toggleMainMenu()">‚úï</button>
                        <span class="main-menu-title">MENU PRINCIPALE</span>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="main-menu-search">
                        <input type="text" id="mainSearch" placeholder="üîç Cerca progetto..." 
                               onkeyup="searchProjects(this.value)" 
                               class="search-input">
                    </div>
                    
                    <!-- Menu Items con Submenu -->
                    <div class="main-nav-section">
                        <!-- Progetti -->
                        <div class="main-nav-item expandable" onclick="toggleMainSubmenu('progetti')">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">üìù</span>
                                <span>Progetti</span>
                                <span class="main-nav-arrow">‚ñ∂</span>
                            </div>
                        </div>
                        <div id="main-submenu-progetti" class="main-submenu">
                            <div class="main-submenu-item" onclick="showNewProjectModal(); closeMainMenu();">
                                <span>‚ûï Nuovo Progetto</span>
                            </div>
                            <div class="main-submenu-item" onclick="showProjectsList(); closeMainMenu();">
                                <span>üìÇ Lista Progetti</span>
                            </div>
                            <div class="main-submenu-item" onclick="showRecentProjects(); closeMainMenu();">
                                <span>üïê Recenti</span>
                            </div>
                            <div class="main-submenu-item" onclick="showArchivedProjects(); closeMainMenu();">
                                <span>üì¶ Archiviati</span>
                            </div>
                        </div>
                        
                        <!-- Strumenti -->
                        <div class="main-nav-item expandable" onclick="toggleMainSubmenu('strumenti')">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">üõ†Ô∏è</span>
                                <span>Strumenti</span>
                                <span class="main-nav-arrow">‚ñ∂</span>
                            </div>
                        </div>
                        <div id="main-submenu-strumenti" class="main-submenu">
                            <div class="main-submenu-item" onclick="openBRMCalculator(); closeMainMenu();">
                                <span>üßÆ Calcolatore BRM</span>
                            </div>
                            <div class="main-submenu-item" onclick="openConversions(); closeMainMenu();">
                                <span>üîÑ Conversioni</span>
                            </div>
                            <div class="main-submenu-item" onclick="openNormative(); closeMainMenu();">
                                <span>üìã Normative</span>
                            </div>
                        </div>
                        
                        <!-- Impostazioni -->
                        <div class="main-nav-item expandable" onclick="toggleMainSubmenu('impostazioni')">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">‚öôÔ∏è</span>
                                <span>Impostazioni</span>
                                <span class="main-nav-arrow">‚ñ∂</span>
                            </div>
                        </div>
                        <div id="main-submenu-impostazioni" class="main-submenu">
                            <div class="main-submenu-item" onclick="openGeneralSettings(); closeMainMenu();">
                                <span>üé® Generali</span>
                            </div>
                            <div class="main-submenu-item" onclick="openProductSettings(); closeMainMenu();">
                                <span>üì¶ Config Prodotti</span>
                            </div>
                            <div class="main-submenu-item" onclick="openExportImport(); closeMainMenu();">
                                <span>üíæ Export/Import</span>
                            </div>
                        </div>
                        
                        <!-- Backup & Sync -->
                        <div class="main-nav-item" onclick="openBackupSettings(); closeMainMenu();">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">üîí</span>
                                <span>Backup</span>
                            </div>
                        </div>
                        
                        <!-- GitHub Sync -->
                        <div class="main-nav-item" onclick="openGitHubSettings(); closeMainMenu();">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">üì¶</span>
                                <span>GitHub</span>
                            </div>
                            <span class="sync-badge" id="mainSyncBadge">
                                ${renderGitHubBadge()}
                            </span>
                        </div>
                        
                        <!-- Statistiche -->
                        <div class="main-nav-item" onclick="openStatistics(); closeMainMenu();">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">üìä</span>
                                <span>Statistiche</span>
                            </div>
                        </div>
                        
                        <!-- Info -->
                        <div class="main-nav-item" onclick="openAppInfo(); closeMainMenu();">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">‚ÑπÔ∏è</span>
                                <span>Info</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions Bottom -->
                    <div class="main-menu-bottom">
                        <div class="quick-actions-title">Azioni Rapide</div>
                        <div class="quick-actions-grid">
                            <button onclick="quickNewProject()" title="Nuovo (Ctrl+N)" class="quick-action-btn">
                                ‚ûï
                            </button>
                            <button onclick="quickSave()" title="Salva (Ctrl+S)" class="quick-action-btn">
                                üíæ
                            </button>
                            <button onclick="quickExport()" title="Export (Ctrl+E)" class="quick-action-btn">
                                üìÑ
                            </button>
                            <button onclick="quickSync()" title="Sync (Ctrl+U)" class="quick-action-btn">
                                ‚òÅÔ∏è
                            </button>
                        </div>
                    </div>
                </aside>
                
                <!-- Overlay -->
                <div class="main-menu-overlay ${state.mainMenuOpen ? 'active' : ''}" 
                     id="mainMenuOverlay" 
                     onclick="closeMainMenu()"></div>
            `;
        }

        // Funzioni gestione menu principale
        function toggleMainMenu() {
            state.mainMenuOpen = !state.mainMenuOpen;
            render();
        }
        
        function closeMainMenu() {
            state.mainMenuOpen = false;
            render();
        }
        
        function toggleMainSubmenu(menuId) {
            const submenu = document.getElementById(`main-submenu-${menuId}`);
            if (submenu) {
                const menuItem = submenu.previousElementSibling;
                const isOpen = submenu.classList.contains('open');
                
                // Chiudi altri submenu
                document.querySelectorAll('.main-submenu.open').forEach(s => {
                    s.classList.remove('open');
                    const prevItem = s.previousElementSibling;
                    if (prevItem) prevItem.classList.remove('expanded');
                });
                
                // Toggle corrente
                if (!isOpen) {
                    submenu.classList.add('open');
                    menuItem.classList.add('expanded');
                }
            }
        }
        
        // Funzioni per le voci del menu
        function showProjectsList() {
            state.screen = 'list';
            // üÜï v4.20: Chiudi tutti i menu quando torni alla lista
            state.projectMenuOpen = false;
            state.mainMenuOpen = false;
            render();
        }
        
        function showRecentProjects() {
            const recentProjects = state.projects.slice(-5).reverse();
            console.log('Progetti recenti:', recentProjects);
            // TODO: Implementare vista progetti recenti
        }
        
        function showArchivedProjects() {
            const archivedProjects = state.projects.filter(p => p.archived === true);
            console.log('Progetti archiviati:', archivedProjects);
            // TODO: Implementare vista progetti archiviati
        }
        
        // Quick Actions
        function quickNewProject() {
            closeMainMenu();
            showNewProjectModal();
        }
        
        function quickSave() {
            closeMainMenu();
            saveState();
            showNotification('üíæ Salvato', 'success');
        }
        
        function quickExport() {
            closeMainMenu();
            if (state.currentProject) {
                exportCurrentProjectJSON();
            } else {
                exportAllProjects();
            }
        }
        
        function quickSync() {
            closeMainMenu();
            if (state.github && state.github.connected) {
                uploadToGitHub();
            } else {
                openGitHubSettings();
            }
        }
        
        // Funzioni placeholder per menu items
        function openBRMCalculator() {
            showNotification('üßÆ Calcolatore BRM in sviluppo', 'info');
        }
        
        function openConversions() {
            showNotification('üîÑ Conversioni in sviluppo', 'info');
        }
        
        function openNormative() {
            showNotification('üìã Normative in sviluppo', 'info');
        }
        
        function openGeneralSettings() {
            showNotification('üé® Impostazioni generali in sviluppo', 'info');
        }
        
        function openProductSettings() {
            showNotification('üì¶ Configurazione prodotti in sviluppo', 'info');
        }
        
        function openExportImport() {
            // Usa le funzioni esistenti
            if (state.screen === 'list') {
                exportAllProjects();
            } else {
                exportCurrentProjectJSON();
            }
        }
        
        function openBackupSettings() {
            showNotification('üîí Sistema backup in sviluppo', 'info');
        }
        
        function openStatistics() {
            const totalProjects = state.projects.length;
            const totalPositions = state.projects.reduce((sum, p) => sum + ((p.positions || []).length), 0);
            showNotification(`üìä Statistiche: ${totalProjects} progetti, ${totalPositions} posizioni`, 'success');
        }
        
        function openAppInfo() {
            showNotification('‚ÑπÔ∏è Open Porte v3.0 - Fase 023', 'info');
        }
        
        // Sistema notifiche migliorato
        function showNotification(message, type = 'info', duration = 3000) {
            // Rimuovi notifiche esistenti
            const existingNotifications = document.querySelectorAll('.notification-toast');
            existingNotifications.forEach(n => n.remove());
            
            // Crea nuova notifica
            const notification = document.createElement('div');
            notification.className = `notification-toast notification-${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <span class="notification-icon">${icons[type]}</span>
                <span class="notification-message">${message}</span>
            `;
            
            // Aggiungi stili inline
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#10b981' : 
                            type === 'error' ? '#ef4444' :
                            type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 10000;
                animation: slideUp 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(notification);
            
            // Rimuovi dopo duration
            if (duration > 0) {
                setTimeout(() => {
                    notification.style.animation = 'slideDown 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }
        
        // Funzione ricerca progetti
        function searchProjects(query) {
            if (!query || query.length < 2) {
                // Reset vista se query vuota
                return;
            }
            
            const results = [];
            const lowerQuery = query.toLowerCase();
            
            state.projects.forEach(project => {
                // Cerca nel nome progetto
                if (project.name && project.name.toLowerCase().includes(lowerQuery)) {
                    results.push({ type: 'project', data: project });
                }
                
                // Cerca nel nome cliente
                if (project.client && project.client.toLowerCase().includes(lowerQuery)) {
                    results.push({ type: 'project', data: project });
                }
                
                // Cerca nelle posizioni
                if (project.positions) {
                    project.positions.forEach(pos => {
                        if (pos.name && pos.name.toLowerCase().includes(lowerQuery)) {
                            results.push({ 
                                type: 'position', 
                                data: pos,
                                projectName: project.name 
                            });
                        }
                    });
                }
            });
            
            console.log(`Trovati ${results.length} risultati per "${query}"`);
            // TODO: Mostrare risultati in overlay dedicato
        }

        function ProjectsList() {
            if (state.projects.length === 0) {
                // Verifica se GitHub √® connesso
                const isGitHubConnected = state.github && state.github.connected;
                
                return `
                    ${Header()}
                    <div class="min-h-[70vh] flex items-center justify-center p-4">
                        <div class="max-w-2xl w-full space-y-4">
                            
                            <!-- Banner GitHub -->
                            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-2xl p-6 shadow-lg">
                                <div class="flex items-start gap-4">
                                    <div class="text-5xl flex-shrink-0">üì¶</div>
                                    <div class="flex-1">
                                        ${!isGitHubConnected ? `
                                            <!-- Non connesso: invita a connettere -->
                                            <h3 class="text-xl font-bold text-blue-900 mb-2">
                                                Hai progetti su altri dispositivi?
                                            </h3>
                                            <p class="text-blue-700 mb-4">
                                                Connetti GitHub per sincronizzare i tuoi progetti tra PC, tablet e smartphone. 
                                                I tuoi dati saranno sempre aggiornati e disponibili ovunque.
                                            </p>
                                            <div class="flex flex-wrap gap-3">
                                                <button onclick="showGitHubTokenInput()" 
                                                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg font-semibold hover:shadow-xl transition-all flex items-center gap-2">
                                                    <span>üîó</span>
                                                    <span>Connetti GitHub</span>
                                                </button>
                                                <button onclick="openGitHubSettings()" 
                                                        class="px-6 py-3 bg-white text-blue-600 border-2 border-blue-300 rounded-lg font-semibold hover:bg-blue-50 transition-all">
                                                    ‚ÑπÔ∏è Maggiori Info
                                                </button>
                                            </div>
                                        ` : `
                                            <!-- Connesso ma nessun progetto locale -->
                                            <h3 class="text-xl font-bold text-blue-900 mb-2">
                                                üü¢ GitHub Connesso
                                            </h3>
                                            <p class="text-blue-700 mb-4">
                                                Inizia creando il tuo primo progetto. I dati verranno sincronizzati automaticamente su GitHub.
                                            </p>
                                            <div class="flex flex-wrap gap-3">
                                                <button onclick="openGitHubSettings()" 
                                                        class="px-6 py-3 bg-white text-blue-600 border-2 border-blue-300 rounded-lg font-semibold hover:bg-blue-50 transition-all">
                                                    ‚öôÔ∏è Impostazioni GitHub
                                                </button>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Benvenuto -->
                            <div class="text-center bg-white rounded-2xl p-8 shadow-xl">
                                <div class="text-6xl mb-4">üìã</div>
                                <h2 class="text-2xl font-bold mb-2">Benvenuto in Open Porte</h2>
                                <p class="text-gray-600 mb-6">
                                    ${!isGitHubConnected ? 
                                        'Inizia creando il tuo primo progetto oppure connetti GitHub per sincronizzare' : 
                                        'Inizia creando il tuo primo progetto'}
                                </p>
                                <button onclick="showNewProjectModal()" 
                                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                                    + Crea Primo Progetto
                                </button>
                            </div>
                            
                        </div>
                    </div>
                `;
            }

            return `
                ${Header()}
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                    ${(state.projects || []).map(p => `
                        <div class="section-card hover:transform hover:scale-105 transition-all cursor-pointer relative"
                             onclick="openProject('${p.id}')">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <p class="text-xs text-purple-600 font-mono font-semibold mb-1">${formatProjectId(p.id)}</p>
                                    <h3 class="font-bold text-lg text-gray-800">‚Üí ${p.name}</h3>
                                    <p class="text-sm text-gray-600 flex items-center gap-1 mt-1">
                                        <span>üë§</span> ${p.client}
                                    </p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.stopPropagation(); deleteProject('${p.id}')"
                                            class="text-red-600 hover:bg-red-100 p-2 rounded-lg transition-all"
                                            title="Elimina progetto">
                                        üóëÔ∏è
                                    </button>
                                    <span class="text-2xl">üóÇÔ∏è</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-sm pt-2 border-t border-gray-100">
                                <div class="flex flex-col gap-1">
                                    <span class="text-gray-500 flex items-center gap-1">
                                        <span>üìã</span> ${(p.positions || []).length} posizioni
                                    </span>
                                    ${p.metadata && p.metadata.version ? `
                                        <span class="text-xs text-blue-600 font-mono flex items-center gap-1">
                                            <span>üî¢</span> v${p.metadata.version}
                                            ${p.metadata.updated ? `
                                                <span class="text-gray-400">‚Ä¢ ${new Date(p.metadata.updated).toLocaleDateString('it-IT', {day: '2-digit', month: '2-digit'})}</span>
                                            ` : ''}
                                        </span>
                                    ` : ''}
                                </div>
                                <span class="text-purple-600 font-medium">Apri ‚Üí</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }


        function ProjectSetup() {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return '';

            return `
                ${renderTopNavbar()}
                
                <div class="max-w-7xl mx-auto p-4">
                    
                    <!-- HEADER COMPLETAMENTO PROGETTO -->
                    <div class="project-completion-header mb-4">
                        <div style="padding: 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: 600; color: #374151;">Completamento Progetto</span>
                                <span style="font-weight: 700; color: #1f2937;">${CompletionSystem.getOverallCompletion(project)}%</span>
                            </div>
                            ${CompletionSystem.getProgressBar(CompletionSystem.getOverallCompletion(project))}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-6 bg-white rounded-lg p-4 shadow overflow-x-auto">
                        ${(() => {
                            // üéØ Genera dinamicamente gli step in base ai prodotti selezionati
                            const steps = [
                                {num: 1, label: 'Dati Cliente'},
                                {num: 2, label: 'Prodotti + Muro'}
                            ];
                            
                            // Aggiungi solo gli step dei prodotti selezionati
                            if (project.prodotti?.infissi) steps.push({num: 3, label: 'Config. Infissi'});
                            if (project.prodotti?.persiane) steps.push({num: 4, label: 'Config. Persiane'});
                            if (project.prodotti?.tapparelle) steps.push({num: 5, label: 'Config. Tapparelle'});
                            if (project.prodotti?.zanzariere) steps.push({num: 6, label: 'Config. Zanzariere'});
                            if (project.prodotti?.cassonetti) steps.push({num: 7, label: 'Config. Cassonetti'});
                            // üö™ v5.08: Blindate e Portoncini NON hanno pi√π config globale
                            // Si configurano direttamente nella posizione
                            
                            // Step finale sempre presente
                            steps.push({num: 8, label: 'Posizioni'});
                            
                            return steps.map((step, idx) => `
                                <div class="flex flex-col items-center cursor-pointer flex-shrink-0" onclick="changeSetupStep(${step.num})">
                                    <div class="step-indicator ${state.setupStep === step.num ? 'active' : state.setupStep > step.num ? 'completed' : 'bg-gray-200'}">
                                        ${state.setupStep > step.num ? '‚úì' : (idx + 1)}
                                    </div>
                                    <span class="text-xs mt-1 ${state.setupStep === step.num ? 'font-bold' : ''} whitespace-nowrap">${step.label}</span>
                                </div>
                            `).join('<div class="flex-1 border-t-2 border-gray-200 -mt-4 mx-2"></div>');
                        })()}
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        ${state.setupStep === 1 ? renderStep1ClientData(project) :
                          state.setupStep === 2 ? renderStep2Products(project) :
                          state.setupStep === 3 ? renderStep3ConfigInfissi(project) :
                          state.setupStep === 4 ? renderStep4ConfigPersiane(project) :
                          state.setupStep === 5 ? renderStep5ConfigTapparelle(project) :
                          state.setupStep === 6 ? renderStep6ConfigZanzariere(project) :
                          state.setupStep === 7 ? renderStep7ConfigCassonetti(project) :
                          renderStep8Positions(project)}
                        
                        <div class="flex justify-between mt-6 pt-4 border-t">
                            <button onclick="goToPrevStep('${project.id}')" 
                                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 ${state.setupStep === 1 ? 'invisible' : ''}">
                                ‚Üê Indietro
                            </button>
                            ${state.setupStep < 8 ? `
                                <button onclick="goToNextStep('${project.id}')" 
                                        class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg">
                                    Avanti ‚Üí
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep1ClientData(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üë§</span> Dati Cliente e Progetto
                    </h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nome Progetto</label>
                            <input type="text" value="${project.name}" 
                                   onchange="updateProject('${project.id}', 'name', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">
                                Cliente <span style="color: #ef4444; font-weight: 700;">*</span>
                            </label>
                            <input type="text" value="${project.client}" 
                                   onchange="updateProject('${project.id}', 'client', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                                   required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Piano</label>
                            ${(() => {
                                const pianoOptions = ['Piano Seminterrato', 'Piano Terra', 'Piano Rialzato', 'Primo Piano', 'Secondo Piano', 'Terzo Piano', 'Quarto Piano', 'Quinto Piano', 'Attico', 'Mansarda'];
                                const currentPiano = project.clientData?.piano || '';
                                const isCustom = currentPiano && !pianoOptions.includes(currentPiano);
                                const selectId = `piano-select-${project.id}`;
                                const inputId = `piano-input-${project.id}`;
                                
                                return `
                                    <select id="${selectId}" 
                                            onchange="
                                                const input = document.getElementById('${inputId}');
                                                if (this.value === '__ALTRO__') {
                                                    input.style.display = 'block';
                                                    input.focus();
                                                } else if (this.value) {
                                                    input.style.display = 'none';
                                                    input.value = '';
                                                    updateClientData('${project.id}', 'piano', this.value);
                                                }
                                            "
                                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">Seleziona piano...</option>
                                        ${pianoOptions.map(opt => `
                                            <option value="${opt}" ${currentPiano === opt ? 'selected' : ''}>${opt}</option>
                                        `).join('')}
                                        <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                    </select>
                                    <input type="text" 
                                           id="${inputId}"
                                           value="${isCustom ? currentPiano : ''}"
                                           onchange="updateClientData('${project.id}', 'piano', this.value)"
                                           placeholder="Inserisci piano personalizzato..."
                                           style="display: ${isCustom ? 'block' : 'none'};"
                                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 mt-2">
                                `;
                            })()}
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Citt√†</label>
                            <input type="text" placeholder="Milano" 
                                   value="${project.clientData?.citta || ''}"
                                   oninput="updateClientData('${project.id}', 'citta', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Via/Indirizzo</label>
                            <input type="text" placeholder="Via Roma, 1" 
                                   value="${project.clientData?.via || ''}"
                                   oninput="updateClientData('${project.id}', 'via', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Telefono</label>
                            <input type="tel" placeholder="+39 333 1234567" 
                                   value="${project.clientData?.telefono || ''}"
                                   oninput="updateClientData('${project.id}', 'telefono', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" placeholder="cliente@email.com" 
                                   value="${project.clientData?.email || ''}"
                                   oninput="updateClientData('${project.id}', 'email', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Note</label>
                            <input type="text" placeholder="Note aggiuntive..." 
                                   value="${project.clientData?.note || ''}"
                                   oninput="updateClientData('${project.id}', 'note', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    ${(() => {
                        // ‚úÖ Suggerimento se mancano dati opzionali
                        const missingFields = [];
                        if (!project.clientData?.telefono) missingFields.push('Telefono');
                        if (!project.clientData?.email) missingFields.push('Email');
                        if (!project.clientData?.via && !project.clientData?.citta) missingFields.push('Indirizzo');
                        
                        if (missingFields.length > 0) {
                            return `
                                <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px;">
                                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                                        <span style="font-size: 1.5rem;">üí°</span>
                                        <div>
                                            <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">
                                                Suggerimento
                                            </div>
                                            <div style="color: #78350f; font-size: 0.875rem;">
                                                Compila <strong>${missingFields.join(', ')}</strong> per avere un report pi√π completo
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    })()}
                </div>
            `;
        }

        function renderStep2Products(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üõ†Ô∏è</span> Seleziona i Prodotti da Installare
                    </h2>
                    <p class="text-gray-600 mb-4">Seleziona quali prodotti verranno installati in questo progetto:</p>
                    
                    <div class="flex flex-wrap gap-4">
                        <label class="product-pill ${project.prodotti?.infissi ? 'selected bg-blue-50 border-blue-500 text-blue-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.infissi ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'infissi', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">ü™ü</span>
                            <div>
                                <div class="font-semibold">Infissi</div>
                                <div class="text-xs opacity-75">Finestre e porte</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.persiane ? 'selected bg-purple-50 border-purple-500 text-purple-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.persiane ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'persiane', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">üö™</span>
                            <div>
                                <div class="font-semibold">Persiane</div>
                                <div class="text-xs opacity-75">Persiane e scuri</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.tapparelle ? 'selected bg-amber-50 border-amber-500 text-amber-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.tapparelle ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'tapparelle', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">üéöÔ∏è</span>
                            <div>
                                <div class="font-semibold">Tapparelle</div>
                                <div class="text-xs opacity-75">Avvolgibili</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.zanzariere ? 'selected bg-green-50 border-green-500 text-green-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.zanzariere ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'zanzariere', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">ü¶ü</span>
                            <div>
                                <div class="font-semibold">Zanzariere</div>
                                <div class="text-xs opacity-75">Protezione insetti</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.cassonetti ? 'selected bg-orange-50 border-orange-500 text-orange-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.cassonetti ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'cassonetti', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">üì¶</span>
                            <div>
                                <div class="font-semibold">Cassonetti</div>
                                <div class="text-xs opacity-75">Cassonetti avvolgibili</div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- üí° INFO: Portoncini e Blindate si configurano direttamente nella posizione -->
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-blue-700 text-sm">
                            üí° <strong>Portoncini Finstral</strong> e <strong>Porte Blindate Oikos</strong> si configurano direttamente nella singola posizione (tipo "Ingresso")
                        </p>
                    </div>

                    ${Object.values(project.prodotti || {}).some(v => v) ? `
                        <div class="mt-6 p-4 bg-green-50 border border-green-300 rounded-lg">
                            <p class="text-green-700 font-medium">
                                ‚úÖ Hai selezionato: ${Object.entries(project.prodotti || {})
                                    .filter(([k,v]) => v)
                                    .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))
                                    .join(', ')}
                            </p>
                        </div>
                    ` : `
                        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                            <p class="text-yellow-700">‚ö†Ô∏è Seleziona almeno un prodotto per continuare</p>
                        </div>
                    `}
                    
                    <!-- üóø SEZIONE MURO INTEGRATA -->
                    <div class="mt-8 pt-8 border-t-2 border-gray-200">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <span class="text-2xl">üóø</span> Caratteristiche Muro (Misure in mm)
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs font-medium">Prof. Muro Int</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profMuroInt || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Prof. Piana Sopra</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Prof. Piana Sotto</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Telaio Prof</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Telaio Largh</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Guida Esistente?</label>
                                <select id="guida-select-${project.id}" 
                                        onchange="updateGuidaEsistente('${project.id}', this.value)"
                                        class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="si" ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                    <option value="no" ${project.caratteristicheMuro?.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                            
                            <div id="guida-fields-${project.id}" style="display: ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'block' : 'none'}">
                                <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded">
                                    <div>
                                        <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.profDistanziale || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'profDistanziale', this.value)"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.profGuida || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'profGuida', this.value)"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.larghezzaGuida || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'larghezzaGuida', this.value)"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Prof. Muro Est.</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profMuroEst || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                                           class="w-full px-3 py-2 border rounded-lg">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-1">Battuta Superiore con Tapparella</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.battutaSuperioreTapparella || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'battutaSuperioreTapparella', this.value)"
                                           class="w-full px-3 py-2 border rounded-lg">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Falso Esistente?</label>
                                <select id="falso-select-${project.id}"
                                        onchange="updateFalsoEsistente('${project.id}', this.value)"
                                        class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="si" ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                    <option value="no" ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                            
                            <div id="falso-si-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'block' : 'none'}">
                                <div class="bg-orange-50 p-3 rounded space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.spessoreFalso || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'spessoreFalso', this.value)"
                                               class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.distanzaFalsoInfisso || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'distanzaFalsoInfisso', this.value)"
                                               class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="falso-no-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'block' : 'none'}">
                                <div class="bg-purple-50 p-3 rounded">
                                    <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.distanzaMuroInfisso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'distanzaMuroInfisso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                            
                            <!-- ‚úÖ NUOVO: Dislivello Piana DEFAULT FINESTRE (F) -->
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mt-4">
                                <h3 class="text-sm font-bold text-blue-800 mb-3">üìê Dislivello Piana - FINESTRE (F) - Default</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium mb-2">C'√® dislivello?</label>
                                        <div class="flex gap-4">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="dislivelloFinestre-${project.id}" value="no"
                                                       ${!project.caratteristicheMuro?.dislivelloPianaFinestre?.presente ? 'checked' : ''}
                                                       onchange="updateDislivelloDefault('${project.id}', 'finestre', 'presente', false)"
                                                       class="mr-2">
                                                <span class="text-sm">Nessun dislivello</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="dislivelloFinestre-${project.id}" value="si"
                                                       ${project.caratteristicheMuro?.dislivelloPianaFinestre?.presente ? 'checked' : ''}
                                                       onchange="updateDislivelloDefault('${project.id}', 'finestre', 'presente', true)"
                                                       class="mr-2">
                                                <span class="text-sm">Dislivello presente</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="dislivelloFinestreFields-${project.id}" 
                                         style="display: ${project.caratteristicheMuro?.dislivelloPianaFinestre?.presente ? 'block' : 'none'}">
                                        <div class="space-y-2">
                                            <div>
                                                <label class="block text-xs font-medium mb-1">Piana pi√π alta:</label>
                                                <div class="flex gap-4">
                                                    <label class="inline-flex items-center">
                                                        <input type="radio" name="pianaAltaFinestre-${project.id}" value="interna"
                                                               ${project.caratteristicheMuro?.dislivelloPianaFinestre?.pianaAlta === 'interna' ? 'checked' : ''}
                                                               onchange="updateDislivelloDefault('${project.id}', 'finestre', 'pianaAlta', 'interna')"
                                                               class="mr-2">
                                                        <span class="text-sm">üè† Interna</span>
                                                    </label>
                                                    <label class="inline-flex items-center">
                                                        <input type="radio" name="pianaAltaFinestre-${project.id}" value="esterna"
                                                               ${project.caratteristicheMuro?.dislivelloPianaFinestre?.pianaAlta === 'esterna' ? 'checked' : ''}
                                                               onchange="updateDislivelloDefault('${project.id}', 'finestre', 'pianaAlta', 'esterna')"
                                                               class="mr-2">
                                                        <span class="text-sm">üåç Esterna</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium mb-1">Dislivello (mm):</label>
                                                <input type="number" placeholder="0" min="0"
                                                       value="${project.caratteristicheMuro?.dislivelloPianaFinestre?.valore || ''}"
                                                       onchange="updateDislivelloDefault('${project.id}', 'finestre', 'valore', this.value)"
                                                       class="w-32 px-2 py-1 border rounded text-sm">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‚úÖ NUOVO: Dislivello Piana DEFAULT PORTE-FINESTRE (PF) -->
                            <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg mt-4">
                                <h3 class="text-sm font-bold text-amber-800 mb-3">üìê Dislivello Piana - PORTE-FINESTRE (PF) - Default</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium mb-2">C'√® dislivello?</label>
                                        <div class="flex gap-4">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="dislivelloPF-${project.id}" value="no"
                                                       ${!project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.presente ? 'checked' : ''}
                                                       onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'presente', false)"
                                                       class="mr-2">
                                                <span class="text-sm">Nessun dislivello</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="dislivelloPF-${project.id}" value="si"
                                                       ${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.presente ? 'checked' : ''}
                                                       onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'presente', true)"
                                                       class="mr-2">
                                                <span class="text-sm">Dislivello presente</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="dislivelloPFFields-${project.id}" 
                                         style="display: ${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.presente ? 'block' : 'none'}">
                                        <div class="space-y-2">
                                            <div>
                                                <label class="block text-xs font-medium mb-1">Piana pi√π alta:</label>
                                                <div class="flex gap-4">
                                                    <label class="inline-flex items-center">
                                                        <input type="radio" name="pianaAltaPF-${project.id}" value="interna"
                                                               ${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.pianaAlta === 'interna' ? 'checked' : ''}
                                                               onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'pianaAlta', 'interna')"
                                                               class="mr-2">
                                                        <span class="text-sm">üè† Interna</span>
                                                    </label>
                                                    <label class="inline-flex items-center">
                                                        <input type="radio" name="pianaAltaPF-${project.id}" value="esterna"
                                                               ${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.pianaAlta === 'esterna' ? 'checked' : ''}
                                                               onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'pianaAlta', 'esterna')"
                                                               class="mr-2">
                                                        <span class="text-sm">üåç Esterna</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium mb-1">Dislivello (mm):</label>
                                                <input type="number" placeholder="0" min="0"
                                                       value="${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.valore || ''}"
                                                       onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'valore', this.value)"
                                                       class="w-32 px-2 py-1 border rounded text-sm">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // üÜï FASE 13 - Render Rilievo Globale per Prodotto
        function renderRilievoGlobale(project, productType, productLabel, icon) {
            const rilievo = getRilievoGlobale(project, productType);
            console.log(`üé® renderRilievoGlobale - ${productType}:`, rilievo);
            const completeness = calculateRilievoGlobaleCompleteness(project, productType);
            const hasInfissi = productType === 'infissi';
            
            return `
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-300 rounded-lg p-4 shadow-md mt-4">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                ${icon} üìã RILIEVO PREESISTENTE - ${productLabel}
                            </h3>
                            <p class="text-xs text-gray-600 mt-1">Compila tutte le informazioni per evitare dimenticanze</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center gap-2">
                                <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="bg-purple-500 h-full transition-all duration-500" 
                                         style="width: ${completeness.percentage}%"></div>
                                </div>
                                <span class="text-sm font-bold">${completeness.percentage}%</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${completeness.completed}/${completeness.total} campi</p>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- 1. MATERIALE -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                                üîß Materiale
                                ${!rilievo.materiale || rilievo.materiale.trim() === '' ? '<span class="text-red-600">‚óè</span>' : '<span class="text-green-600">‚úì</span>'}
                            </label>
                            
                            ${(() => {
                                const options = ['Legno', 'PVC', 'Alluminio', 'Ferro', 'Acciaio'];
                                const isCustom = rilievo.materiale && !options.includes(rilievo.materiale);
                                const isEmpty = !rilievo.materiale || rilievo.materiale.trim() === '';
                                
                                return `
                                    <!-- Select principale -->
                                    <select 
                                        class="w-full px-3 py-2 border-2 rounded-lg ${isEmpty ? 'border-red-300 bg-red-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500" 
                                        onchange="handleSelectCustomChange('materiale', this, '${project.id}', '', '${productType}')">
                                        <option value="">‚ñº Seleziona...</option>
                                        ${options.map(opt => `
                                            <option value="${opt}" ${rilievo.materiale === opt ? 'selected' : ''}>${opt}</option>
                                        `).join('')}
                                        <option value="__custom__" ${isCustom ? 'selected' : ''} class="text-blue-600 font-semibold">üñäÔ∏è Scrivi manualmente</option>
                                    </select>
                                    
                                    <!-- Input custom -->
                                    <input type="text" 
                                           class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg mt-2 bg-blue-50 focus:ring-2 focus:ring-blue-500" 
                                           id="materiale_custom_${project.id}_config_${productType}"
                                           placeholder="‚úèÔ∏è Scrivi valore personalizzato..."
                                           value="${isCustom ? rilievo.materiale : ''}"
                                           style="display: ${isCustom ? 'block' : 'none'};"
                                           oninput="updateRilievoGlobale('${project.id}', '${productType}', 'materiale', this.value)">
                                `;
                            })()}
                        </div>
                        
                        <!-- 2. NOTE AGGIUNTIVE -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                                üìù Note
                            </label>
                            <input type="text" 
                                   value="${rilievo.note || ''}"
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'note', this.value)"
                                   placeholder="Note aggiuntive..."
                                   class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="grid ${hasInfissi ? 'md:grid-cols-4' : 'md:grid-cols-2'} gap-4 mt-4 pt-4 border-t-2 border-gray-200">
                        <!-- CHECKBOX: TOGLIERE -->
                        <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.togliere ? 'border-orange-300' : 'border-gray-200'}">
                            <input type="checkbox" 
                                   id="togliere-${productType}-${project.id}"
                                   ${rilievo.togliere ? 'checked' : ''}
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'togliere', this.checked)"
                                   class="w-5 h-5 text-orange-600 rounded focus:ring-2 focus:ring-orange-500">
                            <label for="togliere-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                üî® Da togliere?
                                ${rilievo.togliere ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                            </label>
                        </div>
                        
                        <!-- CHECKBOX: SMALTIMENTO -->
                        <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.smaltimento ? 'border-red-300' : 'border-gray-200'}">
                            <input type="checkbox" 
                                   id="smaltimento-${productType}-${project.id}"
                                   ${rilievo.smaltimento ? 'checked' : ''}
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'smaltimento', this.checked)"
                                   class="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500">
                            <label for="smaltimento-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                üóëÔ∏è Da smaltire?
                                ${rilievo.smaltimento ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                            </label>
                        </div>
                        
                        ${hasInfissi ? `
                            <!-- CHECKBOX: COPRIFILI INT (solo per Infissi) -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.coprifiliInt ? 'border-blue-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="coprifiliInt-${productType}-${project.id}"
                                       ${rilievo.coprifiliInt ? 'checked' : ''}
                                       onchange="updateRilievoGlobale('${project.id}', '${productType}', 'coprifiliInt', this.checked)"
                                       class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                <label for="coprifiliInt-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    üìè Coprifili INT?
                                    ${rilievo.coprifiliInt ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                </label>
                            </div>
                            
                            <!-- CHECKBOX: COPRIFILI EST (solo per Infissi) -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.coprifiliEst ? 'border-purple-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="coprifiliEst-${productType}-${project.id}"
                                       ${rilievo.coprifiliEst ? 'checked' : ''}
                                       onchange="updateRilievoGlobale('${project.id}', '${productType}', 'coprifiliEst', this.checked)"
                                       class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                                <label for="coprifiliEst-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    üìê Coprifili EST?
                                    ${rilievo.coprifiliEst ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                </label>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${completeness.percentage < 100 ? `
                        <div class="mt-3 p-2 bg-amber-100 border border-amber-300 rounded text-sm text-amber-800">
                            ‚ö†Ô∏è <strong>Attenzione:</strong> Compila tutti i campi per evitare dimenticanze!
                        </div>
                    ` : `
                        <div class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-800">
                            ‚úÖ <strong>Perfetto!</strong> Tutte le informazioni del rilievo sono complete.
                        </div>
                    `}
                </div>
            `;
        }

        function renderBRMConfig(project, productType, productLabel, icon) {
            const configKey = `brmConfig${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const config = project[configKey] || { 
                misuraBaseL: '', operazioneL: '-', valoreL: '0',
                misuraBaseH: '', operazioneH: '-', valoreH: '0',
                misuraBaseB: '', operazioneB: '-', valoreB: '0',
                misuraBaseC: '', operazioneC: '-', valoreC: '0',
                note: '' 
            };
            
            // Misure di larghezza specifiche per cassonetti o generiche
            let misureLarghezza = ['LF', 'LVT', 'LVAR', 'TMV', 'LS'];
            let misureAltezza = ['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'];
            let misureLarghezzaPF = ['LPF', 'LVT', 'LVAR', 'TMV', 'LS'];
            let misureAltezzaPF = ['HPF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'];
            
            // Misure B e C (solo per cassonetti)
            let misureB = ['Prof. Muro Int ‚Üí MI', 'B'];
            let misureC = ['Prof. Muro Int ‚Üí MI', 'C'];
            
            if (productType === 'cassonetti') {
                // ‚úÖ MISURE SPECIFICHE PER CASSONETTI (secondo schema)
                misureLarghezza = ['(LS+SRSX+SRDX)', 'LVT', 'LF', 'TMV', 'BRM_L_INFISSO'];
                misureAltezza = ['HCASS', 'H Soffitto', 'H Parapetto/Soffitto', 'BRM_H_INFISSO'];
            }
            
            // Decide se mostrare campi aggiuntivi per portafinestra
            const showPortafinestra = (productType === 'infissi' || productType === 'zanzariere');
            
            return `
                <div class="brm-calculator mt-6 p-4">
                    <h3 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
                        <span class="text-xl">${icon}</span>
                        üìè Calcolo BRM per ${productLabel}
                        ${productType === 'cassonetti' ? '<span class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded">‚úÖ Misure Specifiche Cassonetti</span>' : ''}
                        ${showPortafinestra ? '<span class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded">ü™ü Finestra / Portafinestra</span>' : ''}
                    </h3>
                    
                    <!-- BRM FINESTRA -->
                    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3 mb-4">
                        <h4 class="font-bold text-green-800 mb-3">ü™ü BRM FINESTRA ${showPortafinestra && productType === 'zanzariere' ? '(F1, F2, F3, FISSO)' : productType === 'infissi' ? '(F1, F2, F3, FISSO)' : ''}</h4>
                        <div class="grid ${productType === 'zanzariere' ? 'md:grid-cols-2' : 'md:grid-cols-2'} gap-4">
                            ${productType === 'zanzariere' ? `
                                <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                                    <h5 class="font-semibold text-amber-800 mb-2 text-sm">üìê BRM Larghezza Finestra</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL', this.value)"
                                                    class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${misureLarghezza.map(m => `
                                                    <option value="${m}" ${config.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL', this.value)"
                                                    class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                                <option value="+" ${config.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${config.operazioneL === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                            <input type="number" value="${config.valoreL || '0'}"
                                                   onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL', this.value)"
                                                   class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="brm-result text-xs">
                                        ${config.misuraBaseL ? `üìè BRM L = ${config.misuraBaseL} ${config.operazioneL} ${config.valoreL}mm` : 'Seleziona misura'}
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                                    <h5 class="font-semibold text-amber-800 mb-2">üìê BRM Larghezza</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL', this.value)"
                                                    class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${misureLarghezza.map(m => `
                                                    <option value="${m}" ${config.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL', this.value)"
                                                    class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                                <option value="+" ${config.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${config.operazioneL === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                            <input type="number" value="${config.valoreL || '0'}"
                                                   onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL', this.value)"
                                                   class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="brm-result">
                                        ${config.misuraBaseL ? `üìè BRM L = ${config.misuraBaseL} ${config.operazioneL} ${config.valoreL}mm` : 'Seleziona misura'}
                                    </div>
                                </div>
                            `}
                            
                            <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                                <h5 class="font-semibold text-amber-800 mb-2 ${productType === 'zanzariere' ? 'text-sm' : ''}">üìê BRM Altezza ${showPortafinestra ? 'Finestra' : ''}</h5>
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <div>
                                        <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                        <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseH', this.value)"
                                                class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                            <option value="">-</option>
                                            ${misureAltezza.map(m => `
                                                <option value="${m}" ${config.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                        <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneH', this.value)"
                                                class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                            <option value="+" ${config.operazioneH === '+' ? 'selected' : ''}>+</option>
                                            <option value="-" ${config.operazioneH === '-' ? 'selected' : ''}>-</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                        <input type="number" value="${config.valoreH || '0'}"
                                               onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreH', this.value)"
                                               class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                    </div>
                                </div>
                                <div class="brm-result ${productType === 'zanzariere' ? 'text-xs' : ''}">
                                    ${config.misuraBaseH ? `üìè BRM H = ${config.misuraBaseH} ${config.operazioneH} ${config.valoreH}mm` : 'Seleziona misura'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BRM PORTAFINESTRA (solo per infissi e zanzariere) -->
                    ${showPortafinestra ? `
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3 mb-4">
                            <h4 class="font-bold text-blue-800 mb-3">üö™ BRM PORTAFINESTRA (PF1, PF2, PF3)</h4>
                            <div class="grid ${productType === 'zanzariere' ? 'md:grid-cols-2' : 'md:grid-cols-1'} gap-4">
                                ${productType === 'zanzariere' ? `
                                    <div class="bg-white p-3 rounded-lg border-2 border-blue-400">
                                        <h5 class="font-semibold text-blue-800 mb-2 text-sm">üìê BRM Larghezza Portafinestra</h5>
                                        <div class="grid grid-cols-3 gap-2 mb-2">
                                            <div>
                                                <label class="text-xs font-medium text-blue-800 block mb-1">Misura</label>
                                                <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL_PF', this.value)"
                                                        class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                                    <option value="">-</option>
                                                    ${misureLarghezzaPF.map(m => `
                                                        <option value="${m}" ${config.misuraBaseL_PF === m ? 'selected' : ''}>${m}</option>
                                                    `).join('')}
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-xs font-medium text-blue-800 block mb-1">Op.</label>
                                                <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL_PF', this.value)"
                                                        class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                                    <option value="+" ${config.operazioneL_PF === '+' ? 'selected' : ''}>+</option>
                                                    <option value="-" ${(config.operazioneL_PF === '-' || !config.operazioneL_PF) ? 'selected' : ''}>-</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-xs font-medium text-blue-800 block mb-1">mm</label>
                                                <input type="number" value="${config.valoreL_PF || '0'}"
                                                       onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL_PF', this.value)"
                                                       class="w-full px-2 py-1 border border-blue-500 rounded text-sm">
                                            </div>
                                        </div>
                                        <div class="brm-result text-xs">
                                            ${config.misuraBaseL_PF ? `üìè BRM L PF = ${config.misuraBaseL_PF} ${config.operazioneL_PF || '-'} ${config.valoreL_PF || '0'}mm` : 'Seleziona misura'}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="bg-white p-3 rounded-lg border-2 border-blue-400">
                                    <h5 class="font-semibold text-blue-800 mb-2 ${productType === 'zanzariere' ? 'text-sm' : ''}">üìê BRM Altezza Portafinestra</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs font-medium text-blue-800 block mb-1">Misura</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseH_PF', this.value)"
                                                    class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${misureAltezzaPF.map(m => `
                                                    <option value="${m}" ${config.misuraBaseH_PF === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-blue-800 block mb-1">Op.</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneH_PF', this.value)"
                                                    class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                                <option value="+" ${config.operazioneH_PF === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${(config.operazioneH_PF === '-' || !config.operazioneH_PF) ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-blue-800 block mb-1">mm</label>
                                            <input type="number" value="${config.valoreH_PF || '0'}"
                                                   onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreH_PF', this.value)"
                                                   class="w-full px-2 py-1 border border-blue-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="brm-result ${productType === 'zanzariere' ? 'text-xs' : ''}">
                                        ${config.misuraBaseH_PF ? `üìè BRM H PF = ${config.misuraBaseH_PF} ${config.operazioneH_PF || '-'} ${config.valoreH_PF || '0'}mm` : 'Seleziona misura'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- BRM B e C (solo per cassonetti) -->
                    ${productType === 'cassonetti' ? `
                        <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-3 mb-4">
                            <h4 class="font-bold text-purple-800 mb-3">üì¶ BRM PROFONDIT√Ä CASSONETTO</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <!-- BRM B -->
                                <div class="bg-white p-3 rounded-lg border-2 border-purple-400">
                                    <h5 class="font-semibold text-purple-800 mb-2">üìê BRM B (Profondit√† 1)</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs font-medium text-purple-800 block mb-1">Misura</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseB', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${misureB.map(m => `
                                                    <option value="${m}" ${config.misuraBaseB === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-purple-800 block mb-1">Op.</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneB', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${config.operazioneB === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${(config.operazioneB === '-' || !config.operazioneB) ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-purple-800 block mb-1">mm</label>
                                            <input type="number" value="${config.valoreB || '0'}"
                                                   onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreB', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="brm-result">
                                        ${config.misuraBaseB ? `üìè BRM B = ${config.misuraBaseB} ${config.operazioneB || '-'} ${config.valoreB || '0'}mm` : 'Seleziona misura'}
                                    </div>
                                </div>
                                
                                <!-- BRM C -->
                                <div class="bg-white p-3 rounded-lg border-2 border-purple-400">
                                    <h5 class="font-semibold text-purple-800 mb-2">üìê BRM C (Profondit√† 2)</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs font-medium text-purple-800 block mb-1">Misura</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseC', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${misureC.map(m => `
                                                    <option value="${m}" ${config.misuraBaseC === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-purple-800 block mb-1">Op.</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneC', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${config.operazioneC === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${(config.operazioneC === '-' || !config.operazioneC) ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-purple-800 block mb-1">mm</label>
                                            <input type="number" value="${config.valoreC || '0'}"
                                                   onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreC', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="brm-result">
                                        ${config.misuraBaseC ? `üìè BRM C = ${config.misuraBaseC} ${config.operazioneC || '-'} ${config.valoreC || '0'}mm` : 'Seleziona misura'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div>
                        <label class="block text-xs font-medium text-amber-800 mb-1">üìù Note Formula</label>
                        <textarea onchange="updateBRMConfig('${project.id}', '${configKey}', 'note', this.value)"
                                  placeholder="Es: Tolleranza standard, considerazioni particolari..."
                                  class="w-full px-2 py-1 border border-amber-500 rounded text-sm"
                                  rows="2">${config.note || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function renderStep3ConfigInfissi(project) {
            if (!project.prodotti?.infissi) {
                return `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Gli infissi non sono stati selezionati. Salta questo step.</p>
                    </div>
                `;
            }

            return `
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-2xl">ü™ü</span> Configurazione Infissi Default
                        </h2>
                        <button onclick="forzaSincronizzazioneInfissi('${project.id}')"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg font-medium transition flex items-center gap-2 shadow-lg">
                            üîÑ SINCRONIZZA TUTTO
                        </button>
                    </div>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutti gli infissi:</p>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 text-sm text-blue-800">
                        üí° <strong>Sincronizzazione automatica:</strong> Quando modifichi un valore qui, tutte le posizioni si aggiornano automaticamente (tranne quelle modificate manualmente). 
                        Se hai dati vecchi, clicca <strong>"SINCRONIZZA TUTTO"</strong> per forzare l'aggiornamento.
                    </div>
                    
                    ${renderRilievoGlobale(project, 'infissi', 'Infissi', 'ü™ü')}
                    
                    <div class="space-y-2 mt-4">
                        <div class="grid md:grid-cols-2 gap-2">
                            <!-- 1. AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                project.configInfissi?.azienda || '',
                                ['finstral', 'essepi', 'schuco', 'oknoplast', 'internorm'],
                                project.id,
                                null,
                                'infisso',
                                '1. Azienda'
                            )}

                            <!-- 2. TIPO ANTA -->
                            ${renderSelectWithCustom(
                                'tipoAnta',
                                project.configInfissi?.tipoAnta || '',
                                ['Classic-line', 'Slim-line', 'Slim-line Cristal', 'Slim-line Twin', 'Slim-line Cristal Twin', 'Step-line', 'Step-line Door', 'Nova-line', 'Nova-line Plus', 'Nova-line Twin', 'Nova-line Cristal Twin'],
                                project.id,
                                null,
                                'infisso',
                                '2. Tipo Anta'
                            )}

                            <!-- 3. FINITURA INTERNA -->
                            ${renderSelectWithCustom(
                                'finituraInt',
                                project.configInfissi?.finituraInt || '',
                                ['pvc', 'legno', 'alluminio', 'ceramica'],
                                project.id,
                                null,
                                'infisso',
                                '3. Finitura Interna'
                            )}

                            <!-- 4. FINITURA ESTERNA -->
                            ${renderSelectWithCustom(
                                'finituraEst',
                                project.configInfissi?.finituraEst || '',
                                ['pvc', 'alluminio', 'ceramica'],
                                project.id,
                                null,
                                'infisso',
                                '4. Finitura Esterna'
                            )}

                            <!-- 5. COLORE INTERNO -->
                            ${renderSelectColoreStandard(
                                'coloreInt',
                                project.configInfissi?.coloreInt || '',
                                project.configInfissi?.finituraInt || 'pvc',
                                project.id,
                                null,
                                'infisso',
                                '5. Colore Interno'
                            )}

                            <!-- 6. COLORE ESTERNO -->
                            ${renderSelectColoreStandard(
                                'coloreEst',
                                project.configInfissi?.coloreEst || '',
                                project.configInfissi?.finituraEst || 'pvc',
                                project.id,
                                null,
                                'infisso',
                                '6. Colore Esterno'
                            )}

                            <!-- 7. TELAIO -->
                            ${renderSelectWithCustom(
                                'telaio',
                                project.configInfissi?.telaio || '',
                                ['961', '965', '967', 'Z62', 'Z91', '962', '924', '951'],
                                project.id,
                                null,
                                'infisso',
                                '7. Telaio'
                            )}

                            <!-- 8. ALLARME -->
                            ${renderSelectWithCustom(
                                'allarme',
                                project.configInfissi?.allarme || '',
                                ['si', 'no'],
                                project.id,
                                null,
                                'infisso',
                                '8. Allarme'
                            )}

                            <!-- 9. VETRO -->
                            ${renderSelectWithCustom(
                                'vetro',
                                project.configInfissi?.vetro || '',
                                ['doppio', 'doppio-sat', 'triplo', 'triplo-sat'],
                                project.id,
                                null,
                                'infisso',
                                '9. Vetro'
                            )}

                            <!-- 10. CERNIERE - v4.80 -->
                            ${renderSelectWithCustom(
                                'cerniere',
                                project.configInfissi?.cerniere || '',
                                ['a-vista', 'a-scomparsa'],
                                project.id,
                                null,
                                'infisso',
                                '10. Cerniere'
                            )}

                            <!-- 11. MANIGLIA - SEMPLIFICATO v4.39 -->
                            ${renderSelectWithCustom(
                                'maniglia',
                                project.configInfissi?.maniglia || '',
                                ['601 - STANDARD', '712 - A PRESSIONE', '773 - DOPPIA ANTA/RIBALTA', '772 - DOPPIA ANTA'],
                                project.id,
                                null,
                                'infisso',
                                '11. Maniglia'
                            )}

                            <!-- 12. COLORE MANIGLIA - AGGIORNATO v4.39 -->
                            ${renderSelectWithCustom(
                                'coloreManiglia',
                                project.configInfissi?.coloreManiglia || '',
                                ['01 - BIANCO', '07 - PERLA', '56 - NEUTRO ANODIZZATO', '74 - BRONZO', '40 - OTTONE LUCIDO', '79 - TITANIO', 'M01 - BIANCO', 'M03 - NERO', 'M07 - BIANCO CREMA'],
                                project.id,
                                null,
                                'infisso',
                                '12. Colore Maniglia'
                            )}

                            <!-- 13. TAGLI TELAIO -->
                            ${renderSelectWithCustom(
                                'tagliTelaio',
                                project.configInfissi?.tagliTelaio || '',
                                ['nessuno', 'sopra', 'sotto', 'sopra-sotto', 'dx', 'sx', 'dx-sx', '4-lati', 'sopra-laterali', 'sotto-laterali'],
                                project.id,
                                null,
                                'infisso',
                                '13. Tagli Telaio'
                            )}

                            <!-- 14. COD.TAGLI (Editabili con etichette chiare) -->
                            <div>
                                <label class="block text-base font-bold mb-1 text-gray-800">14. COD.TAGLI</label>
                                ${(() => {
                                    const tagliTelaio = project.configInfissi?.tagliTelaio || '';
                                    // üÜï v4.81: Genera posizioni tagli da tagliTelaio (non pi√π salvato)
                                    const codTagli = getPosizioniTagli(tagliTelaio);
                                    
                                    // Se non ha selezionato nulla, non mostrare niente
                                    if (!tagliTelaio || tagliTelaio === '' || tagliTelaio === 'nessuno' || codTagli.length === 0) {
                                        return '';
                                    }
                                    
                                    // Mappa posizioni con etichette italiane
                                    const labelMap = {
                                        'SOPRA': '‚Üë SOPRA',
                                        'SOTTO': '‚Üì SOTTO',
                                        'SX': '‚Üê SX',
                                        'DX': '‚Üí DX'
                                    };
                                    
                                    // üÜï v4.79: Ottieni codici disponibili per il telaio selezionato
                                    const telaioSelezionato = project.configInfissi?.telaio || '';
                                    const codiciDisponibili = getCodiciTaglioPerTelaio(telaioSelezionato);
                                    const hasCodici = codiciDisponibili.length > 0;
                                    
                                    return `
                                        <div class="grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(110px, 110px));">
                                            ${codTagli.map((etichetta, idx) => {
                                                const codice = project.configInfissi?.codTagliValues?.[idx] || '';
                                                const isEmpty = !codice || codice.trim() === '';
                                                
                                                return `
                                                    <div class="flex flex-col">
                                                        <label class="text-xs font-bold mb-1 text-gray-700">${labelMap[etichetta] || etichetta}</label>
                                                        ${hasCodici ? `
                                                            <select onchange="updateCodTagliValue('${project.id}', ${idx}, this.value)"
                                                                    class="w-full px-2 py-2 border-2 rounded-lg font-mono text-center font-bold text-sm focus:ring-2 focus:ring-purple-500 ${
                                                                        isEmpty ? 'border-orange-400 bg-orange-50' : 'border-purple-400 bg-purple-50'
                                                                    }">
                                                                <option value="">-- Sel. --</option>
                                                                ${codiciDisponibili.map(c => `<option value="${c}" ${codice === c ? 'selected' : ''}>${c}</option>`).join('')}
                                                            </select>
                                                        ` : `
                                                            <input type="text" 
                                                                   value="${codice}"
                                                                   onchange="updateCodTagliValue('${project.id}', ${idx}, this.value)"
                                                                   placeholder="Codice"
                                                                   class="w-full px-2 py-2 border-2 rounded-lg font-mono text-center font-bold text-sm focus:ring-2 focus:ring-purple-500 ${
                                                                       isEmpty ? 'border-orange-400 bg-orange-50' : 'border-purple-400 bg-purple-50'
                                                                   }">
                                                        `}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                        <p class="text-sm text-gray-600 mt-2 font-medium">üí° ${hasCodici ? `Codici disponibili per telaio ${telaioSelezionato}` : 'Seleziona prima un telaio per vedere i codici disponibili'}</p>
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'infissi', 'Infissi', 'ü™ü')}
                </div>
            `;
        }

        function renderStep4ConfigPersiane(project) {
            if (!project.prodotti?.persiane) {
                return `<div class="text-center py-8"><p class="text-gray-500">Le persiane non sono state selezionate. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üö™</span> Configurazione Persiane Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le persiane:</p>
                    
                    ${renderRilievoGlobale(project, 'persiane', 'Persiane', 'üö™')}
                    
                    <div class="space-y-2 mt-4">
                        <div class="grid md:grid-cols-2 gap-2">
                            <!-- 1. AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                project.configPersiane?.azienda || '',
                                ['P. Persiane'],
                                project.id,
                                null,
                                'persiana',
                                '1. Azienda'
                            )}
                            
                            <!-- 2. MODELLO -->
                            ${renderSelectWithCustom(
                                'modello',
                                project.configPersiane?.modello || '',
                                ['Angela', 'Giulia', 'Luna', 'Aurora', 'Alto Adige', 'Alto Adige (R)', 'Cortina', 'Cortina (R)', 'Oscura', 'Oscura (R)', 'Nerina', 'Nerina (R)', 'Scandola', 'Scandola (TT)', 'Scandola Duo', 'Scandola Duo (TT)', 'Oscura Duo', 'Oscura Duo (TT)'],
                                project.id,
                                null,
                                'persiana',
                                '2. Modello'
                            )}
                        </div>
                        
                        <!-- 3. FISSAGGIO -->
                        <div class="grid md:grid-cols-2 gap-4">
                            ${renderSelectWithCustom(
                                'fissaggio',
                                project.configPersiane?.fissaggio || '',
                                ['muro', 'telaio'],
                                project.id,
                                null,
                                'persiana',
                                '3. Fissaggio'
                            )}
                            
                            <!-- 4. TIPO TELAIO (condizionale se FISSAGGIO = telaio) -->
                            <div id="tipo-telaio-persiane-container-${project.id}" 
                                 style="display: ${project.configPersiane?.fissaggio === 'telaio' ? 'block' : 'none'}">
                                ${renderSelectWithCustom(
                                    'tipoTelaio',
                                    project.configPersiane?.tipoTelaio || '',
                                    ['TH10', 'TH40', 'TH41', 'TH45', 'TH46R', 'TH62', 'TH80', 'TH53'],
                                    project.id,
                                    null,
                                    'persiana',
                                    '4. Tipo Telaio'
                                )}
                            </div>
                        </div>
                        
                        <!-- 5. COLORE PERSIANA e 6. COLORE TELAIO -->
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- 5. COLORE PERSIANA -->
                            ${renderSelectWithCustom(
                                'colorePersiana',
                                project.configPersiane?.colorePersiana || '',
                                COLORI_PERSIANE,
                                project.id,
                                null,
                                'persiana',
                                '5. Colore Persiana'
                            )}
                            
                            <!-- COLORE TELAIO (condizionale se FISSAGGIO = telaio) -->
                            <div id="colore-telaio-persiane-container-${project.id}" 
                                 style="display: ${project.configPersiane?.fissaggio === 'telaio' ? 'block' : 'none'}">
                                ${renderSelectWithCustom(
                                    'coloreTelaio',
                                    project.configPersiane?.coloreTelaio || '',
                                    COLORI_PERSIANE,
                                    project.id,
                                    null,
                                    'persiana',
                                    '6. Colore Telaio'
                                )}
                            </div>
                        </div>
                        
                        <!-- 7. BATTUTA -->
                        <div>
                            ${renderSelectWithCustom(
                                'battuta',
                                project.configPersiane?.battuta || '',
                                ['3 LATI', '4 LATI', '2 LATI LATERALI'],
                                project.id,
                                null,
                                'persiana',
                                '7. Battuta'
                            )}
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'persiane', 'Persiane', 'üö™')}
                </div>
            `;
        }

        function renderStep5ConfigTapparelle(project) {
            if (!project.prodotti?.tapparelle) {
                return `<div class="text-center py-8"><p class="text-gray-500">Le tapparelle non sono state selezionate. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üéöÔ∏è</span> Configurazione Tapparelle Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le tapparelle:</p>
                    
                    ${renderRilievoGlobale(project, 'tapparelle', 'Tapparelle', 'üéöÔ∏è')}
                    
                    <div class="space-y-2 mt-4">
                        <div class="grid md:grid-cols-2 gap-2">
                            <!-- 1. AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                project.configTapparelle?.azienda || '',
                                ['Plasticino', 'New solar', 'Estella'],
                                project.id,
                                null,
                                'tapparella',
                                '1. Azienda'
                            )}
                            
                            <!-- 2. MODELLO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Modello</label>
                                <input type="text" 
                                       id="config-tap-modello-${project.id}"
                                       value="${project.configTapparelle?.modello || ''}"
                                       placeholder="Seleziona modello"
                                       list="config-modello-tap-list-${project.id}"
                                       onchange="updateConfigTapparelle('${project.id}', 'modello', this.value); updateColoriTapparellaDatalistConfig('${project.id}', this.value);"
                                       class="w-full px-3 py-2 border rounded-lg">
                                <datalist id="config-modello-tap-list-${project.id}">
                                    <option value="TA01 - Tipo ALUPROFIL MD 13x55">
                                    <option value="TA25 - Tipo ALUPROFIL AD 13x55">
                                    <option value="TA15 - Tipo STEELPROFIL 13x55">
                                    <option value="A01 - Tipo ANTIGRANDINE 14x50">
                                    <option value="A10 - Tipo PESANTE 14x50">
                                    <option value="A16 - Tipo MINI 10 11x32">
                                    <option value="A15 - Tipo MINI 8 8x33">
                                    <option value="TA10 - Tipo ALUBLIND 13x45">
                                    <option value="TA13 - Tipo ALUBLIND 9x27">
                                    <option value="A18 - Tipo COMBI 13x53">
                                    <option value="A20 - Tipo COMBI 10x39">
                                    <option value="A40 - Tipo ORIENTA">
                                    <option value="A50 - Tipo ESTELLA CLASSIC (A)">
                                    <option value="A50 - Tipo ESTELLA CLASSIC (B)">
                                </datalist>
                            </div>
                            
                            <!-- 3. COLORE TELO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Colore Telo</label>
                                <input type="text" placeholder="Seleziona colore"
                                       id="config-tap-colore-${project.id}"
                                       value="${project.configTapparelle?.colore || ''}"
                                       list="config-colore-tap-list-${project.id}"
                                       onchange="updateConfigTapparelle('${project.id}', 'colore', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                                <datalist id="config-colore-tap-list-${project.id}">
                                    ${(() => {
                                        const colori = getColoriTapparella(project.configTapparelle?.modello);
                                        return colori.map(c => `<option value="${c}">`).join('\n');
                                    })()}
                                </datalist>
                            </div>
                            
                            <!-- 4. SOSTITUZIONE COMPONENTI -->
                            ${renderSostituzioneComponentiConfig(project.id, project.configTapparelle)}
                            
                            <!-- 5. TIPO TAPPARELLA (3 OPZIONI SEMPRE VISIBILI) -->
                            <div class="col-span-2">
                                <label class="block text-sm font-medium mb-2">5. Tipo Tapparella</label>
                                <div class="space-y-3">
                                    <!-- Opzione 1: Manuale -->
                                    <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${(!project.configTapparelle?.nuovaAutomazione || project.configTapparelle?.nuovaAutomazione === 'Manuale') ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">
                                        <input type="radio" 
                                               name="nuovaAuto-${project.id}" 
                                               id="manuale-${project.id}"
                                               ${(!project.configTapparelle?.nuovaAutomazione || project.configTapparelle?.nuovaAutomazione === 'Manuale') ? 'checked' : ''}
                                               onchange="updateConfigTapparelle('${project.id}', 'nuovaAutomazione', 'Manuale'); updateConfigTapparelle('${project.id}', 'forniMotore', false); updateConfigTapparelle('${project.id}', 'modelloMotore', ''); render();"
                                               class="w-4 h-4">
                                        <label for="manuale-${project.id}" class="font-semibold cursor-pointer flex-1">
                                            üñêÔ∏è Manuale
                                        </label>
                                    </div>
                                    
                                    <!-- Opzione 2: Motore esistente (riutilizzo) -->
                                    <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${project.configTapparelle?.nuovaAutomazione === 'Motore esistente' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">
                                        <input type="radio" 
                                               name="nuovaAuto-${project.id}" 
                                               id="motoreEsist-${project.id}"
                                               ${project.configTapparelle?.nuovaAutomazione === 'Motore esistente' ? 'checked' : ''}
                                               onchange="updateConfigTapparelle('${project.id}', 'nuovaAutomazione', 'Motore esistente'); updateConfigTapparelle('${project.id}', 'forniMotore', false); updateConfigTapparelle('${project.id}', 'modelloMotore', ''); render();"
                                               class="w-4 h-4">
                                        <label for="motoreEsist-${project.id}" class="font-semibold cursor-pointer flex-1">
                                            ‚ôªÔ∏è Motore esistente (riutilizzo)
                                        </label>
                                    </div>
                                    
                                    <!-- Opzione 3: Motorizzata -->
                                    <div class="border-2 rounded-lg ${project.configTapparelle?.nuovaAutomazione === 'Motorizzata' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white'}">
                                        <div class="flex items-center gap-3 p-3">
                                            <input type="radio" 
                                                   name="nuovaAuto-${project.id}" 
                                                   id="motorizzata-${project.id}"
                                                   ${project.configTapparelle?.nuovaAutomazione === 'Motorizzata' ? 'checked' : ''}
                                                   onchange="updateConfigTapparelle('${project.id}', 'nuovaAutomazione', 'Motorizzata'); render();"
                                                   class="w-4 h-4">
                                            <label for="motorizzata-${project.id}" class="font-semibold cursor-pointer flex-1">
                                                ‚ö° Motorizzata
                                            </label>
                                        </div>
                                        
                                        ${project.configTapparelle?.nuovaAutomazione === 'Motorizzata' ? `
                                            <div class="px-3 pb-3 space-y-3 border-t pt-3">
                                                <!-- Checkbox: Forniamo motore? -->
                                                <div class="flex items-center gap-3">
                                                    <input type="checkbox" 
                                                           id="forniMotore-${project.id}"
                                                           ${project.configTapparelle?.forniMotore ? 'checked' : ''}
                                                           onchange="updateConfigTapparelle('${project.id}', 'forniMotore', this.checked); render();"
                                                           class="w-4 h-4">
                                                    <label for="forniMotore-${project.id}" class="font-medium cursor-pointer">
                                                        üîå Forniamo motore
                                                    </label>
                                                </div>
                                                
                                                ${project.configTapparelle?.forniMotore ? `
                                                    <!-- Select Modello Motore -->
                                                    <div class="pl-6">
                                                        <label class="block text-sm font-medium mb-1">Modello motore:</label>
                                                        <select class="w-full px-3 py-2 border rounded-lg"
                                                                onchange="updateConfigTapparelle('${project.id}', 'modelloMotore', this.value)">
                                                            <option value="">Seleziona modello...</option>
                                                            <option value="OXIMO IO" ${project.configTapparelle?.modelloMotore === 'OXIMO IO' ? 'selected' : ''}>OXIMO IO</option>
                                                            <option value="RS100 io Hybrid" ${project.configTapparelle?.modelloMotore === 'RS100 io Hybrid' ? 'selected' : ''}>RS100 io Hybrid</option>
                                                            <option value="LT HELIOS" ${project.configTapparelle?.modelloMotore === 'LT HELIOS' ? 'selected' : ''}>LT HELIOS</option>
                                                            <option value="RS100 SOLAR io" ${project.configTapparelle?.modelloMotore === 'RS100 SOLAR io' ? 'selected' : ''}>RS100 SOLAR io</option>
                                                        </select>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'tapparelle', 'Tapparelle', 'üéöÔ∏è')}
                </div>
            `;
        }

        function renderStep6ConfigZanzariere(project) {
            if (!project.prodotti?.zanzariere) {
                return `<div class="text-center py-8"><p class="text-gray-500">Le zanzariere non sono state selezionate. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ü¶ü</span> Configurazione Zanzariere Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le zanzariere:</p>
                    
                    <div class="space-y-2">
                        <div class="grid md:grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                ${(() => {
                                    const options = ['Palagina', 'Finstral'];
                                    const current = project.configZanzariere?.azienda || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `zanz-azienda-${project.id}`;
                                    const inputId = `zanz-azienda-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'zanzariere', 'azienda', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona azienda...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altra azienda...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigZanzariere('${project.id}', 'azienda', this.value)"
                                               placeholder="Inserisci azienda personalizzata..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Tipo Zanzariera</label>
                                ${(() => {
                                    const options = ['Avvolgibile', 'Pliss√©', 'Battente', 'Scorrevole', 'Fissa'];
                                    const current = project.configZanzariere?.tipo || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `zanz-tipo-${project.id}`;
                                    const inputId = `zanz-tipo-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'zanzariere', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona tipo...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigZanzariere('${project.id}', 'tipo', this.value)"
                                               placeholder="Inserisci tipo personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Colore Telaio</label>
                                <input type="text" value="${project.configZanzariere?.coloreTelaio || ''}"
                                       onchange="updateConfigZanzariere('${project.id}', 'coloreTelaio', this.value)"
                                       placeholder="Es: Bianco, Marrone, RAL 9010"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Tipo Rete</label>
                                ${(() => {
                                    const options = ['Standard', 'Anti-polline', 'Pet-resistant', 'Micro-forata'];
                                    const current = project.configZanzariere?.tipoRete || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `zanz-rete-${project.id}`;
                                    const inputId = `zanz-rete-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'zanzariere', 'tipoRete', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigZanzariere('${project.id}', 'tipoRete', this.value)"
                                               placeholder="Inserisci tipo rete personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'zanzariere', 'Zanzariere', 'ü¶ü')}
                </div>
            `;
        }

        function renderStep7ConfigCassonetti(project) {
            if (!project.prodotti?.cassonetti) {
                return `<div class="text-center py-8"><p class="text-gray-500">I cassonetti non sono stati selezionati. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üì¶</span> Configurazione Cassonetti Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutti i cassonetti:</p>
                    
                    ${renderRilievoGlobale(project, 'cassonetti', 'Cassonetti', 'üì¶')}
                    
                    <div class="space-y-2 mt-4">
                        <div class="grid md:grid-cols-2 gap-2">
                            <!-- 1. AZIENDA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                ${(() => {
                                    const options = ['Finstral', 'Mag√≤', 'Alpac'];
                                    const current = project.configCassonetti?.azienda || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `cass-azienda-${project.id}`;
                                    const inputId = `cass-azienda-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'azienda', '${selectId}', '${inputId}', this.value); render();"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona azienda...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altra azienda...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'azienda', this.value); render();"
                                               placeholder="Inserisci azienda personalizzata..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            ${(() => {
                                const azienda = project.configCassonetti?.azienda || '';
                                
                                // ====== FINSTRAL ======
                                if (azienda === 'Finstral') {
                                    return `
                                        <!-- 2. CASSONETTO (checkbox + text) -->
                                        <div>
                                            <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                                                2. Cassonetto
                                                <input type="checkbox" 
                                                       ${project.configCassonetti?.cassonettoCheck !== false ? 'checked' : ''}
                                                       onchange="updateConfigCassonetti('${project.id}', 'cassonettoCheck', this.checked)"
                                                       class="w-4 h-4">
                                            </label>
                                            <input type="text" 
                                                   value="${project.configCassonetti?.cassonettoText || 'Cassonetto'}"
                                                   onchange="updateConfigCassonetti('${project.id}', 'cassonettoText', this.value)"
                                                   placeholder="Cassonetto"
                                                   class="w-full px-3 py-2 border rounded-lg">
                                        </div>
                                        
                                        <!-- 3. POSA (checkbox + text) -->
                                        <div>
                                            <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                                                3. Posa
                                                <input type="checkbox" 
                                                       ${project.configCassonetti?.posaCheck !== false ? 'checked' : ''}
                                                       onchange="updateConfigCassonetti('${project.id}', 'posaCheck', this.checked)"
                                                       class="w-4 h-4">
                                            </label>
                                            <input type="text" 
                                                   value="${project.configCassonetti?.posaText || 'Frontale'}"
                                                   onchange="updateConfigCassonetti('${project.id}', 'posaText', this.value)"
                                                   placeholder="Frontale"
                                                   class="w-full px-3 py-2 border rounded-lg">
                                        </div>
                                        
                                        <!-- 4. COLORE (auto da infisso + modificabile) -->
                                        <div>
                                            <label class="block text-sm font-medium mb-1">4. Colore</label>
                                            <input type="text" 
                                                   value="${project.configCassonetti?.colore || project.configInfissi?.coloreEsterno || 'Finiture PVC'}"
                                                   onchange="updateConfigCassonetti('${project.id}', 'colore', this.value)"
                                                   placeholder="Finiture PVC"
                                                   class="w-full px-3 py-2 border rounded-lg bg-blue-50">
                                            <p class="text-xs text-gray-500 mt-1">‚ö° Auto-compilato da infisso</p>
                                        </div>
                                        
                                        <!-- 5. AGGIUNGERE ISOLAMENTO POSACLIMA (checkbox) -->
                                        <div>
                                            <label class="block text-sm font-medium mb-2 flex items-center gap-2">
                                                <input type="checkbox" 
                                                       ${project.configCassonetti?.isolamentoPosaclima ? 'checked' : ''}
                                                       onchange="updateConfigCassonetti('${project.id}', 'isolamentoPosaclima', this.checked)"
                                                       class="w-4 h-4">
                                                5. Aggiungere isolamento Posaclima
                                            </label>
                                        </div>
                                        
                                        <!-- 6. A SOFFITTO (checkbox) -->
                                        <div>
                                            <label class="block text-sm font-medium mb-2 flex items-center gap-2">
                                                <input type="checkbox" 
                                                       ${project.configCassonetti?.aSoffitto ? 'checked' : ''}
                                                       onchange="updateConfigCassonetti('${project.id}', 'aSoffitto', this.checked)"
                                                       class="w-4 h-4">
                                                6. A Soffitto
                                            </label>
                                        </div>
                                    `;
                                }
                                
                                // ====== MAG√í E ALPAC ======
                                if (azienda === 'Mag√≤' || azienda === 'Alpac') {
                                    return `
                                        <!-- 2. TIPO -->
                                        <div>
                                            <label class="block text-sm font-medium mb-1">2. Tipo</label>
                                            <select onchange="updateConfigCassonetti('${project.id}', 'tipo', this.value)"
                                                    class="w-full px-3 py-2 border rounded-lg">
                                                <option value="">Seleziona...</option>
                                                <option value="Cassonetto" ${project.configCassonetti?.tipo === 'Cassonetto' ? 'selected' : ''}>Cassonetto</option>
                                                <option value="Monoblocco" ${project.configCassonetti?.tipo === 'Monoblocco' ? 'selected' : ''}>Monoblocco</option>
                                            </select>
                                        </div>
                                        
                                        <!-- 3. POSA -->
                                        <div>
                                            <label class="block text-sm font-medium mb-1">3. Posa</label>
                                            <select onchange="updateConfigCassonetti('${project.id}', 'posa', this.value)"
                                                    class="w-full px-3 py-2 border rounded-lg">
                                                <option value="">Seleziona...</option>
                                                <option value="Frontale" ${project.configCassonetti?.posa === 'Frontale' ? 'selected' : ''}>Frontale</option>
                                                <option value="Rasomuro" ${project.configCassonetti?.posa === 'Rasomuro' ? 'selected' : ''}>Rasomuro</option>
                                                <option value="Esterna dal sotto" ${project.configCassonetti?.posa === 'Esterna dal sotto' ? 'selected' : ''}>Esterna dal sotto</option>
                                                <option value="Interna dal sotto" ${project.configCassonetti?.posa === 'Interna dal sotto' ? 'selected' : ''}>Interna dal sotto</option>
                                            </select>
                                        </div>
                                        
                                        <!-- 4. FINITURA -->
                                        <div>
                                            <label class="block text-sm font-medium mb-1">4. Finitura</label>
                                            <select onchange="updateConfigCassonetti('${project.id}', 'finitura', this.value)"
                                                    class="w-full px-3 py-2 border rounded-lg">
                                                <option value="">Seleziona...</option>
                                                <option value="Grezzo da rasare" ${project.configCassonetti?.finitura === 'Grezzo da rasare' ? 'selected' : ''}>Grezzo da rasare</option>
                                                <option value="Mano di fondo" ${project.configCassonetti?.finitura === 'Mano di fondo' ? 'selected' : ''}>Mano di fondo</option>
                                            </select>
                                        </div>
                                        
                                        <!-- 5 e 6 NASCOSTI -->
                                    `;
                                }
                                
                                // Nessuna azienda selezionata
                                return `
                                    <div class="col-span-2 bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                        <p class="text-sm text-gray-600 text-center">
                                            ‚ö†Ô∏è Seleziona un'azienda per visualizzare i campi specifici
                                        </p>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'cassonetti', 'Cassonetti', 'üì¶')}
                </div>
            `;
        }

        function renderStep8WallFeatures(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üóø</span> Caratteristiche Muro (Misure in mm)
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">Prof. Muro Int</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profMuroInt || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Prof. Piana Sopra</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Prof. Piana Sotto</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Telaio Prof</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Telaio Largh</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Guida Esistente?</label>
                            <select id="guida-select-${project.id}" 
                                    onchange="updateGuidaEsistente('${project.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                <option value="">Seleziona...</option>
                                <option value="si" ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                <option value="no" ${project.caratteristicheMuro?.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        <div id="guida-fields-${project.id}" style="display: ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'block' : 'none'}">
                            <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded">
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profDistanziale || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profDistanziale', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profGuida || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.larghezzaGuida || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'larghezzaGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Prof. Muro Est.</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profMuroEst || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Battuta Superiore con Tapparella</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.battutaSuperioreTapparella || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'battutaSuperioreTapparella', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Falso Esistente?</label>
                            <select id="falso-select-${project.id}"
                                    onchange="updateFalsoEsistente('${project.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                <option value="">Seleziona...</option>
                                <option value="si" ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                <option value="no" ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        <div id="falso-si-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'block' : 'none'}">
                            <div class="bg-orange-50 p-3 rounded space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.spessoreFalso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'spessoreFalso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.distanzaFalsoInfisso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'distanzaFalsoInfisso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div id="falso-no-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'block' : 'none'}">
                            <div class="bg-purple-50 p-3 rounded">
                                <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.distanzaMuroInfisso || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'distanzaMuroInfisso', this.value)"
                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // üóø NUOVA FUNZIONE: Render caratteristiche muro OVERRIDE per posizione specifica
        function renderCaratteristicheMuroOverride(project, pos) {
            const cm = pos.caratteristicheMuroOverride || {};
            const posIdUnique = `pos-${pos.id}`;
            
            return `
                <div class="bg-gradient-to-br from-yellow-50 to-purple-50 border-3 border-yellow-500 rounded-lg p-4 mt-4 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-purple-800 flex items-center gap-2">
                            <span class="text-2xl">üóø</span> Caratteristiche Muro PERSONALIZZATE (Misure in mm)
                        </h3>
                        <button onclick="disableOverride('${project.id}', '${pos.id}')"
                                class="px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition">
                            ‚Ü©Ô∏è Ripristina Globali
                        </button>
                    </div>
                    
                    <div class="bg-yellow-100 border-2 border-yellow-400 rounded-lg p-3 mb-4">
                        <p class="text-sm font-semibold text-yellow-900">
                            ‚ö†Ô∏è <strong>Attenzione:</strong> Stai modificando le caratteristiche del muro solo per questa posizione.
                            Le modifiche qui NON influenzano le altre posizioni n√© la configurazione globale.
                        </p>
                    </div>
                    
                    <div class="space-y-4 bg-white p-4 rounded-lg">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium text-purple-700">Prof. Muro Int</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profMuroInt || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroInt', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-purple-700">Prof. Piana Sopra</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profPianaSopra || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSopra', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-purple-700">Prof. Piana Sotto</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profPianaSotto || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSotto', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-purple-700">Telaio Prof</label>
                                <input type="number" placeholder="0"
                                       value="${cm.telaioProfondita || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioProfondita', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-purple-700">Telaio Largh</label>
                                <input type="number" placeholder="0"
                                       value="${cm.telaioLarghezza || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioLarghezza', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-purple-700 mb-1">Guida Esistente?</label>
                            <select onchange="updateGuidaEsistenteOverride('${project.id}', '${pos.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                                <option value="">Seleziona...</option>
                                <option value="si" ${cm.guidaEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                <option value="no" ${cm.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        ${cm.guidaEsistente === 'si' ? `
                            <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded border-2 border-green-300">
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.profDistanziale || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profDistanziale', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.profGuida || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.larghezzaGuida || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'larghezzaGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-purple-700 mb-1">Prof. Muro Est.</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profMuroEst || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroEst', this.value)"
                                       class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-purple-700 mb-1">Battuta Superiore con Tapparella</label>
                                <input type="number" placeholder="0"
                                       value="${cm.battutaSuperioreTapparella || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'battutaSuperioreTapparella', this.value)"
                                       class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-purple-700 mb-1">Falso Esistente?</label>
                            <select onchange="updateFalsoEsistenteOverride('${project.id}', '${pos.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                                <option value="">Seleziona...</option>
                                <option value="si" ${cm.falsoEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                <option value="no" ${cm.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        ${cm.falsoEsistente === 'si' ? `
                            <div class="bg-orange-50 p-3 rounded space-y-3 border-2 border-orange-300">
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.spessoreFalso || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'spessoreFalso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.distanzaFalsoInfisso || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaFalsoInfisso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        ` : ''}
                        
                        ${cm.falsoEsistente === 'no' ? `
                            <div class="bg-purple-50 p-3 rounded border-2 border-purple-300">
                                <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                <input type="number" placeholder="0"
                                       value="${cm.distanzaMuroInfisso || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaMuroInfisso', this.value)"
                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderStep8Positions(project) {
            
            return `
                <div>
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-2xl">üìç</span> Posizioni (${project.positions.length})
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="exportCurrentProjectExcel()"
                                    class="px-4 py-2 bg-gradient-to-r from-emerald-600 to-green-700 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                <span>üìä</span>
                                <span>Excel Progetto</span>
                            </button>
                            <button onclick="addPosition('${project.id}')"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                + Aggiungi Posizione
                            </button>
                        </div>
                    </div>

                    ${project.positions.length === 0 ? `
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna posizione ancora</p>
                            <button onclick="addPosition('${project.id}')"
                                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Aggiungi Prima Posizione
                            </button>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${project.positions.map((pos, idx) => {
                                const validation = validateMisure(project, pos);
                                const statusIcon = validation.errors.length > 0 ? 'üî¥' : validation.warnings.length > 0 ? 'üü°' : '‚úÖ';
                                const statusText = validation.errors.length > 0 ? 'ERRORI' : validation.warnings.length > 0 ? 'WARNING' : 'OK';
                                
                                // Stato rilievo
                                const rilievoStatus = getRilievoStatus(pos);
                                const rilievoCompleteness = calculateRilievoCompleteness(pos);
                                
                                // üÜï FASE 013 - Completamento posizione base (nome, ambiente, prodotti, misure)
                                // üîß FASE 014 - Passa anche project
                                const posStatus = getPositionCompletenessStatus(pos, project);
                                
                                return `
                                <div class="section-card cursor-pointer hover:shadow-lg ${validation.errors.length > 0 ? 'pulse-error' : ''}" onclick="openPosition('${pos.id}')">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">üìç</span>
                                            <div>
                                                <h3 class="font-semibold">${pos.name}</h3>
                                                <p class="text-sm text-gray-600">
                                                    ${pos.piano || 'Piano'} ‚Ä¢ ${pos.ambiente || 'Ambiente'}
                                                    ${pos.infisso ? ` ‚Ä¢ ü™ü` : ''}
                                                    ${pos.persiana ? ` ‚Ä¢ üö™` : ''}
                                                    ${pos.tapparella ? ` ‚Ä¢ üéöÔ∏è` : ''}
                                                    ${pos.zanzariera ? ` ‚Ä¢ ü¶ü` : ''}
                                                    ${pos.cassonetto ? ` ‚Ä¢ üì¶` : ''}
                                                </p>
                                                <div class="flex items-center gap-3 mt-1">
                                                    <p class="text-xs font-semibold ${validation.errors.length > 0 ? 'text-red-600' : validation.warnings.length > 0 ? 'text-amber-600' : 'text-green-600'}">
                                                        ${statusIcon} Misure: ${statusText}
                                                    </p>
                                                    <p class="text-xs font-semibold text-${rilievoStatus.color}-600 flex items-center gap-1">
                                                        ${rilievoStatus.icon} Rilievo: ${rilievoCompleteness.percentage}%
                                                    </p>
                                                    <p class="text-xs font-semibold text-${posStatus.color}-600 flex items-center gap-1" title="${posStatus.comp.missing.length > 0 ? 'Mancanti: ' + posStatus.comp.missing.join(', ') : 'Posizione completa'}">
                                                        ${posStatus.icon} Completo: ${posStatus.text}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <span class="text-purple-600">‚Üí</span>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        // ========================
        // üö™ STEP 9: CONFIG PORTONCINI FINSTRAL
        // ========================
        function renderStep9ConfigPortoncini(project) {
            if (!project.prodotti?.portoncini) {
                return `<div class="text-center py-8"><p class="text-gray-500">I portoncini non sono stati selezionati. Salta questo step.</p></div>`;
            }
            
            // Inizializza configPortoncini se non esiste
            if (!project.configPortoncini) {
                project.configPortoncini = {
                    azienda: 'Finstral',
                    // Telaio
                    tipoTelaio: '',
                    soglia: '',
                    montante: '',
                    traversa: '',
                    // Anta
                    modelloAnta: '',
                    pannello: '',
                    materialeInt: '',
                    materialeEst: '',
                    coloreInt: '',
                    coloreEst: '',
                    // Vetro
                    tipoVetro: '',
                    vetroOrnamentale: '',
                    fermavetro: '',
                    // Ferramenta
                    codiceFerramenta: '',
                    cerniere: '',
                    cilindro: '',
                    quantitaChiavi: 3,
                    // Maniglie
                    manigliaInt: '',
                    manigliaEst: '',
                    // Accessori
                    motorApertura: false,
                    telecomando: '',
                    lettoreImpronte: '',
                    chiudiporta: '',
                    // Note
                    note: ''
                };
                saveState();
            }
            
            const cfg = project.configPortoncini;
            
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üö™</span> Configurazione Portoncini Finstral Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutti i portoncini (Listino FIN-Door):</p>
                    
                    <!-- ‚öôÔ∏è TELAIO -->
                    <div class="bg-teal-50 border-2 border-teal-300 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                            <span>üèóÔ∏è</span> Telaio
                        </h3>
                        <div class="grid md:grid-cols-4 gap-3">
                            <!-- AZIENDA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Azienda</label>
                                <select class="w-full px-3 py-2 border rounded-lg bg-gray-100" disabled>
                                    <option value="Finstral" selected>Finstral</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Al momento solo Finstral</p>
                            </div>
                            
                            <!-- TIPO TELAIO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Tipo Telaio</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'tipoTelaio', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="L" ${cfg.tipoTelaio === 'L' ? 'selected' : ''}>L - Standard</option>
                                    <option value="Z" ${cfg.tipoTelaio === 'Z' ? 'selected' : ''}>Z - Ribassato</option>
                                    <option value="T" ${cfg.tipoTelaio === 'T' ? 'selected' : ''}>T - Termico</option>
                                </select>
                            </div>
                            
                            <!-- SOGLIA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Soglia</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'soglia', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="standard" ${cfg.soglia === 'standard' ? 'selected' : ''}>Standard</option>
                                    <option value="ribassata" ${cfg.soglia === 'ribassata' ? 'selected' : ''}>Ribassata</option>
                                    <option value="filo-pavimento" ${cfg.soglia === 'filo-pavimento' ? 'selected' : ''}>Filo Pavimento</option>
                                </select>
                            </div>
                            
                            <!-- MONTANTE -->
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Montante (mm)</label>
                                <input type="text" 
                                       value="${cfg.montante || ''}"
                                       onchange="updateConfigPortoncini('${project.id}', 'montante', this.value)"
                                       placeholder="Es: 110"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- üö™ ANTA E PANNELLO -->
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                            <span>üö™</span> Anta e Pannello
                        </h3>
                        <div class="grid md:grid-cols-3 gap-3">
                            <!-- MODELLO ANTA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">5. Modello Anta</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'modelloAnta', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="D101" ${cfg.modelloAnta === 'D101' ? 'selected' : ''}>D101 - Base</option>
                                    <option value="D102" ${cfg.modelloAnta === 'D102' ? 'selected' : ''}>D102 - Con vetro</option>
                                    <option value="D201" ${cfg.modelloAnta === 'D201' ? 'selected' : ''}>D201 - Premium</option>
                                    <option value="D202" ${cfg.modelloAnta === 'D202' ? 'selected' : ''}>D202 - Premium vetro</option>
                                    <option value="D301" ${cfg.modelloAnta === 'D301' ? 'selected' : ''}>D301 - Design</option>
                                    <option value="D401" ${cfg.modelloAnta === 'D401' ? 'selected' : ''}>D401 - Top</option>
                                </select>
                            </div>
                            
                            <!-- PANNELLO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">6. Pannello</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'pannello', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="liscio" ${cfg.pannello === 'liscio' ? 'selected' : ''}>Liscio</option>
                                    <option value="bugna" ${cfg.pannello === 'bugna' ? 'selected' : ''}>Bugna</option>
                                    <option value="design" ${cfg.pannello === 'design' ? 'selected' : ''}>Design</option>
                                    <option value="personalizzato" ${cfg.pannello === 'personalizzato' ? 'selected' : ''}>Personalizzato</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üé® MATERIALI E COLORI -->
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                            <span>üé®</span> Materiali e Colori
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- INTERNO -->
                            <div class="bg-yellow-100 p-3 rounded-lg">
                                <h4 class="font-semibold text-yellow-900 mb-2">Interno</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">7. Materiale Int</label>
                                        <select onchange="updateConfigPortoncini('${project.id}', 'materialeInt', this.value)"
                                                class="w-full px-2 py-1 text-sm border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="pvc" ${cfg.materialeInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                            <option value="alluminio" ${cfg.materialeInt === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                            <option value="legno" ${cfg.materialeInt === 'legno' ? 'selected' : ''}>Legno</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">8. Colore Int</label>
                                        <input type="text" 
                                               value="${cfg.coloreInt || ''}"
                                               onchange="updateConfigPortoncini('${project.id}', 'coloreInt', this.value)"
                                               placeholder="Es: RAL9016"
                                               class="w-full px-2 py-1 text-sm border rounded-lg">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ESTERNO -->
                            <div class="bg-yellow-100 p-3 rounded-lg">
                                <h4 class="font-semibold text-yellow-900 mb-2">Esterno</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">9. Materiale Est</label>
                                        <select onchange="updateConfigPortoncini('${project.id}', 'materialeEst', this.value)"
                                                class="w-full px-2 py-1 text-sm border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            <option value="pvc" ${cfg.materialeEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                            <option value="alluminio" ${cfg.materialeEst === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                            <option value="legno" ${cfg.materialeEst === 'legno' ? 'selected' : ''}>Legno</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">10. Colore Est</label>
                                        <input type="text" 
                                               value="${cfg.coloreEst || ''}"
                                               onchange="updateConfigPortoncini('${project.id}', 'coloreEst', this.value)"
                                               placeholder="Es: RAL7016"
                                               class="w-full px-2 py-1 text-sm border rounded-lg">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ü™ü VETRO -->
                    <div class="bg-cyan-50 border-2 border-cyan-300 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-cyan-800 mb-3 flex items-center gap-2">
                            <span>ü™ü</span> Vetro
                        </h3>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">11. Tipo Vetro</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'tipoVetro', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Nessuno/Seleziona...</option>
                                    <option value="chiaro" ${cfg.tipoVetro === 'chiaro' ? 'selected' : ''}>Chiaro</option>
                                    <option value="satinato" ${cfg.tipoVetro === 'satinato' ? 'selected' : ''}>Satinato</option>
                                    <option value="ornamentale" ${cfg.tipoVetro === 'ornamentale' ? 'selected' : ''}>Ornamentale</option>
                                    <option value="sicurezza" ${cfg.tipoVetro === 'sicurezza' ? 'selected' : ''}>Sicurezza</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">12. Vetro Ornamentale</label>
                                <input type="text" 
                                       value="${cfg.vetroOrnamentale || ''}"
                                       onchange="updateConfigPortoncini('${project.id}', 'vetroOrnamentale', this.value)"
                                       placeholder="Es: Delta, Chinchill√†"
                                       class="w-full px-3 py-2 border rounded-lg"
                                       ${cfg.tipoVetro !== 'ornamentale' ? 'disabled' : ''}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">13. Fermavetro</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'fermavetro', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="interno" ${cfg.fermavetro === 'interno' ? 'selected' : ''}>Interno</option>
                                    <option value="esterno" ${cfg.fermavetro === 'esterno' ? 'selected' : ''}>Esterno</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üî© FERRAMENTA -->
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <span>üî©</span> Ferramenta
                        </h3>
                        <div class="grid md:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">14. Codice Ferramenta</label>
                                <input type="text" 
                                       value="${cfg.codiceFerramenta || ''}"
                                       onchange="updateConfigPortoncini('${project.id}', 'codiceFerramenta', this.value)"
                                       placeholder="Es: FD-3000"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">15. Cerniere</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'cerniere', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="standard" ${cfg.cerniere === 'standard' ? 'selected' : ''}>Standard</option>
                                    <option value="3d" ${cfg.cerniere === '3d' ? 'selected' : ''}>3D Regolabili</option>
                                    <option value="nascoste" ${cfg.cerniere === 'nascoste' ? 'selected' : ''}>Nascoste</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">16. Cilindro</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'cilindro', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="standard" ${cfg.cilindro === 'standard' ? 'selected' : ''}>Standard</option>
                                    <option value="europeo" ${cfg.cilindro === 'europeo' ? 'selected' : ''}>Europeo</option>
                                    <option value="alta-sicurezza" ${cfg.cilindro === 'alta-sicurezza' ? 'selected' : ''}>Alta Sicurezza</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">17. Qt√† Chiavi</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'quantitaChiavi', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="3" ${cfg.quantitaChiavi == '3' ? 'selected' : ''}>3</option>
                                    <option value="4" ${cfg.quantitaChiavi == '4' ? 'selected' : ''}>4</option>
                                    <option value="5" ${cfg.quantitaChiavi == '5' ? 'selected' : ''}>5</option>
                                    <option value="6" ${cfg.quantitaChiavi == '6' ? 'selected' : ''}>6</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üñêÔ∏è MANIGLIE -->
                    <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                            <span>üñêÔ∏è</span> Maniglie
                        </h3>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">18. Maniglia Interna</label>
                                <input type="text" 
                                       value="${cfg.manigliaInt || ''}"
                                       onchange="updateConfigPortoncini('${project.id}', 'manigliaInt', this.value)"
                                       placeholder="Es: 7040 - Maniglione"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">19. Maniglia Esterna</label>
                                <input type="text" 
                                       value="${cfg.manigliaEst || ''}"
                                       onchange="updateConfigPortoncini('${project.id}', 'manigliaEst', this.value)"
                                       placeholder="Es: Pomolo fisso / Maniglione"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‚ö° ACCESSORI -->
                    <div class="bg-orange-50 border-2 border-orange-300 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-orange-800 mb-3 flex items-center gap-2">
                            <span>‚ö°</span> Accessori
                        </h3>
                        <div class="grid md:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">20. Motor Apertura</label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" 
                                           ${cfg.motorApertura ? 'checked' : ''}
                                           onchange="updateConfigPortoncini('${project.id}', 'motorApertura', this.checked)"
                                           class="w-5 h-5 rounded">
                                    <span>Motorizzata</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">21. Telecomando</label>
                                <input type="text" 
                                       value="${cfg.telecomando || ''}"
                                       onchange="updateConfigPortoncini('${project.id}', 'telecomando', this.value)"
                                       placeholder="Es: 2 telecomandi"
                                       class="w-full px-3 py-2 border rounded-lg"
                                       ${!cfg.motorApertura ? 'disabled' : ''}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">22. Lettore Impronte</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'lettoreImpronte', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Nessuno</option>
                                    <option value="base" ${cfg.lettoreImpronte === 'base' ? 'selected' : ''}>Base</option>
                                    <option value="smart" ${cfg.lettoreImpronte === 'smart' ? 'selected' : ''}>Smart (con App)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">23. Chiudiporta</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'chiudiporta', this.value)"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Nessuno</option>
                                    <option value="standard" ${cfg.chiudiporta === 'standard' ? 'selected' : ''}>Standard</option>
                                    <option value="incasso" ${cfg.chiudiporta === 'incasso' ? 'selected' : ''}>Ad incasso</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üìù NOTE -->
                    <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <span>üìù</span> Note Generali
                        </h3>
                        <textarea 
                            onchange="updateConfigPortoncini('${project.id}', 'note', this.value)"
                            placeholder="Note aggiuntive per la configurazione portoncini..."
                            class="w-full px-3 py-2 border rounded-lg h-24">${cfg.note || ''}</textarea>
                    </div>
                    
                    <!-- RIEPILOGO -->
                    <div class="mt-4 p-4 bg-teal-100 border-2 border-teal-400 rounded-lg">
                        <h3 class="font-semibold text-teal-900 mb-2">üìã Riepilogo Configurazione</h3>
                        <div class="grid md:grid-cols-3 gap-2 text-sm">
                            <div><strong>Azienda:</strong> ${cfg.azienda || '-'}</div>
                            <div><strong>Telaio:</strong> ${cfg.tipoTelaio || '-'}</div>
                            <div><strong>Modello:</strong> ${cfg.modelloAnta || '-'}</div>
                            <div><strong>Materiale Int:</strong> ${cfg.materialeInt || '-'}</div>
                            <div><strong>Materiale Est:</strong> ${cfg.materialeEst || '-'}</div>
                            <div><strong>Vetro:</strong> ${cfg.tipoVetro || 'Nessuno'}</div>
                            <div><strong>Cilindro:</strong> ${cfg.cilindro || '-'}</div>
                            <div><strong>Motorizzata:</strong> ${cfg.motorApertura ? 'S√¨' : 'No'}</div>
                            <div><strong>Lettore Impronte:</strong> ${cfg.lettoreImpronte || 'No'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Funzione per aggiornare configPortoncini
        window.updateConfigPortoncini = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (!project.configPortoncini) {
                project.configPortoncini = { azienda: 'Finstral' };
            }
            
            project.configPortoncini[field] = value;
            console.log(`üö™ configPortoncini.${field} = ${value}`);
            
            saveState();
            render();
        };


        function PositionDetail() {
            const project = state.projects.find(p => p.id === state.currentProject);
            const pos = project?.positions.find(p => p.id === state.currentPosition);
            if (!pos) return '';

            return `
                ${renderTopNavbar()}
                
                <div class="max-w-7xl mx-auto p-4">
                    <!-- üÜï v4.20: HEADER POSIZIONI A 2 RIGHE RESPONSIVE -->
                    <div class="bg-white rounded-lg shadow mb-4">
                        
                        <!-- RIGA 1: Navigazione principale -->
                        <div class="flex items-center justify-between p-3 border-b border-gray-200">
                            <div class="flex items-center gap-3 flex-1">
                                <input type="text" value="${pos.name}"
                                       onchange="updatePosition('${project.id}', '${pos.id}', 'name', this.value)"
                                       class="text-lg font-bold border-b-2 border-transparent focus:border-purple-500 outline-none max-w-xs"
                                       placeholder="Nome posizione">
                                <button onclick="state.screen = 'project-detail'; state.setupStep = 1; render();"
                                        class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700 transition flex items-center gap-1"
                                        title="Torna alle configurazioni">
                                    üîß Setup
                                </button>
                            </div>
                        </div>
                        
                        <!-- RIGA 2: Dropdown posizione + azioni -->
                        <div class="p-3">
                            <div class="flex flex-wrap items-center gap-2">
                                
                                <!-- DROPDOWN POSIZIONI AVANZATO -->
                                <select onchange="switchPosition(this.value)"
                                        class="flex-1 min-w-[200px] px-4 py-2 border-2 border-purple-300 rounded-lg text-base font-medium bg-white hover:border-purple-500 focus:border-purple-600 focus:ring-2 focus:ring-purple-200 transition-all"
                                        style="font-size: 16px;">
                                    ${project.positions.map(p => {
                                        // Calcola completamento posizione
                                        const completion = (() => {
                                            let total = 0, completed = 0;
                                            if (p.name) { total += 20; completed += 20; }
                                            if (p.ambiente) { total += 20; completed += 20; }
                                            
                                            const prodottiAbilitati = Object.keys(project.prodotti || {}).filter(k => project.prodotti[k]);
                                            if (prodottiAbilitati.length > 0) {
                                                total += 30;
                                                const prodottiPresenti = prodottiAbilitati.filter(prod => {
                                                    const hasProdotto = p[prod] && Object.keys(p[prod]).length > 0;
                                                    const isAssente = p.prodottiAssenti?.includes(prod);
                                                    return hasProdotto || isAssente;
                                                }).length;
                                                completed += Math.round((prodottiPresenti / prodottiAbilitati.length) * 30);
                                            }
                                            
                                            if (p.misure && (p.misure.LF || p.misure.HF)) {
                                                total += 30;
                                                const campiMisure = ['LF', 'HF', 'LP', 'HP', 'LPF', 'HPF'];
                                                const misureCompilate = campiMisure.filter(k => p.misure[k] && p.misure[k] !== '').length;
                                                completed += Math.round((misureCompilate / campiMisure.length) * 30);
                                            }
                                            
                                            return total > 0 ? Math.round((completed / total) * 100) : 0;
                                        })();
                                        
                                        // Icona stato basata su completamento
                                        const icon = completion === 100 ? '‚úÖ' : 
                                                     completion >= 50 ? '‚ö†Ô∏è' : 
                                                     completion > 0 ? '‚ùå' : '‚≠ï';
                                        
                                        // Indicatore posizione corrente
                                        const current = p.id === pos.id ? '‚ñ∂Ô∏è ' : '';
                                        
                                        // Testo con ambiente se presente
                                        const displayText = p.ambiente 
                                            ? `${p.name} - ${p.ambiente}` 
                                            : p.name;
                                        
                                        return `
                                            <option value="${p.id}" ${p.id === pos.id ? 'selected' : ''}>
                                                ${current}${icon} ${displayText} (${completion}%)
                                            </option>
                                        `;
                                    }).join('')}
                                </select>
                                
                                <!-- PULSANTE CONFIG (solo se tab attivo ha config) -->
                                ${(() => {
                                    const tab = pos.activeTab || 'misure';
                                    const configMap = {
                                        'infissi': { step: 3, label: '‚öôÔ∏è Config Infissi', btnClass: 'bg-purple-600 hover:bg-purple-700' },
                                        'persiane': { step: 4, label: '‚öôÔ∏è Config Persiane', btnClass: 'bg-blue-600 hover:bg-blue-700' },
                                        'tapparelle': { step: 5, label: '‚öôÔ∏è Config Tapparelle', btnClass: 'bg-indigo-600 hover:bg-indigo-700' },
                                        'zanzariere': { step: 6, label: '‚öôÔ∏è Config Zanzariere', btnClass: 'bg-green-600 hover:bg-green-700' },
                                        'cassonetti': { step: 7, label: '‚öôÔ∏è Config Cassonetti', btnClass: 'bg-orange-600 hover:bg-orange-700' }
                                    };
                                    const config = configMap[tab];
                                    if (config && project.prodotti?.[tab]) {
                                        return `
                                            <button onclick="state.screen = 'project-detail'; state.setupStep = ${config.step}; render();"
                                                    class="px-3 py-2 ${config.btnClass} text-white rounded-lg font-medium text-sm transition whitespace-nowrap">
                                                ${config.label}
                                            </button>
                                        `;
                                    }
                                    return '';
                                })()}
                                
                                <!-- AZIONI POSIZIONE -->
                                <div class="flex gap-2">
                                    <button onclick="addPosition('${project.id}')"
                                            class="px-3 py-2 bg-green-600 text-white rounded-lg font-medium text-sm hover:bg-green-700 transition whitespace-nowrap">
                                        + Nuova
                                    </button>
                                    ${project.positions.length > 1 ? `
                                    <button onclick="deletePosition('${project.id}', '${pos.id}')"
                                            class="px-3 py-2 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700 transition">
                                        üóëÔ∏è
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div class="section-card">
                            <label class="text-xs font-medium">Piano</label>
                            <input type="text" value="${pos.piano || ''}"
                                   onchange="updatePosition('${project.id}', '${pos.id}', 'piano', this.value)"
                                   placeholder="${project.clientData?.piano || 'Piano'}"
                                   class="w-full compact-input border rounded mt-1">
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">
                                Ambiente <span class="text-red-600 font-bold">*</span>
                            </label>
                            <div class="flex items-center gap-2 mt-1">
                                <!-- DROPDOWN -->
                                <select id="ambiente-select-${pos.id}"
                                        onchange="updatePosition('${project.id}', '${pos.id}', 'ambiente', this.value)"
                                        class="flex-1 compact-input border rounded ${!pos.ambiente ? 'border-red-500 bg-red-50' : ''}"
                                        style="display: ${(pos.ambienteMode || 'select') === 'select' ? 'block' : 'none'};">
                                    <option value="">‚ö†Ô∏è Seleziona ambiente...</option>
                                    ${['Sala', 'Soggiorno', 'Cucina', 'Camera', 'Stanza', 'Cameretta', 'Matrimoniale', 'Disimpegno', 'Studio', 'Ufficio', 'Bagno1', 'Bagno2', 'Ripostiglio', 'Lavanderia', 'Scala', 'Cantina', 'Garage'].map(amb => `
                                        <option value="${amb}" ${pos.ambiente === amb ? 'selected' : ''}>${amb}</option>
                                    `).join('')}
                                </select>
                                
                                <!-- FREE TEXT INPUT -->
                                <input type="text" 
                                       id="ambiente-input-${pos.id}"
                                       value="${pos.ambiente || ''}"
                                       oninput="updatePosition('${project.id}', '${pos.id}', 'ambiente', this.value)"
                                       placeholder="Scrivi ambiente..."
                                       class="flex-1 compact-input border rounded ${!pos.ambiente ? 'border-red-500 bg-red-50' : ''}"
                                       style="display: ${(pos.ambienteMode || 'select') === 'input' ? 'block' : 'none'};">
                                
                                <!-- BOTTONE TOGGLE -->
                                <button type="button"
                                        id="ambiente-toggle-${pos.id}"
                                        onclick="toggleAmbienteMode('${project.id}', '${pos.id}')"
                                        title="${(pos.ambienteMode || 'select') === 'select' ? 'Passa a scrittura libera' : 'Torna alla tendina'}"
                                        class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 whitespace-nowrap">
                                    ${(pos.ambienteMode || 'select') === 'select' ? '‚úèÔ∏è Scrivi' : 'üìã Tendina'}
                                </button>
                            </div>
                            ${!pos.ambiente ? `
                                <p class="text-xs text-red-600 mt-1">‚ö†Ô∏è Campo obbligatorio</p>
                            ` : ''}
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Quantit√†</label>
                            <input type="number" min="1" value="${pos.quantita || '1'}"
                                   onchange="updatePosition('${project.id}', '${pos.id}', 'quantita', this.value)"
                                   placeholder="1"
                                   class="w-full compact-input border rounded mt-1 font-semibold text-purple-700">
                        </div>
                    </div>
                    
                    <!-- üö™ v5.09: TIPO POSIZIONE (Finestra o Ingresso) -->
                    <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg">
                        <label class="block text-sm font-bold text-gray-700 mb-2">üè† Tipo Posizione</label>
                        <div class="flex gap-4">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="tipopos-${pos.id}" value="finestra"
                                       ${(pos.tipoposizione || 'finestra') === 'finestra' ? 'checked' : ''}
                                       onchange="updateTipoPosizione('${project.id}', '${pos.id}', 'finestra')"
                                       class="sr-only">
                                <div class="p-3 rounded-lg border-2 transition-all ${(pos.tipoposizione || 'finestra') === 'finestra' 
                                    ? 'border-blue-500 bg-blue-100 shadow-md' 
                                    : 'border-gray-300 bg-white hover:border-blue-300'}">
                                    <div class="flex items-center gap-2">
                                        <span class="text-2xl">ü™ü</span>
                                        <div>
                                            <div class="font-semibold ${(pos.tipoposizione || 'finestra') === 'finestra' ? 'text-blue-700' : 'text-gray-700'}">Finestra</div>
                                            <div class="text-xs text-gray-500">Infissi, persiane, tapparelle...</div>
                                        </div>
                                    </div>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="tipopos-${pos.id}" value="ingresso"
                                       ${pos.tipoposizione === 'ingresso' ? 'checked' : ''}
                                       onchange="updateTipoPosizione('${project.id}', '${pos.id}', 'ingresso')"
                                       class="sr-only">
                                <div class="p-3 rounded-lg border-2 transition-all ${pos.tipoposizione === 'ingresso' 
                                    ? 'border-teal-500 bg-teal-100 shadow-md' 
                                    : 'border-gray-300 bg-white hover:border-teal-300'}">
                                    <div class="flex items-center gap-2">
                                        <span class="text-2xl">üö™</span>
                                        <div>
                                            <div class="font-semibold ${pos.tipoposizione === 'ingresso' ? 'text-teal-700' : 'text-gray-700'}">Ingresso</div>
                                            <div class="text-xs text-gray-500">Portoncino o Blindata</div>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div class="section-card">
                            <label class="text-xs font-medium">Foto</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="file" id="foto-${pos.id}" accept="image/*" class="hidden"
                                       onchange="addFoto('${project.id}', '${pos.id}', this)">
                                <button onclick="document.getElementById('foto-${pos.id}').click()"
                                        class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                    üì∑ Carica
                                </button>
                                <span class="text-sm text-gray-600">${pos.foto?.length || 0} foto</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow">
                        <div class="flex border-b overflow-x-auto">
                            <!-- TAB DINAMICI in base a tipoposizione -->
                            ${(pos.tipoposizione || 'finestra') === 'finestra' ? `
                                <!-- TIPO FINESTRA: mostra tutti i prodotti standard -->
                                <button onclick="setPositionTab('${pos.id}', 'misure')"
                                        class="tab-btn ${(pos.activeTab || 'misure') === 'misure' ? 'active' : ''}">
                                    üìè Misure
                                </button>
                                ${project.prodotti?.infissi ? `
                                    <button onclick="setPositionTab('${pos.id}', 'infissi')"
                                            class="tab-btn ${pos.activeTab === 'infissi' ? 'active' : ''}">
                                        ü™ü Infissi
                                    </button>
                                ` : ''}
                                ${project.prodotti?.persiane ? `
                                    <button onclick="setPositionTab('${pos.id}', 'persiane')"
                                            class="tab-btn ${pos.activeTab === 'persiane' ? 'active' : ''}">
                                        üö™ Persiane
                                    </button>
                                ` : ''}
                                ${project.prodotti?.tapparelle ? `
                                    <button onclick="setPositionTab('${pos.id}', 'tapparelle')"
                                            class="tab-btn ${pos.activeTab === 'tapparelle' ? 'active' : ''}">
                                        üéöÔ∏è Tapparelle
                                    </button>
                                ` : ''}
                                ${project.prodotti?.zanzariere ? `
                                    <button onclick="setPositionTab('${pos.id}', 'zanzariere')"
                                            class="tab-btn ${pos.activeTab === 'zanzariere' ? 'active' : ''}">
                                        ü¶ü Zanzariere
                                    </button>
                                ` : ''}
                                ${project.prodotti?.cassonetti ? `
                                    <button onclick="setPositionTab('${pos.id}', 'cassonetti')"
                                            class="tab-btn ${pos.activeTab === 'cassonetti' ? 'active' : ''}">
                                        üì¶ Cassonetti
                                    </button>
                                ` : ''}
                            ` : `
                                <!-- TIPO INGRESSO: mostra solo tab ingresso -->
                                <button onclick="setPositionTab('${pos.id}', 'ingresso')"
                                        class="tab-btn ${(pos.activeTab || 'ingresso') === 'ingresso' ? 'active' : ''}">
                                    üö™ Ingresso
                                </button>
                            `}
                            <button onclick="setPositionTab('${pos.id}', 'foto')"
                                    class="tab-btn ${pos.activeTab === 'foto' ? 'active' : ''}">
                                üì∏ Foto (${pos.foto?.length || 0})
                            </button>
                        </div>

                        <div class="p-4">
                            ${renderPositionTabContent(project, pos)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPositionTabContent(project, pos) {
            // üö™ v5.09: Se tipo ingresso, forza tab ingresso come default
            let tab = pos.activeTab || 'misure';
            if (pos.tipoposizione === 'ingresso' && tab !== 'foto' && tab !== 'ingresso') {
                tab = 'ingresso';
            }

            if (tab === 'misure') return renderMisureTab(project, pos);
            if (tab === 'infissi') return renderInfissiTab(project, pos);
            if (tab === 'persiane') return renderPersianeTab(project, pos);
            if (tab === 'tapparelle') return renderTapparelleTab(project, pos);
            if (tab === 'zanzariere') return renderZanzariereTab(project, pos);
            if (tab === 'cassonetti') return renderCassonettiTab(project, pos);
            if (tab === 'ingresso') return renderIngressoTab(project, pos);  // üö™ v5.09
            if (tab === 'foto') return renderFotoTab(project, pos);

            return '';
        }
        
        // üö™ v5.09: Funzione per aggiornare tipo posizione
        window.updateTipoPosizione = function(projectId, positionId, tipo) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === positionId);
            if (!pos) return;
            
            pos.tipoposizione = tipo;
            
            // Reset tab attivo in base al nuovo tipo
            if (tipo === 'ingresso') {
                pos.activeTab = 'ingresso';
            } else {
                pos.activeTab = 'misure';
            }
            
            console.log(`üè† Tipo posizione cambiato: ${tipo}`);
            saveState();
            render();
        };
        
        // üö™ v5.09: Tab INGRESSO (Portoncino o Blindata)
        function renderIngressoTab(project, pos) {
            const ing = pos.ingresso || {};
            
            return `
                <div class="space-y-4">
                    <!-- SCELTA TIPO INGRESSO -->
                    <div class="bg-gradient-to-r from-teal-50 to-red-50 border-2 border-gray-300 rounded-lg p-4">
                        <h3 class="font-bold text-gray-800 mb-3">üö™ Scegli il tipo di porta d'ingresso</h3>
                        <div class="flex gap-4">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="tipoingresso-${pos.id}" value="portoncino"
                                       ${ing.tipo === 'portoncino' ? 'checked' : ''}
                                       onchange="updateIngresso('${project.id}', '${pos.id}', 'tipo', 'portoncino')"
                                       class="sr-only">
                                <div class="p-4 rounded-lg border-2 transition-all text-center ${ing.tipo === 'portoncino' 
                                    ? 'border-teal-500 bg-teal-100 shadow-lg' 
                                    : 'border-gray-300 bg-white hover:border-teal-300'}">
                                    <span class="text-3xl block mb-2">üö™</span>
                                    <div class="font-bold ${ing.tipo === 'portoncino' ? 'text-teal-700' : 'text-gray-700'}">Portoncino</div>
                                    <div class="text-xs text-gray-500">Finstral FIN-Door</div>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="tipoingresso-${pos.id}" value="blindata"
                                       ${ing.tipo === 'blindata' ? 'checked' : ''}
                                       onchange="updateIngresso('${project.id}', '${pos.id}', 'tipo', 'blindata')"
                                       class="sr-only">
                                <div class="p-4 rounded-lg border-2 transition-all text-center ${ing.tipo === 'blindata' 
                                    ? 'border-red-500 bg-red-100 shadow-lg' 
                                    : 'border-gray-300 bg-white hover:border-red-300'}">
                                    <span class="text-3xl block mb-2">üîê</span>
                                    <div class="font-bold ${ing.tipo === 'blindata' ? 'text-red-700' : 'text-gray-700'}">Blindata</div>
                                    <div class="text-xs text-gray-500">Oikos</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    ${!ing.tipo ? `
                        <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <p class="text-yellow-700 font-medium">‚ö†Ô∏è Seleziona il tipo di porta per continuare la configurazione</p>
                        </div>
                    ` : ing.tipo === 'portoncino' ? renderPortoncinoConfig(project, pos, ing) : renderBlindataConfig(project, pos, ing)}
                </div>
            `;
        }
        
        // üö™ Configurazione PORTONCINO Finstral FIN-Door v5.17
        function renderPortoncinoConfig(project, pos, ing) {
            const ptc = ing.portoncino || {};
            
            // Helper: genera options telaio filtrate per forma
            const formaTelaio = ptc.formaTelaio || 'L-INT';
            const telaiDisponibili = FINDOOR_TELAI[formaTelaio] || {};
            const codTelaio = ptc.codTelaio || '';
            const telaioSel = telaiDisponibili[codTelaio] || {};
            
            // Helper: genera options tagli per telaio
            const tagli = FINDOOR_TAGLI_PER_TELAIO[codTelaio] || [];
            
            // Calcolo prezzo stimato
            const L = parseInt(ptc.BRM_L) || 1000;
            const H = parseInt(ptc.BRM_H) || 2100;
            const tipoAnta = ptc.tipoAnta || 'STEP_FRAME-STEP_FRAME';
            const tipoTab = FINDOOR_TIPI_ANTA.find(t => t.cod === tipoAnta)?.tab || 'PVC';
            const isGrande = (L > 1115 || H > 2355);
            
            const prezzoBase = calcolaPrezzoBasePortoncino(L, H, tipoTab);
            const supplAnta = calcolaSupplModelloAnta(ptc.modelloAnta || '01', tipoAnta, isGrande);
            const maniglia = FINDOOR_MANIGLIE.set[ptc.codManiglia] || FINDOOR_MANIGLIE.maniglioni[ptc.codManiglia] || {};
            const prezzoManiglia = maniglia.prezzo || 0;
            const prezzoTotale = prezzoBase + supplAnta + prezzoManiglia;
            
            return `
                <div class="product-card border-teal-300">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <h4 class="font-semibold text-teal-700 text-lg">üö™ Portoncino Finstral FIN-Door</h4>
                            <button onclick="apriCatalogoModelli('${project.id}', '${pos.id}')" 
                                    class="text-xs bg-teal-100 hover:bg-teal-200 text-teal-700 px-3 py-1 rounded-full transition-colors flex items-center gap-1">
                                üìñ Scegli Modello da Catalogo
                            </button>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">Prezzo stimato</div>
                            <div class="text-xl font-bold text-teal-600">‚Ç¨ ${prezzoTotale.toLocaleString('it-IT')}</div>
                        </div>
                    </div>
                    
                    <!-- üìê DIMENSIONI BRM -->
                    <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-teal-800 mb-3">üìê Dimensioni BRM (misura telaio)</h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">BRM Larghezza (mm)</label>
                                <input type="number" value="${ptc.BRM_L || ''}" placeholder="es. 1000"
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'BRM_L', this.value)"
                                       class="w-full compact-input border rounded mt-1 font-bold text-lg">
                            </div>
                            <div>
                                <label class="text-xs font-medium">BRM Altezza (mm)</label>
                                <input type="number" value="${ptc.BRM_H || ''}" placeholder="es. 2200"
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'BRM_H', this.value)"
                                       class="w-full compact-input border rounded mt-1 font-bold text-lg">
                            </div>
                            <div class="flex items-end">
                                <div class="bg-teal-100 p-2 rounded text-sm w-full text-center">
                                    ${isGrande ? 'üìè Misura GRANDE (>1115√ó2355)' : 'üìè Misura standard'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üèóÔ∏è TELAIO -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-blue-800 mb-3">üèóÔ∏è 1. Telaio</h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">Forma Telaio</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'formaTelaio', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="L-INT" ${formaTelaio === 'L-INT' ? 'selected' : ''}>L - Apertura interno</option>
                                    <option value="L-EST" ${formaTelaio === 'L-EST' ? 'selected' : ''}>L - Apertura esterno</option>
                                    <option value="Z" ${formaTelaio === 'Z' ? 'selected' : ''}>Z - Per controtelaio</option>
                                    <option value="T" ${formaTelaio === 'T' ? 'selected' : ''}>T - Forma a T</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Codice Telaio</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'codTelaio', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    ${Object.entries(telaiDisponibili).map(([cod, t]) => 
                                        `<option value="${cod}" ${codTelaio === cod ? 'selected' : ''}>${cod} - ${t.desc} (${t.spessore}mm)</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="flex items-end">
                                ${telaioSel.note ? `<div class="bg-blue-100 p-2 rounded text-xs w-full">‚ÑπÔ∏è ${telaioSel.note}</div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- üö™ TIPO ANTA (Int-Est) -->
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-purple-800 mb-3">üö™ 2. Tipo Anta (Interno - Esterno)</h5>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium">Combinazione Int-Est</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'tipoAnta', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    ${FINDOOR_TIPI_ANTA.map(t => 
                                        `<option value="${t.cod}" ${tipoAnta === t.cod ? 'selected' : ''}>${t.desc} (${t.mat})</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="bg-purple-100 p-2 rounded text-sm flex-1 text-center">
                                    Materiale: <strong>${FINDOOR_TIPI_ANTA.find(t => t.cod === tipoAnta)?.mat || 'PVC-PVC'}</strong>
                                </div>
                                <div class="bg-purple-200 p-2 rounded text-sm">
                                    Base: <strong>‚Ç¨${prezzoBase.toLocaleString('it-IT')}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üé® MODELLO ANTA -->
                    <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-orange-800 mb-3">üé® 3. Modello Anta</h5>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium">Modello</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'modelloAnta', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    ${Object.entries(FINDOOR_MODELLI_ANTA).map(([cod, m]) => 
                                        `<option value="${cod}" ${ptc.modelloAnta === cod ? 'selected' : ''}>${cod} - ${m.desc} (min ${m.minL}√ó${m.minH})</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                ${supplAnta > 0 ? `
                                    <div class="bg-orange-200 p-2 rounded text-sm flex-1 text-center">
                                        Suppl. modello: <strong>+‚Ç¨${supplAnta.toLocaleString('it-IT')}</strong>
                                    </div>
                                ` : `
                                    <div class="bg-gray-100 p-2 rounded text-sm flex-1 text-center text-gray-500">
                                        Seleziona modello per vedere supplemento
                                    </div>
                                `}
                                <label class="flex items-center gap-1 text-sm">
                                    <input type="checkbox" ${ptc.fonoassorbente ? 'checked' : ''}
                                           onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'fonoassorbente', this.checked)">
                                    Fonoass.
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‚úÇÔ∏è TAGLI TELAIO -->
                    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-red-800 mb-3">‚úÇÔ∏è 4. Tagli Telaio</h5>
                        <div class="grid md:grid-cols-4 gap-2">
                            ${['SOPRA', 'SOTTO', 'SX', 'DX'].map(pos => `
                                <div>
                                    <label class="text-xs font-medium">${pos}</label>
                                    <select onchange="updateIngressoTaglio('${project.id}', '${pos.id}', '${pos}', this.value)"
                                            class="w-full compact-input border rounded mt-1 text-sm">
                                        <option value="">Nessuno</option>
                                        ${tagli.map(t => 
                                            `<option value="${t}" ${(ptc.tagli?.[pos] || '') === t ? 'selected' : ''}>${t} (‚Ç¨${FINDOOR_TAGLI_PREZZI[t]}/ml)</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                        ${codTelaio === '' ? '<p class="text-xs text-red-500 mt-2">‚ö†Ô∏è Seleziona prima un telaio per vedere i tagli disponibili</p>' : ''}
                    </div>
                    
                    <!-- üîê MANIGLIE -->
                    <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-gray-800 mb-3">üîê 5. Maniglie</h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">Tipo</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'tipoManiglia', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="set" ${(ptc.tipoManiglia || 'set') === 'set' ? 'selected' : ''}>Set maniglie (coppia)</option>
                                    <option value="maniglione" ${ptc.tipoManiglia === 'maniglione' ? 'selected' : ''}>Maniglione</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Modello</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'codManiglia', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    ${(ptc.tipoManiglia === 'maniglione' 
                                        ? Object.entries(FINDOOR_MANIGLIE.maniglioni)
                                        : Object.entries(FINDOOR_MANIGLIE.set)
                                    ).map(([cod, m]) => 
                                        `<option value="${cod}" ${ptc.codManiglia === cod ? 'selected' : ''}>${cod} - ${m.desc} (‚Ç¨${m.prezzo})</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="flex items-center">
                                ${prezzoManiglia > 0 ? `
                                    <div class="bg-gray-200 p-2 rounded text-sm w-full text-center">
                                        Maniglia: <strong>+‚Ç¨${prezzoManiglia}</strong>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- üé® COLORI -->
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-yellow-800 mb-3">üé® 6. Colori</h5>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium">Gruppo Colore Alluminio</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'gruppoColore', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    ${Object.entries(FINDOOR_COLORI_ALU).map(([cod, g]) => 
                                        `<option value="${cod}" ${(ptc.gruppoColore || 'gruppo1') === cod ? 'selected' : ''}>${g.desc}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Colore Specifico</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'colore', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    ${(FINDOOR_COLORI_ALU[ptc.gruppoColore || 'gruppo1']?.colori || []).map(c => 
                                        `<option value="${c}" ${ptc.colore === c ? 'selected' : ''}>${c}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üîí CILINDRO E CERNIERE -->
                    <div class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-indigo-800 mb-3">üîí 7. Cilindro e Cerniere</h5>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium">Cilindro</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'cilindro', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="standard" ${(ptc.cilindro || 'standard') === 'standard' ? 'selected' : ''}>Standard (3 chiavi) - incluso</option>
                                    <option value="1P" ${ptc.cilindro === '1P' ? 'selected' : ''}>Sicurezza 1P</option>
                                    <option value="2P" ${ptc.cilindro === '2P' ? 'selected' : ''}>Sicurezza 2P</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Cerniere</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'cerniere', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="vista" ${(ptc.cerniere || 'vista') === 'vista' ? 'selected' : ''}>A vista con rostri</option>
                                    <option value="scomparsa" ${ptc.cerniere === 'scomparsa' ? 'selected' : ''}>A scomparsa (cod. 220)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üìù NOTE E RIEPILOGO -->
                    <div class="grid md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium">üìù Note</label>
                            <textarea onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'note', this.value)"
                                      placeholder="Note aggiuntive..." class="w-full compact-input border rounded mt-1 h-20">${ptc.note || ''}</textarea>
                        </div>
                        <div class="bg-teal-100 border-2 border-teal-300 rounded-lg p-3">
                            <h6 class="font-bold text-teal-800 mb-2">üí∞ Riepilogo Prezzi</h6>
                            <div class="text-sm space-y-1">
                                <div class="flex justify-between"><span>Base porta:</span><span>‚Ç¨${prezzoBase.toLocaleString('it-IT')}</span></div>
                                <div class="flex justify-between"><span>Suppl. modello:</span><span>+‚Ç¨${supplAnta.toLocaleString('it-IT')}</span></div>
                                <div class="flex justify-between"><span>Maniglia:</span><span>+‚Ç¨${prezzoManiglia.toLocaleString('it-IT')}</span></div>
                                <hr class="border-teal-400">
                                <div class="flex justify-between font-bold text-lg"><span>TOTALE:</span><span>‚Ç¨${prezzoTotale.toLocaleString('it-IT')}</span></div>
                            </div>
                            <p class="text-xs text-teal-600 mt-2">* Esclusi: tagli, colori gruppo 2/3, optional</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Helper: aggiorna taglio specifico portoncino
        function updateIngressoTaglio(projectId, posId, posizione, valore) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            const pos = project.positions.find(p => p.id === posId);
            if (!pos) return;
            
            if (!pos.ingresso) pos.ingresso = {};
            if (!pos.ingresso.portoncino) pos.ingresso.portoncino = {};
            if (!pos.ingresso.portoncino.tagli) pos.ingresso.portoncino.tagli = {};
            
            if (valore) {
                pos.ingresso.portoncino.tagli[posizione] = valore;
            } else {
                delete pos.ingresso.portoncino.tagli[posizione];
            }
            
            saveState();
            render();
        }
        
        // üîê Configurazione BLINDATA Oikos
        // v5.12: UI COMPLETA Blindata con tutti i campi
        function renderBlindataConfig(project, pos, ing) {
            const bld = ing.blindata || {};
            return `
                <div class="product-card border-red-300">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-red-700 text-lg">üîê Porta Blindata Oikos</h4>
                    </div>
                    
                    <!-- üìê DIMENSIONI -->
                    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-red-800 mb-3">üìê Dimensioni Luce Netta Passaggio</h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">Larghezza (mm)</label>
                                <input type="number" value="${bld.LNP_L || ''}" placeholder="es. 900"
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'LNP_L', this.value)"
                                       class="w-full compact-input border rounded mt-1 font-bold">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Altezza (mm)</label>
                                <input type="number" value="${bld.LNP_H || ''}" placeholder="es. 2100"
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'LNP_H', this.value)"
                                       class="w-full compact-input border rounded mt-1 font-bold">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Luce Calcolata</label>
                                <div class="w-full px-3 py-2 bg-gray-100 border rounded mt-1 font-bold text-center">
                                    ${bld.luceCalcolata ? bld.luceCalcolata.toUpperCase() : '-'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ‚öôÔ∏è CONFIGURAZIONE BASE -->
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-yellow-800 mb-3">‚öôÔ∏è Configurazione Base</h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">Versione</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'versione', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    <option value="E3" ${bld.versione === 'E3' ? 'selected' : ''}>E3 - Evolution 3</option>
                                    <option value="E4" ${bld.versione === 'E4' ? 'selected' : ''}>E4 - Evolution 4</option>
                                    <option value="E3D" ${bld.versione === 'E3D' ? 'selected' : ''}>E3D - Doppia Anta</option>
                                    <option value="E3EI30" ${bld.versione === 'E3EI30' ? 'selected' : ''}>E3 EI 30 - Fuoco 30min</option>
                                    <option value="E3EI45" ${bld.versione === 'E3EI45' ? 'selected' : ''}>E3 EI 45 - Fuoco 45min</option>
                                    <option value="E3EI60" ${bld.versione === 'E3EI60' ? 'selected' : ''}>E3 EI 60 - Fuoco 60min</option>
                                    <option value="E3TT086" ${bld.versione === 'E3TT086' ? 'selected' : ''}>E3 TT U=0.86 - Taglio Termico</option>
                                    <option value="E3TT1" ${bld.versione === 'E3TT1' ? 'selected' : ''}>E3 TT U=1.0 - Taglio Termico</option>
                                    <option value="P3" ${bld.versione === 'P3' ? 'selected' : ''}>P3 - Project Rasomuro</option>
                                    <option value="T3" ${bld.versione === 'T3' ? 'selected' : ''}>T3 - Tekno</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Tipo Anta</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'tipoAnta', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="singola" ${bld.tipoAnta === 'singola' ? 'selected' : ''}>Singola</option>
                                    <option value="doppia" ${bld.tipoAnta === 'doppia' ? 'selected' : ''}>Doppia</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Senso Apertura</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'sensoApertura', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    <option value="SX" ${bld.sensoApertura === 'SX' ? 'selected' : ''}>Sinistra (SX)</option>
                                    <option value="DX" ${bld.sensoApertura === 'DX' ? 'selected' : ''}>Destra (DX)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Verso Apertura</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'versoApertura', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    <option value="spingere" ${bld.versoApertura === 'spingere' ? 'selected' : ''}>Spingere</option>
                                    <option value="tirare" ${bld.versoApertura === 'tirare' ? 'selected' : ''}>Tirare</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Controtelaio</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'controtelaio', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="si" ${bld.controtelaio === 'si' ? 'selected' : ''}>S√¨, con porta</option>
                                    <option value="fornito" ${bld.controtelaio === 'fornito' ? 'selected' : ''}>Gi√† fornito</option>
                                    <option value="no" ${bld.controtelaio === 'no' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üîß PRESTAZIONI -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-blue-800 mb-3">üîß Prestazioni</h5>
                        <div class="grid md:grid-cols-4 gap-3">
                            <div>
                                <label class="text-xs font-medium">Cilindro</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'cilindro', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="BASIC" ${bld.cilindro === 'BASIC' ? 'selected' : ''}>Basic (‚Ç¨123)</option>
                                    <option value="SEKUR" ${bld.cilindro === 'SEKUR' ? 'selected' : ''}>Sekur (‚Ç¨238)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Tipo Cilindro</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'tipoCilindro', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="pomolo-chiave" ${bld.tipoCilindro === 'pomolo-chiave' ? 'selected' : ''}>Pomolo + Chiave (std)</option>
                                    <option value="chiave-chiave" ${bld.tipoCilindro === 'chiave-chiave' ? 'selected' : ''}>Chiave + Chiave</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">N¬∞ Chiavi</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'numChiavi', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="3" ${bld.numChiavi === '3' || !bld.numChiavi ? 'selected' : ''}>3 (standard)</option>
                                    <option value="4" ${bld.numChiavi === '4' ? 'selected' : ''}>4</option>
                                    <option value="5" ${bld.numChiavi === '5' ? 'selected' : ''}>5</option>
                                    <option value="6" ${bld.numChiavi === '6' ? 'selected' : ''}>6</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Colore Telaio</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'coloreTelaio', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="RAL8022" ${bld.coloreTelaio === 'RAL8022' ? 'selected' : ''}>RAL 8022 (base)</option>
                                    <option value="OIKOS_Polveri" ${bld.coloreTelaio === 'OIKOS_Polveri' ? 'selected' : ''}>OIKOS Polveri (+‚Ç¨246)</option>
                                    <option value="OIKOS_Evergreen" ${bld.coloreTelaio === 'OIKOS_Evergreen' ? 'selected' : ''}>OIKOS Evergreen (+‚Ç¨320)</option>
                                    <option value="OIKOS_Future" ${bld.coloreTelaio === 'OIKOS_Future' ? 'selected' : ''}>OIKOS Future (+‚Ç¨384)</option>
                                    <option value="OIKOS_Liquido" ${bld.coloreTelaio === 'OIKOS_Liquido' ? 'selected' : ''}>OIKOS Liquido (+‚Ç¨492)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- üö™ MANIGLIE INT/EST -->
                        <div class="mt-3 pt-3 border-t border-blue-200">
                            <h6 class="text-xs font-semibold text-blue-700 mb-2">üö™ Maniglie e Pomoli</h6>
                            <div class="grid md:grid-cols-4 gap-3">
                                <!-- Maniglia Interna -->
                                <div>
                                    <label class="text-xs font-medium">Maniglia INT</label>
                                    <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'manigliaInt', this.value)"
                                            class="w-full compact-input border rounded mt-1">
                                        <option value="MO-05" ${bld.manigliaInt === 'MO-05' || !bld.manigliaInt ? 'selected' : ''}>MO-05 Standard</option>
                                        <option value="MO-07Q" ${bld.manigliaInt === 'MO-07Q' ? 'selected' : ''}>MO-07Q Quadra</option>
                                        <option value="MO-07T" ${bld.manigliaInt === 'MO-07T' ? 'selected' : ''}>MO-07T Tonda</option>
                                        <option value="MO-08Q" ${bld.manigliaInt === 'MO-08Q' ? 'selected' : ''}>MO-08Q Quadra</option>
                                        <option value="MO-08T" ${bld.manigliaInt === 'MO-08T' ? 'selected' : ''}>MO-08T Tonda</option>
                                        <option value="MO-13Q" ${bld.manigliaInt === 'MO-13Q' ? 'selected' : ''}>MO-13Q Quadra</option>
                                        <option value="MO-13T" ${bld.manigliaInt === 'MO-13T' ? 'selected' : ''}>MO-13T Tonda</option>
                                        <option value="MO-03T" ${bld.manigliaInt === 'MO-03T' ? 'selected' : ''}>MO-03T</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Finitura INT</label>
                                    <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'finituraInt', this.value)"
                                            class="w-full compact-input border rounded mt-1">
                                        <option value="OL" ${bld.finituraInt === 'OL' || !bld.finituraInt ? 'selected' : ''}>OL - Ottone Lucido (std)</option>
                                        <option value="OL_TZ" ${bld.finituraInt === 'OL_TZ' ? 'selected' : ''}>OL TZ - PVD Superior</option>
                                        <option value="CS" ${bld.finituraInt === 'CS' ? 'selected' : ''}>CS - Cromo Satinato</option>
                                        <option value="CL" ${bld.finituraInt === 'CL' ? 'selected' : ''}>CL - Cromo Lucido</option>
                                        <option value="VP" ${bld.finituraInt === 'VP' ? 'selected' : ''}>VP - Verniciato Polvere</option>
                                        <option value="VL" ${bld.finituraInt === 'VL' ? 'selected' : ''}>VL - Verniciato Liquido</option>
                                        <option value="VS" ${bld.finituraInt === 'VS' ? 'selected' : ''}>VS - Verniciato Skydoors</option>
                                    </select>
                                </div>
                                <!-- Maniglia/Pomolo Esterno -->
                                <div>
                                    <label class="text-xs font-medium">Esterno</label>
                                    <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'manigliaEst', this.value)"
                                            class="w-full compact-input border rounded mt-1">
                                        <option value="PO-05" ${bld.manigliaEst === 'PO-05' || !bld.manigliaEst ? 'selected' : ''}>PO-05 Pomolo (std)</option>
                                        <option value="PO-02" ${bld.manigliaEst === 'PO-02' ? 'selected' : ''}>PO-02 Pomolo TZ</option>
                                        <option value="PO-INOX" ${bld.manigliaEst === 'PO-INOX' ? 'selected' : ''}>Pomolo INOX (+‚Ç¨76)</option>
                                        <option value="MO-05" ${bld.manigliaEst === 'MO-05' ? 'selected' : ''}>MO-05 Maniglia</option>
                                        <option value="JUMBO-300" ${bld.manigliaEst === 'JUMBO-300' ? 'selected' : ''}>JUMBO 300 Maniglione</option>
                                        <option value="JUMBO-600" ${bld.manigliaEst === 'JUMBO-600' ? 'selected' : ''}>JUMBO 600 Maniglione</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Finitura EST</label>
                                    <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'finituraEst', this.value)"
                                            class="w-full compact-input border rounded mt-1">
                                        <option value="OL" ${bld.finituraEst === 'OL' || !bld.finituraEst ? 'selected' : ''}>OL - Ottone Lucido (std)</option>
                                        <option value="OL_TZ" ${bld.finituraEst === 'OL_TZ' ? 'selected' : ''}>OL TZ - PVD Superior</option>
                                        <option value="CS" ${bld.finituraEst === 'CS' ? 'selected' : ''}>CS - Cromo Satinato</option>
                                        <option value="CL" ${bld.finituraEst === 'CL' ? 'selected' : ''}>CL - Cromo Lucido</option>
                                        <option value="VP" ${bld.finituraEst === 'VP' ? 'selected' : ''}>VP - Verniciato Polvere</option>
                                        <option value="VL" ${bld.finituraEst === 'VL' ? 'selected' : ''}>VL - Verniciato Liquido</option>
                                        <option value="VS" ${bld.finituraEst === 'VS' ? 'selected' : ''}>VS - Verniciato Skydoors</option>
                                        <option value="OB" ${bld.finituraEst === 'OB' ? 'selected' : ''}>OB - Ottone Brunito</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Acustica e Termica -->
                        <div class="mt-3 pt-3 border-t border-blue-200 grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium">Acustica</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'acustica', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="serie" ${bld.acustica === 'serie' ? 'selected' : ''}>Di serie (40dB)</option>
                                    <option value="maggiorata" ${bld.acustica === 'maggiorata' ? 'selected' : ''}>Maggiorata 45dB (+‚Ç¨120)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Termica (U)</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'termica', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="serie" ${bld.termica === 'serie' ? 'selected' : ''}>Di serie (U=1.9)</option>
                                    <option value="1.2" ${bld.termica === '1.2' ? 'selected' : ''}>U=1.2</option>
                                    <option value="1.0" ${bld.termica === '1.0' ? 'selected' : ''}>U=1.0</option>
                                </select>
                            </div>
                        </div>
                        <!-- KIT AAV -->
                        <div class="mt-3 pt-3 border-t border-blue-200">
                            <label class="text-xs font-medium">üí® Kit Aria-Acqua-Vento (A4-5A-C5)</label>
                            <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'kitAAV', this.value)"
                                    class="w-full compact-input border rounded mt-1">
                                <option value="" ${!bld.kitAAV ? 'selected' : ''}>Nessuno (di serie A0-0-C4)</option>
                                <option value="MOSE" ${bld.kitAAV === 'MOSE' ? 'selected' : ''}>Kit MOSE 4/5A/C5 (+‚Ç¨405-499)</option>
                                <option value="DAM" ${bld.kitAAV === 'DAM' ? 'selected' : ''}>Kit DAM 4/5A/C5 (+‚Ç¨459-514)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ü™ü OPTIONAL -->
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-purple-800 mb-3">ü™ü Optional</h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <!-- VETRO -->
                            <div class="bg-purple-100 rounded p-2">
                                <label class="flex items-center gap-2 cursor-pointer text-sm mb-1">
                                    <input type="checkbox" 
                                           ${bld.vetro?.attivo ? 'checked' : ''}
                                           onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'vetro', 'attivo', this.checked)"
                                           class="w-4 h-4">
                                    <span class="font-medium">ü™ü Vetro</span>
                                </label>
                                ${bld.vetro?.attivo ? `
                                    <div class="space-y-1 pl-6">
                                        <select onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'vetro', 'tipo', this.value)"
                                                class="w-full px-2 py-1 border rounded text-xs">
                                            <option value="">Tipo...</option>
                                            <option value="V1" ${bld.vetro?.tipo === 'V1' ? 'selected' : ''}>V1 Isola</option>
                                            <option value="V2" ${bld.vetro?.tipo === 'V2' ? 'selected' : ''}>V2 800 Veneto</option>
                                            <option value="V3" ${bld.vetro?.tipo === 'V3' ? 'selected' : ''}>V3 Classica</option>
                                            <option value="V4" ${bld.vetro?.tipo === 'V4' ? 'selected' : ''}>V4 Musa</option>
                                            <option value="V5" ${bld.vetro?.tipo === 'V5' ? 'selected' : ''}>V5 Rialto</option>
                                        </select>
                                        <select onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'vetro', 'finitura', this.value)"
                                                class="w-full px-2 py-1 border rounded text-xs">
                                            <option value="trasparente" ${bld.vetro?.finitura === 'trasparente' ? 'selected' : ''}>Trasparente</option>
                                            <option value="sabbiato" ${bld.vetro?.finitura === 'sabbiato' ? 'selected' : ''}>Sabbiato (+‚Ç¨216)</option>
                                        </select>
                                        <label class="flex items-center gap-1 text-xs">
                                            <input type="checkbox" 
                                                   ${bld.vetro?.termico ? 'checked' : ''}
                                                   onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'vetro', 'termico', this.checked)"
                                                   class="w-3 h-3">
                                            <span>Termico (+‚Ç¨300~‚Ç¨400)</span>
                                        </label>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- SOPRALUCE -->
                            <div class="bg-purple-100 rounded p-2">
                                <label class="flex items-center gap-2 cursor-pointer text-sm mb-1">
                                    <input type="checkbox" 
                                           ${bld.sopraluce?.attivo ? 'checked' : ''}
                                           onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'sopraluce', 'attivo', this.checked)"
                                           class="w-4 h-4">
                                    <span class="font-medium">üîù Sopraluce</span>
                                </label>
                                ${bld.sopraluce?.attivo ? `
                                    <div class="space-y-1 pl-6">
                                        <select onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'sopraluce', 'altezza', this.value)"
                                                class="w-full px-2 py-1 border rounded text-xs">
                                            <option value="">Altezza...</option>
                                            <option value="H500" ${bld.sopraluce?.altezza === 'H500' ? 'selected' : ''}>H ‚â§ 500</option>
                                            <option value="H800" ${bld.sopraluce?.altezza === 'H800' ? 'selected' : ''}>H ‚â§ 800</option>
                                        </select>
                                        <label class="flex items-center gap-1 text-xs">
                                            <input type="checkbox" 
                                                   ${bld.sopraluce?.sabbiato ? 'checked' : ''}
                                                   onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'sopraluce', 'sabbiato', this.checked)"
                                                   class="w-3 h-3">
                                            <span>Sabbiato (+‚Ç¨78-200)</span>
                                        </label>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- FIANCOLUCE -->
                            <div class="bg-purple-100 rounded p-2">
                                <label class="flex items-center gap-2 cursor-pointer text-sm mb-1">
                                    <input type="checkbox" 
                                           ${bld.fiancoluce?.attivo ? 'checked' : ''}
                                           onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'fiancoluce', 'attivo', this.checked)"
                                           class="w-4 h-4">
                                    <span class="font-medium">üìè Fiancoluce</span>
                                </label>
                                ${bld.fiancoluce?.attivo ? `
                                    <div class="space-y-1 pl-6">
                                        <label class="flex items-center gap-1 text-xs">
                                            <input type="checkbox" 
                                                   ${bld.fiancoluce?.conVetro ? 'checked' : ''}
                                                   onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'fiancoluce', 'conVetro', this.checked)"
                                                   class="w-3 h-3">
                                            <span>Con vetro (+‚Ç¨1000~‚Ç¨3000)</span>
                                        </label>
                                        <label class="flex items-center gap-1 text-xs">
                                            <input type="checkbox" 
                                                   ${bld.fiancoluce?.sabbiato ? 'checked' : ''}
                                                   onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'fiancoluce', 'sabbiato', this.checked)"
                                                   class="w-3 h-3">
                                            <span>Sabbiato (+‚Ç¨170-432)</span>
                                        </label>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- üé® RIVESTIMENTI -->
                    <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-orange-800 mb-3">üé® Rivestimenti</h5>
                        
                        <!-- RIVESTIMENTO INTERNO -->
                        <div class="bg-orange-100 rounded-lg p-3 mb-3">
                            <h6 class="font-medium text-orange-900 mb-2">üìã Interno</h6>
                            <div class="grid md:grid-cols-4 gap-2">
                                <div>
                                    <label class="text-xs font-medium">Linea</label>
                                    <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Int', 'linea', this.value)"
                                            class="w-full compact-input border rounded mt-1 text-sm">
                                        <option value="">Seleziona...</option>
                                        <option value="Piano" ${bld.rivestimentoInt?.linea === 'Piano' ? 'selected' : ''}>Piano</option>
                                        <option value="Fugato" ${bld.rivestimentoInt?.linea === 'Fugato' ? 'selected' : ''}>Fugato</option>
                                        <option value="Pantografato" ${bld.rivestimentoInt?.linea === 'Pantografato' ? 'selected' : ''}>Pantografato</option>
                                        <option value="Tekno" ${bld.rivestimentoInt?.linea === 'Tekno' ? 'selected' : ''}>Tekno</option>
                                        <option value="LegnoVivo" ${bld.rivestimentoInt?.linea === 'LegnoVivo' ? 'selected' : ''}>Legno Vivo</option>
                                        <option value="Massello" ${bld.rivestimentoInt?.linea === 'Massello' ? 'selected' : ''}>Massello</option>
                                        <option value="Alluminio" ${bld.rivestimentoInt?.linea === 'Alluminio' ? 'selected' : ''}>Alluminio</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Modello</label>
                                    <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Int', 'modello', this.value)"
                                            class="w-full compact-input border rounded mt-1 text-sm">
                                        <option value="">Seleziona...</option>
                                        ${getModelliRivestimento(bld.rivestimentoInt?.linea).map(m => 
                                            `<option value="${m}" ${bld.rivestimentoInt?.modello === m ? 'selected' : ''}>${m}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Essenza</label>
                                    <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Int', 'essenza', this.value)"
                                            class="w-full compact-input border rounded mt-1 text-sm">
                                        <option value="">Seleziona...</option>
                                        ${getEssenzeRivestimento(bld.rivestimentoInt?.linea, bld.rivestimentoInt?.modello).map(e => 
                                            `<option value="${e}" ${bld.rivestimentoInt?.essenza === e ? 'selected' : ''}>${e}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Tinta</label>
                                    <input type="text" 
                                           value="${bld.rivestimentoInt?.tinta || ''}"
                                           onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Int', 'tinta', this.value)"
                                           placeholder="es. Naturale, RAL..."
                                           class="w-full compact-input border rounded mt-1 text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <!-- RIVESTIMENTO ESTERNO -->
                        <div class="bg-yellow-100 rounded-lg p-3">
                            <h6 class="font-medium text-yellow-900 mb-2">üìã Esterno</h6>
                            <div class="grid md:grid-cols-4 gap-2">
                                <div>
                                    <label class="text-xs font-medium">Linea</label>
                                    <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'linea', this.value)"
                                            class="w-full compact-input border rounded mt-1 text-sm">
                                        <option value="">Seleziona...</option>
                                        <option value="Piano" ${bld.rivestimentoEst?.linea === 'Piano' ? 'selected' : ''}>Piano</option>
                                        <option value="Fugato" ${bld.rivestimentoEst?.linea === 'Fugato' ? 'selected' : ''}>Fugato</option>
                                        <option value="Pantografato" ${bld.rivestimentoEst?.linea === 'Pantografato' ? 'selected' : ''}>Pantografato</option>
                                        <option value="Tekno" ${bld.rivestimentoEst?.linea === 'Tekno' ? 'selected' : ''}>Tekno</option>
                                        <option value="LegnoVivo" ${bld.rivestimentoEst?.linea === 'LegnoVivo' ? 'selected' : ''}>Legno Vivo</option>
                                        <option value="Massello" ${bld.rivestimentoEst?.linea === 'Massello' ? 'selected' : ''}>Massello</option>
                                        <option value="Alluminio" ${bld.rivestimentoEst?.linea === 'Alluminio' ? 'selected' : ''}>Alluminio</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Modello</label>
                                    <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'modello', this.value)"
                                            class="w-full compact-input border rounded mt-1 text-sm">
                                        <option value="">Seleziona...</option>
                                        ${getModelliRivestimento(bld.rivestimentoEst?.linea).map(m => 
                                            `<option value="${m}" ${bld.rivestimentoEst?.modello === m ? 'selected' : ''}>${m}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Essenza</label>
                                    <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'essenza', this.value)"
                                            class="w-full compact-input border rounded mt-1 text-sm">
                                        <option value="">Seleziona...</option>
                                        ${getEssenzeRivestimento(bld.rivestimentoEst?.linea, bld.rivestimentoEst?.modello).map(e => 
                                            `<option value="${e}" ${bld.rivestimentoEst?.essenza === e ? 'selected' : ''}>${e}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Tinta</label>
                                    <input type="text" 
                                           value="${bld.rivestimentoEst?.tinta || ''}"
                                           onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'tinta', this.value)"
                                           placeholder="es. Naturale, RAL..."
                                           class="w-full compact-input border rounded mt-1 text-sm">
                                </div>
                            </div>
                            <!-- VERNICIATURA ESTERNI -->
                            <div class="mt-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" 
                                           ${bld.rivestimentoEst?.verniciatura ? 'checked' : ''}
                                           onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'verniciatura', this.checked)"
                                           class="w-4 h-4">
                                    <span class="text-sm font-medium">üåßÔ∏è Verniciatura per esterni (+‚Ç¨150)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üö™ CORNICI E IMBOTTI (v5.13) -->
                    <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-teal-800 mb-3">üö™ Cornici e Imbotti</h5>
                        
                        <!-- IMBOTTE ESTERNO -->
                        <div class="bg-teal-100 rounded-lg p-3 mb-3">
                            <h6 class="font-medium text-teal-900 mb-2">üìè Imbotte Esterno</h6>
                            <div class="grid md:grid-cols-4 gap-2">
                                <div>
                                    <label class="text-xs font-medium">Tipo</label>
                                    <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'imbotteEst', this.value)"
                                            class="w-full compact-input border rounded mt-1 text-sm">
                                        <option value="" ${!bld.imbotteEst ? 'selected' : ''}>Nessuno</option>
                                        <option value="imbotte_cornici" ${bld.imbotteEst === 'imbotte_cornici' ? 'selected' : ''}>Imbotte con Cornici</option>
                                        <option value="solo_cornici" ${bld.imbotteEst === 'solo_cornici' ? 'selected' : ''}>Solo Cornici</option>
                                    </select>
                                </div>
                                ${bld.imbotteEst === 'imbotte_cornici' ? `
                                    <div>
                                        <label class="text-xs font-medium">Altezza</label>
                                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'imbotteEstAltezza', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="H1" ${bld.imbotteEstAltezza === 'H1' ? 'selected' : ''}>H1 (230+230+115 cm)</option>
                                            <option value="H2" ${bld.imbotteEstAltezza === 'H2' ? 'selected' : ''}>H2 (300+300+150 cm)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Larghezza</label>
                                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'imbotteEstLargh', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="L20" ${bld.imbotteEstLargh === 'L20' ? 'selected' : ''}>20 cm</option>
                                            <option value="L30" ${bld.imbotteEstLargh === 'L30' ? 'selected' : ''}>30 cm</option>
                                            <option value="custom" ${bld.imbotteEstLargh === 'custom' ? 'selected' : ''}>Personalizzata</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Essenza</label>
                                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'imbotteEstEssenza', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="tangMog" ${bld.imbotteEstEssenza === 'tangMog' ? 'selected' : ''}>Mogano/Tanganica</option>
                                            <option value="rovNoce" ${bld.imbotteEstEssenza === 'rovNoce' ? 'selected' : ''}>Rovere/Noce Naz.</option>
                                            <option value="laccato" ${bld.imbotteEstEssenza === 'laccato' ? 'selected' : ''}>Laccato Bianco/RAL</option>
                                            <option value="okoume" ${bld.imbotteEstEssenza === 'okoume' ? 'selected' : ''}>Okoum√®</option>
                                            <option value="okoumeRAL" ${bld.imbotteEstEssenza === 'okoumeRAL' ? 'selected' : ''}>Okoum√® Laccato RAL</option>
                                        </select>
                                    </div>
                                ` : ''}
                                ${bld.imbotteEst === 'solo_cornici' ? `
                                    <div>
                                        <label class="text-xs font-medium">Tipo Cornice</label>
                                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'corniceEstTipo', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-sm">
                                            <option value="">Seleziona...</option>
                                            <option value="CF1" ${bld.corniceEstTipo === 'CF1' ? 'selected' : ''}>CF1 70x10mm</option>
                                            <option value="CF2" ${bld.corniceEstTipo === 'CF2' ? 'selected' : ''}>CF2 90x10mm</option>
                                            <option value="CT1" ${bld.corniceEstTipo === 'CT1' ? 'selected' : ''}>CT1 Copritelaio</option>
                                            <option value="CC2" ${bld.corniceEstTipo === 'CC2' ? 'selected' : ''}>CC2 Copritubolari 120x10</option>
                                            <option value="CC3" ${bld.corniceEstTipo === 'CC3' ? 'selected' : ''}>CC3 Copritubolari 180x10</option>
                                            <option value="KIT_ALU_70" ${bld.corniceEstTipo === 'KIT_ALU_70' ? 'selected' : ''}>Kit Alluminio 70x10</option>
                                            <option value="KIT_ALU_90" ${bld.corniceEstTipo === 'KIT_ALU_90' ? 'selected' : ''}>Kit Alluminio 90x10</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Essenza/Finitura</label>
                                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'corniceEstEssenza', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-sm">
                                            <option value="">Seleziona...</option>
                                            ${bld.corniceEstTipo?.startsWith('KIT_ALU') ? `
                                                <option value="polveri" ${bld.corniceEstEssenza === 'polveri' ? 'selected' : ''}>Colori OIKOS Polveri</option>
                                                <option value="evergreen" ${bld.corniceEstEssenza === 'evergreen' ? 'selected' : ''}>OIKOS Evergreen</option>
                                                <option value="future" ${bld.corniceEstEssenza === 'future' ? 'selected' : ''}>OIKOS Future</option>
                                                <option value="liquido" ${bld.corniceEstEssenza === 'liquido' ? 'selected' : ''}>OIKOS Liquido</option>
                                                <option value="spazzolato" ${bld.corniceEstEssenza === 'spazzolato' ? 'selected' : ''}>Alluminio Spazzolato</option>
                                            ` : `
                                                <option value="tangMog" ${bld.corniceEstEssenza === 'tangMog' ? 'selected' : ''}>Tanganica/Mogano</option>
                                                <option value="rovNoce" ${bld.corniceEstEssenza === 'rovNoce' ? 'selected' : ''}>Rovere/Noce</option>
                                                <option value="okoume" ${bld.corniceEstEssenza === 'okoume' ? 'selected' : ''}>Okoum√®</option>
                                                <option value="laccRAL" ${bld.corniceEstEssenza === 'laccRAL' ? 'selected' : ''}>Laccato RAL</option>
                                            `}
                                        </select>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- CORNICI INTERNE FERMA PANNELLO -->
                        <div class="bg-cyan-100 rounded-lg p-3">
                            <h6 class="font-medium text-cyan-900 mb-2">üìê Cornici in Legno Ferma Pannello (interno)</h6>
                            <div class="grid md:grid-cols-2 gap-2">
                                <div>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" 
                                               ${bld.corniciFermaPannello ? 'checked' : ''}
                                               onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'corniciFermaPannello', this.checked)"
                                               class="w-4 h-4">
                                        <span class="text-sm font-medium">Aggiungi cornici ferma pannello</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">
                                        ${bld.tipoAnta === 'doppia' ? '‚Ç¨228 (doppia anta)' : '‚Ç¨114 (anta singola)'} - Luce 0-4
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üìù NOTE -->
                    <div>
                        <label class="text-xs font-medium">üìù Note</label>
                        <textarea onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'note', this.value)"
                                  placeholder="Note aggiuntive..." class="w-full compact-input border rounded mt-1 h-16">${bld.note || ''}</textarea>
                    </div>
                </div>
            `;
        }
        
        // üö™ Funzioni update per ingresso
        window.updateIngresso = function(projectId, positionId, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === positionId);
            if (!pos) return;
            
            if (!pos.ingresso) pos.ingresso = {};
            pos.ingresso[field] = value;
            
            // v5.12: Quando si cambia tipo, PULISCI l'altro tipo per evitare confusione export
            if (field === 'tipo') {
                if (value === 'portoncino') {
                    // Passa a portoncino ‚Üí elimina blindata
                    delete pos.ingresso.blindata;
                    if (!pos.ingresso.portoncino) {
                        pos.ingresso.portoncino = { azienda: 'Finstral' };
                    }
                    console.log('üö™ Tipo cambiato a PORTONCINO - rimossa config blindata');
                }
                if (value === 'blindata') {
                    // Passa a blindata ‚Üí elimina portoncino
                    delete pos.ingresso.portoncino;
                    if (!pos.ingresso.blindata) {
                        pos.ingresso.blindata = { 
                            azienda: 'Oikos', 
                            tipoAnta: 'singola', 
                            cilindro: 'BASIC',
                            tipoCilindro: 'pomolo-chiave',
                            numChiavi: '3',
                            coloreTelaio: 'RAL8022',
                            manigliaInt: 'MO-05',
                            finituraInt: 'OL',
                            manigliaEst: 'PO-05',
                            finituraEst: 'OL',
                            acustica: 'serie',
                            termica: 'serie',
                            kitAAV: '',
                            vetro: { attivo: false, tipo: '', finitura: 'trasparente', termico: false },
                            sopraluce: { attivo: false, altezza: '', sabbiato: false },
                            fiancoluce: { attivo: false, conVetro: false, sabbiato: false, colore: 'RAL8022' },
                            rivestimentoInt: { linea: '', modello: '', essenza: '', tinta: '' },
                            rivestimentoEst: { linea: '', modello: '', essenza: '', tinta: '', verniciatura: false }
                        };
                    }
                    console.log('üîê Tipo cambiato a BLINDATA - rimossa config portoncino');
                }
                if (value === '') {
                    // Nessun tipo selezionato ‚Üí pulisci tutto
                    delete pos.ingresso.portoncino;
                    delete pos.ingresso.blindata;
                    console.log('üö™ Tipo rimosso - pulite tutte le config');
                }
            }
            
            console.log(`üö™ ingresso.${field} = ${value}`);
            saveState();
            render();
        };
        
        window.updateIngressoData = function(projectId, positionId, prodotto, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === positionId);
            if (!pos || !pos.ingresso) return;
            
            if (!pos.ingresso[prodotto]) pos.ingresso[prodotto] = {};
            pos.ingresso[prodotto][field] = value;
            
            // Calcola luce per blindata
            if (prodotto === 'blindata' && (field === 'LNP_L' || field === 'LNP_H')) {
                const L = parseFloat(pos.ingresso.blindata.LNP_L) || 0;
                const H = parseFloat(pos.ingresso.blindata.LNP_H) || 0;
                if (typeof calcolaLuceOikos === 'function') {
                    pos.ingresso.blindata.luceCalcolata = calcolaLuceOikos(L, H);
                }
            }
            
            console.log(`üö™ ingresso.${prodotto}.${field} = ${value}`);
            saveState();
            render();
        };
        
        // v5.12: Update Optional per blindata in ingresso
        window.updateIngressoBlindataOpt = function(projectId, positionId, optional, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === positionId);
            if (!pos || !pos.ingresso || !pos.ingresso.blindata) return;
            
            if (!pos.ingresso.blindata[optional]) {
                pos.ingresso.blindata[optional] = {};
            }
            
            pos.ingresso.blindata[optional][field] = value;
            console.log(`üîê ingresso.blindata.${optional}.${field} = ${value}`);
            saveState();
            render();
        };
        
        // v5.12: Update Rivestimenti per blindata in ingresso
        window.updateIngressoBlindataRiv = function(projectId, positionId, tipo, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === positionId);
            if (!pos || !pos.ingresso || !pos.ingresso.blindata) return;
            
            const rivKey = `rivestimento${tipo}`;
            if (!pos.ingresso.blindata[rivKey]) {
                pos.ingresso.blindata[rivKey] = {};
            }
            
            pos.ingresso.blindata[rivKey][field] = value;
            
            // Pulisci campi dipendenti quando cambia linea
            if (field === 'linea') {
                pos.ingresso.blindata[rivKey].modello = '';
                pos.ingresso.blindata[rivKey].essenza = '';
                pos.ingresso.blindata[rivKey].tinta = '';
            }
            // Pulisci essenza quando cambia modello
            if (field === 'modello') {
                pos.ingresso.blindata[rivKey].essenza = '';
                pos.ingresso.blindata[rivKey].tinta = '';
            }
            
            console.log(`üé® ingresso.blindata.${rivKey}.${field} = ${value}`);
            saveState();
            render();
        };

        // üÜï FASE 014 - Helper per verificare se rilievo posizione √® diverso da globale
        function isRilievoPersonalizzato(project, pos, productType) {
            // FIX: Per infissi il campo √® 'rilievo', per altri prodotti √® 'rilievo[Prodotto]'
            const rilievoKey = productType === 'infissi' ? 'rilievo' : `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const rilievoPos = pos[rilievoKey];
            const rilievoGlobale = getRilievoGlobale(project, productType);
            
            // Se non esiste il rilievo posizione, non √® personalizzato
            if (!rilievoPos) return false;
            
            // Confronta tutti i campi
            const campiDiversi = [];
            
            if (rilievoPos.materiale !== rilievoGlobale.materiale) {
                campiDiversi.push('Materiale');
            }
            if (rilievoPos.note !== rilievoGlobale.note) {
                campiDiversi.push('Note');
            }
            if (rilievoPos.togliere !== rilievoGlobale.togliere) {
                campiDiversi.push('Togliere');
            }
            if (rilievoPos.smaltimento !== rilievoGlobale.smaltimento) {
                campiDiversi.push('Smaltimento');
            }
            if (productType === 'infissi') {
                if (rilievoPos.coprifiliInt !== rilievoGlobale.coprifiliInt) {
                    campiDiversi.push('Coprifili INT');
                }
                if (rilievoPos.coprifiliEst !== rilievoGlobale.coprifiliEst) {
                    campiDiversi.push('Coprifili EST');
                }
            }
            
            return {
                isPersonalizzato: campiDiversi.length > 0,
                campiDiversi: campiDiversi
            };
        }

        function renderRilievoPerProdotto(project, pos, productType, productLabel, hasCoprifili) {
            // FIX: Per infissi il campo √® 'rilievo', per altri prodotti √® 'rilievo[Prodotto]'
            const rilievoKey = productType === 'infissi' ? 'rilievo' : `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const r = pos[rilievoKey] || {};
            
            // üÜï FASE 014 - Controlla se rilievo √® personalizzato
            const personalizz = isRilievoPersonalizzato(project, pos, productType);
            
            // Calcola completezza specifica per questo prodotto
            let completed = 0;
            let total = 3; // materiale, togliere, smaltimento
            if (hasCoprifili) total = 5; // + coprifiliInt, coprifiliEst
            
            if (r.materiale && r.materiale.trim() !== '') completed++;
            if (r.togliere !== undefined && r.togliere !== null) completed++;
            if (r.smaltimento !== undefined && r.smaltimento !== null) completed++;
            if (hasCoprifili) {
                if (r.coprifiliInt !== undefined && r.coprifiliInt !== null) completed++;
                if (r.coprifiliEst !== undefined && r.coprifiliEst !== null) completed++;
            }
            
            const percentage = Math.round((completed / total) * 100);
            
            // Determina status
            let icon, color, statusText, badge;
            if (percentage === 0) {
                icon = '‚ö™'; color = 'gray'; statusText = 'NON INIZIATO'; badge = 'bg-gray-500';
            } else if (percentage < 50) {
                icon = 'üî¥'; color = 'red'; statusText = 'INCOMPLETO'; badge = 'bg-red-500';
            } else if (percentage < 100) {
                icon = 'üü°'; color = 'amber'; statusText = 'PARZIALE'; badge = 'bg-amber-500';
            } else {
                icon = 'üü¢'; color = 'green'; statusText = 'COMPLETO'; badge = 'bg-green-500';
            }
            
            const uniqueId = `${pos.id}-${productType}`;
            const collapseId = `rilievo-collapse-${uniqueId}`;
            
            return `
                <!-- üÜï FASE 014: Pulsante per mostrare/nascondere rilievo -->
                <div class="mb-4">
                    <button onclick="document.getElementById('${collapseId}').style.display = document.getElementById('${collapseId}').style.display === 'none' ? 'block' : 'none'; this.innerHTML = document.getElementById('${collapseId}').style.display === 'none' ? 'RILIEVO PREESISTENTE - ${productLabel}' : '‚úñ Nascondi Rilievo';"
                            class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 border-2 ${personalizz.isPersonalizzato ? 'border-orange-400' : 'border-gray-300'} rounded-lg font-semibold text-sm transition flex items-center justify-between">
                        <span>RILIEVO PREESISTENTE - ${productLabel}</span>
                        ${personalizz.isPersonalizzato ? `
                            <span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full">
                                ‚ö†Ô∏è PERSONALIZZATO
                            </span>
                        ` : ''}
                    </button>
                </div>
                
                <!-- üÜï FASE 014: Sezione rilievo COLLASSATA per default -->
                <div id="${collapseId}" style="display: none;">
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 ${color === 'green' ? 'border-green-400' : color === 'amber' ? 'border-amber-400' : color === 'red' ? 'border-red-400' : 'border-gray-300'} rounded-lg p-4 shadow-md mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    üìã RILIEVO PREESISTENTE - ${productLabel}
                                </h3>
                                <p class="text-xs text-gray-600 mt-1">Compila tutte le informazioni per evitare dimenticanze</p>
                                ${personalizz.isPersonalizzato ? `
                                    <p class="text-xs text-orange-700 font-semibold mt-1">
                                        ‚ö†Ô∏è Diverso dal globale: ${personalizz.campiDiversi.join(', ')}
                                    </p>
                                ` : ''}
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <button onclick="copiaRilievoDaGlobaleProdotto('${project.id}', '${pos.id}', '${productType}')"
                                        class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg font-semibold transition"
                                        title="Copia solo dati Rilievo Preesistente (togliere, materiale, ecc.)">
                                    üì• Copia Rilievo
                                </button>
                                <div class="text-right">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-2xl">${icon}</span>
                                        <span class="text-sm font-bold text-${color}-700">${statusText}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div class="${badge} h-full transition-all duration-500" 
                                                 style="width: ${percentage}%"></div>
                                        </div>
                                        <span class="text-sm font-bold">${percentage}%</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">${completed}/${total} campi</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- 1. MATERIALE -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-semibold flex items-center gap-2">
                                        üîß Materiale
                                        ${!r.materiale || r.materiale.trim() === '' ? '<span class="text-red-600">‚óè</span>' : '<span class="text-green-600">‚úì</span>'}
                                    </label>
                                    <button onclick="toggleMaterialeProdottoMode('${uniqueId}')" 
                                            id="materiale-toggle-${uniqueId}"
                                            class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full font-medium transition">
                                        ‚úèÔ∏è Scrivi
                                    </button>
                                </div>
                                
                                <!-- SELECT MODE (default) -->
                                <select id="materiale-select-${uniqueId}"
                                        onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'materiale', this.value)"
                                        class="w-full px-3 py-2 border-2 ${!r.materiale || r.materiale.trim() === '' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-white'} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="">Seleziona...</option>
                                    <option value="Legno" ${r.materiale === 'Legno' ? 'selected' : ''}>Legno</option>
                                    <option value="PVC" ${r.materiale === 'PVC' ? 'selected' : ''}>PVC</option>
                                    <option value="Alluminio" ${r.materiale === 'Alluminio' ? 'selected' : ''}>Alluminio</option>
                                    <option value="Ferro" ${r.materiale === 'Ferro' ? 'selected' : ''}>Ferro</option>
                                </select>
                                
                                <!-- INPUT MODE (hidden by default) -->
                                <input type="text" 
                                       id="materiale-input-${uniqueId}"
                                       value="${r.materiale || ''}"
                                       oninput="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'materiale', this.value)"
                                       placeholder="Inserisci materiale..."
                                       style="display: none;"
                                       class="w-full px-3 py-2 border-2 ${!r.materiale || r.materiale.trim() === '' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-white'} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            
                            ${productType === 'tapparella' ? `
                            <!-- 2. TIPO AUTOMAZIONE (solo per Tapparelle) -->
                            <div>
                                <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                                    ‚öôÔ∏è Tipo Automazione
                                </label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button type="button"
                                            onclick="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'tipo', 'Manuale')"
                                            class="px-4 py-3 rounded-lg border-2 font-semibold transition ${r.tipo === 'Manuale' ? 'bg-blue-500 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}">
                                        üñêÔ∏è Manuale
                                    </button>
                                    <button type="button"
                                            onclick="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'tipo', 'Motorizzata')"
                                            class="px-4 py-3 rounded-lg border-2 font-semibold transition ${r.tipo === 'Motorizzata' ? 'bg-blue-500 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}">
                                        ‚ö° Motorizzata
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- 3. NOTE AGGIUNTIVE -->
                            <div>
                                <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                                    üìù Note
                                </label>
                                <input type="text" 
                                       value="${r.note || ''}"
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'note', this.value)"
                                       placeholder="Note aggiuntive..."
                                       class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        
                        <div class="grid ${hasCoprifili ? 'md:grid-cols-4' : 'md:grid-cols-2'} gap-4 mt-4 pt-4 border-t-2 border-gray-200">
                            <!-- CHECKBOX: TOGLIERE -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.togliere ? 'border-orange-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="togliere-${uniqueId}"
                                       ${r.togliere ? 'checked' : ''}
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'togliere', this.checked)"
                                       class="w-5 h-5 text-orange-600 rounded focus:ring-2 focus:ring-orange-500">
                                <label for="togliere-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    üî® Da togliere?
                                    ${r.togliere ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                </label>
                            </div>
                            
                            <!-- CHECKBOX: SMALTIMENTO -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.smaltimento ? 'border-red-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="smaltimento-${uniqueId}"
                                       ${r.smaltimento ? 'checked' : ''}
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'smaltimento', this.checked)"
                                       class="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500">
                                <label for="smaltimento-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    üóëÔ∏è Da smaltire?
                                    ${r.smaltimento ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                </label>
                            </div>
                            
                            ${hasCoprifili ? `
                                <!-- CHECKBOX: COPRIFILI INT (solo per Infissi) -->
                                <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.coprifiliInt ? 'border-blue-300' : 'border-gray-200'}">
                                    <input type="checkbox" 
                                           id="coprifiliInt-${uniqueId}"
                                           ${r.coprifiliInt ? 'checked' : ''}
                                           onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliInt', this.checked)"
                                           class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                    <label for="coprifiliInt-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                        üìè Coprifili INT?
                                        ${r.coprifiliInt ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                    </label>
                                </div>
                                
                                <!-- CHECKBOX: COPRIFILI EST (solo per Infissi) -->
                                <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.coprifiliEst ? 'border-purple-300' : 'border-gray-200'}">
                                    <input type="checkbox" 
                                           id="coprifiliEst-${uniqueId}"
                                           ${r.coprifiliEst ? 'checked' : ''}
                                           onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliEst', this.checked)"
                                           class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                                    <label for="coprifiliEst-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                        üìê Coprifili EST?
                                        ${r.coprifiliEst ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                    </label>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${percentage < 100 ? `
                            <div class="mt-3 p-2 bg-amber-100 border border-amber-300 rounded text-sm text-amber-800">
                                ‚ö†Ô∏è <strong>Attenzione:</strong> Compila tutti i campi per evitare dimenticanze!
                            </div>
                        ` : `
                            <div class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-800">
                                ‚úÖ <strong>Perfetto!</strong> Tutte le informazioni del rilievo sono complete.
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // ============================================
        // üîê DATABASE RIVESTIMENTI OIKOS (v5.00)
        // ============================================
        const OIKOS_RIVESTIMENTI = {
            // LINEA PIANO
            Piano: {
                modelli: ['Di Serie', 'Non di serie', 'Materici', 'Orizzontale', 'Verticale', 'Gres', 'Riflessi Vetro'],
                essenze: {
                    'Di Serie': ['Tanganica 1-2', 'Mogano 2-3', 'Laccato Bianco Oikos', 'Rovere 1', 'Noce Nazionale 2', 'MDF da Laccare', 'Supporto Cliente'],
                    // üîê v5.15: Non di serie - Impiallacciati verticale tranciato legno
                    'Non di serie': ['Rovere Naturale 2-3', 'Rovere Miele', 'Rovere Weng√®', 'Rovere Sbiancato', 'Tanganica 3', 'Castagno 2-3', 'Douglas 2', 'Pino 2', 'Noce Canaletto', 'Teak', 'Laccato RAL', 'Altre Essenze'],
                    'Materici': ['Bianco Talco', 'Grigio Talco', 'Bianco Sabl√®', 'Grigio Sabl√®', 'Bianco Rovere Sabl√®', 'Grigio Rovere Sabl√®'],
                    'Orizzontale': ['Rovere Naturale', 'Rovere Miele', 'Rovere Weng√®', 'Rovere Sbiancato', 'Tanganica', 'Noce Canaletto', 'Teak', 'Laccato RAL'],
                    'Verticale': ['Laccato Tendenza Poro Aperto', 'Spazzolato Rovere', 'Laccato Metallizzato', 'Rovere Raw'],
                    'Gres': ['Neve', 'Nero Assoluto', 'Calce Bianco', 'Calce Grigio', 'Calce Tortora', 'Cor-Ten Ruggine', 'Cemento Liscio', 'Ardesia', 'Pietra Piasentina'],
                    'Riflessi Vetro': ['Bianco Panna', 'Bianco', 'Bianco Gesso', 'Grigio', 'Bronzo', 'Tabacco', 'Moka', 'Nero', 'Platino', 'Oro']
                },
                tinte: {
                    'Rovere': ['Naturale', '1', '2', '3', 'Miele', 'Weng√®', 'Sbiancato'],
                    'Laccato': ['Bianco', 'RAL a richiesta'],
                    'Spazzolato': ['Bianco Gesso', 'Madreperla', 'Grigio Agata', 'Tabacco', 'Quercia Antica', 'Grigio Piombo']
                },
                prezziBase: {
                    'Di Serie': { luce0: 192, luce1: 192, luce2: 235, luce3: 346, luce4: 414 },
                    // üîê v5.15: Non di serie - Prezzi ANTA UNICA (pag. 99 listino EVO 2025)
                    // Luce 5/6 = Doppia Anta Tekno, Luce 3/4 = Doppia Anta Evolution
                    'Non di serie': { 
                        luce0: 405, luce1: 405, luce2: 483, // Rovere/Tanganica/Castagno/Douglas/Pino/Laccato RAL
                        luce5: 526, luce6: 585, luce3: 626, luce4: 811, luce7: 1104, luce8: 1333 
                    },
                    'Non di serie Noce Canaletto': { 
                        luce0: 458, luce1: 458, luce2: 545, 
                        luce5: 594, luce6: 660, luce3: 700, luce4: 889, luce7: 1101, luce8: 1317 
                    },
                    'Non di serie Teak': { 
                        luce0: 520, luce1: 520, luce2: 620, 
                        luce5: 675, luce6: 750, luce3: 782, luce4: 1005, luce7: 1243, luce8: 1488 
                    },
                    'Non di serie Altre Essenze': { 
                        luce0: 486, luce1: 486, luce2: 579, 
                        luce5: 631, luce6: 702, luce3: 751, luce4: 973, luce7: 1324, luce8: 1599 
                    },
                    'Materici': { luce0: 170, luce1: 170, luce2: 170 },
                    'Orizzontale': { luce0: 543, luce1: 543, luce2: 647 },
                    'Verticale': { luce0: 459, luce1: 459, luce2: 547 },
                    'Gres': { luce0: 1304, luce1: 1347, luce2: 1436 },
                    'Riflessi Vetro': { luce0: 1197, luce1: 1322, luce2: 1534 }
                }
            },
            // LINEA FUGATO
            Fugato: {
                modelli: ['Verticale', 'HTF', 'HTA', 'Scala'],
                essenze: {
                    'Verticale': ['Mogano 2-3', 'Tanganica 2', 'Pino Nodo 2', 'Douglas 2', 'Rovere 1-2-3', 'Laccato RAL'],
                    'HTF': ['Tanganica 1', 'Mogano 2', 'Rovere 1-2-3', 'Laccato Tendenza', 'Spazzolato Rovere', 'Rovere Raw'],
                    'HTA': ['Tanganica 1', 'Mogano 2', 'Rovere 1-2-3', 'Laccato RAL', 'Spazzolato Rovere', 'Rovere Raw'],
                    'Scala': ['Mogano 2-3', 'Tanganica 2', 'Pino Nodo 2', 'Douglas 2', 'Rovere 1-2-3', 'Laccato RAL']
                },
                tinte: {
                    'Rovere': ['Naturale', '1', '2', '3', 'Miele', 'Weng√®', 'Sbiancato'],
                    'Laccato': ['RAL a richiesta']
                },
                prezziBase: {
                    'Verticale': { luce0: 592, luce1: 592, luce2: 706, luce3: 894, luce4: 1156 },
                    'HTF': { luce0: 636, luce1: 636, luce2: 758, luce3: 1092, luce4: 1317 },
                    'HTA': { luce0: 786, luce1: 786, luce2: 908, luce3: 1242, luce4: 1467 },
                    'Scala': { luce0: 821, luce1: 821, luce2: 979, luce3: 1222, luce4: 1579 }
                }
            },
            // LINEA PANTOGRAFATO
            Pantografato: {
                modelli: ['NP Country', 'SR Country', 'MDF Laccato'],
                essenze: {
                    'NP Country': ['Okoum√® Tinta 6-7-8', 'Okoum√® Mogano', 'Okoum√® Laccato RAL'],
                    'SR Country': ['Okoum√® Tinta 6-7-8', 'Okoum√® Mogano', 'Okoum√® Laccato RAL'],
                    'MDF Laccato': ['MDF Laccato RAL']
                },
                disegni: ['Toscana', 'Milano', 'Gardenia', 'Impero', 'Genova', 'Isola', '800 Veneto', 'Classica', 'Victoria', 'Geranio', 'Glicine', 'Ciclamino', 'Giglio', 'Iris', 'Narciso'],
                prezziBase: {
                    'NP Country': { luce0: 791, luce1: 791, luce2: 968, luce3: 1235, luce4: 1477 },
                    'SR Country': { luce0: 908, luce1: 908, luce2: 1104, luce3: 1399, luce4: 1688 },
                    'MDF Laccato': { luce0: 622, luce1: 622, luce2: 728, luce3: 903, luce4: 1166 }
                }
            },
            // LINEA TEKNO
            Tekno: {
                modelli: ['HTA', 'HTO', 'HT1'],
                essenze: {
                    'HTA': ['Rovere Naturale', 'Rovere 1-2-3', 'Mogano 2', 'Tanganica 1', 'Laccato RAL', 'Laccato Tendenza', 'Spazzolato Rovere', 'Rovere Raw'],
                    'HTO': ['Rovere Naturale', 'Rovere 1-2-3', 'Mogano 2', 'Tanganica 1', 'Laccato RAL', 'Laccato Tendenza', 'Spazzolato Rovere', 'Rovere Raw'],
                    'HT1': ['Rovere Naturale', 'Rovere 1-2-3', 'Mogano 2', 'Tanganica 1', 'Laccato RAL', 'Laccato Tendenza', 'Spazzolato Rovere']
                },
                tinte: {
                    'Rovere': ['Naturale', '1', '2', '3', 'Miele', 'Weng√®', 'Sbiancato'],
                    'Laccato Tendenza': ['Bianco Seta', 'Bianco', 'Bianco Gesso', 'Grigio Ghiaia', 'Grigio Muschio', 'Moka', 'Grigio Piombo', 'Tabacco', 'Bronzo', 'Platino', 'Fumo', 'Oro', 'Rame'],
                    'Spazzolato': ['Bianco Gesso', 'Madreperla', 'Grigio Agata', 'Tabacco', 'Quercia Antica', 'Grigio Piombo']
                },
                prezziBase: {
                    'HTA': { luce0: 909, luce1: 1000, luce2: 1192 },
                    'HTO': { luce0: 833, luce1: 915, luce2: 1091 },
                    'HT1': { luce0: 909, luce1: 1000, luce2: 1192 }
                }
            },
            // LINEA LEGNO VIVO
            LegnoVivo: {
                modelli: ['Musa', 'Rialto', '800 Veneto', 'Classica', 'Toscana', 'Laguna'],
                essenze: {
                    'standard': ['Bianco Gesso', 'Madreperla', 'Tabacco', 'Grigio Agata', 'Grigio Piombo', 'Quercia Antica', 'Rovere Naturale', 'Rovere 1', 'Rovere 2', 'Rovere 3', 'Rovere Miele', 'Laccato RAL']
                },
                note: 'Rovere Spazzolato - Verniciatura esterni compresa',
                prezziBase: {
                    'Musa': { luce0: 1183, luce1: 1183, luce2: 1411, luce3: 1788, luce4: 2304 },
                    'Rialto': { luce0: 1183, luce1: 1183, luce2: 1411, luce3: 1788, luce4: 2304 },
                    '800 Veneto': { luce0: 1183, luce1: 1183, luce2: 1411, luce3: 1788, luce4: 2304 },
                    'Classica': { luce0: 1281, luce1: 1281, luce2: 1527, luce3: 1928, luce4: 2484 },
                    'Toscana': { luce0: 1281, luce1: 1281, luce2: 1527, luce3: 1928, luce4: 2484 },
                    'Laguna': { luce0: 1561, luce1: 1561, luce2: 1860, luce3: 2327, luce4: 2999 }
                }
            },
            // LINEA MASSELLO
            Massello: {
                modelli: ['Massello Standard'],
                essenze: {
                    'Massello Standard': ['Rovere', 'Noce', 'Castagno', 'Frassino']
                },
                note: 'Prezzi su richiesta'
            },
            // ALLUMINIO
            Alluminio: {
                modelli: ['Satinato', 'Spazzolato', 'Verniciato RAL'],
                colori: {
                    'Satinato': ['Argento', 'Bronzo', 'Champagne'],
                    'Spazzolato': ['Argento', 'Bronzo', 'Champagne', 'Nero'],
                    'Verniciato RAL': ['RAL a richiesta']
                },
                note: 'Prezzi su richiesta'
            }
        };
        
        // ============================================
        // üîê DATABASE PANNELLI LINEA PIANO (v5.13)
        // ============================================
        // Mod. DI SERIE: truciolare/MDF 9mm impiallacciato + pelabile
        // Mod. NON DI SERIE (falegnameria): senza pelabile, tinte mazzetta Oikos
        const OIKOS_PANNELLI_PIANO = {
            // Essenze con prezzi per luce e tipo anta
            essenze: [
                { cod: 'ROV_NAT', nome: 'Rovere Naturale 2-3 / Miele / Weng√® / Sbiancato', gruppo: 1 },
                { cod: 'TANG', nome: 'Tanganica 3', gruppo: 1 },
                { cod: 'CAST', nome: 'Castagno 2-3 / Douglas 2 / Pino 2', gruppo: 1 },
                { cod: 'NOCE', nome: 'Noce Canaletto', gruppo: 2 },
                { cod: 'TEAK', nome: 'Teak', gruppo: 3 },
                { cod: 'LACC_RAL', nome: 'Laccato RAL / Laccati di Tendenza', gruppo: 1 },
                { cod: 'ALTRE', nome: 'Altre Essenze a Conferma', gruppo: 4 },
                { cod: 'MDF_LACC', nome: 'MDF da Laccare (per porta Evolution EI)', gruppo: 5 },
                { cod: 'MDF_RAL', nome: 'MDF Laccato RAL (per porta Evolution EI)', gruppo: 6 }
            ],
            // Prezzi NON DI SERIE per gruppo
            prezzi: {
                // gruppo 1: Rovere, Tanganica, Castagno, Laccato RAL
                1: { 
                    antaUnica: { luce01: 405, luce2: 483 },
                    antaUnicaTekno: { luce5: 526, luce6: 585 },
                    doppiaAntaEvolution: { luce3: 626, luce4: 811 },
                    doppiaAntaTekno: { luce7: 1104, luce8: 1333 }
                },
                // gruppo 2: Noce Canaletto
                2: {
                    antaUnica: { luce01: 458, luce2: 545 },
                    antaUnicaTekno: { luce5: 594, luce6: 660 },
                    doppiaAntaEvolution: { luce3: 700, luce4: 889 },
                    doppiaAntaTekno: { luce7: 1101, luce8: 1317 }
                },
                // gruppo 3: Teak
                3: {
                    antaUnica: { luce01: 520, luce2: 620 },
                    antaUnicaTekno: { luce5: 675, luce6: 750 },
                    doppiaAntaEvolution: { luce3: 782, luce4: 1005 },
                    doppiaAntaTekno: { luce7: 1243, luce8: 1488 }
                },
                // gruppo 4: Altre Essenze a Conferma
                4: {
                    antaUnica: { luce01: 486, luce2: 579 },
                    antaUnicaTekno: { luce5: 631, luce6: 702 },
                    doppiaAntaEvolution: { luce3: 751, luce4: 973 },
                    doppiaAntaTekno: { luce7: 1324, luce8: 1599 }
                },
                // gruppo 5: MDF da Laccare (solo Luce 0-1)
                5: {
                    antaUnica: { luce01: 171 }
                },
                // gruppo 6: MDF Laccato RAL (solo Luce 0-1)
                6: {
                    antaUnica: { luce01: 475 }
                }
            },
            // Prezzi DI SERIE (base, gi√† inclusi nel prezzo porta)
            diSerie: {
                essenze: ['Tanganica 1-2', 'Mogano 2-3', 'Laccato Bianco Oikos', 'Rovere 1', 'Noce Nazionale 2', 'MDF da Laccare', 'Supporto Cliente'],
                prezzi: {
                    luce0: 192, luce1: 192, luce2: 235, luce3: 346, luce4: 414
                }
            }
        };
        
        // ============================================
        // üîê DATABASE CORNICI E IMBOTTI OIKOS (v5.13)
        // ============================================
        const OIKOS_CORNICI_IMBOTTI = {
            // CORNICI LINEARI IN ASTE (h = 2600mm)
            corniciAste: {
                tipi: [
                    { cod: 'CF1', nome: 'CF1 70x10 impiallacciato', dim: '70x10mm' },
                    { cod: 'CF2', nome: 'CF2 90x10 impiallacciato', dim: '90x10mm' },
                    { cod: 'CT1', nome: 'CT1 copritelaio', dim: 'copritelaio' },
                    { cod: 'CC2', nome: 'CC2 copritubolari 120x10', dim: '120x10mm' },
                    { cod: 'CC3', nome: 'CC3 copritubolari 180x10', dim: '180x10mm' }
                ],
                prezzi: {
                    // Prezzo per asta h=2600mm
                    'CF1': { tangMog: 39, rovNoce: 47, okoume: 102, laccRAL: 142 },
                    'CF2': { tangMog: 48, rovNoce: 52, okoume: 110, laccRAL: 162 },
                    'CT1': { tangMog: 102, rovNoce: null, okoume: 114, laccRAL: 155 },
                    'CC2': { tangMog: 140, rovNoce: 162, okoume: 167, laccRAL: 191 },
                    'CC3': { tangMog: 196, rovNoce: 220, okoume: 227, laccRAL: 252 }
                },
                maggiorazioneH3000: 0.30 // +30% per aste h=3000mm
            },
            // KIT CORNICI IN ALLUMINIO (n.2 h=2600mm + n.1 h=1300mm)
            corniciAlluminio: {
                tipi: [
                    { cod: 'KIT_ALU_70', nome: 'Kit Cornici Alluminio 70x10', dim: '70x10mm' },
                    { cod: 'KIT_ALU_90', nome: 'Kit Cornici Alluminio 90x10', dim: '90x10mm' }
                ],
                prezzi: {
                    'KIT_ALU_70': { polveri: 501, evergreen: 557, future: 694, liquido: 766, spazzolato: 501 },
                    'KIT_ALU_90': { polveri: 552, evergreen: 609, future: 745, liquido: 814, spazzolato: 552 }
                }
            },
            // IMBOTTI CON CORNICI (in listellare impiallacciato + cornici 70x10mm)
            imbotti: {
                altezze: [
                    { cod: 'H1', nome: 'Altezza 1 (230+230+115 cm)', desc: 'porte standard' },
                    { cod: 'H2', nome: 'Altezza 2 (300+300+150 cm)', desc: 'porte alte' }
                ],
                larghezze: [
                    { cod: 'L20', nome: '20 cm', valore: 20 },
                    { cod: 'L30', nome: '30 cm', valore: 30 }
                ],
                prezzi: {
                    // Mogano 2-3 / Tanganica 1-2
                    'tangMog': { H1_L20: 600, H1_L30: 780, H2_L20: 706, H2_L30: 914 },
                    // Rovere Naturale-1-2-3-Miele / Noce Nazionale 2
                    'rovNoce': { H1_L20: 759, H1_L30: 925, H2_L20: 895, H2_L30: 1085 },
                    // Laccato Bianco / Laccato RAL
                    'laccato': { H1_L20: 600, H1_L30: 780, H2_L20: 706, H2_L30: 914 },
                    // Okoum√® 6-7-8-Mogano
                    'okoume': { H1_L20: 665, H1_L30: 870, H2_L20: 803, H2_L30: 1040 },
                    // Okoum√® Laccato RAL
                    'okoumeRAL': { H1_L20: 696, H1_L30: 917, H2_L20: 839, H2_L30: 1094 }
                },
                prezzoExtraCm: { H1: 18, H2: 20 } // ‚Ç¨/cm in pi√π di larghezza
            },
            // CORNICI FERMA PANNELLO INTERNO (su richiesta)
            corniciFermaPannello: {
                nota: 'Prezzo su richiesta - da aggiungere se richieste'
            }
        };

        // Helper per ottenere modelli per linea
        function getModelliRivestimento(linea) {
            return OIKOS_RIVESTIMENTI[linea]?.modelli || [];
        }
        
        // Helper per ottenere essenze per linea/modello
        function getEssenzeRivestimento(linea, modello) {
            const dati = OIKOS_RIVESTIMENTI[linea];
            if (!dati) return [];
            if (dati.essenze[modello]) return dati.essenze[modello];
            if (dati.essenze['standard']) return dati.essenze['standard'];
            return Object.values(dati.essenze)[0] || [];
        }
        
        // Helper per ottenere tinte per linea/essenza
        function getTinteRivestimento(linea, essenza) {
            const dati = OIKOS_RIVESTIMENTI[linea];
            if (!dati || !dati.tinte) return [];
            // Cerca la categoria dell'essenza
            for (const [cat, tinte] of Object.entries(dati.tinte)) {
                if (essenza.toLowerCase().includes(cat.toLowerCase())) {
                    return tinte;
                }
            }
            return [];
        }
        
        // üîê v5.15: Calcola prezzo rivestimento per linea/modello/luce/essenza
        function calcolaPrezzoRivestimento(linea, modello, luce, essenza = null) {
            if (!linea || !modello) return 0;
            const dati = OIKOS_RIVESTIMENTI[linea];
            if (!dati || !dati.prezziBase) return 0;
            
            // üîê v5.15: Gestione speciale per "Non di serie" con prezzi diversi per essenza
            if (modello === 'Non di serie' && essenza) {
                let keyPrezzo = 'Non di serie'; // Default
                if (essenza.includes('Noce Canaletto')) {
                    keyPrezzo = 'Non di serie Noce Canaletto';
                } else if (essenza.includes('Teak')) {
                    keyPrezzo = 'Non di serie Teak';
                } else if (essenza.includes('Altre Essenze')) {
                    keyPrezzo = 'Non di serie Altre Essenze';
                }
                const prezziModello = dati.prezziBase[keyPrezzo];
                if (prezziModello) {
                    return prezziModello[luce] || prezziModello['luce0'] || 0;
                }
            }
            
            const prezziModello = dati.prezziBase[modello];
            if (!prezziModello) return 0;
            return prezziModello[luce] || prezziModello['luce0'] || 0;
        }
        
        // ============================================
        // üîê DATABASE OPTIONAL OIKOS (v5.03)
        // ============================================
        const OIKOS_OPTIONAL = {
            // VETRO BLINDATO (BR2 + P6B)
            vetroBlindato: {
                'V1': { trasparente: 2311, sabbiato: 2485 },
                'V2': { trasparente: 1757, sabbiato: 1871 },
                'V3': { trasparente: 1537, sabbiato: 1631 },
                'V4': { trasparente: 1537, sabbiato: 1631 },
                'V5': { trasparente: 1456, sabbiato: 1516 },
                'V50': { trasparente: 1537, sabbiato: 1631 }
            },
            // VETRO TERMICO SICUREZZA
            vetroTermico: {
                'V1': { trasparente: 2683, sabbiato: 2857 },
                'V2': { trasparente: 2030, sabbiato: 2144 },
                'V3': { trasparente: 1816, sabbiato: 1910 },
                'V4': { trasparente: 1816, sabbiato: 1910 },
                'V5': { trasparente: 1684, sabbiato: 1774 },
                'V50': { trasparente: 1816, sabbiato: 1910 }
            },
            // SOPRALUCE
            sopraluce: {
                'H500': { 'luce0': 931, 'luce1': 931, 'luce2': 977, 'luce3': 1208, 'luce4': 1413 },
                'H800': { 'luce0': 1330, 'luce1': 1330, 'luce2': 1454, 'luce3': 1754, 'luce4': 2053 },
                'controtelaio': { 'luce0': 350, 'luce1': 350, 'luce2': 374, 'luce3': 391, 'luce4': 404 },
                'sabbiato_H500': { 'luce0': 78, 'luce1': 78, 'luce2': 82, 'luce3': 105, 'luce4': 125 },
                'sabbiato_H800': { 'luce0': 120, 'luce1': 120, 'luce2': 132, 'luce3': 168, 'luce4': 200 }
            },
            // FIANCOLUCE
            fiancoluce: {
                senzaVetro: { 'luce1': 1166, 'luce2': 1308, 'luce3': 1388, 'luce4': 1540 },
                conVetro: { 'luce1': 2209, 'luce2': 2935, 'luce3': 3526, 'luce4': 4374 },
                sabbiato: { 'luce1': 170, 'luce2': 255, 'luce3': 312, 'luce4': 432 },
                colori: {
                    'RAL8022': { 'luce1': 0, 'luce2': 0, 'luce3': 0, 'luce4': 0 },
                    'OIKOS_Polveri': { 'luce1': 256, 'luce2': 290, 'luce3': 298, 'luce4': 336 },
                    'OIKOS_Evergreen': { 'luce1': 336, 'luce2': 382, 'luce3': 392, 'luce4': 441 },
                    'OIKOS_Future': { 'luce1': 404, 'luce2': 460, 'luce3': 472, 'luce4': 532 },
                    'OIKOS_Liquido': { 'luce1': 512, 'luce2': 580, 'luce3': 596, 'luce4': 672 }
                }
            }
        };


        function renderMisureTab(project, pos) {
            const validation = validateMisure(project, pos);
            // üÜï FASE 014 - Indicatore completamento real-time
            // üîß FASE 014 - Passa project alle funzioni
            const comp = calculatePositionCompleteness(pos, project);
            const status = getPositionCompletenessStatus(pos, project);
            
            return `
                <div class="space-y-4">
                    <!-- üÜï FASE 014: Badge Completamento Real-time -->
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 ${
                        comp.percentage === 100 ? 'border-green-500' : 
                        comp.percentage >= 70 ? 'border-amber-500' : 
                        'border-orange-500'
                    } rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-sm font-bold text-gray-700 mb-1">üìä Completamento Posizione</h3>
                                <p class="text-xs text-gray-600">Controlla i dati mentre inserisci le misure</p>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-3xl">${status.icon}</span>
                                    <span class="text-lg font-bold ${
                                        comp.percentage === 100 ? 'text-green-700' : 
                                        comp.percentage >= 70 ? 'text-amber-700' : 
                                        'text-orange-700'
                                    }">${comp.percentage}%</span>
                                </div>
                                <div class="w-40 h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="${status.badge} h-full transition-all duration-500" 
                                         style="width: ${comp.percentage}%"></div>
                                </div>
                            </div>
                        </div>
                        ${comp.missing.length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-gray-300">
                                <p class="text-xs font-semibold text-gray-700 mb-1">‚ö†Ô∏è Da completare:</p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    ${comp.missing.map(m => `<li>‚Ä¢ ${m}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- üÜï FASE 014: Selezione Prodotti Presenti/Assenti -->
                    ${(() => {
                        const mapProdotti = {
                            'infissi': { singolare: 'infisso', label: 'ü™ü Infisso', icon: 'ü™ü' },
                            'persiane': { singolare: 'persiana', label: 'üö™ Persiana', icon: 'üö™' },
                            'tapparelle': { singolare: 'tapparella', label: 'üéöÔ∏è Tapparella', icon: 'üéöÔ∏è' },
                            'zanzariere': { singolare: 'zanzariera', label: 'ü¶ü Zanzariera', icon: 'ü¶ü' },
                            'cassonetti': { singolare: 'cassonetto', label: 'üì¶ Cassonetto', icon: 'üì¶' },
                            'blindate': { singolare: 'blindata', label: 'üîê Blindata', icon: 'üîê' },
                            'portoncini': { singolare: 'portoncino', label: 'üö™ Portoncino', icon: 'üö™' }
                        };
                        
                        const prodottiProgetto = [];
                        if (project?.prodotti) {
                            Object.keys(project.prodotti).forEach(tipo => {
                                if (project.prodotti[tipo] === true) {
                                    prodottiProgetto.push({
                                        tipo: tipo,
                                        ...mapProdotti[tipo]
                                    });
                                }
                            });
                        }
                        
                        if (prodottiProgetto.length === 0) return '';
                        
                        const prodottiAssenti = pos.prodottiAssenti || [];
                        
                        return `
                            <div class="bg-white border-2 border-gray-300 rounded-lg p-4">
                                <h3 class="text-sm font-bold text-gray-700 mb-3">üéØ Prodotti in questa posizione</h3>
                                <p class="text-xs text-gray-600 mb-3">Seleziona i prodotti PRESENTI. Deseleziona quelli NON presenti (es. niente tapparella, niente zanzariera)</p>
                                
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                                    ${prodottiProgetto.map(prod => {
                                        const hasProdotto = pos[prod.singolare] && typeof pos[prod.singolare] === 'object';
                                        const isDichiaratoAssente = prodottiAssenti.includes(prod.singolare);
                                        const isPresente = hasProdotto;
                                        const status = isPresente ? 'presente' : isDichiaratoAssente ? 'assente' : 'mancante';
                                        
                                        return `
                                            <label class="relative flex flex-col items-center p-3 border-2 rounded-lg cursor-pointer transition ${
                                                status === 'presente' ? 'border-green-500 bg-green-50' :
                                                status === 'assente' ? 'border-gray-400 bg-gray-50 opacity-60' :
                                                'border-red-400 bg-red-50'
                                            }">
                                                <input type="checkbox" 
                                                       ${isPresente || !isDichiaratoAssente ? 'checked' : ''}
                                                       onchange="toggleProdottoAssente('${project.id}', '${pos.id}', '${prod.tipo}')"
                                                       class="sr-only">
                                                <span class="text-2xl mb-1">${prod.icon}</span>
                                                <span class="text-xs font-semibold text-center ${
                                                    status === 'presente' ? 'text-green-700' :
                                                    status === 'assente' ? 'text-gray-600' :
                                                    'text-red-700'
                                                }">${prod.label.replace('ü™ü ', '').replace('üö™ ', '').replace('üéöÔ∏è ', '').replace('ü¶ü ', '').replace('üì¶ ', '')}</span>
                                                ${status === 'presente' ? '<span class="text-xs text-green-600 mt-1">‚úì Presente</span>' : ''}
                                                ${status === 'assente' ? '<span class="text-xs text-gray-600 mt-1">Non presente</span>' : ''}
                                                ${status === 'mancante' ? '<span class="text-xs text-red-600 mt-1">‚ö†Ô∏è Mancante</span>' : ''}
                                            </label>
                                        `;
                                    }).join('')}
                                </div>
                                
                                <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800">
                                    <strong>üí° Come funziona:</strong> Spunta = Prodotto presente (devi compilare misure). Non spuntato = Prodotto assente in questa posizione (OK, nessuna misura necessaria).
                                </div>
                            </div>
                        `;
                    })()}
                    
                    ${validation.errors.length > 0 || validation.warnings.length > 0 ? `
                        <div class="validation-summary">
                            ${validation.errors.length > 0 ? `
                                <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-3">
                                    <h3 class="font-bold text-red-800 mb-2 flex items-center gap-2">
                                        üî¥ ERRORI DI VALIDAZIONE (${validation.errors.length})
                                    </h3>
                                    <ul class="space-y-1">
                                        ${validation.errors.map(e => `
                                            <li class="text-sm text-red-700">‚Ä¢ ${e.message}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${validation.warnings.length > 0 ? `
                                <div class="bg-amber-50 border-2 border-amber-500 rounded-lg p-4 mb-3">
                                    <h3 class="font-bold text-amber-800 mb-2 flex items-center gap-2">
                                        üü° ATTENZIONE (${validation.warnings.length})
                                    </h3>
                                    <ul class="space-y-1">
                                        ${validation.warnings.map(w => `
                                            <li class="text-sm text-amber-700">‚Ä¢ ${w.message}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="bg-green-50 border-2 border-green-500 rounded-lg p-3 mb-3">
                            <p class="font-bold text-green-800 flex items-center gap-2">
                                ‚úÖ Tutte le misure sono corrette!
                            </p>
                        </div>
                    `}
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm font-bold text-gray-700 mb-3">Misure Principali (mm)</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="misure-grid-${pos.id}">
                            ${['LVT', 'HVT', 'LF', 'HF', 'TMV', 'HMT', 'L4', 'H4'].map((field, index) => `
                                <div>
                                    <label class="text-xs font-semibold">${field}</label>
                                    <input type="number" placeholder="-"
                                           value="${pos.misure?.[field] || ''}"
                                           onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', '${field}', this.value)"
                                           tabindex="${100 + index}"
                                           data-field-index="${index}"
                                           class="w-full compact-input border rounded mt-1 font-semibold ${getFieldValidationClass(project, pos, field)}">
                                    ${getFieldValidationMessage(project, pos, field)}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- ‚úÖ NUOVO: Dislivello Piana Int ed Est -->
                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg p-4 border-2 border-amber-300">
                        <p class="text-sm font-bold text-amber-800 mb-3">üìê Dislivello Piana Int ed Est</p>
                        ${(() => {
                            // Cerca dislivello in finestra o portaFinestra
                            const dislivello = pos.finestra?.dislivelloPiana || pos.portaFinestra?.dislivelloPiana || {};
                            const presente = dislivello.presente || false;
                            const pianaAlta = dislivello.pianaAlta || '';
                            const valore = dislivello.valore || '';
                            const note = dislivello.note || '';
                            
                            return `
                                <div class="space-y-3">
                                    <div>
                                        <div class="flex gap-4">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="dislivelloPresente-${pos.id}" value="no"
                                                       ${!presente ? 'checked' : ''}
                                                       onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'presente', false)"
                                                       class="mr-2">
                                                <span class="text-sm">Nessun dislivello (piane allineate)</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="dislivelloPresente-${pos.id}" value="si"
                                                       ${presente ? 'checked' : ''}
                                                       onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'presente', true)"
                                                       class="mr-2">
                                                <span class="text-sm">Dislivello presente</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="dislivelloFields-${pos.id}" style="display: ${presente ? 'block' : 'none'}">
                                        <div class="space-y-3 bg-white bg-opacity-60 p-3 rounded">
                                            <div>
                                                <label class="block text-xs font-semibold mb-2 text-amber-900">Piana pi√π alta:</label>
                                                <div class="flex gap-4">
                                                    <label class="inline-flex items-center">
                                                        <input type="radio" name="pianaAlta-${pos.id}" value="interna"
                                                               ${pianaAlta === 'interna' ? 'checked' : ''}
                                                               onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'pianaAlta', 'interna')"
                                                               class="mr-2">
                                                        <span class="text-sm font-medium">üè† Interna</span>
                                                    </label>
                                                    <label class="inline-flex items-center">
                                                        <input type="radio" name="pianaAlta-${pos.id}" value="esterna"
                                                               ${pianaAlta === 'esterna' ? 'checked' : ''}
                                                               onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'pianaAlta', 'esterna')"
                                                               class="mr-2">
                                                        <span class="text-sm font-medium">üåç Esterna</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-semibold mb-1 text-amber-900">Dislivello (mm):</label>
                                                <input type="number" placeholder="0" min="0" value="${valore}"
                                                       onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'valore', this.value)"
                                                       class="w-32 px-3 py-2 border rounded-lg font-semibold">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-semibold mb-1 text-amber-900">Note (opzionale):</label>
                                                <input type="text" placeholder="es. Gradino interno..." value="${note}"
                                                       onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'note', this.value)"
                                                       class="w-full px-3 py-2 border rounded-lg text-sm">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        })()}
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm font-bold text-gray-700 mb-3">Altezze (mm)</p>
                        ${(() => {
                            // Validazione iniziale per il colore di caricamento
                            const hsoff = parseFloat(pos.misure?.HSoffitto) || 0;
                            const hparapSoff = parseFloat(pos.misure?.HParapettoSoffitto) || 0;
                            const hpavParap = parseFloat(pos.misure?.HPavimentoParapetto) || 0;
                            
                            let borderColor = 'border-gray-300';
                            let validationMsg = '';
                            
                            if (hsoff > 0 && hparapSoff > 0 && hpavParap > 0) {
                                const somma = hpavParap + hparapSoff;
                                const diff = Math.abs(somma - hsoff);
                                
                                if (diff <= 10) {
                                    borderColor = 'border-green-500';
                                    validationMsg = `
                                        <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-2">
                                            <p class="text-xs text-green-800">
                                                ‚úÖ <strong>OK:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm ‚úì
                                            </p>
                                        </div>
                                    `;
                                } else {
                                    borderColor = 'border-red-500';
                                    validationMsg = `
                                        <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-2">
                                            <p class="text-xs text-red-800">
                                                ‚ö†Ô∏è <strong>ERRORE:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm (>10mm!)
                                            </p>
                                        </div>
                                    `;
                                }
                            }
                            
                            return `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs font-semibold mb-1">H Soffitto</label>
                                        <input type="number" 
                                               id="hsoff-${pos.id}"
                                               placeholder="0" 
                                               value="${pos.misure?.HSoffitto || ''}"
                                               oninput="validateAltezzeRealTime('${project.id}', '${pos.id}')"
                                               onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'HSoffitto', this.value)"
                                               tabindex="108"
                                               class="w-full px-3 py-2 border-2 ${borderColor} rounded font-semibold">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold mb-1">H Parapetto/Soffitto</label>
                                        <input type="number" 
                                               id="hparapsoff-${pos.id}"
                                               placeholder="0" 
                                               value="${pos.misure?.HParapettoSoffitto || ''}"
                                               oninput="validateAltezzeRealTime('${project.id}', '${pos.id}')"
                                               onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'HParapettoSoffitto', this.value)"
                                               tabindex="109"
                                               class="w-full px-3 py-2 border-2 ${borderColor} rounded font-semibold">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold mb-1">H Pavimento/Parapetto</label>
                                        <input type="number" 
                                               id="hpavparap-${pos.id}"
                                               placeholder="0" 
                                               value="${pos.misure?.HPavimentoParapetto || ''}"
                                               oninput="validateAltezzeRealTime('${project.id}', '${pos.id}')"
                                               onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'HPavimentoParapetto', this.value)"
                                               tabindex="110"
                                               class="w-full px-3 py-2 border-2 ${borderColor} rounded font-semibold">
                                    </div>
                                </div>
                                <div id="validation-msg-${pos.id}">${validationMsg}</div>
                            `;
                        })()}
                    </div>
                    
                    <!-- üìã SEZIONI RILIEVO PREESISTENTE PER OGNI PRODOTTO -->
                    ${project.prodotti?.infissi ? renderRilievoPerProdotto(project, pos, 'infissi', 'ü™ü Infissi', true) : ''}
                    ${project.prodotti?.persiane ? renderRilievoPerProdotto(project, pos, 'persiane', 'üö™ Persiane', false) : ''}
                    ${project.prodotti?.tapparelle ? renderRilievoPerProdotto(project, pos, 'tapparelle', 'üéöÔ∏è Tapparelle', false) : ''}
                    ${project.prodotti?.cassonetti ? renderRilievoPerProdotto(project, pos, 'cassonetti', 'üì¶ Cassonetti', false) : ''}
                    
                    <!-- üóø CARATTERISTICHE MURO PERSONALIZZATE -->
                    ${pos.overrideCaratteristiche ? renderCaratteristicheMuroOverride(project, pos) : `
                        <button onclick="enableOverride('${project.id}', '${pos.id}')"
                                class="w-full text-sm bg-yellow-600 text-white px-4 py-3 rounded-lg hover:bg-yellow-700 font-semibold transition flex items-center justify-center gap-2">
                            ‚úèÔ∏è Personalizza caratteristiche muro per questa posizione
                        </button>
                    `}
                </div>
            `;
        }

        function renderInfissiTab(project, pos) {
            const inf = pos.infisso;
            
            return `
                <div class="space-y-4">
                    ${!inf ? `
                        <!-- üéØ STATO INIZIALE: Prodotto non ancora creato -->
                        <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <p class="text-gray-700 mb-4 font-medium text-lg">Nessun infisso configurato</p>
                            <div class="flex flex-col items-center gap-3">
                                ${!pos.prodottiAssenti?.includes('infisso') ? `
                                    <button onclick="addInfisso('${project.id}', '${pos.id}')"
                                            class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 shadow-sm hover:shadow-md transition-all">
                                        + Aggiungi Infisso
                                    </button>
                                ` : ''}
                                <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                                    <input type="checkbox" 
                                           ${pos.prodottiAssenti?.includes('infisso') ? 'checked' : ''}
                                           onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'infissi')"
                                           class="w-4 h-4">
                                    <span class="text-gray-700 font-medium">‚ö†Ô∏è Non presente in questa posizione</span>
                                </label>
                            </div>
                        </div>
                    ` : (parseInt(inf.qta) === 0 || inf.qta === '0' || inf.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-blue-700 text-lg">ü™ü Infisso</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'infisso')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(inf.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-blue-700 text-lg">ü™ü Infisso</h4>
                                <div class="flex gap-2">
                                    <button onclick="ricaricaInfissoDaGlobali('${project.id}', '${pos.id}')"
                                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700"
                                            title="Ricarica configurazione da Config Globali">
                                        üîÑ Ricarica
                                    </button>
                                    <button onclick="deleteProduct('${project.id}', '${pos.id}', 'infisso')"
                                            class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                        üóëÔ∏è Elimina
                                    </button>
                                </div>
                            </div>
                            
                            <!-- üìã DATI SPECIFICI -->
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                                    üìã Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(inf.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo <span class="text-red-600">*</span></label>
                                        ${(() => {
                                            const options = ['F1', 'PF1', 'F2', 'PF2', 'F3', 'PF3', 'HST', 'FISSO'];
                                            const current = inf.tipo || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `inf-tipo-${pos.id}`;
                                            const inputId = `inf-tipo-input-${pos.id}`;
                                            // üÜï v4.24: Campo obbligatorio - bordo arancione se vuoto
                                            const isEmpty = !current || current === '';
                                            const borderClass = isEmpty ? 'border-2 border-orange-400 bg-orange-50' : 'border';
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'infisso', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input ${borderClass} rounded mt-1">
                                                    <option value="">-- Seleziona --</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è ALTRO - SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipo', this.value)"
                                                       placeholder="Inserisci tipo personalizzato..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Apertura</label>
                                        ${(() => {
                                            const options = ['SX', 'DX', 'Fisso', 'Ribalta', 'Sp. SX', 'Sp. DX', 'SCORR.PARALL'];
                                            const current = inf.apertura || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `inf-apertura-${pos.id}`;
                                            const inputId = `inf-apertura-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'infisso', 'apertura', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è ALTRO - SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'apertura', this.value)"
                                                       placeholder="Inserisci apertura personalizzata..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                </div>
                            </div>

                            <!-- üîß TIPO INFISSO ASSOCIATO -->
                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                    üîß Tipo Infisso Associato
                                </h5>
                                <p class="text-sm text-gray-600 mb-3">Seleziona tipo:</p>
                                <div class="flex gap-6">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfissoAssociato-${project.id}-${pos.id}"
                                               value="F"
                                               ${(() => {
                                                   // Auto-selezione: se tipo contiene PF ‚Üí PF, altrimenti F
                                                   if (inf.tipoInfissoAssociato) {
                                                       return inf.tipoInfissoAssociato === 'F' ? 'checked' : '';
                                                   } else {
                                                       // Default: se tipo non contiene PF ‚Üí seleziona F
                                                       return (inf.tipo && !inf.tipo.includes('PF')) ? 'checked' : '';
                                                   }
                                               })()}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipoInfissoAssociato', 'F')"
                                               class="w-4 h-4">
                                        <span class="font-medium">F (Finestra)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfissoAssociato-${project.id}-${pos.id}"
                                               value="PF"
                                               ${(() => {
                                                   // Auto-selezione: se tipo contiene PF ‚Üí PF
                                                   if (inf.tipoInfissoAssociato) {
                                                       return inf.tipoInfissoAssociato === 'PF' ? 'checked' : '';
                                                   } else {
                                                       // Default: se tipo contiene PF ‚Üí seleziona PF
                                                       return (inf.tipo && inf.tipo.includes('PF')) ? 'checked' : '';
                                                   }
                                               })()}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipoInfissoAssociato', 'PF')"
                                               class="w-4 h-4">
                                        <span class="font-medium">PF (Porta Finestra)</span>
                                    </label>
                                </div>
                                ${!inf.tipoInfissoAssociato && !inf.tipo ? `
                                    <div class="mt-3 bg-amber-100 border-l-4 border-amber-500 p-3">
                                        <p class="text-sm text-amber-800">‚ö†Ô∏è Seleziona prima se F o PF</p>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- ‚öôÔ∏è CONFIGURAZIONE -->
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                                    ‚öôÔ∏è Configurazione
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <!-- AZIENDA -->
                                    ${renderSelectWithCustom(
                                        'azienda',
                                        inf.azienda || '',
                                        ['finstral', 'Essepi'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Azienda'
                                    )}

                                    <!-- TIPO ANTA -->
                                    ${renderSelectWithCustom(
                                        'tipoAnta',
                                        inf.tipoAnta || '',
                                        ['Classic-line', 'Slim-line', 'Slim-line Cristal', 'Slim-line Twin', 'Slim-line Cristal Twin', 'Step-line', 'Step-line Door', 'Nova-line', 'Nova-line Plus', 'Nova-line Twin', 'Nova-line Cristal Twin'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Tipo Anta'
                                    )}

                                    <!-- FINITURA INTERNA -->
                                    ${renderSelectWithCustom(
                                        'finituraInt',
                                        inf.finituraInt || '',
                                        ['pvc', 'legno', 'alluminio', 'ceramica'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Finitura Int'
                                    )}

                                    <!-- FINITURA ESTERNA -->
                                    ${renderSelectWithCustom(
                                        'finituraEst',
                                        inf.finituraEst || '',
                                        ['pvc', 'alluminio', 'ceramica'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Finitura Est'
                                    )}

                                    <!-- COLORE INTERNO -->
                                    ${renderSelectColoreStandard(
                                        'coloreInt',
                                        inf.coloreInt || '',
                                        inf.finituraInt || 'pvc',
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Colore Interno'
                                    )}

                                    <!-- COLORE ESTERNO -->
                                    ${renderSelectColoreStandard(
                                        'coloreEst',
                                        inf.coloreEst || '',
                                        inf.finituraEst || 'pvc',
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Colore Esterno'
                                    )}

                                    <!-- TELAIO -->
                                    ${renderSelectWithCustom(
                                        'telaio',
                                        inf.telaio || '',
                                        ['961', '965', '967', 'Z62', 'Z91', '962', '924', '951'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Telaio'
                                    )}

                                    <!-- ALLARME -->
                                    ${renderSelectWithCustom(
                                        'allarme',
                                        inf.allarme || '',
                                        ['si', 'no'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Allarme'
                                    )}

                                    <!-- VETRO -->
                                    ${renderSelectWithCustom(
                                        'vetro',
                                        inf.vetro || '',
                                        ['doppio', 'doppio-sat', 'triplo', 'triplo-sat'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Vetro'
                                    )}

                                    <!-- CERNIERE - v4.80 -->
                                    ${renderSelectWithCustom(
                                        'cerniere',
                                        inf.cerniere || '',
                                        ['a-vista', 'a-scomparsa'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Cerniere'
                                    )}

                                    <!-- MANIGLIA - SEMPLIFICATO v4.39 -->
                                    ${renderSelectWithCustom(
                                        'maniglia',
                                        inf.maniglia || '',
                                        ['601 - STANDARD', '712 - A PRESSIONE', '773 - DOPPIA ANTA/RIBALTA', '772 - DOPPIA ANTA'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Maniglia'
                                    )}

                                    <!-- COLORE MANIGLIA - AGGIORNATO v4.39 -->
                                    ${renderSelectWithCustom(
                                        'coloreManiglia',
                                        inf.coloreManiglia || '',
                                        ['01 - BIANCO', '07 - PERLA', '56 - NEUTRO ANODIZZATO', '74 - BRONZO', '40 - OTTONE LUCIDO', '79 - TITANIO', 'M01 - BIANCO', 'M03 - NERO', 'M07 - BIANCO CREMA'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Colore Maniglia'
                                    )}

                                    <!-- TAGLI TELAIO -->
                                    ${renderSelectWithCustom(
                                        'tagliTelaio',
                                        inf.tagliTelaio || '',
                                        ['nessuno', 'sopra', 'sotto', 'sopra-sotto', 'dx', 'sx', 'dx-sx', '4-lati', 'sopra-laterali', 'sotto-laterali'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Tagli Telaio'
                                    )}
                                </div>
                                
                                <!-- COD.TAGLI MULTIPLI (editabili, sincronizzati con config globale) -->
                                <div class="mt-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="text-xs font-medium">COD.TAGLI</label>
                                        <button onclick="state.screen = 'project-detail'; state.setupStep = 3; render();"
                                                class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded font-medium transition">
                                            ‚öôÔ∏è Config Globale
                                        </button>
                                    </div>
                                    <div class="grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));">
                                        ${(() => {
                                            // üÜï v4.81: Genera posizioni da tagliTelaio (fallback a codTagli per retrocompatibilit√†)
                                            const tagliTelaio = inf.tagliTelaio || '';
                                            const codTagli = getPosizioniTagli(tagliTelaio);
                                            const codTagliValues = inf.codTagliValues || [];
                                            
                                            if (codTagli.length === 0 || tagliTelaio === 'nessuno') {
                                                return '<input type="text" readonly placeholder="Seleziona Tagli Telaio" class="w-full px-2 py-1 border rounded bg-gray-50 text-gray-700 text-xs">';
                                            }
                                            
                                            // üÜï v4.79: Ottieni codici disponibili per il telaio della posizione
                                            const telaioPos = inf.telaio || '';
                                            const codiciDisponibili = getCodiciTaglioPerTelaio(telaioPos);
                                            const hasCodici = codiciDisponibili.length > 0;
                                            
                                            return codTagli.map((taglio, idx) => {
                                                const valore = codTagliValues[idx] || '';
                                                const isEmpty = !valore || valore.trim() === '';
                                                return `
                                                <div class="flex flex-col">
                                                    <label class="text-xs font-bold text-gray-600 mb-1">${taglio}</label>
                                                    ${hasCodici ? `
                                                        <select onchange="updateCodTagliPosizione('${project.id}', '${pos.id}', ${idx}, this.value)"
                                                                class="w-full px-1 py-1 border-2 rounded text-gray-700 text-xs text-center font-bold focus:ring-2 focus:ring-blue-500 ${
                                                                    isEmpty ? 'border-orange-300 bg-orange-50' : 'border-blue-300 bg-blue-50'
                                                                }">
                                                            <option value="">--</option>
                                                            ${codiciDisponibili.map(c => `<option value="${c}" ${valore === c ? 'selected' : ''}>${c}</option>`).join('')}
                                                        </select>
                                                    ` : `
                                                        <input type="text" 
                                                               value="${valore}"
                                                               onchange="updateCodTagliPosizione('${project.id}', '${pos.id}', ${idx}, this.value)"
                                                               placeholder="Codice"
                                                               class="w-full px-2 py-1 border-2 border-blue-300 rounded text-gray-700 text-xs text-center font-bold focus:ring-2 focus:ring-blue-500">
                                                    `}
                                                </div>
                                            `}).join('');
                                        })()}
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">üí° Valori copiati da Config Globale (modificabili qui)</p>
                                </div>
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    ${!inf.brmPersonalizzato ? `
                                        <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'infisso')"
                                                class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                            üé® Personalizza BRM
                                        </button>
                                    ` : `
                                        <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'infisso')"
                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                            ‚Ü©Ô∏è Usa Globale
                                        </button>
                                    `}
                                </div>
                                
                                ${!inf.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2">
                                            <strong>Formula Globale Attiva:</strong>
                                        </p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div>
                                                <span class="font-semibold">BRM L =</span>
                                                ${project.brmConfigInfissi?.misuraBaseL || '?'} 
                                                ${project.brmConfigInfissi?.operazioneL || '-'} 
                                                ${project.brmConfigInfissi?.valoreL || '0'}mm
                                            </div>
                                            <div>
                                                <span class="font-semibold">BRM H =</span>
                                                ${project.brmConfigInfissi?.misuraBaseH || '?'} 
                                                ${project.brmConfigInfissi?.operazioneH || '-'} 
                                                ${project.brmConfigInfissi?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${inf.BRM_L || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${inf.BRM_H || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${inf.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${inf.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${inf.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-infisso-${pos.id}" value="${inf.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-infisso-${pos.id}">
                                                = ${inf.brmPersonalizzato?.misuraBaseL || '?'} ${inf.brmPersonalizzato?.operazioneL || '+'} ${inf.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HPF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${inf.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${inf.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${inf.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-infisso-${pos.id}" value="${inf.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-infisso-${pos.id}">
                                                = ${inf.brmPersonalizzato?.misuraBaseH || '?'} ${inf.brmPersonalizzato?.operazioneH || '+'} ${inf.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${inf.BRM_L || ''}" readonly id="brm-l-result-infisso-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${inf.BRM_H || ''}" readonly id="brm-h-result-infisso-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${inf.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${inf.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderPersianeTab(project, pos) {
            const per = pos.persiana;
            
            return `
                <div class="space-y-4">
                    ${!per ? `
                        <!-- üéØ STATO INIZIALE: Prodotto non ancora creato -->
                        <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <p class="text-gray-700 mb-4 font-medium text-lg">Nessuna persiana configurata</p>
                            <div class="flex flex-col items-center gap-3">
                                ${!pos.prodottiAssenti?.includes('persiana') ? `
                                    <button onclick="addPersiana('${project.id}', '${pos.id}')"
                                            class="px-6 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 shadow-sm hover:shadow-md transition-all">
                                        + Aggiungi Persiana
                                    </button>
                                ` : ''}
                                <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                                    <input type="checkbox" 
                                           ${pos.prodottiAssenti?.includes('persiana') ? 'checked' : ''}
                                           onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'persiane')"
                                           class="w-4 h-4">
                                    <span class="text-gray-700 font-medium">‚ö†Ô∏è Non presente in questa posizione</span>
                                </label>
                            </div>
                        </div>
                    ` : (parseInt(per.qta) === 0 || per.qta === '0' || per.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-purple-700 text-lg">üö™ Persiana</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'persiana')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(per.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-purple-700 text-lg">üö™ Persiana</h4>
                                <div class="flex gap-2">
                                    <button onclick="ricaricaPersianaDaGlobali('${project.id}', '${pos.id}')"
                                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700"
                                            title="Ricarica configurazione da Config Globali">
                                        üîÑ Ricarica
                                    </button>
                                    <button onclick="deleteProduct('${project.id}', '${pos.id}', 'persiana')"
                                            class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                        üóëÔ∏è Elimina
                                    </button>
                                </div>
                            </div>
                            
                            <!-- üìã DATI SPECIFICI -->
                            <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                                    üìã Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(per.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo <span class="text-red-600">*</span></label>
                                        ${(() => {
                                            const options = ['F1', 'PF1', 'F2', 'PF2', 'F3', 'PF3', 'SCORREVOLE'];
                                            const current = per.tipo || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `per-tipo-${pos.id}`;
                                            const inputId = `per-tipo-input-${pos.id}`;
                                            // üÜï v4.24: Campo obbligatorio - bordo arancione se vuoto
                                            const isEmpty = !current || current === '';
                                            const borderClass = isEmpty ? 'border-2 border-orange-400 bg-orange-50' : 'border';
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'persiana', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input ${borderClass} rounded mt-1">
                                                    <option value="">-- Seleziona --</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è ALTRO - SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'tipo', this.value)"
                                                       placeholder="Inserisci tipo personalizzato..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Apertura</label>
                                        ${(() => {
                                            const options = ['SP SX', 'SP DX', 'LIB SX', 'LIB DX', 'SCORR SX', 'SCORR DX'];
                                            const current = per.apertura || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `per-apertura-${pos.id}`;
                                            const inputId = `per-apertura-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'persiana', 'apertura', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'apertura', this.value)"
                                                       placeholder="Inserisci apertura personalizzata..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                </div>
                            </div>

                            <!-- ‚öôÔ∏è CONFIGURAZIONE -->
                            <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                                    ‚öôÔ∏è Configurazione
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <!-- AZIENDA -->
                                    ${renderSelectWithCustom(
                                        'azienda',
                                        per.azienda || '',
                                        ['P. Persiane'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Azienda'
                                    )}

                                    <!-- MODELLO -->
                                    ${renderSelectWithCustom(
                                        'modello',
                                        per.modello || '',
                                        ['Angela', 'Giulia', 'Luna', 'Aurora', 'Alto Adige', 'Alto Adige (R)', 'Cortina', 'Cortina (R)', 'Oscura', 'Oscura (R)', 'Nerina', 'Nerina (R)', 'Scandola', 'Scandola (TT)', 'Scandola Duo', 'Scandola Duo (TT)', 'Oscura Duo', 'Oscura Duo (TT)'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Modello'
                                    )}

                                    <!-- FISSAGGIO -->
                                    ${renderSelectWithCustom(
                                        'fissaggio',
                                        per.fissaggio || '',
                                        ['muro', 'telaio'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Fissaggio'
                                    )}

                                    <!-- TIPO TELAIO - Solo se fissaggio = telaio -->
                                    ${per.fissaggio === 'telaio' ? renderSelectWithCustom(
                                        'tipoTelaio',
                                        per.tipoTelaio || '',
                                        ['TH10', 'TH40', 'TH41', 'TH45', 'TH46R', 'TH62', 'TH80', 'TH53'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Tipo Telaio'
                                    ) : ''}

                                    <!-- COLORE PERSIANA -->
                                    ${renderSelectWithCustom(
                                        'colorePersiana',
                                        per.colorePersiana || '',
                                        COLORI_PERSIANE,
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Colore Persiana'
                                    )}

                                    <!-- COLORE TELAIO - Solo se fissaggio = telaio -->
                                    ${per.fissaggio === 'telaio' ? renderSelectWithCustom(
                                        'coloreTelaio',
                                        per.coloreTelaio || '',
                                        COLORI_PERSIANE,
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Colore Telaio'
                                    ) : ''}

                                    <!-- BATTUTA -->
                                    ${renderSelectWithCustom(
                                        'battuta',
                                        per.battuta || '',
                                        ['3 LATI', '4 LATI', '2 LATI LATERALI'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Battuta'
                                    )}
                                </div>
                            </div>

                            <!-- üî© ACCESSORI PERSIANA (Cardini + Fermapersiane) -->
                            ${renderAccessoriPersiana(project.id, pos.id, per)}

                            <!-- üì∑ FOTO PERSIANA -->
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-semibold text-blue-800 flex items-center gap-2">
                                        üì∑ Foto Persiana
                                    </h5>
                                    <button onclick="document.getElementById('foto-persiana-input-${project.id}-${pos.id}').click()"
                                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700">
                                        üì∑ Carica Foto
                                    </button>
                                    <input type="file" 
                                           id="foto-persiana-input-${project.id}-${pos.id}"
                                           accept="image/*"
                                           style="display: none;"
                                           onchange="addFotoPersiana('${project.id}', '${pos.id}', event)">
                                </div>
                                ${per.foto && per.foto.length > 0 ? `
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        ${per.foto.map((foto, idx) => `
                                            <div class="relative">
                                                <img src="${foto}" class="w-full h-32 object-cover rounded border-2 border-blue-300">
                                                <button onclick="removeFotoPersiana('${project.id}', '${pos.id}', ${idx})"
                                                        class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 text-xs hover:bg-red-700">
                                                    ‚úï
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p class="text-sm text-gray-500 italic text-center py-3">1 foto per persiana<br>Nessuna foto caricata</p>
                                `}
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    ${!per.brmPersonalizzato ? `
                                        <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'persiana')"
                                                class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                            üé® Personalizza BRM
                                        </button>
                                    ` : `
                                        <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'persiana')"
                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                            ‚Ü©Ô∏è Usa Globale
                                        </button>
                                    `}
                                </div>
                                
                                ${!per.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigPersiane?.misuraBaseL || '?'} ${project.brmConfigPersiane?.operazioneL || '-'} ${project.brmConfigPersiane?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigPersiane?.misuraBaseH || '?'} ${project.brmConfigPersiane?.operazioneH || '-'} ${project.brmConfigPersiane?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${per.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${per.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${per.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${per.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${per.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-persiana-${pos.id}" value="${per.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-persiana-${pos.id}">
                                                = ${per.brmPersonalizzato?.misuraBaseL || '?'} ${per.brmPersonalizzato?.operazioneL || '+'} ${per.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${per.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${per.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${per.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-persiana-${pos.id}" value="${per.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-persiana-${pos.id}">
                                                = ${per.brmPersonalizzato?.misuraBaseH || '?'} ${per.brmPersonalizzato?.operazioneH || '+'} ${per.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${per.BRM_L || ''}" readonly id="brm-l-result-persiana-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${per.BRM_H || ''}" readonly id="brm-h-result-persiana-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${per.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${per.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

                function renderTapparelleTab(project, pos) {
            const tap = pos.tapparella;
            
            return `
                <div class="space-y-4">
                    ${!tap ? `
                        <!-- üéØ STATO INIZIALE: Prodotto non ancora creato -->
                        <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <p class="text-gray-700 mb-4 font-medium text-lg">Nessuna tapparella configurata</p>
                            <div class="flex flex-col items-center gap-3">
                                ${!pos.prodottiAssenti?.includes('tapparella') ? `
                                    <button onclick="addTapparella('${project.id}', '${pos.id}')"
                                            class="px-6 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700 shadow-sm hover:shadow-md transition-all">
                                        + Aggiungi Tapparella
                                    </button>
                                ` : ''}
                                <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                                    <input type="checkbox" 
                                           ${pos.prodottiAssenti?.includes('tapparella') ? 'checked' : ''}
                                           onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'tapparelle')"
                                           class="w-4 h-4">
                                    <span class="text-gray-700 font-medium">‚ö†Ô∏è Non presente in questa posizione</span>
                                </label>
                            </div>
                        </div>
                    ` : (parseInt(tap.qta) === 0 || tap.qta === '0' || tap.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-amber-700 text-lg">üéöÔ∏è Tapparella</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'tapparella')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(tap.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-amber-700 text-lg">üéöÔ∏è Tapparella</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'tapparella')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <!-- üìã DATI SPECIFICI -->
                            <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                                    üìã Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(tap.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- ‚öôÔ∏è CONFIGURAZIONE -->
                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                    ‚öôÔ∏è Configurazione
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <!-- AZIENDA -->
                                    ${renderSelectWithCustom(
                                        'azienda',
                                        tap.azienda || '',
                                        ['Plasticino', 'New Solar', 'Estella'],
                                        project.id,
                                        pos.id,
                                        'tapparella',
                                        'Azienda'
                                    )}

                                    <div>
                                        <label class="text-xs font-medium">Modello</label>
                                        <input type="text" value="${tap.modello || ''}"
                                               placeholder="Mini"
                                               list="modello-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'modello', this.value); updateColoriTapparellaDatalist('${pos.id}', this.value);"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="modello-tap-list-${pos.id}">
                                            <option value="TA01 - Tipo ALUPROFIL MD 13x55">
                                            <option value="TA25 - Tipo ALUPROFIL AD 13x55">
                                            <option value="TA15 - Tipo STEELPROFIL 13x55">
                                            <option value="A01 - Tipo ANTIGRANDINE 14x50">
                                            <option value="A10 - Tipo PESANTE 14x50">
                                            <option value="A16 - Tipo MINI 10 11x32">
                                            <option value="A15 - Tipo MINI 8 8x33">
                                            <option value="TA10 - Tipo ALUBLIND 13x45">
                                            <option value="TA13 - Tipo ALUBLIND 9x27">
                                            <option value="A18 - Tipo COMBI 13x53">
                                            <option value="A20 - Tipo COMBI 10x39">
                                            <option value="A40 - Tipo ORIENTA">
                                            <option value="A50 - Tipo ESTELLA CLASSIC (A)">
                                            <option value="A50 - Tipo ESTELLA CLASSIC (B)">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Telo</label>
                                        <input type="text" value="${tap.colore || ''}"
                                               placeholder="Bianco 01"
                                               list="colore-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'colore', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="colore-tap-list-${pos.id}">
                                            ${(() => {
                                                const colori = getColoriTapparella(tap.modello);
                                                return colori.map(c => `<option value="${c}">`).join('\n');
                                            })()}
                                        </datalist>
                                    </div>
                                    
                                    <!-- üîß SEZIONE SOSTITUZIONE COMPONENTI -->
                                    ${renderSostituzioneComponenti(project.id, pos.id, tap)}
                                    
                                    <!-- üÜï 3 OPZIONI SEMPRE VISIBILI (NON PI√ô CONDIZIONALI) -->
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium mb-2">Tipo Tapparella</label>
                                        <div class="space-y-3">
                                            <!-- Opzione 1: Manuale -->
                                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${(!tap.nuovaAutomazione || tap.nuovaAutomazione === 'Manuale') ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">
                                                <input type="radio" 
                                                       name="nuovaAuto-${pos.id}" 
                                                       id="manuale-${pos.id}"
                                                       ${(!tap.nuovaAutomazione || tap.nuovaAutomazione === 'Manuale') ? 'checked' : ''}
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'nuovaAutomazione', 'Manuale'); updateProduct('${project.id}', '${pos.id}', 'tapparella', 'forniMotore', false); updateProduct('${project.id}', '${pos.id}', 'tapparella', 'modelloMotore', ''); render();"
                                                       class="w-4 h-4">
                                                <label for="manuale-${pos.id}" class="font-semibold cursor-pointer flex-1">
                                                    üñêÔ∏è Manuale
                                                </label>
                                            </div>
                                            
                                            <!-- Opzione 2: Motore esistente (riutilizzo) -->
                                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${tap.nuovaAutomazione === 'Motore esistente' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">
                                                <input type="radio" 
                                                       name="nuovaAuto-${pos.id}" 
                                                       id="motoreEsist-${pos.id}"
                                                       ${tap.nuovaAutomazione === 'Motore esistente' ? 'checked' : ''}
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'nuovaAutomazione', 'Motore esistente'); updateProduct('${project.id}', '${pos.id}', 'tapparella', 'forniMotore', false); updateProduct('${project.id}', '${pos.id}', 'tapparella', 'modelloMotore', ''); render();"
                                                       class="w-4 h-4">
                                                <label for="motoreEsist-${pos.id}" class="font-semibold cursor-pointer flex-1">
                                                    ‚ôªÔ∏è Motore esistente (riutilizzo)
                                                </label>
                                            </div>
                                            
                                            <!-- Opzione 3: Motorizzata -->
                                            <div class="border-2 rounded-lg ${tap.nuovaAutomazione === 'Motorizzata' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white'}">
                                                <div class="flex items-center gap-3 p-3">
                                                    <input type="radio" 
                                                           name="nuovaAuto-${pos.id}" 
                                                           id="motorizzata-${pos.id}"
                                                           ${tap.nuovaAutomazione === 'Motorizzata' ? 'checked' : ''}
                                                           onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'nuovaAutomazione', 'Motorizzata'); render();"
                                                           class="w-4 h-4">
                                                    <label for="motorizzata-${pos.id}" class="font-semibold cursor-pointer flex-1">
                                                        ‚ö° Motorizzata
                                                    </label>
                                                </div>
                                                
                                                ${tap.nuovaAutomazione === 'Motorizzata' ? `
                                                    <div class="px-3 pb-3 space-y-3 border-t pt-3">
                                                        <!-- Checkbox: Forniamo motore? -->
                                                        <div class="flex items-center gap-3">
                                                            <input type="checkbox" 
                                                                   id="forniMotore-${pos.id}"
                                                                   ${tap.forniMotore ? 'checked' : ''}
                                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'forniMotore', this.checked); render();"
                                                                   class="w-4 h-4">
                                                            <label for="forniMotore-${pos.id}" class="font-medium cursor-pointer">
                                                                üîå Forniamo motore
                                                            </label>
                                                        </div>
                                                        
                                                        ${tap.forniMotore ? `
                                                            <!-- Select Modello Motore -->
                                                            <div class="pl-6">
                                                                <label class="block text-sm font-medium mb-1">Modello motore:</label>
                                                                <select class="w-full px-3 py-2 border rounded-lg"
                                                                        onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'modelloMotore', this.value)">
                                                                    <option value="">Seleziona modello...</option>
                                                                    <option value="OXIMO IO" ${tap.modelloMotore === 'OXIMO IO' ? 'selected' : ''}>OXIMO IO</option>
                                                                    <option value="RS100 io Hybrid" ${tap.modelloMotore === 'RS100 io Hybrid' ? 'selected' : ''}>RS100 io Hybrid</option>
                                                                    <option value="LT HELIOS" ${tap.modelloMotore === 'LT HELIOS' ? 'selected' : ''}>LT HELIOS</option>
                                                                    <option value="RS100 SOLAR io" ${tap.modelloMotore === 'RS100 SOLAR io' ? 'selected' : ''}>RS100 SOLAR io</option>
                                                                </select>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- üîå MOTORI (SISTEMA COMPLETO FASE 11a) -->
                            ${(() => {
                                const tipoEsistente = pos.rilievoTapparelle?.tipo || '';
                                const mostraMotori = (
                                    // CASO A: Esistente Manuale ‚Üí Nuova Motorizzata ‚Üí Forniamo motore
                                    (tipoEsistente === 'Manuale' && tap.nuovaAutomazione === 'Motorizzata' && tap.forniMotore) ||
                                    // CASO B: Esistente Motorizzata ‚Üí Sostituzione motore
                                    (tipoEsistente === 'Motorizzata' && tap.nuovaAutomazione === 'Sostituzione motore')
                                );
                                
                                return mostraMotori ? `
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-semibold text-blue-800 flex items-center gap-2">
                                        üîå Motori
                                    </h5>
                                    <button onclick="addMotoreTapparella('${project.id}', '${pos.id}')"
                                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700">
                                        + Aggiungi Motore
                                    </button>
                                </div>
                                ${tap.motori && tap.motori.length > 0 ? `
                                    ${tap.motori.map((motore, idx) => `
                                        <div class="bg-white p-4 rounded border-2 border-blue-300 mb-3">
                                            <div class="flex justify-between items-center mb-3">
                                                <h6 class="text-sm font-semibold text-blue-700">üîå Motore ${idx + 1}</h6>
                                                <button onclick="removeMotoreTapparella('${project.id}', '${pos.id}', ${idx})"
                                                        class="text-red-600 hover:text-red-800 text-sm font-semibold px-2 py-1 hover:bg-red-50 rounded">
                                                    ‚úï Rimuovi
                                                </button>
                                            </div>
                                            
                                            <!-- Marca Motore -->
                                            <div class="mb-3">
                                                <label class="text-xs font-medium text-gray-700">üè≠ Marca</label>
                                                <input type="text" 
                                                       value="${motore.marca || ''}"
                                                       placeholder="Es: Somfy, Nice..."
                                                       list="marca-motore-list-${idx}"
                                                       onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'marca', this.value)"
                                                       class="w-full px-3 py-2 border rounded text-sm mt-1">
                                                <datalist id="marca-motore-list-${idx}">
                                                    <option value="Somfy">
                                                    <option value="Nice">
                                                    <option value="Cherubini">
                                                    <option value="BTicino">
                                                    <option value="Came">
                                                    <option value="Faac">
                                                </datalist>
                                            </div>

                                            <!-- Modello/Trasmettitore -->
                                            <div class="mb-3">
                                                <label class="text-xs font-medium text-gray-700">üì° Modello / Trasmettitore</label>
                                                <input type="text" 
                                                       value="${motore.modello || ''}"
                                                       placeholder="Es: LT, Oximo, Hybrid..."
                                                       list="modello-motore-list-${idx}"
                                                       onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'modello', this.value)"
                                                       class="w-full px-3 py-2 border rounded text-sm mt-1">
                                                <datalist id="modello-motore-list-${idx}">
                                                    <option value="LT">
                                                    <option value="Oximo">
                                                    <option value="Hybrid">
                                                    <option value="Era">
                                                    <option value="Neo">
                                                    <option value="Spider">
                                                </datalist>
                                            </div>

                                            <!-- Tipo Alimentazione -->
                                            <div class="mb-3">
                                                <label class="text-xs font-medium text-gray-700 block mb-2">‚ö° Tipo Alimentazione</label>
                                                <div class="flex gap-4">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" 
                                                               name="alimentazione-${idx}" 
                                                               value="Filare"
                                                               ${!motore.alimentazione || motore.alimentazione === 'Filare' ? 'checked' : ''}
                                                               onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'alimentazione', this.value)"
                                                               class="w-4 h-4">
                                                        <span class="text-sm">üîå Filare</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" 
                                                               name="alimentazione-${idx}" 
                                                               value="Telecomando"
                                                               ${motore.alimentazione === 'Telecomando' ? 'checked' : ''}
                                                               onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'alimentazione', this.value)"
                                                               class="w-4 h-4">
                                                        <span class="text-sm">üìª Telecomando</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Trasmettitore (solo se Telecomando) -->
                                            ${motore.alimentazione === 'Telecomando' ? `
                                                <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-3">
                                                    <label class="text-xs font-medium text-purple-800 block mb-2">üìª Trasmettitore</label>
                                                    <input type="text" 
                                                           value="${motore.trasmettitore || ''}"
                                                           placeholder="Es: RTS, IO, Telis..."
                                                           onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'trasmettitore', this.value)"
                                                           class="w-full px-3 py-2 border border-purple-300 rounded text-sm">
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                ` : `
                                    <p class="text-sm text-gray-500 italic text-center py-3">Nessun motore aggiunto</p>
                                `}
                            </div>
                            ` : '' })()}

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    ${!tap.brmPersonalizzato ? `
                                        <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'tapparella')"
                                                class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                            üé® Personalizza BRM
                                        </button>
                                    ` : `
                                        <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'tapparella')"
                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                            ‚Ü©Ô∏è Usa Globale
                                        </button>
                                    `}
                                </div>
                                
                                ${!tap.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigTapparelle?.misuraBaseL || '?'} ${project.brmConfigTapparelle?.operazioneL || '-'} ${project.brmConfigTapparelle?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigTapparelle?.misuraBaseH || '?'} ${project.brmConfigTapparelle?.operazioneH || '-'} ${project.brmConfigTapparelle?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${tap.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${tap.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-tapparella-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${tap.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-tapparella-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${tap.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${tap.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-tapparella-${pos.id}" value="${tap.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-tapparella-${pos.id}">
                                                = ${tap.brmPersonalizzato?.misuraBaseL || '?'} ${tap.brmPersonalizzato?.operazioneL || '+'} ${tap.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-tapparella-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${tap.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-tapparella-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${tap.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${tap.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-tapparella-${pos.id}" value="${tap.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-tapparella-${pos.id}">
                                                = ${tap.brmPersonalizzato?.misuraBaseH || '?'} ${tap.brmPersonalizzato?.operazioneH || '+'} ${tap.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${tap.BRM_L || ''}" readonly id="brm-l-result-tapparella-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${tap.BRM_H || ''}" readonly id="brm-h-result-tapparella-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${tap.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${tap.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

                function renderZanzariereTab(project, pos) {
            const zan = pos.zanzariera;
            
            return `
                <div class="space-y-4">
                    ${!zan ? `
                        <!-- üéØ STATO INIZIALE: Prodotto non ancora creato -->
                        <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <p class="text-gray-700 mb-4 font-medium text-lg">Nessuna zanzariera configurata</p>
                            <div class="flex flex-col items-center gap-3">
                                ${!pos.prodottiAssenti?.includes('zanzariera') ? `
                                    <button onclick="addZanzariera('${project.id}', '${pos.id}')"
                                            class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 shadow-sm hover:shadow-md transition-all">
                                        + Aggiungi Zanzariera
                                    </button>
                                ` : ''}
                                <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                                    <input type="checkbox" 
                                           ${pos.prodottiAssenti?.includes('zanzariera') ? 'checked' : ''}
                                           onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'zanzariere')"
                                           class="w-4 h-4">
                                    <span class="text-gray-700 font-medium">‚ö†Ô∏è Non presente in questa posizione</span>
                                </label>
                            </div>
                        </div>
                    ` : (parseInt(zan.qta) === 0 || zan.qta === '0' || zan.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-green-700 text-lg">ü¶ü Zanzariera</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'zanzariera')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(zan.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-green-700 text-lg">ü¶ü Zanzariera</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'zanzariera')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <!-- ‚öôÔ∏è TIPO INFISSO ASSOCIATO -->
                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                    üîß Tipo Infisso Associato
                                </h5>
                                <p class="text-sm text-gray-600 mb-3">Seleziona tipo:</p>
                                <div class="flex gap-6">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfisso-${project.id}-${pos.id}"
                                               value="F"
                                               ${zan.tipoInfissoAssociato === 'F' ? 'checked' : ''}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoInfissoAssociato', 'F')"
                                               class="w-4 h-4">
                                        <span class="font-medium">F (Finestra)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfisso-${project.id}-${pos.id}"
                                               value="PF"
                                               ${zan.tipoInfissoAssociato === 'PF' ? 'checked' : ''}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoInfissoAssociato', 'PF')"
                                               class="w-4 h-4">
                                        <span class="font-medium">PF (Porta Finestra)</span>
                                    </label>
                                </div>
                                ${!zan.tipoInfissoAssociato ? `
                                    <div class="mt-3 bg-amber-100 border-l-4 border-amber-500 p-3">
                                        <p class="text-sm text-amber-800">‚ö†Ô∏è Seleziona prima se F o PF</p>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- üìã DATI SPECIFICI -->
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                                    üìã Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(zan.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <!-- AZIENDA -->
                                    ${renderSelectWithCustom(
                                        'azienda',
                                        zan.azienda || '',
                                        ['Palagina', 'Finstral'],
                                        project.id,
                                        pos.id,
                                        'zanzariera',
                                        'Azienda'
                                    )}

                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipo', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">--</option>
                                            <option value="Avvolgibile" ${zan.tipo === 'Avvolgibile' ? 'selected' : ''}>Avvolgibile</option>
                                            <option value="Pliss√©" ${zan.tipo === 'Pliss√©' ? 'selected' : ''}>Pliss√©</option>
                                            <option value="Battente" ${zan.tipo === 'Battente' ? 'selected' : ''}>Battente</option>
                                            <option value="Scorrevole" ${zan.tipo === 'Scorrevole' ? 'selected' : ''}>Scorrevole</option>
                                            <option value="Fissa" ${zan.tipo === 'Fissa' ? 'selected' : ''}>Fissa</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Apertura</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'apertura', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">--</option>
                                            <option value="SP SX" ${zan.apertura === 'SP SX' ? 'selected' : ''}>SP SX</option>
                                            <option value="SP DX" ${zan.apertura === 'SP DX' ? 'selected' : ''}>SP DX</option>
                                            <option value="SCORR SX" ${zan.apertura === 'SCORR SX' ? 'selected' : ''}>SCORR SX</option>
                                            <option value="SCORR DX" ${zan.apertura === 'SCORR DX' ? 'selected' : ''}>SCORR DX</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- ‚öôÔ∏è CONFIGURAZIONE -->
                            <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                                    ‚öôÔ∏è Configurazione
                                </h5>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Colore Telaio</label>
                                        <input type="text" value="${zan.coloreTelaio || ''}"
                                               placeholder="Es: Bianco, Marrone"
                                               list="coloreTel-zan-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'coloreTelaio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreTel-zan-list-${pos.id}">
                                            <option value="Bianco">
                                            <option value="Marrone">
                                            <option value="Grigio">
                                            <option value="Nero">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo Rete</label>
                                        <input type="text" value="${zan.tipoRete || ''}"
                                               placeholder="Es: Standard, Anti-polline"
                                               list="tipoRete-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoRete', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="tipoRete-list-${pos.id}">
                                            <option value="Standard">
                                            <option value="Anti-polline">
                                            <option value="Pet-resistant">
                                            <option value="Micro-forata">
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    ${!zan.brmPersonalizzato ? `
                                        <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'zanzariera')"
                                                class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                            üé® Personalizza BRM
                                        </button>
                                    ` : `
                                        <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'zanzariera')"
                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                            ‚Ü©Ô∏è Usa Globale
                                        </button>
                                    `}
                                </div>
                                
                                ${!zan.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigZanzariere?.misuraBaseL || '?'} ${project.brmConfigZanzariere?.operazioneL || '-'} ${project.brmConfigZanzariere?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigZanzariere?.misuraBaseH || '?'} ${project.brmConfigZanzariere?.operazioneH || '-'} ${project.brmConfigZanzariere?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${zan.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${zan.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-zanzariera-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LPF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${zan.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-zanzariera-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${zan.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${zan.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-zanzariera-${pos.id}" value="${zan.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-zanzariera-${pos.id}">
                                                = ${zan.brmPersonalizzato?.misuraBaseL || '?'} ${zan.brmPersonalizzato?.operazioneL || '+'} ${zan.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-zanzariera-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HPF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${zan.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-zanzariera-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${zan.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${zan.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-zanzariera-${pos.id}" value="${zan.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-zanzariera-${pos.id}">
                                                = ${zan.brmPersonalizzato?.misuraBaseH || '?'} ${zan.brmPersonalizzato?.operazioneH || '+'} ${zan.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${zan.BRM_L || ''}" readonly id="brm-l-result-zanzariera-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${zan.BRM_H || ''}" readonly id="brm-h-result-zanzariera-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${zan.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${zan.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

                function renderCassonettiTab(project, pos) {
            const cas = pos.cassonetto;
            
            return `
                <div class="space-y-4">
                    ${!cas ? `
                        <!-- üéØ STATO INIZIALE: Prodotto non ancora creato -->
                        <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <p class="text-gray-700 mb-4 font-medium text-lg">Nessun cassonetto configurato</p>
                            <div class="flex flex-col items-center gap-3">
                                ${!pos.prodottiAssenti?.includes('cassonetto') ? `
                                    <button onclick="addCassonetto('${project.id}', '${pos.id}')"
                                            class="px-6 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 shadow-sm hover:shadow-md transition-all">
                                        + Aggiungi Cassonetto
                                    </button>
                                ` : ''}
                                <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                                    <input type="checkbox" 
                                           ${pos.prodottiAssenti?.includes('cassonetto') ? 'checked' : ''}
                                           onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'cassonetti')"
                                           class="w-4 h-4">
                                    <span class="text-gray-700 font-medium">‚ö†Ô∏è Non presente in questa posizione</span>
                                </label>
                            </div>
                        </div>
                    ` : (parseInt(cas.qta) === 0 || cas.qta === '0' || cas.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-orange-700 text-lg">üì¶ Cassonetto</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'cassonetto')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(cas.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-orange-700 text-lg">üì¶ Cassonetto</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'cassonetto')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <!-- üìã DATI GENERALI -->
                            <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-orange-800 mb-3 flex items-center gap-2">
                                    üìã Dati Generali
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <!-- QUANTIT√Ä -->
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(cas.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <!-- 1. AZIENDA -->
                                    ${renderSelectWithCustom(
                                        'azienda',
                                        cas.azienda || '',
                                        ['Finstral', 'Mag√≤', 'Alpac'],
                                        project.id,
                                        pos.id,
                                        'cassonetto',
                                        'Azienda'
                                    )}
                                </div>
                                
                                ${(() => {
                                    const azienda = cas.azienda || '';
                                    
                                    // ====== FINSTRAL ======
                                    if (azienda === 'Finstral') {
                                        return `
                                            <div class="grid md:grid-cols-3 gap-3 mt-3">
                                                <!-- 2. CASSONETTO (checkbox + text) -->
                                                <div>
                                                    <label class="text-xs font-medium flex items-center gap-2">
                                                        <input type="checkbox" 
                                                               ${cas.cassonettoCheck !== false ? 'checked' : ''}
                                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'cassonettoCheck', this.checked)"
                                                               class="w-4 h-4">
                                                        2. Cassonetto
                                                    </label>
                                                    <input type="text" 
                                                           value="${cas.cassonettoText || 'Cassonetto'}"
                                                           onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'cassonettoText', this.value)"
                                                           placeholder="Cassonetto"
                                                           class="w-full compact-input border rounded mt-1">
                                                </div>
                                                
                                                <!-- 3. POSA (checkbox + text) -->
                                                <div>
                                                    <label class="text-xs font-medium flex items-center gap-2">
                                                        <input type="checkbox" 
                                                               ${cas.posaCheck !== false ? 'checked' : ''}
                                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'posaCheck', this.checked)"
                                                               class="w-4 h-4">
                                                        3. Posa
                                                    </label>
                                                    <input type="text" 
                                                           value="${cas.posaText || 'Frontale'}"
                                                           onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'posaText', this.value)"
                                                           placeholder="Frontale"
                                                           class="w-full compact-input border rounded mt-1">
                                                </div>
                                                
                                                <!-- 4. COLORE (auto da infisso) -->
                                                <div>
                                                    <label class="text-xs font-medium">4. Colore</label>
                                                    <input type="text" 
                                                           value="${cas.colore || pos.infisso?.coloreEsterno || 'Finiture PVC'}"
                                                           onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'colore', this.value)"
                                                           placeholder="Finiture PVC"
                                                           class="w-full compact-input border rounded mt-1 bg-blue-50">
                                                    <p class="text-xs text-gray-500 mt-0.5">‚ö° Auto da infisso</p>
                                                </div>
                                                
                                                <!-- 5. ISOLAMENTO POSACLIMA (checkbox) -->
                                                <div>
                                                    <label class="text-xs font-medium flex items-center gap-2 mt-2">
                                                        <input type="checkbox" 
                                                               ${cas.isolamentoPosaclima ? 'checked' : ''}
                                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'isolamentoPosaclima', this.checked)"
                                                               class="w-4 h-4">
                                                        5. Isolamento Posaclima
                                                    </label>
                                                </div>
                                                
                                                <!-- 6. A SOFFITTO (checkbox) -->
                                                <div>
                                                    <label class="text-xs font-medium flex items-center gap-2 mt-2">
                                                        <input type="checkbox" 
                                                               ${cas.aSoffitto ? 'checked' : ''}
                                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'aSoffitto', this.checked)"
                                                               class="w-4 h-4">
                                                        6. A Soffitto
                                                    </label>
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    // ====== MAG√í E ALPAC ======
                                    if (azienda === 'Mag√≤' || azienda === 'Alpac') {
                                        return `
                                            <div class="grid md:grid-cols-3 gap-3 mt-3">
                                                <!-- 2. TIPO -->
                                                <div>
                                                    <label class="text-xs font-medium">2. Tipo</label>
                                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'tipo', this.value)"
                                                            class="w-full compact-input border rounded mt-1">
                                                        <option value="">--</option>
                                                        <option value="Cassonetto" ${cas.tipo === 'Cassonetto' ? 'selected' : ''}>Cassonetto</option>
                                                        <option value="Monoblocco" ${cas.tipo === 'Monoblocco' ? 'selected' : ''}>Monoblocco</option>
                                                    </select>
                                                </div>
                                                
                                                <!-- 3. POSA -->
                                                <div>
                                                    <label class="text-xs font-medium">3. Posa</label>
                                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'posa', this.value)"
                                                            class="w-full compact-input border rounded mt-1">
                                                        <option value="">--</option>
                                                        <option value="Frontale" ${cas.posa === 'Frontale' ? 'selected' : ''}>Frontale</option>
                                                        <option value="Rasomuro" ${cas.posa === 'Rasomuro' ? 'selected' : ''}>Rasomuro</option>
                                                        <option value="Esterna dal sotto" ${cas.posa === 'Esterna dal sotto' ? 'selected' : ''}>Esterna dal sotto</option>
                                                        <option value="Interna dal sotto" ${cas.posa === 'Interna dal sotto' ? 'selected' : ''}>Interna dal sotto</option>
                                                    </select>
                                                </div>
                                                
                                                <!-- 4. FINITURA -->
                                                <div>
                                                    <label class="text-xs font-medium">4. Finitura</label>
                                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'finitura', this.value)"
                                                            class="w-full compact-input border rounded mt-1">
                                                        <option value="">--</option>
                                                        <option value="Grezzo da rasare" ${cas.finitura === 'Grezzo da rasare' ? 'selected' : ''}>Grezzo da rasare</option>
                                                        <option value="Mano di fondo" ${cas.finitura === 'Mano di fondo' ? 'selected' : ''}>Mano di fondo</option>
                                                    </select>
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    // Nessuna azienda o azienda custom
                                    if (!azienda || (azienda !== 'Finstral' && azienda !== 'Mag√≤' && azienda !== 'Alpac')) {
                                        return `
                                            <div class="mt-3 bg-gray-50 border-2 border-gray-300 rounded-lg p-3">
                                                <p class="text-xs text-gray-600 text-center">
                                                    ‚ö†Ô∏è Seleziona un'azienda (Finstral, Mag√≤ o Alpac) per visualizzare i campi specifici
                                                </p>
                                            </div>
                                        `;
                                    }
                                    
                                    return '';
                                })()}
                            </div>

                            <!-- üìè MISURE CASSONETTO (mm) -->
                            <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                                    üìè Misure Cassonetto (mm)
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">LS</label>
                                        <input type="number" value="${cas.LS || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'LS', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">SRSX</label>
                                        <input type="number" value="${cas.SRSX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'SRSX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <!-- ‚úÖ v4.97: ZSX con radio button + validazione -->
                                    <div class="bg-blue-50 p-2 rounded border border-blue-200">
                                        <label class="text-xs font-medium text-blue-800">ZSX (Spazio SX)</label>
                                        <div class="flex flex-col gap-1 mt-1">
                                            <label class="flex items-center gap-1 text-xs cursor-pointer">
                                                <input type="radio" name="zsx-tipo-${pos.id}" value="muro"
                                                       ${(cas.ZSX_tipo === 'muro' || (!cas.ZSX_tipo && cas.ZSX === '0')) ? 'checked' : ''}
                                                       onchange="updateZSXTipo('${project.id}', '${pos.id}', 'muro')">
                                                <span>üß± A muro (=SRSX)</span>
                                            </label>
                                            <label class="flex items-center gap-1 text-xs cursor-pointer">
                                                <input type="radio" name="zsx-tipo-${pos.id}" value="libero"
                                                       ${cas.ZSX_tipo === 'libero' ? 'checked' : ''}
                                                       onchange="updateZSXTipo('${project.id}', '${pos.id}', 'libero')">
                                                <span>‚úÖ Libero (&gt;50mm)</span>
                                            </label>
                                            <label class="flex items-center gap-1 text-xs cursor-pointer">
                                                <input type="radio" name="zsx-tipo-${pos.id}" value="limitato"
                                                       ${cas.ZSX_tipo === 'limitato' ? 'checked' : ''}
                                                       onchange="updateZSXTipo('${project.id}', '${pos.id}', 'limitato')">
                                                <span>‚ö†Ô∏è Limitato:</span>
                                                <input type="number" 
                                                       id="zsx-input-${pos.id}"
                                                       value="${cas.ZSX_tipo === 'limitato' ? (cas.ZSX || '') : ''}"
                                                       placeholder="mm"
                                                       min="1"
                                                       ${cas.ZSX_tipo !== 'limitato' ? 'disabled' : ''}
                                                       onchange="validateAndUpdateZSX('${project.id}', '${pos.id}', this.value)"
                                                       class="w-16 px-1 py-0.5 border rounded text-xs ${cas.ZSX_tipo !== 'limitato' ? 'bg-gray-100' : (cas.ZSX_tipo === 'limitato' && !cas.ZSX ? 'border-red-500 bg-red-50' : '')}">
                                                <span class="text-xs">mm</span>
                                            </label>
                                        </div>
                                        <!-- Messaggio errore ZSX > SRSX -->
                                        ${(() => {
                                            const zsx = parseInt(cas.ZSX) || 0;
                                            const srsx = parseInt(cas.SRSX) || 0;
                                            if (cas.ZSX_tipo === 'limitato' && zsx > 0 && srsx > 0 && zsx > srsx) {
                                                return '<div class="text-xs text-red-600 font-semibold mt-1">‚ö†Ô∏è ZSX (' + zsx + 'mm) supera SRSX (' + srsx + 'mm)!</div>';
                                            }
                                            if (cas.ZSX_tipo === 'limitato' && !cas.ZSX) {
                                                return '<div class="text-xs text-orange-600 mt-1">‚ö†Ô∏è Inserisci mm disponibili</div>';
                                            }
                                            return '';
                                        })()}
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">SRDX</label>
                                        <input type="number" value="${cas.SRDX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'SRDX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <!-- ‚úÖ v4.97: ZDX con radio button + validazione -->
                                    <div class="bg-purple-50 p-2 rounded border border-purple-200">
                                        <label class="text-xs font-medium text-purple-800">ZDX (Spazio DX)</label>
                                        <div class="flex flex-col gap-1 mt-1">
                                            <label class="flex items-center gap-1 text-xs cursor-pointer">
                                                <input type="radio" name="zdx-tipo-${pos.id}" value="muro"
                                                       ${(cas.ZDX_tipo === 'muro' || (!cas.ZDX_tipo && cas.ZDX === '0')) ? 'checked' : ''}
                                                       onchange="updateZDXTipo('${project.id}', '${pos.id}', 'muro')">
                                                <span>üß± A muro (=SRDX)</span>
                                            </label>
                                            <label class="flex items-center gap-1 text-xs cursor-pointer">
                                                <input type="radio" name="zdx-tipo-${pos.id}" value="libero"
                                                       ${cas.ZDX_tipo === 'libero' ? 'checked' : ''}
                                                       onchange="updateZDXTipo('${project.id}', '${pos.id}', 'libero')">
                                                <span>‚úÖ Libero (&gt;50mm)</span>
                                            </label>
                                            <label class="flex items-center gap-1 text-xs cursor-pointer">
                                                <input type="radio" name="zdx-tipo-${pos.id}" value="limitato"
                                                       ${cas.ZDX_tipo === 'limitato' ? 'checked' : ''}
                                                       onchange="updateZDXTipo('${project.id}', '${pos.id}', 'limitato')">
                                                <span>‚ö†Ô∏è Limitato:</span>
                                                <input type="number" 
                                                       id="zdx-input-${pos.id}"
                                                       value="${cas.ZDX_tipo === 'limitato' ? (cas.ZDX || '') : ''}"
                                                       placeholder="mm"
                                                       min="1"
                                                       ${cas.ZDX_tipo !== 'limitato' ? 'disabled' : ''}
                                                       onchange="validateAndUpdateZDX('${project.id}', '${pos.id}', this.value)"
                                                       class="w-16 px-1 py-0.5 border rounded text-xs ${cas.ZDX_tipo !== 'limitato' ? 'bg-gray-100' : (cas.ZDX_tipo === 'limitato' && !cas.ZDX ? 'border-red-500 bg-red-50' : '')}">
                                                <span class="text-xs">mm</span>
                                            </label>
                                        </div>
                                        <!-- Messaggio errore ZDX > SRDX -->
                                        ${(() => {
                                            const zdx = parseInt(cas.ZDX) || 0;
                                            const srdx = parseInt(cas.SRDX) || 0;
                                            if (cas.ZDX_tipo === 'limitato' && zdx > 0 && srdx > 0 && zdx > srdx) {
                                                return '<div class="text-xs text-red-600 font-semibold mt-1">‚ö†Ô∏è ZDX (' + zdx + 'mm) supera SRDX (' + srdx + 'mm)!</div>';
                                            }
                                            if (cas.ZDX_tipo === 'limitato' && !cas.ZDX) {
                                                return '<div class="text-xs text-orange-600 mt-1">‚ö†Ô∏è Inserisci mm disponibili</div>';
                                            }
                                            return '';
                                        })()}
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">HCASS</label>
                                        <input type="number" value="${cas.HCASS || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'HCASS', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">B</label>
                                        <input type="number" value="${cas.B || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'B', this.value); validateCassonettoBC('${project.id}', '${pos.id}');"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">C</label>
                                        <input type="number" value="${cas.C || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'C', this.value); validateCassonettoBC('${project.id}', '${pos.id}');"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">BSuperiore</label>
                                        <input type="number" value="${cas.BSuperiore || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'BSuperiore', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                </div>
                                
                                <!-- ‚úÖ v4.86: Controllo B-C con ID per aggiornamento real-time -->
                                <div id="bc-validation-${pos.id}">
                                ${(() => {
                                    // Validazione B - C = Prof. Muro Int ¬± 10mm
                                    const b = parseFloat(cas.B) || 0;
                                    const c = parseFloat(cas.C) || 0;
                                    const diff = b - c;
                                    
                                    // Prendi Prof. Muro Int (override o globale)
                                    const profMuroInt = pos.caratteristicheMuroOverride?.profMuroInt 
                                        ? parseFloat(pos.caratteristicheMuroOverride.profMuroInt) 
                                        : parseFloat(project.caratteristicheMuro?.profMuroInt) || 0;
                                    
                                    if (b === 0 || c === 0 || profMuroInt === 0) {
                                        return `
                                            <div class="mt-3 bg-gray-100 border-l-4 border-gray-400 p-3">
                                                <p class="text-sm text-gray-600">
                                                    ‚ÑπÔ∏è Inserisci B, C e Prof. Muro Int per attivare il controllo
                                                </p>
                                            </div>
                                        `;
                                    }
                                    
                                    const differenza = Math.abs(diff - profMuroInt);
                                    const isValid = differenza <= 10;
                                    
                                    if (isValid) {
                                        return `
                                            <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-3">
                                                <p class="text-sm text-green-800">
                                                    ‚úÖ <strong>Controllo OK:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm ‚úì
                                                </p>
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-3">
                                                <p class="text-sm text-red-800">
                                                    ‚ö†Ô∏è <strong>ATTENZIONE:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm (Tolleranza ¬±10mm superata!)
                                                </p>
                                            </div>
                                        `;
                                    }
                                })()}
                                </div>
                                
                                ${(() => {
                                    // ‚ö†Ô∏è CONTROLLI ALTEZZE CON CASSONETTO
                                    const hcass = parseFloat(cas.HCASS) || 0;
                                    const hmt = parseFloat(pos.misure?.HMT) || 0;
                                    const hsoffitto = parseFloat(pos.misure?.HSoffitto) || 0;
                                    const hPavParapetto = parseFloat(pos.misure?.HPavimentoParapetto) || 0;
                                    const hParapettoSoff = parseFloat(pos.misure?.HParapettoSoffitto) || 0;
                                    
                                    // BRM altezze per controllo 4
                                    const brmHInfisso = parseFloat(pos.infisso?.BRM_H) || 0;
                                    const brmHCassonetto = parseFloat(cas.BRM_H) || 0;
                                    
                                    // Determina se √® PF o F dal tipo infisso
                                    const tipoInfisso = pos.infisso?.tipo || '';
                                    const isPF = tipoInfisso.includes('PF');
                                    const isF = tipoInfisso.includes('F') && !isPF;
                                    
                                    let warnings = [];
                                    
                                    // ‚úÖ CONTROLLO 1: PF ‚Üí HSoffitto > HMT + HCASS
                                    if (isPF && hmt > 0 && hcass > 0 && hsoffitto > 0) {
                                        const somma = hmt + hcass;
                                        if (hsoffitto > somma) {
                                            warnings.push({
                                                type: 'success',
                                                msg: `‚úÖ <strong>PF OK:</strong> HSoffitto (${hsoffitto}mm) > HMT + HCASS (${hmt} + ${hcass} = ${somma}mm) ‚úì`
                                            });
                                        } else {
                                            warnings.push({
                                                type: 'error',
                                                msg: `‚ö†Ô∏è <strong>PF ERRORE:</strong> HSoffitto (${hsoffitto}mm) <= HMT + HCASS (${hmt} + ${hcass} = ${somma}mm)!`
                                            });
                                        }
                                    }
                                    
                                    // ‚úÖ CONTROLLO 2: F ‚Üí HParapettoSoffitto > HMT + HCASS (v4.88 FIX)
                                    if (isF && hParapettoSoff > 0 && hmt > 0 && hcass > 0) {
                                        const somma = hmt + hcass;
                                        if (hParapettoSoff > somma) {
                                            warnings.push({
                                                type: 'success',
                                                msg: `‚úÖ <strong>F OK:</strong> HParapettoSoffitto (${hParapettoSoff}mm) > HMT + HCASS (${hmt} + ${hcass} = ${somma}mm) ‚úì`
                                            });
                                        } else {
                                            warnings.push({
                                                type: 'error',
                                                msg: `‚ö†Ô∏è <strong>F ERRORE:</strong> HParapettoSoffitto (${hParapettoSoff}mm) <= HMT + HCASS (${hmt} + ${hcass} = ${somma}mm)!`
                                            });
                                        }
                                    }
                                    
                                    // ‚úÖ CONTROLLO 3: HPavimentoParapetto + HParapettoSoffitto = HSoffitto ¬± 10mm
                                    if (hPavParapetto > 0 && hParapettoSoff > 0 && hsoffitto > 0) {
                                        const somma = hPavParapetto + hParapettoSoff;
                                        const diff = Math.abs(somma - hsoffitto);
                                        if (diff <= 10) {
                                            warnings.push({
                                                type: 'success',
                                                msg: `‚úÖ <strong>ALTEZZE OK:</strong> HPav/Parap + HParap/Soff (${hPavParapetto} + ${hParapettoSoff} = ${somma}mm) = HSoffitto (${hsoffitto}mm) ¬± 10mm | Diff: ${diff.toFixed(1)}mm ‚úì`
                                            });
                                        } else {
                                            warnings.push({
                                                type: 'error',
                                                msg: `‚ö†Ô∏è <strong>ALTEZZE ERRORE:</strong> HPav/Parap + HParap/Soff (${hPavParapetto} + ${hParapettoSoff} = ${somma}mm) ‚â† HSoffitto (${hsoffitto}mm) | Diff: ${diff.toFixed(1)}mm (Tolleranza ¬±10mm superata!)`
                                            });
                                        }
                                    }
                                    
                                    // ‚úÖ CONTROLLO 4 (v4.88): BRM_H Infisso + BRM_H Cassonetto <= Spazio disponibile
                                    if (brmHInfisso > 0 && brmHCassonetto > 0) {
                                        const sommaBRM = brmHInfisso + brmHCassonetto;
                                        const spazioDisponibile = isPF ? hsoffitto : hParapettoSoff;
                                        const tipoSpazio = isPF ? 'HSoffitto' : 'HParapettoSoffitto';
                                        
                                        if (spazioDisponibile > 0) {
                                            if (sommaBRM <= spazioDisponibile) {
                                                warnings.push({
                                                    type: 'success',
                                                    msg: `‚úÖ <strong>BRM OK:</strong> BRM_H Infisso + BRM_H Cass (${brmHInfisso} + ${brmHCassonetto} = ${sommaBRM}mm) <= ${tipoSpazio} (${spazioDisponibile}mm) ‚úì`
                                                });
                                            } else {
                                                warnings.push({
                                                    type: 'error',
                                                    msg: `‚ö†Ô∏è <strong>BRM ERRORE:</strong> BRM_H Infisso + BRM_H Cass (${brmHInfisso} + ${brmHCassonetto} = ${sommaBRM}mm) > ${tipoSpazio} (${spazioDisponibile}mm)!`
                                                });
                                            }
                                        }
                                    }
                                    
                                    // Genera HTML per i messaggi
                                    if (warnings.length === 0) {
                                        return ''; // Nessun controllo applicabile
                                    }
                                    
                                    return warnings.map(w => {
                                        const bgColor = w.type === 'success' ? 'bg-green-100' : 'bg-red-100';
                                        const borderColor = w.type === 'success' ? 'border-green-500' : 'border-red-500';
                                        const textColor = w.type === 'success' ? 'text-green-800' : 'text-red-800';
                                        
                                        return `
                                            <div class="mt-3 ${bgColor} border-l-4 ${borderColor} p-3">
                                                <p class="text-sm ${textColor}">${w.msg}</p>
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                                
                                <div class="mt-3 bg-blue-100 border-l-4 border-blue-500 p-3">
                                    <p class="text-sm text-blue-800">
                                        üìù <strong>ZSX/ZDX:</strong> A muro = ZSX=SRSX (attaccato) | Libero = spazio &gt;50mm | Limitato = inserisci mm (deve essere ‚â§ SRSX/SRDX)
                                    </p>
                                </div>
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    <div class="flex gap-2">
                                        ${!cas.brmPersonalizzato ? `
                                            <button onclick="ricalcolaBRMCassonetto('${project.id}', '${pos.id}')"
                                                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-all">
                                                üîÑ Ricalcola BRM
                                            </button>
                                            <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'cassonetto')"
                                                    class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                                üé® Personalizza BRM
                                            </button>
                                        ` : `
                                            <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'cassonetto')"
                                                    class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                                ‚Ü©Ô∏è Usa Globale
                                            </button>
                                        `}
                                    </div>
                                </div>
                                
                                ${!cas.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigCassonetti?.misuraBaseL || '?'} ${project.brmConfigCassonetti?.operazioneL || '-'} ${project.brmConfigCassonetti?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigCassonetti?.misuraBaseH || '?'} ${project.brmConfigCassonetti?.operazioneH || '-'} ${project.brmConfigCassonetti?.valoreH || '0'}mm</div>
                                            <div><span class="font-semibold">BRM C =</span> ${project.brmConfigCassonetti?.misuraBaseC || '?'} ${project.brmConfigCassonetti?.operazioneC || '-'} ${project.brmConfigCassonetti?.valoreC || '0'}mm</div>
                                            <div><span class="font-semibold">BRM B =</span> ${project.brmConfigCassonetti?.misuraBaseB || '?'} ${project.brmConfigCassonetti?.operazioneB || '-'} ${project.brmConfigCassonetti?.valoreB || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${cas.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                            <!-- ‚úÖ v4.87: Nota allargamento dinamico -->
                                            <div class="text-xs mt-1 ${(cas.ZSX_tipo === 'muro' || cas.ZDX_tipo === 'muro') ? 'text-orange-600' : 'text-gray-500'}">
                                                üìê Allargamento: ${(() => {
                                                    const valoreL = parseFloat(project.brmConfigCassonetti?.valoreL) || 0;
                                                    const perLato = valoreL / 2;
                                                    const allSX = (cas.ZSX_tipo === 'muro') ? 0 : perLato;
                                                    const allDX = (cas.ZDX_tipo === 'muro') ? 0 : perLato;
                                                    const tot = allSX + allDX;
                                                    return `SX +${allSX}mm (${cas.ZSX_tipo || 'libero'}) | DX +${allDX}mm (${cas.ZDX_tipo || 'libero'}) = +${tot}mm`;
                                                })()}
                                            </div>
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${cas.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM C</label>
                                            <input type="number" value="${cas.BRM_C || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM B</label>
                                            <input type="number" value="${cas.BRM_B || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['(LS+SRSX+SRDX)', 'LVT', 'LF', 'TMV', 'BRM_L_INFISSO'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-cassonetto-${pos.id}">
                                                = ${cas.brmPersonalizzato?.misuraBaseL || '?'} ${cas.brmPersonalizzato?.operazioneL || '+'} ${cas.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HCASS', 'H Soffitto', 'H Parapetto/Soffitto', 'BRM_H_INFISSO'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-cassonetto-${pos.id}">
                                                = ${cas.brmPersonalizzato?.misuraBaseH || '?'} ${cas.brmPersonalizzato?.operazioneH || '+'} ${cas.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM C -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM C</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseC-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseC', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['Prof. Muro Int ‚Üí MI', 'C'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseC === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneC-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneC', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneC === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneC === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreC-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreC || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreC', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-c-cassonetto-${pos.id}">
                                                = ${cas.brmPersonalizzato?.misuraBaseC || '?'} ${cas.brmPersonalizzato?.operazioneC || '+'} ${cas.brmPersonalizzato?.valoreC || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM B -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM B</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseB-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseB', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['Prof. Muro Int ‚Üí MI', 'B'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseB === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneB-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneB', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneB === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneB === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreB-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreB || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreB', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-b-cassonetto-${pos.id}">
                                                = ${cas.brmPersonalizzato?.misuraBaseB || '?'} ${cas.brmPersonalizzato?.operazioneB || '+'} ${cas.brmPersonalizzato?.valoreB || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${cas.BRM_L || ''}" readonly id="brm-l-result-cassonetto-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${cas.BRM_H || ''}" readonly id="brm-h-result-cassonetto-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM C</label>
                                            <input type="number" value="${cas.BRM_C || ''}" readonly id="brm-c-result-cassonetto-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM B</label>
                                            <input type="number" value="${cas.BRM_B || ''}" readonly id="brm-b-result-cassonetto-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${cas.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${cas.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderPortonciniTab(project, pos) {
            const ptc = pos.portoncino;
            
            return `
                <div class="space-y-4">
                    ${!ptc ? `
                        <!-- üéØ STATO INIZIALE: Prodotto non ancora creato -->
                        <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                            <p class="text-gray-700 mb-4 font-medium text-lg">Nessun portoncino configurato</p>
                            <div class="flex flex-col items-center gap-3">
                                ${!pos.prodottiAssenti?.includes('portoncino') ? `
                                    <button onclick="addPortoncino('${project.id}', '${pos.id}')"
                                            class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-sm hover:shadow-md transition-all">
                                        + Aggiungi Portoncino Finstral
                                    </button>
                                ` : ''}
                                <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                                    <input type="checkbox" 
                                           ${pos.prodottiAssenti?.includes('portoncino') ? 'checked' : ''}
                                           onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'portoncini')"
                                           class="w-4 h-4">
                                    <span class="text-gray-700 font-medium">‚ö†Ô∏è Non presente in questa posizione</span>
                                </label>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-teal-700 text-lg">üö™ Portoncino Finstral</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'portoncino')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <!-- üìê DIMENSIONI BRM -->
                            <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                                    üìê Dimensioni BRM (Battuta Riferimento Misura)
                                </h5>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">BRM Larghezza (mm)</label>
                                        <input type="number" 
                                               value="${ptc.BRM_L || ''}"
                                               placeholder="es. 1000"
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'BRM_L', this.value)"
                                               class="w-full compact-input border rounded mt-1 font-bold">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">BRM Altezza (mm)</label>
                                        <input type="number" 
                                               value="${ptc.BRM_H || ''}"
                                               placeholder="es. 2200"
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'BRM_H', this.value)"
                                               class="w-full compact-input border rounded mt-1 font-bold">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- üèóÔ∏è TELAIO -->
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                                    üèóÔ∏è Telaio
                                </h5>
                                <div class="grid md:grid-cols-4 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Tipo Telaio</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'tipoTelaio', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona...</option>
                                            <option value="L" ${ptc.tipoTelaio === 'L' ? 'selected' : ''}>L - Standard</option>
                                            <option value="Z" ${ptc.tipoTelaio === 'Z' ? 'selected' : ''}>Z - Ribassato</option>
                                            <option value="T" ${ptc.tipoTelaio === 'T' ? 'selected' : ''}>T - Termico</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Soglia</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'soglia', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona...</option>
                                            <option value="standard" ${ptc.soglia === 'standard' ? 'selected' : ''}>Standard</option>
                                            <option value="ribassata" ${ptc.soglia === 'ribassata' ? 'selected' : ''}>Ribassata</option>
                                            <option value="filo-pavimento" ${ptc.soglia === 'filo-pavimento' ? 'selected' : ''}>Filo Pavimento</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Montante (mm)</label>
                                        <input type="text" 
                                               value="${ptc.montante || ''}"
                                               placeholder="Es: 110"
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'montante', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Traversa (mm)</label>
                                        <input type="text" 
                                               value="${ptc.traversa || ''}"
                                               placeholder="Es: 110"
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'traversa', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- üö™ ANTA E PANNELLO -->
                            <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                                    üö™ Anta e Pannello
                                </h5>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Modello Anta</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'modelloAnta', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona...</option>
                                            <option value="D101" ${ptc.modelloAnta === 'D101' ? 'selected' : ''}>D101 - Base</option>
                                            <option value="D102" ${ptc.modelloAnta === 'D102' ? 'selected' : ''}>D102 - Con vetro</option>
                                            <option value="D201" ${ptc.modelloAnta === 'D201' ? 'selected' : ''}>D201 - Premium</option>
                                            <option value="D202" ${ptc.modelloAnta === 'D202' ? 'selected' : ''}>D202 - Premium vetro</option>
                                            <option value="D301" ${ptc.modelloAnta === 'D301' ? 'selected' : ''}>D301 - Design</option>
                                            <option value="D401" ${ptc.modelloAnta === 'D401' ? 'selected' : ''}>D401 - Top</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Pannello</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'pannello', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona...</option>
                                            <option value="liscio" ${ptc.pannello === 'liscio' ? 'selected' : ''}>Liscio</option>
                                            <option value="bugna" ${ptc.pannello === 'bugna' ? 'selected' : ''}>Bugna</option>
                                            <option value="design" ${ptc.pannello === 'design' ? 'selected' : ''}>Design</option>
                                            <option value="personalizzato" ${ptc.pannello === 'personalizzato' ? 'selected' : ''}>Personalizzato</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- üé® MATERIALI E COLORI -->
                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                    üé® Materiali e Colori
                                </h5>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <!-- INTERNO -->
                                    <div class="bg-yellow-100 p-3 rounded-lg">
                                        <h6 class="font-semibold text-yellow-900 mb-2 text-sm">Interno</h6>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs font-medium">Materiale</label>
                                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'materialeInt', this.value)"
                                                        class="w-full compact-input border rounded mt-1 text-sm">
                                                    <option value="">Sel...</option>
                                                    <option value="pvc" ${ptc.materialeInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                                    <option value="alluminio" ${ptc.materialeInt === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                                    <option value="legno" ${ptc.materialeInt === 'legno' ? 'selected' : ''}>Legno</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-xs font-medium">Colore</label>
                                                <input type="text" 
                                                       value="${ptc.coloreInt || ''}"
                                                       placeholder="RAL..."
                                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'coloreInt', this.value)"
                                                       class="w-full compact-input border rounded mt-1 text-sm">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- ESTERNO -->
                                    <div class="bg-yellow-100 p-3 rounded-lg">
                                        <h6 class="font-semibold text-yellow-900 mb-2 text-sm">Esterno</h6>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs font-medium">Materiale</label>
                                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'materialeEst', this.value)"
                                                        class="w-full compact-input border rounded mt-1 text-sm">
                                                    <option value="">Sel...</option>
                                                    <option value="pvc" ${ptc.materialeEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                                    <option value="alluminio" ${ptc.materialeEst === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                                    <option value="legno" ${ptc.materialeEst === 'legno' ? 'selected' : ''}>Legno</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-xs font-medium">Colore</label>
                                                <input type="text" 
                                                       value="${ptc.coloreEst || ''}"
                                                       placeholder="RAL..."
                                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'coloreEst', this.value)"
                                                       class="w-full compact-input border rounded mt-1 text-sm">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ü™ü VETRO -->
                            <div class="bg-cyan-50 border-2 border-cyan-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-cyan-800 mb-3 flex items-center gap-2">
                                    ü™ü Vetro
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Tipo Vetro</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'tipoVetro', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Nessuno</option>
                                            <option value="chiaro" ${ptc.tipoVetro === 'chiaro' ? 'selected' : ''}>Chiaro</option>
                                            <option value="satinato" ${ptc.tipoVetro === 'satinato' ? 'selected' : ''}>Satinato</option>
                                            <option value="ornamentale" ${ptc.tipoVetro === 'ornamentale' ? 'selected' : ''}>Ornamentale</option>
                                            <option value="sicurezza" ${ptc.tipoVetro === 'sicurezza' ? 'selected' : ''}>Sicurezza</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Vetro Ornamentale</label>
                                        <input type="text" 
                                               value="${ptc.vetroOrnamentale || ''}"
                                               placeholder="Delta, Chinchill√†..."
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'vetroOrnamentale', this.value)"
                                               class="w-full compact-input border rounded mt-1"
                                               ${ptc.tipoVetro !== 'ornamentale' ? 'disabled' : ''}>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Fermavetro</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'fermavetro', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Sel...</option>
                                            <option value="interno" ${ptc.fermavetro === 'interno' ? 'selected' : ''}>Interno</option>
                                            <option value="esterno" ${ptc.fermavetro === 'esterno' ? 'selected' : ''}>Esterno</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- üî© FERRAMENTA -->
                            <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                    üî© Ferramenta
                                </h5>
                                <div class="grid md:grid-cols-4 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Codice Ferramenta</label>
                                        <input type="text" 
                                               value="${ptc.codiceFerramenta || ''}"
                                               placeholder="FD-3000"
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'codiceFerramenta', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Cerniere</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'cerniere', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Sel...</option>
                                            <option value="standard" ${ptc.cerniere === 'standard' ? 'selected' : ''}>Standard</option>
                                            <option value="3d" ${ptc.cerniere === '3d' ? 'selected' : ''}>3D Regolabili</option>
                                            <option value="nascoste" ${ptc.cerniere === 'nascoste' ? 'selected' : ''}>Nascoste</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Cilindro</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'cilindro', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Sel...</option>
                                            <option value="standard" ${ptc.cilindro === 'standard' ? 'selected' : ''}>Standard</option>
                                            <option value="europeo" ${ptc.cilindro === 'europeo' ? 'selected' : ''}>Europeo</option>
                                            <option value="alta-sicurezza" ${ptc.cilindro === 'alta-sicurezza' ? 'selected' : ''}>Alta Sicurezza</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Qt√† Chiavi</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'quantitaChiavi', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="3" ${ptc.quantitaChiavi == '3' ? 'selected' : ''}>3</option>
                                            <option value="4" ${ptc.quantitaChiavi == '4' ? 'selected' : ''}>4</option>
                                            <option value="5" ${ptc.quantitaChiavi == '5' ? 'selected' : ''}>5</option>
                                            <option value="6" ${ptc.quantitaChiavi == '6' ? 'selected' : ''}>6</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- üñêÔ∏è MANIGLIE -->
                            <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                                    üñêÔ∏è Maniglie
                                </h5>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Maniglia Interna</label>
                                        <input type="text" 
                                               value="${ptc.manigliaInt || ''}"
                                               placeholder="7040 - Maniglione"
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'manigliaInt', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Maniglia Esterna</label>
                                        <input type="text" 
                                               value="${ptc.manigliaEst || ''}"
                                               placeholder="Pomolo fisso"
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'manigliaEst', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‚ö° ACCESSORI -->
                            <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-orange-800 mb-3 flex items-center gap-2">
                                    ‚ö° Accessori
                                </h5>
                                <div class="grid md:grid-cols-4 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Motor Apertura</label>
                                        <label class="flex items-center gap-2 mt-1">
                                            <input type="checkbox" 
                                                   ${ptc.motorApertura ? 'checked' : ''}
                                                   onchange="updatePortoncino('${project.id}', '${pos.id}', 'motorApertura', this.checked)"
                                                   class="w-4 h-4 rounded">
                                            <span class="text-sm">Motorizzata</span>
                                        </label>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Telecomando</label>
                                        <input type="text" 
                                               value="${ptc.telecomando || ''}"
                                               placeholder="2 telecomandi"
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'telecomando', this.value)"
                                               class="w-full compact-input border rounded mt-1"
                                               ${!ptc.motorApertura ? 'disabled' : ''}>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Lettore Impronte</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'lettoreImpronte', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Nessuno</option>
                                            <option value="base" ${ptc.lettoreImpronte === 'base' ? 'selected' : ''}>Base</option>
                                            <option value="smart" ${ptc.lettoreImpronte === 'smart' ? 'selected' : ''}>Smart (App)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Chiudiporta</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'chiudiporta', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Nessuno</option>
                                            <option value="standard" ${ptc.chiudiporta === 'standard' ? 'selected' : ''}>Standard</option>
                                            <option value="incasso" ${ptc.chiudiporta === 'incasso' ? 'selected' : ''}>Ad incasso</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- üìù NOTE -->
                            <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                                <h5 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                    üìù Note
                                </h5>
                                <textarea 
                                    onchange="updatePortoncino('${project.id}', '${pos.id}', 'note', this.value)"
                                    placeholder="Note aggiuntive..."
                                    class="w-full px-3 py-2 border rounded-lg h-20 text-sm">${ptc.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        // üö™ FUNZIONI HELPER PORTONCINI (v5.07)
        window.addPortoncino = function(projectId, positionId) {
            const project = state.projects.find(p => p.id === projectId);
            const position = project.positions.find(p => p.id === positionId);
            
            // Eredita dalla config globale se esiste
            const cfg = project.configPortoncini || {};
            
            position.portoncino = {
                attivo: true,
                azienda: cfg.azienda || 'Finstral',
                // Dimensioni
                BRM_L: '',
                BRM_H: '',
                // Telaio
                tipoTelaio: cfg.tipoTelaio || '',
                soglia: cfg.soglia || '',
                montante: cfg.montante || '',
                traversa: cfg.traversa || '',
                // Anta
                modelloAnta: cfg.modelloAnta || '',
                pannello: cfg.pannello || '',
                materialeInt: cfg.materialeInt || '',
                materialeEst: cfg.materialeEst || '',
                coloreInt: cfg.coloreInt || '',
                coloreEst: cfg.coloreEst || '',
                // Vetro
                tipoVetro: cfg.tipoVetro || '',
                vetroOrnamentale: cfg.vetroOrnamentale || '',
                fermavetro: cfg.fermavetro || '',
                // Ferramenta
                codiceFerramenta: cfg.codiceFerramenta || '',
                cerniere: cfg.cerniere || '',
                cilindro: cfg.cilindro || '',
                quantitaChiavi: cfg.quantitaChiavi || 3,
                // Maniglie
                manigliaInt: cfg.manigliaInt || '',
                manigliaEst: cfg.manigliaEst || '',
                // Accessori
                motorApertura: cfg.motorApertura || false,
                telecomando: cfg.telecomando || '',
                lettoreImpronte: cfg.lettoreImpronte || '',
                chiudiporta: cfg.chiudiporta || '',
                // Note
                note: ''
            };
            
            console.log('üö™ Portoncino aggiunto con config globale:', position.portoncino);
            saveState();
            render();
        };
        
        window.updatePortoncino = function(projectId, positionId, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            const position = project.positions.find(p => p.id === positionId);
            
            if (!position.portoncino) return;
            
            position.portoncino[field] = value;
            console.log(`üö™ portoncino.${field} = ${value}`);
            
            saveState();
            render();
        };

        
        // Calcola luce Oikos da dimensioni
        function calcolaLuceOikos(L, H) {
            if (L <= 0 || H <= 0) return '';
            if (L <= 900 && H <= 2100) return 'luce0';
            if (L <= 940 && H <= 2210) return 'luce1';
            if (L <= 1030 && H <= 2400) return 'luce2';
            if (L <= 1350 && H <= 2210) return 'luce3';
            if (L <= 1600 && H <= 2400) return 'luce4';
            if (L <= 1800 && H <= 2210) return 'luce5';
            if (L <= 2000 && H <= 2400) return 'luce6';
            return 'fuoriMisura';
        }
        
        // Calcola prezzo stimato blindata
        function calcolaPrezzoBlindataStimato(bld) {
            let totale = 0;
            const luce = bld.luceCalcolata || 'luce0';
            
            // Prezzi base per versione e luce
            const prezziBase = {
                'E3': { 'luce0': 1156, 'luce1': 1206, 'luce2': 1441 },
                'E4': { 'luce0': 1436, 'luce1': 1486, 'luce2': 1721 },
                'E3D': { 'luce3': 2217, 'luce4': 2532 },
                'E3EI30': { 'luce0': 1731 },
                'E3EI45': { 'luce0': 1731 },
                'E3EI60': { 'luce0': 1891 },
                'E3TT086': { 'luce0': 2254, 'luce1': 2442, 'luce2': 2766 },
                'E3TT1': { 'luce0': 1958, 'luce1': 2131, 'luce2': 2386 },
                'P3': { 'luce0': 1173, 'luce1': 1293, 'luce2': 1480 }
            };
            
            // Prezzo base anta
            totale += prezziBase[bld.versione]?.[luce] || 0;
            
            // Controtelaio
            if (bld.controtelaio === 'si' || bld.controtelaio === true) {
                const controtelai = {
                    'luce0': 177, 'luce1': 202, 'luce2': 240,
                    'luce3': 318, 'luce4': 350
                };
                totale += controtelai[luce] || 0;
            }
            
            // Cilindro
            const cilindri = { 'BASIC': 123, 'SEKUR': 238 };
            totale += cilindri[bld.cilindro] || 0;
            
            // Colore telaio
            const colori = {
                'RAL8022': 0,
                'OIKOS_Polveri': 246,
                'OIKOS_Evergreen': 320,
                'OIKOS_Future': 384,
                'OIKOS_Liquido': 492
            };
            totale += colori[bld.coloreTelaio] || 0;
            
            // Acustica maggiorata
            if (bld.acustica === 'maggiorata') {
                totale += 120;
            }
            
            // Termica
            if (bld.termica && bld.termica !== 'serie') {
                const termiche = {
                    'singola': {
                        '1.2': { 'luce0': 272, 'luce1': 308, 'luce2': 354 },
                        '1.0': { 'luce0': 496, 'luce1': 544, 'luce2': 624 }
                    }
                };
                totale += termiche['singola'][bld.termica]?.[luce] || 0;
            }
            
            // üîê v5.01: Kit Aria-Acqua-Vento (MOSE/DAM 4-5A-C5)
            if (bld.kitAAV) {
                const kitAAV = {
                    'MOSE': { 'luce0': 405, 'luce1': 464, 'luce2': 499, 'luce3': 499, 'luce4': 499, 'luce5': 499, 'luce6': 499 },
                    'DAM': { 'luce0': 459, 'luce1': 489, 'luce2': 514, 'luce3': 514, 'luce4': 514, 'luce5': 514, 'luce6': 514 }
                };
                totale += kitAAV[bld.kitAAV]?.[luce] || 0;
            }
            
            // üîê v5.02: Rivestimento INTERNO
            if (bld.rivestimentoInt?.linea && bld.rivestimentoInt?.modello) {
                totale += calcolaPrezzoRivestimento(bld.rivestimentoInt.linea, bld.rivestimentoInt.modello, luce);
            }
            
            // üîê v5.02: Rivestimento ESTERNO
            if (bld.rivestimentoEst?.linea && bld.rivestimentoEst?.modello) {
                totale += calcolaPrezzoRivestimento(bld.rivestimentoEst.linea, bld.rivestimentoEst.modello, luce);
                // Verniciatura esterni (+30% circa, semplificato a ‚Ç¨150)
                if (bld.rivestimentoEst.verniciatura) {
                    totale += 150;
                }
            }
            
            // üîê v5.03: VETRO
            if (bld.vetro?.attivo && bld.vetro?.tipo) {
                const tipoVetro = bld.vetro.termico ? OIKOS_OPTIONAL.vetroTermico : OIKOS_OPTIONAL.vetroBlindato;
                const finitura = bld.vetro.finitura || 'trasparente';
                totale += tipoVetro[bld.vetro.tipo]?.[finitura] || 0;
            }
            
            // üîê v5.03: SOPRALUCE
            if (bld.sopraluce?.attivo && bld.sopraluce?.altezza) {
                totale += OIKOS_OPTIONAL.sopraluce[bld.sopraluce.altezza]?.[luce] || 0;
                // Controtelaio sopraluce (se H > 2400)
                totale += OIKOS_OPTIONAL.sopraluce.controtelaio[luce] || 0;
                // Sabbiato
                if (bld.sopraluce.sabbiato) {
                    const sabKey = 'sabbiato_' + bld.sopraluce.altezza;
                    totale += OIKOS_OPTIONAL.sopraluce[sabKey]?.[luce] || 0;
                }
            }
            
            // üîê v5.03: FIANCOLUCE
            if (bld.fiancoluce?.attivo) {
                const luceFL = luce === 'luce0' ? 'luce1' : luce; // Fiancoluce parte da luce1
                if (bld.fiancoluce.conVetro) {
                    totale += OIKOS_OPTIONAL.fiancoluce.conVetro[luceFL] || 0;
                } else {
                    totale += OIKOS_OPTIONAL.fiancoluce.senzaVetro[luceFL] || 0;
                }
                if (bld.fiancoluce.sabbiato) {
                    totale += OIKOS_OPTIONAL.fiancoluce.sabbiato[luceFL] || 0;
                }
                // Colore fiancoluce
                if (bld.fiancoluce.colore && bld.fiancoluce.colore !== 'RAL8022') {
                    totale += OIKOS_OPTIONAL.fiancoluce.colori[bld.fiancoluce.colore]?.[luceFL] || 0;
                }
            }
            
            return totale;
        }

        function renderFotoTab(project, pos) {
            return `
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-700 mb-3">üì∏ Foto Posizione</h4>
                    
                    <div class="mb-3">
                        <input type="file" 
                               id="foto-input-${pos.id}" 
                               accept="image/*" 
                               onchange="addFoto('${project.id}', '${pos.id}', this)"
                               class="hidden">
                        <button onclick="document.getElementById('foto-input-${pos.id}').click()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                            üì∑ Carica Foto
                        </button>
                        <p class="text-xs text-gray-600 mt-2">Click per selezionare un'immagine dal dispositivo</p>
                    </div>
                    
                    ${pos.foto && pos.foto.length > 0 ? `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            ${pos.foto.map((foto, idx) => `
                                <div class="relative group">
                                    <img src="${foto.data}" 
                                         onclick="showFotoModal('${foto.data}')"
                                         class="w-full h-32 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-blue-500 transition-all">
                                    <button onclick="removeFoto('${project.id}', '${pos.id}', ${idx})"
                                            class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        ‚úï
                                    </button>
                                    <p class="text-xs text-center mt-1 text-gray-600">Foto ${idx + 1}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-sm text-gray-500 italic">Nessuna foto caricata</p>'}
                </div>
            `;
        }

        function NewProjectModal() {
            return `
                <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                        <h3 class="text-xl font-bold mb-4">Nuovo Progetto</h3>
                        <div class="mb-3">
                            <input type="text" id="projectClient" placeholder="Cliente" 
                                   required
                                   class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none">
                            <p class="text-xs text-gray-500 mt-1">* Obbligatorio - Identifica il progetto</p>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="projectName" placeholder="Nome progetto (opzionale)" 
                                   class="w-full px-3 py-2 border rounded-lg focus:border-blue-400 focus:outline-none">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="hideModal()" 
                                    class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button onclick="createNewProject()" 
                                    class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Crea
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function FotoModal() {
            return `
                <div id="foto-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50" onclick="hideFotoModal()">
                    <div class="relative max-w-4xl max-h-screen p-4">
                        <button onclick="hideFotoModal()" class="absolute top-2 right-2 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center font-bold hover:bg-gray-200">
                            ‚úï
                        </button>
                        <img id="foto-modal-img" src="" class="max-w-full max-h-screen object-contain rounded-lg">
                    </div>
                </div>
            `;
        }

        // Window Functions
        window.showNewProjectModal = () => document.getElementById('modal').classList.remove('hidden');
        window.hideModal = () => document.getElementById('modal').classList.add('hidden');

        window.createNewProject = () => {
            const name = document.getElementById('projectName').value.trim();
            const client = document.getElementById('projectClient').value.trim();
            
            // Cliente obbligatorio, Nome progetto opzionale
            if (!client) {
                alert('Il campo Cliente √® obbligatorio!');
                return;
            }
            
            // Se nome progetto non √® inserito, usa il nome del cliente
            const projectName = name || client;
            
            createProject(projectName, client);
            hideModal();
            state.screen = 'project';
            // üÜï v4.20: Chiudi tutti i menu quando crei nuovo progetto
            state.projectMenuOpen = false;
            state.mainMenuOpen = false;
            render();
        };

        window.goBack = () => {
            if (state.screen === 'position') {
                state.screen = 'project';
            } else {
                state.screen = 'list';
            }
            // üÜï v4.20: Chiudi tutti i menu durante navigazione
            state.projectMenuOpen = false;
            state.mainMenuOpen = false;
            render();
        };

        window.openProject = (id) => {
            state.currentProject = id;
            state.screen = 'project';
            // üÜï v4.20: Chiudi tutti i menu quando apri progetto
            state.projectMenuOpen = false;
            state.mainMenuOpen = false;
            render();
        };

        // ============================================
        // üîß FIX 027H: getCurrentProject helper
        // ============================================
        // Aggiunto per compatibilit√† con menu dinamico
        function getCurrentProject() {
            if (state.currentProject) {
                return state.projects.find(p => p.id === state.currentProject);
            }
            return null;
        }
        
        window.openPosition = (id) => {
            state.currentPosition = id;
            state.screen = 'position';
            state.showRiepilogoRilievi = false;  // Reset flag riepilogo
            // üÜï v4.20: Chiudi tutti i menu quando apri posizione
            state.projectMenuOpen = false;
            state.mainMenuOpen = false;
            render();
        };

        // üÜï FASE 014 - Controllo completamento prima cambio posizione
        window.switchPosition = (id) => {
            const project = state.projects.find(p => p.positions && p.positions.some(pos => pos.id === state.currentPosition));
            const currentPos = project?.positions?.find(p => p.id === state.currentPosition);
            
            // Se c'√® una posizione corrente, controlla completamento
            if (currentPos && currentPos.id !== id) {
                const comp = calculatePositionCompleteness(currentPos);
                
                // Se non √® completa al 100%, mostra warning
                if (comp.percentage < 100) {
                    const missingText = comp.missing.length > 0 
                        ? `\n\nMancanti:\n‚Ä¢ ${comp.missing.join('\n‚Ä¢ ')}` 
                        : '';
                    
                    const proceed = confirm(
                        `‚ö†Ô∏è ATTENZIONE: La posizione "${currentPos.name}" non √® completa al 100%!\n` +
                        `Completamento attuale: ${comp.percentage}%${missingText}\n\n` +
                        `Vuoi comunque cambiare posizione?`
                    );
                    
                    if (!proceed) {
                        // Utente ha annullato, rimane sulla posizione corrente
                        render(); // Ri-renderizza per resettare il dropdown
                        return;
                    }
                }
            }
            
            // Cambio posizione
            state.currentPosition = id;
            render();
        };

        window.printChecklistRilievi = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Genera HTML per stampa
            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Checklist Rilievi - ${project.nome || 'Progetto'}</title>
                    <style>
                        @media print {
                            @page { margin: 1cm; }
                            body { margin: 0; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 1200px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #6B46C1;
                            border-bottom: 3px solid #6B46C1;
                            padding-bottom: 10px;
                        }
                        h2 {
                            color: #4A5568;
                            margin-top: 30px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            page-break-inside: avoid;
                        }
                        th {
                            background: #6B46C1;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-size: 14px;
                        }
                        td {
                            padding: 10px;
                            border: 1px solid #E2E8F0;
                        }
                        tr:nth-child(even) {
                            background: #F7FAFC;
                        }
                        .header-info {
                            background: #EDF2F7;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .check-box {
                            display: inline-block;
                            width: 18px;
                            height: 18px;
                            border: 2px solid #4A5568;
                            margin: 0 5px;
                            vertical-align: middle;
                        }
                        .check-filled {
                            background: #48BB78;
                            border-color: #48BB78;
                        }
                        .missing {
                            color: #E53E3E;
                            font-weight: bold;
                        }
                        .status {
                            display: inline-block;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        .status-complete { background: #C6F6D5; color: #22543D; }
                        .status-partial { background: #FEEBC8; color: #744210; }
                        .status-empty { background: #FED7D7; color: #742A2A; }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 10px 20px;
                            background: #6B46C1;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                        }
                        @media print {
                            .print-btn { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Stampa</button>
                    
                    <h1>üìã CHECKLIST RILIEVI - SOPRALLUOGO</h1>
                    
                    <div class="header-info">
                        <h3>Informazioni Progetto</h3>
                        <p><strong>Progetto:</strong> ${project.nome || 'N/A'}</p>
                        <p><strong>Cliente:</strong> ${project.clientData?.nome || 'N/A'}</p>
                        <p><strong>Indirizzo:</strong> ${project.clientData?.indirizzo || 'N/A'}</p>
                        <p><strong>Piano:</strong> ${project.clientData?.piano || 'N/A'}</p>
                        <p><strong>Data stampa:</strong> ${new Date().toLocaleDateString('it-IT')}</p>
                    </div>
                    
                    <h2>üìç Posizioni da Rilevare (${project.positions.length})</h2>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 15%">Posizione</th>
                                <th style="width: 12%">Piano/Amb.</th>
                                <th style="width: 15%">Preesistente</th>
                                <th style="width: 14%">Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${project.positions.map(pos => {
                                const r = pos.rilievo || {};
                                const completeness = calculateRilievoCompleteness(pos);
                                const statusClass = completeness.percentage === 100 ? 'status-complete' : 
                                                   completeness.percentage > 0 ? 'status-partial' : 'status-empty';
                                const statusText = completeness.percentage === 100 ? 'COMPLETO' : 
                                                  completeness.percentage > 0 ? 'PARZIALE' : 'DA FARE';
                                
                                return `
                                    <tr>
                                        <td>
                                            <strong>${pos.name}</strong><br>
                                            <span class="status ${statusClass}">${statusText}</span>
                                        </td>
                                        <td>${pos.piano || '-'}<br>${pos.ambiente || '-'}</td>
                                        <td class="${!r.preesistente || r.preesistente.trim() === '' ? 'missing' : ''}">
                                            ${r.preesistente || '‚ùå DA COMPILARE'}
                                        </td>
                                        <td style="font-size: 12px;">${r.note || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 40px; border-top: 2px solid #E2E8F0; padding-top: 20px;">
                        <h3>‚úÖ Istruzioni per il Sopralluogo</h3>
                        <ol style="line-height: 1.8;">
                            <li>Verifica per ogni posizione cosa √® presente (infisso, persiana, tapparella, etc.)</li>
                            <li>Aggiungi note aggiuntive se necessario</li>
                        </ol>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; color: #A0AEC0; font-size: 12px;">
                        <p>Generato da Open Porte - Sistema di Rilievo Misure</p>
                    </div>
                </body>
                </html>
            `;
            
            // Apri in nuova finestra e stampa
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHTML);
            printWindow.document.close();
        };

        window.setPositionTab = (posId, tab) => {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.activeTab = tab;
                    render();
                }
            }
        };

        // Update Functions
        window.updateProject = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                project[field] = value;
                saveState();
            }
        };

        // üÜï v4.76: Debounce per auto-save dati cantiere (500ms)
        let clientDataSaveTimer = null;
        function saveStateDebounced(delay = 500) {
            clearTimeout(clientDataSaveTimer);
            clientDataSaveTimer = setTimeout(() => {
                saveState();
                console.log('üíæ Auto-save dati cantiere (debounce 500ms)');
            }, delay);
        }
        
        window.updateClientData = (projectId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.clientData) project.clientData = {};
                project.clientData[field] = value;
                
                if (field === 'piano') {
                    project.positions.forEach(pos => {
                        if (!pos.piano) pos.piano = value;
                    });
                }
                // üÜï v4.76: Auto-save con debounce 500ms
                saveStateDebounced();
            }
        };

        window.updateProdotti = (projectId, product, checked) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.prodotti) project.prodotti = {};
                
                // Mappa prodotto -> step number
                const productStepMap = {
                    'infissi': 3,
                    'persiane': 4,
                    'tapparelle': 5,
                    'zanzariere': 6,
                    'cassonetti': 7
                };
                
                const productStep = productStepMap[product];
                
                // üÜï v4.75: Se DISATTIVO un prodotto, pulisco tutti i dati correlati
                if (!checked) {
                    cleanProductData(project, product);
                }
                
                // Se sto deselezionando un prodotto e sono sul suo step di config
                if (!checked && state.setupStep === productStep) {
                    // Aggiorna temporaneamente il prodotto per calcolare il prossimo step valido
                    project.prodotti[product] = checked;
                    // Salta allo step successivo valido
                    state.setupStep = getNextValidStep(state.setupStep, project);
                } else {
                    project.prodotti[product] = checked;
                }
                
                saveState();
                render();
            }
        };
        
        // üÜï v4.75: Funzione per pulire dati prodotto quando disattivato
        function cleanProductData(project, product) {
            // Mappa prodotto -> chiavi JSON da pulire
            const productDataMap = {
                'infissi': { config: 'configInfissi', brm: 'brmConfigInfissi', rilievo: 'rilievoInfissi', position: 'infisso' },
                'persiane': { config: 'configPersiane', brm: 'brmConfigPersiane', rilievo: 'rilievoPersiane', position: 'persiana' },
                'tapparelle': { config: 'configTapparelle', brm: 'brmConfigTapparelle', rilievo: 'rilievoTapparelle', position: 'tapparella' },
                'zanzariere': { config: 'configZanzariere', brm: 'brmConfigZanzariere', rilievo: 'rilievoZanzariere', position: 'zanzariera' },
                'cassonetti': { config: 'configCassonetti', brm: 'brmConfigCassonetti', rilievo: 'rilievoCassonetti', position: 'cassonetto' }
            };
            
            const keys = productDataMap[product];
            if (!keys) return;
            
            // Pulisci config globale (svuota oggetto ma mantieni struttura)
            if (project[keys.config]) {
                Object.keys(project[keys.config]).forEach(k => {
                    project[keys.config][k] = '';
                });
            }
            
            // Pulisci BRM config
            if (project[keys.brm]) {
                Object.keys(project[keys.brm]).forEach(k => {
                    if (k === 'operazioneL' || k === 'operazioneH' || k === 'operazioneC' || k === 'operazioneB') {
                        project[keys.brm][k] = '-';
                    } else if (k === 'valoreL' || k === 'valoreH' || k === 'valoreC' || k === 'valoreB' || 
                               k === 'SRSX' || k === 'SRDX' || k === 'ZSX' || k === 'ZDX') {
                        project[keys.brm][k] = '0';
                    } else {
                        project[keys.brm][k] = '';
                    }
                });
            }
            
            // Pulisci rilievo
            if (project[keys.rilievo]) {
                Object.keys(project[keys.rilievo]).forEach(k => {
                    if (typeof project[keys.rilievo][k] === 'boolean') {
                        project[keys.rilievo][k] = false;
                    } else {
                        project[keys.rilievo][k] = '';
                    }
                });
            }
            
            // üîë IMPORTANTE: Pulisci tutte le posizioni
            if (project.positions && project.positions.length > 0) {
                project.positions.forEach(pos => {
                    pos[keys.position] = null;
                });
            }
            
            console.log(`üßπ v4.75: Puliti dati ${product} (config + ${project.positions?.length || 0} posizioni)`);
        }

        window.updateConfigPersiane = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configPersiane[field];
                
                project.configPersiane[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'persiana', field, value, oldValue);
                
                saveState();
                
                // üîß v4.44: Se il campo √® 'fissaggio', mostra/nascondi campi telaio
                if (field === 'fissaggio') {
                    const tipoTelaioContainer = document.getElementById(`tipo-telaio-persiane-container-${projectId}`);
                    const coloreTelaioContainer = document.getElementById(`colore-telaio-persiane-container-${projectId}`);
                    
                    if (tipoTelaioContainer) {
                        tipoTelaioContainer.style.display = value === 'telaio' ? 'block' : 'none';
                    }
                    if (coloreTelaioContainer) {
                        coloreTelaioContainer.style.display = value === 'telaio' ? 'block' : 'none';
                    }
                }
            }
        };

        // Nuova funzione per gestire i campi condizionali delle persiane
        window.updateConfigPersianeConditional = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configPersiane[field];
                
                project.configPersiane[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'persiana', field, value, oldValue);
                
                saveState();
                
                // Gestione visibilit√† campi condizionali
                if (field === 'modello') {
                    const modelloAltro = document.getElementById(`modello-altro-${projectId}`);
                    if (modelloAltro) {
                        modelloAltro.style.display = value === 'altro' ? 'block' : 'none';
                    }
                } else if (field === 'tipoTelaio') {
                    const tipoTelaioAltro = document.getElementById(`tipo-telaio-altro-${projectId}`);
                    if (tipoTelaioAltro) {
                        tipoTelaioAltro.style.display = value === 'altro' ? 'block' : 'none';
                    }
                }
            }
        };

        // Nuova funzione per gestire il fissaggio e i campi telaio
        window.updateFissaggioPersiane = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configPersiane.fissaggio;
                
                project.configPersiane.fissaggio = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'persiana', 'fissaggio', value, oldValue);
                
                saveState();
                
                const tipoTelaioContainer = document.getElementById(`tipo-telaio-persiane-container-${projectId}`);
                const coloreTelaioContainer = document.getElementById(`colore-telaio-persiane-container-${projectId}`);
                
                if (tipoTelaioContainer) {
                    tipoTelaioContainer.style.display = value === 'telaio' ? 'block' : 'none';
                }
                if (coloreTelaioContainer) {
                    coloreTelaioContainer.style.display = value === 'telaio' ? 'block' : 'none';
                }
            }
        };

        window.updateConfigTapparelle = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configTapparelle) project.configTapparelle = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configTapparelle[field];
                
                project.configTapparelle[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'tapparella', field, value, oldValue);
                
                saveState();
            }
        };

        window.updateConfigZanzariere = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configZanzariere) project.configZanzariere = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configZanzariere[field];
                
                project.configZanzariere[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'zanzariera', field, value, oldValue);
                
                saveState();
            }
        };

        window.updateConfigCassonetti = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configCassonetti) project.configCassonetti = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configCassonetti[field];
                
                project.configCassonetti[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'cassonetto', field, value, oldValue);
                
                saveState();
            }
        };

        // üÜï FUNZIONE AUTO-SYNC: Sincronizza config globale ‚Üí posizioni
        // Aggiorna automaticamente SOLO i campi che non sono stati modificati manualmente
        function syncConfigToPositions(project, productType, field, newValue, oldValue) {
            if (!project || !project.positions) return 0;
            
            let contatore = 0;
            console.log(`üîÑ syncConfigToPositions: ${productType}.${field}`);
            console.log(`   newValue:`, newValue);
            console.log(`   oldValue:`, oldValue);
            
            // Per ogni posizione del progetto
            project.positions.forEach(pos => {
                const product = pos[productType];
                
                // Se la posizione ha questo prodotto
                if (product) {
                    const currentValue = product[field];
                    
                    // üéØ LOGICA AUTO-SYNC:
                    // Aggiorna se:
                    // 1. Il campo √® vuoto/undefined/null (mai impostato)
                    // 2. Il campo √® un array vuoto [] (mai popolato)
                    // 3. Il campo ha lo stesso valore della vecchia config (non modificato manualmente)
                    const shouldSync = (
                        currentValue === undefined || 
                        currentValue === '' || 
                        currentValue === null ||
                        (Array.isArray(currentValue) && currentValue.length === 0) || // Array vuoto = mai impostato
                        currentValue === oldValue ||
                        (Array.isArray(currentValue) && Array.isArray(oldValue) && 
                         JSON.stringify(currentValue) === JSON.stringify(oldValue))
                    );
                    
                    console.log(`   Posizione ${pos.id}: currentValue=`, currentValue, ` shouldSync=${shouldSync}`);
                    
                    if (shouldSync) {
                        // Aggiorna con il nuovo valore globale
                        if (Array.isArray(newValue)) {
                            // Per array (es. codTagli), crea una copia
                            product[field] = [...newValue];
                        } else {
                            product[field] = newValue;
                        }
                        console.log(`   ‚úÖ SINCRONIZZATO: ${field} =`, newValue);
                        contatore++;
                    } else {
                        console.log(`   ‚è≠Ô∏è SKIP (modificato manualmente)`);
                    }
                    // ALTRIMENTI: L'utente ha modificato manualmente ‚Üí NON aggiornare
                }
            });
            
            console.log(`   üìä Totale sincronizzati: ${contatore}`);
            return contatore;
        }

        // Verifica sincronizzazione automatica
        function verificaSincronizzazioneNecessaria(project) {
            if (!project || !project.configInfissi) return false;
            
            // Verifica se la config ha valori
            const configHaValori = (
                project.configInfissi.azienda ||
                project.configInfissi.telaio ||
                project.configInfissi.coloreInt ||
                // üÜï v4.85: Usa tagliTelaio invece di codTagli (rimosso)
                project.configInfissi.tagliTelaio
            );
            
            if (!configHaValori) return false;
            
            // Conta campi vuoti nelle posizioni
            let campiVuoti = 0;
            project.positions.forEach(pos => {
                if (pos.infisso) {
                    ['azienda', 'telaio', 'coloreInt'].forEach(field => {
                        const posValue = pos.infisso[field];
                        const configValue = project.configInfissi[field];
                        
                        const posIsEmpty = !posValue || posValue === '';
                        const configHasValue = configValue && configValue !== '';
                        
                        if (posIsEmpty && configHasValue) {
                            campiVuoti++;
                        }
                    });
                    
                    // üÜï v4.85: Check tagliTelaio invece di codTagli (rimosso)
                    const tagliEmpty = !pos.infisso.tagliTelaio || pos.infisso.tagliTelaio === '';
                    const tagliHasValue = project.configInfissi.tagliTelaio && project.configInfissi.tagliTelaio !== '';
                    if (tagliEmpty && tagliHasValue) {
                        campiVuoti++;
                    }
                }
            });
            
            if (campiVuoti > 0) {
                console.warn(`‚ö†Ô∏è ATTENZIONE: ${campiVuoti} campi nelle posizioni sono vuoti ma la Config Globale ha valori!`);
                console.log('üí° SUGGERIMENTO: Usa il pulsante SINCRONIZZA TUTTO nella Config Globale.');
                return true;
            }
            
            return false;
        }

        // ‚úÖ NUOVO: Funzione per ricalcolare tutti i BRM globali quando cambia la configurazione
        function ricalcolaTuttiiBRMGlobali(project, configKey) {
            // Mappa tra configKey e productType
            const configToProductMap = {
                'brmConfigInfissi': 'infisso',
                'brmConfigPersiane': 'persiana',
                'brmConfigTapparelle': 'tapparella',
                'brmConfigZanzariere': 'zanzariera',
                'brmConfigCassonetti': 'cassonetto'
            };
            
            const productType = configToProductMap[configKey];
            if (!productType) return;
            
            // Ricalcola BRM per ogni posizione che ha questo prodotto
            project.positions.forEach(pos => {
                const product = pos[productType];
                
                // Ricalcola SOLO se il prodotto esiste E NON ha personalizzazione
                if (product && !product.brmPersonalizzato) {
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Usa le misure corrette in base al tipo di prodotto
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    
                    // Ricalcola BRM con la config globale aggiornata
                    const brm = calculateBRM(project, pos, misure, project[configKey], tipo);
                    
                    // Aggiorna i valori BRM nel prodotto
                    product.BRM_L = brm.L;
                    product.BRM_H = brm.H;
                    
                    // Per cassonetti, gestisci anche C e B
                    if (productType === 'cassonetto') {
                        product.BRM_C = brm.C;
                        product.BRM_B = brm.B;
                    }
                }
            });
        }

        // ‚úÖ NUOVO: Funzione per ricalcolare tutti i BRM di una posizione quando cambiano le misure
        function ricalcolaBRMPerPosizione(project, pos) {
            const configMap = {
                'infisso': 'brmConfigInfissi',
                'persiana': 'brmConfigPersiane',
                'tapparella': 'brmConfigTapparelle',
                'zanzariera': 'brmConfigZanzariere',
                'cassonetto': 'brmConfigCassonetti'
            };
            
            // Ricalcola per ogni tipo di prodotto nella posizione
            ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'].forEach(productType => {
                const product = pos[productType];
                
                // Ricalcola SOLO se il prodotto esiste E NON ha personalizzazione
                if (product && !product.brmPersonalizzato) {
                    const configKey = configMap[productType];
                    
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Usa le misure corrette in base al tipo di prodotto
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    
                    // Ricalcola BRM con la config globale
                    if (project[configKey]) {
                        const brm = calculateBRM(project, pos, misure, project[configKey], tipo);
                        
                        // Aggiorna i valori BRM nel prodotto
                        product.BRM_L = brm.L;
                        product.BRM_H = brm.H;
                        
                        // Per cassonetti, gestisci anche C e B
                        if (productType === 'cassonetto') {
                            product.BRM_C = brm.C;
                            product.BRM_B = brm.B;
                        }
                    }
                }
            });
        }

        window.updateBRMConfig = (projectId, configKey, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project[configKey]) project[configKey] = {};
                
                // ‚úÖ FIX: Converti sempre i valori mm in positivi (valore assoluto)
                // Se l'utente inserisce -10, lo convertiamo in 10
                // L'operazione (+ o -) viene gestita separatamente dal campo "operazione"
                if (field.startsWith('valore') && !isNaN(value)) {
                    value = Math.abs(parseFloat(value)).toString();
                }
                
                project[configKey][field] = value;
                
                // ‚úÖ NUOVO: Ricalcola automaticamente tutti i BRM che usano questa config globale
                ricalcolaTuttiiBRMGlobali(project, configKey);
                
                saveState();
                // ‚ö° FASE 024B: NO render - approccio cloud
                // I dati sono gi√† salvati, i BRM ricalcolati
                // L'utente vedr√† i cambiamenti al prossimo cambio naturale di vista
            }
        };

        window.updateBRMPersonalizzato = (projectId, posId, productType, field, value) => {
            updateBRMPersonalizzato(projectId, posId, productType, field, value);
        };

        window.updateCaratteristicheMuro = (projectId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro[field] = value;
                
                // üîß CORREZIONE: Se modifichi "Battuta Superiore con Tapparella", 
                // aggiorna automaticamente BSuperiore nei cassonetti che usano le caratteristiche globali
                if (field === 'battutaSuperioreTapparella') {
                    let cassUpdated = 0;
                    project.positions.forEach(pos => {
                        // Aggiorna solo se la posizione usa caratteristiche globali (non ha override)
                        if (pos.cassonetto && !pos.overrideCaratteristiche) {
                            pos.cassonetto.BSuperiore = value || '0';
                            cassUpdated++;
                        }
                    });
                    
                    if (cassUpdated > 0) {
                        // ‚ö° FASE 024B: NO render - dati gi√† salvati
                        // showNotification mostrer√† il risultato senza bisogno di render
                        showNotification(`‚úÖ Aggiornati ${cassUpdated} cassonetti con nuovo BSuperiore: ${value}mm`, 'success');
                    }
                }
                
                saveState();
            }
        };

        // üóø NUOVA FUNZIONE: Aggiorna caratteristiche muro OVERRIDE per una specifica posizione
        window.updateCaratteristicheMuroOverride = (projectId, posId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.overrideCaratteristiche) {
                    if (!pos.caratteristicheMuroOverride) pos.caratteristicheMuroOverride = {};
                    pos.caratteristicheMuroOverride[field] = value;
                    
                    // üîß CORREZIONE: Se modifichi "Battuta Superiore con Tapparella" nell'override,
                    // aggiorna automaticamente BSuperiore nel cassonetto di questa posizione
                    if (field === 'battutaSuperioreTapparella' && pos.cassonetto) {
                        pos.cassonetto.BSuperiore = value || '0';
                        // ‚ö° FASE 024B: Aggiorna DOM diretto invece di render
                        const bSupEl = document.getElementById(`bsup-${posId}`);
                        if (bSupEl) bSupEl.value = value || '0';
                        showNotification(`‚úÖ Aggiornato BSuperiore cassonetto: ${value}mm`, 'success');
                    }
                    
                    saveState();
                }
            }
        };

        window.updateGuidaEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.guidaEsistente = value;
                saveState();
                
                const guidaFields = document.getElementById(`guida-fields-${projectId}`);
                if (guidaFields) {
                    guidaFields.style.display = value === 'si' ? 'block' : 'none';
                }
            }
        };
        
        // ‚úÖ NUOVO: Aggiorna dislivello default (finestre o porteFinestre)
        window.updateDislivelloDefault = (projectId, tipo, field, value) => {
            markUserTyping();
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                
                // Inizializza struttura dislivello se non esiste
                const key = tipo === 'finestre' ? 'dislivelloPianaFinestre' : 'dislivelloPianaPorteFinestre';
                if (!project.caratteristicheMuro[key]) {
                    project.caratteristicheMuro[key] = {
                        presente: false,
                        pianaAlta: null,
                        valore: 0,
                        note: ''
                    };
                }
                
                // Aggiorna campo
                if (field === 'presente') {
                    project.caratteristicheMuro[key].presente = value;
                    // Mostra/nascondi campi
                    const fieldsId = tipo === 'finestre' ? 
                        `dislivelloFinestreFields-${projectId}` : 
                        `dislivelloPFFields-${projectId}`;
                    const fieldsEl = document.getElementById(fieldsId);
                    if (fieldsEl) {
                        fieldsEl.style.display = value ? 'block' : 'none';
                    }
                    // Se disattivato, resetta valori
                    if (!value) {
                        project.caratteristicheMuro[key].pianaAlta = null;
                        project.caratteristicheMuro[key].valore = 0;
                    }
                } else if (field === 'valore') {
                    project.caratteristicheMuro[key].valore = parseInt(value) || 0;
                } else {
                    project.caratteristicheMuro[key][field] = value;
                }
                
                saveState();
            }
        };
        
        // ‚úÖ NUOVO: Aggiorna dislivello per posizione specifica
        window.updateDislivelloPosizione = (projectId, posId, field, value) => {
            markUserTyping();
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // Determina se √® finestra o porta-finestra
                    let prodotto = pos.finestra || pos.portaFinestra;
                    const tipoKey = pos.finestra ? 'finestra' : 'portaFinestra';
                    
                    // Se il prodotto non esiste ancora, crealo
                    if (!prodotto) {
                        prodotto = {};
                        pos[tipoKey] = prodotto;
                    }
                    
                    // Inizializza struttura dislivello
                    if (!prodotto.dislivelloPiana) {
                        prodotto.dislivelloPiana = {
                            presente: false,
                            pianaAlta: null,
                            valore: 0,
                            note: ''
                        };
                    }
                    
                    // Aggiorna campo
                    if (field === 'presente') {
                        prodotto.dislivelloPiana.presente = value;
                        // Mostra/nascondi campi
                        const fieldsEl = document.getElementById(`dislivelloFields-${posId}`);
                        if (fieldsEl) {
                            fieldsEl.style.display = value ? 'block' : 'none';
                        }
                        // Se disattivato, resetta valori
                        if (!value) {
                            prodotto.dislivelloPiana.pianaAlta = null;
                            prodotto.dislivelloPiana.valore = 0;
                            prodotto.dislivelloPiana.note = '';
                        }
                    } else if (field === 'valore') {
                        prodotto.dislivelloPiana.valore = parseInt(value) || 0;
                    } else {
                        prodotto.dislivelloPiana[field] = value;
                    }
                    
                    saveState();
                }
            }
        };

        // üóø NUOVA FUNZIONE: Aggiorna guida esistente OVERRIDE per posizione
        window.updateGuidaEsistenteOverride = (projectId, posId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.overrideCaratteristiche) {
                    if (!pos.caratteristicheMuroOverride) pos.caratteristicheMuroOverride = {};
                    pos.caratteristicheMuroOverride.guidaEsistente = value;
                    saveState();
                    
                    // ‚ö° FASE 024B: Manipolazione DOM diretta per mostrare/nascondere campi
                    const guidaFields = document.querySelector(`[id*="guida-fields-override-${posId}"]`);
                    if (guidaFields) {
                        guidaFields.style.display = value === 'si' ? 'block' : 'none';
                    }
                }
            }
        };

        window.updateFalsoEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.falsoEsistente = value;
                saveState();
                
                const falsoSiFields = document.getElementById(`falso-si-fields-${projectId}`);
                const falsoNoFields = document.getElementById(`falso-no-fields-${projectId}`);
                if (falsoSiFields && falsoNoFields) {
                    falsoSiFields.style.display = value === 'si' ? 'block' : 'none';
                    falsoNoFields.style.display = value === 'no' ? 'block' : 'none';
                }
            }
        };

        // üóø NUOVA FUNZIONE: Aggiorna falso esistente OVERRIDE per posizione
        window.updateFalsoEsistenteOverride = (projectId, posId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.overrideCaratteristiche) {
                    if (!pos.caratteristicheMuroOverride) pos.caratteristicheMuroOverride = {};
                    pos.caratteristicheMuroOverride.falsoEsistente = value;
                    saveState();
                    
                    // ‚ö° FASE 024B: Manipolazione DOM diretta per mostrare/nascondere campi
                    const falsoSiFields = document.querySelector(`[id*="falso-si-fields-override-${posId}"]`);
                    const falsoNoFields = document.querySelector(`[id*="falso-no-fields-override-${posId}"]`);
                    if (falsoSiFields && falsoNoFields) {
                        falsoSiFields.style.display = value === 'si' ? 'block' : 'none';
                        falsoNoFields.style.display = value === 'no' ? 'block' : 'none';
                    }
                }
            }
        };

        // üÜï FASE 15: Update Misure Globali Infissi
        window.updateMisureGlobaliInfissi = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.misureGlobaliInfissi) {
                    project.misureGlobaliInfissi = {
                        LVT: '', HVT: '', LF: '', HF: '', 
                        TMV: '', HMT: '', LVAR: '', HVAR: '',
                        DeltaINT: '', DeltaEST: '',
                        HSoffitto: '', HParapettoSoffitto: '', HPavimentoParapetto: ''
                    };
                }
                project.misureGlobaliInfissi[field] = value;
                saveState();
            }
        };

        window.updatePosition = (projectId, posId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos[field] = value;
                    
                    // ‚úÖ FIX: Rimuovi bordo rosso quando compili ambiente
                    if (field === 'ambiente' && value && value.trim() !== '') {
                        const selectEl = document.getElementById(`ambiente-select-${posId}`);
                        const inputEl = document.getElementById(`ambiente-input-${posId}`);
                        
                        if (selectEl) {
                            selectEl.classList.remove('border-red-500', 'bg-red-50');
                            selectEl.classList.add('border-gray-300');
                        }
                        if (inputEl) {
                            inputEl.classList.remove('border-red-500', 'bg-red-50');
                            inputEl.classList.add('border-gray-300');
                        }
                    }
                    
                    saveState();
                }
            }
        };

        window.updateMisura = (projectId, posId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.misure) pos.misure = {};
                    pos.misure[field] = value;
                    saveState();
                }
            }
        };

        // üÜï Gestione navigazione TAB tra campi misure
        window.handleMisureTabNavigation = (event, posId, currentIndex, totalFields) => {
            if (event.key === 'Tab') {
                event.preventDefault();
                
                const grid = document.getElementById(`misure-grid-${posId}`);
                if (!grid) return;
                
                const inputs = grid.querySelectorAll('input[type="number"]');
                
                if (event.shiftKey) {
                    // SHIFT+TAB: vai indietro
                    const prevIndex = currentIndex - 1;
                    if (prevIndex >= 0 && inputs[prevIndex]) {
                        inputs[prevIndex].focus();
                        inputs[prevIndex].select();
                    }
                } else {
                    // TAB: vai avanti
                    const nextIndex = currentIndex + 1;
                    if (nextIndex < totalFields && inputs[nextIndex]) {
                        inputs[nextIndex].focus();
                        inputs[nextIndex].select();
                    }
                }
            }
        };

        window.updateMisuraWithValidation = (projectId, posId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // üõ°Ô∏è Se l'utente modifica una misura che aveva un override, rimuovi l'override
                    // perch√© il valore √® cambiato e deve essere rivalidato
                    if (pos.validationOverrides && pos.validationOverrides[field]) {
                        delete pos.validationOverrides[field];
                        
                        // Se non ci sono pi√π override, rimuovi l'oggetto intero
                        if (Object.keys(pos.validationOverrides).length === 0) {
                            delete pos.validationOverrides;
                        }
                    }
                }
            }
            
            updateMisura(projectId, posId, field, value);
            
            // ‚úÖ NUOVO: Ricalcola automaticamente tutti i BRM di questa posizione quando cambiano le misure
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    ricalcolaBRMPerPosizione(project, pos);
                }
            }
            
            render();
        };

        window.enableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = true;
                    pos.caratteristicheMuroOverride = {...project.caratteristicheMuro};
                    saveState();
                    render();
                }
            }
        };

        window.disableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = false;
                    pos.caratteristicheMuroOverride = null;
                    
                    // üîß CORREZIONE: Quando disabiliti l'override, aggiorna BSuperiore con il valore globale
                    if (pos.cassonetto) {
                        const bSuperioreGlobale = project.caratteristicheMuro?.battutaSuperioreTapparella || '0';
                        pos.cassonetto.BSuperiore = bSuperioreGlobale;
                        showNotification(`‚úÖ Cassonetto aggiornato con valore globale BSuperiore: ${bSuperioreGlobale}mm`, 'success');
                    }
                    
                    saveState();
                    render();
                }
            }
        };

        window.deletePosition = (projectId, posId) => {
            if (confirm('Sei sicuro di voler eliminare questa posizione? Tutti i dati verranno persi.')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    project.positions = project.positions.filter(p => p.id !== posId);
                    saveState();
                    
                    if (project.positions.length > 0) {
                        state.currentPosition = project.positions[0].id;
                        state.screen = 'position';
                    } else {
                        state.screen = 'project';
                    }
                    render();
                }
            }
        };

        // Motor Functions for Tapparelle
        window.addMotoreTapparella = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparella) {
                    if (!pos.tapparella.motori) {
                        pos.tapparella.motori = [];
                    }
                    // FASE 11a: Inizializza motore con tutti i campi
                    pos.tapparella.motori.push({ 
                        marca: '',
                        modello: '',
                        alimentazione: 'Filare',
                        trasmettitore: ''
                    });
                    saveState();
                    render();
                }
            }
        };

        window.updateMotoreTapparella = (projectId, posId, tappIdx, motoreIdx, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparelle && pos.tapparelle[tappIdx] && pos.tapparelle[tappIdx].motori) {
                    pos.tapparelle[tappIdx].motori[motoreIdx].modello = value;
                    saveState();
                }
            }
        };

        // FASE 11a: Nuova funzione per aggiornare singoli campi del motore
        window.updateMotoreTapparellaField = (projectId, posId, motoreIdx, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparella && pos.tapparella.motori && pos.tapparella.motori[motoreIdx]) {
                    pos.tapparella.motori[motoreIdx][field] = value;
                    saveState();
                    // ‚ö° FASE 024: Se cambia alimentazione, ri-renderizza con debounce per mostrare/nascondere trasmettitore
                    if (field === 'alimentazione') {
                        deferredRender();
                    }
                }
            }
        };

        window.removeMotoreTapparella = (projectId, posId, motoreIdx) => {
            if (confirm('Eliminare questo motore?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.tapparella && pos.tapparella.motori) {
                        pos.tapparella.motori.splice(motoreIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };

        // Foto Functions
        window.addFoto = (projectId, posId, input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos) {
                            if (!pos.foto) pos.foto = [];
                            pos.foto.push({
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            });
                            saveState();
                            showNotification('Foto aggiunta', 'success');
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeFoto = (projectId, posId, fotoIdx) => {
            if (confirm('Sei sicuro di voler eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.foto) {
                        pos.foto.splice(fotoIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };

        window.addFotoPersiana = (projectId, posId, persianaIdx, input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                            pos.persiane[persianaIdx].foto = {
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            };
                            saveState();
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
            input.value = '';
        };

        window.removeFotoPersiana = (projectId, posId, persianaIdx) => {
            if (confirm('Sei sicuro di voler eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                        pos.persiane[persianaIdx].foto = null;
                        saveState();
                        render();
                    }
                }
            }
        };

        window.showFotoModal = (fotoData) => {
            const modal = document.getElementById('foto-modal');
            const img = document.getElementById('foto-modal-img');
            if (modal && img) {
                img.src = fotoData;
                modal.classList.remove('hidden');
            }
        };

        window.hideFotoModal = () => {
            const modal = document.getElementById('foto-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        // Export/Import Functions
        window.exportAllProjects = () => {
            try {
                const data = {
                    projects: state.projects,
                    exportDate: new Date().toISOString(),
                    version: '3.5-FASE006-JSON-COMPLETO',
                    totalProjects: state.projects.length
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `open-porte-progetti-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Export completato! ${data.totalProjects} progetti`, 'success');
                
            } catch (error) {
                console.error('Errore export:', error);
                showNotification(`Errore durante export: ${error.message}`, 'error');
            }
        };

        // üìä EXPORT EXCEL - Formato intuitivo con 3 fogli
        window.exportAllProjectsExcel = () => {
            try {
                if (!window.XLSX) {
                    showNotification('Errore: Libreria Excel non caricata', 'error');
                    return;
                }
                
                // Array per i 3 fogli
                const progetti = [];
                const posizioni = [];
                const prodotti = [];
                
                // Processa ogni progetto
                state.projects.forEach(project => {
                    // FOGLIO 1: PROGETTI
                    progetti.push({
                        'ID Progetto': project.id,
                        'Nome Progetto': project.name || '',
                        'Cliente': project.client || '',
                        'Telefono': project.clientData?.telefono || '',
                        'Email': project.clientData?.email || '',
                        'Indirizzo': project.clientData?.indirizzo || '',
                        'Citt√†': project.clientData?.citta || '',
                        'CAP': project.clientData?.cap || '',
                        'Piano': project.clientData?.piano || '',
                        'Prodotti Abilitati': Object.keys(project.prodotti || {}).filter(k => project.prodotti[k]).join(', '),
                        'Num Posizioni': (project.positions || []).length,
                        'Data Creazione': project.created || '',
                        'Ultima Modifica': project.updated || ''
                    });
                    
                    // FOGLIO 2: POSIZIONI + FOGLIO 3: PRODOTTI
                    (project.positions || []).forEach(pos => {
                        posizioni.push({
                            'ID Posizione': pos.id,
                            'ID Progetto': project.id,
                            'Nome Progetto': project.name,
                            'Nome Posizione': pos.name || '',
                            'Ambiente': pos.ambiente || '',
                            'Piano': pos.piano || '',
                            
                            // Misure posizione
                            'LVT (mm)': pos.misure?.LVT || '',
                            'HVT (mm)': pos.misure?.HVT || '',
                            'LF (mm)': pos.misure?.LF || '',
                            'HF (mm)': pos.misure?.HF || '',
                            'TMV (mm)': pos.misure?.TMV || '',
                            'HMT (mm)': pos.misure?.HMT || '',
                            'L4 (mm)': pos.misure?.L4 || '',
                            'H4 (mm)': pos.misure?.H4 || '',
                            'Delta INT (mm)': pos.misure?.DeltaINT || '',
                            'Delta EST (mm)': pos.misure?.DeltaEST || '',
                            
                            // Rilievo
                            'Da Togliere': pos.rilievo?.togliere ? 'SI' : 'NO',
                            'Smaltimento': pos.rilievo?.smaltimento ? 'SI' : 'NO',
                            'Materiale Esistente': pos.rilievo?.materiale || '',
                            'Coprifili INT': pos.rilievo?.coprifiliInt ? 'SI' : 'NO',
                            'Coprifili EST': pos.rilievo?.coprifiliEst ? 'SI' : 'NO',
                            'Note Rilievo': pos.rilievo?.note || ''
                        });
                        
                        // PRODOTTI nella posizione
                        const prodottiTypes = ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'];
                        
                        prodottiTypes.forEach(tipo => {
                            const prod = pos[tipo];
                            if (prod && typeof prod === 'object' && parseInt(prod.qta || 0) > 0) {
                                prodotti.push({
                                    'ID Posizione': pos.id,
                                    'ID Progetto': project.id,
                                    'Nome Progetto': project.name,
                                    'Nome Posizione': pos.name,
                                    'Ambiente': pos.ambiente,
                                    
                                    // Tipo prodotto
                                    'Tipo Prodotto': tipo.toUpperCase(),
                                    'Quantit√†': prod.qta || '',
                                    
                                    // Dati comuni
                                    'Azienda': prod.azienda || '',
                                    'Modello/Tipo': prod.tipo || prod.modello || '',
                                    'BRM Larghezza (mm)': prod.BRM_L || '',
                                    'BRM Altezza (mm)': prod.BRM_H || '',
                                    
                                    // Colori
                                    'Colore Interno': prod.coloreInt || prod.colore || '',
                                    'Colore Esterno': prod.coloreEst || '',
                                    
                                    // Specifici infisso
                                    'Apertura': prod.apertura || '',
                                    'Tipo Anta': prod.tipoAnta || '',
                                    'Telaio': prod.telaio || '',
                                    'Vetro': prod.vetro || '',
                                    'Cerniere': prod.cerniere || '',  // üÜï v4.80
                                    'Tagli Telaio': prod.tagliTelaio || '',
                                    'Codici Tagli': (prod.codTagliValues || []).join(','),
                                    'Maniglia': prod.maniglia || '',
                                    'Colore Maniglia': prod.coloreManiglia || '',
                                    'Allarme': prod.allarme || '',
                                    
                                    // Specifici persiana/tapparella
                                    'Fissaggio': prod.fissaggio || '',
                                    'Motorizzazione': prod.motorizzazione || '',
                                    
                                    // Note
                                    'Note Prodotto': prod.note || ''
                                });
                            }
                        });
                    });
                });
                
                // Crea workbook
                const wb = XLSX.utils.book_new();
                
                // Aggiungi i 3 fogli
                const ws1 = XLSX.utils.json_to_sheet(progetti);
                const ws2 = XLSX.utils.json_to_sheet(posizioni);
                const ws3 = XLSX.utils.json_to_sheet(prodotti);
                
                XLSX.utils.book_append_sheet(wb, ws1, "Progetti");
                XLSX.utils.book_append_sheet(wb, ws2, "Posizioni");
                XLSX.utils.book_append_sheet(wb, ws3, "Prodotti");
                
                // Download
                const fileName = `openporte-export-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification(`‚úÖ Excel esportato! ${progetti.length} progetti, ${posizioni.length} posizioni, ${prodotti.length} prodotti`, 'success');
                
            } catch (error) {
                console.error('Errore export Excel:', error);
                showNotification(`Errore durante export Excel: ${error.message}`, 'error');
            }
        };

        // üìä EXPORT EXCEL SINGOLO PROGETTO - Tutte le colonne in orizzontale
        window.exportCurrentProjectExcel = () => {
            try {
                if (!window.XLSX) {
                    showNotification('Errore: Libreria Excel non caricata', 'error');
                    return;
                }
                
                const project = state.projects.find(p => p.id === state.currentProject);
                if (!project) {
                    showNotification('Nessun progetto selezionato', 'error');
                    return;
                }
                
                // ========== FOGLIO 1: DATI PROGETTO ==========
                const progettoData = [{
                    'Nome Progetto': project.name || '',
                    'Cliente': project.client || '',
                    'Piano': project.clientData?.piano || '',
                    'Citt√†': project.clientData?.citta || '',
                    'Via/Indirizzo': project.clientData?.indirizzo || '',
                    'Telefono': project.clientData?.telefono || '',
                    'Email': project.clientData?.email || '',
                    'Note Cliente': project.clientData?.note || '',
                    
                    'Infissi Abilitati': project.prodotti?.infissi ? 'SI' : 'NO',
                    'Persiane Abilitate': project.prodotti?.persiane ? 'SI' : 'NO',
                    'Tapparelle Abilitate': project.prodotti?.tapparelle ? 'SI' : 'NO',
                    'Zanzariere Abilitate': project.prodotti?.zanzariere ? 'SI' : 'NO',
                    'Cassonetti Abilitati': project.prodotti?.cassonetti ? 'SI' : 'NO',
                    
                    // MURO TEMPLATE
                    'Prof. Muro Int': project.caratteristicheMuro?.profMuroInt || '',
                    'Prof. Piana Sopra': project.caratteristicheMuro?.profPianaSopra || '',
                    'Prof. Piana Sotto': project.caratteristicheMuro?.profPianaSotto || '',
                    'Telaio Prof': project.caratteristicheMuro?.telaioProfondita || '',
                    'Telaio Largh': project.caratteristicheMuro?.telaioLarghezza || '',
                    'Guida Esistente?': project.caratteristicheMuro?.guidaEsistente || '',
                    'Prof. Guida': project.caratteristicheMuro?.profGuida || '',
                    'Larghezza Guida': project.caratteristicheMuro?.larghezzaGuida || '',
                    'Prof. Muro Est.': project.caratteristicheMuro?.profMuroEst || '',
                    'Battuta Sup. con Tapp.': project.caratteristicheMuro?.battutaSuperioreTapparella || '',
                    'Falso Esistente?': project.caratteristicheMuro?.falsoEsistente || '',
                    'Spessore Falso': project.caratteristicheMuro?.spessoreFalso || '',
                    'Dist. Falso-Infisso': project.caratteristicheMuro?.distanzaFalsoInfisso || '',
                    
                    // INFISSI CONFIG + BRM
                    'Infissi - Azienda': project.configInfissi?.azienda || '',
                    'Infissi - Telaio': project.configInfissi?.telaio || '',
                    'Infissi - Colore INT': project.configInfissi?.coloreInt || '',
                    'Infissi - Colore EST': project.configInfissi?.coloreEst || '',
                    'Infissi - Tipo Anta': project.configInfissi?.tipoAnta || '',
                    'Infissi - Vetro': project.configInfissi?.vetro || '',
                    'Infissi - Tagli Telaio': project.configInfissi?.tagliTelaio || '',
                    'Infissi BRM - Base L': project.brmConfigInfissi?.misuraBaseL || '',
                    'Infissi BRM - Op. L': project.brmConfigInfissi?.operazioneL || '',
                    'Infissi BRM - Valore L': project.brmConfigInfissi?.valoreL || '',
                    'Infissi BRM - Base H': project.brmConfigInfissi?.misuraBaseH || '',
                    'Infissi BRM - Op. H': project.brmConfigInfissi?.operazioneH || '',
                    'Infissi BRM - Valore H': project.brmConfigInfissi?.valoreH || '',
                    
                    // PERSIANE CONFIG + BRM
                    'Persiane - Azienda': project.configPersiane?.azienda || '',
                    'Persiane - Modello': project.configPersiane?.modello || '',
                    'Persiane - Fissaggio': project.configPersiane?.fissaggio || '',
                    'Persiane - Colore': project.configPersiane?.colore || '',
                    'Persiane BRM - Base L': project.brmConfigPersiane?.misuraBaseL || '',
                    'Persiane BRM - Op. L': project.brmConfigPersiane?.operazioneL || '',
                    'Persiane BRM - Valore L': project.brmConfigPersiane?.valoreL || '',
                    'Persiane BRM - Base H': project.brmConfigPersiane?.misuraBaseH || '',
                    'Persiane BRM - Op. H': project.brmConfigPersiane?.operazioneH || '',
                    'Persiane BRM - Valore H': project.brmConfigPersiane?.valoreH || '',
                    
                    // TAPPARELLE CONFIG + BRM
                    'Tapparelle - Azienda': project.configTapparelle?.azienda || '',
                    'Tapparelle - Tipo': project.configTapparelle?.tipo || '',
                    'Tapparelle - Colore': project.configTapparelle?.colore || '',
                    'Tapparelle - Motorizzazione': project.configTapparelle?.motorizzazione || '',
                    'Tapparelle BRM - Base L': project.brmConfigTapparelle?.misuraBaseL || '',
                    'Tapparelle BRM - Op. L': project.brmConfigTapparelle?.operazioneL || '',
                    'Tapparelle BRM - Valore L': project.brmConfigTapparelle?.valoreL || '',
                    'Tapparelle BRM - Base H': project.brmConfigTapparelle?.misuraBaseH || '',
                    'Tapparelle BRM - Op. H': project.brmConfigTapparelle?.operazioneH || '',
                    'Tapparelle BRM - Valore H': project.brmConfigTapparelle?.valoreH || '',
                    
                    // ZANZARIERE CONFIG + BRM
                    'Zanzariere - Azienda': project.configZanzariere?.azienda || '',
                    'Zanzariere - Modello F': project.configZanzariere?.modelloF || '',
                    'Zanzariere - Modello PF': project.configZanzariere?.modelloPF || '',
                    'Zanzariere - Colore': project.configZanzariere?.colore || '',
                    'Zanzariere BRM - Base L': project.brmConfigZanzariere?.misuraBaseL || '',
                    'Zanzariere BRM - Op. L': project.brmConfigZanzariere?.operazioneL || '',
                    'Zanzariere BRM - Valore L': project.brmConfigZanzariere?.valoreL || '',
                    'Zanzariere BRM - Base H': project.brmConfigZanzariere?.misuraBaseH || '',
                    'Zanzariere BRM - Op. H': project.brmConfigZanzariere?.operazioneH || '',
                    'Zanzariere BRM - Valore H': project.brmConfigZanzariere?.valoreH || '',
                    
                    // CASSONETTI CONFIG + BRM
                    'Cassonetti - Tipo': project.configCassonetti?.tipo || '',
                    'Cassonetti - Azienda': project.configCassonetti?.azienda || '',
                    'Cassonetti - Colore': project.configCassonetti?.colore || '',
                    'Cassonetti BRM - Base L': project.brmConfigCassonetti?.misuraBaseL || '',
                    'Cassonetti BRM - Base H': project.brmConfigCassonetti?.misuraBaseH || '',
                    'Cassonetti BRM - Base C': project.brmConfigCassonetti?.misuraBaseC || '',
                    'Cassonetti BRM - Base B': project.brmConfigCassonetti?.misuraBaseB || ''
                }];
                
                // ========== FOGLIO 2: POSIZIONI ==========
                const posizioniRows = [];
                
                (project.positions || []).forEach(pos => {
                    // Ottieni caratteristiche muro (override o globali)
                    const cm = pos.caratteristicheMuroOverride || project.caratteristicheMuro || {};
                    
                    const row = {
                        // DATI POSIZIONE
                        'Nome Posizione': pos.name || '',
                        'Ambiente': pos.ambiente || '',
                        'Piano': pos.piano || '',
                        
                        // CARATTERISTICHE MURO (valori reali posizione)
                        'Prof. Muro Int': cm.profMuroInt || '',
                        'Prof. Piana Sopra': cm.profPianaSopra || '',
                        'Prof. Piana Sotto': cm.profPianaSotto || '',
                        'Telaio Prof': cm.telaioProfondita || '',
                        'Telaio Largh': cm.telaioLarghezza || '',
                        'Guida Esistente?': cm.guidaEsistente || '',
                        'Prof. Guida': cm.profGuida || '',
                        'Larghezza Guida': cm.larghezzaGuida || '',
                        'Prof. Muro Est.': cm.profMuroEst || '',
                        'Battuta Sup. con Tapp.': cm.battutaSuperioreTapparella || '',
                        'Falso Esistente?': cm.falsoEsistente || '',
                        'Spessore Falso': cm.spessoreFalso || '',
                        'Dist. Falso-Infisso': cm.distanzaFalsoInfisso || '',
                        
                        // MISURE POSIZIONE
                        'LVT': pos.misure?.LVT || '',
                        'HVT': pos.misure?.HVT || '',
                        'LF': pos.misure?.LF || '',
                        'HF': pos.misure?.HF || '',
                        'TMV': pos.misure?.TMV || '',
                        'HMT': pos.misure?.HMT || '',
                        'L4': pos.misure?.L4 || '',
                        'H4': pos.misure?.H4 || '',
                        'Delta INT': pos.misure?.DeltaINT || '',
                        'Delta EST': pos.misure?.DeltaEST || '',
                        'H Soffitto': pos.misure?.HSoffitto || '',
                        'H Parapetto Soffitto': pos.misure?.HParapettoSoffitto || '',
                        'H Pavimento Parapetto': pos.misure?.HPavimentoParapetto || '',
                        
                        // RILIEVO POSIZIONE
                        'Da Togliere': pos.rilievo?.togliere ? 'SI' : 'NO',
                        'Smaltimento': pos.rilievo?.smaltimento ? 'SI' : 'NO',
                        'Materiale Esistente': pos.rilievo?.materiale || '',
                        'Coprifili INT': pos.rilievo?.coprifiliInt ? 'SI' : 'NO',
                        'Coprifili EST': pos.rilievo?.coprifiliEst ? 'SI' : 'NO',
                        'Note Rilievo': pos.rilievo?.note || '',
                        
                        // INFISSO POSIZIONE
                        'Infisso QTA': pos.infisso?.qta || '',
                        'Infisso Tipo': pos.infisso?.tipo || '',
                        'Infisso Apertura': pos.infisso?.apertura || '',
                        'Infisso Azienda': pos.infisso?.azienda || '',
                        'Infisso Telaio': pos.infisso?.telaio || '',
                        'Infisso Colore INT': pos.infisso?.coloreInt || '',
                        'Infisso Colore EST': pos.infisso?.coloreEst || '',
                        'Infisso Tipo Anta': pos.infisso?.tipoAnta || '',
                        'Infisso Vetro': pos.infisso?.vetro || '',
                        'Infisso Tagli Telaio': pos.infisso?.tagliTelaio || '',
                        'Infisso Maniglia': pos.infisso?.maniglia || '',
                        'Infisso Colore Maniglia': pos.infisso?.coloreManiglia || '',
                        'Infisso BRM L': pos.infisso?.BRM_L || '',
                        'Infisso BRM H': pos.infisso?.BRM_H || '',
                        'Infisso Note': pos.infisso?.note || '',
                        
                        // PERSIANA POSIZIONE
                        'Persiana QTA': pos.persiana?.qta || '',
                        'Persiana Azienda': pos.persiana?.azienda || '',
                        'Persiana Modello': pos.persiana?.modello || '',
                        'Persiana Fissaggio': pos.persiana?.fissaggio || '',
                        'Persiana Colore': pos.persiana?.colore || '',
                        'Persiana BRM L': pos.persiana?.BRM_L || '',
                        'Persiana BRM H': pos.persiana?.BRM_H || '',
                        'Persiana Note': pos.persiana?.note || '',
                        
                        // TAPPARELLA POSIZIONE
                        'Tapparella QTA': pos.tapparella?.qta || '',
                        'Tapparella Azienda': pos.tapparella?.azienda || '',
                        'Tapparella Tipo': pos.tapparella?.tipo || '',
                        'Tapparella Colore': pos.tapparella?.colore || '',
                        'Tapparella Motorizzazione': pos.tapparella?.motorizzazione || '',
                        'Tapparella BRM L': pos.tapparella?.BRM_L || '',
                        'Tapparella BRM H': pos.tapparella?.BRM_H || '',
                        'Tapparella Note': pos.tapparella?.note || '',
                        
                        // ZANZARIERA POSIZIONE
                        'Zanzariera QTA': pos.zanzariera?.qta || '',
                        'Zanzariera Azienda': pos.zanzariera?.azienda || '',
                        'Zanzariera Modello F': pos.zanzariera?.modelloF || '',
                        'Zanzariera Modello PF': pos.zanzariera?.modelloPF || '',
                        'Zanzariera Colore': pos.zanzariera?.colore || '',
                        'Zanzariera BRM L': pos.zanzariera?.BRM_L || '',
                        'Zanzariera BRM H': pos.zanzariera?.BRM_H || '',
                        'Zanzariera Note': pos.zanzariera?.note || '',
                        
                        // CASSONETTO POSIZIONE
                        'Cassonetto QTA': pos.cassonetto?.qta || '',
                        'Cassonetto Tipo': pos.cassonetto?.tipo || '',
                        'Cassonetto Azienda': pos.cassonetto?.azienda || '',
                        'Cassonetto Colore': pos.cassonetto?.colore || '',
                        'Cassonetto BRM L': pos.cassonetto?.BRM_L || '',
                        'Cassonetto BRM H': pos.cassonetto?.BRM_H || '',
                        'Cassonetto Note': pos.cassonetto?.note || '',
                        
                        // NOTE
                        'Note Posizione': pos.note || '',
                        'Num Foto': (pos.foto || []).length
                    };
                    
                    posizioniRows.push(row);
                });
                
                // Crea workbook con 2 fogli
                const wb = XLSX.utils.book_new();
                
                const ws1 = XLSX.utils.json_to_sheet(progettoData);
                const ws2 = XLSX.utils.json_to_sheet(posizioniRows);
                
                XLSX.utils.book_append_sheet(wb, ws1, "Progetto");
                XLSX.utils.book_append_sheet(wb, ws2, "Posizioni");
                
                // Download
                const fileName = `${project.name || 'progetto'}-${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification(`‚úÖ Excel esportato! Progetto + ${posizioniRows.length} posizioni`, 'success');
                
            } catch (error) {
                console.error('Errore export Excel:', error);
                showNotification(`Errore durante export Excel: ${error.message}`, 'error');
            }
        };
        window.exportCurrentProjectJSON = () => {
            try {
                const project = state.projects.find(p => p.id === state.currentProject);
                if (!project) {
                    showNotification('Nessun progetto selezionato', 'error');
                    return;
                }
                
                // üÜï FASE 013: Controllo completamento posizioni (nome, ambiente, prodotti, misure)
                // üîß FASE 014: Passa project alla funzione
                const posizioniIncomplete = project.positions.map(pos => {
                    const comp = calculatePositionCompleteness(pos, project);
                    return { pos, comp };
                }).filter(item => !item.comp.isComplete);
                
                if (posizioniIncomplete.length > 0) {
                    let dettagli = posizioniIncomplete.map(item => {
                        const nome = item.pos.name || 'Senza nome';
                        const perc = item.comp.percentage;
                        const mancanti = item.comp.missing.join(', ');
                        return `‚Ä¢ ${nome} (${perc}%): ${mancanti}`;
                    }).join('\n');
                    
                    const conferma = confirm(
                        `‚ö†Ô∏è ATTENZIONE: ${posizioniIncomplete.length} posizioni non sono complete al 100%:\n\n${dettagli}\n\n` +
                        `Vuoi procedere comunque con l'export?\n\n` +
                        `[OK] = Esporta lo stesso | [Annulla] = Torna a completare`
                    );
                    
                    if (!conferma) {
                        showNotification('Export annullato. Completa le posizioni mancanti.', 'info');
                        return;
                    }
                }
                
                // üÜï VALIDAZIONE: Verifica che tutte le posizioni abbiano Ambiente compilato
                const posizioniSenzaAmbiente = project.positions.filter(pos => !pos.ambiente || pos.ambiente.trim() === '');
                if (posizioniSenzaAmbiente.length > 0) {
                    const nomiPosizioni = posizioniSenzaAmbiente.map(pos => pos.name || 'Senza nome').join(', ');
                    showNotification(
                        `‚ö†Ô∏è Ambiente obbligatorio! Le seguenti posizioni non hanno l'ambiente compilato: ${nomiPosizioni}`,
                        'error',
                        8000
                    );
                    return;
                }
                
                const data = {
                    commessa_id: project.id,
                    versione: "1.0-FASE007",
                    data_rilievo: new Date().toISOString(),
                    // üîç RICERCA: Campo per ricerca facile nel JSON
                    nome_ricerca: `${project.client || ''} ${project.name || ''}`.trim(),
                    cliente: {
                        nome: project.client || '',
                        progetto: project.name || '',
                        piano: project.clientData?.piano || '',
                        indirizzo: project.clientData?.indirizzo || '',
                        telefono: project.clientData?.telefono || ''
                    },
                    note_progetto: project.clientData?.note || '',
                    // üß± CARATTERISTICHE MURO GLOBALI
                    caratteristiche_muro_globali: {
                        telaio_larghezza: project.caratteristicheMuro?.telaioLarghezza || 0,
                        telaio_altezza: project.caratteristicheMuro?.telaioAltezza || 0,
                        falso_esistente: project.caratteristicheMuro?.falsoEsistente || 'no',
                        spessore_falso: project.caratteristicheMuro?.spessoreFalso || 0,
                        distanza_falso_infisso: project.caratteristicheMuro?.distanzaFalsoInfisso || 0,
                        distanza_muro_infisso: project.caratteristicheMuro?.distanzaMuroInfisso || 0,
                        guida_tipo: project.caratteristicheMuro?.guidaTipo || '',
                        guida_larghezza: project.caratteristicheMuro?.guidaLarghezza || 0,
                        guida_altezza: project.caratteristicheMuro?.guidaAltezza || 0,
                        guida_profondita: project.caratteristicheMuro?.guidaProfondita || 0,
                        coprifilo_larghezza: project.caratteristicheMuro?.coprifiloLarghezza || 0,
                        prof_muro_int: project.caratteristicheMuro?.profMuroInt || 0,
                        prof_muro_est: project.caratteristicheMuro?.profMuroEst || 0,
                        battuta_superiore_tapparella: project.caratteristicheMuro?.battutaSuperioreTapparella || 0
                    },
                    posizioni: project.positions.map(pos => {
                        // üìä TEMPLATE COMPLETO MISURE - Include tutti i campi anche se = 0
                        const misureComplete = {
                            // Misure principali
                            LVT: pos.misure?.LVT ?? 0,
                            HVT: pos.misure?.HVT ?? 0,
                            LF: pos.misure?.LF ?? 0,
                            HF: pos.misure?.HF ?? 0,
                            TMV: pos.misure?.TMV ?? 0,
                            HMT: pos.misure?.HMT ?? 0,
                            L4: pos.misure?.L4 ?? 0,
                            H4: pos.misure?.H4 ?? 0,
                            // Delta
                            DeltaINT: pos.misure?.DeltaINT ?? 0,
                            DeltaEST: pos.misure?.DeltaEST ?? 0,
                            // Altezze
                            HSoffitto: pos.misure?.HSoffitto ?? 0,
                            HParapettoSoffitto: pos.misure?.HParapettoSoffitto ?? 0,
                            HPavimentoParapetto: pos.misure?.HPavimentoParapetto ?? 0
                        };
                        
                        const posData = {
                            id: pos.id,
                            nome: pos.nome || pos.id,
                            piano: pos.piano || '',
                            stanza: pos.stanza || '',
                            ambiente: pos.ambiente || '',
                            quantita: pos.quantita || 1,
                            misure: misureComplete
                        };
                        
                        // üß± CARATTERISTICHE MURO OVERRIDE (se presenti per questa posizione)
                        if (pos.overrideCaratteristiche && pos.caratteristicheMuroOverride) {
                            posData.caratteristiche_muro_override = {
                                telaio_larghezza: pos.caratteristicheMuroOverride.telaioLarghezza || 0,
                                telaio_altezza: pos.caratteristicheMuroOverride.telaioAltezza || 0,
                                falso_esistente: pos.caratteristicheMuroOverride.falsoEsistente || 'no',
                                spessore_falso: pos.caratteristicheMuroOverride.spessoreFalso || 0,
                                distanza_falso_infisso: pos.caratteristicheMuroOverride.distanzaFalsoInfisso || 0,
                                distanza_muro_infisso: pos.caratteristicheMuroOverride.distanzaMuroInfisso || 0,
                                guida_tipo: pos.caratteristicheMuroOverride.guidaTipo || '',
                                guida_larghezza: pos.caratteristicheMuroOverride.guidaLarghezza || 0,
                                guida_altezza: pos.caratteristicheMuroOverride.guidaAltezza || 0,
                                guida_profondita: pos.caratteristicheMuroOverride.guidaProfondita || 0,
                                coprifilo_larghezza: pos.caratteristicheMuroOverride.coprifiloLarghezza || 0,
                                prof_muro_int: pos.caratteristicheMuroOverride.profMuroInt || 0,
                                prof_muro_est: pos.caratteristicheMuroOverride.profMuroEst || 0,
                                battuta_superiore_tapparella: pos.caratteristicheMuroOverride.battutaSuperioreTapparella || 0
                            };
                        }
                        
                        // Aggiungi infisso se presente
                        if (pos.infisso) {
                            posData.infisso = {
                                quantita: pos.infisso.quantita || 1,
                                tipo: pos.infisso.tipo || '',
                                apertura: pos.infisso.apertura || '',
                                azienda: pos.infisso.azienda || '',
                                misure: misureComplete,  // üìä Usa template completo
                                brm: {  // üìä Template completo BRM
                                    L: pos.infisso.brm?.L ?? null,
                                    H: pos.infisso.brm?.H ?? null,
                                    C: pos.infisso.brm?.C ?? null,
                                    B: pos.infisso.brm?.B ?? null
                                },
                                finitura_int: pos.infisso.finituraInt || '',
                                finitura_est: pos.infisso.finituraEst || '',
                                colore_int: pos.infisso.coloreInt || '',
                                colore_est: pos.infisso.coloreEst || '',
                                tipo_anta: pos.infisso.tipoAnta || '',
                                telaio: pos.infisso.telaio || '',
                                allarme: pos.infisso.allarme || '',
                                vetro: pos.infisso.vetro || '',
                                tagli_telaio: pos.infisso.tagliTelaio || '',
                                // üÜï v4.85: Usa codTagliValues invece di codTagli (rimosso)
                                cod_tagli_values: pos.infisso.codTagliValues || [],
                                maniglia: pos.infisso.maniglia || '',
                                colore_maniglia: pos.infisso.coloreManiglia || ''
                            };
                        }
                        
                        // Aggiungi persiana se presente
                        if (pos.persiana) {
                            posData.persiana = {
                                quantita: pos.persiana.quantita || 1,
                                tipo: pos.persiana.tipo || '',
                                apertura: pos.persiana.apertura || '',
                                modello: pos.persiana.modello || '',
                                fissaggio: pos.persiana.fissaggio || '',
                                tipo_telaio: pos.persiana.tipoTelaio || '',
                                colore_persiana: pos.persiana.colorePersiana || '',
                                colore_telaio: pos.persiana.coloreTelaio || '',
                                battuta: pos.persiana.battuta || '',
                                brm: {  // üìä Template completo BRM
                                    L: pos.persiana.brm?.L ?? null,
                                    H: pos.persiana.brm?.H ?? null,
                                    C: pos.persiana.brm?.C ?? null,
                                    B: pos.persiana.brm?.B ?? null
                                },
                                foto: pos.persiana.foto ? 'presente' : 'no'
                            };
                        }
                        
                        // Aggiungi tapparella se presente
                        if (pos.tapparella) {
                            posData.tapparella = {
                                quantita: pos.tapparella.quantita || 1,
                                azienda: pos.tapparella.azienda || '',
                                modello: pos.tapparella.modello || '',
                                colore: pos.tapparella.colore || '',
                                manuale_motorizzato: pos.tapparella.manualeMotoriz || '',
                                sost_tipo: pos.tapparella.sostTipo || 'tutto',
                                accessori_da_sostituire: pos.tapparella.accessoriDaSostituire || {},
                                guida: pos.tapparella.guida || '',
                                colore_guida: pos.tapparella.coloreGuida || '',
                                brm: {  // üìä Template completo BRM
                                    L: pos.tapparella.brm?.L ?? null,
                                    H: pos.tapparella.brm?.H ?? null,
                                    C: pos.tapparella.brm?.C ?? null,
                                    B: pos.tapparella.brm?.B ?? null
                                },
                                motori: pos.tapparella.motori || []
                            };
                        }
                        
                        // Aggiungi zanzariera se presente
                        if (pos.zanzariera) {
                            posData.zanzariera = {
                                quantita: pos.zanzariera.quantita || 1,
                                azienda: pos.zanzariera.azienda || '',
                                tipo: pos.zanzariera.tipo || '',
                                apertura: pos.zanzariera.apertura || '',
                                tipo_infisso_associato: pos.zanzariera.tipoInfissoAssociato || '',
                                colore_telaio: pos.zanzariera.coloreTelaio || '',
                                tipo_rete: pos.zanzariera.tipoRete || '',
                                brm: {  // üìä Template completo BRM
                                    L: pos.zanzariera.brm?.L ?? null,
                                    H: pos.zanzariera.brm?.H ?? null,
                                    C: pos.zanzariera.brm?.C ?? null,
                                    B: pos.zanzariera.brm?.B ?? null
                                }
                            };
                        }
                        
                        // Aggiungi cassonetto se presente
                        if (pos.cassonetto) {
                            posData.cassonetto = {
                                quantita: pos.cassonetto.quantita || 1,
                                tipo: pos.cassonetto.tipo || '',
                                azienda: pos.cassonetto.azienda || '',
                                colore: pos.cassonetto.colore || '',
                                sovrappi_sostit: pos.cassonetto.sovrappiSostit || '',
                                a_soffitto: pos.cassonetto.aSoffitto || '',
                                misure: {  // üìä Template completo con ?? operator
                                    LS: pos.cassonetto.LS ?? 0,
                                    SRSX: pos.cassonetto.SRSX ?? 0,
                                    ZSX: pos.cassonetto.ZSX ?? 0,
                                    SRDX: pos.cassonetto.SRDX ?? 0,
                                    ZDX: pos.cassonetto.ZDX ?? 0,
                                    HCASS: pos.cassonetto.HCASS ?? 0,
                                    B: pos.cassonetto.B ?? 0,
                                    C: pos.cassonetto.C ?? 0,
                                    BSuperiore: pos.cassonetto.BSuperiore ?? 0
                                },
                                brm: {  // üìä Template completo BRM
                                    L: pos.cassonetto.brm?.L ?? null,
                                    H: pos.cassonetto.brm?.H ?? null,
                                    C: pos.cassonetto.brm?.C ?? null,
                                    B: pos.cassonetto.brm?.B ?? null
                                }
                            };
                        }
                        
                        // üìã RILIEVO PREESISTENTE (se presente)
                        if (pos.rilievo) {
                            posData.rilievo_preesistente = {
                                da_togliere: pos.rilievo.togliere || false,
                                smaltimento: pos.rilievo.smaltimento || false,
                                materiale: pos.rilievo.materiale || '',
                                coprifili_int: pos.rilievo.coprifiliInt || false,
                                coprifili_est: pos.rilievo.coprifiliEst || false,
                                note: pos.rilievo.note || ''
                            };
                        }
                        
                        // üö™ v5.12: INGRESSO (portoncino o blindata)
                        if (pos.ingresso) {
                            posData.ingresso = {
                                tipo: pos.ingresso.tipo || null
                            };
                            
                            // Portoncino Finstral
                            if (pos.ingresso.portoncino) {
                                posData.ingresso.portoncino = pos.ingresso.portoncino;
                            }
                            
                            // Blindata Oikos (struttura completa)
                            if (pos.ingresso.blindata) {
                                const bld = pos.ingresso.blindata;
                                posData.ingresso.blindata = {
                                    azienda: bld.azienda || 'Oikos',
                                    LNP_L: bld.LNP_L || null,
                                    LNP_H: bld.LNP_H || null,
                                    luceCalcolata: bld.luceCalcolata || null,
                                    versione: bld.versione || '',
                                    tipoAnta: bld.tipoAnta || 'singola',
                                    sensoApertura: bld.sensoApertura || '',
                                    versoApertura: bld.versoApertura || '',
                                    controtelaio: bld.controtelaio || 'si',
                                    cilindro: bld.cilindro || 'BASIC',
                                    coloreTelaio: bld.coloreTelaio || 'RAL8022',
                                    acustica: bld.acustica || 'serie',
                                    termica: bld.termica || 'serie',
                                    kitAAV: bld.kitAAV || '',
                                    // Optional
                                    vetro: bld.vetro || { attivo: false },
                                    sopraluce: bld.sopraluce || { attivo: false },
                                    fiancoluce: bld.fiancoluce || { attivo: false },
                                    // Rivestimenti
                                    rivestimentoInt: bld.rivestimentoInt || {},
                                    rivestimentoEst: bld.rivestimentoEst || {},
                                    note: bld.note || ''
                                };
                            }
                        }
                        
                        return posData;
                    }),
                    totali: {
                        n_posizioni: project.positions.length,
                        n_infissi: project.positions.filter(p => p.infisso).length,
                        n_persiane: project.positions.filter(p => p.persiana).length,
                        n_tapparelle: project.positions.filter(p => p.tapparella).length,
                        n_zanzariere: project.positions.filter(p => p.zanzariera).length,
                        n_cassonetti: project.positions.filter(p => p.cassonetto).length,
                        n_ingressi: project.positions.filter(p => p.ingresso).length,
                        n_blindate: project.positions.filter(p => p.ingresso?.tipo === 'blindata').length,
                        n_portoncini: project.positions.filter(p => p.ingresso?.tipo === 'portoncino').length
                    }
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `RILIEVO-${project.client || 'Cliente'}-${project.name || 'Progetto'}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`‚úÖ JSON esportato per Odoo!`, 'success');
                
            } catch (error) {
                console.error('Errore export JSON:', error);
                showNotification(`Errore durante export: ${error.message}`, 'error');
            }
        };

        // Funzione per stampare PDF del rilievo
        window.printCurrentProjectPDF = () => {
            try {
                const project = state.projects.find(p => p.id === state.currentProject);
                if (!project) {
                    showNotification('Nessun progetto selezionato', 'error');
                    return;
                }
                
                // üÜï FASE 013: Controllo completamento posizioni (nome, ambiente, prodotti, misure)
                // üîß FASE 014: Passa project alla funzione
                const posizioniIncomplete = project.positions.map(pos => {
                    const comp = calculatePositionCompleteness(pos, project);
                    return { pos, comp };
                }).filter(item => !item.comp.isComplete);
                
                if (posizioniIncomplete.length > 0) {
                    let dettagli = posizioniIncomplete.map(item => {
                        const nome = item.pos.name || 'Senza nome';
                        const perc = item.comp.percentage;
                        const mancanti = item.comp.missing.join(', ');
                        return `‚Ä¢ ${nome} (${perc}%): ${mancanti}`;
                    }).join('\n');
                    
                    const conferma = confirm(
                        `‚ö†Ô∏è ATTENZIONE: ${posizioniIncomplete.length} posizioni non sono complete al 100%:\n\n${dettagli}\n\n` +
                        `Vuoi procedere comunque con la stampa PDF?\n\n` +
                        `[OK] = Stampa lo stesso | [Annulla] = Torna a completare`
                    );
                    
                    if (!conferma) {
                        showNotification('Stampa annullata. Completa le posizioni mancanti.', 'info');
                        return;
                    }
                }
                
                // Genera HTML per stampa - continua nel prossimo file
                const printHTML = generatePrintHTML(project);
                
                // Apri finestra di stampa
                const printWindow = window.open('', '', 'width=900,height=700');
                printWindow.document.write(printHTML);
                printWindow.document.close();
                
                // Aspetta che il contenuto sia caricato prima di stampare
                printWindow.onload = () => {
                    printWindow.focus();
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                };
                
                showNotification('üìÑ Finestra di stampa aperta!', 'success');
                
            } catch (error) {
                console.error('Errore stampa PDF:', error);
                showNotification(`Errore durante stampa: ${error.message}`, 'error');
            }
        };

        // Funzione helper per generare HTML di stampa
        function generatePrintHTML(project) {
            return `<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<title>Rilievo - ${project.client || 'Cliente'}</title>
<style>
@media print { @page { margin: 1cm; } body { margin: 0; } .page-break { page-break-after: always; } }
body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
h1 { color: #1e293b; border-bottom: 3px solid #6366f1; padding-bottom: 10px; margin-bottom: 20px; }
h2 { color: #475569; background: #f1f5f9; padding: 10px; margin-top: 30px; border-left: 4px solid #6366f1; }
h3 { color: #334155; margin-top: 20px; background: #e2e8f0; padding: 8px; }
h4 { color: #475569; margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
th { background-color: #6366f1; color: white; font-weight: bold; }
tr:nth-child(even) { background-color: #f8fafc; }
.header-info { background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
.header-info p { margin: 5px 0; }
.totali { background: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px solid #fbbf24; }
.nota { background: #dbeafe; padding: 10px; border-left: 4px solid #3b82f6; margin: 10px 0; font-size: 0.9em; }
.logo { text-align: center; margin-bottom: 20px; color: #6366f1; font-size: 1.2em; font-weight: bold; }
</style></head><body>
<div class="logo">OPEN PORTE & FINESTRE SRL</div>
<h1>üìã RILIEVO MISURE</h1>
<div class="header-info">
<p><strong>üè¢ Cliente:</strong> ${project.client || 'N/D'}</p>
<p><strong>üìÅ Progetto:</strong> ${project.name || 'N/D'}</p>
<p><strong>üìç Piano:</strong> ${project.clientData?.piano || 'N/D'}</p>
<p><strong>üè† Indirizzo:</strong> ${project.clientData?.indirizzo || 'N/D'}</p>
<p><strong>üìû Telefono:</strong> ${project.clientData?.telefono || 'N/D'}</p>
<p><strong>üìÖ Data Rilievo:</strong> ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}</p>
${project.clientData?.note ? `<p><strong>üìù Note:</strong> ${project.clientData.note}</p>` : ''}
</div>
<div class="totali">
<strong>üìä RIEPILOGO TOTALI:</strong><br>
‚Ä¢ Posizioni: ${project.positions.length}<br>
‚Ä¢ Infissi: ${project.positions.filter(p => p.infisso).length}<br>
‚Ä¢ Persiane: ${project.positions.filter(p => p.persiana).length}<br>
‚Ä¢ Tapparelle: ${project.positions.filter(p => p.tapparella).length}<br>
‚Ä¢ Zanzariere: ${project.positions.filter(p => p.zanzariera).length}<br>
‚Ä¢ Cassonetti: ${project.positions.filter(p => p.cassonetto).length}
</div>
<h2>üìê DETTAGLIO POSIZIONI</h2>
${project.positions.map((pos, idx) => generatePositionHTML(pos, idx, project.positions.length, project)).join('')}
<div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 0.9em;">
<p>Documento generato automaticamente da Open Porte App</p>
<p>OPEN PORTE & FINESTRE SRL - Capitale Sociale ‚Ç¨20.000</p>
</div>
</body></html>`;
        }

        // Helper per generare la spiegazione del calcolo BRM
        function generateBRMExplanation(pos, product, productType, project) {
            if (!product) return '';
            
            // Determina quale brmConfig usare
            let brmConfig = null;
            let tipo = null;
            
            if (productType === 'infisso') {
                brmConfig = project.brmConfigInfissi;
                tipo = product.tipo;
            } else if (productType === 'persiana') {
                brmConfig = project.brmConfigPersiane;
            } else if (productType === 'tapparella') {
                brmConfig = project.brmConfigTapparelle;
            } else if (productType === 'zanzariera') {
                brmConfig = project.brmConfigZanzariere;
                tipo = pos.infisso?.tipo || '';
            } else if (productType === 'cassonetto') {
                brmConfig = project.brmConfigCassonetti;
            }
            
            if (!brmConfig) return '';
            
            // Determina se √® portafinestra
            const isPortafinestra = tipo && (tipo.includes('PF') || tipo.toUpperCase().includes('PF'));
            
            // Helper per calcolare e formattare una formula
            const spiegaMisura = (misuraBase, misure) => {
                if (!misuraBase) return null;
                
                misuraBase = misuraBase.replace(/\s+/g, '');
                
                // Se contiene +, √® una somma
                if (misuraBase.includes('+')) {
                    const parti = misuraBase.split('+').map(p => p.trim());
                    const valori = [];
                    let totale = 0;
                    
                    for (const parte of parti) {
                        const valore = parseFloat(misure[parte]);
                        if (!isNaN(valore)) {
                            valori.push(`${parte}(${valore})`);
                            totale += valore;
                        }
                    }
                    
                    return {
                        formula: valori.join(' + '),
                        base: totale
                    };
                }
                
                // Singola misura
                const valore = parseFloat(misure[misuraBase]);
                return isNaN(valore) ? null : {
                    formula: misuraBase,
                    base: valore
                };
            };
            
            // Usa le misure corrette in base al tipo di prodotto
            const misure = (productType === 'cassonetto') ? product : pos.misure;
            
            let result = '<tr><td colspan="2" style="background:#e0f2fe;padding:8px;font-size:0.85em;"><strong>üìê Calcolo BRM:</strong><br>';
            const explanations = [];
            
            // Calcola L
            const misuraBaseLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'misuraBaseL_PF' : 'misuraBaseL';
            const operazioneLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'operazioneL_PF' : 'operazioneL';
            const valoreLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'valoreL_PF' : 'valoreL';
            
            if (brmConfig[misuraBaseLKey] && product.BRM_L !== undefined && product.BRM_L !== null) {
                const infoL = spiegaMisura(brmConfig[misuraBaseLKey], misure);
                if (infoL) {
                    const valoreL = parseFloat(brmConfig[valoreLKey]) || 0;
                    const operazioneL = brmConfig[operazioneLKey] || '-';
                    const segno = operazioneL === '+' ? '+' : '‚àí';
                    explanations.push(`<strong>BRM_L</strong> = ${infoL.formula} ${segno} ${Math.abs(valoreL)} = <strong>${product.BRM_L} mm</strong>`);
                }
            }
            
            // Calcola H
            const misuraBaseHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'misuraBaseH_PF' : 'misuraBaseH';
            const operazioneHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'operazioneH_PF' : 'operazioneH';
            const valoreHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'valoreH_PF' : 'valoreH';
            
            if (brmConfig[misuraBaseHKey] && product.BRM_H !== undefined && product.BRM_H !== null) {
                const infoH = spiegaMisura(brmConfig[misuraBaseHKey], misure);
                if (infoH) {
                    const valoreH = parseFloat(brmConfig[valoreHKey]) || 0;
                    const operazioneH = brmConfig[operazioneHKey] || '-';
                    const segno = operazioneH === '+' ? '+' : '‚àí';
                    explanations.push(`<strong>BRM_H</strong> = ${infoH.formula} ${segno} ${Math.abs(valoreH)} = <strong>${product.BRM_H} mm</strong>`);
                }
            }
            
            // Calcola C (cassonetti)
            if (brmConfig.misuraBaseC && product.BRM_C !== undefined && product.BRM_C !== null) {
                const infoC = spiegaMisura(brmConfig.misuraBaseC, misure);
                if (infoC) {
                    const valoreC = parseFloat(brmConfig.valoreC) || 0;
                    const operazioneC = brmConfig.operazioneC || '-';
                    const segno = operazioneC === '+' ? '+' : '‚àí';
                    explanations.push(`<strong>BRM_C</strong> = ${infoC.formula} ${segno} ${Math.abs(valoreC)} = <strong>${product.BRM_C} mm</strong>`);
                }
            }
            
            // Calcola B (cassonetti)
            if (brmConfig.misuraBaseB && product.BRM_B !== undefined && product.BRM_B !== null) {
                const infoB = spiegaMisura(brmConfig.misuraBaseB, misure);
                if (infoB) {
                    const valoreB = parseFloat(brmConfig.valoreB) || 0;
                    const operazioneB = brmConfig.operazioneB || '-';
                    const segno = operazioneB === '+' ? '+' : '‚àí';
                    explanations.push(`<strong>BRM_B</strong> = ${infoB.formula} ${segno} ${Math.abs(valoreB)} = <strong>${product.BRM_B} mm</strong>`);
                }
            }
            
            if (explanations.length === 0) return '';
            
            result += explanations.join('<br>');
            result += '</td></tr>';
            
            return result;
        }

        // Helper per generare HTML singola posizione
        function generatePositionHTML(pos, idx, total, project) {
            return `${idx > 0 ? '<div class="page-break"></div>' : ''}<div class="page-break-avoid">
<h3>Posizione ${idx + 1}: ${pos.nome || pos.id}${pos.piano ? ' - ' + pos.piano : ''}</h3>
${pos.ambiente ? `<p><strong>Ambiente:</strong> ${pos.ambiente}</p>` : ''}
<p><strong>üìè Misure Vano:</strong></p>
<table><tr><th>LVT</th><th>HVT</th><th>LF</th><th>HF</th><th>TMV</th><th>HMT</th></tr>
<tr><td>${pos.misure?.LVT || '-'}</td><td>${pos.misure?.HVT || '-'}</td><td>${pos.misure?.LF || '-'}</td><td>${pos.misure?.HF || '-'}</td><td>${pos.misure?.TMV || '-'}</td><td>${pos.misure?.HMT || '-'}</td></tr></table>
${pos.infisso ? `<h4>ü™ü INFISSO</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Quantit√†</td><td>${pos.infisso.quantita || 1}</td></tr>
<tr><td>Tipo</td><td>${pos.infisso.tipo || '-'}</td></tr>
<tr><td>Apertura</td><td>${pos.infisso.apertura || '-'}</td></tr>
<tr><td>Azienda</td><td>${pos.infisso.azienda || '-'}</td></tr>
<tr><td>Finitura Int</td><td>${pos.infisso.finituraInt || '-'}</td></tr>
<tr><td>Finitura Est</td><td>${pos.infisso.finituraEst || '-'}</td></tr>
<tr><td>Colore Int</td><td>${pos.infisso.coloreInt || '-'}</td></tr>
<tr><td>Colore Est</td><td>${pos.infisso.coloreEst || '-'}</td></tr>
<tr><td>Vetro</td><td>${pos.infisso.vetro || '-'}</td></tr>
${pos.infisso.BRM_L !== undefined || pos.infisso.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.infisso.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.infisso.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.infisso, 'infisso', project)}` : ''}</table>` : ''}
${pos.persiana ? `<h4>üö™ PERSIANA</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Quantit√†</td><td>${pos.persiana.quantita || 1}</td></tr>
<tr><td>Tipo</td><td>${pos.persiana.tipo || '-'}</td></tr>
<tr><td>Colore Persiana</td><td>${pos.persiana.colorePersiana || '-'}</td></tr>
${pos.persiana.BRM_L !== undefined || pos.persiana.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.persiana.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.persiana.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.persiana, 'persiana', project)}` : ''}</table>` : ''}
${pos.tapparella ? `<h4>üéöÔ∏è TAPPARELLA</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Quantit√†</td><td>${pos.tapparella.quantita || 1}</td></tr>
<tr><td>Azienda</td><td>${pos.tapparella.azienda || '-'}</td></tr>
<tr><td>Modello</td><td>${pos.tapparella.modello || '-'}</td></tr>
${pos.tapparella.BRM_L !== undefined || pos.tapparella.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.tapparella.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.tapparella.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.tapparella, 'tapparella', project)}` : ''}</table>` : ''}
${pos.zanzariera ? `<h4>ü¶ü ZANZARIERA</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Quantit√†</td><td>${pos.zanzariera.quantita || 1}</td></tr>
<tr><td>Tipo</td><td>${pos.zanzariera.tipo || '-'}</td></tr>
${pos.zanzariera.BRM_L !== undefined || pos.zanzariera.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.zanzariera.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.zanzariera.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.zanzariera, 'zanzariera', project)}` : ''}</table>` : ''}
${pos.cassonetto ? `<h4>üì¶ CASSONETTO</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Tipo</td><td>${pos.cassonetto.tipo || '-'}</td></tr>
<tr><td>LS</td><td>${pos.cassonetto.LS || 0} mm</td></tr>
<tr><td>HCASS</td><td>${pos.cassonetto.HCASS || 0} mm</td></tr>
${pos.cassonetto.BRM_C !== undefined && pos.cassonetto.BRM_C !== null ? `<tr><td><strong>BRM_C</strong></td><td><strong>${pos.cassonetto.BRM_C ?? '-'} mm</strong></td></tr>` : ''}
${pos.cassonetto.BRM_B !== undefined && pos.cassonetto.BRM_B !== null ? `<tr><td><strong>BRM_B</strong></td><td><strong>${pos.cassonetto.BRM_B ?? '-'} mm</strong></td></tr>` : ''}
${generateBRMExplanation(pos, pos.cassonetto, 'cassonetto', project)}</table>` : ''}
</div>`;
        }

        // ‚ö° FASE 024: Render differito con debounce
        // Permette all'utente di fare pi√π modifiche consecutive senza interruzioni
        // Il render viene eseguito solo dopo 300ms di "silenzio"
        function deferredRender() {
            // Cancella il timer precedente se esiste
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            
            // Schedula un nuovo render tra 300ms
            renderTimeout = setTimeout(() => {
                render();
                renderTimeout = null;
            }, RENDER_DEBOUNCE_MS);
        }

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${MainMenu()}
                <main class="min-h-screen">
                    ${state.screen === 'list' ? ProjectsList() :
                      state.screen === 'position' ? PositionDetail() :
                      state.screen === 'drawings' ? DrawingsPage() :
                      ProjectSetup()}
                </main>
                ${NewProjectModal()}
                ${FotoModal()}
            `;
        }

        // Navigation function for setup steps
        window.navigateToStep = (step) => {
            state.setupStep = step;
            render();
        };

        // Navigation function for screens - AGGIUNTA PER MENU
        window.showScreen = (screenName) => {
            state.screen = screenName;
            render();
        };

        // Error handler per debug
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Errore JavaScript:', {
                message: msg,
                source: url,
                lineno: lineNo,
                colno: columnNo,
                error: error
            });
            return false;
        };

        // Initialize App con gestione errori
        try {
            console.log('Inizializzazione app...');
            loadState();
            render();
            console.log('App inizializzata correttamente');
            
            // üÜï v4.73: AUTO-SYNC da GitHub all'apertura (1 volta per sessione)
            if (GITHUB_CONFIG.token && !window.autoSyncDone) {
                window.autoSyncDone = true; // Flag per fare solo 1 volta
                
                console.log('üîÑ Auto-sync da GitHub...');
                
                // Download in background (non blocca UI)
                setTimeout(async () => {
                    try {
                        const result = await manualDownloadFromGitHub();
                        if (result) {
                            console.log('‚úÖ Auto-sync completato');
                        } else {
                            console.log('‚ÑπÔ∏è Auto-sync: nessun aggiornamento');
                        }
                    } catch (error) {
                        console.error('‚ö†Ô∏è Auto-sync fallito:', error);
                        // Non mostra errore all'utente, solo in console
                    }
                }, 500); // Aspetta 500ms dopo render
            } else if (!GITHUB_CONFIG.token) {
                console.log('‚ö†Ô∏è Auto-sync disabilitato: token GitHub non configurato');
            }
            
            // üÜï v4.74: SYNC PERIODICO ogni 2 minuti (anche con tab aperto)
            if (GITHUB_CONFIG.token && !window.periodicSyncInterval) {
                console.log('‚è∞ Sync periodico attivato (ogni 2 minuti)');
                
                window.periodicSyncInterval = setInterval(async () => {
                    console.log('‚è∞ Sync periodico in esecuzione...');
                    try {
                        const result = await manualDownloadFromGitHub();
                        if (result) {
                            console.log('‚úÖ Sync periodico: progetti aggiornati');
                        } else {
                            console.log('‚ÑπÔ∏è Sync periodico: gi√† aggiornato');
                        }
                    } catch (error) {
                        console.error('‚ö†Ô∏è Sync periodico fallito:', error);
                    }
                }, 120000); // 120000ms = 2 minuti
            }
            
            // Verifica se serve sincronizzazione (solo 1 volta per sessione)
            const project = state.projects.find(p => p.id === state.currentProject);
            if (project && !state.sincronizzazioneVerificata) {
                if (verificaSincronizzazioneNecessaria(project)) {
                    // Mostra avviso solo 1 volta
                    state.sincronizzazioneVerificata = true;
                }
            }
            
        } catch (error) {
            console.error('Errore durante inizializzazione:', error);
            alert('Si √® verificato un errore. Controlla la console per i dettagli.');
        }
    </script>

    <!-- üéØ OTTIMIZZAZIONE NAVIGAZIONE TAB: Solo campi dati, no pulsanti -->
    <script>
        // Esegui dopo ogni render per mantenere la configurazione TAB
        const originalRender = window.render;
        window.render = function() {
            originalRender();
            // Applica tabindex dopo il render
            setTimeout(() => {
                // Escludi TUTTI i button dalla navigazione TAB
                document.querySelectorAll('button').forEach(btn => {
                    btn.setAttribute('tabindex', '-1');
                });
                
                // Escludi anche i link dalla navigazione TAB
                document.querySelectorAll('a').forEach(link => {
                    link.setAttribute('tabindex', '-1');
                });
                
                // Mantieni SOLO input, select, textarea navigabili con TAB
                // (Questi elementi hanno gi√† tabindex=0 di default, non serve modificarli)
            }, 10);
        };
        
        console.log('‚úÖ Navigazione TAB ottimizzata: Ora TAB passa solo tra i campi dati!');
        console.log('‚úÖ FASE 021: Menu laterale hamburger attivato!');

        // ============================================
        // MENU SISTEMA OPENPORTE - CODICE INTEGRATO
        // ============================================
        
        const MenuSistema = {
            // Configurazione menu
            config: {
                menuItems: [],
                styles: '' // Stili gi√† inseriti nel CSS sopra
            },
            
            // Inizializza il menu
            init() {
                console.log('üöÄ Inizializzazione Menu Sistema...');
                
                // Crea struttura HTML
                this.createMenuStructure();
                
                // Attiva event listeners
                this.attachEventListeners();
                
                // Verifica stato iniziale
                this.updateSyncStatus();
                
                console.log('‚úÖ Menu Sistema inizializzato!');
            },
            
            // Crea struttura HTML del menu
            createMenuStructure() {
                // Rimuovi menu esistente se presente
                const existingMenu = document.querySelector('.menu-sistema');
                if (existingMenu) existingMenu.remove();
                
                const existingToggle = document.querySelector('.menu-toggle');
                if (existingToggle) existingToggle.remove();
                
                const existingOverlay = document.querySelector('.menu-overlay');
                if (existingOverlay) existingOverlay.remove();
                
                // Crea container menu
                const menuContainer = document.createElement('div');
                menuContainer.className = 'menu-sistema';
                
                // Header
                menuContainer.innerHTML = `
                    <div class="menu-items">
                        ${this.renderMenuItems(this.config.menuItems)}
                    </div>
                    <div class="menu-footer">
                        <div class="sync-status" id="menu-sync-status">
                            <span class="sync-icon">üîÑ</span>
                            <span class="sync-text">Non connesso</span>
                        </div>
                    </div>
                `;
                
                // Toggle button
                const toggleButton = document.createElement('div');
                toggleButton.className = 'menu-toggle';
                toggleButton.innerHTML = '<span class="menu-toggle-icon">‚ò∞</span>';
                
                // Overlay
                const overlay = document.createElement('div');
                overlay.className = 'menu-overlay';
                
                // Aggiungi al DOM
                document.body.appendChild(menuContainer);
                document.body.appendChild(toggleButton);
                document.body.appendChild(overlay);
            },
            
            // Renderizza items del menu
            renderMenuItems(items) {
                return items.map(item => {
                    const hasSubmenu = item.submenu && item.submenu.length > 0;
                    
                    let html = `
                        <div class="menu-item" data-menu-id="${item.id}">
                            <span class="menu-icon">${item.icon}</span>
                            <span class="menu-label">${item.label}</span>
                            ${hasSubmenu ? '<span class="menu-arrow">‚ñ∂</span>' : ''}
                        </div>
                    `;
                    
                    if (hasSubmenu) {
                        html += `
                            <div class="submenu" data-parent-id="${item.id}">
                                ${item.submenu.map(subitem => `
                                    <div class="submenu-item" data-menu-id="${subitem.id}">
                                        <span class="menu-icon">${subitem.icon}</span>
                                        <span class="menu-label">${subitem.label}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    return html;
                }).join('');
            },
            
            // Attacca event listeners
            attachEventListeners() {
                const toggle = document.querySelector('.menu-toggle');
                const overlay = document.querySelector('.menu-overlay');
                const menu = document.querySelector('.menu-sistema');
                
                // Toggle menu
                toggle?.addEventListener('click', () => this.toggleMenu());
                overlay?.addEventListener('click', () => this.closeMenu());
                
                // Menu items - uso event delegation
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.menu-item')) {
                        this.handleMenuClick(e);
                    } else if (e.target.closest('.submenu-item')) {
                        this.handleSubmenuClick(e);
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && menu?.classList.contains('active')) {
                        this.closeMenu();
                    }
                });
            },
            
            // Gestisci click su menu item
            handleMenuClick(e) {
                const item = e.target.closest('.menu-item');
                const menuId = item.dataset.menuId;
                const menuConfig = this.config.menuItems.find(m => m.id === menuId);
                
                if (menuConfig?.submenu) {
                    // Toggle submenu
                    item.classList.toggle('expanded');
                    const submenu = document.querySelector(`.submenu[data-parent-id="${menuId}"]`);
                    submenu?.classList.toggle('active');
                } else if (menuConfig?.action) {
                    // Esegui azione
                    menuConfig.action();
                    this.closeMenu();
                }
            },
            
            // Gestisci click su submenu item
            handleSubmenuClick(e) {
                e.stopPropagation();
                const item = e.target.closest('.submenu-item');
                const menuId = item.dataset.menuId;
                
                // Trova configurazione submenu
                for (const menuItem of this.config.menuItems) {
                    if (menuItem.submenu) {
                        const subItem = menuItem.submenu.find(s => s.id === menuId);
                        if (subItem?.action) {
                            subItem.action();
                            this.closeMenu();
                            break;
                        }
                    }
                }
            },
            
            // Toggle menu
            toggleMenu() {
                const menu = document.querySelector('.menu-sistema');
                const toggle = document.querySelector('.menu-toggle');
                const overlay = document.querySelector('.menu-overlay');
                
                menu?.classList.toggle('active');
                toggle?.classList.toggle('active');
                overlay?.classList.toggle('active');
            },
            
            // Chiudi menu
            closeMenu() {
                const menu = document.querySelector('.menu-sistema');
                const toggle = document.querySelector('.menu-toggle');
                const overlay = document.querySelector('.menu-overlay');
                
                menu?.classList.remove('active');
                toggle?.classList.remove('active');
                overlay?.classList.remove('active');
            },
            
            // Apri menu
            openMenu() {
                const menu = document.querySelector('.menu-sistema');
                const toggle = document.querySelector('.menu-toggle');
                const overlay = document.querySelector('.menu-overlay');
                
                menu?.classList.add('active');
                toggle?.classList.add('active');
                overlay?.classList.add('active');
            },
            
            // Aggiorna stato sync
            updateSyncStatus() {
                const syncStatus = document.getElementById('menu-sync-status');
                if (!syncStatus) return;
                
                // Controlla se state.github esiste e √® connesso
                const isConnected = window.state?.github?.connected || false;
                const lastSync = window.state?.github?.lastSyncTime || null;
                
                if (isConnected) {
                    syncStatus.classList.add('connected');
                    syncStatus.innerHTML = `
                        <span class="sync-icon">‚úÖ</span>
                        <span class="sync-text">GitHub connesso</span>
                    `;
                    
                    if (lastSync) {
                        const date = new Date(lastSync);
                        const timeStr = date.toLocaleTimeString('it-IT', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        syncStatus.innerHTML += `<br><small>Ultimo sync: ${timeStr}</small>`;
                    }
                } else {
                    syncStatus.classList.remove('connected');
                    syncStatus.innerHTML = `
                        <span class="sync-icon">üîÑ</span>
                        <span class="sync-text">Non connesso</span>
                    `;
                }
            },
            
            // Marca menu item come attivo
            setActiveMenuItem(screenId) {
                // Rimuovi classe active da tutti
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Mappa screen a menu id
                const screenToMenu = {
                    'list': 'progetti',
                    'dashboard': 'dashboard',
                    'setup': 'nuovo-progetto',
                    'statistics': 'statistiche'
                };
                
                const menuId = screenToMenu[screenId];
                if (menuId) {
                    const menuItem = document.querySelector(`.menu-item[data-menu-id="${menuId}"]`);
                    menuItem?.classList.add('active');
                }
            }
        };
        
        // Rendi globale
        window.MenuSistema = MenuSistema;

        // ============================================
        // INTEGRAZIONE MENU SISTEMA OPENPORTE
        // ============================================
        
        // Inizializza il menu dopo che l'app √® pronta
        const initMenuSistemaIntegrato = () => {
            // Verifica che il menu sia disponibile
            if (typeof MenuSistema === 'undefined') {
                console.error('MenuSistema non trovato! Assicurati che menu-sistema-module.js sia caricato');
                return;
            }
            
            // Configura le azioni del menu per integrarsi con l'app esistente
            MenuSistema.config.menuItems = [
                {
                    id: 'progetti',
                    label: 'Lista Progetti',
                    icon: 'üìÅ',
                    action: () => {
                        showScreen('list');
                        MenuSistema.setActiveMenuItem('list');
                    }
                },
                {
                    id: 'nuovo-progetto',
                    label: 'Nuovo Progetto',
                    icon: '‚ûï',
                    action: () => {
                        const newProject = createProject('Nuovo Progetto', 'Cliente');
                        state.screen = 'project-detail';
                        render();
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'progetto-corrente',
                    label: 'Progetto Corrente',
                    icon: 'üèóÔ∏è',
                    submenu: state.currentProject ? [
                        {
                            id: 'dati-cliente',
                            label: 'Dati Cliente',
                            icon: 'üë§',
                            action: () => {
                                state.setupStep = 1;
                                render();
                                MenuSistema.closeMenu();
                            }
                        },
                        {
                            id: 'posizioni',
                            label: 'Posizioni',
                            icon: 'üìç',
                            action: () => {
                                state.setupStep = 9;
                                render();
                                MenuSistema.closeMenu();
                            }
                        },
                        {
                            id: 'rilievi-globali',
                            label: 'Prodotti e Rilievi',
                            icon: 'üìê',
                            action: () => {
                                state.setupStep = 2;
                                render();
                                MenuSistema.closeMenu();
                            }
                        }
                    ] : []
                },
                {
                    id: 'sincronizzazione',
                    label: 'Sincronizzazione',
                    icon: 'üîÑ',
                    submenu: [
                        {
                            id: 'github-settings',
                            label: 'Impostazioni GitHub',
                            icon: '‚öôÔ∏è',
                            action: () => {
                                openGitHubSettings();
                                MenuSistema.closeMenu();
                            }
                        },
                        {
                            id: 'sync-now',
                            label: 'Sincronizza Ora',
                            icon: '‚¨ÜÔ∏è',
                            action: () => {
                                if (state.github?.connected) {
                                    quickSync();
                                    MenuSistema.closeMenu();
                                } else {
                                    showNotification('GitHub non connesso', 'error');
                                }
                            }
                        },
                        {
                            id: 'download-github',
                            label: 'Scarica da GitHub',
                            icon: '‚¨áÔ∏è',
                            action: () => {
                                if (state.github?.connected) {
                                    downloadFromGitHub();
                                    MenuSistema.closeMenu();
                                } else {
                                    showNotification('GitHub non connesso', 'error');
                                }
                            }
                        }
                    ]
                },
                {
                    id: 'import-export',
                    label: 'Import/Export',
                    icon: 'üíæ',
                    submenu: [
                        {
                            id: 'export-json',
                            label: 'Esporta Progetti',
                            icon: 'üì§',
                            action: () => {
                                exportProjects();
                                MenuSistema.closeMenu();
                            }
                        },
                        {
                            id: 'import-json',
                            label: 'Importa Progetti',
                            icon: 'üì•',
                            action: () => {
                                importProjects();
                                MenuSistema.closeMenu();
                            }
                        },
                        {
                            id: 'backup-locale',
                            label: 'Backup Locale',
                            icon: 'üíæ',
                            action: () => {
                                const backup = {
                                    version: '1.0',
                                    date: new Date().toISOString(),
                                    state: state
                                };
                                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `backup-openporte-${new Date().toISOString().split('T')[0]}.json`;
                                a.click();
                                showNotification('Backup creato', 'success');
                                MenuSistema.closeMenu();
                            }
                        }
                    ]
                },
                {
                    id: 'statistiche',
                    label: 'Statistiche',
                    icon: 'üìä',
                    action: () => {
                        openStatistics();
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'strumenti',
                    label: 'Strumenti',
                    icon: 'üîß',
                    submenu: [
                        {
                            id: 'verifica-sync',
                            label: 'Verifica Sincronizzazione',
                            icon: 'üîç',
                            action: () => {
                                if (state.currentProject) {
                                    const project = state.projects.find(p => p.id === state.currentProject);
                                    if (project) {
                                        verificaSincronizzazioneNecessaria(project);
                                    }
                                }
                                MenuSistema.closeMenu();
                            }
                        },
                        {
                            id: 'clear-cache',
                            label: 'Pulisci Cache',
                            icon: 'üßπ',
                            action: () => {
                                if ('caches' in window) {
                                    caches.keys().then(names => {
                                        names.forEach(name => caches.delete(name));
                                    });
                                }
                                showNotification('Cache pulita', 'success');
                                MenuSistema.closeMenu();
                            }
                        },
                        {
                            id: 'debug-console',
                            label: 'Console Debug',
                            icon: 'üêõ',
                            action: () => {
                                console.log('=== STATO APPLICAZIONE ===');
                                console.log('Progetti:', state.projects.length);
                                console.log('Progetto corrente:', state.currentProject);
                                console.log('GitHub connesso:', state.github?.connected || false);
                                console.log('Ultimo sync:', state.github?.lastSyncTime || 'Mai');
                                console.log('State completo:', state);
                                showNotification('Debug stampato in console', 'info');
                                MenuSistema.closeMenu();
                            }
                        }
                    ]
                },
                {
                    id: 'info',
                    label: 'Informazioni',
                    icon: '‚ÑπÔ∏è',
                    submenu: [
                        {
                            id: 'version',
                            label: 'Versione',
                            icon: 'üì±',
                            action: () => {
                                alert(`OpenPorte v3.5-ULTIMATE-FIX\nMenu Sistema v1.0\nBuild: 10/11/2025\n\nFix applicati:\n‚úÖ rilievoPersiane array‚Üíoggetto\n‚úÖ state.github undefined\n‚úÖ project.positions crash\n‚úÖ Menu sistema integrato`);
                            }
                        },
                        {
                            id: 'help',
                            label: 'Aiuto',
                            icon: '‚ùì',
                            action: () => {
                                alert('Per assistenza:\n\nüìß supporto@openporte.it\nüì± +39 XXX XXX XXXX\nüåê www.openporte.it/help');
                            }
                        }
                    ]
                }
            ];
            
            // Inizializza il menu
            MenuSistema.init();
            
            // Aggiorna stato sync periodicamente
            setInterval(() => {
                MenuSistema.updateSyncStatus();
            }, 5000);
            
            // Hook per aggiornare menu quando cambia schermata
            // NOTA: showScreen verr√† definito dopo, quindi non possiamo wrapparlo qui
            // Il menu si aggiorner√† tramite altri eventi
            
            console.log('‚úÖ Menu Sistema OpenPorte integrato con successo!');
        };
        
        // Inizializza quando DOM √® pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMenuSistemaIntegrato);
        } else {
            // DOM gi√† pronto, inizializza subito
            setTimeout(initMenuSistemaIntegrato, 100);
        }

        // ============================================
        // üçî MENU SISTEMA - FASE 020 (VECCHIO - DISABILITATO)
        // ============================================

        window.toggleMenu = function() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu && overlay) {
                menu.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        };

        window.closeMenu = function() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu && overlay) {
                menu.classList.remove('open');
                overlay.classList.remove('active');
            }
        };

        window.navigateTo = function(section) {
            // Chiudi menu su mobile
            if (window.innerWidth < 768) {
                closeMenu();
            }
            
            // Rimuovi active da tutti i link
            document.querySelectorAll('.menu-list a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Aggiungi active al link corrente
            const currentLink = document.querySelector(`.menu-list a[href="#${section}"]`);
            if (currentLink) {
                currentLink.classList.add('active');
            }
            
            // Per ora gestiamo solo la sezione "progetti" che √® l'app principale
            // Le altre sezioni verranno implementate successivamente
            if (section === 'progetti') {
                // L'app principale √® gi√† visibile
                console.log('üìÅ Sezione progetti');
            } else if (section === 'config') {
                // TODO: Implementare pagina config globali
                showNotification('‚öôÔ∏è Config Globali - In sviluppo', 'info');
            } else if (section === 'backup') {
                // TODO: Implementare pagina backup
                showNotification('üíæ Backup - In sviluppo', 'info');
            } else if (section === 'sync') {
                // TODO: Implementare pagina sync
                showNotification('üîÑ Sincronizzazione - In sviluppo', 'info');
            } else if (section === 'info') {
                // TODO: Implementare pagina info
                showNotification('‚ÑπÔ∏è Info & Guida - In sviluppo', 'info');
            }
            
            // Salva sezione corrente
            try {
                localStorage.setItem('currentMenuSection', section);
            } catch (e) {
                console.warn('Impossibile salvare sezione corrente:', e);
            }
            
            // Scroll top
            window.scrollTo(0, 0);
        };

        // Inizializza menu al caricamento
        setTimeout(() => {
            let lastSection = 'progetti'; // Default
            
            try {
                lastSection = localStorage.getItem('currentMenuSection') || 'progetti';
            } catch (e) {
                console.warn('Impossibile recuperare ultima sezione:', e);
            }
            
            navigateTo(lastSection);
            console.log('‚úÖ FASE 020: Menu sistema inizializzato!');
        }, 100);

        // Chiudi menu con tasto ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMenu();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + K per ricerca
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                toggleMainMenu();
                setTimeout(() => {
                    const searchInput = document.getElementById('mainSearch');
                    if (searchInput) searchInput.focus();
                }, 300);
            }
            
            // Ctrl/Cmd + N per nuovo progetto
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showNewProjectModal();
            }
            
            // Ctrl/Cmd + S per salvare
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveState();
                showNotification('üíæ Salvato', 'success');
            }
            
            // Ctrl/Cmd + E per export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                if (state.currentProject) {
                    exportCurrentProjectJSON();
                } else {
                    exportAllProjects();
                }
            }
            
            // Esc per chiudere menu/modal
            if (e.key === 'Escape') {
                if (state.mainMenuOpen) {
                    closeMainMenu();
                }
                if (state.projectMenuOpen) {
                    closeProjectMenu();
                }
                // Chiudi anche eventuali modal
                const modals = document.querySelectorAll('.modal-overlay');
                modals.forEach(modal => {
                    if (modal.style.display === 'flex') {
                        modal.style.display = 'none';
                    }
                });
            }
        });
        
        // üö® NOTIFICA VISIVA VERSIONE DINAMICA
        setTimeout(() => {
            showNotification(`üö™ v${APP_VERSION} ‚úÖ ${APP_VERSION_NOTE}`, 'success', 5000);
        }, 1000);
        
        // Aggiungi animazioni CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from { transform: translate(-50%, 100%); opacity: 0; }
                to { transform: translate(-50%, 0); opacity: 1; }
            }
            @keyframes slideDown {
                from { transform: translate(-50%, 0); opacity: 1; }
                to { transform: translate(-50%, 100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
